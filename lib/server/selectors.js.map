{"version":3,"sources":["../../src/server/selectors.ts"],"names":["Selectors","constructor","_builtinEngines","_builtinEnginesInMainWorld","_engines","guid","Set","Map","register","name","source","contentScript","match","Error","has","set","unregisterAll","clear","query","frame","selector","options","scope","info","_page","parseSelector","context","_context","world","injectedScript","handle","evaluateHandle","injected","parsed","strict","querySelector","document","elementHandle","asElement","dispose","mainContext","_mainContext","_adoptIfNeeded","_queryArray","arrayHandle","querySelectorAll","_queryAll","adoptToMain","properties","getProperties","targetContext","result","property","values","push","Promise","all","adopted","_delegate","adoptElementHandle","needsMainWorld","part","parts","custom","get"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from './dom';\nimport * as frames from './frames';\nimport * as js from './javascript';\nimport * as types from './types';\nimport { ParsedSelector, parseSelector } from './common/selectorParser';\nimport { createGuid } from '../utils/utils';\n\nexport type SelectorInfo = {\n  parsed: ParsedSelector,\n  world: types.World,\n  selector: string,\n  strict: boolean,\n};\n\nexport class Selectors {\n  readonly _builtinEngines: Set<string>;\n  readonly _builtinEnginesInMainWorld: Set<string>;\n  readonly _engines: Map<string, { source: string, contentScript: boolean }>;\n  readonly guid = `selectors@${createGuid()}`;\n\n  constructor() {\n    // Note: keep in sync with InjectedScript class.\n    this._builtinEngines = new Set([\n      'css', 'css:light',\n      'xpath', 'xpath:light',\n      '_react', '_vue',\n      'text', 'text:light',\n      'id', 'id:light',\n      'data-testid', 'data-testid:light',\n      'data-test-id', 'data-test-id:light',\n      'data-test', 'data-test:light',\n      'nth', 'visible'\n    ]);\n    this._builtinEnginesInMainWorld = new Set([\n      '_react', '_vue',\n    ]);\n    this._engines = new Map();\n  }\n\n  async register(name: string, source: string, contentScript: boolean = false): Promise<void> {\n    if (!name.match(/^[a-zA-Z_0-9-]+$/))\n      throw new Error('Selector engine name may only contain [a-zA-Z0-9_] characters');\n    // Note: we keep 'zs' for future use.\n    if (this._builtinEngines.has(name) || name === 'zs' || name === 'zs:light')\n      throw new Error(`\"${name}\" is a predefined selector engine`);\n    if (this._engines.has(name))\n      throw new Error(`\"${name}\" selector engine has been already registered`);\n    this._engines.set(name, { source, contentScript });\n  }\n\n  unregisterAll() {\n    this._engines.clear();\n  }\n\n  async query(frame: frames.Frame, selector: string, options: { strict?: boolean }, scope?: dom.ElementHandle): Promise<dom.ElementHandle<Element> | null> {\n    const info = frame._page.parseSelector(selector, options);\n    const context = await frame._context(info.world);\n    const injectedScript = await context.injectedScript();\n    const handle = await injectedScript.evaluateHandle((injected, { parsed, scope, strict }) => {\n      return injected.querySelector(parsed, scope || document, strict);\n    }, { parsed: info.parsed, scope, strict: info.strict });\n    const elementHandle = handle.asElement() as dom.ElementHandle<Element> | null;\n    if (!elementHandle) {\n      handle.dispose();\n      return null;\n    }\n    const mainContext = await frame._mainContext();\n    return this._adoptIfNeeded(elementHandle, mainContext);\n  }\n\n  async _queryArray(frame: frames.Frame, selector: string, scope?: dom.ElementHandle): Promise<js.JSHandle<Element[]>> {\n    const info = this.parseSelector(selector, false);\n    const context = await frame._mainContext();\n    const injectedScript = await context.injectedScript();\n    const arrayHandle = await injectedScript.evaluateHandle((injected, { parsed, scope }) => {\n      return injected.querySelectorAll(parsed, scope || document);\n    }, { parsed: info.parsed, scope });\n    return arrayHandle;\n  }\n\n  async _queryAll(frame: frames.Frame, selector: string, scope?: dom.ElementHandle, adoptToMain?: boolean): Promise<dom.ElementHandle<Element>[]> {\n    const info = this.parseSelector(selector, false);\n    const context = await frame._context(info.world);\n    const injectedScript = await context.injectedScript();\n    const arrayHandle = await injectedScript.evaluateHandle((injected, { parsed, scope }) => {\n      return injected.querySelectorAll(parsed, scope || document);\n    }, { parsed: info.parsed, scope });\n\n    const properties = await arrayHandle.getProperties();\n    arrayHandle.dispose();\n\n    // Note: adopting elements one by one may be slow. If we encounter the issue here,\n    // we might introduce 'useMainContext' option or similar to speed things up.\n    const targetContext = adoptToMain ? await frame._mainContext() : context;\n    const result: Promise<dom.ElementHandle<Element>>[] = [];\n    for (const property of properties.values()) {\n      const elementHandle = property.asElement() as dom.ElementHandle<Element>;\n      if (elementHandle)\n        result.push(this._adoptIfNeeded(elementHandle, targetContext));\n      else\n        property.dispose();\n    }\n    return Promise.all(result);\n  }\n\n  private async _adoptIfNeeded<T extends Node>(handle: dom.ElementHandle<T>, context: dom.FrameExecutionContext): Promise<dom.ElementHandle<T>> {\n    if (handle._context === context)\n      return handle;\n    const adopted = handle._page._delegate.adoptElementHandle(handle, context);\n    handle.dispose();\n    return adopted;\n  }\n\n  parseSelector(selector: string, strict: boolean): SelectorInfo {\n    const parsed = parseSelector(selector);\n    let needsMainWorld = false;\n    for (const part of parsed.parts) {\n      const custom = this._engines.get(part.name);\n      if (!custom && !this._builtinEngines.has(part.name))\n        throw new Error(`Unknown engine \"${part.name}\" while parsing selector ${selector}`);\n      if (custom && !custom.contentScript)\n        needsMainWorld = true;\n      if (this._builtinEnginesInMainWorld.has(part.name))\n        needsMainWorld = true;\n    }\n    return {\n      parsed,\n      selector,\n      world: needsMainWorld ? 'main' : 'utility',\n      strict,\n    };\n  }\n}\n"],"file":"selectors.js"}