{"version":3,"sources":["../../../src/server/injected/reactSelectorEngine.ts"],"names":["getComponentName","reactElement","type","displayName","name","_currentElement","elementType","getChildren","child","children","sibling","push","isKnownElement","_renderedComponent","_renderedChildren","Object","values","filter","getProps","props","memoizedProps","result","buildComponentsTree","treeNode","map","rootElements","rootElement","stateNode","_hostNode","Element","filterComponentsTree","searchFn","findReactRoot","walker","document","createTreeWalker","nextNode","currentNode","hasOwnProperty","_reactRootContainer","_internalRoot","current","key","keys","startsWith","undefined","ReactEngine","queryAll","scope","selector","attributes","reactRoot","tree","treeNodes","some","domNode","contains","attr","allRootElements","Set","add"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { SelectorEngine, SelectorRoot } from './selectorEngine';\nimport { checkComponentAttribute, parseComponentSelector } from '../common/componentUtils';\n\ntype ComponentNode = {\n  name: string,\n  children: ComponentNode[],\n  rootElements: Element[],\n  props: any,\n};\n\ntype ReactVNode = {\n  // React 16+\n  type: any,\n  child?: ReactVNode,\n  sibling?: ReactVNode,\n  stateNode?: Node,\n  memoizedProps?: any,\n\n  // React 15\n  _hostNode?: any,\n  _currentElement?: any,\n  _renderedComponent?: any,\n  _renderedChildren?: any[],\n};\n\nfunction getComponentName(reactElement: ReactVNode): string {\n  // React 16+\n  // @see https://github.com/baruchvlz/resq/blob/5c15a5e04d3f7174087248f5a158c3d6dcc1ec72/src/utils.js#L16\n  if (typeof reactElement.type === 'function')\n    return reactElement.type.displayName || reactElement.type.name || 'Anonymous';\n  if (typeof reactElement.type === 'string')\n    return reactElement.type;\n\n  // React 15\n  // @see https://github.com/facebook/react/blob/2edf449803378b5c58168727d4f123de3ba5d37f/packages/react-devtools-shared/src/backend/legacy/renderer.js#L59\n  if (reactElement._currentElement) {\n    const elementType = reactElement._currentElement.type;\n    if (typeof elementType === 'string')\n      return elementType;\n    if (typeof elementType === 'function')\n      return elementType.displayName || elementType.name || 'Anonymous';\n  }\n  return '';\n}\n\nfunction getChildren(reactElement: ReactVNode): ReactVNode[] {\n  // React 16+\n  // @see https://github.com/baruchvlz/resq/blob/5c15a5e04d3f7174087248f5a158c3d6dcc1ec72/src/utils.js#L192\n  if (reactElement.child) {\n    const children: ReactVNode[] = [];\n    for (let child: ReactVNode|undefined = reactElement.child; child; child = child.sibling)\n      children.push(child);\n    return children;\n  }\n\n  // React 15\n  // @see https://github.com/facebook/react/blob/2edf449803378b5c58168727d4f123de3ba5d37f/packages/react-devtools-shared/src/backend/legacy/renderer.js#L101\n  if (!reactElement._currentElement)\n    return [];\n  const isKnownElement = (reactElement: ReactVNode) => {\n    const elementType = reactElement._currentElement?.type;\n    return typeof elementType === 'function' || typeof elementType === 'string';\n  };\n\n  if (reactElement._renderedComponent) {\n    const child = reactElement._renderedComponent;\n    return isKnownElement(child) ? [child] : [];\n  }\n  if (reactElement._renderedChildren)\n    return [...Object.values(reactElement._renderedChildren)].filter(isKnownElement);\n  return [];\n}\n\nfunction getProps(reactElement: ReactVNode) {\n  const props =\n      // React 16+\n      reactElement.memoizedProps ||\n      // React 15\n      reactElement._currentElement?.props;\n  if (!props || typeof props === 'string')\n    return props;\n  const result = { ...props };\n\n  delete result.children;\n  return result;\n}\n\nfunction buildComponentsTree(reactElement: ReactVNode): ComponentNode {\n  const treeNode: ComponentNode = {\n    name: getComponentName(reactElement),\n    children: getChildren(reactElement).map(buildComponentsTree),\n    rootElements: [],\n    props: getProps(reactElement),\n  };\n\n  const rootElement =\n      // React 16+\n      // @see https://github.com/baruchvlz/resq/blob/5c15a5e04d3f7174087248f5a158c3d6dcc1ec72/src/utils.js#L29\n      reactElement.stateNode ||\n      // React 15\n      reactElement._hostNode || reactElement._renderedComponent?._hostNode;\n  if (rootElement instanceof Element) {\n    treeNode.rootElements.push(rootElement);\n  } else {\n    for (const child of treeNode.children)\n      treeNode.rootElements.push(...child.rootElements);\n  }\n  return treeNode;\n}\n\nfunction filterComponentsTree(treeNode: ComponentNode, searchFn: (node: ComponentNode) => boolean, result: ComponentNode[] = []) {\n  if (searchFn(treeNode))\n    result.push(treeNode);\n  for (const child of treeNode.children)\n    filterComponentsTree(child, searchFn, result);\n  return result;\n}\n\nfunction findReactRoot(): ReactVNode | undefined {\n  const walker = document.createTreeWalker(document);\n  while (walker.nextNode()) {\n    // @see https://github.com/baruchvlz/resq/blob/5c15a5e04d3f7174087248f5a158c3d6dcc1ec72/src/utils.js#L329\n    if (walker.currentNode.hasOwnProperty('_reactRootContainer'))\n      return (walker.currentNode as any)._reactRootContainer._internalRoot.current;\n    for (const key of Object.keys(walker.currentNode)) {\n      // @see https://github.com/baruchvlz/resq/blob/5c15a5e04d3f7174087248f5a158c3d6dcc1ec72/src/utils.js#L334\n      if (key.startsWith('__reactInternalInstance') || key.startsWith('__reactFiber'))\n        return (walker.currentNode as any)[key];\n    }\n  }\n  return undefined;\n}\n\nexport const ReactEngine: SelectorEngine = {\n  queryAll(scope: SelectorRoot, selector: string): Element[] {\n    const {name, attributes} = parseComponentSelector(selector);\n\n    const reactRoot = findReactRoot();\n    if (!reactRoot)\n      return [];\n    const tree = buildComponentsTree(reactRoot);\n    const treeNodes = filterComponentsTree(tree, treeNode => {\n      if (name && treeNode.name !== name)\n        return false;\n      if (treeNode.rootElements.some(domNode => !scope.contains(domNode)))\n        return false;\n      for (const attr of attributes) {\n        if (!checkComponentAttribute(treeNode.props, attr))\n          return false;\n      }\n      return true;\n    });\n    const allRootElements: Set<Element> = new Set();\n    for (const treeNode of treeNodes) {\n      for (const domNode of treeNode.rootElements)\n        allRootElements.add(domNode);\n    }\n    return [...allRootElements];\n  }\n};\n"],"file":"reactSelectorEngine.js"}