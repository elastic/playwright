{"version":3,"sources":["../../../src/server/injected/selectorEvaluator.ts"],"names":["SelectorEvaluatorImpl","constructor","extraEngines","_engines","Map","_cacheQueryCSS","_cacheMatches","_cacheQuery","_cacheMatchesSimple","_cacheMatchesParents","_cacheCallMatches","_cacheCallQuery","_cacheQuerySimple","_cacheText","_scoreMap","_retainCacheCounter","name","engine","set","notEngine","isEngine","hasEngine","scopeEngine","lightEngine","visibleEngine","textEngine","textIsEngine","textMatchesEngine","hasTextEngine","createPositionEngine","boxRightOf","boxLeftOf","boxAbove","boxBelow","boxNear","nthMatchEngine","allNames","keys","sort","parserNames","customCSSNames","join","Error","begin","end","clear","_cached","cache","main","rest","cb","has","entries","get","entry","find","e","every","value","index","result","push","_checkSelector","s","wellFormed","Array","isArray","simples","length","matches","element","context","selector","scope","pierceShadow","_matchesEngine","_matchesSimple","_matchesParents","query","_queryEngine","previousScoreMap","elements","_querySimple","filter","size","a","b","aScore","bScore","undefined","_markScore","score","simple","isPossiblyScopeClause","functions","some","f","css","_matchesCSS","func","_getEngine","args","_queryCSS","funcs","firstIndex","findIndex","i","complex","combinator","parent","parentElementOrShadowHostInContext","previousSibling","previousSiblingInContext","_callMatches","_callQuery","includes","root","concat","querySelectorAll","shadowRoot","evaluator","arg","sortInDOMOrder","nodeType","documentElement","isVisible","matcher","createLaxTextMatcher","elementMatchesText","createStrictTextMatcher","createRegexTextMatcher","shouldSkipForTextMatching","elementText","text","trim","replace","toLowerCase","full","immediate","source","flags","re","RegExp","test","nodeName","document","head","contains","currentImmediate","HTMLInputElement","type","child","firstChild","nextSibling","Node","TEXT_NODE","nodeValue","ELEMENT_NODE","box1","box2","maxDistance","distance","left","right","Math","max","bottom","top","kThreshold","scorer","queryArgs","slice","box","getBoundingClientRect","bestScore","parentElementOrShadowHost","parentElement","parentNode","DOCUMENT_FRAGMENT_NODE","host","previousElementSibling","ownerDocument","defaultView","style","getComputedStyle","visibility","rect","width","height","elementToEntry","roots","append","parentEntry","children","taken","forEach","visit","Set","firstElementChild","nextElementSibling"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { CSSComplexSelector, CSSSimpleSelector, CSSComplexSelectorList, CSSFunctionArgument } from '../common/cssParser';\nimport { customCSSNames } from '../common/selectorParser';\n\nexport type QueryContext = {\n  scope: Element | Document;\n  pierceShadow: boolean;\n  // Place for more options, e.g. normalizing whitespace.\n};\nexport type Selector = any; // Opaque selector type.\nexport interface SelectorEvaluator {\n  query(context: QueryContext, selector: Selector): Element[];\n  matches(element: Element, selector: Selector, context: QueryContext): boolean;\n}\nexport interface SelectorEngine {\n  matches?(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean;\n  query?(context: QueryContext, args: (string | number | Selector)[], evaluator: SelectorEvaluator): Element[];\n}\n\ntype QueryCache = Map<any, { rest: any[], result: any }[]>;\nexport class SelectorEvaluatorImpl implements SelectorEvaluator {\n  private _engines = new Map<string, SelectorEngine>();\n  private _cacheQueryCSS: QueryCache = new Map();\n  private _cacheMatches: QueryCache = new Map();\n  private _cacheQuery: QueryCache = new Map();\n  private _cacheMatchesSimple: QueryCache = new Map();\n  private _cacheMatchesParents: QueryCache = new Map();\n  private _cacheCallMatches: QueryCache = new Map();\n  private _cacheCallQuery: QueryCache = new Map();\n  private _cacheQuerySimple: QueryCache = new Map();\n  _cacheText = new Map<Element | ShadowRoot, ElementText>();\n  private _scoreMap: Map<Element, number> | undefined;\n  private _retainCacheCounter = 0;\n\n  constructor(extraEngines: Map<string, SelectorEngine>) {\n    for (const [name, engine] of extraEngines)\n      this._engines.set(name, engine);\n    this._engines.set('not', notEngine);\n    this._engines.set('is', isEngine);\n    this._engines.set('where', isEngine);\n    this._engines.set('has', hasEngine);\n    this._engines.set('scope', scopeEngine);\n    this._engines.set('light', lightEngine);\n    this._engines.set('visible', visibleEngine);\n    this._engines.set('text', textEngine);\n    this._engines.set('text-is', textIsEngine);\n    this._engines.set('text-matches', textMatchesEngine);\n    this._engines.set('has-text', hasTextEngine);\n    this._engines.set('right-of', createPositionEngine('right-of', boxRightOf));\n    this._engines.set('left-of', createPositionEngine('left-of', boxLeftOf));\n    this._engines.set('above', createPositionEngine('above', boxAbove));\n    this._engines.set('below', createPositionEngine('below', boxBelow));\n    this._engines.set('near', createPositionEngine('near', boxNear));\n    this._engines.set('nth-match', nthMatchEngine);\n\n    const allNames = [...this._engines.keys()];\n    allNames.sort();\n    const parserNames = [...customCSSNames];\n    parserNames.sort();\n    if (allNames.join('|') !== parserNames.join('|'))\n      throw new Error(`Please keep customCSSNames in sync with evaluator engines: ${allNames.join('|')} vs ${parserNames.join('|')}`);\n  }\n\n  begin() {\n    ++this._retainCacheCounter;\n  }\n\n  end() {\n    --this._retainCacheCounter;\n    if (!this._retainCacheCounter) {\n      this._cacheQueryCSS.clear();\n      this._cacheMatches.clear();\n      this._cacheQuery.clear();\n      this._cacheMatchesSimple.clear();\n      this._cacheMatchesParents.clear();\n      this._cacheCallMatches.clear();\n      this._cacheCallQuery.clear();\n      this._cacheQuerySimple.clear();\n      this._cacheText.clear();\n    }\n  }\n\n  private _cached<T>(cache: QueryCache, main: any, rest: any[], cb: () => T): T {\n    if (!cache.has(main))\n      cache.set(main, []);\n    const entries = cache.get(main)!;\n    const entry = entries.find(e => rest.every((value, index) => e.rest[index] === value));\n    if (entry)\n      return entry.result as T;\n    const result = cb();\n    entries.push({ rest, result });\n    return result;\n  }\n\n  private _checkSelector(s: Selector): CSSComplexSelector | CSSComplexSelectorList {\n    const wellFormed = typeof s === 'object' && s &&\n      (Array.isArray(s) || ('simples' in s) && (s.simples.length));\n    if (!wellFormed)\n      throw new Error(`Malformed selector \"${s}\"`);\n    return s as CSSComplexSelector | CSSComplexSelectorList;\n  }\n\n  matches(element: Element, s: Selector, context: QueryContext): boolean {\n    const selector = this._checkSelector(s);\n    this.begin();\n    try {\n      return this._cached<boolean>(this._cacheMatches, element, [selector, context.scope, context.pierceShadow], () => {\n        if (Array.isArray(selector))\n          return this._matchesEngine(isEngine, element, selector, context);\n        if (!this._matchesSimple(element, selector.simples[selector.simples.length - 1].selector, context))\n          return false;\n        return this._matchesParents(element, selector, selector.simples.length - 2, context);\n      });\n    } finally {\n      this.end();\n    }\n  }\n\n  query(context: QueryContext, s: any): Element[] {\n    const selector = this._checkSelector(s);\n    this.begin();\n    try {\n      return this._cached<Element[]>(this._cacheQuery, selector, [context.scope, context.pierceShadow], () => {\n        if (Array.isArray(selector))\n          return this._queryEngine(isEngine, context, selector);\n\n        // query() recursively calls itself, so we set up a new map for this particular query() call.\n        const previousScoreMap = this._scoreMap;\n        this._scoreMap = new Map();\n        let elements = this._querySimple(context, selector.simples[selector.simples.length - 1].selector);\n        elements = elements.filter(element => this._matchesParents(element, selector, selector.simples.length - 2, context));\n        if (this._scoreMap.size) {\n          elements.sort((a, b) => {\n            const aScore = this._scoreMap!.get(a);\n            const bScore = this._scoreMap!.get(b);\n            if (aScore === bScore)\n              return 0;\n            if (aScore === undefined)\n              return 1;\n            if (bScore === undefined)\n              return -1;\n            return aScore - bScore;\n          });\n        }\n        this._scoreMap = previousScoreMap;\n\n        return elements;\n      });\n    } finally {\n      this.end();\n    }\n  }\n\n  _markScore(element: Element, score: number) {\n    // HACK ALERT: temporary marks an element with a score, to be used\n    // for sorting at the end of the query().\n    if (this._scoreMap)\n      this._scoreMap.set(element, score);\n  }\n\n  private _matchesSimple(element: Element, simple: CSSSimpleSelector, context: QueryContext): boolean {\n    return this._cached<boolean>(this._cacheMatchesSimple, element, [simple, context.scope, context.pierceShadow], () => {\n      const isPossiblyScopeClause = simple.functions.some(f => f.name === 'scope' || f.name === 'is');\n      if (!isPossiblyScopeClause && element === context.scope)\n        return false;\n      if (simple.css && !this._matchesCSS(element, simple.css))\n        return false;\n      for (const func of simple.functions) {\n        if (!this._matchesEngine(this._getEngine(func.name), element, func.args, context))\n          return false;\n      }\n      return true;\n    });\n  }\n\n  private _querySimple(context: QueryContext, simple: CSSSimpleSelector): Element[] {\n    if (!simple.functions.length)\n      return this._queryCSS(context, simple.css || '*');\n\n    return this._cached<Element[]>(this._cacheQuerySimple, simple, [context.scope, context.pierceShadow], () => {\n      let css = simple.css;\n      const funcs = simple.functions;\n      if (css === '*' && funcs.length)\n        css = undefined;\n\n      let elements: Element[];\n      let firstIndex = -1;\n      if (css !== undefined) {\n        elements = this._queryCSS(context, css);\n      } else {\n        firstIndex = funcs.findIndex(func => this._getEngine(func.name).query !== undefined);\n        if (firstIndex === -1)\n          firstIndex = 0;\n        elements = this._queryEngine(this._getEngine(funcs[firstIndex].name), context, funcs[firstIndex].args);\n      }\n      for (let i = 0; i < funcs.length; i++) {\n        if (i === firstIndex)\n          continue;\n        const engine = this._getEngine(funcs[i].name);\n        if (engine.matches !== undefined)\n          elements = elements.filter(e => this._matchesEngine(engine, e, funcs[i].args, context));\n      }\n      for (let i = 0; i < funcs.length; i++) {\n        if (i === firstIndex)\n          continue;\n        const engine = this._getEngine(funcs[i].name);\n        if (engine.matches === undefined)\n          elements = elements.filter(e => this._matchesEngine(engine, e, funcs[i].args, context));\n      }\n      return elements;\n    });\n  }\n\n  private _matchesParents(element: Element, complex: CSSComplexSelector, index: number, context: QueryContext): boolean {\n    if (index < 0)\n      return true;\n    return this._cached<boolean>(this._cacheMatchesParents, element, [complex, index, context.scope, context.pierceShadow], () => {\n      const { selector: simple, combinator } = complex.simples[index];\n      if (combinator === '>') {\n        const parent = parentElementOrShadowHostInContext(element, context);\n        if (!parent || !this._matchesSimple(parent, simple, context))\n          return false;\n        return this._matchesParents(parent, complex, index - 1, context);\n      }\n      if (combinator === '+') {\n        const previousSibling = previousSiblingInContext(element, context);\n        if (!previousSibling || !this._matchesSimple(previousSibling, simple, context))\n          return false;\n        return this._matchesParents(previousSibling, complex, index - 1, context);\n      }\n      if (combinator === '') {\n        let parent = parentElementOrShadowHostInContext(element, context);\n        while (parent) {\n          if (this._matchesSimple(parent, simple, context)) {\n            if (this._matchesParents(parent, complex, index - 1, context))\n              return true;\n            if (complex.simples[index - 1].combinator === '')\n              break;\n          }\n          parent = parentElementOrShadowHostInContext(parent, context);\n        }\n        return false;\n      }\n      if (combinator === '~') {\n        let previousSibling = previousSiblingInContext(element, context);\n        while (previousSibling) {\n          if (this._matchesSimple(previousSibling, simple, context)) {\n            if (this._matchesParents(previousSibling, complex, index - 1, context))\n              return true;\n            if (complex.simples[index - 1].combinator === '~')\n              break;\n          }\n          previousSibling = previousSiblingInContext(previousSibling, context);\n        }\n        return false;\n      }\n      if (combinator === '>=') {\n        let parent: Element | undefined = element;\n        while (parent) {\n          if (this._matchesSimple(parent, simple, context)) {\n            if (this._matchesParents(parent, complex, index - 1, context))\n              return true;\n            if (complex.simples[index - 1].combinator === '')\n              break;\n          }\n          parent = parentElementOrShadowHostInContext(parent, context);\n        }\n        return false;\n      }\n      throw new Error(`Unsupported combinator \"${combinator}\"`);\n    });\n  }\n\n  private _matchesEngine(engine: SelectorEngine, element: Element, args: CSSFunctionArgument[], context: QueryContext): boolean {\n    if (engine.matches)\n      return this._callMatches(engine, element, args, context);\n    if (engine.query)\n      return this._callQuery(engine, args, context).includes(element);\n    throw new Error(`Selector engine should implement \"matches\" or \"query\"`);\n  }\n\n  private _queryEngine(engine: SelectorEngine, context: QueryContext, args: CSSFunctionArgument[]): Element[] {\n    if (engine.query)\n      return this._callQuery(engine, args, context);\n    if (engine.matches)\n      return this._queryCSS(context, '*').filter(element => this._callMatches(engine, element, args, context));\n    throw new Error(`Selector engine should implement \"matches\" or \"query\"`);\n  }\n\n  private _callMatches(engine: SelectorEngine, element: Element, args: CSSFunctionArgument[], context: QueryContext): boolean {\n    return this._cached<boolean>(this._cacheCallMatches, element, [engine, context.scope, context.pierceShadow, ...args], () => {\n      return engine.matches!(element, args, context, this);\n    });\n  }\n\n  private _callQuery(engine: SelectorEngine, args: CSSFunctionArgument[], context: QueryContext): Element[] {\n    return this._cached<Element[]>(this._cacheCallQuery, engine, [context.scope, context.pierceShadow, ...args], () => {\n      return engine.query!(context, args, this);\n    });\n  }\n\n  private _matchesCSS(element: Element, css: string): boolean {\n    return element.matches(css);\n  }\n\n  _queryCSS(context: QueryContext, css: string): Element[] {\n    return this._cached<Element[]>(this._cacheQueryCSS, css, [context.scope, context.pierceShadow], () => {\n      let result: Element[] = [];\n      function query(root: Element | ShadowRoot | Document) {\n        result = result.concat([...root.querySelectorAll(css)]);\n        if (!context.pierceShadow)\n          return;\n        if ((root as Element).shadowRoot)\n          query((root as Element).shadowRoot!);\n        for (const element of root.querySelectorAll('*')) {\n          if (element.shadowRoot)\n            query(element.shadowRoot);\n        }\n      }\n      query(context.scope);\n      return result;\n    });\n  }\n\n  private _getEngine(name: string): SelectorEngine {\n    const engine = this._engines.get(name);\n    if (!engine)\n      throw new Error(`Unknown selector engine \"${name}\"`);\n    return engine;\n  }\n}\n\nconst isEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length === 0)\n      throw new Error(`\"is\" engine expects non-empty selector list`);\n    return args.some(selector => evaluator.matches(element, selector, context));\n  },\n\n  query(context: QueryContext, args: (string | number | Selector)[], evaluator: SelectorEvaluator): Element[] {\n    if (args.length === 0)\n      throw new Error(`\"is\" engine expects non-empty selector list`);\n    let elements: Element[] = [];\n    for (const arg of args)\n      elements = elements.concat(evaluator.query(context, arg));\n    return args.length === 1 ? elements : sortInDOMOrder(elements);\n  },\n};\n\nconst hasEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length === 0)\n      throw new Error(`\"has\" engine expects non-empty selector list`);\n    return evaluator.query({ ...context, scope: element }, args).length > 0;\n  },\n\n  // TODO: we do not implement \"relative selectors\", as in \"div:has(> span)\" or \"div:has(+ span)\".\n\n  // TODO: we can implement efficient \"query\" by matching \"args\" and returning\n  // all parents/descendants, just have to be careful with the \":scope\" matching.\n};\n\nconst scopeEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length !== 0)\n      throw new Error(`\"scope\" engine expects no arguments`);\n    if (context.scope.nodeType === 9 /* Node.DOCUMENT_NODE */)\n      return element === (context.scope as Document).documentElement;\n    return element === context.scope;\n  },\n\n  query(context: QueryContext, args: (string | number | Selector)[], evaluator: SelectorEvaluator): Element[] {\n    if (args.length !== 0)\n      throw new Error(`\"scope\" engine expects no arguments`);\n    if (context.scope.nodeType === 9 /* Node.DOCUMENT_NODE */) {\n      const root = (context.scope as Document).documentElement;\n      return root ? [root] : [];\n    }\n    if (context.scope.nodeType === 1 /* Node.ELEMENT_NODE */)\n      return [context.scope as Element];\n    return [];\n  },\n};\n\nconst notEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length === 0)\n      throw new Error(`\"not\" engine expects non-empty selector list`);\n    return !evaluator.matches(element, args, context);\n  },\n};\n\nconst lightEngine: SelectorEngine = {\n  query(context: QueryContext, args: (string | number | Selector)[], evaluator: SelectorEvaluator): Element[] {\n    return evaluator.query({ ...context, pierceShadow: false }, args);\n  },\n\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    return evaluator.matches(element, args, { ...context, pierceShadow: false });\n  }\n};\n\nconst visibleEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length)\n      throw new Error(`\"visible\" engine expects no arguments`);\n    return isVisible(element);\n  }\n};\n\nconst textEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length !== 1 || typeof args[0] !== 'string')\n      throw new Error(`\"text\" engine expects a single string`);\n    const matcher = createLaxTextMatcher(args[0]);\n    return elementMatchesText(evaluator as SelectorEvaluatorImpl, element, matcher) === 'self';\n  },\n};\n\nconst textIsEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length !== 1 || typeof args[0] !== 'string')\n      throw new Error(`\"text-is\" engine expects a single string`);\n    const matcher = createStrictTextMatcher(args[0]);\n    return elementMatchesText(evaluator as SelectorEvaluatorImpl, element, matcher) !== 'none';\n  },\n};\n\nconst textMatchesEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length === 0 || typeof args[0] !== 'string' || args.length > 2 || (args.length === 2 && typeof args[1] !== 'string'))\n      throw new Error(`\"text-matches\" engine expects a regexp body and optional regexp flags`);\n    const matcher = createRegexTextMatcher(args[0], args.length === 2 ? args[1] : undefined);\n    return elementMatchesText(evaluator as SelectorEvaluatorImpl, element, matcher) === 'self';\n  },\n};\n\nconst hasTextEngine: SelectorEngine = {\n  matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n    if (args.length !== 1 || typeof args[0] !== 'string')\n      throw new Error(`\"has-text\" engine expects a single string`);\n    if (shouldSkipForTextMatching(element))\n      return false;\n    const matcher = createLaxTextMatcher(args[0]);\n    return matcher(elementText(evaluator as SelectorEvaluatorImpl, element));\n  },\n};\n\nexport function createLaxTextMatcher(text: string): TextMatcher {\n  text = text.trim().replace(/\\s+/g, ' ').toLowerCase();\n  return (elementText: ElementText) => {\n    const s = elementText.full.trim().replace(/\\s+/g, ' ').toLowerCase();\n    return s.includes(text);\n  };\n}\n\nexport function createStrictTextMatcher(text: string): TextMatcher {\n  text = text.trim().replace(/\\s+/g, ' ');\n  return (elementText: ElementText) => {\n    return elementText.immediate.some(s => s.trim().replace(/\\s+/g, ' ') === text);\n  };\n}\n\nexport function createRegexTextMatcher(source: string, flags?: string): TextMatcher {\n  const re = new RegExp(source, flags);\n  return (elementText: ElementText) => {\n    return re.test(elementText.full);\n  };\n}\n\nfunction shouldSkipForTextMatching(element: Element | ShadowRoot) {\n  return element.nodeName === 'SCRIPT' || element.nodeName === 'STYLE' || document.head && document.head.contains(element);\n}\n\nexport type ElementText = { full: string, immediate: string[] };\nexport type TextMatcher = (text: ElementText) => boolean;\n\nexport function elementText(evaluator: SelectorEvaluatorImpl, root: Element | ShadowRoot): ElementText {\n  let value = evaluator._cacheText.get(root);\n  if (value === undefined) {\n    value = { full: '', immediate: [] };\n    if (!shouldSkipForTextMatching(root)) {\n      let currentImmediate = '';\n      if ((root instanceof HTMLInputElement) && (root.type === 'submit' || root.type === 'button')) {\n        value = { full: root.value, immediate: [root.value] };\n      } else {\n        for (let child = root.firstChild; child; child = child.nextSibling) {\n          if (child.nodeType === Node.TEXT_NODE) {\n            value.full += child.nodeValue || '';\n            currentImmediate += child.nodeValue || '';\n          } else {\n            if (currentImmediate)\n              value.immediate.push(currentImmediate);\n            currentImmediate = '';\n            if (child.nodeType === Node.ELEMENT_NODE)\n              value.full += elementText(evaluator, child as Element).full;\n          }\n        }\n        if (currentImmediate)\n          value.immediate.push(currentImmediate);\n        if ((root as Element).shadowRoot)\n          value.full += elementText(evaluator, (root as Element).shadowRoot!).full;\n      }\n    }\n    evaluator._cacheText.set(root, value);\n  }\n  return value;\n}\n\nexport function elementMatchesText(evaluator: SelectorEvaluatorImpl, element: Element, matcher: TextMatcher): 'none' | 'self' | 'selfAndChildren' {\n  if (shouldSkipForTextMatching(element))\n    return 'none';\n  if (!matcher(elementText(evaluator, element)))\n    return 'none';\n  for (let child = element.firstChild; child; child = child.nextSibling) {\n    if (child.nodeType === Node.ELEMENT_NODE && matcher(elementText(evaluator, child as Element)))\n      return 'selfAndChildren';\n  }\n  if (element.shadowRoot && matcher(elementText(evaluator, element.shadowRoot)))\n    return 'selfAndChildren';\n  return 'self';\n}\n\nfunction boxRightOf(box1: DOMRect, box2: DOMRect, maxDistance: number | undefined): number | undefined {\n  const distance = box1.left - box2.right;\n  if (distance < 0 || (maxDistance !== undefined && distance > maxDistance))\n    return;\n  return distance + Math.max(box2.bottom - box1.bottom, 0) + Math.max(box1.top - box2.top, 0);\n}\n\nfunction boxLeftOf(box1: DOMRect, box2: DOMRect, maxDistance: number | undefined): number | undefined {\n  const distance = box2.left - box1.right;\n  if (distance < 0 || (maxDistance !== undefined && distance > maxDistance))\n    return;\n  return distance + Math.max(box2.bottom - box1.bottom, 0) + Math.max(box1.top - box2.top, 0);\n}\n\nfunction boxAbove(box1: DOMRect, box2: DOMRect, maxDistance: number | undefined): number | undefined {\n  const distance = box2.top - box1.bottom;\n  if (distance < 0 || (maxDistance !== undefined && distance > maxDistance))\n    return;\n  return distance + Math.max(box1.left - box2.left, 0) + Math.max(box2.right - box1.right, 0);\n}\n\nfunction boxBelow(box1: DOMRect, box2: DOMRect, maxDistance: number | undefined): number | undefined {\n  const distance = box1.top - box2.bottom;\n  if (distance < 0 || (maxDistance !== undefined && distance > maxDistance))\n    return;\n  return distance + Math.max(box1.left - box2.left, 0) + Math.max(box2.right - box1.right, 0);\n}\n\nfunction boxNear(box1: DOMRect, box2: DOMRect, maxDistance: number | undefined): number | undefined {\n  const kThreshold = maxDistance === undefined ? 50 : maxDistance;\n  let score = 0;\n  if (box1.left - box2.right >= 0)\n    score += box1.left - box2.right;\n  if (box2.left - box1.right >= 0)\n    score += box2.left - box1.right;\n  if (box2.top - box1.bottom >= 0)\n    score += box2.top - box1.bottom;\n  if (box1.top - box2.bottom >= 0)\n    score += box1.top - box2.bottom;\n  return score > kThreshold ? undefined : score;\n}\n\nfunction createPositionEngine(name: string, scorer: (box1: DOMRect, box2: DOMRect, maxDistance: number | undefined) => number | undefined): SelectorEngine {\n  return {\n    matches(element: Element, args: (string | number | Selector)[], context: QueryContext, evaluator: SelectorEvaluator): boolean {\n      const maxDistance = args.length && typeof args[args.length - 1] === 'number' ? args[args.length - 1] : undefined;\n      const queryArgs = maxDistance === undefined ? args : args.slice(0, args.length - 1);\n      if (args.length < 1 + (maxDistance === undefined ? 0 : 1))\n        throw new Error(`\"${name}\" engine expects a selector list and optional maximum distance in pixels`);\n      const box = element.getBoundingClientRect();\n      let bestScore: number | undefined;\n      for (const e of evaluator.query(context, queryArgs)) {\n        if (e === element)\n          continue;\n        const score = scorer(box, e.getBoundingClientRect(), maxDistance);\n        if (score === undefined)\n          continue;\n        if (bestScore === undefined || score < bestScore)\n          bestScore = score;\n      }\n      if (bestScore === undefined)\n        return false;\n      (evaluator as SelectorEvaluatorImpl)._markScore(element, bestScore);\n      return true;\n    }\n  };\n}\n\nconst nthMatchEngine: SelectorEngine = {\n  query(context: QueryContext, args: (string | number | Selector)[], evaluator: SelectorEvaluator): Element[] {\n    let index = args[args.length - 1];\n    if (args.length < 2)\n      throw new Error(`\"nth-match\" engine expects non-empty selector list and an index argument`);\n    if (typeof index !== 'number' || index < 1)\n      throw new Error(`\"nth-match\" engine expects a one-based index as the last argument`);\n    const elements = isEngine.query!(context, args.slice(0, args.length - 1), evaluator);\n    index--;  // one-based\n    return index < elements.length ? [elements[index]] : [];\n  },\n};\n\nexport function parentElementOrShadowHost(element: Element): Element | undefined {\n  if (element.parentElement)\n    return element.parentElement;\n  if (!element.parentNode)\n    return;\n  if (element.parentNode.nodeType === Node.DOCUMENT_FRAGMENT_NODE && (element.parentNode as ShadowRoot).host)\n    return (element.parentNode as ShadowRoot).host;\n}\n\nfunction parentElementOrShadowHostInContext(element: Element, context: QueryContext): Element | undefined {\n  if (element === context.scope)\n    return;\n  if (!context.pierceShadow)\n    return element.parentElement || undefined;\n  return parentElementOrShadowHost(element);\n}\n\nfunction previousSiblingInContext(element: Element, context: QueryContext): Element | undefined {\n  if (element === context.scope)\n    return;\n  return element.previousElementSibling || undefined;\n}\n\nexport function isVisible(element: Element): boolean {\n  // Note: this logic should be similar to waitForDisplayedAtStablePosition() to avoid surprises.\n  if (!element.ownerDocument || !element.ownerDocument.defaultView)\n    return true;\n  const style = element.ownerDocument.defaultView.getComputedStyle(element);\n  if (!style || style.visibility === 'hidden')\n    return false;\n  const rect = element.getBoundingClientRect();\n  return rect.width > 0 && rect.height > 0;\n}\n\nfunction sortInDOMOrder(elements: Element[]): Element[] {\n  type SortEntry = { children: Element[], taken: boolean };\n\n  const elementToEntry = new Map<Element, SortEntry>();\n  const roots: Element[] = [];\n  const result: Element[] = [];\n\n  function append(element: Element): SortEntry {\n    let entry = elementToEntry.get(element);\n    if (entry)\n      return entry;\n    const parent = parentElementOrShadowHost(element);\n    if (parent) {\n      const parentEntry = append(parent);\n      parentEntry.children.push(element);\n    } else {\n      roots.push(element);\n    }\n    entry = { children: [], taken: false };\n    elementToEntry.set(element, entry);\n    return entry;\n  }\n  elements.forEach(e => append(e).taken = true);\n\n  function visit(element: Element) {\n    const entry = elementToEntry.get(element)!;\n    if (entry.taken)\n      result.push(element);\n    if (entry.children.length > 1) {\n      const set = new Set(entry.children);\n      entry.children = [];\n      let child = element.firstElementChild;\n      while (child && entry.children.length < set.size) {\n        if (set.has(child))\n          entry.children.push(child);\n        child = child.nextElementSibling;\n      }\n      child = element.shadowRoot ? element.shadowRoot.firstElementChild : null;\n      while (child && entry.children.length < set.size) {\n        if (set.has(child))\n          entry.children.push(child);\n        child = child.nextElementSibling;\n      }\n    }\n    entry.children.forEach(visit);\n  }\n  roots.forEach(visit);\n\n  return result;\n}\n"],"file":"selectorEvaluator.js"}