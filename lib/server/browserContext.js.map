{"version":3,"sources":["../../src/server/browserContext.ts"],"names":["BrowserContext","SdkObject","constructor","browser","options","browserContextId","_timeoutSettings","TimeoutSettings","_pageBindings","Map","_options","_requestInterceptor","_isPersistentContext","_closedStatus","_closePromise","_closePromiseFulfill","_permissions","_downloads","Set","_browser","_browserContextId","_selectors","_origins","_harTracer","tracing","attribution","context","Promise","fulfill","recordHar","HarTracer","Tracing","_setSelectors","selectors","_initialize","isInternal","instrumentation","contextDebugger","Debugger","addListener","RecorderSupplement","show","pauseOnNextStatement","isPaused","showInspector","on","Events","PausedStateChanged","extendInjectedScript","consoleApiSource","source","_ensureVideosPath","recordVideo","path","join","dir","_browserClosed","page","pages","_didClose","_didCloseInternal","_deleteAllDownloads","clear","_onClosePersistent","Error","emit","Close","cookies","urls","Array","isArray","_doCookies","setHTTPCredentials","httpCredentials","_doSetHTTPCredentials","exposeBinding","name","needsHandle","playwrightBinding","world","identifier","PageBinding","has","getBinding","binding","set","_doExposeBinding","grantPermissions","permissions","origin","resolvedOrigin","url","URL","existing","get","forEach","p","add","list","values","_doGrantPermissions","clearPermissions","_doClearPermissions","setDefaultNavigationTimeout","timeout","setDefaultTimeout","_loadDefaultContextAsIs","progress","length","waitForEvent","helper","Page","cleanupWhenAborted","dispose","promise","_pageIsError","mainFrame","_waitForLoadState","_loadDefaultContext","isMobile","locale","oldPage","newPage","metadata","close","_authenticateProxyViaHeader","proxy","username","undefined","password","token","Buffer","from","toString","extraHTTPHeaders","network","mergeHeaders","singleHeader","_authenticateProxyViaCredentials","_setRequestInterceptor","handler","_doUpdateRequestInterception","isClosingOrClosed","all","map","download","artifact","deleteOnContextClose","BeforeClose","flush","promises","_idToVideo","push","finishedPromise","_doClose","pageDelegate","newPageDelegate","pageOrError","isClosed","addVisitedOrigin","storageState","result","filter","c","value","origins","size","internalMetadata","_setServerRequestInterceptor","body","catch","originStorage","localStorage","frame","goto","storage","evaluateExpression","setStorageState","state","addCookies","originState","arg","installInFrame","installInPage","InternalFrameNavigatedToNewDocument","frames","Request","Response","RequestFailed","RequestFinished","VideoStarted","assertBrowserContextIsNotOwned","_ownedContext","validateBrowserContextOptions","browserOptions","noDefaultViewport","deviceScaleFactor","viewport","width","height","scale","Math","min","max","floor","isChromium","os","platform","normalizeProxySettings","bypassCSP","verifyGeolocation","geolocation","_debugName","accuracy","longitude","latitude","server","bypass","host","protocol","e","split","t","trim"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as os from 'os';\nimport { TimeoutSettings } from '../utils/timeoutSettings';\nimport { debugMode, mkdirIfNeeded, createGuid } from '../utils/utils';\nimport { Browser, BrowserOptions } from './browser';\nimport { Download } from './download';\nimport * as frames from './frames';\nimport { helper } from './helper';\nimport * as network from './network';\nimport { Page, PageBinding, PageDelegate } from './page';\nimport { Progress } from './progress';\nimport { Selectors } from './selectors';\nimport * as types from './types';\nimport path from 'path';\nimport { CallMetadata, internalCallMetadata, createInstrumentation, SdkObject } from './instrumentation';\nimport { Debugger } from './supplements/debugger';\nimport { Tracing } from './trace/recorder/tracing';\nimport { HarTracer } from './supplements/har/harTracer';\nimport { RecorderSupplement } from './supplements/recorderSupplement';\nimport * as consoleApiSource from '../generated/consoleApiSource';\n\nexport abstract class BrowserContext extends SdkObject {\n  static Events = {\n    Close: 'close',\n    Page: 'page',\n    Request: 'request',\n    Response: 'response',\n    RequestFailed: 'requestfailed',\n    RequestFinished: 'requestfinished',\n    BeforeClose: 'beforeclose',\n    VideoStarted: 'videostarted',\n  };\n\n  readonly _timeoutSettings = new TimeoutSettings();\n  readonly _pageBindings = new Map<string, PageBinding>();\n  readonly _options: types.BrowserContextOptions;\n  _requestInterceptor?: network.RouteHandler;\n  private _isPersistentContext: boolean;\n  private _closedStatus: 'open' | 'closing' | 'closed' = 'open';\n  readonly _closePromise: Promise<Error>;\n  private _closePromiseFulfill: ((error: Error) => void) | undefined;\n  readonly _permissions = new Map<string, string[]>();\n  readonly _downloads = new Set<Download>();\n  readonly _browser: Browser;\n  readonly _browserContextId: string | undefined;\n  private _selectors?: Selectors;\n  private _origins = new Set<string>();\n  private _harTracer: HarTracer | undefined;\n  readonly tracing: Tracing;\n\n  constructor(browser: Browser, options: types.BrowserContextOptions, browserContextId: string | undefined) {\n    super(browser, 'browser-context');\n    this.attribution.context = this;\n    this._browser = browser;\n    this._options = options;\n    this._browserContextId = browserContextId;\n    this._isPersistentContext = !browserContextId;\n    this._closePromise = new Promise(fulfill => this._closePromiseFulfill = fulfill);\n\n    if (this._options.recordHar)\n      this._harTracer = new HarTracer(this, this._options.recordHar);\n    this.tracing = new Tracing(this);\n  }\n\n  _setSelectors(selectors: Selectors) {\n    this._selectors = selectors;\n  }\n\n  selectors(): Selectors {\n    return this._selectors || this._browser.options.selectors;\n  }\n\n  async _initialize() {\n    if (this.attribution.isInternal)\n      return;\n    // Create instrumentation per context.\n    this.instrumentation = createInstrumentation();\n\n    // Debugger will pause execution upon page.pause in headed mode.\n    const contextDebugger = new Debugger(this);\n    this.instrumentation.addListener(contextDebugger);\n\n    // When PWDEBUG=1, show inspector for each context.\n    if (debugMode() === 'inspector')\n      await RecorderSupplement.show(this, { pauseOnNextStatement: true });\n\n    // When paused, show inspector.\n    if (contextDebugger.isPaused())\n      RecorderSupplement.showInspector(this);\n    contextDebugger.on(Debugger.Events.PausedStateChanged, () => {\n      RecorderSupplement.showInspector(this);\n    });\n\n    if (debugMode() === 'console')\n      await this.extendInjectedScript('main', consoleApiSource.source);\n  }\n\n  async _ensureVideosPath() {\n    if (this._options.recordVideo)\n      await mkdirIfNeeded(path.join(this._options.recordVideo.dir, 'dummy'));\n  }\n\n  _browserClosed() {\n    for (const page of this.pages())\n      page._didClose();\n    this._didCloseInternal();\n  }\n\n  private _didCloseInternal() {\n    if (this._closedStatus === 'closed') {\n      // We can come here twice if we close browser context and browser\n      // at the same time.\n      return;\n    }\n    this._closedStatus = 'closed';\n    this._deleteAllDownloads();\n    this._downloads.clear();\n    if (this._isPersistentContext)\n      this._onClosePersistent();\n    this._closePromiseFulfill!(new Error('Context closed'));\n    this.emit(BrowserContext.Events.Close);\n  }\n\n  // BrowserContext methods.\n  abstract pages(): Page[];\n  abstract newPageDelegate(): Promise<PageDelegate>;\n  abstract _doCookies(urls: string[]): Promise<types.NetworkCookie[]>;\n  abstract addCookies(cookies: types.SetNetworkCookieParam[]): Promise<void>;\n  abstract clearCookies(): Promise<void>;\n  abstract _doGrantPermissions(origin: string, permissions: string[]): Promise<void>;\n  abstract _doClearPermissions(): Promise<void>;\n  abstract setGeolocation(geolocation?: types.Geolocation): Promise<void>;\n  abstract _doSetHTTPCredentials(httpCredentials?: types.Credentials): Promise<void>;\n  abstract setExtraHTTPHeaders(headers: types.HeadersArray): Promise<void>;\n  abstract setOffline(offline: boolean): Promise<void>;\n  abstract _doAddInitScript(expression: string): Promise<void>;\n  abstract _doExposeBinding(binding: PageBinding): Promise<void>;\n  abstract _doUpdateRequestInterception(): Promise<void>;\n  abstract _doClose(): Promise<void>;\n  abstract _onClosePersistent(): void;\n  abstract _doCancelDownload(uuid: string): Promise<void>;\n\n  async cookies(urls: string | string[] | undefined = []): Promise<types.NetworkCookie[]> {\n    if (urls && !Array.isArray(urls))\n      urls = [ urls ];\n    return await this._doCookies(urls as string[]);\n  }\n\n  setHTTPCredentials(httpCredentials?: types.Credentials): Promise<void> {\n    return this._doSetHTTPCredentials(httpCredentials);\n  }\n\n  async exposeBinding(name: string, needsHandle: boolean, playwrightBinding: frames.FunctionWithSource, world: types.World): Promise<void> {\n    const identifier = PageBinding.identifier(name, world);\n    if (this._pageBindings.has(identifier))\n      throw new Error(`Function \"${name}\" has been already registered`);\n    for (const page of this.pages()) {\n      if (page.getBinding(name, world))\n        throw new Error(`Function \"${name}\" has been already registered in one of the pages`);\n    }\n    const binding = new PageBinding(name, playwrightBinding, needsHandle, world);\n    this._pageBindings.set(identifier, binding);\n    await this._doExposeBinding(binding);\n  }\n\n  async grantPermissions(permissions: string[], origin?: string) {\n    let resolvedOrigin = '*';\n    if (origin) {\n      const url = new URL(origin);\n      resolvedOrigin = url.origin;\n    }\n    const existing = new Set(this._permissions.get(resolvedOrigin) || []);\n    permissions.forEach(p => existing.add(p));\n    const list = [...existing.values()];\n    this._permissions.set(resolvedOrigin, list);\n    await this._doGrantPermissions(resolvedOrigin, list);\n  }\n\n  async clearPermissions() {\n    this._permissions.clear();\n    await this._doClearPermissions();\n  }\n\n  setDefaultNavigationTimeout(timeout: number) {\n    this._timeoutSettings.setDefaultNavigationTimeout(timeout);\n  }\n\n  setDefaultTimeout(timeout: number) {\n    this._timeoutSettings.setDefaultTimeout(timeout);\n  }\n\n  async _loadDefaultContextAsIs(progress: Progress): Promise<Page[]> {\n    if (!this.pages().length) {\n      const waitForEvent = helper.waitForEvent(progress, this, BrowserContext.Events.Page);\n      progress.cleanupWhenAborted(() => waitForEvent.dispose);\n      const page = (await waitForEvent.promise) as Page;\n      if (page._pageIsError)\n        throw page._pageIsError;\n    }\n    const pages = this.pages();\n    if (pages[0]._pageIsError)\n      throw pages[0]._pageIsError;\n    await pages[0].mainFrame()._waitForLoadState(progress, 'load');\n    return pages;\n  }\n\n  async _loadDefaultContext(progress: Progress) {\n    const pages = await this._loadDefaultContextAsIs(progress);\n    if (this._options.isMobile || this._options.locale) {\n      // Workaround for:\n      // - chromium fails to change isMobile for existing page;\n      // - webkit fails to change locale for existing page.\n      const oldPage = pages[0];\n      await this.newPage(progress.metadata);\n      await oldPage.close(progress.metadata);\n    }\n  }\n\n  protected _authenticateProxyViaHeader() {\n    const proxy = this._options.proxy || this._browser.options.proxy || { username: undefined, password: undefined };\n    const { username, password } = proxy;\n    if (username) {\n      this._options.httpCredentials = { username, password: password! };\n      const token = Buffer.from(`${username}:${password}`).toString('base64');\n      this._options.extraHTTPHeaders = network.mergeHeaders([\n        this._options.extraHTTPHeaders,\n        network.singleHeader('Proxy-Authorization', `Basic ${token}`),\n      ]);\n    }\n  }\n\n  protected _authenticateProxyViaCredentials() {\n    const proxy = this._options.proxy || this._browser.options.proxy;\n    if (!proxy)\n      return;\n    const { username, password } = proxy;\n    if (username)\n      this._options.httpCredentials = { username, password: password || '' };\n  }\n\n  async _setRequestInterceptor(handler: network.RouteHandler | undefined): Promise<void> {\n    this._requestInterceptor = handler;\n    await this._doUpdateRequestInterception();\n  }\n\n  isClosingOrClosed() {\n    return this._closedStatus !== 'open';\n  }\n\n  private async _deleteAllDownloads(): Promise<void> {\n    await Promise.all(Array.from(this._downloads).map(download => download.artifact.deleteOnContextClose()));\n  }\n\n  async close(metadata: CallMetadata) {\n    if (this._closedStatus === 'open') {\n      this.emit(BrowserContext.Events.BeforeClose);\n      this._closedStatus = 'closing';\n\n      await this._harTracer?.flush();\n      await this.tracing.dispose();\n\n      // Cleanup.\n      const promises: Promise<void>[] = [];\n      for (const { context, artifact } of this._browser._idToVideo.values()) {\n        // Wait for the videos to finish.\n        if (context === this)\n          promises.push(artifact.finishedPromise());\n      }\n\n      if (this._isPersistentContext) {\n        // Close all the pages instead of the context,\n        // because we cannot close the default context.\n        await Promise.all(this.pages().map(page => page.close(metadata)));\n      } else {\n        // Close the context.\n        await this._doClose();\n      }\n\n      // We delete downloads after context closure\n      // so that browser does not write to the download file anymore.\n      promises.push(this._deleteAllDownloads());\n      await Promise.all(promises);\n\n      // Persistent context should also close the browser.\n      if (this._isPersistentContext)\n        await this._browser.close();\n\n      // Bookkeeping.\n      this._didCloseInternal();\n    }\n    await this._closePromise;\n  }\n\n  async newPage(metadata: CallMetadata): Promise<Page> {\n    const pageDelegate = await this.newPageDelegate();\n    const pageOrError = await pageDelegate.pageOrError();\n    if (pageOrError instanceof Page) {\n      if (pageOrError.isClosed())\n        throw new Error('Page has been closed.');\n      return pageOrError;\n    }\n    throw pageOrError;\n  }\n\n  addVisitedOrigin(origin: string) {\n    this._origins.add(origin);\n  }\n\n  async storageState(metadata: CallMetadata): Promise<types.StorageState> {\n    const result: types.StorageState = {\n      cookies: (await this.cookies()).filter(c => c.value !== ''),\n      origins: []\n    };\n    if (this._origins.size)  {\n      const internalMetadata = internalCallMetadata();\n      const page = await this.newPage(internalMetadata);\n      await page._setServerRequestInterceptor(handler => {\n        handler.fulfill({ body: '<html></html>' }).catch(() => {});\n      });\n      for (const origin of this._origins) {\n        const originStorage: types.OriginStorage = { origin, localStorage: [] };\n        const frame = page.mainFrame();\n        await frame.goto(internalMetadata, origin);\n        const storage = await frame.evaluateExpression(`({\n          localStorage: Object.keys(localStorage).map(name => ({ name, value: localStorage.getItem(name) })),\n        })`, false, undefined, 'utility');\n        originStorage.localStorage = storage.localStorage;\n        if (storage.localStorage.length)\n          result.origins.push(originStorage);\n      }\n      await page.close(internalMetadata);\n    }\n    return result;\n  }\n\n  async setStorageState(metadata: CallMetadata, state: types.SetStorageState) {\n    if (state.cookies)\n      await this.addCookies(state.cookies);\n    if (state.origins && state.origins.length)  {\n      const internalMetadata = internalCallMetadata();\n      const page = await this.newPage(internalMetadata);\n      await page._setServerRequestInterceptor(handler => {\n        handler.fulfill({ body: '<html></html>' }).catch(() => {});\n      });\n      for (const originState of state.origins) {\n        const frame = page.mainFrame();\n        await frame.goto(metadata, originState.origin);\n        await frame.evaluateExpression(`\n          originState => {\n            for (const { name, value } of (originState.localStorage || []))\n              localStorage.setItem(name, value);\n          }`, true, originState, 'utility');\n      }\n      await page.close(internalMetadata);\n    }\n  }\n\n  async extendInjectedScript(world: types.World, source: string, arg?: any) {\n    const installInFrame = (frame: frames.Frame) => frame.extendInjectedScript(world, source, arg).catch(() => {});\n    const installInPage = (page: Page) => {\n      page.on(Page.Events.InternalFrameNavigatedToNewDocument, installInFrame);\n      return Promise.all(page.frames().map(installInFrame));\n    };\n    this.on(BrowserContext.Events.Page, installInPage);\n    return Promise.all(this.pages().map(installInPage));\n  }\n}\n\nexport function assertBrowserContextIsNotOwned(context: BrowserContext) {\n  for (const page of context.pages()) {\n    if (page._ownedContext)\n      throw new Error('Please use browser.newContext() for multi-page scripts that share the context.');\n  }\n}\n\nexport function validateBrowserContextOptions(options: types.BrowserContextOptions, browserOptions: BrowserOptions) {\n  if (options.noDefaultViewport && options.deviceScaleFactor !== undefined)\n    throw new Error(`\"deviceScaleFactor\" option is not supported with null \"viewport\"`);\n  if (options.noDefaultViewport && options.isMobile !== undefined)\n    throw new Error(`\"isMobile\" option is not supported with null \"viewport\"`);\n  if (!options.viewport && !options.noDefaultViewport)\n    options.viewport = { width: 1280, height: 720 };\n  if (options.recordVideo) {\n    if (!options.recordVideo.size) {\n      if (options.noDefaultViewport) {\n        options.recordVideo.size = { width: 800, height: 600 };\n      } else {\n        const size = options.viewport!;\n        const scale = Math.min(1, 800 / Math.max(size.width, size.height));\n        options.recordVideo.size = {\n          width: Math.floor(size.width * scale),\n          height: Math.floor(size.height * scale)\n        };\n      }\n    }\n    // Make sure both dimensions are odd, this is required for vp8\n    options.recordVideo.size!.width &= ~1;\n    options.recordVideo.size!.height &= ~1;\n  }\n  if (options.proxy) {\n    if (!browserOptions.proxy && browserOptions.isChromium && os.platform() === 'win32')\n      throw new Error(`Browser needs to be launched with the global proxy. If all contexts override the proxy, global proxy will be never used and can be any string, for example \"launch({ proxy: { server: 'http://per-context' } })\"`);\n    options.proxy = normalizeProxySettings(options.proxy);\n  }\n  if (debugMode() === 'inspector')\n    options.bypassCSP = true;\n  verifyGeolocation(options.geolocation);\n  if (!options._debugName)\n    options._debugName = createGuid();\n}\n\nexport function verifyGeolocation(geolocation?: types.Geolocation) {\n  if (!geolocation)\n    return;\n  geolocation.accuracy = geolocation.accuracy || 0;\n  const { longitude, latitude, accuracy } = geolocation;\n  if (longitude < -180 || longitude > 180)\n    throw new Error(`geolocation.longitude: precondition -180 <= LONGITUDE <= 180 failed.`);\n  if (latitude < -90 || latitude > 90)\n    throw new Error(`geolocation.latitude: precondition -90 <= LATITUDE <= 90 failed.`);\n  if (accuracy < 0)\n    throw new Error(`geolocation.accuracy: precondition 0 <= ACCURACY failed.`);\n}\n\nexport function normalizeProxySettings(proxy: types.ProxySettings): types.ProxySettings {\n  let { server, bypass } = proxy;\n  let url;\n  try {\n    // new URL('127.0.0.1:8080') throws\n    // new URL('localhost:8080') fails to parse host or protocol\n    // In both of these cases, we need to try re-parse URL with `http://` prefix.\n    url = new URL(server);\n    if (!url.host || !url.protocol)\n      url = new URL('http://' + server);\n  } catch (e) {\n    url = new URL('http://' + server);\n  }\n  if (url.protocol === 'socks4:' && (proxy.username || proxy.password))\n    throw new Error(`Socks4 proxy protocol does not support authentication`);\n  if (url.protocol === 'socks5:' && (proxy.username || proxy.password))\n    throw new Error(`Browser does not support socks5 proxy authentication`);\n  server = url.protocol + '//' + url.host;\n  if (bypass)\n    bypass = bypass.split(',').map(t => t.trim()).join(',');\n  return { ...proxy, server, bypass };\n}\n"],"file":"browserContext.js"}