{"version":3,"sources":["../../../../src/server/trace/viewer/traceModel.ts"],"names":["TraceModel","constructor","snapshotStorage","contextEntry","pageEntries","Map","_snapshotStorage","_version","startTime","Number","MAX_VALUE","endTime","MIN_VALUE","browserName","options","sdkLanguage","pages","resources","build","page","actions","sort","a1","a2","metadata","_pageEntry","pageId","pageEntry","get","events","objects","screencastFrames","set","push","appendEvent","line","event","_modernize","JSON","parse","type","version","include","hasSnapshot","method","params","guid","initializer","addResource","snapshot","addFrameSnapshot","Math","min","max","undefined","VERSION","call","_modernize_0_to_1","error","name","message","_modernize_1_to_2","isMainFrame","viewport","width","height","PersistentSnapshotStorage","BaseSnapshotStorage","resourcesDir","_resourcesDir","resourceContent","sha1","fs","readFileSync","path","join"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport path from 'path';\nimport * as trace from '../common/traceEvents';\nimport { ResourceSnapshot } from '../../snapshot/snapshotTypes';\nimport { BaseSnapshotStorage } from '../../snapshot/snapshotStorage';\nimport { BrowserContextOptions } from '../../types';\nimport { shouldCaptureSnapshot, VERSION } from '../recorder/tracing';\nexport * as trace from '../common/traceEvents';\n\nexport class TraceModel {\n  contextEntry: ContextEntry;\n  pageEntries = new Map<string, PageEntry>();\n  private _snapshotStorage: PersistentSnapshotStorage;\n  private _version: number | undefined;\n\n  constructor(snapshotStorage: PersistentSnapshotStorage) {\n    this._snapshotStorage = snapshotStorage;\n    this.contextEntry = {\n      startTime: Number.MAX_VALUE,\n      endTime: Number.MIN_VALUE,\n      browserName: '',\n      options: { sdkLanguage: '' },\n      pages: [],\n      resources: [],\n    };\n  }\n\n  build() {\n    for (const page of this.contextEntry!.pages)\n      page.actions.sort((a1, a2) => a1.metadata.startTime - a2.metadata.startTime);\n    this.contextEntry!.resources = this._snapshotStorage.resources();\n  }\n\n  private _pageEntry(pageId: string): PageEntry {\n    let pageEntry = this.pageEntries.get(pageId);\n    if (!pageEntry) {\n      pageEntry = {\n        actions: [],\n        events: [],\n        objects: {},\n        screencastFrames: [],\n      };\n      this.pageEntries.set(pageId, pageEntry);\n      this.contextEntry.pages.push(pageEntry);\n    }\n    return pageEntry;\n  }\n\n  appendEvent(line: string) {\n    const event = this._modernize(JSON.parse(line));\n    switch (event.type) {\n      case 'context-options': {\n        this._version = event.version || 0;\n        this.contextEntry.browserName = event.browserName;\n        this.contextEntry.options = event.options;\n        break;\n      }\n      case 'screencast-frame': {\n        this._pageEntry(event.pageId).screencastFrames.push(event);\n        break;\n      }\n      case 'action': {\n        const metadata = event.metadata;\n        const include = event.hasSnapshot;\n        if (include && metadata.pageId)\n          this._pageEntry(metadata.pageId).actions.push(event);\n        break;\n      }\n      case 'event': {\n        const metadata = event.metadata;\n        if (metadata.pageId) {\n          if (metadata.method === '__create__')\n            this._pageEntry(metadata.pageId).objects[metadata.params.guid] = metadata.params.initializer;\n          else\n            this._pageEntry(metadata.pageId).events.push(event);\n        }\n        break;\n      }\n      case 'resource-snapshot':\n        this._snapshotStorage.addResource(event.snapshot);\n        break;\n      case 'frame-snapshot':\n        this._snapshotStorage.addFrameSnapshot(event.snapshot);\n        break;\n    }\n    if (event.type === 'action' || event.type === 'event') {\n      this.contextEntry!.startTime = Math.min(this.contextEntry!.startTime, event.metadata.startTime);\n      this.contextEntry!.endTime = Math.max(this.contextEntry!.endTime, event.metadata.endTime);\n    }\n  }\n\n  private _modernize(event: any): trace.TraceEvent {\n    if (this._version === undefined)\n      return event;\n    for (let version = this._version; version < VERSION; ++version)\n      event = (this as any)[`_modernize_${version}_to_${version + 1}`].call(this, event);\n    return event;\n  }\n\n  _modernize_0_to_1(event: any): any {\n    if (event.type === 'action') {\n      if (typeof event.metadata.error === 'string')\n        event.metadata.error = { error: { name: 'Error', message: event.metadata.error } };\n      if (event.metadata && typeof event.hasSnapshot !== 'boolean')\n        event.hasSnapshot = shouldCaptureSnapshot(event.metadata);\n    }\n    return event;\n  }\n\n  _modernize_1_to_2(event: any): any {\n    if (event.type === 'frame-snapshot' && event.snapshot.isMainFrame) {\n      // Old versions had completely wrong viewport.\n      event.snapshot.viewport = this.contextEntry.options.viewport || { width: 1280, height: 720 };\n    }\n    return event;\n  }\n}\n\nexport type ContextEntry = {\n  startTime: number;\n  endTime: number;\n  browserName: string;\n  options: BrowserContextOptions;\n  pages: PageEntry[];\n  resources: ResourceSnapshot[];\n};\n\nexport type PageEntry = {\n  actions: trace.ActionTraceEvent[];\n  events: trace.ActionTraceEvent[];\n  objects: { [key: string]: any };\n  screencastFrames: {\n    sha1: string,\n    timestamp: number,\n    width: number,\n    height: number,\n  }[];\n};\n\nexport class PersistentSnapshotStorage extends BaseSnapshotStorage {\n  private _resourcesDir: string;\n\n  constructor(resourcesDir: string) {\n    super();\n    this._resourcesDir = resourcesDir;\n  }\n\n  resourceContent(sha1: string): Buffer | undefined {\n    return fs.readFileSync(path.join(this._resourcesDir, sha1));\n  }\n}\n"],"file":"traceModel.js"}