{"version":3,"sources":["../../../src/server/firefox/ffPage.ts"],"names":["UTILITY_WORLD_NAME","FFPage","constructor","session","browserContext","opener","cspErrorsAsynchronousForInlineScipts","rawMouse","rawKeyboard","rawTouchscreen","_session","_page","_networkManager","_browserContext","_pagePromise","_pageCallback","_initializedPage","_initializationFailed","_opener","_contextIdToContext","_eventListeners","_workers","Map","_screencastId","RawKeyboardImpl","RawMouseImpl","RawTouchscreenImpl","Page","FFNetworkManager","on","Events","FrameDetached","frame","_removeContextsForFrame","eventsHelper","addEventListener","_onEventFired","bind","_onFrameAttached","_onFrameDetached","_onNavigationAborted","_onNavigationCommitted","_onNavigationStarted","_onSameDocumentNavigation","_onExecutionContextCreated","_onExecutionContextDestroyed","event","_onLinkClicked","phase","_onUncaughtError","_onConsole","_onDialogOpened","_onBindingCalled","_onFileChooserOpened","_onWorkerCreated","_onWorkerDestroyed","_onDispatchMessageFromWorker","_onCrashed","_onVideoRecordingStarted","_onWebSocketCreated","_onWebSocketClosed","_onWebSocketFrameReceived","_onWebSocketFrameSent","_onScreencastFrame","Promise","f","once","FFSessionEvents","Disconnected","_markAsError","Error","_didDisconnect","initOpener","reportAsNew","send","script","worldName","catch","e","error","pageOrError","_frameManager","onWebSocketCreated","webSocketId","frameId","wsid","requestURL","onWebSocketRequest","webSocketError","webSocketClosed","webSocketFrameReceived","opcode","data","onWebSocketFrameSent","payload","executionContextId","auxData","delegate","FFExecutionContext","name","context","dom","FrameExecutionContext","_contextCreated","set","get","delete","_contextDestroyed","contextId","frameWillPotentiallyRequestNavigation","frameDidPotentiallyRequestNavigation","params","frameRequestedNavigation","navigationId","frameAbortedNavigation","errorText","workerId","worker","frameCommittedNewDocumentNavigation","url","frameCommittedSameDocumentNavigation","frameAttached","parentFrameId","frameDetached","frameLifecycleEvent","message","stack","split","filter","Boolean","map","a","replace","join","firePageError","type","args","location","_addConsoleMessage","arg","createHandle","emit","Dialog","dialog","accept","promptText","sendMayFail","dialogId","defaultValue","element","handle","asElement","Worker","workerSession","FFSession","_connection","JSON","stringify","dispatchMessage","id","method","undefined","_addWorker","_createExecutionContext","_existingExecutionContext","dispose","_removeWorker","parse","markAsCrashed","_didCrash","_browser","_videoStarted","screencastId","file","exposeBinding","binding","world","source","didClose","removeEventListeners","_didClose","navigateFrame","referer","response","_id","newDocumentId","updateExtraHTTPHeaders","headers","_state","extraHTTPHeaders","setEmulatedSize","emulatedSize","viewportSize","width","viewport","height","bringToFront","updateEmulateMedia","colorScheme","reducedMotion","mediaType","updateRequestInterception","setRequestInterception","_needsRequestInterception","setFileChooserIntercepted","enabled","reload","mainFrame","goBack","success","goForward","evaluateOnNewDocument","closePage","runBeforeUnload","canScreenshotOutsideViewport","setBackgroundColor","color","takeScreenshot","progress","format","documentRect","viewportRect","quality","scrollOffset","waitForFunctionValueInUtility","x","window","scrollX","y","scrollY","throwIfAborted","mimeType","clip","Buffer","from","resetViewport","getContentFrame","contentFrameId","_context","objectId","_objectId","getOwnerFrame","ownerFrameId","isElementHandle","remoteObject","subtype","getBoundingBox","quads","getContentQuads","length","minX","Infinity","maxX","minY","maxY","quad","point","Math","min","max","scrollRectIntoViewIfNeeded","rect","then","includes","setScreencastOptions","options","debugLogger","log","buffer","ScreencastFrame","deviceWidth","deviceHeight","rafCountForStablePosition","result","p1","p2","p3","p4","setInputFiles","files","evaluateInUtility","injected","node","adoptElementHandle","to","_delegate","_executionContextId","kUnableToAdoptErrorMessage","getAccessibilityTree","needle","inputActionEpilogue","getFrameElement","parent","parentFrame","handles","selectors","_queryAll","items","all","contentFrame","find","item","resolve"],"mappings":"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","sourcesContent":["/**\n * Copyright 2019 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dialog from '../dialog';\nimport * as dom from '../dom';\nimport * as frames from '../frames';\nimport { eventsHelper, RegisteredListener } from '../../utils/eventsHelper';\nimport { assert } from '../../utils/utils';\nimport { Page, PageBinding, PageDelegate, Worker } from '../page';\nimport * as types from '../types';\nimport { getAccessibilityTree } from './ffAccessibility';\nimport { FFBrowserContext } from './ffBrowser';\nimport { FFSession, FFSessionEvents } from './ffConnection';\nimport { FFExecutionContext } from './ffExecutionContext';\nimport { RawKeyboardImpl, RawMouseImpl, RawTouchscreenImpl } from './ffInput';\nimport { FFNetworkManager } from './ffNetworkManager';\nimport { Protocol } from './protocol';\nimport { Progress } from '../progress';\nimport { splitErrorMessage } from '../../utils/stackTrace';\nimport { debugLogger } from '../../utils/debugLogger';\n\nexport const UTILITY_WORLD_NAME = '__playwright_utility_world__';\n\nexport class FFPage implements PageDelegate {\n  readonly cspErrorsAsynchronousForInlineScipts = true;\n  readonly rawMouse: RawMouseImpl;\n  readonly rawKeyboard: RawKeyboardImpl;\n  readonly rawTouchscreen: RawTouchscreenImpl;\n  readonly _session: FFSession;\n  readonly _page: Page;\n  readonly _networkManager: FFNetworkManager;\n  readonly _browserContext: FFBrowserContext;\n  private _pagePromise: Promise<Page | Error>;\n  private _pageCallback: (pageOrError: Page | Error) => void = () => {};\n  _initializedPage: Page | null = null;\n  private _initializationFailed = false;\n  readonly _opener: FFPage | null;\n  private readonly _contextIdToContext: Map<string, dom.FrameExecutionContext>;\n  private _eventListeners: RegisteredListener[];\n  private _workers = new Map<string, { frameId: string, session: FFSession }>();\n  private _screencastId: string | undefined;\n\n  constructor(session: FFSession, browserContext: FFBrowserContext, opener: FFPage | null) {\n    this._session = session;\n    this._opener = opener;\n    this.rawKeyboard = new RawKeyboardImpl(session);\n    this.rawMouse = new RawMouseImpl(session);\n    this.rawTouchscreen = new RawTouchscreenImpl(session);\n    this._contextIdToContext = new Map();\n    this._browserContext = browserContext;\n    this._page = new Page(this, browserContext);\n    this._networkManager = new FFNetworkManager(session, this._page);\n    this._page.on(Page.Events.FrameDetached, frame => this._removeContextsForFrame(frame));\n    // TODO: remove Page.willOpenNewWindowAsynchronously from the protocol.\n    this._eventListeners = [\n      eventsHelper.addEventListener(this._session, 'Page.eventFired', this._onEventFired.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.frameAttached', this._onFrameAttached.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.frameDetached', this._onFrameDetached.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.navigationAborted', this._onNavigationAborted.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.navigationCommitted', this._onNavigationCommitted.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.navigationStarted', this._onNavigationStarted.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.sameDocumentNavigation', this._onSameDocumentNavigation.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Runtime.executionContextCreated', this._onExecutionContextCreated.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Runtime.executionContextDestroyed', this._onExecutionContextDestroyed.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.linkClicked', event => this._onLinkClicked(event.phase)),\n      eventsHelper.addEventListener(this._session, 'Page.uncaughtError', this._onUncaughtError.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Runtime.console', this._onConsole.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.dialogOpened', this._onDialogOpened.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.bindingCalled', this._onBindingCalled.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.fileChooserOpened', this._onFileChooserOpened.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.workerCreated', this._onWorkerCreated.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.workerDestroyed', this._onWorkerDestroyed.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.dispatchMessageFromWorker', this._onDispatchMessageFromWorker.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.crashed', this._onCrashed.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.videoRecordingStarted', this._onVideoRecordingStarted.bind(this)),\n\n      eventsHelper.addEventListener(this._session, 'Page.webSocketCreated', this._onWebSocketCreated.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.webSocketClosed', this._onWebSocketClosed.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.webSocketFrameReceived', this._onWebSocketFrameReceived.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.webSocketFrameSent', this._onWebSocketFrameSent.bind(this)),\n      eventsHelper.addEventListener(this._session, 'Page.screencastFrame', this._onScreencastFrame.bind(this)),\n\n    ];\n    this._pagePromise = new Promise(f => this._pageCallback = f);\n    session.once(FFSessionEvents.Disconnected, () => {\n      this._markAsError(new Error('Page closed'));\n      this._page._didDisconnect();\n    });\n    this._session.once('Page.ready', async () => {\n      await this._page.initOpener(this._opener);\n      if (this._initializationFailed)\n        return;\n      // Note: it is important to call |reportAsNew| before resolving pageOrError promise,\n      // so that anyone who awaits pageOrError got a ready and reported page.\n      this._initializedPage = this._page;\n      this._page.reportAsNew();\n      this._pageCallback(this._page);\n    });\n    // Ideally, we somehow ensure that utility world is created before Page.ready arrives, but currently it is racy.\n    // Therefore, we can end up with an initialized page without utility world, although very unlikely.\n    this._session.send('Page.addScriptToEvaluateOnNewDocument', { script: '', worldName: UTILITY_WORLD_NAME }).catch(e => this._markAsError(e));\n  }\n\n  async _markAsError(error: Error) {\n    // Same error may be report twice: channer disconnected and session.send fails.\n    if (this._initializationFailed)\n      return;\n    this._initializationFailed = true;\n\n    if (!this._initializedPage) {\n      await this._page.initOpener(this._opener);\n      this._page.reportAsNew(error);\n      this._pageCallback(error);\n    }\n  }\n\n  async pageOrError(): Promise<Page | Error> {\n    return this._pagePromise;\n  }\n\n  _onWebSocketCreated(event: Protocol.Page.webSocketCreatedPayload) {\n    this._page._frameManager.onWebSocketCreated(webSocketId(event.frameId, event.wsid), event.requestURL);\n    this._page._frameManager.onWebSocketRequest(webSocketId(event.frameId, event.wsid));\n  }\n\n  _onWebSocketClosed(event: Protocol.Page.webSocketClosedPayload) {\n    if (event.error)\n      this._page._frameManager.webSocketError(webSocketId(event.frameId, event.wsid), event.error);\n    this._page._frameManager.webSocketClosed(webSocketId(event.frameId, event.wsid));\n  }\n\n  _onWebSocketFrameReceived(event: Protocol.Page.webSocketFrameReceivedPayload) {\n    this._page._frameManager.webSocketFrameReceived(webSocketId(event.frameId, event.wsid), event.opcode, event.data);\n  }\n\n  _onWebSocketFrameSent(event: Protocol.Page.webSocketFrameSentPayload) {\n    this._page._frameManager.onWebSocketFrameSent(webSocketId(event.frameId, event.wsid), event.opcode, event.data);\n  }\n\n  _onExecutionContextCreated(payload: Protocol.Runtime.executionContextCreatedPayload) {\n    const {executionContextId, auxData} = payload;\n    const frame = this._page._frameManager.frame(auxData.frameId!);\n    if (!frame)\n      return;\n    const delegate = new FFExecutionContext(this._session, executionContextId);\n    let worldName: types.World|null = null;\n    if (auxData.name === UTILITY_WORLD_NAME)\n      worldName = 'utility';\n    else if (!auxData.name)\n      worldName = 'main';\n    const context = new dom.FrameExecutionContext(delegate, frame, worldName);\n    if (worldName)\n      frame._contextCreated(worldName, context);\n    this._contextIdToContext.set(executionContextId, context);\n  }\n\n  _onExecutionContextDestroyed(payload: Protocol.Runtime.executionContextDestroyedPayload) {\n    const {executionContextId} = payload;\n    const context = this._contextIdToContext.get(executionContextId);\n    if (!context)\n      return;\n    this._contextIdToContext.delete(executionContextId);\n    context.frame._contextDestroyed(context);\n  }\n\n  private _removeContextsForFrame(frame: frames.Frame) {\n    for (const [contextId, context] of this._contextIdToContext) {\n      if (context.frame === frame)\n        this._contextIdToContext.delete(contextId);\n    }\n  }\n\n  _onLinkClicked(phase: 'before' | 'after') {\n    if (phase === 'before')\n      this._page._frameManager.frameWillPotentiallyRequestNavigation();\n    else\n      this._page._frameManager.frameDidPotentiallyRequestNavigation();\n  }\n\n  _onNavigationStarted(params: Protocol.Page.navigationStartedPayload) {\n    this._page._frameManager.frameRequestedNavigation(params.frameId, params.navigationId);\n  }\n\n  _onNavigationAborted(params: Protocol.Page.navigationAbortedPayload) {\n    this._page._frameManager.frameAbortedNavigation(params.frameId, params.errorText, params.navigationId);\n  }\n\n  _onNavigationCommitted(params: Protocol.Page.navigationCommittedPayload) {\n    for (const [workerId, worker] of this._workers) {\n      if (worker.frameId === params.frameId)\n        this._onWorkerDestroyed({ workerId });\n    }\n    this._page._frameManager.frameCommittedNewDocumentNavigation(params.frameId, params.url, params.name || '', params.navigationId || '', false);\n  }\n\n  _onSameDocumentNavigation(params: Protocol.Page.sameDocumentNavigationPayload) {\n    this._page._frameManager.frameCommittedSameDocumentNavigation(params.frameId, params.url);\n  }\n\n  _onFrameAttached(params: Protocol.Page.frameAttachedPayload) {\n    this._page._frameManager.frameAttached(params.frameId, params.parentFrameId);\n  }\n\n  _onFrameDetached(params: Protocol.Page.frameDetachedPayload) {\n    this._page._frameManager.frameDetached(params.frameId);\n  }\n\n  _onEventFired(payload: Protocol.Page.eventFiredPayload) {\n    const {frameId, name} = payload;\n    if (name === 'load')\n      this._page._frameManager.frameLifecycleEvent(frameId, 'load');\n    if (name === 'DOMContentLoaded')\n      this._page._frameManager.frameLifecycleEvent(frameId, 'domcontentloaded');\n  }\n\n  _onUncaughtError(params: Protocol.Page.uncaughtErrorPayload) {\n    const { name, message } = splitErrorMessage(params.message);\n    const error = new Error(message);\n    error.stack = params.message + '\\n' + params.stack.split('\\n').filter(Boolean).map(a => a.replace(/([^@]*)@(.*)/, '    at $1 ($2)')).join('\\n');\n    error.name = name;\n    this._page.firePageError(error);\n  }\n\n  _onConsole(payload: Protocol.Runtime.consolePayload) {\n    const {type, args, executionContextId, location} = payload;\n    const context = this._contextIdToContext.get(executionContextId)!;\n    this._page._addConsoleMessage(type, args.map(arg => context.createHandle(arg)), location);\n  }\n\n  _onDialogOpened(params: Protocol.Page.dialogOpenedPayload) {\n    this._page.emit(Page.Events.Dialog, new dialog.Dialog(\n        this._page,\n        params.type,\n        params.message,\n        async (accept: boolean, promptText?: string) => {\n          await this._session.sendMayFail('Page.handleDialog', { dialogId: params.dialogId, accept, promptText });\n        },\n        params.defaultValue));\n  }\n\n  async _onBindingCalled(event: Protocol.Page.bindingCalledPayload) {\n    const context = this._contextIdToContext.get(event.executionContextId)!;\n    const pageOrError = await this.pageOrError();\n    if (!(pageOrError instanceof Error))\n      await this._page._onBindingCalled(event.payload, context);\n  }\n\n  async _onFileChooserOpened(payload: Protocol.Page.fileChooserOpenedPayload) {\n    const {executionContextId, element} = payload;\n    const context = this._contextIdToContext.get(executionContextId)!;\n    const handle = context.createHandle(element).asElement()!;\n    await this._page._onFileChooserOpened(handle);\n  }\n\n  async _onWorkerCreated(event: Protocol.Page.workerCreatedPayload) {\n    const workerId = event.workerId;\n    const worker = new Worker(this._page, event.url);\n    const workerSession = new FFSession(this._session._connection, 'worker', workerId, (message: any) => {\n      this._session.send('Page.sendMessageToWorker', {\n        frameId: event.frameId,\n        workerId: workerId,\n        message: JSON.stringify(message)\n      }).catch(e => {\n        workerSession.dispatchMessage({ id: message.id, method: '', params: {}, error: { message: e.message, data: undefined } });\n      });\n    });\n    this._workers.set(workerId, { session: workerSession, frameId: event.frameId });\n    this._page._addWorker(workerId, worker);\n    workerSession.once('Runtime.executionContextCreated', event => {\n      worker._createExecutionContext(new FFExecutionContext(workerSession, event.executionContextId));\n    });\n    workerSession.on('Runtime.console', event => {\n      const {type, args, location} = event;\n      const context = worker._existingExecutionContext!;\n      this._page._addConsoleMessage(type, args.map(arg => context.createHandle(arg)), location);\n    });\n    // Note: we receive worker exceptions directly from the page.\n  }\n\n  _onWorkerDestroyed(event: Protocol.Page.workerDestroyedPayload) {\n    const workerId = event.workerId;\n    const worker = this._workers.get(workerId);\n    if (!worker)\n      return;\n    worker.session.dispose();\n    this._workers.delete(workerId);\n    this._page._removeWorker(workerId);\n  }\n\n  async _onDispatchMessageFromWorker(event: Protocol.Page.dispatchMessageFromWorkerPayload) {\n    const worker = this._workers.get(event.workerId);\n    if (!worker)\n      return;\n    worker.session.dispatchMessage(JSON.parse(event.message));\n  }\n\n  async _onCrashed(event: Protocol.Page.crashedPayload) {\n    this._session.markAsCrashed();\n    this._page._didCrash();\n  }\n\n  _onVideoRecordingStarted(event: Protocol.Page.videoRecordingStartedPayload) {\n    this._browserContext._browser._videoStarted(this._browserContext, event.screencastId, event.file, this.pageOrError());\n  }\n\n  async exposeBinding(binding: PageBinding) {\n    const worldName = binding.world === 'utility' ? UTILITY_WORLD_NAME : '';\n    await this._session.send('Page.addBinding', { name: binding.name, script: binding.source, worldName });\n  }\n\n  didClose() {\n    this._session.dispose();\n    eventsHelper.removeEventListeners(this._eventListeners);\n    this._networkManager.dispose();\n    this._page._didClose();\n  }\n\n  async navigateFrame(frame: frames.Frame, url: string, referer: string | undefined): Promise<frames.GotoResult> {\n    const response = await this._session.send('Page.navigate', { url, referer, frameId: frame._id });\n    return { newDocumentId: response.navigationId || undefined };\n  }\n\n  async updateExtraHTTPHeaders(): Promise<void> {\n    await this._session.send('Network.setExtraHTTPHeaders', { headers: this._page._state.extraHTTPHeaders || [] });\n  }\n\n  async setEmulatedSize(emulatedSize: types.EmulatedSize): Promise<void> {\n    assert(this._page._state.emulatedSize === emulatedSize);\n    await this._session.send('Page.setViewportSize', {\n      viewportSize: {\n        width: emulatedSize.viewport.width,\n        height: emulatedSize.viewport.height,\n      },\n    });\n  }\n\n  async bringToFront(): Promise<void> {\n    await this._session.send('Page.bringToFront', {});\n  }\n\n  async updateEmulateMedia(): Promise<void> {\n    const colorScheme = this._page._state.colorScheme === null ? undefined : this._page._state.colorScheme;\n    const reducedMotion = this._page._state.reducedMotion === null ? undefined : this._page._state.reducedMotion;\n    await this._session.send('Page.setEmulatedMedia', {\n      // Empty string means reset.\n      type: this._page._state.mediaType === null ? '' : this._page._state.mediaType,\n      colorScheme,\n      reducedMotion,\n    });\n  }\n\n  async updateRequestInterception(): Promise<void> {\n    await this._networkManager.setRequestInterception(this._page._needsRequestInterception());\n  }\n\n  async setFileChooserIntercepted(enabled: boolean) {\n    await this._session.send('Page.setInterceptFileChooserDialog', { enabled }).catch(e => {}); // target can be closed.\n  }\n\n  async reload(): Promise<void> {\n    await this._session.send('Page.reload', { frameId: this._page.mainFrame()._id });\n  }\n\n  async goBack(): Promise<boolean> {\n    const { success } = await this._session.send('Page.goBack', { frameId: this._page.mainFrame()._id });\n    return success;\n  }\n\n  async goForward(): Promise<boolean> {\n    const { success } = await this._session.send('Page.goForward', { frameId: this._page.mainFrame()._id });\n    return success;\n  }\n\n  async evaluateOnNewDocument(source: string): Promise<void> {\n    await this._session.send('Page.addScriptToEvaluateOnNewDocument', { script: source });\n  }\n\n  async closePage(runBeforeUnload: boolean): Promise<void> {\n    await this._session.send('Page.close', { runBeforeUnload });\n  }\n\n  canScreenshotOutsideViewport(): boolean {\n    return true;\n  }\n\n  async setBackgroundColor(color?: { r: number; g: number; b: number; a: number; }): Promise<void> {\n    if (color)\n      throw new Error('Not implemented');\n  }\n\n  async takeScreenshot(progress: Progress, format: 'png' | 'jpeg', documentRect: types.Rect | undefined, viewportRect: types.Rect | undefined, quality: number | undefined): Promise<Buffer> {\n    if (!documentRect) {\n      const scrollOffset = await this._page.mainFrame().waitForFunctionValueInUtility(progress, () => ({ x: window.scrollX, y: window.scrollY }));\n      documentRect = {\n        x: viewportRect!.x + scrollOffset.x,\n        y: viewportRect!.y + scrollOffset.y,\n        width: viewportRect!.width,\n        height: viewportRect!.height,\n      };\n    }\n    // TODO: remove fullPage option from Page.screenshot.\n    // TODO: remove Page.getBoundingBox method.\n    progress.throwIfAborted();\n    const { data } = await this._session.send('Page.screenshot', {\n      mimeType: ('image/' + format) as ('image/png' | 'image/jpeg'),\n      clip: documentRect,\n    });\n    return Buffer.from(data, 'base64');\n  }\n\n  async resetViewport(): Promise<void> {\n    assert(false, 'Should not be called');\n  }\n\n  async getContentFrame(handle: dom.ElementHandle): Promise<frames.Frame | null> {\n    const { contentFrameId } = await this._session.send('Page.describeNode', {\n      frameId: handle._context.frame._id,\n      objectId: handle._objectId,\n    });\n    if (!contentFrameId)\n      return null;\n    return this._page._frameManager.frame(contentFrameId);\n  }\n\n  async getOwnerFrame(handle: dom.ElementHandle): Promise<string | null> {\n    const { ownerFrameId } = await this._session.send('Page.describeNode', {\n      frameId: handle._context.frame._id,\n      objectId: handle._objectId\n    });\n    return ownerFrameId || null;\n  }\n\n  isElementHandle(remoteObject: any): boolean {\n    return remoteObject.subtype === 'node';\n  }\n\n  async getBoundingBox(handle: dom.ElementHandle): Promise<types.Rect | null> {\n    const quads = await this.getContentQuads(handle);\n    if (!quads || !quads.length)\n      return null;\n    let minX = Infinity;\n    let maxX = -Infinity;\n    let minY = Infinity;\n    let maxY = -Infinity;\n    for (const quad of quads) {\n      for (const point of quad) {\n        minX = Math.min(minX, point.x);\n        maxX = Math.max(maxX, point.x);\n        minY = Math.min(minY, point.y);\n        maxY = Math.max(maxY, point.y);\n      }\n    }\n    return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\n  }\n\n  async scrollRectIntoViewIfNeeded(handle: dom.ElementHandle, rect?: types.Rect): Promise<'error:notvisible' | 'error:notconnected' | 'done'> {\n    return await this._session.send('Page.scrollIntoViewIfNeeded', {\n      frameId: handle._context.frame._id,\n      objectId: handle._objectId,\n      rect,\n    }).then(() => 'done' as const).catch(e => {\n      if (e instanceof Error && e.message.includes('Node is detached from document'))\n        return 'error:notconnected';\n      if (e instanceof Error && e.message.includes('Node does not have a layout object'))\n        return 'error:notvisible';\n      throw e;\n    });\n  }\n\n  async setScreencastOptions(options: { width: number, height: number, quality: number } | null): Promise<void> {\n    if (options) {\n      const { screencastId } = await this._session.send('Page.startScreencast', options);\n      this._screencastId = screencastId;\n    } else {\n      await this._session.send('Page.stopScreencast');\n    }\n  }\n\n  private _onScreencastFrame(event: Protocol.Page.screencastFramePayload) {\n    if (!this._screencastId)\n      return;\n    this._session.send('Page.screencastFrameAck', { screencastId: this._screencastId }).catch(e => debugLogger.log('error', e));\n\n    const buffer = Buffer.from(event.data, 'base64');\n    this._page.emit(Page.Events.ScreencastFrame, {\n      buffer,\n      width: event.deviceWidth,\n      height: event.deviceHeight,\n    });\n  }\n\n  rafCountForStablePosition(): number {\n    return 1;\n  }\n\n  async getContentQuads(handle: dom.ElementHandle): Promise<types.Quad[] | null> {\n    const result = await this._session.sendMayFail('Page.getContentQuads', {\n      frameId: handle._context.frame._id,\n      objectId: handle._objectId,\n    });\n    if (!result)\n      return null;\n    return result.quads.map(quad => [ quad.p1, quad.p2, quad.p3, quad.p4 ]);\n  }\n\n  async setInputFiles(handle: dom.ElementHandle<HTMLInputElement>, files: types.FilePayload[]): Promise<void> {\n    await handle.evaluateInUtility(([injected, node, files]) =>\n      injected.setInputFiles(node, files), files);\n  }\n\n  async adoptElementHandle<T extends Node>(handle: dom.ElementHandle<T>, to: dom.FrameExecutionContext): Promise<dom.ElementHandle<T>> {\n    const result = await this._session.send('Page.adoptNode', {\n      frameId: handle._context.frame._id,\n      objectId: handle._objectId,\n      executionContextId: (to._delegate as FFExecutionContext)._executionContextId\n    });\n    if (!result.remoteObject)\n      throw new Error(dom.kUnableToAdoptErrorMessage);\n    return to.createHandle(result.remoteObject) as dom.ElementHandle<T>;\n  }\n\n  async getAccessibilityTree(needle?: dom.ElementHandle) {\n    return getAccessibilityTree(this._session, needle);\n  }\n\n  async inputActionEpilogue(): Promise<void> {\n  }\n\n  async getFrameElement(frame: frames.Frame): Promise<dom.ElementHandle> {\n    const parent = frame.parentFrame();\n    if (!parent)\n      throw new Error('Frame has been detached.');\n    const handles = await this._page.selectors._queryAll(parent, 'frame,iframe', undefined);\n    const items = await Promise.all(handles.map(async handle => {\n      const frame = await handle.contentFrame().catch(e => null);\n      return { handle, frame };\n    }));\n    const result = items.find(item => item.frame === frame);\n    items.map(item => item === result ? Promise.resolve() : item.handle.dispose());\n    if (!result)\n      throw new Error('Frame has been detached.');\n    return result.handle;\n  }\n}\n\nfunction webSocketId(frameId: string, wsid: string): string {\n  return `${frameId}---${wsid}`;\n}\n"],"file":"ffPage.js"}