{"version":3,"sources":["../../../src/server/firefox/ffExecutionContext.ts"],"names":["FFExecutionContext","constructor","session","executionContextId","_session","_executionContextId","rawEvaluateJSON","expression","payload","send","returnByValue","catch","rewriteError","checkException","exceptionDetails","result","value","rawEvaluateHandle","objectId","rawCallFunctionNoReply","func","args","functionDeclaration","toString","map","a","js","JSHandle","_objectId","evaluateWithArguments","utilityScript","values","objectIds","undefined","_context","createHandle","getProperties","context","response","Map","property","properties","set","name","remoteObject","subtype","type","renderPreview","potentiallyUnserializableValue","releaseHandle","Error","JSON","stringify","text","stack","error","message","includes","isContextDestroyedError","TypeError","startsWith","unserializableValue","parseUnserializableValue","object","String","toUpperCase","slice"],"mappings":"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","sourcesContent":["/**\n * Copyright 2019 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as js from '../javascript';\nimport { FFSession } from './ffConnection';\nimport { Protocol } from './protocol';\nimport { rewriteErrorMessage } from '../../utils/stackTrace';\nimport { parseEvaluationResultValue } from '../common/utilityScriptSerializers';\n\nexport class FFExecutionContext implements js.ExecutionContextDelegate {\n  _session: FFSession;\n  _executionContextId: string;\n\n  constructor(session: FFSession, executionContextId: string) {\n    this._session = session;\n    this._executionContextId = executionContextId;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const payload = await this._session.send('Runtime.evaluate', {\n      expression,\n      returnByValue: true,\n      executionContextId: this._executionContextId,\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    return payload.result!.value;\n  }\n\n  async rawEvaluateHandle(expression: string): Promise<js.ObjectId> {\n    const payload = await this._session.send('Runtime.evaluate', {\n      expression,\n      returnByValue: false,\n      executionContextId: this._executionContextId,\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    return payload.result!.objectId!;\n  }\n\n  rawCallFunctionNoReply(func: Function, ...args: any[]) {\n    this._session.send('Runtime.callFunction', {\n      functionDeclaration: func.toString(),\n      args: args.map(a => a instanceof js.JSHandle ? { objectId: a._objectId } : { value: a }) as any,\n      returnByValue: true,\n      executionContextId: this._executionContextId\n    }).catch(() => {});\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], objectIds: string[]): Promise<any> {\n    const payload = await this._session.send('Runtime.callFunction', {\n      functionDeclaration: expression,\n      args: [\n        { objectId: utilityScript._objectId, value: undefined },\n        ...values.map(value => ({ value })),\n        ...objectIds.map(objectId => ({ objectId, value: undefined })),\n      ],\n      returnByValue,\n      executionContextId: this._executionContextId\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    if (returnByValue)\n      return parseEvaluationResultValue(payload.result!.value);\n    return utilityScript._context.createHandle(payload.result!);\n  }\n\n  async getProperties(context: js.ExecutionContext, objectId: js.ObjectId): Promise<Map<string, js.JSHandle>> {\n    const response = await this._session.send('Runtime.getObjectProperties', {\n      executionContextId: this._executionContextId,\n      objectId,\n    });\n    const result = new Map();\n    for (const property of response.properties)\n      result.set(property.name, context.createHandle(property.value));\n    return result;\n  }\n\n  createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n    return new js.JSHandle(context, remoteObject.subtype || remoteObject.type || '', renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n  }\n\n  async releaseHandle(objectId: js.ObjectId): Promise<void> {\n    await this._session.send('Runtime.disposeObject', {\n      executionContextId: this._executionContextId,\n      objectId\n    });\n  }\n}\n\nfunction checkException(exceptionDetails?: Protocol.Runtime.ExceptionDetails) {\n  if (!exceptionDetails)\n    return;\n  if (exceptionDetails.value)\n    throw new Error('Evaluation failed: ' + JSON.stringify(exceptionDetails.value));\n  else\n    throw new Error('Evaluation failed: ' + exceptionDetails.text + '\\n' + exceptionDetails.stack);\n}\n\nfunction rewriteError(error: Error): (Protocol.Runtime.evaluateReturnValue | Protocol.Runtime.callFunctionReturnValue) {\n  if (error.message.includes('cyclic object value') || error.message.includes('Object is not serializable'))\n    return {result: {type: 'undefined', value: undefined}};\n  if (js.isContextDestroyedError(error))\n    throw new Error('Execution context was destroyed, most likely because of a navigation.');\n  if (error instanceof TypeError && error.message.startsWith('Converting circular structure to JSON'))\n    rewriteErrorMessage(error, error.message + ' Are you passing a nested JSHandle?');\n  throw error;\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const unserializableValue = remoteObject.unserializableValue;\n  return unserializableValue ? js.parseUnserializableValue(unserializableValue) : value;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if (object.unserializableValue)\n    return String(object.unserializableValue);\n  if (object.type === 'symbol')\n    return 'Symbol()';\n  if (object.subtype === 'regexp')\n    return 'RegExp';\n  if (object.subtype === 'weakmap')\n    return 'WeakMap';\n  if (object.subtype === 'weakset')\n    return 'WeakSet';\n  if (object.subtype)\n    return object.subtype[0].toUpperCase() + object.subtype.slice(1);\n  if ('value' in object)\n    return String(object.value);\n}\n"],"file":"ffExecutionContext.js"}