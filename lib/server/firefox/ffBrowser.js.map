{"version":3,"sources":["../../../src/server/firefox/ffBrowser.ts"],"names":["FFBrowser","Browser","connect","transport","options","connection","FFConnection","protocolLogger","browserLogsCollector","browser","__testHookOnConnectToBrowser","promises","send","attachToDefaultContext","persistent","_initVersion","_defaultContext","FFBrowserContext","undefined","push","_initialize","proxy","_connection","toJugglerProxyOptions","Promise","all","constructor","_ffPages","_contexts","_version","Map","on","ConnectionEvents","Disconnected","_onDisconnect","_onAttachedToTarget","bind","_onDetachedFromTarget","_onDownloadCreated","_onDownloadFinished","_onVideoRecordingFinished","result","version","substring","indexOf","isConnected","_closed","newContext","isMobile","Error","browserContextId","removeOnDetach","context","set","contexts","Array","from","values","payload","ffPage","get","targetId","delete","didClose","openerId","type","targetInfo","session","createSession","sessionId","opener","FFPage","pageTargetId","originPage","_initializedPage","_markAsError","_opener","_downloadCreated","uuid","url","suggestedFileName","error","canceled","_downloadFinished","_takeVideo","screencastId","reportFinished","video","_idToVideo","artifact","kBrowserClosedError","clear","_didClose","BrowserContext","length","_browserContextId","_browser","downloadOptions","behavior","_options","acceptDownloads","downloadsDir","downloadsPath","viewport","viewportSize","width","height","deviceScaleFactor","hasTouch","userAgent","bypassCSP","ignoreHTTPSErrors","javaScriptEnabled","javaScriptDisabled","locale","timezoneId","permissions","grantPermissions","extraHTTPHeaders","setExtraHTTPHeaders","httpCredentials","setHTTPCredentials","geolocation","setGeolocation","offline","setOffline","colorScheme","reducedMotion","recordVideo","_ensureVideosPath","then","size","dir","filter","_browserContext","pages","map","pageOrNull","newPageDelegate","catch","e","message","includes","_doCookies","urls","cookies","network","filterCookies","c","copy","addCookies","cc","rewriteCookies","expires","clearCookies","_doGrantPermissions","origin","webPermissionToProtocol","filtered","permission","protocolPermission","_doClearPermissions","headers","allHeaders","mergeHeaders","singleHeader","override","_doSetHTTPCredentials","credentials","_doAddInitScript","source","script","_doExposeBinding","binding","worldName","world","UTILITY_WORLD_NAME","name","_doUpdateRequestInterception","enabled","_requestInterceptor","_onClosePersistent","_doClose","_doCancelDownload","proxyServer","URL","server","port","parseInt","protocol","bypass","split","domain","trim","host","hostname","username","password"],"mappings":"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","sourcesContent":["/**\n * Copyright 2018 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { kBrowserClosedError } from '../../utils/errors';\nimport { assert } from '../../utils/utils';\nimport { Browser, BrowserOptions } from '../browser';\nimport { assertBrowserContextIsNotOwned, BrowserContext, validateBrowserContextOptions, verifyGeolocation } from '../browserContext';\nimport * as network from '../network';\nimport { Page, PageBinding, PageDelegate } from '../page';\nimport { ConnectionTransport } from '../transport';\nimport * as types from '../types';\nimport { ConnectionEvents, FFConnection } from './ffConnection';\nimport { FFPage, UTILITY_WORLD_NAME } from './ffPage';\nimport { Protocol } from './protocol';\n\nexport class FFBrowser extends Browser {\n  _connection: FFConnection;\n  readonly _ffPages: Map<string, FFPage>;\n  readonly _contexts: Map<string, FFBrowserContext>;\n  private _version = '';\n\n  static async connect(transport: ConnectionTransport, options: BrowserOptions): Promise<FFBrowser> {\n    const connection = new FFConnection(transport, options.protocolLogger, options.browserLogsCollector);\n    const browser = new FFBrowser(connection, options);\n    if ((options as any).__testHookOnConnectToBrowser)\n      await (options as any).__testHookOnConnectToBrowser();\n    const promises: Promise<any>[] = [\n      connection.send('Browser.enable', { attachToDefaultContext: !!options.persistent }),\n      browser._initVersion(),\n    ];\n    if (options.persistent) {\n      browser._defaultContext = new FFBrowserContext(browser, undefined, options.persistent);\n      promises.push((browser._defaultContext as FFBrowserContext)._initialize());\n    }\n    if (options.proxy)\n      promises.push(browser._connection.send('Browser.setBrowserProxy', toJugglerProxyOptions(options.proxy)));\n    await Promise.all(promises);\n    return browser;\n  }\n\n  constructor(connection: FFConnection, options: BrowserOptions) {\n    super(options);\n    this._connection = connection;\n    this._ffPages = new Map();\n    this._contexts = new Map();\n    this._connection.on(ConnectionEvents.Disconnected, () => this._onDisconnect());\n    this._connection.on('Browser.attachedToTarget', this._onAttachedToTarget.bind(this));\n    this._connection.on('Browser.detachedFromTarget', this._onDetachedFromTarget.bind(this));\n    this._connection.on('Browser.downloadCreated', this._onDownloadCreated.bind(this));\n    this._connection.on('Browser.downloadFinished', this._onDownloadFinished.bind(this));\n    this._connection.on('Browser.videoRecordingFinished', this._onVideoRecordingFinished.bind(this));\n  }\n\n  async _initVersion() {\n    const result = await this._connection.send('Browser.getInfo');\n    this._version = result.version.substring(result.version.indexOf('/') + 1);\n  }\n\n  isConnected(): boolean {\n    return !this._connection._closed;\n  }\n\n  async newContext(options: types.BrowserContextOptions): Promise<BrowserContext> {\n    validateBrowserContextOptions(options, this.options);\n    if (options.isMobile)\n      throw new Error('options.isMobile is not supported in Firefox');\n    const { browserContextId } = await this._connection.send('Browser.createBrowserContext', { removeOnDetach: true });\n    const context = new FFBrowserContext(this, browserContextId, options);\n    await context._initialize();\n    this._contexts.set(browserContextId, context);\n    return context;\n  }\n\n  contexts(): BrowserContext[] {\n    return Array.from(this._contexts.values());\n  }\n\n  version(): string {\n    return this._version;\n  }\n\n  _onDetachedFromTarget(payload: Protocol.Browser.detachedFromTargetPayload) {\n    const ffPage = this._ffPages.get(payload.targetId)!;\n    this._ffPages.delete(payload.targetId);\n    ffPage.didClose();\n  }\n\n  _onAttachedToTarget(payload: Protocol.Browser.attachedToTargetPayload) {\n    const {targetId, browserContextId, openerId, type} = payload.targetInfo;\n    assert(type === 'page');\n    const context = browserContextId ? this._contexts.get(browserContextId)! : this._defaultContext as FFBrowserContext;\n    assert(context, `Unknown context id:${browserContextId}, _defaultContext: ${this._defaultContext}`);\n    const session = this._connection.createSession(payload.sessionId, type);\n    const opener = openerId ? this._ffPages.get(openerId)! : null;\n    const ffPage = new FFPage(session, context, opener);\n    this._ffPages.set(targetId, ffPage);\n  }\n\n  _onDownloadCreated(payload: Protocol.Browser.downloadCreatedPayload) {\n    const ffPage = this._ffPages.get(payload.pageTargetId)!;\n    assert(ffPage);\n    if (!ffPage)\n      return;\n    let originPage = ffPage._initializedPage;\n    // If it's a new window download, report it on the opener page.\n    if (!originPage) {\n      // Resume the page creation with an error. The page will automatically close right\n      // after the download begins.\n      ffPage._markAsError(new Error('Starting new page download'));\n      if (ffPage._opener)\n        originPage = ffPage._opener._initializedPage;\n    }\n    if (!originPage)\n      return;\n    this._downloadCreated(originPage, payload.uuid, payload.url, payload.suggestedFileName);\n  }\n\n  _onDownloadFinished(payload: Protocol.Browser.downloadFinishedPayload) {\n    const error = payload.canceled ? 'canceled' : payload.error;\n    this._downloadFinished(payload.uuid, error);\n  }\n\n  _onVideoRecordingFinished(payload: Protocol.Browser.videoRecordingFinishedPayload) {\n    this._takeVideo(payload.screencastId)?.reportFinished();\n  }\n\n  _onDisconnect() {\n    for (const video of this._idToVideo.values())\n      video.artifact.reportFinished(kBrowserClosedError);\n    this._idToVideo.clear();\n    this._didClose();\n  }\n}\n\nexport class FFBrowserContext extends BrowserContext {\n  declare readonly _browser: FFBrowser;\n\n  constructor(browser: FFBrowser, browserContextId: string | undefined, options: types.BrowserContextOptions) {\n    super(browser, options, browserContextId);\n  }\n\n  async _initialize() {\n    assert(!this._ffPages().length);\n    const browserContextId = this._browserContextId;\n    const promises: Promise<any>[] = [ super._initialize() ];\n    promises.push(this._browser._connection.send('Browser.setDownloadOptions', {\n      browserContextId,\n      downloadOptions: {\n        behavior: this._options.acceptDownloads ? 'saveToDisk' : 'cancel',\n        downloadsDir: this._browser.options.downloadsPath,\n      },\n    }));\n    if (this._options.viewport) {\n      const viewport = {\n        viewportSize: { width: this._options.viewport.width, height: this._options.viewport.height },\n        deviceScaleFactor: this._options.deviceScaleFactor || 1,\n      };\n      promises.push(this._browser._connection.send('Browser.setDefaultViewport', { browserContextId, viewport }));\n    }\n    if (this._options.hasTouch)\n      promises.push(this._browser._connection.send('Browser.setTouchOverride', { browserContextId, hasTouch: true }));\n    if (this._options.userAgent)\n      promises.push(this._browser._connection.send('Browser.setUserAgentOverride', { browserContextId, userAgent: this._options.userAgent }));\n    if (this._options.bypassCSP)\n      promises.push(this._browser._connection.send('Browser.setBypassCSP', { browserContextId, bypassCSP: true }));\n    if (this._options.ignoreHTTPSErrors)\n      promises.push(this._browser._connection.send('Browser.setIgnoreHTTPSErrors', { browserContextId, ignoreHTTPSErrors: true }));\n    if (this._options.javaScriptEnabled === false)\n      promises.push(this._browser._connection.send('Browser.setJavaScriptDisabled', { browserContextId, javaScriptDisabled: true }));\n    if (this._options.locale)\n      promises.push(this._browser._connection.send('Browser.setLocaleOverride', { browserContextId, locale: this._options.locale }));\n    if (this._options.timezoneId)\n      promises.push(this._browser._connection.send('Browser.setTimezoneOverride', { browserContextId, timezoneId: this._options.timezoneId }));\n    if (this._options.permissions)\n      promises.push(this.grantPermissions(this._options.permissions));\n    if (this._options.extraHTTPHeaders || this._options.locale)\n      promises.push(this.setExtraHTTPHeaders(this._options.extraHTTPHeaders || []));\n    if (this._options.httpCredentials)\n      promises.push(this.setHTTPCredentials(this._options.httpCredentials));\n    if (this._options.geolocation)\n      promises.push(this.setGeolocation(this._options.geolocation));\n    if (this._options.offline)\n      promises.push(this.setOffline(this._options.offline));\n    promises.push(this._browser._connection.send('Browser.setColorScheme', {\n      browserContextId,\n      colorScheme: this._options.colorScheme !== undefined  ? this._options.colorScheme : 'light',\n    }));\n    promises.push(this._browser._connection.send('Browser.setReducedMotion', {\n      browserContextId,\n      reducedMotion: this._options.reducedMotion !== undefined  ? this._options.reducedMotion : 'no-preference',\n    }));\n    if (this._options.recordVideo) {\n      promises.push(this._ensureVideosPath().then(() => {\n        return this._browser._connection.send('Browser.setVideoRecordingOptions', {\n          // validateBrowserContextOptions ensures correct video size.\n          options: {\n            ...this._options.recordVideo!.size!,\n            dir: this._options.recordVideo!.dir,\n          },\n          browserContextId: this._browserContextId\n        });\n      }));\n    }\n    if (this._options.proxy) {\n      promises.push(this._browser._connection.send('Browser.setContextProxy', {\n        browserContextId: this._browserContextId,\n        ...toJugglerProxyOptions(this._options.proxy)\n      }));\n    }\n\n    await Promise.all(promises);\n  }\n\n  _ffPages(): FFPage[] {\n    return Array.from(this._browser._ffPages.values()).filter(ffPage => ffPage._browserContext === this);\n  }\n\n  pages(): Page[] {\n    return this._ffPages().map(ffPage => ffPage._initializedPage).filter(pageOrNull => !!pageOrNull) as Page[];\n  }\n\n  async newPageDelegate(): Promise<PageDelegate> {\n    assertBrowserContextIsNotOwned(this);\n    const { targetId } = await this._browser._connection.send('Browser.newPage', {\n      browserContextId: this._browserContextId\n    }).catch(e =>  {\n      if (e.message.includes('Failed to override timezone'))\n        throw new Error(`Invalid timezone ID: ${this._options.timezoneId}`);\n      throw e;\n    });\n    return this._browser._ffPages.get(targetId)!;\n  }\n\n  async _doCookies(urls: string[]): Promise<types.NetworkCookie[]> {\n    const { cookies } = await this._browser._connection.send('Browser.getCookies', { browserContextId: this._browserContextId });\n    return network.filterCookies(cookies.map(c => {\n      const copy: any = { ... c };\n      delete copy.size;\n      delete copy.session;\n      return copy as types.NetworkCookie;\n    }), urls);\n  }\n\n  async addCookies(cookies: types.SetNetworkCookieParam[]) {\n    const cc = network.rewriteCookies(cookies).map(c => ({\n      ...c,\n      expires: c.expires && c.expires !== -1 ? c.expires : undefined,\n    }));\n    await this._browser._connection.send('Browser.setCookies', { browserContextId: this._browserContextId, cookies: cc });\n  }\n\n  async clearCookies() {\n    await this._browser._connection.send('Browser.clearCookies', { browserContextId: this._browserContextId });\n  }\n\n  async _doGrantPermissions(origin: string, permissions: string[]) {\n    const webPermissionToProtocol = new Map<string, 'geo' | 'desktop-notification' | 'persistent-storage' | 'push'>([\n      ['geolocation', 'geo'],\n      ['persistent-storage', 'persistent-storage'],\n      ['push', 'push'],\n      ['notifications', 'desktop-notification'],\n    ]);\n    const filtered = permissions.map(permission => {\n      const protocolPermission = webPermissionToProtocol.get(permission);\n      if (!protocolPermission)\n        throw new Error('Unknown permission: ' + permission);\n      return protocolPermission;\n    });\n    await this._browser._connection.send('Browser.grantPermissions', { origin: origin, browserContextId: this._browserContextId, permissions: filtered});\n  }\n\n  async _doClearPermissions() {\n    await this._browser._connection.send('Browser.resetPermissions', { browserContextId: this._browserContextId });\n  }\n\n  async setGeolocation(geolocation?: types.Geolocation): Promise<void> {\n    verifyGeolocation(geolocation);\n    this._options.geolocation = geolocation;\n    await this._browser._connection.send('Browser.setGeolocationOverride', { browserContextId: this._browserContextId, geolocation: geolocation || null });\n  }\n\n  async setExtraHTTPHeaders(headers: types.HeadersArray): Promise<void> {\n    this._options.extraHTTPHeaders = headers;\n    let allHeaders = this._options.extraHTTPHeaders;\n    if (this._options.locale)\n      allHeaders = network.mergeHeaders([allHeaders, network.singleHeader('Accept-Language', this._options.locale)]);\n    await this._browser._connection.send('Browser.setExtraHTTPHeaders', { browserContextId: this._browserContextId, headers: allHeaders });\n  }\n\n  async setOffline(offline: boolean): Promise<void> {\n    this._options.offline = offline;\n    await this._browser._connection.send('Browser.setOnlineOverride', { browserContextId: this._browserContextId, override: offline ? 'offline' : 'online' });\n  }\n\n  async _doSetHTTPCredentials(httpCredentials?: types.Credentials): Promise<void> {\n    this._options.httpCredentials = httpCredentials;\n    await this._browser._connection.send('Browser.setHTTPCredentials', { browserContextId: this._browserContextId, credentials: httpCredentials || null });\n  }\n\n  async _doAddInitScript(source: string) {\n    await this._browser._connection.send('Browser.addScriptToEvaluateOnNewDocument', { browserContextId: this._browserContextId, script: source });\n  }\n\n  async _doExposeBinding(binding: PageBinding) {\n    const worldName = binding.world === 'utility' ? UTILITY_WORLD_NAME : '';\n    await this._browser._connection.send('Browser.addBinding', { browserContextId: this._browserContextId, worldName, name: binding.name, script: binding.source });\n  }\n\n  async _doUpdateRequestInterception(): Promise<void> {\n    await this._browser._connection.send('Browser.setRequestInterception', { browserContextId: this._browserContextId, enabled: !!this._requestInterceptor });\n  }\n\n  _onClosePersistent() {}\n\n  async _doClose() {\n    assert(this._browserContextId);\n    await this._browser._connection.send('Browser.removeBrowserContext', { browserContextId: this._browserContextId });\n    this._browser._contexts.delete(this._browserContextId);\n  }\n\n  async _doCancelDownload(uuid: string) {\n    await this._browser._connection.send('Browser.cancelDownload', { uuid });\n  }\n}\n\nfunction toJugglerProxyOptions(proxy: types.ProxySettings) {\n  const proxyServer = new URL(proxy.server);\n  let port = parseInt(proxyServer.port, 10);\n  let type: 'http' | 'https' | 'socks' | 'socks4' = 'http';\n  if (proxyServer.protocol === 'socks5:')\n    type = 'socks';\n  else if (proxyServer.protocol === 'socks4:')\n    type = 'socks4';\n  else if (proxyServer.protocol === 'https:')\n    type = 'https';\n  if (proxyServer.port === '') {\n    if (proxyServer.protocol === 'http:')\n      port = 80;\n    else if (proxyServer.protocol === 'https:')\n      port = 443;\n  }\n  return {\n    type,\n    bypass: proxy.bypass ? proxy.bypass.split(',').map(domain => domain.trim()) : [],\n    host: proxyServer.hostname,\n    port,\n    username: proxy.username,\n    password: proxy.password\n  };\n}\n"],"file":"ffBrowser.js"}