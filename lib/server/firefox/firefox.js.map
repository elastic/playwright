{"version":3,"sources":["../../../src/server/firefox/firefox.ts"],"names":["Firefox","BrowserType","constructor","playwrightOptions","_connectToTransport","transport","options","FFBrowser","connect","_rewriteStartupError","error","_amendEnvironment","env","userDataDir","executable","browserArguments","path","isAbsolute","os","homedir","Error","platform","LD_LIBRARY_PATH","dirname","process","MOZ_WEBRENDER","_attemptToGracefullyCloseBrowser","message","method","params","id","kBrowserCloseMessageId","send","_defaultArgs","isPersistent","args","devtools","headless","console","warn","userDataDirArg","find","arg","startsWith","firefoxUserPrefs","undefined","lines","name","value","Object","entries","push","JSON","stringify","fs","writeFileSync","join","firefoxArguments"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as os from 'os';\nimport fs from 'fs';\nimport path from 'path';\nimport { FFBrowser } from './ffBrowser';\nimport { kBrowserCloseMessageId } from './ffConnection';\nimport { BrowserType } from '../browserType';\nimport { Env } from '../../utils/processLauncher';\nimport { ConnectionTransport } from '../transport';\nimport { BrowserOptions, PlaywrightOptions } from '../browser';\nimport * as types from '../types';\n\nexport class Firefox extends BrowserType {\n  constructor(playwrightOptions: PlaywrightOptions) {\n    super('firefox', playwrightOptions);\n  }\n\n  _connectToTransport(transport: ConnectionTransport, options: BrowserOptions): Promise<FFBrowser> {\n    return FFBrowser.connect(transport, options);\n  }\n\n  _rewriteStartupError(error: Error): Error {\n    return error;\n  }\n\n  _amendEnvironment(env: Env, userDataDir: string, executable: string, browserArguments: string[]): Env {\n    if (!path.isAbsolute(os.homedir()))\n      throw new Error(`Cannot launch Firefox with relative home directory. Did you set ${os.platform() === 'win32' ? 'USERPROFILE' : 'HOME'} to a relative path?`);\n    if (os.platform() === 'linux') {\n      return {\n        ...env,\n        // On linux Juggler ships the libstdc++ it was linked against.\n        LD_LIBRARY_PATH: `${path.dirname(executable)}:${process.env.LD_LIBRARY_PATH}`,\n      };\n    }\n    if (os.platform() === 'darwin') {\n      return {\n        ...env,\n        // @see https://github.com/microsoft/playwright/issues/5721\n        MOZ_WEBRENDER: 0,\n      };\n    }\n    return env;\n  }\n\n  _attemptToGracefullyCloseBrowser(transport: ConnectionTransport): void {\n    const message = { method: 'Browser.close', params: {}, id: kBrowserCloseMessageId };\n    transport.send(message);\n  }\n\n  _defaultArgs(options: types.LaunchOptions, isPersistent: boolean, userDataDir: string): string[] {\n    const { args = [], devtools, headless } = options;\n    if (devtools)\n      console.warn('devtools parameter is not supported as a launch argument in Firefox. You can launch the devtools window manually.');\n    const userDataDirArg = args.find(arg => arg.startsWith('-profile') || arg.startsWith('--profile'));\n    if (userDataDirArg)\n      throw new Error('Pass userDataDir parameter to `browserType.launchPersistentContext(userDataDir, ...)` instead of specifying --profile argument');\n    if (args.find(arg => arg.startsWith('-juggler')))\n      throw new Error('Use the port parameter instead of -juggler argument');\n    const firefoxUserPrefs = isPersistent ? undefined : options.firefoxUserPrefs;\n    if (firefoxUserPrefs) {\n      const lines: string[] = [];\n      for (const [name, value] of Object.entries(firefoxUserPrefs))\n        lines.push(`user_pref(${JSON.stringify(name)}, ${JSON.stringify(value)});`);\n      fs.writeFileSync(path.join(userDataDir, 'user.js'), lines.join('\\n'));\n    }\n    const firefoxArguments = ['-no-remote'];\n    if (headless) {\n      firefoxArguments.push('-headless');\n    } else {\n      firefoxArguments.push('-wait-for-browser');\n      firefoxArguments.push('-foreground');\n    }\n    firefoxArguments.push(`-profile`, userDataDir);\n    firefoxArguments.push('-juggler-pipe');\n    firefoxArguments.push(...args);\n    if (isPersistent)\n      firefoxArguments.push('about:blank');\n    else\n      firefoxArguments.push('-silent');\n    return firefoxArguments;\n  }\n}\n"],"file":"firefox.js"}