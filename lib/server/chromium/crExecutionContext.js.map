{"version":3,"sources":["../../../src/server/chromium/crExecutionContext.ts"],"names":["CRExecutionContext","constructor","client","contextPayload","_client","_contextId","id","rawEvaluateJSON","expression","exceptionDetails","result","remoteObject","send","contextId","returnByValue","catch","rewriteError","Error","value","rawEvaluateHandle","objectId","rawCallFunctionNoReply","func","args","functionDeclaration","toString","arguments","map","a","js","JSHandle","_objectId","executionContextId","userGesture","evaluateWithArguments","utilityScript","values","objectIds","awaitPromise","_context","createHandle","getProperties","context","response","ownProperties","Map","property","enumerable","set","name","subtype","type","renderPreview","potentiallyUnserializableValue","releaseHandle","error","message","includes","isContextDestroyedError","endsWith","TypeError","startsWith","unserializableValue","parseUnserializableValue","object","String","description","preview","tokens","properties","push","join"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { CRSession } from './crConnection';\nimport { getExceptionMessage, releaseObject } from './crProtocolHelper';\nimport { Protocol } from './protocol';\nimport * as js from '../javascript';\nimport { rewriteErrorMessage } from '../../utils/stackTrace';\nimport { parseEvaluationResultValue } from '../common/utilityScriptSerializers';\n\nexport class CRExecutionContext implements js.ExecutionContextDelegate {\n  _client: CRSession;\n  _contextId: number;\n\n  constructor(client: CRSession, contextPayload: Protocol.Runtime.ExecutionContextDescription) {\n    this._client = client;\n    this._contextId = contextPayload.id;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.evaluate', {\n      expression,\n      contextId: this._contextId,\n      returnByValue: true,\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new Error('Evaluation failed: ' + getExceptionMessage(exceptionDetails));\n    return remoteObject.value;\n  }\n\n  async rawEvaluateHandle(expression: string): Promise<js.ObjectId> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.evaluate', {\n      expression,\n      contextId: this._contextId,\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new Error('Evaluation failed: ' + getExceptionMessage(exceptionDetails));\n    return remoteObject.objectId!;\n  }\n\n  rawCallFunctionNoReply(func: Function, ...args: any[]) {\n    this._client.send('Runtime.callFunctionOn', {\n      functionDeclaration: func.toString(),\n      arguments: args.map(a => a instanceof js.JSHandle ? { objectId: a._objectId } : { value: a }),\n      returnByValue: true,\n      executionContextId: this._contextId,\n      userGesture: true\n    }).catch(() => {});\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], objectIds: string[]): Promise<any> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.callFunctionOn', {\n      functionDeclaration: expression,\n      objectId: utilityScript._objectId,\n      arguments: [\n        { objectId: utilityScript._objectId },\n        ...values.map(value => ({ value })),\n        ...objectIds.map(objectId => ({ objectId })),\n      ],\n      returnByValue,\n      awaitPromise: true,\n      userGesture: true\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new Error('Evaluation failed: ' + getExceptionMessage(exceptionDetails));\n    return returnByValue ? parseEvaluationResultValue(remoteObject.value) : utilityScript._context.createHandle(remoteObject);\n  }\n\n  async getProperties(context: js.ExecutionContext, objectId: js.ObjectId): Promise<Map<string, js.JSHandle>> {\n    const response = await this._client.send('Runtime.getProperties', {\n      objectId,\n      ownProperties: true\n    });\n    const result = new Map();\n    for (const property of response.result) {\n      if (!property.enumerable || !property.value)\n        continue;\n      result.set(property.name, context.createHandle(property.value));\n    }\n    return result;\n  }\n\n  createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n    return new js.JSHandle(context, remoteObject.subtype || remoteObject.type, renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n  }\n\n  async releaseHandle(objectId: js.ObjectId): Promise<void> {\n    await releaseObject(this._client, objectId);\n  }\n}\n\nfunction rewriteError(error: Error): Protocol.Runtime.evaluateReturnValue {\n  if (error.message.includes('Object reference chain is too long'))\n    return {result: {type: 'undefined'}};\n  if (error.message.includes('Object couldn\\'t be returned by value'))\n    return {result: {type: 'undefined'}};\n\n  if (js.isContextDestroyedError(error) || error.message.endsWith('Inspected target navigated or closed'))\n    throw new Error('Execution context was destroyed, most likely because of a navigation.');\n  if (error instanceof TypeError && error.message.startsWith('Converting circular structure to JSON'))\n    rewriteErrorMessage(error, error.message + ' Are you passing a nested JSHandle?');\n  throw error;\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const unserializableValue = remoteObject.unserializableValue;\n  return unserializableValue ? js.parseUnserializableValue(unserializableValue) : value;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if ('value' in object)\n    return String(object.value);\n  if (object.unserializableValue)\n    return String(object.unserializableValue);\n\n  if (object.description === 'Object' && object.preview) {\n    const tokens = [];\n    for (const { name, value } of object.preview.properties)\n      tokens.push(`${name}: ${value}`);\n    return `{${tokens.join(', ')}}`;\n  }\n  if (object.subtype === 'array' && object.preview) {\n    const result = [];\n    for (const { name, value } of object.preview.properties)\n      result[+name] = value;\n    return '[' + String(result) + ']';\n  }\n  return object.description;\n}\n"],"file":"crExecutionContext.js"}