{"version":3,"sources":["../../../src/server/chromium/crPage.ts"],"names":["UTILITY_WORLD_NAME","CRPage","mainFrameSession","page","crPage","_delegate","_mainFrameSession","constructor","client","targetId","browserContext","opener","hasUIWindow","isBackgroundPage","_sessions","Map","_page","rawMouse","rawKeyboard","rawTouchscreen","_targetId","_opener","_pdf","_coverage","_browserContext","_pagePromise","_initializedPage","_isBackgroundPage","_nextWindowOpenPopupFeatures","dragManager","DragManager","RawKeyboardImpl","_browser","_isMac","RawMouseImpl","RawTouchscreenImpl","CRPDF","CRCoverage","Page","FrameSession","set","once","CRSessionEvents","Disconnected","_didDisconnect","_options","noDefaultViewport","features","shift","viewportSize","helper","getViewportSizeFromWindowFeatures","_state","emulatedSize","viewport","screen","_initialize","then","r","initOpener","catch","e","_reportAsNew","error","emit","CRBrowserContext","CREvents","BackgroundPage","reportAsNew","_forAllFrameSessions","cb","frameSessions","Array","from","values","Promise","all","map","frameSession","_isMainFrame","message","includes","_sessionForFrame","frame","has","_id","parent","parentFrame","Error","get","_sessionForHandle","handle","_context","willBeginDownload","_willBeginDownload","pageOrError","didClose","session","dispose","_didClose","navigateFrame","url","referrer","_navigate","exposeBinding","binding","_initBinding","frames","evaluateExpression","source","world","updateExtraHTTPHeaders","_updateExtraHTTPHeaders","updateGeolocation","_updateGeolocation","updateOffline","_updateOffline","updateHttpCredentials","_updateHttpCredentials","setEmulatedSize","_updateViewport","bringToFront","_client","send","updateEmulateMedia","_updateEmulateMedia","updateRequestInterception","_updateRequestInterception","setFileChooserIntercepted","enabled","_setFileChooserIntercepted","reload","_go","delta","history","entry","entries","currentIndex","entryId","id","goBack","goForward","evaluateOnNewDocument","_evaluateOnNewDocument","closePage","runBeforeUnload","_closePage","canScreenshotOutsideViewport","setBackgroundColor","color","takeScreenshot","progress","format","documentRect","viewportRect","quality","visualViewport","x","pageX","y","pageY","enclosingIntSize","width","scale","height","clip","throwIfAborted","result","Buffer","data","resetViewport","mobile","deviceScaleFactor","getContentFrame","_getContentFrame","getOwnerFrame","_getOwnerFrame","isElementHandle","remoteObject","subtype","getBoundingBox","_getBoundingBox","scrollRectIntoViewIfNeeded","rect","_scrollRectIntoViewIfNeeded","setScreencastOptions","options","_startScreencast","maxWidth","maxHeight","_stopScreencast","rafCountForStablePosition","getContentQuads","_getContentQuads","setInputFiles","files","evaluateInUtility","injected","node","adoptElementHandle","to","_adoptElementHandle","getAccessibilityTree","needle","inputActionEpilogue","pdf","generate","coverage","getFrameElement","parentSession","backendNodeId","frameId","_adoptBackendNodeId","_mainContext","_crPage","_networkManager","_contextIdToContext","_eventListeners","_firstNonInitialNavigationCommittedPromise","_firstNonInitialNavigationCommittedFulfill","_firstNonInitialNavigationCommittedReject","_windowId","_swappedIn","_videoRecorder","_screencastId","_screencastClients","Set","CRNetworkManager","f","_addRendererListeners","push","eventsHelper","addEventListener","event","_onLogEntryAdded","_onFileChooserOpened","_onFrameAttached","parentFrameId","_onFrameDetached","reason","_onFrameNavigated","_onFrameRequestedNavigation","_onFrameStoppedLoading","_onDialog","_onFrameNavigatedWithinDocument","_onBindingCalled","_onConsoleAPI","exception","_handleException","exceptionDetails","_onExecutionContextCreated","context","_onExecutionContextDestroyed","executionContextId","_onExecutionContextsCleared","_onAttachedToTarget","_onDetachedFromTarget","_addBrowserListeners","_onTargetCrashed","_onScreencastFrame","_onWindowOpen","isClank","windowId","screencastOptions","recordVideo","screencastId","outputFile","path","join","dir","size","_ensureVideosPath","_createVideoRecorder","p","_stopVideoRecording","lifecycleEventsEnabled","promises","frameTree","_handleFrameTree","localFrames","_frameManager","_sendMayFail","grantUniveralAccess","worldName","_pageBindings","undefined","_evaluateOnNewDocumentSources","isInitialEmptyPage","mainFrame","_onLifecycleEvent","initialize","autoAttach","waitForDebuggerOnStart","flatten","bypassCSP","ignoreHTTPSErrors","ignore","hasTouch","javaScriptEnabled","value","userAgent","locale","acceptLanguage","emulateLocale","timezoneId","emulateTimezone","allBindings","_startVideoRecording","removeEventListeners","delete","response","errorText","newDocumentId","loaderId","name","frameLifecycleEvent","frameStoppedLoading","parentId","childFrames","child","removeChildFramesRecursively","frameAttached","framePayload","initial","frameCommittedNewDocumentNavigation","urlFragment","payload","disposition","frameRequestedNavigation","frameCommittedSameDocumentNavigation","frameDetached","contextPayload","auxData","delegate","CRExecutionContext","isDefault","dom","FrameExecutionContext","_contextCreated","_contextDestroyed","contextId","keys","CRConnection","fromSession","sessionId","targetInfo","type","worker","Worker","_addWorker","_createExecutionContext","on","args","o","_existingExecutionContext","createHandle","_addConsoleMessage","stackTrace","Events","PageError","instrumentNetworkEvents","_removeWorker","childFrameSession","windowFeatures","arg","executionContextName","Dialog","dialog","accept","promptText","defaultPrompt","firePageError","_markAsCrashed","_didCrash","level","text","lineNumber","objectId","location","columnNumber","utilityContext","_utilityContext","originPage","buffer","ScreencastFrame","timestamp","metadata","deviceWidth","deviceHeight","ffmpegPath","registry","findExecutable","executablePath","sdkLanguage","VideoRecorder","launch","Close","gotFirstFrame","_videoStarted","recorder","stop","video","_takeVideo","reportFinished","add","headers","network","mergeHeaders","extraHTTPHeaders","length","geolocation","offline","setOffline","credentials","httpCredentials","authenticate","screenSize","isLandscape","isMobile","screenWidth","screenHeight","screenOrientation","angle","insets","headful","process","platform","setWindowBounds","windowBounds","bounds","colorScheme","reducedMotion","media","mediaType","setRequestInterception","_needsRequestInterception","nodeInfo","_objectId","documentElement","evaluateHandle","doc","ownerDocument","quad","model","border","Math","min","max","position","_framePosition","element","frameElement","box","boundingBox","quads","_contextId","object","kUnableToAdoptErrorMessage","asElement"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dom from '../dom';\nimport * as frames from '../frames';\nimport { helper } from '../helper';\nimport { eventsHelper, RegisteredListener } from '../../utils/eventsHelper';\nimport * as network from '../network';\nimport { CRSession, CRConnection, CRSessionEvents } from './crConnection';\nimport { CRExecutionContext } from './crExecutionContext';\nimport { CRNetworkManager } from './crNetworkManager';\nimport { Page, Worker, PageBinding } from '../page';\nimport { Protocol } from './protocol';\nimport { toConsoleMessageLocation, exceptionToError, releaseObject } from './crProtocolHelper';\nimport * as dialog from '../dialog';\nimport { PageDelegate } from '../page';\nimport path from 'path';\nimport { RawMouseImpl, RawKeyboardImpl, RawTouchscreenImpl } from './crInput';\nimport { getAccessibilityTree } from './crAccessibility';\nimport { CRCoverage } from './crCoverage';\nimport { CRPDF } from './crPdf';\nimport { CRBrowserContext } from './crBrowser';\nimport * as types from '../types';\nimport { rewriteErrorMessage } from '../../utils/stackTrace';\nimport { assert, headersArrayToObject, createGuid, canAccessFile } from '../../utils/utils';\nimport { VideoRecorder } from './videoRecorder';\nimport { Progress } from '../progress';\nimport { DragManager } from './crDragDrop';\nimport { registry } from '../../utils/registry';\n\n\nconst UTILITY_WORLD_NAME = '__playwright_utility_world__';\nexport type WindowBounds = { top?: number, left?: number, width?: number, height?: number };\n\nexport class CRPage implements PageDelegate {\n  readonly _mainFrameSession: FrameSession;\n  readonly _sessions = new Map<Protocol.Target.TargetID, FrameSession>();\n  readonly _page: Page;\n  readonly rawMouse: RawMouseImpl;\n  readonly rawKeyboard: RawKeyboardImpl;\n  readonly rawTouchscreen: RawTouchscreenImpl;\n  readonly _targetId: string;\n  readonly _opener: CRPage | null;\n  private readonly _pdf: CRPDF;\n  private readonly _coverage: CRCoverage;\n  readonly _browserContext: CRBrowserContext;\n  private readonly _pagePromise: Promise<Page | Error>;\n  _initializedPage: Page | null = null;\n  private _isBackgroundPage: boolean;\n\n  // Holds window features for the next popup being opened via window.open,\n  // until the popup target arrives. This could be racy if two oopifs\n  // simultaneously call window.open with window features: the order\n  // of their Page.windowOpen events is not guaranteed to match the order\n  // of new popup targets.\n  readonly _nextWindowOpenPopupFeatures: string[][] = [];\n\n  static mainFrameSession(page: Page): FrameSession {\n    const crPage = page._delegate as CRPage;\n    return crPage._mainFrameSession;\n  }\n\n  constructor(client: CRSession, targetId: string, browserContext: CRBrowserContext, opener: CRPage | null, hasUIWindow: boolean, isBackgroundPage: boolean) {\n    this._targetId = targetId;\n    this._opener = opener;\n    this._isBackgroundPage = isBackgroundPage;\n    const dragManager = new DragManager(this);\n    this.rawKeyboard = new RawKeyboardImpl(client, browserContext._browser._isMac, dragManager);\n    this.rawMouse = new RawMouseImpl(this, client, dragManager);\n    this.rawTouchscreen = new RawTouchscreenImpl(client);\n    this._pdf = new CRPDF(client);\n    this._coverage = new CRCoverage(client);\n    this._browserContext = browserContext;\n    this._page = new Page(this, browserContext);\n    this._mainFrameSession = new FrameSession(this, client, targetId, null);\n    this._sessions.set(targetId, this._mainFrameSession);\n    client.once(CRSessionEvents.Disconnected, () => this._page._didDisconnect());\n    if (opener && !browserContext._options.noDefaultViewport) {\n      const features = opener._nextWindowOpenPopupFeatures.shift() || [];\n      const viewportSize = helper.getViewportSizeFromWindowFeatures(features);\n      if (viewportSize)\n        this._page._state.emulatedSize = { viewport: viewportSize, screen: viewportSize };\n    }\n    // Note: it is important to call |reportAsNew| before resolving pageOrError promise,\n    // so that anyone who awaits pageOrError got a ready and reported page.\n    this._pagePromise = this._mainFrameSession._initialize(hasUIWindow).then(async r => {\n      await this._page.initOpener(this._opener);\n      return r;\n    }).catch(async e => {\n      await this._page.initOpener(this._opener);\n      throw e;\n    }).then(() => {\n      this._initializedPage = this._page;\n      this._reportAsNew();\n      return this._page;\n    }).catch(e => {\n      this._reportAsNew(e);\n      return e;\n    });\n  }\n\n  private _reportAsNew(error?: Error) {\n    if (this._isBackgroundPage) {\n      if (!error)\n        this._browserContext.emit(CRBrowserContext.CREvents.BackgroundPage, this._page);\n    } else {\n      this._page.reportAsNew(error);\n    }\n  }\n\n  private async _forAllFrameSessions(cb: (frame: FrameSession) => Promise<any>) {\n    const frameSessions = Array.from(this._sessions.values());\n    await Promise.all(frameSessions.map(frameSession => {\n      if (frameSession._isMainFrame())\n        return cb(frameSession);\n      return cb(frameSession).catch(e => {\n        // Broadcasting a message to the closed iframe shoule be a noop.\n        if (e.message && (e.message.includes('Target closed.') || e.message.includes('Session closed.')))\n          return;\n        throw e;\n      });\n    }));\n  }\n\n  private _sessionForFrame(frame: frames.Frame): FrameSession {\n    // Frame id equals target id.\n    while (!this._sessions.has(frame._id)) {\n      const parent = frame.parentFrame();\n      if (!parent)\n        throw new Error(`Frame has been detached.`);\n      frame = parent;\n    }\n    return this._sessions.get(frame._id)!;\n  }\n\n  private _sessionForHandle(handle: dom.ElementHandle): FrameSession {\n    const frame = handle._context.frame;\n    return this._sessionForFrame(frame);\n  }\n\n  willBeginDownload() {\n    this._mainFrameSession._willBeginDownload();\n  }\n\n  async pageOrError(): Promise<Page | Error> {\n    return this._pagePromise;\n  }\n\n  didClose() {\n    for (const session of this._sessions.values())\n      session.dispose();\n    this._page._didClose();\n  }\n\n  async navigateFrame(frame: frames.Frame, url: string, referrer: string | undefined): Promise<frames.GotoResult> {\n    return this._sessionForFrame(frame)._navigate(frame, url, referrer);\n  }\n\n  async exposeBinding(binding: PageBinding) {\n    await this._forAllFrameSessions(frame => frame._initBinding(binding));\n    await Promise.all(this._page.frames().map(frame => frame.evaluateExpression(binding.source, false, {}, binding.world).catch(e => {})));\n  }\n\n  async updateExtraHTTPHeaders(): Promise<void> {\n    await this._forAllFrameSessions(frame => frame._updateExtraHTTPHeaders(false));\n  }\n\n  async updateGeolocation(): Promise<void> {\n    await this._forAllFrameSessions(frame => frame._updateGeolocation(false));\n  }\n\n  async updateOffline(): Promise<void> {\n    await this._forAllFrameSessions(frame => frame._updateOffline(false));\n  }\n\n  async updateHttpCredentials(): Promise<void> {\n    await this._forAllFrameSessions(frame => frame._updateHttpCredentials(false));\n  }\n\n  async setEmulatedSize(emulatedSize: types.EmulatedSize): Promise<void> {\n    assert(this._page._state.emulatedSize === emulatedSize);\n    await this._mainFrameSession._updateViewport();\n  }\n\n  async bringToFront(): Promise<void> {\n    await this._mainFrameSession._client.send('Page.bringToFront');\n  }\n\n  async updateEmulateMedia(): Promise<void> {\n    await this._forAllFrameSessions(frame => frame._updateEmulateMedia(false));\n  }\n\n  async updateRequestInterception(): Promise<void> {\n    await this._forAllFrameSessions(frame => frame._updateRequestInterception());\n  }\n\n  async setFileChooserIntercepted(enabled: boolean) {\n    await this._forAllFrameSessions(frame => frame._setFileChooserIntercepted(enabled));\n  }\n\n  async reload(): Promise<void> {\n    await this._mainFrameSession._client.send('Page.reload');\n  }\n\n  private async _go(delta: number): Promise<boolean> {\n    const history = await this._mainFrameSession._client.send('Page.getNavigationHistory');\n    const entry = history.entries[history.currentIndex + delta];\n    if (!entry)\n      return false;\n    await this._mainFrameSession._client.send('Page.navigateToHistoryEntry', { entryId: entry.id });\n    return true;\n  }\n\n  goBack(): Promise<boolean> {\n    return this._go(-1);\n  }\n\n  goForward(): Promise<boolean> {\n    return this._go(+1);\n  }\n\n  async evaluateOnNewDocument(source: string, world: types.World = 'main'): Promise<void> {\n    await this._forAllFrameSessions(frame => frame._evaluateOnNewDocument(source, world));\n  }\n\n  async closePage(runBeforeUnload: boolean): Promise<void> {\n    if (runBeforeUnload)\n      await this._mainFrameSession._client.send('Page.close');\n    else\n      await this._browserContext._browser._closePage(this);\n  }\n\n  canScreenshotOutsideViewport(): boolean {\n    return false;\n  }\n\n  async setBackgroundColor(color?: { r: number; g: number; b: number; a: number; }): Promise<void> {\n    await this._mainFrameSession._client.send('Emulation.setDefaultBackgroundColorOverride', { color });\n  }\n\n  async takeScreenshot(progress: Progress, format: 'png' | 'jpeg', documentRect: types.Rect | undefined, viewportRect: types.Rect | undefined, quality: number | undefined): Promise<Buffer> {\n    const { visualViewport } = await this._mainFrameSession._client.send('Page.getLayoutMetrics');\n    if (!documentRect) {\n      documentRect = {\n        x: visualViewport.pageX + viewportRect!.x,\n        y: visualViewport.pageY + viewportRect!.y,\n        ...helper.enclosingIntSize({\n          width: viewportRect!.width / visualViewport.scale,\n          height: viewportRect!.height / visualViewport.scale,\n        })\n      };\n    }\n    // When taking screenshots with documentRect (based on the page content, not viewport),\n    // ignore current page scale.\n    const clip = { ...documentRect, scale: viewportRect ? visualViewport.scale : 1 };\n    progress.throwIfAborted();\n    const result = await this._mainFrameSession._client.send('Page.captureScreenshot', { format, quality, clip });\n    return Buffer.from(result.data, 'base64');\n  }\n\n  async resetViewport(): Promise<void> {\n    await this._mainFrameSession._client.send('Emulation.setDeviceMetricsOverride', { mobile: false, width: 0, height: 0, deviceScaleFactor: 0 });\n  }\n\n  async getContentFrame(handle: dom.ElementHandle): Promise<frames.Frame | null> {\n    return this._sessionForHandle(handle)._getContentFrame(handle);\n  }\n\n  async getOwnerFrame(handle: dom.ElementHandle): Promise<string | null> {\n    return this._sessionForHandle(handle)._getOwnerFrame(handle);\n  }\n\n  isElementHandle(remoteObject: any): boolean {\n    return (remoteObject as Protocol.Runtime.RemoteObject).subtype === 'node';\n  }\n\n  async getBoundingBox(handle: dom.ElementHandle): Promise<types.Rect | null> {\n    return this._sessionForHandle(handle)._getBoundingBox(handle);\n  }\n\n  async scrollRectIntoViewIfNeeded(handle: dom.ElementHandle, rect?: types.Rect): Promise<'error:notvisible' | 'error:notconnected' | 'done'> {\n    return this._sessionForHandle(handle)._scrollRectIntoViewIfNeeded(handle, rect);\n  }\n\n  async setScreencastOptions(options: { width: number, height: number, quality: number } | null): Promise<void> {\n    if (options) {\n      await this._mainFrameSession._startScreencast(this, {\n        format: 'jpeg',\n        quality: options.quality,\n        maxWidth: options.width,\n        maxHeight: options.height\n      });\n    } else {\n      await this._mainFrameSession._stopScreencast(this);\n    }\n  }\n\n  rafCountForStablePosition(): number {\n    return 1;\n  }\n\n  async getContentQuads(handle: dom.ElementHandle): Promise<types.Quad[] | null> {\n    return this._sessionForHandle(handle)._getContentQuads(handle);\n  }\n\n  async setInputFiles(handle: dom.ElementHandle<HTMLInputElement>, files: types.FilePayload[]): Promise<void> {\n    await handle.evaluateInUtility(([injected, node, files]) =>\n      injected.setInputFiles(node, files), files);\n  }\n\n  async adoptElementHandle<T extends Node>(handle: dom.ElementHandle<T>, to: dom.FrameExecutionContext): Promise<dom.ElementHandle<T>> {\n    return this._sessionForHandle(handle)._adoptElementHandle<T>(handle, to);\n  }\n\n  async getAccessibilityTree(needle?: dom.ElementHandle) {\n    return getAccessibilityTree(this._mainFrameSession._client, needle);\n  }\n\n  async inputActionEpilogue(): Promise<void> {\n    await this._mainFrameSession._client.send('Page.enable').catch(e => {});\n  }\n\n  async pdf(options?: types.PDFOptions): Promise<Buffer> {\n    return this._pdf.generate(options);\n  }\n\n  coverage(): CRCoverage {\n    return this._coverage;\n  }\n\n  async getFrameElement(frame: frames.Frame): Promise<dom.ElementHandle> {\n    let parent = frame.parentFrame();\n    if (!parent)\n      throw new Error('Frame has been detached.');\n    const parentSession = this._sessionForFrame(parent);\n    const { backendNodeId } = await parentSession._client.send('DOM.getFrameOwner', { frameId: frame._id }).catch(e => {\n      if (e instanceof Error && e.message.includes('Frame with the given id was not found.'))\n        rewriteErrorMessage(e, 'Frame has been detached.');\n      throw e;\n    });\n    parent = frame.parentFrame();\n    if (!parent)\n      throw new Error('Frame has been detached.');\n    return parentSession._adoptBackendNodeId(backendNodeId, await parent._mainContext());\n  }\n}\n\nclass FrameSession {\n  readonly _client: CRSession;\n  readonly _crPage: CRPage;\n  readonly _page: Page;\n  readonly _networkManager: CRNetworkManager;\n  private readonly _contextIdToContext = new Map<number, dom.FrameExecutionContext>();\n  private _eventListeners: RegisteredListener[] = [];\n  readonly _targetId: string;\n  private _firstNonInitialNavigationCommittedPromise: Promise<void>;\n  private _firstNonInitialNavigationCommittedFulfill = () => {};\n  private _firstNonInitialNavigationCommittedReject = (e: Error) => {};\n  private _windowId: number | undefined;\n  // Marks the oopif session that remote -> local transition has happened in the parent.\n  // See Target.detachedFromTarget handler for details.\n  private _swappedIn = false;\n  private _videoRecorder: VideoRecorder | null = null;\n  private _screencastId: string | null = null;\n  private _screencastClients = new Set<any>();\n\n  constructor(crPage: CRPage, client: CRSession, targetId: string, parentSession: FrameSession | null) {\n    this._client = client;\n    this._crPage = crPage;\n    this._page = crPage._page;\n    this._targetId = targetId;\n    this._networkManager = new CRNetworkManager(client, this._page, parentSession ? parentSession._networkManager : null);\n    this._firstNonInitialNavigationCommittedPromise = new Promise((f, r) => {\n      this._firstNonInitialNavigationCommittedFulfill = f;\n      this._firstNonInitialNavigationCommittedReject = r;\n    });\n    client.once(CRSessionEvents.Disconnected, () => {\n      this._firstNonInitialNavigationCommittedReject(new Error('Page closed'));\n    });\n  }\n\n  _isMainFrame(): boolean {\n    return this._targetId === this._crPage._targetId;\n  }\n\n  private _addRendererListeners() {\n    this._eventListeners.push(...[\n      eventsHelper.addEventListener(this._client, 'Log.entryAdded', event => this._onLogEntryAdded(event)),\n      eventsHelper.addEventListener(this._client, 'Page.fileChooserOpened', event => this._onFileChooserOpened(event)),\n      eventsHelper.addEventListener(this._client, 'Page.frameAttached', event => this._onFrameAttached(event.frameId, event.parentFrameId)),\n      eventsHelper.addEventListener(this._client, 'Page.frameDetached', event => this._onFrameDetached(event.frameId, event.reason)),\n      eventsHelper.addEventListener(this._client, 'Page.frameNavigated', event => this._onFrameNavigated(event.frame, false)),\n      eventsHelper.addEventListener(this._client, 'Page.frameRequestedNavigation', event => this._onFrameRequestedNavigation(event)),\n      eventsHelper.addEventListener(this._client, 'Page.frameStoppedLoading', event => this._onFrameStoppedLoading(event.frameId)),\n      eventsHelper.addEventListener(this._client, 'Page.javascriptDialogOpening', event => this._onDialog(event)),\n      eventsHelper.addEventListener(this._client, 'Page.navigatedWithinDocument', event => this._onFrameNavigatedWithinDocument(event.frameId, event.url)),\n      eventsHelper.addEventListener(this._client, 'Runtime.bindingCalled', event => this._onBindingCalled(event)),\n      eventsHelper.addEventListener(this._client, 'Runtime.consoleAPICalled', event => this._onConsoleAPI(event)),\n      eventsHelper.addEventListener(this._client, 'Runtime.exceptionThrown', exception => this._handleException(exception.exceptionDetails)),\n      eventsHelper.addEventListener(this._client, 'Runtime.executionContextCreated', event => this._onExecutionContextCreated(event.context)),\n      eventsHelper.addEventListener(this._client, 'Runtime.executionContextDestroyed', event => this._onExecutionContextDestroyed(event.executionContextId)),\n      eventsHelper.addEventListener(this._client, 'Runtime.executionContextsCleared', event => this._onExecutionContextsCleared()),\n      eventsHelper.addEventListener(this._client, 'Target.attachedToTarget', event => this._onAttachedToTarget(event)),\n      eventsHelper.addEventListener(this._client, 'Target.detachedFromTarget', event => this._onDetachedFromTarget(event)),\n    ]);\n  }\n\n  private _addBrowserListeners() {\n    this._eventListeners.push(...[\n      eventsHelper.addEventListener(this._client, 'Inspector.targetCrashed', event => this._onTargetCrashed()),\n      eventsHelper.addEventListener(this._client, 'Page.screencastFrame', event => this._onScreencastFrame(event)),\n      eventsHelper.addEventListener(this._client, 'Page.windowOpen', event => this._onWindowOpen(event)),\n    ]);\n  }\n\n  async _initialize(hasUIWindow: boolean) {\n    if (hasUIWindow &&\n      !this._crPage._browserContext._browser.isClank() &&\n      !this._crPage._browserContext._options.noDefaultViewport) {\n      const { windowId } = await this._client.send('Browser.getWindowForTarget');\n      this._windowId = windowId;\n    }\n\n    let screencastOptions: types.PageScreencastOptions | undefined;\n    if (this._isMainFrame() && this._crPage._browserContext._options.recordVideo && hasUIWindow) {\n      const screencastId = createGuid();\n      const outputFile = path.join(this._crPage._browserContext._options.recordVideo.dir, screencastId + '.webm');\n      screencastOptions = {\n        // validateBrowserContextOptions ensures correct video size.\n        ...this._crPage._browserContext._options.recordVideo.size!,\n        outputFile,\n      };\n      await this._crPage._browserContext._ensureVideosPath();\n      // Note: it is important to start video recorder before sending Page.startScreencast,\n      // and it is equally important to send Page.startScreencast before sending Runtime.runIfWaitingForDebugger.\n      await this._createVideoRecorder(screencastId, screencastOptions);\n      this._crPage.pageOrError().then(p => {\n        if (p instanceof Error)\n          this._stopVideoRecording().catch(() => {});\n      });\n    }\n\n    let lifecycleEventsEnabled: Promise<any>;\n    if (!this._isMainFrame())\n      this._addRendererListeners();\n    this._addBrowserListeners();\n    const promises: Promise<any>[] = [\n      this._client.send('Page.enable'),\n      this._client.send('Page.getFrameTree').then(({frameTree}) => {\n        if (this._isMainFrame()) {\n          this._handleFrameTree(frameTree);\n          this._addRendererListeners();\n        }\n        const localFrames = this._isMainFrame() ? this._page.frames() : [ this._page._frameManager.frame(this._targetId)! ];\n        for (const frame of localFrames) {\n          // Note: frames might be removed before we send these.\n          this._client._sendMayFail('Page.createIsolatedWorld', {\n            frameId: frame._id,\n            grantUniveralAccess: true,\n            worldName: UTILITY_WORLD_NAME,\n          });\n          for (const binding of this._crPage._browserContext._pageBindings.values())\n            frame.evaluateExpression(binding.source, false, undefined, binding.world).catch(e => {});\n          for (const source of this._crPage._browserContext._evaluateOnNewDocumentSources)\n            frame.evaluateExpression(source, false, undefined, 'main').catch(e => {});\n        }\n        const isInitialEmptyPage = this._isMainFrame() && this._page.mainFrame().url() === ':';\n        if (isInitialEmptyPage) {\n          // Ignore lifecycle events for the initial empty page. It is never the final page\n          // hence we are going to get more lifecycle updates after the actual navigation has\n          // started (even if the target url is about:blank).\n          lifecycleEventsEnabled.catch(e => {}).then(() => {\n            this._eventListeners.push(eventsHelper.addEventListener(this._client, 'Page.lifecycleEvent', event => this._onLifecycleEvent(event)));\n          });\n        } else {\n          this._firstNonInitialNavigationCommittedFulfill();\n          this._eventListeners.push(eventsHelper.addEventListener(this._client, 'Page.lifecycleEvent', event => this._onLifecycleEvent(event)));\n        }\n      }),\n      this._client.send('Log.enable', {}),\n      lifecycleEventsEnabled = this._client.send('Page.setLifecycleEventsEnabled', { enabled: true }),\n      this._client.send('Runtime.enable', {}),\n      this._client.send('Page.addScriptToEvaluateOnNewDocument', {\n        source: '',\n        worldName: UTILITY_WORLD_NAME,\n      }),\n      this._networkManager.initialize(),\n      this._client.send('Target.setAutoAttach', { autoAttach: true, waitForDebuggerOnStart: true, flatten: true }),\n    ];\n    if (this._isMainFrame())\n      promises.push(this._client.send('Emulation.setFocusEmulationEnabled', { enabled: true }));\n    const options = this._crPage._browserContext._options;\n    if (options.bypassCSP)\n      promises.push(this._client.send('Page.setBypassCSP', { enabled: true }));\n    if (options.ignoreHTTPSErrors)\n      promises.push(this._client.send('Security.setIgnoreCertificateErrors', { ignore: true }));\n    if (this._isMainFrame())\n      promises.push(this._updateViewport());\n    if (options.hasTouch)\n      promises.push(this._client.send('Emulation.setTouchEmulationEnabled', { enabled: true }));\n    if (options.javaScriptEnabled === false)\n      promises.push(this._client.send('Emulation.setScriptExecutionDisabled', { value: true }));\n    if (options.userAgent || options.locale)\n      promises.push(this._client.send('Emulation.setUserAgentOverride', { userAgent: options.userAgent || '', acceptLanguage: options.locale }));\n    if (options.locale)\n      promises.push(emulateLocale(this._client, options.locale));\n    if (options.timezoneId)\n      promises.push(emulateTimezone(this._client, options.timezoneId));\n    promises.push(this._updateGeolocation(true));\n    promises.push(this._updateExtraHTTPHeaders(true));\n    promises.push(this._updateRequestInterception());\n    promises.push(this._updateOffline(true));\n    promises.push(this._updateHttpCredentials(true));\n    promises.push(this._updateEmulateMedia(true));\n    for (const binding of this._crPage._page.allBindings())\n      promises.push(this._initBinding(binding));\n    for (const source of this._crPage._browserContext._evaluateOnNewDocumentSources)\n      promises.push(this._evaluateOnNewDocument(source, 'main'));\n    for (const source of this._crPage._page._evaluateOnNewDocumentSources)\n      promises.push(this._evaluateOnNewDocument(source, 'main'));\n    if (screencastOptions)\n      promises.push(this._startVideoRecording(screencastOptions));\n    promises.push(this._client.send('Runtime.runIfWaitingForDebugger'));\n    promises.push(this._firstNonInitialNavigationCommittedPromise);\n    await Promise.all(promises);\n  }\n\n  dispose() {\n    eventsHelper.removeEventListeners(this._eventListeners);\n    this._networkManager.dispose();\n    this._crPage._sessions.delete(this._targetId);\n  }\n\n  async _navigate(frame: frames.Frame, url: string, referrer: string | undefined): Promise<frames.GotoResult> {\n    const response = await this._client.send('Page.navigate', { url, referrer, frameId: frame._id });\n    if (response.errorText)\n      throw new Error(`${response.errorText} at ${url}`);\n    return { newDocumentId: response.loaderId };\n  }\n\n  _onLifecycleEvent(event: Protocol.Page.lifecycleEventPayload) {\n    if (event.name === 'load')\n      this._page._frameManager.frameLifecycleEvent(event.frameId, 'load');\n    else if (event.name === 'DOMContentLoaded')\n      this._page._frameManager.frameLifecycleEvent(event.frameId, 'domcontentloaded');\n  }\n\n  _onFrameStoppedLoading(frameId: string) {\n    this._page._frameManager.frameStoppedLoading(frameId);\n  }\n\n  _handleFrameTree(frameTree: Protocol.Page.FrameTree) {\n    this._onFrameAttached(frameTree.frame.id, frameTree.frame.parentId || null);\n    this._onFrameNavigated(frameTree.frame, true);\n    if (!frameTree.childFrames)\n      return;\n\n    for (const child of frameTree.childFrames)\n      this._handleFrameTree(child);\n  }\n\n  _onFrameAttached(frameId: string, parentFrameId: string | null) {\n    const frameSession = this._crPage._sessions.get(frameId);\n    if (frameSession && frameId !== this._targetId) {\n      // This is a remote -> local frame transition.\n      frameSession._swappedIn = true;\n      const frame = this._page._frameManager.frame(frameId);\n      // Frame or even a whole subtree may be already gone, because some ancestor did navigate.\n      if (frame)\n        this._page._frameManager.removeChildFramesRecursively(frame);\n      return;\n    }\n    if (parentFrameId && !this._page._frameManager.frame(parentFrameId)) {\n      // Parent frame may be gone already because some ancestor frame navigated and\n      // destroyed the whole subtree of some oopif, while oopif's process is still sending us events.\n      // Be careful to not confuse this with \"main frame navigated cross-process\" scenario\n      // where parentFrameId is null.\n      return;\n    }\n    this._page._frameManager.frameAttached(frameId, parentFrameId);\n  }\n\n  _onFrameNavigated(framePayload: Protocol.Page.Frame, initial: boolean) {\n    if (!this._page._frameManager.frame(framePayload.id))\n      return; // Subtree may be already gone because some ancestor navigation destroyed the oopif.\n    this._page._frameManager.frameCommittedNewDocumentNavigation(framePayload.id, framePayload.url + (framePayload.urlFragment || ''), framePayload.name || '', framePayload.loaderId, initial);\n    if (!initial)\n      this._firstNonInitialNavigationCommittedFulfill();\n  }\n\n  _onFrameRequestedNavigation(payload: Protocol.Page.frameRequestedNavigationPayload) {\n    if (payload.disposition === 'currentTab')\n      this._page._frameManager.frameRequestedNavigation(payload.frameId);\n  }\n\n  _onFrameNavigatedWithinDocument(frameId: string, url: string) {\n    this._page._frameManager.frameCommittedSameDocumentNavigation(frameId, url);\n  }\n\n  _onFrameDetached(frameId: string, reason: 'remove' | 'swap') {\n    if (this._crPage._sessions.has(frameId)) {\n      // This is a local -> remote frame transtion, where\n      // Page.frameDetached arrives after Target.attachedToTarget.\n      // We've already handled the new target and frame reattach - nothing to do here.\n      return;\n    }\n    if (reason === 'swap') {\n      // This is a local -> remote frame transtion, where\n      // Page.frameDetached arrives before Target.attachedToTarget.\n      // We should keep the frame in the tree, and it will be used for the new target.\n      const frame = this._page._frameManager.frame(frameId);\n      if (frame)\n        this._page._frameManager.removeChildFramesRecursively(frame);\n      return;\n    }\n    // Just a regular frame detach.\n    this._page._frameManager.frameDetached(frameId);\n  }\n\n  _onExecutionContextCreated(contextPayload: Protocol.Runtime.ExecutionContextDescription) {\n    const frame = contextPayload.auxData ? this._page._frameManager.frame(contextPayload.auxData.frameId) : null;\n    if (!frame)\n      return;\n    const delegate = new CRExecutionContext(this._client, contextPayload);\n    let worldName: types.World|null = null;\n    if (contextPayload.auxData && !!contextPayload.auxData.isDefault)\n      worldName = 'main';\n    else if (contextPayload.name === UTILITY_WORLD_NAME)\n      worldName = 'utility';\n    const context = new dom.FrameExecutionContext(delegate, frame, worldName);\n    if (worldName)\n      frame._contextCreated(worldName, context);\n    this._contextIdToContext.set(contextPayload.id, context);\n  }\n\n  _onExecutionContextDestroyed(executionContextId: number) {\n    const context = this._contextIdToContext.get(executionContextId);\n    if (!context)\n      return;\n    this._contextIdToContext.delete(executionContextId);\n    context.frame._contextDestroyed(context);\n  }\n\n  _onExecutionContextsCleared() {\n    for (const contextId of Array.from(this._contextIdToContext.keys()))\n      this._onExecutionContextDestroyed(contextId);\n  }\n\n  _onAttachedToTarget(event: Protocol.Target.attachedToTargetPayload) {\n    const session = CRConnection.fromSession(this._client).session(event.sessionId)!;\n\n    if (event.targetInfo.type === 'iframe') {\n      // Frame id equals target id.\n      const targetId = event.targetInfo.targetId;\n      const frame = this._page._frameManager.frame(targetId);\n      if (!frame)\n        return; // Subtree may be already gone due to renderer/browser race.\n      this._page._frameManager.removeChildFramesRecursively(frame);\n      const frameSession = new FrameSession(this._crPage, session, targetId, this);\n      this._crPage._sessions.set(targetId, frameSession);\n      frameSession._initialize(false).catch(e => e);\n      return;\n    }\n\n    if (event.targetInfo.type !== 'worker') {\n      // Ideally, detaching should resume any target, but there is a bug in the backend.\n      session._sendMayFail('Runtime.runIfWaitingForDebugger').then(() => {\n        this._client._sendMayFail('Target.detachFromTarget', { sessionId: event.sessionId });\n      });\n      return;\n    }\n\n    const url = event.targetInfo.url;\n    const worker = new Worker(this._page, url);\n    this._page._addWorker(event.sessionId, worker);\n    session.once('Runtime.executionContextCreated', async event => {\n      worker._createExecutionContext(new CRExecutionContext(session, event.context));\n    });\n    // This might fail if the target is closed before we initialize.\n    session._sendMayFail('Runtime.enable');\n    session._sendMayFail('Network.enable');\n    session._sendMayFail('Runtime.runIfWaitingForDebugger');\n    session.on('Runtime.consoleAPICalled', event => {\n      const args = event.args.map(o => worker._existingExecutionContext!.createHandle(o));\n      this._page._addConsoleMessage(event.type, args, toConsoleMessageLocation(event.stackTrace));\n    });\n    session.on('Runtime.exceptionThrown', exception => this._page.emit(Page.Events.PageError, exceptionToError(exception.exceptionDetails)));\n    // TODO: attribute workers to the right frame.\n    this._networkManager.instrumentNetworkEvents(session, this._page._frameManager.frame(this._targetId)!);\n  }\n\n  _onDetachedFromTarget(event: Protocol.Target.detachedFromTargetPayload) {\n    // This might be a worker...\n    this._page._removeWorker(event.sessionId);\n\n    // ... or an oopif.\n    const childFrameSession = this._crPage._sessions.get(event.targetId!);\n    if (!childFrameSession)\n      return;\n\n    // Usually, we get frameAttached in this session first and mark child as swappedIn.\n    if (childFrameSession._swappedIn) {\n      childFrameSession.dispose();\n      return;\n    }\n\n    // However, sometimes we get detachedFromTarget before frameAttached.\n    // In this case we don't know wheter this is a remote frame detach,\n    // or just a remote -> local transition. In the latter case, frameAttached\n    // is already inflight, so let's make a safe roundtrip to ensure it arrives.\n    this._client.send('Page.enable').catch(e => null).then(() => {\n      // Child was not swapped in - that means frameAttached did not happen and\n      // this is remote detach rather than remote -> local swap.\n      if (!childFrameSession._swappedIn)\n        this._page._frameManager.frameDetached(event.targetId!);\n      childFrameSession.dispose();\n    });\n  }\n\n  _onWindowOpen(event: Protocol.Page.windowOpenPayload) {\n    this._crPage._nextWindowOpenPopupFeatures.push(event.windowFeatures);\n  }\n\n  async _onConsoleAPI(event: Protocol.Runtime.consoleAPICalledPayload) {\n    if (event.executionContextId === 0) {\n      // DevTools protocol stores the last 1000 console messages. These\n      // messages are always reported even for removed execution contexts. In\n      // this case, they are marked with executionContextId = 0 and are\n      // reported upon enabling Runtime agent.\n      //\n      // Ignore these messages since:\n      // - there's no execution context we can use to operate with message\n      //   arguments\n      // - these messages are reported before Playwright clients can subscribe\n      //   to the 'console'\n      //   page event.\n      //\n      // @see https://github.com/GoogleChrome/puppeteer/issues/3865\n      return;\n    }\n    const context = this._contextIdToContext.get(event.executionContextId)!;\n    const values = event.args.map(arg => context.createHandle(arg));\n    this._page._addConsoleMessage(event.type, values, toConsoleMessageLocation(event.stackTrace));\n  }\n\n  async _initBinding(binding: PageBinding) {\n    const worldName = binding.world === 'utility' ? UTILITY_WORLD_NAME : undefined;\n    await Promise.all([\n      this._client.send('Runtime.addBinding', { name: binding.name, executionContextName: worldName }),\n      this._client.send('Page.addScriptToEvaluateOnNewDocument', { source: binding.source, worldName })\n    ]);\n  }\n\n  async _onBindingCalled(event: Protocol.Runtime.bindingCalledPayload) {\n    const context = this._contextIdToContext.get(event.executionContextId)!;\n    const pageOrError = await this._crPage.pageOrError();\n    if (!(pageOrError instanceof Error))\n      await this._page._onBindingCalled(event.payload, context);\n  }\n\n  _onDialog(event: Protocol.Page.javascriptDialogOpeningPayload) {\n    if (!this._page._frameManager.frame(this._targetId))\n      return; // Our frame/subtree may be gone already.\n    this._page.emit(Page.Events.Dialog, new dialog.Dialog(\n        this._page,\n        event.type,\n        event.message,\n        async (accept: boolean, promptText?: string) => {\n          await this._client.send('Page.handleJavaScriptDialog', { accept, promptText });\n        },\n        event.defaultPrompt));\n  }\n\n  _handleException(exceptionDetails: Protocol.Runtime.ExceptionDetails) {\n    this._page.firePageError(exceptionToError(exceptionDetails));\n  }\n\n  async _onTargetCrashed() {\n    this._client._markAsCrashed();\n    this._page._didCrash();\n  }\n\n  _onLogEntryAdded(event: Protocol.Log.entryAddedPayload) {\n    const {level, text, args, source, url, lineNumber} = event.entry;\n    if (args)\n      args.map(arg => releaseObject(this._client, arg.objectId!));\n    if (source !== 'worker') {\n      const location: types.ConsoleMessageLocation = {\n        url: url || '',\n        lineNumber: lineNumber || 0,\n        columnNumber: 0,\n      };\n      this._page._addConsoleMessage(level, [], location, text);\n    }\n  }\n\n  async _onFileChooserOpened(event: Protocol.Page.fileChooserOpenedPayload) {\n    const frame = this._page._frameManager.frame(event.frameId);\n    if (!frame)\n      return;\n    let handle;\n    try {\n      const utilityContext = await frame._utilityContext();\n      handle = await this._adoptBackendNodeId(event.backendNodeId, utilityContext);\n    } catch (e) {\n      // During async processing, frame/context may go away. We should not throw.\n      return;\n    }\n    await this._page._onFileChooserOpened(handle);\n  }\n\n  _willBeginDownload() {\n    const originPage = this._crPage._initializedPage;\n    if (!originPage) {\n      // Resume the page creation with an error. The page will automatically close right\n      // after the download begins.\n      this._firstNonInitialNavigationCommittedReject(new Error('Starting new page download'));\n    }\n  }\n\n  _onScreencastFrame(payload: Protocol.Page.screencastFramePayload) {\n    this._client.send('Page.screencastFrameAck', {sessionId: payload.sessionId}).catch(() => {});\n    const buffer = Buffer.from(payload.data, 'base64');\n    this._page.emit(Page.Events.ScreencastFrame, {\n      buffer,\n      timestamp: payload.metadata.timestamp,\n      width: payload.metadata.deviceWidth,\n      height: payload.metadata.deviceHeight,\n    });\n  }\n\n  async _createVideoRecorder(screencastId: string, options: types.PageScreencastOptions): Promise<void> {\n    assert(!this._screencastId);\n    const ffmpegPath = registry.findExecutable('ffmpeg')!.executablePath();\n    // TODO: use default error message once it's ready.\n    if (!ffmpegPath || !canAccessFile(ffmpegPath)) {\n      let message: string = '';\n      switch (this._page._browserContext._options.sdkLanguage) {\n        case 'python': message = 'playwright install ffmpeg'; break;\n        case 'python-async': message = 'playwright install ffmpeg'; break;\n        case 'javascript': message = 'npx playwright install ffmpeg'; break;\n        case 'java': message = 'mvn exec:java -e -Dexec.mainClass=com.microsoft.playwright.CLI -Dexec.args=\"install ffmpeg\"'; break;\n      }\n      throw new Error(`\n============================================================\n  Please install ffmpeg in order to record video.\n\n  $ ${message}\n============================================================\n      `);\n    }\n    this._videoRecorder = await VideoRecorder.launch(this._crPage._page, ffmpegPath, options);\n    this._screencastId = screencastId;\n  }\n\n  async _startVideoRecording(options: types.PageScreencastOptions) {\n    const screencastId = this._screencastId;\n    assert(screencastId);\n    this._page.once(Page.Events.Close, () => this._stopVideoRecording().catch(() => {}));\n    const gotFirstFrame = new Promise(f => this._client.once('Page.screencastFrame', f));\n    await this._startScreencast(this._videoRecorder, {\n      format: 'jpeg',\n      quality: 90,\n      maxWidth: options.width,\n      maxHeight: options.height,\n    });\n    // Wait for the first frame before reporting video to the client.\n    gotFirstFrame.then(() => {\n      this._crPage._browserContext._browser._videoStarted(this._crPage._browserContext, screencastId, options.outputFile, this._crPage.pageOrError());\n    });\n  }\n\n  async _stopVideoRecording(): Promise<void> {\n    if (!this._screencastId)\n      return;\n    const screencastId = this._screencastId;\n    this._screencastId = null;\n    const recorder = this._videoRecorder!;\n    this._videoRecorder = null;\n    await this._stopScreencast(recorder);\n    await recorder.stop().catch(() => {});\n    // Keep the video artifact in the map utntil encoding is fully finished, if the context\n    // starts closing before the video is fully written to disk it will wait for it.\n    const video = this._crPage._browserContext._browser._takeVideo(screencastId);\n    video?.reportFinished();\n  }\n\n  async _startScreencast(client: any, options: Protocol.Page.startScreencastParameters = {}) {\n    this._screencastClients.add(client);\n    if (this._screencastClients.size === 1)\n      await this._client.send('Page.startScreencast', options);\n  }\n\n  async _stopScreencast(client: any) {\n    this._screencastClients.delete(client);\n    if (!this._screencastClients.size)\n      await this._client._sendMayFail('Page.stopScreencast');\n  }\n\n  async _updateExtraHTTPHeaders(initial: boolean): Promise<void> {\n    const headers = network.mergeHeaders([\n      this._crPage._browserContext._options.extraHTTPHeaders,\n      this._page._state.extraHTTPHeaders\n    ]);\n    if (!initial || headers.length)\n      await this._client.send('Network.setExtraHTTPHeaders', { headers: headersArrayToObject(headers, false /* lowerCase */) });\n  }\n\n  async _updateGeolocation(initial: boolean): Promise<void> {\n    const geolocation = this._crPage._browserContext._options.geolocation;\n    if (!initial || geolocation)\n      await this._client.send('Emulation.setGeolocationOverride', geolocation || {});\n  }\n\n  async _updateOffline(initial: boolean): Promise<void> {\n    const offline = !!this._crPage._browserContext._options.offline;\n    if (!initial || offline)\n      await this._networkManager.setOffline(offline);\n  }\n\n  async _updateHttpCredentials(initial: boolean): Promise<void> {\n    const credentials = this._crPage._browserContext._options.httpCredentials || null;\n    if (!initial || credentials)\n      await this._networkManager.authenticate(credentials);\n  }\n\n  async _updateViewport(): Promise<void> {\n    if (this._crPage._browserContext._browser.isClank())\n      return;\n    assert(this._isMainFrame());\n    const options = this._crPage._browserContext._options;\n    const emulatedSize = this._page._state.emulatedSize;\n    if (emulatedSize === null)\n      return;\n    const viewportSize = emulatedSize.viewport;\n    const screenSize = emulatedSize.screen;\n    const isLandscape = viewportSize.width > viewportSize.height;\n    const promises = [\n      this._client.send('Emulation.setDeviceMetricsOverride', {\n        mobile: !!options.isMobile,\n        width: viewportSize.width,\n        height: viewportSize.height,\n        screenWidth: screenSize.width,\n        screenHeight: screenSize.height,\n        deviceScaleFactor: options.deviceScaleFactor || 1,\n        screenOrientation: isLandscape ? { angle: 90, type: 'landscapePrimary' } : { angle: 0, type: 'portraitPrimary' },\n      }),\n    ];\n    if (this._windowId) {\n      let insets = { width: 0, height: 0 };\n      if (this._crPage._browserContext._browser.options.headful) {\n        // TODO: popup windows have their own insets.\n        insets = { width: 24, height: 88 };\n        if (process.platform === 'win32')\n          insets = { width: 16, height: 88 };\n        else if (process.platform === 'linux')\n          insets = { width: 8, height: 85 };\n        else if (process.platform === 'darwin')\n          insets = { width: 2, height: 80 };\n      }\n      promises.push(this.setWindowBounds({\n        width: viewportSize.width + insets.width,\n        height: viewportSize.height + insets.height\n      }));\n    }\n    await Promise.all(promises);\n  }\n\n  async windowBounds(): Promise<WindowBounds> {\n    const { bounds } = await this._client.send('Browser.getWindowBounds', {\n      windowId: this._windowId!\n    });\n    return bounds;\n  }\n\n  async setWindowBounds(bounds: WindowBounds) {\n    return await this._client.send('Browser.setWindowBounds', {\n      windowId: this._windowId!,\n      bounds\n    });\n  }\n\n  async _updateEmulateMedia(initial: boolean): Promise<void> {\n    if (this._crPage._browserContext._browser.isClank())\n      return;\n    const colorScheme = this._page._state.colorScheme === null ? '' : this._page._state.colorScheme;\n    const reducedMotion = this._page._state.reducedMotion === null ? '' : this._page._state.reducedMotion;\n    const features = [\n      { name: 'prefers-color-scheme', value: colorScheme },\n      { name: 'prefers-reduced-motion', value: reducedMotion },\n    ];\n    // Empty string disables the override.\n    await this._client.send('Emulation.setEmulatedMedia', { media: this._page._state.mediaType || '', features });\n  }\n\n  async _updateRequestInterception(): Promise<void> {\n    await this._networkManager.setRequestInterception(this._page._needsRequestInterception());\n  }\n\n  async _setFileChooserIntercepted(enabled: boolean) {\n    await this._client.send('Page.setInterceptFileChooserDialog', { enabled }).catch(e => {}); // target can be closed.\n  }\n\n  async _evaluateOnNewDocument(source: string, world: types.World): Promise<void> {\n    const worldName = world === 'utility' ? UTILITY_WORLD_NAME : undefined;\n    await this._client.send('Page.addScriptToEvaluateOnNewDocument', { source, worldName });\n  }\n\n  async _getContentFrame(handle: dom.ElementHandle): Promise<frames.Frame | null> {\n    const nodeInfo = await this._client.send('DOM.describeNode', {\n      objectId: handle._objectId\n    });\n    if (!nodeInfo || typeof nodeInfo.node.frameId !== 'string')\n      return null;\n    return this._page._frameManager.frame(nodeInfo.node.frameId);\n  }\n\n  async _getOwnerFrame(handle: dom.ElementHandle): Promise<string | null> {\n    // document.documentElement has frameId of the owner frame.\n    const documentElement = await handle.evaluateHandle(node => {\n      const doc = node as Document;\n      if (doc.documentElement && doc.documentElement.ownerDocument === doc)\n        return doc.documentElement;\n      return node.ownerDocument ? node.ownerDocument.documentElement : null;\n    });\n    if (!documentElement)\n      return null;\n    if (!documentElement._objectId)\n      return null;\n    const nodeInfo = await this._client.send('DOM.describeNode', {\n      objectId: documentElement._objectId\n    });\n    const frameId = nodeInfo && typeof nodeInfo.node.frameId === 'string' ?\n      nodeInfo.node.frameId : null;\n    documentElement.dispose();\n    return frameId;\n  }\n\n  async _getBoundingBox(handle: dom.ElementHandle): Promise<types.Rect | null> {\n    const result = await this._client._sendMayFail('DOM.getBoxModel', {\n      objectId: handle._objectId\n    });\n    if (!result)\n      return null;\n    const quad = result.model.border;\n    const x = Math.min(quad[0], quad[2], quad[4], quad[6]);\n    const y = Math.min(quad[1], quad[3], quad[5], quad[7]);\n    const width = Math.max(quad[0], quad[2], quad[4], quad[6]) - x;\n    const height = Math.max(quad[1], quad[3], quad[5], quad[7]) - y;\n    const position = await this._framePosition();\n    if (!position)\n      return null;\n    return { x: x + position.x, y: y + position.y, width, height };\n  }\n\n  private async _framePosition(): Promise<types.Point | null> {\n    const frame = this._page._frameManager.frame(this._targetId);\n    if (!frame)\n      return null;\n    if (frame === this._page.mainFrame())\n      return { x: 0, y: 0 };\n    const element = await frame.frameElement();\n    const box = await element.boundingBox();\n    return box;\n  }\n\n  async _scrollRectIntoViewIfNeeded(handle: dom.ElementHandle, rect?: types.Rect): Promise<'error:notvisible' | 'error:notconnected' | 'done'> {\n    return await this._client.send('DOM.scrollIntoViewIfNeeded', {\n      objectId: handle._objectId,\n      rect,\n    }).then(() => 'done' as const).catch(e => {\n      if (e instanceof Error && e.message.includes('Node does not have a layout object'))\n        return 'error:notvisible';\n      if (e instanceof Error && e.message.includes('Node is detached from document'))\n        return 'error:notconnected';\n      throw e;\n    });\n  }\n\n  async _getContentQuads(handle: dom.ElementHandle): Promise<types.Quad[] | null> {\n    const result = await this._client._sendMayFail('DOM.getContentQuads', {\n      objectId: handle._objectId\n    });\n    if (!result)\n      return null;\n    const position = await this._framePosition();\n    if (!position)\n      return null;\n    return result.quads.map(quad => [\n      { x: quad[0] + position.x, y: quad[1] + position.y },\n      { x: quad[2] + position.x, y: quad[3] + position.y },\n      { x: quad[4] + position.x, y: quad[5] + position.y },\n      { x: quad[6] + position.x, y: quad[7] + position.y }\n    ]);\n  }\n\n  async _adoptElementHandle<T extends Node>(handle: dom.ElementHandle<T>, to: dom.FrameExecutionContext): Promise<dom.ElementHandle<T>> {\n    const nodeInfo = await this._client.send('DOM.describeNode', {\n      objectId: handle._objectId,\n    });\n    return this._adoptBackendNodeId(nodeInfo.node.backendNodeId, to) as Promise<dom.ElementHandle<T>>;\n  }\n\n  async _adoptBackendNodeId(backendNodeId: Protocol.DOM.BackendNodeId, to: dom.FrameExecutionContext): Promise<dom.ElementHandle> {\n    const result = await this._client._sendMayFail('DOM.resolveNode', {\n      backendNodeId,\n      executionContextId: (to._delegate as CRExecutionContext)._contextId,\n    });\n    if (!result || result.object.subtype === 'null')\n      throw new Error(dom.kUnableToAdoptErrorMessage);\n    return to.createHandle(result.object).asElement()!;\n  }\n}\n\nasync function emulateLocale(session: CRSession, locale: string) {\n  try {\n    await session.send('Emulation.setLocaleOverride', { locale });\n  } catch (exception) {\n    // All pages in the same renderer share locale. All such pages belong to the same\n    // context and if locale is overridden for one of them its value is the same as\n    // we are trying to set so it's not a problem.\n    if (exception.message.includes('Another locale override is already in effect'))\n      return;\n    throw exception;\n  }\n}\n\nasync function emulateTimezone(session: CRSession, timezoneId: string) {\n  try {\n    await session.send('Emulation.setTimezoneOverride', { timezoneId: timezoneId });\n  } catch (exception) {\n    if (exception.message.includes('Timezone override is already in effect'))\n      return;\n    if (exception.message.includes('Invalid timezone'))\n      throw new Error(`Invalid timezone ID: ${timezoneId}`);\n    throw exception;\n  }\n}\n"],"file":"crPage.js"}