{"version":3,"sources":["../../../src/server/common/componentUtils.ts"],"names":["checkComponentAttribute","obj","attr","token","jsonPath","undefined","objValue","caseSensetive","toUpperCase","attrValue","value","op","includes","startsWith","endsWith","split","parseComponentSelector","selector","wp","EOL","length","next","eat1","result","syntaxError","stage","Error","skipSpaces","test","readIdentifier","readQuotedString","quote","readAttributeToken","slice","readOperator","readAttribute","push","operator","isNaN","name","attributes"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\ntype Operator = '<truthy>'|'='|'*='|'|='|'^='|'$='|'~=';\nexport type ParsedComponentAttribute = {\n  jsonPath: string[],\n  op: Operator,\n  value: any,\n  caseSensetive: boolean,\n};\n\nexport type ParsedComponentSelector = {\n  name: string,\n  attributes: ParsedComponentAttribute[],\n};\n\nexport function checkComponentAttribute(obj: any, attr: ParsedComponentAttribute) {\n  for (const token of attr.jsonPath) {\n    if (obj !== undefined && obj !== null)\n      obj = obj[token];\n  }\n  const objValue = typeof obj === 'string' && !attr.caseSensetive ? obj.toUpperCase() : obj;\n  const attrValue = typeof attr.value === 'string' && !attr.caseSensetive ? attr.value.toUpperCase() : attr.value;\n\n  if (attr.op === '<truthy>')\n    return !!objValue;\n  if (attr.op === '=')\n    return objValue === attrValue;\n  if (typeof objValue !== 'string' || typeof attrValue !== 'string')\n    return false;\n  if (attr.op === '*=')\n    return objValue.includes(attrValue);\n  if (attr.op === '^=')\n    return objValue.startsWith(attrValue);\n  if (attr.op === '$=')\n    return objValue.endsWith(attrValue);\n  if (attr.op === '|=')\n    return objValue === attrValue || objValue.startsWith(attrValue + '-');\n  if (attr.op === '~=')\n    return objValue.split(' ').includes(attrValue);\n  return false;\n}\n\nexport function parseComponentSelector(selector: string): ParsedComponentSelector {\n  let wp = 0;\n  let EOL = selector.length === 0;\n\n  const next = () => selector[wp] || '';\n  const eat1 = () => {\n    const result = next();\n    ++wp;\n    EOL = wp >= selector.length;\n    return result;\n  };\n\n  const syntaxError = (stage: string|undefined) => {\n    if (EOL)\n      throw new Error(`Unexpected end of selector while parsing selector \\`${selector}\\``);\n    throw new Error(`Error while parsing selector \\`${selector}\\` - unexpected symbol \"${next()}\" at position ${wp}` + (stage ? ' during ' + stage : ''));\n  };\n\n  function skipSpaces() {\n    while (!EOL && /\\s/.test(next()))\n      eat1();\n  }\n\n  function readIdentifier() {\n    let result = '';\n    skipSpaces();\n    while (!EOL && /[-$0-9A-Z_]/i.test(next()))\n      result += eat1();\n    return result;\n  }\n\n  function readQuotedString(quote: string) {\n    let result = eat1();\n    if (result !== quote)\n      syntaxError('parsing quoted string');\n    while (!EOL && next() !== quote) {\n      if (next() === '\\\\')\n        eat1();\n      result += eat1();\n    }\n    if (next() !== quote)\n      syntaxError('parsing quoted string');\n    result += eat1();\n    return result;\n  }\n\n  function readAttributeToken() {\n    let token = '';\n    skipSpaces();\n    if (next() === `'` || next() === `\"`)\n      token = readQuotedString(next()).slice(1, -1);\n    else\n      token = readIdentifier();\n    if (!token)\n      syntaxError('parsing property path');\n    return token;\n  }\n\n  function readOperator(): Operator {\n    skipSpaces();\n    let op = '';\n    if (!EOL)\n      op += eat1();\n    if (!EOL && (op !== '='))\n      op += eat1();\n    if (!['=', '*=', '^=', '$=', '|=', '~='].includes(op))\n      syntaxError('parsing operator');\n    return (op as Operator);\n  }\n\n  function readAttribute(): ParsedComponentAttribute {\n    // skip leading [\n    eat1();\n\n    // read attribute name:\n    // foo.bar\n    // 'foo'  . \"ba zz\"\n    const jsonPath = [];\n    jsonPath.push(readAttributeToken());\n    skipSpaces();\n    while (next() === '.') {\n      eat1();\n      jsonPath.push(readAttributeToken());\n      skipSpaces();\n    }\n    // check property is truthy: [enabled]\n    if (next() === ']') {\n      eat1();\n      return {jsonPath, op: '<truthy>', value: null, caseSensetive: false};\n    }\n\n    const operator = readOperator();\n\n    let value = undefined;\n    let caseSensetive = true;\n    skipSpaces();\n    if (next() === `'` || next() === `\"`) {\n      value = readQuotedString(next()).slice(1, -1);\n      skipSpaces();\n      if (next() === 'i' || next() === 'I') {\n        caseSensetive = false;\n        eat1();\n      } else if (next() === 's' || next() === 'S') {\n        caseSensetive = true;\n        eat1();\n      }\n    } else {\n      value = '';\n      while (!EOL && !/\\s/.test(next()) && next() !== ']')\n        value += eat1();\n      if (value === 'true') {\n        value = true;\n      } else if (value === 'false') {\n        value = false;\n      } else {\n        value = +value;\n        if (isNaN(value))\n          syntaxError('parsing attribute value');\n      }\n    }\n    skipSpaces();\n    if (next() !== ']')\n      syntaxError('parsing attribute value');\n\n    eat1();\n    if (operator !== '=' && typeof value !== 'string')\n      throw new Error(`Error while parsing selector \\`${selector}\\` - cannot use ${operator} in attribute with non-string matching value - ${value}`);\n    return {jsonPath, op: operator, value, caseSensetive};\n  }\n\n  const result: ParsedComponentSelector = {\n    name: '',\n    attributes: [],\n  };\n  result.name = readIdentifier();\n  skipSpaces();\n  while (next() === '[') {\n    result.attributes.push(readAttribute());\n    skipSpaces();\n  }\n  if (!EOL)\n    syntaxError(undefined);\n  if (!result.name && !result.attributes.length)\n    throw new Error(`Error while parsing selector \\`${selector}\\` - selector cannot be empty`);\n  return result;\n}\n"],"file":"componentUtils.js"}