{"version":3,"sources":["../../../src/server/webkit/wkExecutionContext.ts"],"names":["WKExecutionContext","constructor","session","contextId","_session","_contextId","_contextDestroyedCallback","_executionContextDestroyedPromise","Promise","resolve","reject","_dispose","rawEvaluateJSON","expression","response","send","returnByValue","wasThrown","Error","result","description","value","error","rewriteError","rawEvaluateHandle","objectId","rawCallFunctionNoReply","func","args","functionDeclaration","toString","find","a","js","JSHandle","_objectId","arguments","map","emulateUserGesture","catch","evaluateWithArguments","utilityScript","values","objectIds","race","then","contextDestroyedResult","awaitPromise","_context","createHandle","getProperties","context","ownProperties","Map","property","properties","enumerable","set","name","remoteObject","isPromise","className","subtype","type","renderPreview","potentiallyUnserializableValue","releaseHandle","isUnserializable","includes","parseUnserializableValue","isContextDestroyedError","object","String","preview","tokens","push","join"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { WKSession } from './wkConnection';\nimport { Protocol } from './protocol';\nimport * as js from '../javascript';\nimport { parseEvaluationResultValue } from '../common/utilityScriptSerializers';\n\nexport class WKExecutionContext implements js.ExecutionContextDelegate {\n  private readonly _session: WKSession;\n  readonly _contextId: number | undefined;\n  private _contextDestroyedCallback: () => void = () => {};\n  private readonly _executionContextDestroyedPromise: Promise<unknown>;\n\n  constructor(session: WKSession, contextId: number | undefined) {\n    this._session = session;\n    this._contextId = contextId;\n    this._executionContextDestroyedPromise = new Promise<void>((resolve, reject) => {\n      this._contextDestroyedCallback = resolve;\n    });\n  }\n\n  _dispose() {\n    this._contextDestroyedCallback();\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    try {\n      const response = await this._session.send('Runtime.evaluate', {\n        expression,\n        contextId: this._contextId,\n        returnByValue: true\n      });\n      if (response.wasThrown)\n        throw new Error('Evaluation failed: ' + response.result.description);\n      return response.result.value;\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  async rawEvaluateHandle(expression: string): Promise<js.ObjectId> {\n    try {\n      const response = await this._session.send('Runtime.evaluate', {\n        expression,\n        contextId: this._contextId,\n        returnByValue: false\n      });\n      if (response.wasThrown)\n        throw new Error('Evaluation failed: ' + response.result.description);\n      return response.result.objectId!;\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  rawCallFunctionNoReply(func: Function, ...args: any[]) {\n    this._session.send('Runtime.callFunctionOn', {\n      functionDeclaration: func.toString(),\n      objectId: args.find(a => a instanceof js.JSHandle)!._objectId,\n      arguments: args.map(a => a instanceof js.JSHandle ? { objectId: a._objectId } : { value: a }),\n      returnByValue: true,\n      emulateUserGesture: true\n    }).catch(() => {});\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], objectIds: string[]): Promise<any> {\n    try {\n      const response = await Promise.race([\n        this._executionContextDestroyedPromise.then(() => contextDestroyedResult),\n        this._session.send('Runtime.callFunctionOn', {\n          functionDeclaration: expression,\n          objectId: utilityScript._objectId!,\n          arguments: [\n            { objectId: utilityScript._objectId },\n            ...values.map(value => ({ value })),\n            ...objectIds.map(objectId => ({ objectId })),\n          ],\n          returnByValue,\n          emulateUserGesture: true,\n          awaitPromise: true\n        })\n      ]);\n      if (response.wasThrown)\n        throw new Error('Evaluation failed: ' + response.result.description);\n      if (returnByValue)\n        return parseEvaluationResultValue(response.result.value);\n      return utilityScript._context.createHandle(response.result);\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  async getProperties(context: js.ExecutionContext, objectId: js.ObjectId): Promise<Map<string, js.JSHandle>> {\n    const response = await this._session.send('Runtime.getProperties', {\n      objectId,\n      ownProperties: true\n    });\n    const result = new Map();\n    for (const property of response.properties) {\n      if (!property.enumerable || !property.value)\n        continue;\n      result.set(property.name, context.createHandle(property.value));\n    }\n    return result;\n  }\n\n  createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n    const isPromise = remoteObject.className === 'Promise';\n    return new js.JSHandle(context, isPromise ? 'promise' : remoteObject.subtype || remoteObject.type, renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n  }\n\n  async releaseHandle(objectId: js.ObjectId): Promise<void> {\n    await this._session.send('Runtime.releaseObject', { objectId });\n  }\n}\n\nconst contextDestroyedResult = {\n  wasThrown: true,\n  result: {\n    description: 'Protocol error: Execution context was destroyed, most likely because of a navigation.'\n  } as Protocol.Runtime.RemoteObject\n};\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const isUnserializable = remoteObject.type === 'number' && ['NaN', '-Infinity', 'Infinity', '-0'].includes(remoteObject.description!);\n  return isUnserializable ? js.parseUnserializableValue(remoteObject.description!) : value;\n}\n\nfunction rewriteError(error: Error): Error {\n  if (js.isContextDestroyedError(error))\n    return new Error('Execution context was destroyed, most likely because of a navigation.');\n  return error;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if ('value' in object)\n    return String(object.value);\n\n  if (object.description === 'Object' && object.preview) {\n    const tokens = [];\n    for (const { name, value } of object.preview.properties!)\n      tokens.push(`${name}: ${value}`);\n    return `{${tokens.join(', ')}}`;\n  }\n  if (object.subtype === 'array' && object.preview) {\n    const result = [];\n    for (const { name, value } of object.preview.properties!)\n      result[+name] = value;\n    return '[' + String(result) + ']';\n  }\n  return object.description;\n}\n"],"file":"wkExecutionContext.js"}