{"version":3,"sources":["../../../src/server/webkit/wkAccessibility.ts"],"names":["getAccessibilityTree","session","needle","objectId","_objectId","undefined","axNode","send","tree","WKAXNode","_findNeedle","WKRoleToARIARole","Map","Object","entries","WKUnhelpfulRoleDescriptions","constructor","payload","_payload","_children","children","push","found","child","isControl","role","_isTextControl","_name","value","name","isInteresting","insideControl","focusable","isLeafNode","_hasRendundantTextChild","length","serialize","node","get","description","roledescription","valueString","valueNumber","checked","pressed","userStringProperties","userStringProperty","booleanProperties","booleanProperty","numericalProperties","numericalProperty","tokenProperties","tokenProperty","orientationIsApplicable","Set","orientation","has"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport * as accessibility from '../accessibility';\nimport { WKSession } from './wkConnection';\nimport { Protocol } from './protocol';\nimport * as dom from '../dom';\nimport * as types from '../types';\n\nexport async function getAccessibilityTree(session: WKSession, needle?: dom.ElementHandle) {\n  const objectId = needle ? needle._objectId : undefined;\n  const {axNode} = await session.send('Page.accessibilitySnapshot', { objectId });\n  const tree = new WKAXNode(axNode);\n  return {\n    tree,\n    needle: needle ? tree._findNeedle() : null\n  };\n}\n\nconst WKRoleToARIARole = new Map(Object.entries({\n  'TextField': 'textbox',\n}));\n\n// WebKit localizes role descriptions on mac, but the english versions only add noise.\nconst WKUnhelpfulRoleDescriptions = new Map(Object.entries({\n  'WebArea': 'HTML content',\n  'Summary': 'summary',\n  'DescriptionList': 'description list',\n  'ImageMap': 'image map',\n  'ListMarker': 'list marker',\n  'Video': 'video playback',\n  'Mark': 'highlighted',\n  'contentinfo': 'content information',\n  'Details': 'details',\n  'DescriptionListDetail': 'description',\n  'DescriptionListTerm': 'term',\n  'alertdialog': 'web alert dialog',\n  'dialog': 'web dialog',\n  'status': 'application status',\n  'tabpanel': 'tab panel',\n  'application': 'web application',\n}));\n\nclass WKAXNode implements accessibility.AXNode {\n    private _payload: Protocol.Page.AXNode;\n    private _children: WKAXNode[];\n\n    constructor(payload: Protocol.Page.AXNode) {\n      this._payload = payload;\n\n      this._children = [];\n      for (const payload of this._payload.children || [])\n        this._children.push(new WKAXNode(payload));\n    }\n\n    children() {\n      return this._children;\n    }\n\n    _findNeedle(): WKAXNode | null {\n      if (this._payload.found)\n        return this;\n      for (const child of this._children) {\n        const found = child._findNeedle();\n        if (found)\n          return found;\n      }\n      return null;\n    }\n\n    isControl(): boolean {\n      switch (this._payload.role) {\n        case 'button':\n        case 'checkbox':\n        case 'ColorWell':\n        case 'combobox':\n        case 'DisclosureTriangle':\n        case 'listbox':\n        case 'menu':\n        case 'menubar':\n        case 'menuitem':\n        case 'menuitemcheckbox':\n        case 'menuitemradio':\n        case 'radio':\n        case 'scrollbar':\n        case 'searchbox':\n        case 'slider':\n        case 'spinbutton':\n        case 'switch':\n        case 'tab':\n        case 'textbox':\n        case 'TextField':\n        case 'tree':\n          return true;\n        default:\n          return false;\n      }\n    }\n\n    _isTextControl(): boolean {\n      switch (this._payload.role) {\n        case 'combobox':\n        case 'searchfield':\n        case 'textbox':\n        case 'TextField':\n          return true;\n      }\n      return false;\n    }\n\n    _name(): string {\n      if (this._payload.role === 'text')\n        return this._payload.value || '';\n      return this._payload.name || '';\n    }\n\n    isInteresting(insideControl: boolean): boolean {\n      const {role, focusable} = this._payload;\n      const name = this._name();\n      if (role === 'ScrollArea')\n        return false;\n      if (role === 'WebArea')\n        return true;\n\n      if (focusable || role === 'MenuListOption')\n        return true;\n\n      // If it's not focusable but has a control role, then it's interesting.\n      if (this.isControl())\n        return true;\n\n      // A non focusable child of a control is not interesting\n      if (insideControl)\n        return false;\n\n      return this.isLeafNode() && !!name;\n    }\n\n    _hasRendundantTextChild() {\n      if (this._children.length !== 1)\n        return false;\n      const child = this._children[0];\n      return child._payload.role === 'text' && this._payload.name === child._payload.value;\n    }\n\n    isLeafNode(): boolean {\n      if (!this._children.length)\n        return true;\n      // WebKit on Linux ignores everything inside text controls, normalize this behavior\n      if (this._isTextControl())\n        return true;\n      // WebKit for mac has text nodes inside heading, li, menuitem, a, and p nodes\n      if (this._hasRendundantTextChild())\n        return true;\n      return false;\n    }\n\n    serialize(): types.SerializedAXNode {\n      const node: types.SerializedAXNode = {\n        role: WKRoleToARIARole.get(this._payload.role) || this._payload.role,\n        name: this._name(),\n      };\n\n      if ('description' in this._payload && this._payload.description !== node.name)\n        node.description = this._payload.description;\n\n      if ('roledescription' in this._payload) {\n        const roledescription = this._payload.roledescription;\n        if (roledescription !== this._payload.role && WKUnhelpfulRoleDescriptions.get(this._payload.role) !== roledescription)\n          node.roledescription = roledescription;\n      }\n\n      if ('value' in this._payload && this._payload.role !== 'text') {\n        if (typeof this._payload.value === 'string')\n          node.valueString = this._payload.value;\n        else if (typeof this._payload.value === 'number')\n          node.valueNumber = this._payload.value;\n      }\n\n      if ('checked' in this._payload)\n        node.checked = this._payload.checked === 'true' ? 'checked' : this._payload.checked === 'false' ? 'unchecked' : 'mixed';\n\n      if ('pressed' in this._payload)\n        node.pressed = this._payload.pressed === 'true' ? 'pressed' : this._payload.pressed === 'false' ? 'released' : 'mixed';\n\n      const userStringProperties: Array<keyof types.SerializedAXNode & keyof Protocol.Page.AXNode> = [\n        'keyshortcuts',\n        'valuetext'\n      ];\n      for (const userStringProperty of userStringProperties) {\n        if (!(userStringProperty in this._payload))\n          continue;\n        (node as any)[userStringProperty] = this._payload[userStringProperty];\n      }\n\n      const booleanProperties: Array<keyof types.SerializedAXNode & keyof Protocol.Page.AXNode> = [\n        'disabled',\n        'expanded',\n        'focused',\n        'modal',\n        'multiline',\n        'multiselectable',\n        'readonly',\n        'required',\n        'selected',\n      ];\n      for (const booleanProperty of booleanProperties) {\n        // WebArea and ScorllArea treat focus differently than other nodes. They report whether their frame  has focus,\n        // not whether focus is specifically on the root node.\n        if (booleanProperty === 'focused' && (this._payload.role === 'WebArea' || this._payload.role === 'ScrollArea'))\n          continue;\n        const value = this._payload[booleanProperty];\n        if (!value)\n          continue;\n        (node as any)[booleanProperty] = value;\n      }\n\n      const numericalProperties: Array<keyof types.SerializedAXNode & keyof Protocol.Page.AXNode> = [\n        'level',\n        'valuemax',\n        'valuemin',\n      ];\n      for (const numericalProperty of numericalProperties) {\n        if (!(numericalProperty in this._payload))\n          continue;\n        (node as any)[numericalProperty] = (this._payload as any)[numericalProperty];\n      }\n      const tokenProperties: Array<keyof types.SerializedAXNode & keyof Protocol.Page.AXNode> = [\n        'autocomplete',\n        'haspopup',\n        'invalid',\n      ];\n      for (const tokenProperty of tokenProperties) {\n        const value = (this._payload as any)[tokenProperty];\n        if (!value || value === 'false')\n          continue;\n        (node as any)[tokenProperty] = value;\n      }\n\n      const orientationIsApplicable = new Set([\n        'ScrollArea',\n        'scrollbar',\n        'listbox',\n        'combobox',\n        'menu',\n        'tree',\n        'separator',\n        'slider',\n        'tablist',\n        'toolbar',\n      ]);\n      if (this._payload.orientation && orientationIsApplicable.has(this._payload.role))\n        node.orientation = this._payload.orientation;\n\n      return node;\n    }\n}\n"],"file":"wkAccessibility.js"}