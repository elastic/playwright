{"version":3,"sources":["../../../src/server/webkit/wkPage.ts"],"names":["UTILITY_WORLD_NAME","BINDING_CALL_MESSAGE","WKPage","constructor","browserContext","pageProxySession","opener","rawMouse","rawKeyboard","rawTouchscreen","_session","_provisionalPage","_page","_pagePromise","_pagePromiseCallback","_pageProxySession","_opener","_requestIdToRequest","Map","_workers","_contextIdToContext","_mainFrameContextId","_sessionListeners","_eventListeners","_browserContext","_initializedPage","_firstNonInitialNavigationCommittedPromise","_firstNonInitialNavigationCommittedFulfill","_firstNonInitialNavigationCommittedReject","e","_lastConsoleMessage","_requestIdToResponseReceivedPayloadEvent","_needsResponseInterception","_nextWindowOpenPopupFeatures","_recordingVideoFile","_screencastGeneration","RawKeyboardImpl","RawMouseImpl","RawTouchscreenImpl","Page","WKWorkers","undefined","on","Events","FrameDetached","frame","_removeContextsForFrame","eventsHelper","addEventListener","_onTargetCreated","bind","_onTargetDestroyed","_onDispatchMessageFromTarget","_onDidCommitProvisionalTarget","_onScreencastFrame","Promise","f","r","_options","noDefaultViewport","viewportSize","helper","getViewportSizeFromWindowFeatures","_state","emulatedSize","viewport","screen","_initializePageProxySession","promises","send","active","contextOptions","javaScriptEnabled","push","enabled","_updateViewport","updateHttpCredentials","_permissions","size","key","value","_grantPermissions","recordVideo","outputFile","path","join","dir","_ensureVideosPath","then","_startVideo","all","_setSession","session","removeEventListeners","setSession","_addSessionListeners","_initializeSession","provisional","resourceTreeHandler","_initializeSessionMayThrow","catch","isDisposed","frameTree","name","_","initializeSession","_needsRequestInterception","url","stage","isRegex","userAgent","mediaType","colorScheme","reducedMotion","_setEmulateMedia","world","bootstrapScript","_calculateBootstrapScript","length","source","worldName","webkitWorldName","frames","map","evaluateExpression","bypassCSP","width","height","updateEmulateMedia","headers","_calculateExtraHTTPHeaders","offline","hasTouch","timezoneId","timeZone","Error","setting","isMobile","event","oldTargetId","newTargetId","sessionId","errorText","kSwappedOutErrorMessage","newSession","commit","dispose","targetId","crashed","markAsCrashed","_didCrash","didClose","_didClose","disconnected","_didDisconnect","dispatchMessageToSession","message","dispatchMessage","handleProvisionalLoadFailed","error","includes","_frameManager","frameAbortedNavigation","mainFrame","_id","loaderId","handleWindowOpen","windowFeatures","pageOrError","targetInfo","WKSession","connection","type","JSON","stringify","id","isProvisional","_handleFrameTree","isPaused","sendMayFail","initOpener","reportAsNew","WKProvisionalPage","initializationPromise","parse","_onFrameNavigated","_onFrameNavigatedWithinDocument","frameId","_onFrameAttached","parentFrameId","_onFrameDetached","_onFrameScheduledNavigation","_onFrameStoppedLoading","_onLifecycleEvent","_onExecutionContextCreated","context","_onConsoleMessage","_onConsoleRepeatCountUpdated","_onDialog","_onFileChooserOpened","_onRequestWillBeSent","_onRequestIntercepted","_onResponseIntercepted","_onResponseReceived","_onLoadingFinished","_onLoadingFailed","onWebSocketCreated","requestId","onWebSocketRequest","onWebSocketResponse","response","status","statusText","payloadData","onWebSocketFrameSent","opcode","webSocketFrameReceived","webSocketClosed","webSocketError","errorMessage","_updateState","method","params","_forAllSessions","callback","sessions","frameRequestedNavigation","frameStoppedLoading","frameLifecycleEvent","parentId","childFrames","child","frameAttached","framePayload","initial","clear","frameCommittedNewDocumentNavigation","frameCommittedSameDocumentNavigation","frameDetached","notifyFrame","contextId","_delegate","_dispose","delete","_contextDestroyed","contextPayload","has","delegate","WKExecutionContext","dom","FrameExecutionContext","_contextCreated","set","navigateFrame","referrer","pageProxyId","result","browserSession","newDocumentId","level","text","parameters","line","lineNumber","column","columnNumber","parsedObjectId","objectId","get","injectedScriptId","_onBindingCalled","stack","stackTrace","callFrame","functionName","firePageError","derivedType","handles","p","createHandle","count","location","i","_addConsoleMessage","emit","Dialog","dialog","accept","promptText","defaultPrompt","handle","_mainContext","element","asElement","media","appearance","reducedMotionWk","updateExtraHTTPHeaders","locale","network","mergeHeaders","extraHTTPHeaders","singleHeader","setEmulatedSize","bringToFront","options","deviceSize","screenSize","fixedLayout","deviceScaleFactor","angle","_ensureResponseInterceptionEnabled","updateRequestInterception","updateOffline","credentials","httpCredentials","username","password","setFileChooserIntercepted","reload","goBack","goForward","exposeBinding","binding","_updateBootstrapScript","_evaluateBindingScript","script","_bindingToScript","evaluateOnNewDocument","scripts","allBindings","_evaluateOnNewDocumentSources","closePage","runBeforeUnload","_stopVideo","canScreenshotOutsideViewport","setBackgroundColor","color","_toolbarHeight","_browser","headful","hostPlatform","screencastId","file","toolbarHeight","_videoStarted","takeScreenshot","progress","format","documentRect","viewportRect","quality","rect","coordinateSystem","prefix","buffer","Buffer","from","dataURL","substr","jpeg","encode","png","PNG","sync","read","data","resetViewport","getContentFrame","nodeInfo","_objectId","contentFrameId","getOwnerFrame","ownerFrameId","isElementHandle","remoteObject","subtype","getBoundingBox","quads","getContentQuads","minX","Infinity","maxX","minY","maxY","quad","point","Math","min","x","max","y","scrollRectIntoViewIfNeeded","setScreencastOptions","so","generation","debugLogger","log","ScreencastFrame","deviceWidth","deviceHeight","rafCountForStablePosition","process","platform","setInputFiles","files","protocolFiles","mimeType","adoptElementHandle","to","executionContextId","_contextId","object","kUnableToAdoptErrorMessage","getAccessibilityTree","needle","inputActionEpilogue","getFrameElement","parent","parentFrame","selectors","_queryAll","items","contentFrame","find","item","resolve","request","startsWith","redirectedFrom","redirectResponse","_handleRequestRedirect","timestamp","isNavigationRequest","documentId","route","WKRouteImpl","WKInterceptableRequest","requestStarted","responsePayload","createResponse","_securityDetailsFinished","_serverAddrFinished","_requestFinished","timing","secondsToRoundishMillis","_timestamp","_requestId","requestReceivedResponse","requestFinished","errorType","_route","_requestInterceptedCallback","_routeForRedirectChain","_responseInterceptedCallback","requestHeaders","Object","keys","updateWithRawHeaders","_existingResponse","responseReceivedPayload","parseRemoteAddress","metrics","remoteAddress","protocol","isLoadedSecurely","securityConnection","subjectName","security","certificate","subject","validFrom","validTo","validUntil","responseBodyBytesReceived","responseHeaderBytesReceived","transferSize","_setHttpVersion","_setFailureText","requestFailed","origin","permissions","webPermissionToProtocol","filtered","permission","protocolPermission","_clearPermissions","colon","lastIndexOf","dot","ipAddress","slice","port","address","split","u","URL","secureConnectionStart","connectStart"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as jpeg from 'jpeg-js';\nimport path from 'path';\nimport * as png from 'pngjs';\nimport { splitErrorMessage } from '../../utils/stackTrace';\nimport { assert, createGuid, debugAssert, headersArrayToObject, headersObjectToArray, hostPlatform } from '../../utils/utils';\nimport * as accessibility from '../accessibility';\nimport * as dialog from '../dialog';\nimport * as dom from '../dom';\nimport * as frames from '../frames';\nimport { eventsHelper, RegisteredListener } from '../../utils/eventsHelper';\nimport { helper } from '../helper';\nimport { JSHandle, kSwappedOutErrorMessage } from '../javascript';\nimport * as network from '../network';\nimport { Page, PageBinding, PageDelegate } from '../page';\nimport { Progress } from '../progress';\nimport * as types from '../types';\nimport { Protocol } from './protocol';\nimport { getAccessibilityTree } from './wkAccessibility';\nimport { WKBrowserContext } from './wkBrowser';\nimport { WKSession } from './wkConnection';\nimport { WKExecutionContext } from './wkExecutionContext';\nimport { RawKeyboardImpl, RawMouseImpl, RawTouchscreenImpl } from './wkInput';\nimport { WKInterceptableRequest, WKRouteImpl } from './wkInterceptableRequest';\nimport { WKProvisionalPage } from './wkProvisionalPage';\nimport { WKWorkers } from './wkWorkers';\nimport { debugLogger } from '../../utils/debugLogger';\n\nconst UTILITY_WORLD_NAME = '__playwright_utility_world__';\nconst BINDING_CALL_MESSAGE = '__playwright_binding_call__';\n\nexport class WKPage implements PageDelegate {\n  readonly rawMouse: RawMouseImpl;\n  readonly rawKeyboard: RawKeyboardImpl;\n  readonly rawTouchscreen: RawTouchscreenImpl;\n  _session: WKSession;\n  private _provisionalPage: WKProvisionalPage | null = null;\n  readonly _page: Page;\n  private readonly _pagePromise: Promise<Page | Error>;\n  private _pagePromiseCallback: (page: Page | Error) => void = () => {};\n  private readonly _pageProxySession: WKSession;\n  readonly _opener: WKPage | null;\n  private readonly _requestIdToRequest = new Map<string, WKInterceptableRequest>();\n  private readonly _workers: WKWorkers;\n  private readonly _contextIdToContext: Map<number, dom.FrameExecutionContext>;\n  private _mainFrameContextId?: number;\n  private _sessionListeners: RegisteredListener[] = [];\n  private _eventListeners: RegisteredListener[];\n  readonly _browserContext: WKBrowserContext;\n  _initializedPage: Page | null = null;\n  private _firstNonInitialNavigationCommittedPromise: Promise<void>;\n  private _firstNonInitialNavigationCommittedFulfill = () => {};\n  _firstNonInitialNavigationCommittedReject = (e: Error) => {};\n  private _lastConsoleMessage: { derivedType: string, text: string, handles: JSHandle[]; count: number, location: types.ConsoleMessageLocation; } | null = null;\n\n  private readonly _requestIdToResponseReceivedPayloadEvent = new Map<string, Protocol.Network.responseReceivedPayload>();\n  _needsResponseInterception: boolean = false;\n  // Holds window features for the next popup being opened via window.open,\n  // until the popup page proxy arrives.\n  private _nextWindowOpenPopupFeatures?: string[];\n  private _recordingVideoFile: string | null = null;\n  private _screencastGeneration: number = 0;\n\n  constructor(browserContext: WKBrowserContext, pageProxySession: WKSession, opener: WKPage | null) {\n    this._pageProxySession = pageProxySession;\n    this._opener = opener;\n    this.rawKeyboard = new RawKeyboardImpl(pageProxySession);\n    this.rawMouse = new RawMouseImpl(pageProxySession);\n    this.rawTouchscreen = new RawTouchscreenImpl(pageProxySession);\n    this._contextIdToContext = new Map();\n    this._page = new Page(this, browserContext);\n    this._workers = new WKWorkers(this._page);\n    this._session = undefined as any as WKSession;\n    this._browserContext = browserContext;\n    this._page.on(Page.Events.FrameDetached, (frame: frames.Frame) => this._removeContextsForFrame(frame, false));\n    this._eventListeners = [\n      eventsHelper.addEventListener(this._pageProxySession, 'Target.targetCreated', this._onTargetCreated.bind(this)),\n      eventsHelper.addEventListener(this._pageProxySession, 'Target.targetDestroyed', this._onTargetDestroyed.bind(this)),\n      eventsHelper.addEventListener(this._pageProxySession, 'Target.dispatchMessageFromTarget', this._onDispatchMessageFromTarget.bind(this)),\n      eventsHelper.addEventListener(this._pageProxySession, 'Target.didCommitProvisionalTarget', this._onDidCommitProvisionalTarget.bind(this)),\n      eventsHelper.addEventListener(this._pageProxySession, 'Screencast.screencastFrame', this._onScreencastFrame.bind(this)),\n    ];\n    this._pagePromise = new Promise(f => this._pagePromiseCallback = f);\n    this._firstNonInitialNavigationCommittedPromise = new Promise((f, r) => {\n      this._firstNonInitialNavigationCommittedFulfill = f;\n      this._firstNonInitialNavigationCommittedReject = r;\n    });\n    if (opener && !browserContext._options.noDefaultViewport && opener._nextWindowOpenPopupFeatures) {\n      const viewportSize = helper.getViewportSizeFromWindowFeatures(opener._nextWindowOpenPopupFeatures);\n      opener._nextWindowOpenPopupFeatures = undefined;\n      if (viewportSize)\n        this._page._state.emulatedSize = { viewport: viewportSize, screen: viewportSize };\n    }\n  }\n\n  private async _initializePageProxySession() {\n    const promises: Promise<any>[] = [\n      this._pageProxySession.send('Dialog.enable'),\n      this._pageProxySession.send('Emulation.setActiveAndFocused', { active: true }),\n    ];\n    const contextOptions = this._browserContext._options;\n    if (contextOptions.javaScriptEnabled === false)\n      promises.push(this._pageProxySession.send('Emulation.setJavaScriptEnabled', { enabled: false }));\n    promises.push(this._updateViewport());\n    promises.push(this.updateHttpCredentials());\n    if (this._browserContext._permissions.size) {\n      for (const [key, value] of this._browserContext._permissions)\n        promises.push(this._grantPermissions(key, value));\n    }\n    if (this._browserContext._options.recordVideo) {\n      const outputFile = path.join(this._browserContext._options.recordVideo.dir, createGuid() + '.webm');\n      promises.push(this._browserContext._ensureVideosPath().then(() => {\n        return this._startVideo({\n          // validateBrowserContextOptions ensures correct video size.\n          ...this._browserContext._options.recordVideo!.size!,\n          outputFile,\n        });\n      }));\n    }\n    await Promise.all(promises);\n  }\n\n  private _setSession(session: WKSession) {\n    eventsHelper.removeEventListeners(this._sessionListeners);\n    this._session = session;\n    this.rawKeyboard.setSession(session);\n    this._addSessionListeners();\n    this._workers.setSession(session);\n  }\n\n  // This method is called for provisional targets as well. The session passed as the parameter\n  // may be different from the current session and may be destroyed without becoming current.\n  async _initializeSession(session: WKSession, provisional: boolean, resourceTreeHandler: (r: Protocol.Page.getResourceTreeReturnValue) => void) {\n    await this._initializeSessionMayThrow(session, resourceTreeHandler).catch(e => {\n      // Provisional session can be disposed at any time, for example due to new navigation initiating\n      // a new provisional page.\n      if (provisional && session.isDisposed())\n        return;\n      // Swallow initialization errors due to newer target swap in,\n      // since we will reinitialize again.\n      if (this._session === session)\n        throw e;\n    });\n  }\n\n  private async _initializeSessionMayThrow(session: WKSession, resourceTreeHandler: (r: Protocol.Page.getResourceTreeReturnValue) => void) {\n    const [, frameTree] = await Promise.all([\n      // Page agent must be enabled before Runtime.\n      session.send('Page.enable'),\n      session.send('Page.getResourceTree'),\n    ] as const);\n    resourceTreeHandler(frameTree);\n    const promises: Promise<any>[] = [\n      // Resource tree should be received before first execution context.\n      session.send('Runtime.enable'),\n      session.send('Page.createUserWorld', { name: UTILITY_WORLD_NAME }).catch(_ => {}),  // Worlds are per-process\n      session.send('Console.enable'),\n      session.send('Network.enable'),\n      this._workers.initializeSession(session)\n    ];\n    if (this._page._needsRequestInterception()) {\n      promises.push(session.send('Network.setInterceptionEnabled', { enabled: true }));\n      promises.push(session.send('Network.addInterception', { url: '.*', stage: 'request', isRegex: true }));\n      if (this._needsResponseInterception)\n        promises.push(session.send('Network.addInterception', { url: '.*', stage: 'response', isRegex: true }));\n    }\n\n    const contextOptions = this._browserContext._options;\n    if (contextOptions.userAgent)\n      promises.push(session.send('Page.overrideUserAgent', { value: contextOptions.userAgent }));\n    if (this._page._state.mediaType || this._page._state.colorScheme || this._page._state.reducedMotion)\n      promises.push(WKPage._setEmulateMedia(session, this._page._state.mediaType, this._page._state.colorScheme, this._page._state.reducedMotion));\n    for (const world of ['main', 'utility'] as const) {\n      const bootstrapScript = this._calculateBootstrapScript(world);\n      if (bootstrapScript.length)\n        promises.push(session.send('Page.setBootstrapScript', { source: bootstrapScript, worldName: webkitWorldName(world) }));\n      this._page.frames().map(frame => frame.evaluateExpression(bootstrapScript, false, undefined, world).catch(e => {}));\n    }\n    if (contextOptions.bypassCSP)\n      promises.push(session.send('Page.setBypassCSP', { enabled: true }));\n    if (this._page._state.emulatedSize) {\n      promises.push(session.send('Page.setScreenSizeOverride', {\n        width: this._page._state.emulatedSize.screen.width,\n        height: this._page._state.emulatedSize.screen.height,\n      }));\n    }\n    promises.push(this.updateEmulateMedia());\n    promises.push(session.send('Network.setExtraHTTPHeaders', { headers: headersArrayToObject(this._calculateExtraHTTPHeaders(), false /* lowerCase */) }));\n    if (contextOptions.offline)\n      promises.push(session.send('Network.setEmulateOfflineState', { offline: true }));\n    promises.push(session.send('Page.setTouchEmulationEnabled', { enabled: !!contextOptions.hasTouch }));\n    if (contextOptions.timezoneId) {\n      promises.push(session.send('Page.setTimeZone', { timeZone: contextOptions.timezoneId }).\n          catch(e => { throw new Error(`Invalid timezone ID: ${contextOptions.timezoneId}`); }));\n    }\n    promises.push(session.send('Page.overrideSetting', { setting: 'DeviceOrientationEventEnabled' as any, value: contextOptions.isMobile }));\n    promises.push(session.send('Page.overrideSetting', { setting: 'FullScreenEnabled' as any, value: !contextOptions.isMobile }));\n    promises.push(session.send('Page.overrideSetting', { setting: 'NotificationsEnabled' as any, value: !contextOptions.isMobile }));\n    promises.push(session.send('Page.overrideSetting', { setting: 'PointerLockEnabled' as any, value: !contextOptions.isMobile }));\n    promises.push(session.send('Page.overrideSetting', { setting: 'InputTypeMonthEnabled' as any, value: contextOptions.isMobile }));\n    promises.push(session.send('Page.overrideSetting', { setting: 'InputTypeWeekEnabled' as any, value: contextOptions.isMobile }));\n    await Promise.all(promises);\n  }\n\n  private _onDidCommitProvisionalTarget(event: Protocol.Target.didCommitProvisionalTargetPayload) {\n    const { oldTargetId, newTargetId } = event;\n    assert(this._provisionalPage);\n    assert(this._provisionalPage._session.sessionId === newTargetId, 'Unknown new target: ' + newTargetId);\n    assert(this._session.sessionId === oldTargetId, 'Unknown old target: ' + oldTargetId);\n    this._session.errorText = kSwappedOutErrorMessage;\n    const newSession = this._provisionalPage._session;\n    this._provisionalPage.commit();\n    this._provisionalPage.dispose();\n    this._provisionalPage = null;\n    this._setSession(newSession);\n  }\n\n  private _onTargetDestroyed(event: Protocol.Target.targetDestroyedPayload) {\n    const { targetId, crashed } = event;\n    if (this._provisionalPage && this._provisionalPage._session.sessionId === targetId) {\n      this._provisionalPage._session.dispose(false);\n      this._provisionalPage.dispose();\n      this._provisionalPage = null;\n    } else if (this._session.sessionId === targetId) {\n      this._session.dispose(false);\n      eventsHelper.removeEventListeners(this._sessionListeners);\n      if (crashed) {\n        this._session.markAsCrashed();\n        this._page._didCrash();\n      }\n    }\n  }\n\n  didClose() {\n    this._page._didClose();\n  }\n\n  dispose(disconnected: boolean) {\n    this._pageProxySession.dispose(disconnected);\n    eventsHelper.removeEventListeners(this._sessionListeners);\n    eventsHelper.removeEventListeners(this._eventListeners);\n    if (this._session)\n      this._session.dispose(disconnected);\n    if (this._provisionalPage) {\n      this._provisionalPage._session.dispose(disconnected);\n      this._provisionalPage.dispose();\n      this._provisionalPage = null;\n    }\n    this._page._didDisconnect();\n    this._firstNonInitialNavigationCommittedReject(new Error('Page closed'));\n  }\n\n  dispatchMessageToSession(message: any) {\n    this._pageProxySession.dispatchMessage(message);\n  }\n\n  handleProvisionalLoadFailed(event: Protocol.Playwright.provisionalLoadFailedPayload) {\n    if (!this._initializedPage) {\n      this._firstNonInitialNavigationCommittedReject(new Error('Initial load failed'));\n      return;\n    }\n    if (!this._provisionalPage)\n      return;\n    let errorText = event.error;\n    if (errorText.includes('cancelled'))\n      errorText += '; maybe frame was detached?';\n    this._page._frameManager.frameAbortedNavigation(this._page.mainFrame()._id, errorText, event.loaderId);\n  }\n\n  handleWindowOpen(event: Protocol.Playwright.windowOpenPayload) {\n    debugAssert(!this._nextWindowOpenPopupFeatures);\n    this._nextWindowOpenPopupFeatures = event.windowFeatures;\n  }\n\n  async pageOrError(): Promise<Page | Error> {\n    return this._pagePromise;\n  }\n\n  private async _onTargetCreated(event: Protocol.Target.targetCreatedPayload) {\n    const { targetInfo } = event;\n    const session = new WKSession(this._pageProxySession.connection, targetInfo.targetId, `The ${targetInfo.type} has been closed.`, (message: any) => {\n      this._pageProxySession.send('Target.sendMessageToTarget', {\n        message: JSON.stringify(message), targetId: targetInfo.targetId\n      }).catch(e => {\n        session.dispatchMessage({ id: message.id, error: { message: e.message } });\n      });\n    });\n    assert(targetInfo.type === 'page', 'Only page targets are expected in WebKit, received: ' + targetInfo.type);\n\n    if (!targetInfo.isProvisional) {\n      assert(!this._initializedPage);\n      let pageOrError: Page | Error;\n      try {\n        this._setSession(session);\n        await Promise.all([\n          this._initializePageProxySession(),\n          this._initializeSession(session, false, ({frameTree}) => this._handleFrameTree(frameTree)),\n        ]);\n        pageOrError = this._page;\n      } catch (e) {\n        pageOrError = e;\n      }\n      if (targetInfo.isPaused)\n        this._pageProxySession.sendMayFail('Target.resume', { targetId: targetInfo.targetId });\n      if ((pageOrError instanceof Page) && this._page.mainFrame().url() === '') {\n        try {\n          // Initial empty page has an empty url. We should wait until the first real url has been loaded,\n          // even if that url is about:blank. This is especially important for popups, where we need the\n          // actual url before interacting with it.\n          await this._firstNonInitialNavigationCommittedPromise;\n        } catch (e) {\n          pageOrError = e;\n        }\n      } else {\n        // Avoid rejection on disconnect.\n        this._firstNonInitialNavigationCommittedPromise.catch(() => {});\n      }\n      await this._page.initOpener(this._opener);\n      // Note: it is important to call |reportAsNew| before resolving pageOrError promise,\n      // so that anyone who awaits pageOrError got a ready and reported page.\n      this._initializedPage = pageOrError instanceof Page ? pageOrError : null;\n      this._page.reportAsNew(pageOrError instanceof Page ? undefined : pageOrError);\n      this._pagePromiseCallback(pageOrError);\n    } else {\n      assert(targetInfo.isProvisional);\n      assert(!this._provisionalPage);\n      this._provisionalPage = new WKProvisionalPage(session, this);\n      if (targetInfo.isPaused) {\n        this._provisionalPage.initializationPromise.then(() => {\n          this._pageProxySession.sendMayFail('Target.resume', { targetId: targetInfo.targetId });\n        });\n      }\n    }\n  }\n\n  private _onDispatchMessageFromTarget(event: Protocol.Target.dispatchMessageFromTargetPayload) {\n    const { targetId, message } = event;\n    if (this._provisionalPage && this._provisionalPage._session.sessionId === targetId)\n      this._provisionalPage._session.dispatchMessage(JSON.parse(message));\n    else if (this._session.sessionId === targetId)\n      this._session.dispatchMessage(JSON.parse(message));\n    else\n      throw new Error('Unknown target: ' + targetId);\n  }\n\n  private _addSessionListeners() {\n    // TODO: remove Page.willRequestOpenWindow and Page.didRequestOpenWindow from the protocol.\n    this._sessionListeners = [\n      eventsHelper.addEventListener(this._session, 'Page.frameNavigated', event => this._onFrameNavigated(event.frame, false)),\n      eventsHelper.addEventListener(this._session, 'Page.navigatedWithinDocument', event => this._onFrameNavigatedWithinDocument(event.frameId, event.url)),\n      eventsHelper.addEventListener(this._session, 'Page.frameAttached', event => this._onFrameAttached(event.frameId, event.parentFrameId)),\n      eventsHelper.addEventListener(this._session, 'Page.frameDetached', event => this._onFrameDetached(event.frameId)),\n      eventsHelper.addEventListener(this._session, 'Page.frameScheduledNavigation', event => this._onFrameScheduledNavigation(event.frameId)),\n      eventsHelper.addEventListener(this._session, 'Page.frameStoppedLoading', event => this._onFrameStoppedLoading(event.frameId)),\n      eventsHelper.addEventListener(this._session, 'Page.loadEventFired', event => this._onLifecycleEvent(event.frameId, 'load')),\n      eventsHelper.addEventListener(this._session, 'Page.domContentEventFired', event => this._onLifecycleEvent(event.frameId, 'domcontentloaded')),\n      eventsHelper.addEventListener(this._session, 'Runtime.executionContextCreated', event => this._onExecutionContextCreated(event.context)),\n      eventsHelper.addEventListener(this._session, 'Console.messageAdded', event => this._onConsoleMessage(event)),\n      eventsHelper.addEventListener(this._session, 'Console.messageRepeatCountUpdated', event => this._onConsoleRepeatCountUpdated(event)),\n      eventsHelper.addEventListener(this._pageProxySession, 'Dialog.javascriptDialogOpening', event => this._onDialog(event)),\n      eventsHelper.addEventListener(this._session, 'Page.fileChooserOpened', event => this._onFileChooserOpened(event)),\n      eventsHelper.addEventListener(this._session, 'Network.requestWillBeSent', e => this._onRequestWillBeSent(this._session, e)),\n      eventsHelper.addEventListener(this._session, 'Network.requestIntercepted', e => this._onRequestIntercepted(this._session, e)),\n      eventsHelper.addEventListener(this._session, 'Network.responseIntercepted', e => this._onResponseIntercepted(this._session, e)),\n      eventsHelper.addEventListener(this._session, 'Network.responseReceived', e => this._onResponseReceived(e)),\n      eventsHelper.addEventListener(this._session, 'Network.loadingFinished', e => this._onLoadingFinished(e)),\n      eventsHelper.addEventListener(this._session, 'Network.loadingFailed', e => this._onLoadingFailed(e)),\n      eventsHelper.addEventListener(this._session, 'Network.webSocketCreated', e => this._page._frameManager.onWebSocketCreated(e.requestId, e.url)),\n      eventsHelper.addEventListener(this._session, 'Network.webSocketWillSendHandshakeRequest', e => this._page._frameManager.onWebSocketRequest(e.requestId)),\n      eventsHelper.addEventListener(this._session, 'Network.webSocketHandshakeResponseReceived', e => this._page._frameManager.onWebSocketResponse(e.requestId, e.response.status, e.response.statusText)),\n      eventsHelper.addEventListener(this._session, 'Network.webSocketFrameSent', e => e.response.payloadData && this._page._frameManager.onWebSocketFrameSent(e.requestId, e.response.opcode, e.response.payloadData)),\n      eventsHelper.addEventListener(this._session, 'Network.webSocketFrameReceived', e => e.response.payloadData && this._page._frameManager.webSocketFrameReceived(e.requestId, e.response.opcode, e.response.payloadData)),\n      eventsHelper.addEventListener(this._session, 'Network.webSocketClosed', e => this._page._frameManager.webSocketClosed(e.requestId)),\n      eventsHelper.addEventListener(this._session, 'Network.webSocketFrameError', e => this._page._frameManager.webSocketError(e.requestId, e.errorMessage)),\n    ];\n  }\n  private async _updateState<T extends keyof Protocol.CommandParameters>(\n    method: T,\n    params?: Protocol.CommandParameters[T]\n  ): Promise<void> {\n    await this._forAllSessions(session => session.send(method, params).then());\n  }\n\n  private async _forAllSessions(callback: ((session: WKSession) => Promise<void>)): Promise<void> {\n    const sessions = [\n      this._session\n    ];\n    // If the state changes during provisional load, push it to the provisional page\n    // as well to always be in sync with the backend.\n    if (this._provisionalPage)\n      sessions.push(this._provisionalPage._session);\n    await Promise.all(sessions.map(session => callback(session).catch(e => {})));\n  }\n\n  private _onFrameScheduledNavigation(frameId: string) {\n    this._page._frameManager.frameRequestedNavigation(frameId);\n  }\n\n  private _onFrameStoppedLoading(frameId: string) {\n    this._page._frameManager.frameStoppedLoading(frameId);\n  }\n\n  private _onLifecycleEvent(frameId: string, event: types.LifecycleEvent) {\n    this._page._frameManager.frameLifecycleEvent(frameId, event);\n  }\n\n  private _handleFrameTree(frameTree: Protocol.Page.FrameResourceTree) {\n    this._onFrameAttached(frameTree.frame.id, frameTree.frame.parentId || null);\n    this._onFrameNavigated(frameTree.frame, true);\n    this._page._frameManager.frameLifecycleEvent(frameTree.frame.id, 'domcontentloaded');\n    this._page._frameManager.frameLifecycleEvent(frameTree.frame.id, 'load');\n\n    if (!frameTree.childFrames)\n      return;\n    for (const child of frameTree.childFrames)\n      this._handleFrameTree(child);\n  }\n\n  _onFrameAttached(frameId: string, parentFrameId: string | null): frames.Frame {\n    return this._page._frameManager.frameAttached(frameId, parentFrameId);\n  }\n\n  private _onFrameNavigated(framePayload: Protocol.Page.Frame, initial: boolean) {\n    const frame = this._page._frameManager.frame(framePayload.id);\n    assert(frame);\n    this._removeContextsForFrame(frame, true);\n    if (!framePayload.parentId)\n      this._workers.clear();\n    this._page._frameManager.frameCommittedNewDocumentNavigation(framePayload.id, framePayload.url, framePayload.name || '', framePayload.loaderId, initial);\n    if (!initial)\n      this._firstNonInitialNavigationCommittedFulfill();\n  }\n\n  private _onFrameNavigatedWithinDocument(frameId: string, url: string) {\n    this._page._frameManager.frameCommittedSameDocumentNavigation(frameId, url);\n  }\n\n  private _onFrameDetached(frameId: string) {\n    this._page._frameManager.frameDetached(frameId);\n  }\n\n  private _removeContextsForFrame(frame: frames.Frame, notifyFrame: boolean) {\n    for (const [contextId, context] of this._contextIdToContext) {\n      if (context.frame === frame) {\n        (context._delegate as WKExecutionContext)._dispose();\n        this._contextIdToContext.delete(contextId);\n        if (notifyFrame)\n          frame._contextDestroyed(context);\n      }\n    }\n  }\n\n  private _onExecutionContextCreated(contextPayload: Protocol.Runtime.ExecutionContextDescription) {\n    if (this._contextIdToContext.has(contextPayload.id))\n      return;\n    const frame = this._page._frameManager.frame(contextPayload.frameId);\n    if (!frame)\n      return;\n    const delegate = new WKExecutionContext(this._session, contextPayload.id);\n    let worldName: types.World|null = null;\n    if (contextPayload.type === 'normal')\n      worldName = 'main';\n    else if (contextPayload.type === 'user' && contextPayload.name === UTILITY_WORLD_NAME)\n      worldName = 'utility';\n    const context = new dom.FrameExecutionContext(delegate, frame, worldName);\n    if (worldName)\n      frame._contextCreated(worldName, context);\n    if (contextPayload.type === 'normal' && frame === this._page.mainFrame())\n      this._mainFrameContextId = contextPayload.id;\n    this._contextIdToContext.set(contextPayload.id, context);\n  }\n\n  async navigateFrame(frame: frames.Frame, url: string, referrer: string | undefined): Promise<frames.GotoResult> {\n    if (this._pageProxySession.isDisposed())\n      throw new Error('Target closed');\n    const pageProxyId = this._pageProxySession.sessionId;\n    const result = await this._pageProxySession.connection.browserSession.send('Playwright.navigate', { url, pageProxyId, frameId: frame._id, referrer });\n    return { newDocumentId: result.loaderId };\n  }\n\n  private _onConsoleMessage(event: Protocol.Console.messageAddedPayload) {\n    // Note: do no introduce await in this function, otherwise we lose the ordering.\n    // For example, frame.setContent relies on this.\n    const { type, level, text, parameters, url, line: lineNumber, column: columnNumber, source } = event.message;\n    if (level === 'debug' && parameters && parameters[0].value === BINDING_CALL_MESSAGE) {\n      const parsedObjectId = JSON.parse(parameters[1].objectId!);\n      const context = this._contextIdToContext.get(parsedObjectId.injectedScriptId)!;\n      this.pageOrError().then(pageOrError => {\n        if (!(pageOrError instanceof Error))\n          this._page._onBindingCalled(parameters[2].value, context);\n      });\n      return;\n    }\n    if (level === 'error' && source === 'javascript') {\n      const { name, message } = splitErrorMessage(text);\n\n      let stack: string;\n      if (event.message.stackTrace) {\n        stack = text + '\\n' + event.message.stackTrace.map(callFrame => {\n          return `    at ${callFrame.functionName || 'unknown'} (${callFrame.url}:${callFrame.lineNumber}:${callFrame.columnNumber})`;\n        }).join('\\n');\n      } else {\n        stack = '';\n      }\n\n      const error = new Error(message);\n      error.stack = stack;\n      error.name = name;\n\n      this._page.firePageError(error);\n      return;\n    }\n\n    let derivedType: string = type || '';\n    if (type === 'log')\n      derivedType = level;\n    else if (type === 'timing')\n      derivedType = 'timeEnd';\n\n    const handles = (parameters || []).map(p => {\n      let context: dom.FrameExecutionContext | null = null;\n      if (p.objectId) {\n        const objectId = JSON.parse(p.objectId);\n        context = this._contextIdToContext.get(objectId.injectedScriptId)!;\n      } else {\n        context = this._contextIdToContext.get(this._mainFrameContextId!)!;\n      }\n      return context.createHandle(p);\n    });\n    this._lastConsoleMessage = {\n      derivedType,\n      text,\n      handles,\n      count: 0,\n      location: {\n        url: url || '',\n        lineNumber: (lineNumber || 1) - 1,\n        columnNumber: (columnNumber || 1) - 1,\n      }\n    };\n    this._onConsoleRepeatCountUpdated({ count: 1});\n  }\n\n  _onConsoleRepeatCountUpdated(event: Protocol.Console.messageRepeatCountUpdatedPayload) {\n    if (this._lastConsoleMessage) {\n      const {\n        derivedType,\n        text,\n        handles,\n        count,\n        location\n      } = this._lastConsoleMessage;\n      for (let i = count; i < event.count; ++i)\n        this._page._addConsoleMessage(derivedType, handles, location, handles.length ? undefined : text);\n      this._lastConsoleMessage.count = event.count;\n    }\n  }\n\n  _onDialog(event: Protocol.Dialog.javascriptDialogOpeningPayload) {\n    this._page.emit(Page.Events.Dialog, new dialog.Dialog(\n        this._page,\n        event.type as dialog.DialogType,\n        event.message,\n        async (accept: boolean, promptText?: string) => {\n          await this._pageProxySession.send('Dialog.handleJavaScriptDialog', { accept, promptText });\n        },\n        event.defaultPrompt));\n  }\n\n  private async _onFileChooserOpened(event: {frameId: Protocol.Network.FrameId, element: Protocol.Runtime.RemoteObject}) {\n    let handle;\n    try {\n      const context = await this._page._frameManager.frame(event.frameId)!._mainContext();\n      handle = context.createHandle(event.element).asElement()!;\n    } catch (e) {\n      // During async processing, frame/context may go away. We should not throw.\n      return;\n    }\n    await this._page._onFileChooserOpened(handle);\n  }\n\n  private static async _setEmulateMedia(session: WKSession, mediaType: types.MediaType | null, colorScheme: types.ColorScheme | null, reducedMotion: types.ReducedMotion | null): Promise<void> {\n    const promises = [];\n    promises.push(session.send('Page.setEmulatedMedia', { media: mediaType || '' }));\n    let appearance: any = undefined;\n    switch (colorScheme) {\n      case 'light': appearance = 'Light'; break;\n      case 'dark': appearance = 'Dark'; break;\n    }\n    promises.push(session.send('Page.setForcedAppearance', { appearance }));\n    let reducedMotionWk: any = undefined;\n    switch (reducedMotion) {\n      case 'reduce': reducedMotionWk = 'Reduce'; break;\n      case 'no-preference': reducedMotionWk = 'NoPreference'; break;\n    }\n    promises.push(session.send('Page.setForcedReducedMotion', { reducedMotion: reducedMotionWk }));\n    await Promise.all(promises);\n  }\n\n  async updateExtraHTTPHeaders(): Promise<void> {\n    await this._updateState('Network.setExtraHTTPHeaders', { headers: headersArrayToObject(this._calculateExtraHTTPHeaders(), false /* lowerCase */) });\n  }\n\n  _calculateExtraHTTPHeaders(): types.HeadersArray {\n    const locale = this._browserContext._options.locale;\n    const headers = network.mergeHeaders([\n      this._browserContext._options.extraHTTPHeaders,\n      this._page._state.extraHTTPHeaders,\n      locale ? network.singleHeader('Accept-Language', locale) : undefined,\n    ]);\n    return headers;\n  }\n\n  async updateEmulateMedia(): Promise<void> {\n    const colorScheme = this._page._state.colorScheme;\n    const reducedMotion = this._page._state.reducedMotion;\n    await this._forAllSessions(session => WKPage._setEmulateMedia(session, this._page._state.mediaType, colorScheme, reducedMotion));\n  }\n\n  async setEmulatedSize(emulatedSize: types.EmulatedSize): Promise<void> {\n    assert(this._page._state.emulatedSize === emulatedSize);\n    await this._updateViewport();\n  }\n\n  async bringToFront(): Promise<void> {\n    this._pageProxySession.send('Target.activate', {\n      targetId: this._session.sessionId\n    });\n  }\n\n  async _updateViewport(): Promise<void> {\n    const options = this._browserContext._options;\n    const deviceSize = this._page._state.emulatedSize;\n    if (deviceSize === null)\n      return;\n    const viewportSize = deviceSize.viewport;\n    const screenSize = deviceSize.screen;\n    const promises: Promise<any>[] = [\n      this._pageProxySession.send('Emulation.setDeviceMetricsOverride', {\n        width: viewportSize.width,\n        height: viewportSize.height,\n        fixedLayout: !!options.isMobile,\n        deviceScaleFactor: options.deviceScaleFactor || 1\n      }),\n      this._session.send('Page.setScreenSizeOverride', {\n        width: screenSize.width,\n        height: screenSize.height,\n      }),\n    ];\n    if (options.isMobile) {\n      const angle = viewportSize.width > viewportSize.height ? 90 : 0;\n      promises.push(this._session.send('Page.setOrientationOverride', { angle }));\n    }\n    await Promise.all(promises);\n  }\n\n  async _ensureResponseInterceptionEnabled() {\n    if (this._needsResponseInterception)\n      return;\n    this._needsResponseInterception = true;\n    await this.updateRequestInterception();\n  }\n\n  async updateRequestInterception(): Promise<void> {\n    const enabled = this._page._needsRequestInterception();\n    const promises = [\n      this._updateState('Network.setInterceptionEnabled', { enabled }),\n      this._updateState('Network.addInterception', { url: '.*', stage: 'request', isRegex: true }),\n    ];\n    if (this._needsResponseInterception)\n      this._updateState('Network.addInterception', { url: '.*', stage: 'response', isRegex: true });\n    await Promise.all(promises);\n  }\n\n  async updateOffline() {\n    await this._updateState('Network.setEmulateOfflineState', { offline: !!this._browserContext._options.offline });\n  }\n\n  async updateHttpCredentials() {\n    const credentials = this._browserContext._options.httpCredentials || { username: '', password: '' };\n    await this._pageProxySession.send('Emulation.setAuthCredentials', { username: credentials.username, password: credentials.password });\n  }\n\n  async setFileChooserIntercepted(enabled: boolean) {\n    await this._session.send('Page.setInterceptFileChooserDialog', { enabled }).catch(e => {}); // target can be closed.\n  }\n\n  async reload(): Promise<void> {\n    await this._session.send('Page.reload');\n  }\n\n  goBack(): Promise<boolean> {\n    return this._session.send('Page.goBack').then(() => true).catch(error => {\n      if (error instanceof Error && error.message.includes(`Protocol error (Page.goBack): Failed to go`))\n        return false;\n      throw error;\n    });\n  }\n\n  goForward(): Promise<boolean> {\n    return this._session.send('Page.goForward').then(() => true).catch(error => {\n      if (error instanceof Error && error.message.includes(`Protocol error (Page.goForward): Failed to go`))\n        return false;\n      throw error;\n    });\n  }\n\n  async exposeBinding(binding: PageBinding): Promise<void> {\n    await this._updateBootstrapScript(binding.world);\n    await this._evaluateBindingScript(binding);\n  }\n\n  private async _evaluateBindingScript(binding: PageBinding): Promise<void> {\n    const script = this._bindingToScript(binding);\n    await Promise.all(this._page.frames().map(frame => frame.evaluateExpression(script, false, {}, binding.world).catch(e => {})));\n  }\n\n  async evaluateOnNewDocument(script: string): Promise<void> {\n    await this._updateBootstrapScript('main');\n  }\n\n  private _bindingToScript(binding: PageBinding): string {\n    return `self.${binding.name} = (param) => console.debug('${BINDING_CALL_MESSAGE}', {}, param); ${binding.source}`;\n  }\n\n  private _calculateBootstrapScript(world: types.World): string {\n    const scripts: string[] = [];\n    for (const binding of this._page.allBindings()) {\n      if (binding.world === world)\n        scripts.push(this._bindingToScript(binding));\n    }\n    if (world === 'main') {\n      scripts.push(...this._browserContext._evaluateOnNewDocumentSources);\n      scripts.push(...this._page._evaluateOnNewDocumentSources);\n    }\n    return scripts.join(';');\n  }\n\n  async _updateBootstrapScript(world: types.World): Promise<void> {\n    await this._updateState('Page.setBootstrapScript', { source: this._calculateBootstrapScript(world), worldName: webkitWorldName(world) });\n  }\n\n  async closePage(runBeforeUnload: boolean): Promise<void> {\n    await this._stopVideo();\n    await this._pageProxySession.sendMayFail('Target.close', {\n      targetId: this._session.sessionId,\n      runBeforeUnload\n    });\n  }\n\n  canScreenshotOutsideViewport(): boolean {\n    return true;\n  }\n\n  async setBackgroundColor(color?: { r: number; g: number; b: number; a: number; }): Promise<void> {\n    await this._session.send('Page.setDefaultBackgroundColorOverride', { color });\n  }\n\n  private _toolbarHeight(): number {\n    if (this._page._browserContext._browser?.options.headful)\n      return hostPlatform === 'mac10.15' ? 55 : 59;\n    return 0;\n  }\n\n  private async _startVideo(options: types.PageScreencastOptions): Promise<void> {\n    assert(!this._recordingVideoFile);\n    const { screencastId } = await this._pageProxySession.send('Screencast.startVideo', {\n      file: options.outputFile,\n      width: options.width,\n      height: options.height,\n      toolbarHeight: this._toolbarHeight()\n    });\n    this._recordingVideoFile = options.outputFile;\n    this._browserContext._browser._videoStarted(this._browserContext, screencastId, options.outputFile, this.pageOrError());\n  }\n\n  private async _stopVideo(): Promise<void> {\n    if (!this._recordingVideoFile)\n      return;\n    await this._pageProxySession.sendMayFail('Screencast.stopVideo');\n    this._recordingVideoFile = null;\n  }\n\n  async takeScreenshot(progress: Progress, format: string, documentRect: types.Rect | undefined, viewportRect: types.Rect | undefined, quality: number | undefined): Promise<Buffer> {\n    const rect = (documentRect || viewportRect)!;\n    const result = await this._session.send('Page.snapshotRect', { ...rect, coordinateSystem: documentRect ? 'Page' : 'Viewport' });\n    const prefix = 'data:image/png;base64,';\n    let buffer = Buffer.from(result.dataURL.substr(prefix.length), 'base64');\n    if (format === 'jpeg')\n      buffer = jpeg.encode(png.PNG.sync.read(buffer), quality).data;\n    return buffer;\n  }\n\n  async resetViewport(): Promise<void> {\n    assert(false, 'Should not be called');\n  }\n\n  async getContentFrame(handle: dom.ElementHandle): Promise<frames.Frame | null> {\n    const nodeInfo = await this._session.send('DOM.describeNode', {\n      objectId: handle._objectId\n    });\n    if (!nodeInfo.contentFrameId)\n      return null;\n    return this._page._frameManager.frame(nodeInfo.contentFrameId);\n  }\n\n  async getOwnerFrame(handle: dom.ElementHandle): Promise<string | null> {\n    if (!handle._objectId)\n      return null;\n    const nodeInfo = await this._session.send('DOM.describeNode', {\n      objectId: handle._objectId\n    });\n    return nodeInfo.ownerFrameId || null;\n  }\n\n  isElementHandle(remoteObject: any): boolean {\n    return (remoteObject as Protocol.Runtime.RemoteObject).subtype === 'node';\n  }\n\n  async getBoundingBox(handle: dom.ElementHandle): Promise<types.Rect | null> {\n    const quads = await this.getContentQuads(handle);\n    if (!quads || !quads.length)\n      return null;\n    let minX = Infinity;\n    let maxX = -Infinity;\n    let minY = Infinity;\n    let maxY = -Infinity;\n    for (const quad of quads) {\n      for (const point of quad) {\n        minX = Math.min(minX, point.x);\n        maxX = Math.max(maxX, point.x);\n        minY = Math.min(minY, point.y);\n        maxY = Math.max(maxY, point.y);\n      }\n    }\n    return { x: minX, y: minY, width: maxX - minX, height: maxY - minY };\n  }\n\n  async scrollRectIntoViewIfNeeded(handle: dom.ElementHandle, rect?: types.Rect): Promise<'error:notvisible' | 'error:notconnected' | 'done'> {\n    return await this._session.send('DOM.scrollIntoViewIfNeeded', {\n      objectId: handle._objectId,\n      rect,\n    }).then(() => 'done' as const).catch(e => {\n      if (e instanceof Error && e.message.includes('Node does not have a layout object'))\n        return 'error:notvisible';\n      if (e instanceof Error && e.message.includes('Node is detached from document'))\n        return 'error:notconnected';\n      throw e;\n    });\n  }\n\n  async setScreencastOptions(options: { width: number, height: number, quality: number } | null): Promise<void> {\n    if (options) {\n      const so = { ...options, toolbarHeight: this._toolbarHeight() };\n      const { generation } = await this._pageProxySession.send('Screencast.startScreencast', so);\n      this._screencastGeneration = generation;\n    } else {\n      await this._pageProxySession.send('Screencast.stopScreencast');\n    }\n  }\n\n  private _onScreencastFrame(event: Protocol.Screencast.screencastFramePayload) {\n    this._pageProxySession.send('Screencast.screencastFrameAck', { generation: this._screencastGeneration }).catch(e => debugLogger.log('error', e));\n    const buffer = Buffer.from(event.data, 'base64');\n    this._page.emit(Page.Events.ScreencastFrame, {\n      buffer,\n      width: event.deviceWidth,\n      height: event.deviceHeight,\n    });\n  }\n\n  rafCountForStablePosition(): number {\n    return process.platform === 'win32' ? 5 : 1;\n  }\n\n  async getContentQuads(handle: dom.ElementHandle): Promise<types.Quad[] | null> {\n    const result = await this._session.sendMayFail('DOM.getContentQuads', {\n      objectId: handle._objectId\n    });\n    if (!result)\n      return null;\n    return result.quads.map(quad => [\n      { x: quad[0], y: quad[1] },\n      { x: quad[2], y: quad[3] },\n      { x: quad[4], y: quad[5] },\n      { x: quad[6], y: quad[7] }\n    ]);\n  }\n\n  async setInputFiles(handle: dom.ElementHandle<HTMLInputElement>, files: types.FilePayload[]): Promise<void> {\n    const objectId = handle._objectId;\n    const protocolFiles = files.map(file => ({\n      name: file.name,\n      type: file.mimeType,\n      data: file.buffer,\n    }));\n    await this._session.send('DOM.setInputFiles', { objectId, files: protocolFiles });\n  }\n\n  async adoptElementHandle<T extends Node>(handle: dom.ElementHandle<T>, to: dom.FrameExecutionContext): Promise<dom.ElementHandle<T>> {\n    const result = await this._session.sendMayFail('DOM.resolveNode', {\n      objectId: handle._objectId,\n      executionContextId: (to._delegate as WKExecutionContext)._contextId\n    });\n    if (!result || result.object.subtype === 'null')\n      throw new Error(dom.kUnableToAdoptErrorMessage);\n    return to.createHandle(result.object) as dom.ElementHandle<T>;\n  }\n\n  async getAccessibilityTree(needle?: dom.ElementHandle): Promise<{tree: accessibility.AXNode, needle: accessibility.AXNode | null}> {\n    return getAccessibilityTree(this._session, needle);\n  }\n\n  async inputActionEpilogue(): Promise<void> {\n  }\n\n  async getFrameElement(frame: frames.Frame): Promise<dom.ElementHandle> {\n    const parent = frame.parentFrame();\n    if (!parent)\n      throw new Error('Frame has been detached.');\n    const handles = await this._page.selectors._queryAll(parent, 'frame,iframe', undefined);\n    const items = await Promise.all(handles.map(async handle => {\n      const frame = await handle.contentFrame().catch(e => null);\n      return { handle, frame };\n    }));\n    const result = items.find(item => item.frame === frame);\n    items.map(item => item === result ? Promise.resolve() : item.handle.dispose());\n    if (!result)\n      throw new Error('Frame has been detached.');\n    return result.handle;\n  }\n\n  _onRequestWillBeSent(session: WKSession, event: Protocol.Network.requestWillBeSentPayload) {\n    if (event.request.url.startsWith('data:'))\n      return;\n    let redirectedFrom: WKInterceptableRequest | null = null;\n    if (event.redirectResponse) {\n      const request = this._requestIdToRequest.get(event.requestId);\n      // If we connect late to the target, we could have missed the requestWillBeSent event.\n      if (request) {\n        this._handleRequestRedirect(request, event.redirectResponse, event.timestamp);\n        redirectedFrom = request;\n      }\n    }\n    const frame = redirectedFrom ? redirectedFrom.request.frame() : this._page._frameManager.frame(event.frameId);\n    // sometimes we get stray network events for detached frames\n    // TODO(einbinder) why?\n    if (!frame)\n      return;\n\n    // TODO(einbinder) this will fail if we are an XHR document request\n    const isNavigationRequest = event.type === 'Document';\n    const documentId = isNavigationRequest ? event.loaderId : undefined;\n    let route = null;\n    // We do not support intercepting redirects.\n    if (this._page._needsRequestInterception() && !redirectedFrom)\n      route = new WKRouteImpl(session, this, event.requestId);\n    const request = new WKInterceptableRequest(session, route, frame, event, redirectedFrom, documentId);\n    this._requestIdToRequest.set(event.requestId, request);\n    this._page._frameManager.requestStarted(request.request, route || undefined);\n  }\n\n  private _handleRequestRedirect(request: WKInterceptableRequest, responsePayload: Protocol.Network.Response, timestamp: number) {\n    const response = request.createResponse(responsePayload);\n    response._securityDetailsFinished();\n    response._serverAddrFinished();\n    response._requestFinished(responsePayload.timing ? helper.secondsToRoundishMillis(timestamp - request._timestamp) : -1, 'Response body is unavailable for redirect responses');\n    this._requestIdToRequest.delete(request._requestId);\n    this._page._frameManager.requestReceivedResponse(response);\n    this._page._frameManager.requestFinished(request.request);\n  }\n\n  _onRequestIntercepted(session: WKSession, event: Protocol.Network.requestInterceptedPayload) {\n    const request = this._requestIdToRequest.get(event.requestId);\n    if (!request) {\n      session.sendMayFail('Network.interceptRequestWithError', {errorType: 'Cancellation', requestId: event.requestId});\n      return;\n    }\n    if (!request._route) {\n      // Intercepted, although we do not intend to allow interception.\n      // Just continue.\n      session.sendMayFail('Network.interceptWithRequest', { requestId: request._requestId });\n    } else {\n      request._route._requestInterceptedCallback();\n    }\n  }\n\n  _onResponseIntercepted(session: WKSession, event: Protocol.Network.responseInterceptedPayload) {\n    const request = this._requestIdToRequest.get(event.requestId);\n    const route = request?._routeForRedirectChain();\n    if (!route?._responseInterceptedCallback) {\n      session.sendMayFail('Network.interceptContinue', { requestId: event.requestId, stage: 'response' });\n      return;\n    }\n    route._responseInterceptedCallback({ response: event.response });\n  }\n\n  _onResponseReceived(event: Protocol.Network.responseReceivedPayload) {\n    const request = this._requestIdToRequest.get(event.requestId);\n    // FileUpload sends a response without a matching request.\n    if (!request)\n      return;\n    this._requestIdToResponseReceivedPayloadEvent.set(request._requestId, event);\n    const response = request.createResponse(event.response);\n    if (event.response.requestHeaders && Object.keys(event.response.requestHeaders).length)\n      request.request.updateWithRawHeaders(headersObjectToArray(event.response.requestHeaders));\n    this._page._frameManager.requestReceivedResponse(response);\n\n    if (response.status() === 204) {\n      this._onLoadingFailed({\n        requestId: event.requestId,\n        errorText: 'Aborted: 204 No Content',\n        timestamp: event.timestamp\n      });\n    }\n  }\n\n  _onLoadingFinished(event: Protocol.Network.loadingFinishedPayload) {\n    const request = this._requestIdToRequest.get(event.requestId);\n    // For certain requestIds we never receive requestWillBeSent event.\n    // @see https://crbug.com/750469\n    if (!request)\n      return;\n\n    // Under certain conditions we never get the Network.responseReceived\n    // event from protocol. @see https://crbug.com/883475\n    const response = request.request._existingResponse();\n    if (response) {\n      const responseReceivedPayload = this._requestIdToResponseReceivedPayloadEvent.get(request._requestId);\n      response._serverAddrFinished(parseRemoteAddress(event?.metrics?.remoteAddress));\n      response._securityDetailsFinished({\n        protocol: isLoadedSecurely(response.url(), response.timing()) ? event.metrics?.securityConnection?.protocol : undefined,\n        subjectName: responseReceivedPayload?.response.security?.certificate?.subject,\n        validFrom: responseReceivedPayload?.response.security?.certificate?.validFrom,\n        validTo: responseReceivedPayload?.response.security?.certificate?.validUntil,\n      });\n      const { responseBodyBytesReceived, responseHeaderBytesReceived } = event.metrics || {};\n      const transferSize = responseBodyBytesReceived ? responseBodyBytesReceived + (responseHeaderBytesReceived || 0) : undefined;\n      if (event.metrics?.protocol)\n        response._setHttpVersion(event.metrics.protocol);\n      response._requestFinished(helper.secondsToRoundishMillis(event.timestamp - request._timestamp), undefined, transferSize);\n    }\n\n    this._requestIdToResponseReceivedPayloadEvent.delete(request._requestId);\n    this._requestIdToRequest.delete(request._requestId);\n    this._page._frameManager.requestFinished(request.request);\n  }\n\n  _onLoadingFailed(event: Protocol.Network.loadingFailedPayload) {\n    const request = this._requestIdToRequest.get(event.requestId);\n    // For certain requestIds we never receive requestWillBeSent event.\n    // @see https://crbug.com/750469\n    if (!request)\n      return;\n    const route = request._routeForRedirectChain();\n    if (route?._responseInterceptedCallback)\n      route._responseInterceptedCallback({ error: event });\n    const response = request.request._existingResponse();\n    if (response) {\n      response._serverAddrFinished();\n      response._securityDetailsFinished();\n      response._requestFinished(helper.secondsToRoundishMillis(event.timestamp - request._timestamp));\n    }\n    this._requestIdToRequest.delete(request._requestId);\n    request.request._setFailureText(event.errorText);\n    this._page._frameManager.requestFailed(request.request, event.errorText.includes('cancelled'));\n  }\n\n  async _grantPermissions(origin: string, permissions: string[]) {\n    const webPermissionToProtocol = new Map<string, string>([\n      ['geolocation', 'geolocation'],\n    ]);\n    const filtered = permissions.map(permission => {\n      const protocolPermission = webPermissionToProtocol.get(permission);\n      if (!protocolPermission)\n        throw new Error('Unknown permission: ' + permission);\n      return protocolPermission;\n    });\n    await this._pageProxySession.send('Emulation.grantPermissions', { origin, permissions: filtered });\n  }\n\n  async _clearPermissions() {\n    await this._pageProxySession.send('Emulation.resetPermissions', {});\n  }\n}\n\nfunction webkitWorldName(world: types.World) {\n  switch (world) {\n    case 'main': return undefined;\n    case 'utility': return UTILITY_WORLD_NAME;\n  }\n}\n\n/**\n * WebKit Remote Addresses look like:\n *\n * macOS:\n * ::1.8911\n * 2606:2800:220:1:248:1893:25c8:1946.443\n * 127.0.0.1:8000\n *\n * ubuntu:\n * ::1:8907\n * 127.0.0.1:8000\n *\n * NB: They look IPv4 and IPv6's with ports but use an alternative notation.\n */\nfunction parseRemoteAddress(value?: string) {\n  if (!value)\n    return;\n\n  try {\n    const colon = value.lastIndexOf(':');\n    const dot = value.lastIndexOf('.');\n    if (dot < 0) { // IPv6ish:port\n      return {\n        ipAddress: `[${value.slice(0, colon)}]`,\n        port: +value.slice(colon + 1)\n      };\n    }\n\n    if (colon > dot) { // IPv4:port\n      const [address, port] = value.split(':');\n      return {\n        ipAddress: address,\n        port: +port,\n      };\n    } else { // IPv6ish.port\n      const [address, port] = value.split('.');\n      return {\n        ipAddress: `[${address}]`,\n        port: +port,\n      };\n    }\n  } catch (_) {}\n}\n\n\n/**\n * Adapted from Source/WebInspectorUI/UserInterface/Models/Resource.js in\n * WebKit codebase.\n */\nfunction isLoadedSecurely(url: string, timing: network.ResourceTiming) {\n  try {\n    const u = new URL(url);\n    if (u.protocol !== 'https:' && u.protocol !== 'wss:' && u.protocol !== 'sftp:')\n      return false;\n    if (timing.secureConnectionStart === -1 && timing.connectStart !== -1)\n      return false;\n    return true;\n  } catch (_) {}\n}\n"],"file":"wkPage.js"}