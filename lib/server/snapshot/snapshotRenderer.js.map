{"version":3,"sources":["../../../src/server/snapshot/snapshotRenderer.ts"],"names":["SnapshotRenderer","constructor","resources","snapshots","index","_snapshots","_index","snapshotName","_resources","_snapshot","snapshot","viewport","render","visit","n","snapshotIndex","escapeText","_string","Array","isArray","referenceIndex","nodes","snapshotNodes","nodeIndex","length","builder","push","attr","value","Object","entries","escapeAttribute","i","autoClosing","has","join","html","pageId","frameId","doctype","snapshotScript","resourceByUrl","url","result","resource","timestamp","o","resourceOverrides","sha1","responseSha1","Set","escaped","s","replace","char","_nodes","applyPlaywrightAttributes","shadowAttribute","scrollTopAttribute","scrollLeftAttribute","styleSheetAttribute","scrollTops","scrollLefts","root","e","querySelectorAll","iframe","src","getAttribute","setAttribute","window","location","origin","search","element","template","shadowRoot","parentElement","attachShadow","mode","appendChild","content","remove","adoptedSheets","adoptedStyleSheets","sheet","CSSStyleSheet","replaceSync","document","onLoad","removeEventListener","scrollTop","removeAttribute","scrollLeft","addEventListener","kShadowAttribute","kScrollTopAttribute","kScrollLeftAttribute","kStyleSheetAttribute","toString"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FrameSnapshot, NodeSnapshot, RenderedFrameSnapshot, ResourceSnapshot } from './snapshotTypes';\n\nexport class SnapshotRenderer {\n  private _snapshots: FrameSnapshot[];\n  private _index: number;\n  readonly snapshotName: string | undefined;\n  private _resources: ResourceSnapshot[];\n  private _snapshot: FrameSnapshot;\n\n  constructor(resources: ResourceSnapshot[], snapshots: FrameSnapshot[], index: number) {\n    this._resources = resources;\n    this._snapshots = snapshots;\n    this._index = index;\n    this._snapshot = snapshots[index];\n    this.snapshotName = snapshots[index].snapshotName;\n  }\n\n  snapshot(): FrameSnapshot {\n    return this._snapshots[this._index];\n  }\n\n  viewport(): { width: number, height: number } {\n    return this._snapshots[this._index].viewport;\n  }\n\n  render(): RenderedFrameSnapshot {\n    const visit = (n: NodeSnapshot, snapshotIndex: number): string => {\n      // Text node.\n      if (typeof n === 'string')\n        return escapeText(n);\n\n      if (!(n as any)._string) {\n        if (Array.isArray(n[0])) {\n          // Node reference.\n          const referenceIndex = snapshotIndex - n[0][0];\n          if (referenceIndex >= 0 && referenceIndex < snapshotIndex) {\n            const nodes = snapshotNodes(this._snapshots[referenceIndex]);\n            const nodeIndex = n[0][1];\n            if (nodeIndex >= 0 && nodeIndex < nodes.length)\n              (n as any)._string = visit(nodes[nodeIndex], referenceIndex);\n          }\n        } else if (typeof n[0] === 'string') {\n          // Element node.\n          const builder: string[] = [];\n          builder.push('<', n[0]);\n          for (const [attr, value] of Object.entries(n[1] || {}))\n            builder.push(' ', attr, '=\"', escapeAttribute(value as string), '\"');\n          builder.push('>');\n          for (let i = 2; i < n.length; i++)\n            builder.push(visit(n[i], snapshotIndex));\n          if (!autoClosing.has(n[0]))\n            builder.push('</', n[0], '>');\n          (n as any)._string = builder.join('');\n        } else {\n          // Why are we here? Let's not throw, just in case.\n          (n as any)._string = '';\n        }\n      }\n      return (n as any)._string;\n    };\n\n    const snapshot = this._snapshot;\n    let html = visit(snapshot.html, this._index);\n    if (!html)\n      return { html: '', pageId: snapshot.pageId, frameId: snapshot.frameId, index: this._index };\n\n    if (snapshot.doctype)\n      html = `<!DOCTYPE ${snapshot.doctype}>` + html;\n    html += `\n      <style>*[__playwright_target__=\"${this.snapshotName}\"] { background-color: #6fa8dc7f; }</style>\n      <script>${snapshotScript()}</script>\n    `;\n\n    return { html, pageId: snapshot.pageId, frameId: snapshot.frameId, index: this._index };\n  }\n\n  resourceByUrl(url: string): ResourceSnapshot | undefined {\n    const snapshot = this._snapshot;\n    let result: ResourceSnapshot | undefined;\n\n    // First try locating exact resource belonging to this frame.\n    for (const resource of this._resources) {\n      if (resource.timestamp >= snapshot.timestamp)\n        break;\n      if (resource.frameId !== snapshot.frameId)\n        continue;\n      if (resource.url === url) {\n        result = resource;\n        break;\n      }\n    }\n\n    if (!result) {\n      // Then fall back to resource with this URL to account for memory cache.\n      for (const resource of this._resources) {\n        if (resource.timestamp >= snapshot.timestamp)\n          break;\n        if (resource.url === url)\n          return resource;\n      }\n    }\n\n    if (result) {\n      // Patch override if necessary.\n      for (const o of snapshot.resourceOverrides) {\n        if (url === o.url && o.sha1) {\n          result = { ...result, responseSha1: o.sha1 };\n          break;\n        }\n      }\n    }\n\n    return result;\n  }\n}\n\nconst autoClosing = new Set(['AREA', 'BASE', 'BR', 'COL', 'COMMAND', 'EMBED', 'HR', 'IMG', 'INPUT', 'KEYGEN', 'LINK', 'MENUITEM', 'META', 'PARAM', 'SOURCE', 'TRACK', 'WBR']);\nconst escaped = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '\"': '&quot;', '\\'': '&#39;' };\n\nfunction escapeAttribute(s: string): string {\n  return s.replace(/[&<>\"']/ug, char => (escaped as any)[char]);\n}\nfunction escapeText(s: string): string {\n  return s.replace(/[&<]/ug, char => (escaped as any)[char]);\n}\n\nfunction snapshotNodes(snapshot: FrameSnapshot): NodeSnapshot[] {\n  if (!(snapshot as any)._nodes) {\n    const nodes: NodeSnapshot[] = [];\n    const visit = (n: NodeSnapshot) => {\n      if (typeof n === 'string') {\n        nodes.push(n);\n      } else if (typeof n[0] === 'string') {\n        for (let i = 2; i < n.length; i++)\n          visit(n[i]);\n        nodes.push(n);\n      }\n    };\n    visit(snapshot.html);\n    (snapshot as any)._nodes = nodes;\n  }\n  return (snapshot as any)._nodes;\n}\n\nfunction snapshotScript() {\n  function applyPlaywrightAttributes(shadowAttribute: string, scrollTopAttribute: string, scrollLeftAttribute: string, styleSheetAttribute: string) {\n    const scrollTops: Element[] = [];\n    const scrollLefts: Element[] = [];\n\n    const visit = (root: Document | ShadowRoot) => {\n      // Collect all scrolled elements for later use.\n      for (const e of root.querySelectorAll(`[${scrollTopAttribute}]`))\n        scrollTops.push(e);\n      for (const e of root.querySelectorAll(`[${scrollLeftAttribute}]`))\n        scrollLefts.push(e);\n\n      for (const iframe of root.querySelectorAll('iframe')) {\n        const src = iframe.getAttribute('src');\n        if (!src) {\n          iframe.setAttribute('src', 'data:text/html,<body style=\"background: #ddd\"></body>');\n        } else {\n          // Append query parameters to inherit ?name= or ?time= values from parent.\n          iframe.setAttribute('src', window.location.origin + src + window.location.search);\n        }\n      }\n\n      for (const element of root.querySelectorAll(`template[${shadowAttribute}]`)) {\n        const template = element as HTMLTemplateElement;\n        const shadowRoot = template.parentElement!.attachShadow({ mode: 'open' });\n        shadowRoot.appendChild(template.content);\n        template.remove();\n        visit(shadowRoot);\n      }\n\n      if ('adoptedStyleSheets' in (root as any)) {\n        const adoptedSheets: CSSStyleSheet[] = [...(root as any).adoptedStyleSheets];\n        for (const element of root.querySelectorAll(`template[${styleSheetAttribute}]`)) {\n          const template = element as HTMLTemplateElement;\n          const sheet = new CSSStyleSheet();\n          (sheet as any).replaceSync(template.getAttribute(styleSheetAttribute));\n          adoptedSheets.push(sheet);\n        }\n        (root as any).adoptedStyleSheets = adoptedSheets;\n      }\n    };\n    visit(document);\n\n    const onLoad = () => {\n      window.removeEventListener('load', onLoad);\n      for (const element of scrollTops) {\n        element.scrollTop = +element.getAttribute(scrollTopAttribute)!;\n        element.removeAttribute(scrollTopAttribute);\n      }\n      for (const element of scrollLefts) {\n        element.scrollLeft = +element.getAttribute(scrollLeftAttribute)!;\n        element.removeAttribute(scrollLeftAttribute);\n      }\n    };\n    window.addEventListener('load', onLoad);\n  }\n\n  const kShadowAttribute = '__playwright_shadow_root_';\n  const kScrollTopAttribute = '__playwright_scroll_top_';\n  const kScrollLeftAttribute = '__playwright_scroll_left_';\n  const kStyleSheetAttribute = '__playwright_style_sheet_';\n  return `\\n(${applyPlaywrightAttributes.toString()})('${kShadowAttribute}', '${kScrollTopAttribute}', '${kScrollLeftAttribute}', '${kStyleSheetAttribute}')`;\n}\n"],"file":"snapshotRenderer.js"}