{"version":3,"sources":["../../../src/server/snapshot/snapshotServer.ts"],"names":["SnapshotServer","constructor","server","snapshotStorage","_snapshotStorage","routePrefix","_serveSnapshot","bind","_serveSnapshotSize","_serveResource","_serveSnapshotRoot","request","response","statusCode","setHeader","end","rootScript","_serveServiceWorker","serviceWorkerMain","self","snapshotIds","Map","addEventListener","event","waitUntil","clients","claim","respondNotAvailable","Response","status","headers","removeHash","url","u","URL","hash","toString","e","doFetch","pathname","fetch","snapshotUrl","mode","get","clientId","htmlResponse","html","frameId","index","json","set","complexUrl","btoa","JSON","stringify","fetchUrl","fetchedResponse","Headers","body","statusText","respondWith","endsWith","snapshot","_snapshot","substring","length","_respondWithJson","render","viewport","uri","pageOrFrameId","query","split","parsed","querystring","parse","snapshotByName","name","object","Buffer","from","snapshotByIndex","resource","resourceByUrl","sha1","responseSha1","content","resourceContent","contentType","isTextEncoding","test","includes","value","responseHeaders","removeHeader","byteLength","navigator","serviceWorker","register","showPromise","Promise","resolve","controller","oncontrollerchange","pointElement","document","createElement","style","position","backgroundColor","width","height","borderRadius","margin","zIndex","iframe","appendChild","window","showSnapshot","options","src","point","left","x","top","y","documentElement","remove","location","href","data"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as http from 'http';\nimport querystring from 'querystring';\nimport { HttpServer } from '../../utils/httpServer';\nimport type { RenderedFrameSnapshot } from './snapshotTypes';\nimport { SnapshotStorage } from './snapshotStorage';\nimport type { Point } from '../../common/types';\n\nexport class SnapshotServer {\n  private _snapshotStorage: SnapshotStorage;\n\n  constructor(server: HttpServer, snapshotStorage: SnapshotStorage) {\n    this._snapshotStorage = snapshotStorage;\n\n    server.routePrefix('/snapshot/', this._serveSnapshot.bind(this));\n    server.routePrefix('/snapshotSize/', this._serveSnapshotSize.bind(this));\n    server.routePrefix('/resources/', this._serveResource.bind(this));\n  }\n\n  private _serveSnapshotRoot(request: http.IncomingMessage, response: http.ServerResponse): boolean {\n    response.statusCode = 200;\n    response.setHeader('Cache-Control', 'public, max-age=31536000');\n    response.setHeader('Content-Type', 'text/html');\n    response.end(`\n      <style>\n        html, body {\n          margin: 0;\n          padding: 0;\n        }\n        iframe {\n          position: absolute;\n          top: 0;\n          left: 0;\n          width: 100%;\n          height: 100%;\n          border: none;\n        }\n      </style>\n      <body>\n        <script>\n        (${rootScript})();\n        </script>\n      </body>\n    `);\n    return true;\n  }\n\n  private _serveServiceWorker(request: http.IncomingMessage, response: http.ServerResponse): boolean {\n    function serviceWorkerMain(self: any /* ServiceWorkerGlobalScope */) {\n      const snapshotIds = new Map<string, { frameId: string, index: number }>();\n\n      self.addEventListener('install', function(event: any) {\n      });\n\n      self.addEventListener('activate', function(event: any) {\n        event.waitUntil(self.clients.claim());\n      });\n\n      function respondNotAvailable(): Response {\n        return new Response('<body style=\"background: #ddd\"></body>', { status: 200, headers: { 'Content-Type': 'text/html' } });\n      }\n\n      function removeHash(url: string) {\n        try {\n          const u = new URL(url);\n          u.hash = '';\n          return u.toString();\n        } catch (e) {\n          return url;\n        }\n      }\n\n      async function doFetch(event: any /* FetchEvent */): Promise<Response> {\n        const request = event.request;\n        const pathname = new URL(request.url).pathname;\n        if (pathname === '/snapshot/service-worker.js' || pathname === '/snapshot/')\n          return fetch(event.request);\n\n        const snapshotUrl = request.mode === 'navigate' ?\n          request.url : (await self.clients.get(event.clientId))!.url;\n\n        if (request.mode === 'navigate') {\n          const htmlResponse = await fetch(event.request);\n          const { html, frameId, index }: RenderedFrameSnapshot  = await htmlResponse.json();\n          if (!html)\n            return respondNotAvailable();\n          snapshotIds.set(snapshotUrl, { frameId, index });\n          const response = new Response(html, { status: 200, headers: { 'Content-Type': 'text/html' } });\n          return response;\n        }\n\n        const { frameId, index } = snapshotIds.get(snapshotUrl)!;\n        const url = removeHash(request.url);\n        const complexUrl = btoa(JSON.stringify({ frameId, index, url }));\n        const fetchUrl = `/resources/${complexUrl}`;\n        const fetchedResponse = await fetch(fetchUrl);\n        // We make a copy of the response, instead of just forwarding,\n        // so that response url is not inherited as \"/resources/...\", but instead\n        // as the original request url.\n\n        // Response url turns into resource base uri that is used to resolve\n        // relative links, e.g. url(/foo/bar) in style sheets.\n        const headers = new Headers(fetchedResponse.headers);\n        const response = new Response(fetchedResponse.body, {\n          status: fetchedResponse.status,\n          statusText: fetchedResponse.statusText,\n          headers,\n        });\n        return response;\n      }\n\n      self.addEventListener('fetch', function(event: any) {\n        event.respondWith(doFetch(event));\n      });\n    }\n\n    response.statusCode = 200;\n    response.setHeader('Cache-Control', 'public, max-age=31536000');\n    response.setHeader('Content-Type', 'application/javascript');\n    response.end(`(${serviceWorkerMain.toString()})(self)`);\n    return true;\n  }\n\n  private _serveSnapshot(request: http.IncomingMessage, response: http.ServerResponse): boolean {\n    if (request.url!.endsWith('/snapshot/'))\n      return this._serveSnapshotRoot(request, response);\n    if (request.url!.endsWith('/snapshot/service-worker.js'))\n      return this._serveServiceWorker(request, response);\n    const snapshot = this._snapshot(request.url!.substring('/snapshot/'.length));\n    this._respondWithJson(response, snapshot ? snapshot.render() : { html: '' });\n    return true;\n  }\n\n  private _serveSnapshotSize(request: http.IncomingMessage, response: http.ServerResponse): boolean {\n    const snapshot = this._snapshot(request.url!.substring('/snapshotSize/'.length));\n    this._respondWithJson(response, snapshot ? snapshot.viewport() : {});\n    return true;\n  }\n\n  private _snapshot(uri: string) {\n    const [ pageOrFrameId, query ] = uri.split('?');\n    const parsed: any = querystring.parse(query);\n    return this._snapshotStorage.snapshotByName(pageOrFrameId, parsed.name);\n  }\n\n  private _respondWithJson(response: http.ServerResponse, object: any) {\n    response.statusCode = 200;\n    response.setHeader('Cache-Control', 'public, max-age=31536000');\n    response.setHeader('Content-Type', 'application/json');\n    response.end(JSON.stringify(object));\n  }\n\n  private _serveResource(request: http.IncomingMessage, response: http.ServerResponse): boolean {\n    const { frameId, index, url } = JSON.parse(Buffer.from(request.url!.substring('/resources/'.length), 'base64').toString());\n    const snapshot = this._snapshotStorage.snapshotByIndex(frameId, index);\n    const resource = snapshot?.resourceByUrl(url);\n    if (!resource)\n      return false;\n\n    const sha1 = resource.responseSha1;\n    try {\n      const content = this._snapshotStorage.resourceContent(sha1);\n      if (!content)\n        return false;\n      response.statusCode = 200;\n      let contentType = resource.contentType;\n      const isTextEncoding = /^text\\/|^application\\/(javascript|json)/.test(contentType);\n      if (isTextEncoding && !contentType.includes('charset'))\n        contentType = `${contentType}; charset=utf-8`;\n      response.setHeader('Content-Type', contentType);\n      for (const { name, value } of resource.responseHeaders) {\n        try {\n          response.setHeader(name, value.split('\\n'));\n        } catch (e) {\n          // Browser is able to handle the header, but Node is not.\n          // Swallow the error since we cannot do anything meaningful.\n        }\n      }\n\n      response.removeHeader('Content-Encoding');\n      response.removeHeader('Access-Control-Allow-Origin');\n      response.setHeader('Access-Control-Allow-Origin', '*');\n      response.removeHeader('Content-Length');\n      response.setHeader('Content-Length', content.byteLength);\n      response.setHeader('Cache-Control', 'public, max-age=31536000');\n      response.end(content);\n      return true;\n    } catch (e) {\n      return false;\n    }\n  }\n}\n\ndeclare global {\n  interface Window {\n    showSnapshot: (url: string, point?: Point) => Promise<void>;\n  }\n}\nfunction rootScript() {\n  if (!navigator.serviceWorker)\n    return;\n  navigator.serviceWorker.register('./service-worker.js');\n  let showPromise = Promise.resolve();\n  if (!navigator.serviceWorker.controller) {\n    showPromise = new Promise(resolve => {\n      navigator.serviceWorker.oncontrollerchange = () => resolve();\n    });\n  }\n\n  const pointElement = document.createElement('div');\n  pointElement.style.position = 'fixed';\n  pointElement.style.backgroundColor = 'red';\n  pointElement.style.width = '20px';\n  pointElement.style.height = '20px';\n  pointElement.style.borderRadius = '10px';\n  pointElement.style.margin = '-10px 0 0 -10px';\n  pointElement.style.zIndex = '2147483647';\n\n  const iframe = document.createElement('iframe');\n  document.body.appendChild(iframe);\n  (window as any).showSnapshot = async (url: string, options: { point?: Point } = {}) => {\n    await showPromise;\n    iframe.src = url;\n    if (options.point) {\n      pointElement.style.left = options.point.x + 'px';\n      pointElement.style.top = options.point.y + 'px';\n      document.documentElement.appendChild(pointElement);\n    } else {\n      pointElement.remove();\n    }\n  };\n  window.addEventListener('message', event => {\n    window.showSnapshot(window.location.href + event.data.snapshotUrl);\n  }, false);\n}\n"],"file":"snapshotServer.js"}