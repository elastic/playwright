{"version":3,"sources":["../../../src/server/snapshot/snapshotter.ts"],"names":["Snapshotter","constructor","context","delegate","_context","_delegate","_eventListeners","_snapshotStreamer","_initialized","_started","_fetchedResponses","Map","guid","started","start","_initialize","reset","page","pages","response","_frameManager","_responses","_saveResource","catch","e","debugLogger","log","_runInAllFrames","stop","_onPage","eventsHelper","addEventListener","BrowserContext","Events","Page","bind","Response","initScript","frameSnapshotStreamer","_doAddInitScript","expression","frames","push","Promise","all","map","frame","nonStallingRawEvaluateInExistingMainContext","dispose","removeEventListeners","captureSnapshot","snapshotName","element","JSON","stringify","callFunctionNoReply","setAttribute","snapshots","data","snapshot","pageId","frameId","frameUrl","url","doctype","html","viewport","timestamp","collectionTime","resourceOverrides","isMainFrame","mainFrame","content","contentType","buffer","Buffer","from","sha1","mimeToExtension","onBlob","ref","onFrameSnapshot","_annotateFrameHierarchy","FrameAttached","isRedirect","status","request","resourceType","original","redirectedFrom","name","value","headers","toLowerCase","method","requestBody","postDataBuffer","requestSha1","requestHeaders","responseSha1","get","undefined","body","set","resource","_page","type","responseHeaders","onResourceSnapshot","frameElement","parent","parentFrame","_mainContext","evaluate","snapshotStreamer","window","markIframe","kMimeToExtension"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BrowserContext } from '../browserContext';\nimport { Page } from '../page';\nimport * as network from '../network';\nimport { eventsHelper, RegisteredListener } from '../../utils/eventsHelper';\nimport { debugLogger } from '../../utils/debugLogger';\nimport { Frame } from '../frames';\nimport { frameSnapshotStreamer, SnapshotData } from './snapshotterInjected';\nimport { calculateSha1, createGuid, monotonicTime } from '../../utils/utils';\nimport { FrameSnapshot, ResourceSnapshot } from './snapshotTypes';\nimport { ElementHandle } from '../dom';\n\nexport type SnapshotterBlob = {\n  buffer: Buffer,\n  sha1: string,\n};\n\nexport interface SnapshotterDelegate {\n  onBlob(blob: SnapshotterBlob): void;\n  onResourceSnapshot(resource: ResourceSnapshot): void;\n  onFrameSnapshot(snapshot: FrameSnapshot): void;\n}\n\nexport class Snapshotter {\n  private _context: BrowserContext;\n  private _delegate: SnapshotterDelegate;\n  private _eventListeners: RegisteredListener[] = [];\n  private _snapshotStreamer: string;\n  private _initialized = false;\n  private _started = false;\n  private _fetchedResponses = new Map<network.Response, string>();\n\n  constructor(context: BrowserContext, delegate: SnapshotterDelegate) {\n    this._context = context;\n    this._delegate = delegate;\n    const guid = createGuid();\n    this._snapshotStreamer = '__playwright_snapshot_streamer_' + guid;\n  }\n\n  started(): boolean {\n    return this._started;\n  }\n\n  async start() {\n    this._started = true;\n    if (!this._initialized) {\n      this._initialized = true;\n      await this._initialize();\n    }\n    await this.reset();\n\n    // Replay resources loaded in all pages.\n    for (const page of this._context.pages()) {\n      for (const response of page._frameManager._responses)\n        this._saveResource(response).catch(e => debugLogger.log('error', e));\n    }\n  }\n\n  async reset() {\n    if (this._started)\n      await this._runInAllFrames(`window[\"${this._snapshotStreamer}\"].reset()`);\n  }\n\n  async stop() {\n    this._started = false;\n  }\n\n  async _initialize() {\n    for (const page of this._context.pages())\n      this._onPage(page);\n    this._eventListeners = [\n      eventsHelper.addEventListener(this._context, BrowserContext.Events.Page, this._onPage.bind(this)),\n      eventsHelper.addEventListener(this._context, BrowserContext.Events.Response, (response: network.Response) => {\n        this._saveResource(response).catch(e => debugLogger.log('error', e));\n      }),\n    ];\n\n    const initScript = `(${frameSnapshotStreamer})(\"${this._snapshotStreamer}\")`;\n    await this._context._doAddInitScript(initScript);\n    await this._runInAllFrames(initScript);\n  }\n\n  private async _runInAllFrames(expression: string) {\n    const frames = [];\n    for (const page of this._context.pages())\n      frames.push(...page.frames());\n    await Promise.all(frames.map(frame => {\n      return frame.nonStallingRawEvaluateInExistingMainContext(expression).catch(e => debugLogger.log('error', e));\n    }));\n  }\n\n  dispose() {\n    eventsHelper.removeEventListeners(this._eventListeners);\n  }\n\n  async captureSnapshot(page: Page, snapshotName: string, element?: ElementHandle): Promise<void> {\n    // Prepare expression synchronously.\n    const expression = `window[\"${this._snapshotStreamer}\"].captureSnapshot(${JSON.stringify(snapshotName)})`;\n\n    // In a best-effort manner, without waiting for it, mark target element.\n    element?.callFunctionNoReply((element: Element, snapshotName: string) => {\n      element.setAttribute('__playwright_target__', snapshotName);\n    }, snapshotName);\n\n    // In each frame, in a non-stalling manner, capture the snapshots.\n    const snapshots = page.frames().map(async frame => {\n      const data = await frame.nonStallingRawEvaluateInExistingMainContext(expression).catch(e => debugLogger.log('error', e)) as SnapshotData;\n      // Something went wrong -> bail out, our snapshots are best-efforty.\n      if (!data || !this._started)\n        return;\n\n      const snapshot: FrameSnapshot = {\n        snapshotName,\n        pageId: page.guid,\n        frameId: frame.guid,\n        frameUrl: data.url,\n        doctype: data.doctype,\n        html: data.html,\n        viewport: data.viewport,\n        timestamp: monotonicTime(),\n        collectionTime: data.collectionTime,\n        resourceOverrides: [],\n        isMainFrame: page.mainFrame() === frame\n      };\n      for (const { url, content, contentType } of data.resourceOverrides) {\n        if (typeof content === 'string') {\n          const buffer = Buffer.from(content);\n          const sha1 = calculateSha1(buffer) + mimeToExtension(contentType);\n          this._delegate.onBlob({ sha1, buffer });\n          snapshot.resourceOverrides.push({ url, sha1 });\n        } else {\n          snapshot.resourceOverrides.push({ url, ref: content });\n        }\n      }\n      this._delegate.onFrameSnapshot(snapshot);\n    });\n    await Promise.all(snapshots);\n  }\n\n  private _onPage(page: Page) {\n    // Annotate frame hierarchy so that snapshots could include frame ids.\n    for (const frame of page.frames())\n      this._annotateFrameHierarchy(frame);\n    this._eventListeners.push(eventsHelper.addEventListener(page, Page.Events.FrameAttached, frame => this._annotateFrameHierarchy(frame)));\n  }\n\n  private async _saveResource(response: network.Response) {\n    if (!this._started)\n      return;\n    const isRedirect = response.status() >= 300 && response.status() <= 399;\n    if (isRedirect)\n      return;\n    // We do not need scripts for snapshots.\n    if (response.request().resourceType() === 'script')\n      return;\n\n    // Shortcut all redirects - we cannot intercept them properly.\n    let original = response.request();\n    while (original.redirectedFrom())\n      original = original.redirectedFrom()!;\n    const url = original.url();\n\n    let contentType = '';\n    for (const { name, value } of response.headers()) {\n      if (name.toLowerCase() === 'content-type')\n        contentType = value;\n    }\n\n    const method = original.method();\n    const status = response.status();\n    const requestBody = original.postDataBuffer();\n    const requestSha1 = requestBody ? calculateSha1(requestBody) + mimeToExtension(contentType) : '';\n    if (requestBody)\n      this._delegate.onBlob({ sha1: requestSha1, buffer: requestBody });\n    const requestHeaders = original.headers();\n\n    // Only fetch response bodies once.\n    let responseSha1 = this._fetchedResponses.get(response);\n    {\n      if (responseSha1 === undefined) {\n        const body = await response.body().catch(e => debugLogger.log('error', e));\n        // Bail out after each async hop.\n        if (!this._started)\n          return;\n        responseSha1 = body ? calculateSha1(body) + mimeToExtension(contentType) : '';\n        if (body)\n          this._delegate.onBlob({ sha1: responseSha1, buffer: body });\n        this._fetchedResponses.set(response, responseSha1);\n      }\n    }\n\n    const resource: ResourceSnapshot = {\n      pageId: response.frame()._page.guid,\n      frameId: response.frame().guid,\n      url,\n      type: response.request().resourceType(),\n      contentType,\n      responseHeaders: response.headers(),\n      requestHeaders,\n      method,\n      status,\n      requestSha1,\n      responseSha1,\n      timestamp: monotonicTime()\n    };\n    this._delegate.onResourceSnapshot(resource);\n  }\n\n  private async _annotateFrameHierarchy(frame: Frame) {\n    try {\n      const frameElement = await frame.frameElement();\n      const parent = frame.parentFrame();\n      if (!parent)\n        return;\n      const context = await parent._mainContext();\n      await context?.evaluate(({ snapshotStreamer, frameElement, frameId }) => {\n        (window as any)[snapshotStreamer].markIframe(frameElement, frameId);\n      }, { snapshotStreamer: this._snapshotStreamer, frameElement, frameId: frame.guid });\n      frameElement.dispose();\n    } catch (e) {\n    }\n  }\n}\n\nconst kMimeToExtension: { [key: string]: string } = {\n  'application/javascript': 'js',\n  'application/json': 'json',\n  'application/json5': 'json5',\n  'application/pdf': 'pdf',\n  'application/xhtml+xml': 'xhtml',\n  'application/zip': 'zip',\n  'font/otf': 'otf',\n  'font/woff': 'woff',\n  'font/woff2': 'woff2',\n  'image/bmp': 'bmp',\n  'image/gif': 'gif',\n  'image/jpeg': 'jpeg',\n  'image/png': 'png',\n  'image/tiff': 'tiff',\n  'text/css': 'css',\n  'text/csv': 'csv',\n  'text/html': 'html',\n  'text/plain': 'text',\n  'video/mp4': 'mp4',\n  'video/mpeg': 'mpeg',\n};\n\nfunction mimeToExtension(contentType: string): string {\n  return '.' + (kMimeToExtension[contentType] || 'dat');\n}\n"],"file":"snapshotter.js"}