{"version":3,"sources":["../../../src/server/snapshot/snapshotterInjected.ts"],"names":["frameSnapshotStreamer","snapshotStreamer","window","kShadowAttribute","kScrollTopAttribute","kScrollLeftAttribute","kStyleSheetAttribute","kSnapshotFrameId","Symbol","kCachedData","kEndOfList","resetCachedData","obj","ensureCachedData","removeHash","url","u","URL","hash","toString","e","Streamer","constructor","_removeNoScript","_lastSnapshotNumber","_staleStyleSheets","Set","_readingStyleSheet","_fakeBase","_observer","_interceptNativeMethod","CSSStyleSheet","prototype","sheet","_invalidateStyleSheet","_interceptNativeGetter","document","createElement","MutationObserver","list","_handleMutations","observerConfig","attributes","subtree","observe","method","cb","native","args","result","call","prop","descriptor","Object","getOwnPropertyDescriptor","defineProperty","get","mutation","target","attributesCached","undefined","add","_updateStyleElementStyleSheetTextIfNeeded","data","has","delete","cssText","_getSheetText","_updateLinkStyleSheetTextIfNeeded","snapshotNumber","cssRef","markIframe","iframeElement","frameId","reset","clear","visitNode","node","nodeType","Node","ELEMENT_NODE","element","shadowRoot","child","firstChild","nextSibling","documentElement","_sanitizeUrl","startsWith","_sanitizeSrcSet","srcset","split","map","src","trim","spaceIndex","lastIndexOf","substring","join","_resolveUrl","base","href","_getSheetBase","rootSheet","parentStyleSheet","ownerNode","baseURI","rules","rule","cssRules","push","captureSnapshot","timestamp","performance","now","nodeCounter","shadowDomNesting","takeRecords","nodeName","DOCUMENT_FRAGMENT_NODE","TEXT_NODE","values","equals","cached","extraNodes","expectValue","value","length","checkAndReturn","n","ref","nodeValue","textContent","attrs","visitChild","snapshot","visitChildStyleSheet","visitStyleSheet","checked","scrollTop","scrollLeft","setAttribute","documentOrShadowRoot","ownerDocument","adoptedStyleSheets","name","i","keys","pop","oldCSSText","html","doctype","resourceOverrides","viewport","width","innerWidth","height","innerHeight","location","collectionTime","content","contentType"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { NodeSnapshot } from './snapshotTypes';\n\nexport type SnapshotData = {\n  doctype?: string,\n  html: NodeSnapshot,\n  resourceOverrides: {\n    url: string,\n    // String is the content. Number is \"x snapshots ago\", same url.\n    content: string | number,\n    contentType: 'text/css'\n  }[],\n  viewport: { width: number, height: number },\n  url: string,\n  timestamp: number,\n  collectionTime: number,\n};\n\nexport function frameSnapshotStreamer(snapshotStreamer: string) {\n  // Communication with Playwright.\n  if ((window as any)[snapshotStreamer])\n    return;\n\n  // Attributes present in the snapshot.\n  const kShadowAttribute = '__playwright_shadow_root_';\n  const kScrollTopAttribute = '__playwright_scroll_top_';\n  const kScrollLeftAttribute = '__playwright_scroll_left_';\n  const kStyleSheetAttribute = '__playwright_style_sheet_';\n\n  // Symbols for our own info on Nodes/StyleSheets.\n  const kSnapshotFrameId = Symbol('__playwright_snapshot_frameid_');\n  const kCachedData = Symbol('__playwright_snapshot_cache_');\n  const kEndOfList = Symbol('__playwright_end_of_list_');\n  type CachedData = {\n    cached?: any[], // Cached values to determine whether the snapshot will be the same.\n    ref?: [number, number], // Previous snapshotNumber and nodeIndex.\n    attributesCached?: boolean, // Whether node attributes have not changed.\n    cssText?: string, // Text for stylesheets.\n    cssRef?: number, // Previous snapshotNumber for overridden stylesheets.\n  };\n\n  function resetCachedData(obj: any) {\n    delete obj[kCachedData];\n  }\n\n  function ensureCachedData(obj: any): CachedData {\n    if (!obj[kCachedData])\n      obj[kCachedData] = {};\n    return obj[kCachedData];\n  }\n\n  function removeHash(url: string) {\n    try {\n      const u = new URL(url);\n      u.hash = '';\n      return u.toString();\n    } catch (e) {\n      return url;\n    }\n  }\n\n  class Streamer {\n    private _removeNoScript = true;\n    private _lastSnapshotNumber = 0;\n    private _staleStyleSheets = new Set<CSSStyleSheet>();\n    private _readingStyleSheet = false;  // To avoid invalidating due to our own reads.\n    private _fakeBase: HTMLBaseElement;\n    private _observer: MutationObserver;\n\n    constructor() {\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'insertRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'deleteRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'addRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'removeRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeGetter(window.CSSStyleSheet.prototype, 'rules', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeGetter(window.CSSStyleSheet.prototype, 'cssRules', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n\n      this._fakeBase = document.createElement('base');\n\n      this._observer = new MutationObserver(list => this._handleMutations(list));\n      const observerConfig = { attributes: true, subtree: true };\n      this._observer.observe(document, observerConfig);\n    }\n\n    private _interceptNativeMethod(obj: any, method: string, cb: (thisObj: any, result: any) => void) {\n      const native = obj[method] as Function;\n      if (!native)\n        return;\n      obj[method] = function(...args: any[]) {\n        const result = native.call(this, ...args);\n        cb(this, result);\n        return result;\n      };\n    }\n\n    private _interceptNativeGetter(obj: any, prop: string, cb: (thisObj: any, result: any) => void) {\n      const descriptor = Object.getOwnPropertyDescriptor(obj, prop)!;\n      Object.defineProperty(obj, prop, {\n        ...descriptor,\n        get: function() {\n          const result = descriptor.get!.call(this);\n          cb(this, result);\n          return result;\n        },\n      });\n    }\n\n    private _handleMutations(list: MutationRecord[]) {\n      for (const mutation of list)\n        ensureCachedData(mutation.target).attributesCached = undefined;\n    }\n\n    private _invalidateStyleSheet(sheet: CSSStyleSheet) {\n      if (this._readingStyleSheet)\n        return;\n      this._staleStyleSheets.add(sheet);\n    }\n\n    private _updateStyleElementStyleSheetTextIfNeeded(sheet: CSSStyleSheet): string | undefined {\n      const data = ensureCachedData(sheet);\n      if (this._staleStyleSheets.has(sheet)) {\n        this._staleStyleSheets.delete(sheet);\n        try {\n          data.cssText = this._getSheetText(sheet);\n        } catch (e) {\n          // Sometimes we cannot access cross-origin stylesheets.\n        }\n      }\n      return data.cssText;\n    }\n\n    // Returns either content, ref, or no override.\n    private _updateLinkStyleSheetTextIfNeeded(sheet: CSSStyleSheet, snapshotNumber: number): string | number | undefined {\n      const data = ensureCachedData(sheet);\n      if (this._staleStyleSheets.has(sheet)) {\n        this._staleStyleSheets.delete(sheet);\n        try {\n          data.cssText = this._getSheetText(sheet);\n          data.cssRef = snapshotNumber;\n          return data.cssText;\n        } catch (e) {\n          // Sometimes we cannot access cross-origin stylesheets.\n        }\n      }\n      return data.cssRef === undefined ? undefined : snapshotNumber - data.cssRef;\n    }\n\n    markIframe(iframeElement: HTMLIFrameElement | HTMLFrameElement, frameId: string) {\n      (iframeElement as any)[kSnapshotFrameId] = frameId;\n    }\n\n    reset() {\n      this._staleStyleSheets.clear();\n\n      const visitNode = (node: Node | ShadowRoot) => {\n        resetCachedData(node);\n        if (node.nodeType === Node.ELEMENT_NODE) {\n          const element = node as Element;\n          if (element.shadowRoot)\n            visitNode(element.shadowRoot);\n        }\n        for (let child = node.firstChild; child; child = child.nextSibling)\n          visitNode(child);\n      };\n      visitNode(document.documentElement);\n      visitNode(this._fakeBase);\n    }\n\n    private _sanitizeUrl(url: string): string {\n      if (url.startsWith('javascript:'))\n        return '';\n      return url;\n    }\n\n    private _sanitizeSrcSet(srcset: string): string {\n      return srcset.split(',').map(src => {\n        src = src.trim();\n        const spaceIndex = src.lastIndexOf(' ');\n        if (spaceIndex === -1)\n          return this._sanitizeUrl(src);\n        return this._sanitizeUrl(src.substring(0, spaceIndex).trim()) + src.substring(spaceIndex);\n      }).join(', ');\n    }\n\n    private _resolveUrl(base: string, url: string): string {\n      if (url === '')\n        return '';\n      try {\n        return new URL(url, base).href;\n      } catch (e) {\n        return url;\n      }\n    }\n\n    private _getSheetBase(sheet: CSSStyleSheet): string {\n      let rootSheet = sheet;\n      while (rootSheet.parentStyleSheet)\n        rootSheet = rootSheet.parentStyleSheet;\n      if (rootSheet.ownerNode)\n        return rootSheet.ownerNode.baseURI;\n      return document.baseURI;\n    }\n\n    private _getSheetText(sheet: CSSStyleSheet): string {\n      this._readingStyleSheet = true;\n      try {\n        const rules: string[] = [];\n        for (const rule of sheet.cssRules)\n          rules.push(rule.cssText);\n        return rules.join('\\n');\n      } finally {\n        this._readingStyleSheet = false;\n      }\n    }\n\n    captureSnapshot(): SnapshotData | undefined {\n      const timestamp = performance.now();\n      const snapshotNumber = ++this._lastSnapshotNumber;\n      let nodeCounter = 0;\n      let shadowDomNesting = 0;\n\n      // Ensure we are up to date.\n      this._handleMutations(this._observer.takeRecords());\n\n      const visitNode = (node: Node | ShadowRoot): { equals: boolean, n: NodeSnapshot } | undefined => {\n        const nodeType = node.nodeType;\n        const nodeName = nodeType === Node.DOCUMENT_FRAGMENT_NODE ? 'template' : node.nodeName;\n\n        if (nodeType !== Node.ELEMENT_NODE &&\n            nodeType !== Node.DOCUMENT_FRAGMENT_NODE &&\n            nodeType !== Node.TEXT_NODE)\n          return;\n        if (nodeName === 'SCRIPT')\n          return;\n        if (this._removeNoScript && nodeName === 'NOSCRIPT')\n          return;\n\n        const data = ensureCachedData(node);\n        const values: any[] = [];\n        let equals = !!data.cached;\n        let extraNodes = 0;\n\n        const expectValue = (value: any) => {\n          equals = equals && data.cached![values.length] === value;\n          values.push(value);\n        };\n\n        const checkAndReturn = (n: NodeSnapshot): { equals: boolean, n: NodeSnapshot } => {\n          data.attributesCached = true;\n          if (equals)\n            return { equals: true, n: [[ snapshotNumber - data.ref![0], data.ref![1] ]] };\n          nodeCounter += extraNodes;\n          data.ref = [snapshotNumber, nodeCounter++];\n          data.cached = values;\n          return { equals: false, n };\n        };\n\n        if (nodeType === Node.TEXT_NODE) {\n          const value = node.nodeValue || '';\n          expectValue(value);\n          return checkAndReturn(value);\n        }\n\n        if (nodeName === 'STYLE') {\n          const sheet = (node as HTMLStyleElement).sheet;\n          let cssText: string | undefined;\n          if (sheet)\n            cssText = this._updateStyleElementStyleSheetTextIfNeeded(sheet);\n          cssText = cssText || node.textContent || '';\n          expectValue(cssText);\n          // Compensate for the extra 'cssText' text node.\n          extraNodes++;\n          return checkAndReturn(['style', {}, cssText]);\n        }\n\n        const attrs: { [attr: string]: string } = {};\n        const result: NodeSnapshot = [nodeName, attrs];\n\n        const visitChild = (child: Node) => {\n          const snapshot = visitNode(child);\n          if (snapshot) {\n            result.push(snapshot.n);\n            expectValue(child);\n            equals = equals && snapshot.equals;\n          }\n        };\n\n        const visitChildStyleSheet = (child: CSSStyleSheet) => {\n          const snapshot = visitStyleSheet(child);\n          if (snapshot) {\n            result.push(snapshot.n);\n            expectValue(child);\n            equals = equals && snapshot.equals;\n          }\n        };\n\n        if (nodeType === Node.DOCUMENT_FRAGMENT_NODE)\n          attrs[kShadowAttribute] = 'open';\n\n        if (nodeType === Node.ELEMENT_NODE) {\n          const element = node as Element;\n          if (nodeName === 'INPUT') {\n            const value = (element as HTMLInputElement).value;\n            expectValue('value');\n            expectValue(value);\n            attrs['value'] = value;\n            if ((element as HTMLInputElement).checked) {\n              expectValue('checked');\n              attrs['checked'] = '';\n            }\n          }\n          if (element.scrollTop) {\n            expectValue(kScrollTopAttribute);\n            expectValue(element.scrollTop);\n            attrs[kScrollTopAttribute] = '' + element.scrollTop;\n          }\n          if (element.scrollLeft) {\n            expectValue(kScrollLeftAttribute);\n            expectValue(element.scrollLeft);\n            attrs[kScrollLeftAttribute] = '' + element.scrollLeft;\n          }\n          if (element.shadowRoot) {\n            ++shadowDomNesting;\n            visitChild(element.shadowRoot);\n            --shadowDomNesting;\n          }\n        }\n\n        if (nodeName === 'TEXTAREA') {\n          const value = (node as HTMLTextAreaElement).value;\n          expectValue(value);\n          extraNodes++; // Compensate for the extra text node.\n          result.push(value);\n        } else {\n          if (nodeName === 'HEAD') {\n            // Insert fake <base> first, to ensure all <link> elements use the proper base uri.\n            this._fakeBase.setAttribute('href', document.baseURI);\n            visitChild(this._fakeBase);\n          }\n          for (let child = node.firstChild; child; child = child.nextSibling)\n            visitChild(child);\n          expectValue(kEndOfList);\n          let documentOrShadowRoot = null;\n          if (node.ownerDocument!.documentElement === node)\n            documentOrShadowRoot = node.ownerDocument;\n          else if (node.nodeType === Node.DOCUMENT_FRAGMENT_NODE)\n            documentOrShadowRoot = node;\n          if (documentOrShadowRoot) {\n            for (const sheet of (documentOrShadowRoot as any).adoptedStyleSheets || [])\n              visitChildStyleSheet(sheet);\n            expectValue(kEndOfList);\n          }\n        }\n\n        // Process iframe src attribute before bailing out since it depends on a symbol, not the DOM.\n        if (nodeName === 'IFRAME' || nodeName === 'FRAME') {\n          const element = node as Element;\n          const frameId = (element as any)[kSnapshotFrameId];\n          const name = 'src';\n          const value = frameId ? `/snapshot/${frameId}` : '';\n          expectValue(name);\n          expectValue(value);\n          attrs[name] = value;\n        }\n\n        // We can skip attributes comparison because nothing else has changed,\n        // and mutation observer didn't tell us about the attributes.\n        if (equals && data.attributesCached && !shadowDomNesting)\n          return checkAndReturn(result);\n\n        if (nodeType === Node.ELEMENT_NODE) {\n          const element = node as Element;\n          for (let i = 0; i < element.attributes.length; i++) {\n            const name = element.attributes[i].name;\n            if (name === 'value' && (nodeName === 'INPUT' || nodeName === 'TEXTAREA'))\n              continue;\n            if (nodeName === 'LINK' && name === 'integrity')\n              continue;\n            if (nodeName === 'IFRAME' && name === 'src')\n              continue;\n            let value = element.attributes[i].value;\n            if (name === 'src' && (nodeName === 'IMG'))\n              value = this._sanitizeUrl(value);\n            else if (name === 'srcset' && (nodeName === 'IMG'))\n              value = this._sanitizeSrcSet(value);\n            else if (name === 'srcset' && (nodeName === 'SOURCE'))\n              value = this._sanitizeSrcSet(value);\n            else if (name === 'href' && (nodeName === 'LINK'))\n              value = this._sanitizeUrl(value);\n            else if (name.startsWith('on'))\n              value = '';\n            expectValue(name);\n            expectValue(value);\n            attrs[name] = value;\n          }\n          expectValue(kEndOfList);\n        }\n\n        if (result.length === 2 && !Object.keys(attrs).length)\n          result.pop();  // Remove empty attrs when there are no children.\n        return checkAndReturn(result);\n      };\n\n      const visitStyleSheet = (sheet: CSSStyleSheet) => {\n        const data = ensureCachedData(sheet);\n        const oldCSSText = data.cssText;\n        const cssText = this._updateStyleElementStyleSheetTextIfNeeded(sheet) || '';\n        if (cssText === oldCSSText)\n          return { equals: true, n: [[ snapshotNumber - data.ref![0], data.ref![1] ]] };\n        data.ref = [snapshotNumber, nodeCounter++];\n        return {\n          equals: false,\n          n: ['template', {\n            [kStyleSheetAttribute]: cssText,\n          }]\n        };\n      };\n\n      let html: NodeSnapshot;\n      if (document.documentElement) {\n        const { n } = visitNode(document.documentElement)!;\n        html = n;\n      } else {\n        html = ['html'];\n      }\n\n      const result: SnapshotData = {\n        html,\n        doctype: document.doctype ? document.doctype.name : undefined,\n        resourceOverrides: [],\n        viewport: {\n          width: window.innerWidth,\n          height: window.innerHeight,\n        },\n        url: location.href,\n        timestamp,\n        collectionTime: 0,\n      };\n\n      for (const sheet of this._staleStyleSheets) {\n        if (sheet.href === null)\n          continue;\n        const content = this._updateLinkStyleSheetTextIfNeeded(sheet, snapshotNumber);\n        if (content === undefined) {\n          // Unable to capture stylesheet contents.\n          continue;\n        }\n        const base = this._getSheetBase(sheet);\n        const url = removeHash(this._resolveUrl(base, sheet.href!));\n        result.resourceOverrides.push({ url, content, contentType: 'text/css' },);\n      }\n\n      result.collectionTime = performance.now() - result.timestamp;\n      return result;\n    }\n  }\n\n  (window as any)[snapshotStreamer] = new Streamer();\n}\n"],"file":"snapshotterInjected.js"}