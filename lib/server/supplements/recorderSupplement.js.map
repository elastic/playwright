{"version":3,"sources":["../../../src/server/supplements/recorderSupplement.ts"],"names":["symbol","Symbol","RecorderSupplement","showInspector","context","show","catch","params","recorderPromise","recorder","install","Boolean","showRecorder","then","constructor","_generator","_pageAliases","Map","_lastPopupOrdinal","_lastDialogOrdinal","_lastDownloadOrdinal","_timers","Set","_context","_mode","_highlightedSelector","_recorderApp","_params","_currentCallsMetadata","_recorderSources","_userSources","_allMetadatas","_debugger","Debugger","lookup","instrumentation","addListener","startRecording","language","_options","sdkLanguage","languages","JavaLanguageGenerator","JavaScriptLanguageGenerator","PythonLanguageGenerator","CSharpLanguageGenerator","primaryLanguage","find","l","id","Error","delete","orderedLanguages","generator","CodeGenerator","_browser","options","name","launchOptions","contextOptions","device","saveStorage","actionListener","text","on","languageGenerator","source","file","fileName","generateText","highlighter","highlight","revealLine","split","length","push","_pushAllSources","setFile","outputFile","BrowserContext","Events","BeforeClose","fs","writeFileSync","process","installRecorder","recorderApp","RecorderApp","open","once","resume","data","event","_setMode","mode","_refreshOverlay","selector","pauseOnNextStatement","_clearScript","Promise","all","setMode","setPaused","isPaused","recorderAppForTest","Page","page","_onPage","pages","Close","timer","clearTimeout","clear","close","exposeBinding","action","_performAction","frame","_recordAction","actionSelector","actionPoint","metadata","sdkObject","attribution","point","uiState","_","setSelector","bringToFront","extendInjectedScript","recorderSource","isUnderTest","consoleApiSource","_pausedStateChanged","PausedStateChanged","pausedDetails","has","onBeforeCall","_updateUserSources","updateCallLog","keys","setEnabled","setMuted","mainFrame","evaluateExpression","undefined","addAction","pageAlias","committed","signals","Frame","Navigation","_onFrameNavigated","Download","_onDownload","Dialog","_onDialog","suffix","size","String","set","opener","_onPopup","url","restart","commitLastAction","_page","actionInContext","get","perform","cb","callMetadata","apiName","objectId","guid","pageId","frameId","startTime","endTime","type","method","log","snapshots","willPerformAction","e","onAfterCall","performedActionFailed","setTimeout","didPerformAction","add","kActionTimeout","click","timeout","modifiers","shortcut","key","join","press","check","uncheck","values","map","value","selectOption","signal","popup","popupAlias","downloadAlias","dialogAlias","error","fileToSelect","stack","line","_readSource","languageForFile","paused","setSources","onBeforeInputAction","onCallLog","logName","message","metadatas","logs","status","updateCallLogs","readFileSync","endsWith"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as fs from 'fs';\nimport * as actions from './recorder/recorderActions';\nimport type * as channels from '../../protocol/channels';\nimport { CodeGenerator, ActionInContext } from './recorder/codeGenerator';\nimport { describeFrame, toClickOptions, toModifiers } from './recorder/utils';\nimport { Page } from '../page';\nimport { Frame } from '../frames';\nimport { BrowserContext } from '../browserContext';\nimport { JavaLanguageGenerator } from './recorder/java';\nimport { JavaScriptLanguageGenerator } from './recorder/javascript';\nimport { CSharpLanguageGenerator } from './recorder/csharp';\nimport { PythonLanguageGenerator } from './recorder/python';\nimport * as recorderSource from '../../generated/recorderSource';\nimport * as consoleApiSource from '../../generated/consoleApiSource';\nimport { RecorderApp } from './recorder/recorderApp';\nimport { CallMetadata, InstrumentationListener, SdkObject } from '../instrumentation';\nimport { Point } from '../../common/types';\nimport { CallLog, CallLogStatus, EventData, Mode, Source, UIState } from './recorder/recorderTypes';\nimport { createGuid, isUnderTest, monotonicTime } from '../../utils/utils';\nimport { metadataToCallLog } from './recorder/recorderUtils';\nimport { Debugger } from './debugger';\n\ntype BindingSource = { frame: Frame, page: Page };\n\nconst symbol = Symbol('RecorderSupplement');\n\nexport class RecorderSupplement implements InstrumentationListener {\n  private _generator: CodeGenerator;\n  private _pageAliases = new Map<Page, string>();\n  private _lastPopupOrdinal = 0;\n  private _lastDialogOrdinal = 0;\n  private _lastDownloadOrdinal = 0;\n  private _timers = new Set<NodeJS.Timeout>();\n  private _context: BrowserContext;\n  private _mode: Mode;\n  private _highlightedSelector = '';\n  private _recorderApp: RecorderApp | null = null;\n  private _params: channels.BrowserContextRecorderSupplementEnableParams;\n  private _currentCallsMetadata = new Map<CallMetadata, SdkObject>();\n  private _recorderSources: Source[];\n  private _userSources = new Map<string, Source>();\n  private _allMetadatas = new Map<string, CallMetadata>();\n  private _debugger: Debugger;\n\n  static showInspector(context: BrowserContext) {\n    RecorderSupplement.show(context, {}).catch(() => {});\n  }\n\n  static show(context: BrowserContext, params: channels.BrowserContextRecorderSupplementEnableParams = {}): Promise<RecorderSupplement> {\n    let recorderPromise = (context as any)[symbol] as Promise<RecorderSupplement>;\n    if (!recorderPromise) {\n      const recorder = new RecorderSupplement(context, params);\n      recorderPromise = recorder.install(Boolean(params.showRecorder)).then(() => recorder);\n\n      (context as any)[symbol] = recorderPromise;\n    }\n    return recorderPromise;\n  }\n\n  constructor(context: BrowserContext, params: channels.BrowserContextRecorderSupplementEnableParams) {\n    this._context = context;\n    this._debugger = Debugger.lookup(context)!;\n    context.instrumentation.addListener(this);\n    this._params = params;\n    this._mode = params.startRecording ? 'recording' : 'none';\n    const language = params.language || context._options.sdkLanguage;\n\n    const languages = new Set([\n      new JavaLanguageGenerator(),\n      new JavaScriptLanguageGenerator(false),\n      new JavaScriptLanguageGenerator(true),\n      new PythonLanguageGenerator(false),\n      new PythonLanguageGenerator(true),\n      new CSharpLanguageGenerator(),\n    ]);\n    const primaryLanguage = [...languages].find(l => l.id === language)!;\n    if (!primaryLanguage)\n      throw new Error(`\\n===============================\\nUnsupported language: '${language}'\\n===============================\\n`);\n\n    languages.delete(primaryLanguage);\n    const orderedLanguages = [primaryLanguage, ...languages];\n\n    this._recorderSources = [];\n    const generator = new CodeGenerator(context._browser.options.name, !!params.startRecording, params.launchOptions || {}, params.contextOptions || {}, params.device, params.saveStorage, params.actionListener);\n    let text = '';\n    generator.on('change', () => {\n      this._recorderSources = [];\n      for (const languageGenerator of orderedLanguages) {\n        const source: Source = {\n          file: languageGenerator.fileName,\n          text: generator.generateText(languageGenerator),\n          language: languageGenerator.highlighter,\n          highlight: []\n        };\n        source.revealLine = source.text.split('\\n').length - 1;\n        this._recorderSources.push(source);\n        if (languageGenerator === orderedLanguages[0])\n          text = source.text;\n      }\n      this._pushAllSources();\n      this._recorderApp?.setFile(primaryLanguage.fileName);\n    });\n    if (params.outputFile) {\n      context.on(BrowserContext.Events.BeforeClose, () => {\n        fs.writeFileSync(params.outputFile!, text);\n        text = '';\n      });\n      process.on('exit', () => {\n        if (text)\n          fs.writeFileSync(params.outputFile!, text);\n      });\n    }\n    this._generator = generator;\n  }\n\n  async installRecorder() {\n    const recorderApp = await RecorderApp.open(this._context);\n    this._recorderApp = recorderApp;\n    recorderApp.once('close', () => {\n      this._debugger.resume(false);\n      this._recorderApp = null;\n    });\n    recorderApp.on('event', (data: EventData) => {\n      if (data.event === 'setMode') {\n        this._setMode(data.params.mode);\n        this._refreshOverlay();\n        return;\n      }\n      if (data.event === 'selectorUpdated') {\n        this._highlightedSelector = data.params.selector;\n        this._refreshOverlay();\n        return;\n      }\n      if (data.event === 'step') {\n        this._debugger.resume(true);\n        return;\n      }\n      if (data.event === 'resume') {\n        this._debugger.resume(false);\n        return;\n      }\n      if (data.event === 'pause') {\n        this._debugger.pauseOnNextStatement();\n        return;\n      }\n      if (data.event === 'clear') {\n        this._clearScript();\n        return;\n      }\n    });\n\n    await Promise.all([\n      recorderApp.setMode(this._mode),\n      recorderApp.setPaused(this._debugger.isPaused()),\n      this._pushAllSources()\n    ]);\n\n    (this._context as any).recorderAppForTest = this._recorderApp;\n  }\n\n  async install(showRecorder: Boolean) {\n    if (showRecorder)\n      await this.installRecorder();\n\n    this._context.on(BrowserContext.Events.Page, page => this._onPage(page));\n    for (const page of this._context.pages())\n      this._onPage(page);\n\n    this._context.once(BrowserContext.Events.Close, () => {\n      for (const timer of this._timers)\n        clearTimeout(timer);\n      this._timers.clear();\n      this._recorderApp?.close().catch(() => {});\n    });\n\n    // Input actions that potentially lead to navigation are intercepted on the page and are\n    // performed by the Playwright.\n    await this._context.exposeBinding('_playwrightRecorderPerformAction', false,\n        (source: BindingSource, action: actions.Action) => this._performAction(source.frame, action), 'utility');\n\n    // Other non-essential actions are simply being recorded.\n    await this._context.exposeBinding('_playwrightRecorderRecordAction', false,\n        (source: BindingSource, action: actions.Action) => this._recordAction(source.frame, action), 'utility');\n\n    await this._context.exposeBinding('_playwrightRecorderState', false, source => {\n      let actionSelector = this._highlightedSelector;\n      let actionPoint: Point | undefined;\n      for (const [metadata, sdkObject] of this._currentCallsMetadata) {\n        if (source.page === sdkObject.attribution.page) {\n          actionPoint = metadata.point || actionPoint;\n          actionSelector = actionSelector || metadata.params.selector;\n        }\n      }\n      const uiState: UIState = {\n        mode: this._mode,\n        actionPoint,\n        actionSelector,\n      };\n      return uiState;\n    }, 'utility');\n\n    await this._context.exposeBinding('_playwrightRecorderSetSelector', false, async (_, selector: string) => {\n      this._setMode('none');\n      await this._recorderApp?.setSelector(selector, true);\n      await this._recorderApp?.bringToFront();\n    }, 'utility');\n\n    await this._context.exposeBinding('_playwrightResume', false, () => {\n      this._debugger.resume(false);\n    }, 'main');\n\n    await this._context.extendInjectedScript('utility', recorderSource.source, { isUnderTest: isUnderTest() });\n    await this._context.extendInjectedScript('main', consoleApiSource.source);\n\n    if (this._debugger.isPaused())\n      this._pausedStateChanged();\n    this._debugger.on(Debugger.Events.PausedStateChanged, () => this._pausedStateChanged());\n  }\n\n  _pausedStateChanged() {\n    // If we are called upon page.pause, we don't have metadatas, populate them.\n    for (const { metadata, sdkObject } of this._debugger.pausedDetails()) {\n      if (!this._currentCallsMetadata.has(metadata))\n        this.onBeforeCall(sdkObject, metadata);\n    }\n    this._recorderApp?.setPaused(this._debugger.isPaused());\n    this._updateUserSources();\n    this.updateCallLog([...this._currentCallsMetadata.keys()]);\n  }\n\n  private _setMode(mode: Mode) {\n    this._mode = mode;\n    this._recorderApp?.setMode(this._mode);\n    this._generator.setEnabled(this._mode === 'recording');\n    Debugger.lookup(this._context)!.setMuted(this._mode === 'recording');\n    if (this._mode !== 'none')\n      this._context.pages()[0].bringToFront().catch(() => {});\n  }\n\n  private _refreshOverlay() {\n    for (const page of this._context.pages())\n      page.mainFrame().evaluateExpression('window._playwrightRefreshOverlay()', false, undefined, 'main').catch(() => {});\n  }\n\n  private async _onPage(page: Page) {\n    // First page is called page, others are called popup1, popup2, etc.\n    const frame = page.mainFrame();\n    page.on('close', () => {\n      this._pageAliases.delete(page);\n      this._generator.addAction({\n        pageAlias,\n        ...describeFrame(page.mainFrame()),\n        committed: true,\n        action: {\n          name: 'closePage',\n          signals: [],\n        }\n      });\n    });\n    frame.on(Frame.Events.Navigation, () => this._onFrameNavigated(frame, page));\n    page.on(Page.Events.Download, () => this._onDownload(page));\n    page.on(Page.Events.Dialog, () => this._onDialog(page));\n    const suffix = this._pageAliases.size ? String(++this._lastPopupOrdinal) : '';\n    const pageAlias = 'page' + suffix;\n    this._pageAliases.set(page, pageAlias);\n\n    if (page.opener()) {\n      this._onPopup(page.opener()!, page);\n    } else {\n      this._generator.addAction({\n        pageAlias,\n        ...describeFrame(page.mainFrame()),\n        committed: true,\n        action: {\n          name: 'openPage',\n          url: page.mainFrame().url(),\n          signals: [],\n        }\n      });\n    }\n  }\n\n  private _clearScript(): void {\n    this._generator.restart();\n    if (!!this._params.startRecording) {\n      for (const page of this._context.pages())\n        this._onFrameNavigated(page.mainFrame(), page);\n    }\n  }\n\n  private async _performAction(frame: Frame, action: actions.Action) {\n    // Commit last action so that no further signals are added to it.\n    this._generator.commitLastAction();\n\n    const page = frame._page;\n    const actionInContext: ActionInContext = {\n      pageAlias: this._pageAliases.get(page)!,\n      ...describeFrame(frame),\n      action\n    };\n\n    const perform = async (action: string, params: any, cb: (callMetadata: CallMetadata) => Promise<any>) => {\n      const callMetadata: CallMetadata = {\n        id: `call@${createGuid()}`,\n        apiName: 'frame.' + action,\n        objectId: frame.guid,\n        pageId: frame._page.guid,\n        frameId: frame.guid,\n        startTime: monotonicTime(),\n        endTime: 0,\n        type: 'Frame',\n        method: action,\n        params,\n        log: [],\n        snapshots: [],\n      };\n      this._generator.willPerformAction(actionInContext);\n\n      try {\n        await frame.instrumentation.onBeforeCall(frame, callMetadata);\n        await cb(callMetadata);\n      } catch (e) {\n        callMetadata.endTime = monotonicTime();\n        await frame.instrumentation.onAfterCall(frame, callMetadata);\n        this._generator.performedActionFailed(actionInContext);\n        return;\n      }\n\n      callMetadata.endTime = monotonicTime();\n      await frame.instrumentation.onAfterCall(frame, callMetadata);\n\n      const timer = setTimeout(() => {\n        // Commit the action after 5 seconds so that no further signals are added to it.\n        actionInContext.committed = true;\n        this._timers.delete(timer);\n      }, 5000);\n      this._generator.didPerformAction(actionInContext);\n      this._timers.add(timer);\n    };\n\n    const kActionTimeout = 5000;\n    if (action.name === 'click') {\n      const { options } = toClickOptions(action);\n      await perform('click', { selector: action.selector }, callMetadata => frame.click(callMetadata, action.selector, { ...options, timeout: kActionTimeout }));\n    }\n    if (action.name === 'press') {\n      const modifiers = toModifiers(action.modifiers);\n      const shortcut = [...modifiers, action.key].join('+');\n      await perform('press', { selector: action.selector, key: shortcut }, callMetadata => frame.press(callMetadata, action.selector, shortcut, { timeout: kActionTimeout }));\n    }\n    if (action.name === 'check')\n      await perform('check', { selector: action.selector }, callMetadata => frame.check(callMetadata, action.selector, { timeout: kActionTimeout }));\n    if (action.name === 'uncheck')\n      await perform('uncheck', { selector: action.selector }, callMetadata => frame.uncheck(callMetadata, action.selector, { timeout: kActionTimeout }));\n    if (action.name === 'select') {\n      const values = action.options.map(value => ({ value }));\n      await perform('selectOption', { selector: action.selector, values }, callMetadata => frame.selectOption(callMetadata, action.selector, [], values, { timeout: kActionTimeout }));\n    }\n  }\n\n  private async _recordAction(frame: Frame, action: actions.Action) {\n    // Commit last action so that no further signals are added to it.\n    this._generator.commitLastAction();\n\n    this._generator.addAction({\n      pageAlias: this._pageAliases.get(frame._page)!,\n      ...describeFrame(frame),\n      action\n    });\n  }\n\n  private _onFrameNavigated(frame: Frame, page: Page) {\n    const pageAlias = this._pageAliases.get(page);\n    this._generator.signal(pageAlias!, frame, { name: 'navigation', url: frame.url() });\n  }\n\n  private _onPopup(page: Page, popup: Page) {\n    const pageAlias = this._pageAliases.get(page)!;\n    const popupAlias = this._pageAliases.get(popup)!;\n    this._generator.signal(pageAlias, page.mainFrame(), { name: 'popup', popupAlias });\n  }\n  private _onDownload(page: Page) {\n    const pageAlias = this._pageAliases.get(page)!;\n    this._generator.signal(pageAlias, page.mainFrame(), { name: 'download', downloadAlias: String(++this._lastDownloadOrdinal) });\n  }\n\n  private _onDialog(page: Page) {\n    const pageAlias = this._pageAliases.get(page)!;\n    this._generator.signal(pageAlias, page.mainFrame(), { name: 'dialog', dialogAlias: String(++this._lastDialogOrdinal) });\n  }\n\n  async onBeforeCall(sdkObject: SdkObject, metadata: CallMetadata) {\n    if (this._mode === 'recording')\n      return;\n    this._currentCallsMetadata.set(metadata, sdkObject);\n    this._allMetadatas.set(metadata.id, metadata);\n    this._updateUserSources();\n    this.updateCallLog([metadata]);\n    if (metadata.params && metadata.params.selector) {\n      this._highlightedSelector = metadata.params.selector;\n      this._recorderApp?.setSelector(this._highlightedSelector).catch(() => {});\n    }\n  }\n\n  async onAfterCall(sdkObject: SdkObject, metadata: CallMetadata) {\n    if (this._mode === 'recording')\n      return;\n    if (!metadata.error)\n      this._currentCallsMetadata.delete(metadata);\n    this._updateUserSources();\n    this.updateCallLog([metadata]);\n  }\n\n  private _updateUserSources() {\n    // Remove old decorations.\n    for (const source of this._userSources.values()) {\n      source.highlight = [];\n      source.revealLine = undefined;\n    }\n\n    // Apply new decorations.\n    let fileToSelect = undefined;\n    for (const metadata of this._currentCallsMetadata.keys()) {\n      if (!metadata.stack || !metadata.stack[0])\n        continue;\n      const { file, line } = metadata.stack[0];\n      let source = this._userSources.get(file);\n      if (!source) {\n        source = { file, text: this._readSource(file), highlight: [], language: languageForFile(file) };\n        this._userSources.set(file, source);\n      }\n      if (line) {\n        const paused = this._debugger.isPaused(metadata);\n        source.highlight.push({ line, type: metadata.error ? 'error' : (paused ? 'paused' : 'running') });\n        source.revealLine = line;\n        fileToSelect = source.file;\n      }\n    }\n    this._pushAllSources();\n    if (fileToSelect)\n      this._recorderApp?.setFile(fileToSelect);\n  }\n\n  private _pushAllSources() {\n    this._recorderApp?.setSources([...this._recorderSources, ...this._userSources.values()]);\n  }\n\n  async onBeforeInputAction(sdkObject: SdkObject, metadata: CallMetadata) {\n  }\n\n  async onCallLog(logName: string, message: string, sdkObject: SdkObject, metadata: CallMetadata): Promise<void> {\n    this.updateCallLog([metadata]);\n  }\n\n  updateCallLog(metadatas: CallMetadata[]) {\n    if (this._mode === 'recording')\n      return;\n    const logs: CallLog[] = [];\n    for (const metadata of metadatas) {\n      if (!metadata.method)\n        continue;\n      let status: CallLogStatus = 'done';\n      if (this._currentCallsMetadata.has(metadata))\n        status = 'in-progress';\n      if (this._debugger.isPaused(metadata))\n        status = 'paused';\n      logs.push(metadataToCallLog(metadata, status));\n    }\n    this._recorderApp?.updateCallLogs(logs);\n  }\n\n  private _readSource(fileName: string): string {\n    try {\n      return fs.readFileSync(fileName, 'utf-8');\n    } catch (e) {\n      return '// No source available';\n    }\n  }\n}\n\nfunction languageForFile(file: string) {\n  if (file.endsWith('.py'))\n    return 'python';\n  if (file.endsWith('.java'))\n    return 'java';\n  if (file.endsWith('.cs'))\n    return 'csharp';\n  return 'javascript';\n}\n"],"file":"recorderSupplement.js"}