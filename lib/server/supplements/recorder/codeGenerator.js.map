{"version":3,"sources":["../../../../src/server/supplements/recorder/codeGenerator.ts"],"names":["CodeGenerator","EventEmitter","constructor","browserName","generateHeaders","launchOptions","contextOptions","deviceName","saveStorage","actionListener","_currentAction","_lastAction","_actions","_enabled","_options","headless","restart","emit","setEnabled","enabled","addAction","action","willPerformAction","didPerformAction","performedActionFailed","actionInContext","pageAlias","eraseLastAction","lastAction","name","selector","clickCount","url","pop","push","commitLastAction","committed","signal","frame","acceptDownloads","signals","length","isAsync","generateText","languageGenerator","text","generateHeader","actionText","generateAction","generateFooter","join"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EventEmitter } from 'events';\nimport type { BrowserContextOptions, LaunchOptions } from '../../../..';\nimport { Frame } from '../../frames';\nimport { LanguageGenerator, LanguageGeneratorOptions } from './language';\nimport { Action, Signal } from './recorderActions';\nimport { describeFrame } from './utils';\n\nexport type ActionInContext = {\n  pageAlias: string;\n  frameName?: string;\n  frameUrl: string;\n  isMainFrame: boolean;\n  action: Action;\n  committed?: boolean;\n};\n\nexport class CodeGenerator extends EventEmitter {\n  private _currentAction: ActionInContext | null = null;\n  private _lastAction: ActionInContext | null = null;\n  private _actions: ActionInContext[] = [];\n  private _enabled: boolean;\n  private _options: LanguageGeneratorOptions;\n\n  constructor(browserName: string, generateHeaders: boolean, launchOptions: LaunchOptions, contextOptions: BrowserContextOptions, deviceName: string | undefined, saveStorage: string | undefined, actionListener: EventEmitter | undefined) {\n    super();\n\n    // Make a copy of options to modify them later.\n    launchOptions = { headless: false, ...launchOptions };\n    contextOptions = { ...contextOptions };\n    this._enabled = generateHeaders;\n    this._options = { browserName, generateHeaders, launchOptions, contextOptions, deviceName, saveStorage, actionListener };\n    this.restart();\n  }\n\n  restart() {\n    this._currentAction = null;\n    this._lastAction = null;\n    this._actions = [];\n    this.emit('change');\n  }\n\n  setEnabled(enabled: boolean) {\n    this._enabled = enabled;\n  }\n\n  addAction(action: ActionInContext) {\n    if (!this._enabled)\n      return;\n    this.willPerformAction(action);\n    this.didPerformAction(action);\n  }\n\n  willPerformAction(action: ActionInContext) {\n    if (!this._enabled)\n      return;\n    this._currentAction = action;\n  }\n\n  performedActionFailed(action: ActionInContext) {\n    if (!this._enabled)\n      return;\n    if (this._currentAction === action)\n      this._currentAction = null;\n  }\n\n  didPerformAction(actionInContext: ActionInContext) {\n    if (!this._enabled)\n      return;\n    const { action, pageAlias } = actionInContext;\n    let eraseLastAction = false;\n    if (this._lastAction && this._lastAction.pageAlias === pageAlias) {\n      const { action: lastAction } = this._lastAction;\n      // We augment last action based on the type.\n      if (this._lastAction && action.name === 'fill' && lastAction.name === 'fill') {\n        if (action.selector === lastAction.selector)\n          eraseLastAction = true;\n      }\n      if (lastAction && action.name === 'click' && lastAction.name === 'click') {\n        if (action.selector === lastAction.selector && action.clickCount > lastAction.clickCount)\n          eraseLastAction = true;\n      }\n      if (lastAction && action.name === 'navigate' && lastAction.name === 'navigate') {\n        if (action.url === lastAction.url) {\n          // Already at a target URL.\n          this._currentAction = null;\n          return;\n        }\n      }\n      // Check and uncheck erase click.\n      if (lastAction && (action.name === 'check' || action.name === 'uncheck') && lastAction.name === 'click') {\n        if (action.selector === lastAction.selector)\n          eraseLastAction = true;\n      }\n    }\n\n    this._lastAction = actionInContext;\n    this._currentAction = null;\n    if (eraseLastAction)\n      this._actions.pop();\n    this._actions.push(actionInContext);\n    this.emit('change');\n    this._options.actionListener?.emit('actions', this._actions);\n  }\n\n  commitLastAction() {\n    if (!this._enabled)\n      return;\n    const action = this._lastAction;\n    if (action)\n      action.committed = true;\n  }\n\n  signal(pageAlias: string, frame: Frame, signal: Signal) {\n    if (!this._enabled)\n      return;\n\n    // We'll need to pass acceptDownloads for any generated downloads code to work.\n    if (signal.name === 'download')\n      this._options.contextOptions.acceptDownloads = true;\n\n    // Signal either arrives while action is being performed or shortly after.\n    if (this._currentAction) {\n      this._currentAction.action.signals.push(signal);\n      return;\n    }\n    if (this._lastAction && !this._lastAction.committed) {\n      const signals = this._lastAction.action.signals;\n      if (signal.name === 'navigation' && signals.length && signals[signals.length - 1].name === 'download')\n        return;\n      if (signal.name === 'download' && signals.length && signals[signals.length - 1].name === 'navigation')\n        signals.length = signals.length - 1;\n      signal.isAsync = true;\n      this._lastAction.action.signals.push(signal);\n      this.emit('change');\n      this._options.actionListener?.emit('actions', this._actions);\n      return;\n    }\n\n    if (signal.name === 'navigation') {\n      this.addAction({\n        pageAlias,\n        ...describeFrame(frame),\n        committed: true,\n        action: {\n          name: 'navigate',\n          url: frame.url(),\n          signals: [],\n        },\n      });\n    }\n  }\n\n  generateText(languageGenerator: LanguageGenerator) {\n    const text = [];\n    if (this._options.generateHeaders)\n      text.push(languageGenerator.generateHeader(this._options));\n    for (const action of this._actions) {\n      const actionText = languageGenerator.generateAction(action);\n      if (actionText)\n        text.push(actionText);\n    }\n    if (this._options.generateHeaders)\n      text.push(languageGenerator.generateFooter(this._options.saveStorage));\n    return text.join('\\n');\n  }\n}\n"],"file":"codeGenerator.js"}