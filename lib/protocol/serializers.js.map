{"version":3,"sources":["../../src/protocol/serializers.ts"],"names":["serializeError","e","isError","error","message","stack","name","value","serializeValue","fallThrough","Set","parseError","undefined","Error","parseSerializedValue","TimeoutError","handles","n","s","b","v","NaN","Infinity","d","Date","r","RegExp","p","f","a","map","o","result","k","h","handleSerializer","visited","handle","has","Object","is","global","isDate","toJSON","isRegExp","source","flags","Array","isArray","add","i","length","push","delete","keys","obj","prototype","toString","call","__proto__"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { TimeoutError } from '../utils/errors';\nimport { SerializedError, SerializedValue } from './channels';\n\nexport function serializeError(e: any): SerializedError {\n  if (isError(e))\n    return { error: { message: e.message, stack: e.stack, name: e.name } };\n  return { value: serializeValue(e, value => ({ fallThrough: value }), new Set()) };\n}\n\nexport function parseError(error: SerializedError): Error {\n  if (!error.error) {\n    if (error.value === undefined)\n      throw new Error('Serialized error must have either an error or a value');\n    return parseSerializedValue(error.value, undefined);\n  }\n  if (error.error.name === 'TimeoutError') {\n    const e = new TimeoutError(error.error.message);\n    e.stack = error.error.stack || '';\n    return e;\n  }\n  const e = new Error(error.error.message);\n  e.stack = error.error.stack || '';\n  e.name = error.error.name;\n  return e;\n}\n\nexport function parseSerializedValue(value: SerializedValue, handles: any[] | undefined): any {\n  if (value.n !== undefined)\n    return value.n;\n  if (value.s !== undefined)\n    return value.s;\n  if (value.b !== undefined)\n    return value.b;\n  if (value.v !== undefined) {\n    if (value.v === 'undefined')\n      return undefined;\n    if (value.v === 'null')\n      return null;\n    if (value.v === 'NaN')\n      return NaN;\n    if (value.v === 'Infinity')\n      return Infinity;\n    if (value.v === '-Infinity')\n      return -Infinity;\n    if (value.v === '-0')\n      return -0;\n  }\n  if (value.d !== undefined)\n    return new Date(value.d);\n  if (value.r !== undefined)\n    return new RegExp(value.r.p, value.r.f);\n  if (value.a !== undefined)\n    return value.a.map((a: any) => parseSerializedValue(a, handles));\n  if (value.o !== undefined) {\n    const result: any = {};\n    for (const { k, v } of value.o)\n      result[k] = parseSerializedValue(v, handles);\n    return result;\n  }\n  if (value.h !== undefined) {\n    if (handles === undefined)\n      throw new Error('Unexpected handle');\n    return handles[value.h];\n  }\n  throw new Error('Unexpected value');\n}\n\nexport type HandleOrValue = { h: number } | { fallThrough: any };\nexport function serializeValue(value: any, handleSerializer: (value: any) => HandleOrValue, visited: Set<any>): SerializedValue {\n  const handle = handleSerializer(value);\n  if ('fallThrough' in handle)\n    value = handle.fallThrough;\n  else\n    return handle;\n\n  if (visited.has(value))\n    throw new Error('Argument is a circular structure');\n  if (typeof value === 'symbol')\n    return { v: 'undefined' };\n  if (Object.is(value, undefined))\n    return { v: 'undefined' };\n  if (Object.is(value, null))\n    return { v: 'null' };\n  if (Object.is(value, NaN))\n    return { v: 'NaN' };\n  if (Object.is(value, Infinity))\n    return { v: 'Infinity' };\n  if (Object.is(value, -Infinity))\n    return { v: '-Infinity' };\n  if (Object.is(value, -0))\n    return { v: '-0' };\n  if (typeof value === 'boolean')\n    return { b: value };\n  if (typeof value === 'number')\n    return { n: value };\n  if (typeof value === 'string')\n    return { s: value };\n  if (isError(value)) {\n    const error = value;\n    if ('captureStackTrace' in global.Error) {\n      // v8\n      return { s: error.stack || '' };\n    }\n    return { s: `${error.name}: ${error.message}\\n${error.stack}` };\n  }\n  if (isDate(value))\n    return { d: value.toJSON() };\n  if (isRegExp(value))\n    return { r: { p: value.source, f: value.flags } };\n  if (Array.isArray(value)) {\n    const a = [];\n    visited.add(value);\n    for (let i = 0; i < value.length; ++i)\n      a.push(serializeValue(value[i], handleSerializer, visited));\n    visited.delete(value);\n    return { a };\n  }\n  if (typeof value === 'object') {\n    const o: { k: string, v: SerializedValue }[] = [];\n    visited.add(value);\n    for (const name of Object.keys(value))\n      o.push({ k: name, v: serializeValue(value[name], handleSerializer, visited) });\n    visited.delete(value);\n    return { o };\n  }\n  throw new Error('Unexpected value');\n}\n\nfunction isRegExp(obj: any): obj is RegExp {\n  return obj instanceof RegExp || Object.prototype.toString.call(obj) === '[object RegExp]';\n}\n\nfunction isDate(obj: any): obj is Date {\n  return obj instanceof Date || Object.prototype.toString.call(obj) === '[object Date]';\n}\n\nfunction isError(obj: any): obj is Error {\n  return obj instanceof Error || obj?.__proto__?.name === 'Error' || (obj?.__proto__ && isError(obj.__proto__));\n}\n"],"file":"serializers.js"}