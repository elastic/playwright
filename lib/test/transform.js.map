{"version":3,"sources":["../../src/test/transform.ts"],"names":["version","cacheDir","process","env","PWTEST_CACHE_DIR","path","join","os","tmpdir","sourceMaps","Map","kStackTraceLimit","Error","stackTraceLimit","sourceMapSupport","install","environment","handleUncaughtExceptions","retrieveSourceMap","source","has","sourceMapPath","get","fs","existsSync","map","JSON","parse","readFileSync","url","calculateCachePath","content","filePath","hash","crypto","createHash","update","String","digest","fileName","basename","extname","replace","installTransform","pirates","addHook","code","filename","cachePath","codePath","set","BROWSERSLIST_IGNORE_OLD_DATA","babel","require","result","transformFileSync","babelrc","configFile","assumptions","setPublicClassFields","presets","resolve","onlyRemoveTypeImports","plugins","mkdirSync","dirname","recursive","writeFileSync","stringify","exts","wrapFunctionWithLocation","func","args","oldPrepareStackTrace","prepareStackTrace","error","stackFrames","frame","wrapCallSite","getFileName","file","startsWith","fileURLToPath","line","getLineNumber","column","getColumnNumber","obj","captureStackTrace","location","stack"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as crypto from 'crypto';\nimport * as os from 'os';\nimport * as path from 'path';\nimport * as fs from 'fs';\nimport * as pirates from 'pirates';\nimport * as sourceMapSupport from 'source-map-support';\nimport * as url from 'url';\nimport type { Location } from './types';\n\nconst version = 4;\nconst cacheDir = process.env.PWTEST_CACHE_DIR || path.join(os.tmpdir(), 'playwright-transform-cache');\nconst sourceMaps: Map<string, string> = new Map();\n\nconst kStackTraceLimit = 15;\nError.stackTraceLimit = kStackTraceLimit;\n\nsourceMapSupport.install({\n  environment: 'node',\n  handleUncaughtExceptions: false,\n  retrieveSourceMap(source) {\n    if (!sourceMaps.has(source))\n      return null;\n    const sourceMapPath = sourceMaps.get(source)!;\n    if (!fs.existsSync(sourceMapPath))\n      return null;\n    return {\n      map: JSON.parse(fs.readFileSync(sourceMapPath, 'utf-8')),\n      url: source\n    };\n  }\n});\n\nfunction calculateCachePath(content: string, filePath: string): string {\n  const hash = crypto.createHash('sha1').update(content).update(filePath).update(String(version)).digest('hex');\n  const fileName = path.basename(filePath, path.extname(filePath)).replace(/\\W/g, '') + '_' + hash;\n  return path.join(cacheDir, hash[0] + hash[1], fileName);\n}\n\nexport function installTransform(): () => void {\n  return pirates.addHook((code, filename) => {\n    const cachePath = calculateCachePath(code, filename);\n    const codePath = cachePath + '.js';\n    const sourceMapPath = cachePath + '.map';\n    sourceMaps.set(filename, sourceMapPath);\n    if (fs.existsSync(codePath))\n      return fs.readFileSync(codePath, 'utf8');\n    // We don't use any browserslist data, but babel checks it anyway.\n    // Silence the annoying warning.\n    process.env.BROWSERSLIST_IGNORE_OLD_DATA = 'true';\n    const babel: typeof import('@babel/core') = require('@babel/core');\n    const result = babel.transformFileSync(filename, {\n      babelrc: false,\n      configFile: false,\n      assumptions: {\n        // Without this, babel defines a top level function that\n        // breaks playwright evaluates.\n        setPublicClassFields: true,\n      },\n      presets: [\n        [require.resolve('@babel/preset-typescript'), { onlyRemoveTypeImports: true }],\n      ],\n      plugins: [\n        [require.resolve('@babel/plugin-proposal-class-properties')],\n        [require.resolve('@babel/plugin-proposal-numeric-separator')],\n        [require.resolve('@babel/plugin-proposal-logical-assignment-operators')],\n        [require.resolve('@babel/plugin-proposal-nullish-coalescing-operator')],\n        [require.resolve('@babel/plugin-proposal-optional-chaining')],\n        [require.resolve('@babel/plugin-syntax-json-strings')],\n        [require.resolve('@babel/plugin-syntax-optional-catch-binding')],\n        [require.resolve('@babel/plugin-syntax-async-generators')],\n        [require.resolve('@babel/plugin-syntax-object-rest-spread')],\n        [require.resolve('@babel/plugin-proposal-export-namespace-from')],\n        [require.resolve('@babel/plugin-transform-modules-commonjs')],\n        [require.resolve('@babel/plugin-proposal-dynamic-import')],\n      ],\n      sourceMaps: 'both',\n    } as babel.TransformOptions)!;\n    if (result.code) {\n      fs.mkdirSync(path.dirname(cachePath), {recursive: true});\n      if (result.map)\n        fs.writeFileSync(sourceMapPath, JSON.stringify(result.map), 'utf8');\n      fs.writeFileSync(codePath, result.code, 'utf8');\n    }\n    return result.code || '';\n  }, {\n    exts: ['.ts']\n  });\n}\n\nexport function wrapFunctionWithLocation<A extends any[], R>(func: (location: Location, ...args: A) => R): (...args: A) => R {\n  return (...args) => {\n    const oldPrepareStackTrace = Error.prepareStackTrace;\n    Error.prepareStackTrace = (error, stackFrames) => {\n      const frame: NodeJS.CallSite = sourceMapSupport.wrapCallSite(stackFrames[1]);\n      const fileName = frame.getFileName();\n      // Node error stacks for modules use file:// urls instead of paths.\n      const file = (fileName && fileName.startsWith('file://')) ? url.fileURLToPath(fileName) : fileName;\n      return {\n        file,\n        line: frame.getLineNumber(),\n        column: frame.getColumnNumber(),\n      };\n    };\n    Error.stackTraceLimit = 2;\n    const obj: { stack: Location } = {} as any;\n    Error.captureStackTrace(obj);\n    const location = obj.stack;\n    Error.stackTraceLimit = kStackTraceLimit;\n    Error.prepareStackTrace = oldPrepareStackTrace;\n    return func(location, ...args);\n  };\n}\n"],"file":"transform.js"}