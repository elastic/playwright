{"version":3,"sources":["../../src/test/util.ts"],"names":["DeadlineRunner","constructor","promise","deadline","_timer","_done","_fulfill","_reject","result","Promise","f","r","then","_finish","catch","e","undefined","setDeadline","success","error","clearTimeout","timeout","monotonicTime","timedOut","setTimeout","raceAgainstDeadline","pollUntilDeadline","testInfo","func","pollTime","deadlinePromise","defaultExpectTimeout","project","expect","aborted","abortedPromise","pollIntervals","attempts","remainingTime","race","errors","TimeoutError","timer","timeoutPromise","serializeError","Error","message","stack","value","util","inspect","seconds","nanoseconds","process","hrtime","isRegExp","RegExp","Object","prototype","toString","call","createMatcher","patterns","reList","filePatterns","pattern","Array","isArray","push","startsWith","re","lastIndex","test","nocase","mergeObjects","a","b","is","name","entries","wrapInPromise","forceRegExp","match","relativeFilePath","file","path","isAbsolute","relative","cwd","formatLocation","location","line","column","errorWithFile","errorWithLocation","expectType","receiver","type","matcherName","sanitizeForFilePath","s","replace"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { TestInfoImpl } from './types';\nimport util from 'util';\nimport path from 'path';\nimport type { TestError, Location } from './types';\nimport { default as minimatch } from 'minimatch';\nimport { errors } from '../..';\n\nexport class DeadlineRunner<T> {\n  private _timer: NodeJS.Timer | undefined;\n  private _done = false;\n  private _fulfill!: (t: { result?: T, timedOut?: boolean }) => void;\n  private _reject!: (error: any) => void;\n\n  readonly result: Promise<{ result?: T, timedOut?: boolean }>;\n\n  constructor(promise: Promise<T>, deadline: number | undefined) {\n    this.result = new Promise((f, r) => {\n      this._fulfill = f;\n      this._reject = r;\n    });\n    promise.then(result => {\n      this._finish({ result });\n    }).catch(e => {\n      this._finish(undefined, e);\n    });\n    this.setDeadline(deadline);\n  }\n\n  private _finish(success?: { result?: T, timedOut?: boolean }, error?: any) {\n    if (this._done)\n      return;\n    this.setDeadline(undefined);\n    if (success)\n      this._fulfill(success);\n    else\n      this._reject(error);\n  }\n\n  setDeadline(deadline: number | undefined) {\n    if (this._timer) {\n      clearTimeout(this._timer);\n      this._timer = undefined;\n    }\n    if (deadline === undefined)\n      return;\n    const timeout = deadline - monotonicTime();\n    if (timeout <= 0)\n      this._finish({ timedOut: true });\n    else\n      this._timer = setTimeout(() => this._finish({ timedOut: true }), timeout);\n  }\n}\n\nexport async function raceAgainstDeadline<T>(promise: Promise<T>, deadline: number | undefined): Promise<{ result?: T, timedOut?: boolean }> {\n  return (new DeadlineRunner(promise, deadline)).result;\n}\n\nexport async function pollUntilDeadline(testInfo: TestInfoImpl, func: (remainingTime: number) => Promise<boolean>, pollTime: number | undefined, deadlinePromise: Promise<void>): Promise<void> {\n  let defaultExpectTimeout = testInfo.project.expect?.timeout;\n  if (typeof defaultExpectTimeout === 'undefined')\n    defaultExpectTimeout = 5000;\n  pollTime = pollTime === 0 ? 0 : pollTime || defaultExpectTimeout;\n  const deadline = pollTime ? monotonicTime() + pollTime : 0;\n\n  let aborted = false;\n  const abortedPromise = deadlinePromise.then(() => {\n    aborted = true;\n    return true;\n  });\n\n  const pollIntervals = [100, 250, 500];\n  let attempts = 0;\n  while (!aborted) {\n    const remainingTime = deadline ? deadline - monotonicTime() : 1000 * 3600 * 24;\n    if (remainingTime <= 0)\n      break;\n\n    try {\n      // Either aborted, or func() returned truthy.\n      const result = await Promise.race([\n        func(remainingTime),\n        abortedPromise,\n      ]);\n      if (result)\n        return;\n    } catch (e) {\n      if (e instanceof errors.TimeoutError)\n        return;\n      throw e;\n    }\n\n    let timer: NodeJS.Timer;\n    const timeoutPromise = new Promise(f => timer = setTimeout(f, pollIntervals[attempts++] || 1000));\n    await Promise.race([abortedPromise, timeoutPromise]);\n    clearTimeout(timer!);\n  }\n}\n\n\nexport function serializeError(error: Error | any): TestError {\n  if (error instanceof Error) {\n    return {\n      message: error.message,\n      stack: error.stack\n    };\n  }\n  return {\n    value: util.inspect(error)\n  };\n}\n\nexport function monotonicTime(): number {\n  const [seconds, nanoseconds] = process.hrtime();\n  return seconds * 1000 + (nanoseconds / 1000000 | 0);\n}\n\nexport function isRegExp(e: any): e is RegExp {\n  return e && typeof e === 'object' && (e instanceof RegExp || Object.prototype.toString.call(e) === '[object RegExp]');\n}\n\nexport type Matcher = (value: string) => boolean;\n\nexport type FilePatternFilter = {\n  re: RegExp;\n  line: number | null;\n};\n\nexport function createMatcher(patterns: string | RegExp | (string | RegExp)[]): Matcher {\n  const reList: RegExp[] = [];\n  const filePatterns: string[] = [];\n  for (const pattern of Array.isArray(patterns) ? patterns : [patterns]) {\n    if (isRegExp(pattern)) {\n      reList.push(pattern);\n    } else {\n      if (!pattern.startsWith('**/') && !pattern.startsWith('**/'))\n        filePatterns.push('**/' + pattern);\n      else\n        filePatterns.push(pattern);\n    }\n  }\n\n  return (value: string) => {\n    for (const re of reList) {\n      re.lastIndex = 0;\n      if (re.test(value))\n        return true;\n    }\n    for (const pattern of filePatterns) {\n      if (minimatch(value, pattern, {\n        nocase: true,\n      }))\n        return true;\n    }\n    return false;\n  };\n}\n\nexport function mergeObjects<A extends object, B extends object>(a: A | undefined | void, b: B | undefined | void): A & B {\n  const result = { ...a } as any;\n  if (!Object.is(b, undefined)) {\n    for (const [name, value] of Object.entries(b as B)) {\n      if (!Object.is(value, undefined))\n        result[name] = value;\n    }\n  }\n  return result as any;\n}\n\nexport async function wrapInPromise(value: any) {\n  return value;\n}\n\nexport function forceRegExp(pattern: string): RegExp {\n  const match = pattern.match(/^\\/(.*)\\/([gi]*)$/);\n  if (match)\n    return new RegExp(match[1], match[2]);\n  return new RegExp(pattern, 'g');\n}\n\nexport function relativeFilePath(file: string): string {\n  if (!path.isAbsolute(file))\n    return file;\n  return path.relative(process.cwd(), file);\n}\n\nexport function formatLocation(location: Location) {\n  return relativeFilePath(location.file) + ':' + location.line + ':' + location.column;\n}\n\nexport function errorWithFile(file: string, message: string) {\n  return new Error(`${relativeFilePath(file)}: ${message}`);\n}\n\nexport function errorWithLocation(location: Location, message: string) {\n  return new Error(`${formatLocation(location)}: ${message}`);\n}\n\nexport function expectType(receiver: any, type: string, matcherName: string) {\n  if (typeof receiver !== 'object' || receiver.constructor.name !== type)\n    throw new Error(`${matcherName} can be only used with ${type} object`);\n}\n\nexport function sanitizeForFilePath(s: string) {\n  return s.replace(/[\\x00-\\x2F\\x3A-\\x40\\x5B-\\x60\\x7B-\\x7F]+/g, '-');\n}\n"],"file":"util.js"}