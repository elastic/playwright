{"version":3,"sources":["../../src/test/index.ts"],"names":["_baseTest","rootTestType","test","extend","defaultBrowserType","scope","browserName","use","playwright","require","headless","undefined","channel","launchOptions","screenshot","video","trace","_artifactsDir","workerInfo","dir","path","join","project","outputDir","workerIndex","fs","mkdirSync","recursive","_browserType","includes","Error","browserType","options","handleSIGINT","timeout","_defaultLaunchOptions","browser","launch","close","acceptDownloads","bypassCSP","colorScheme","deviceScaleFactor","extraHTTPHeaders","geolocation","hasTouch","httpCredentials","ignoreHTTPSErrors","isMobile","javaScriptEnabled","locale","offline","permissions","proxy","storageState","timezoneId","userAgent","viewport","actionTimeout","navigationTimeout","baseURL","process","env","PLAYWRIGHT_TEST_BASE_URL","contextOptions","_combinedContextOptions","_setupContextOptionsAndArtifacts","testInfo","snapshotSuffix","platform","PWDEBUG","setTimeout","captureTrace","retry","temporaryTraceFiles","temporaryScreenshots","onDidCreateContext","context","setDefaultTimeout","setDefaultNavigationTimeout","tracing","start","screenshots","snapshots","stop","_csi","onApiCall","name","_addStep","onWillCloseContext","tracePath","push","_export","Promise","all","pages","map","page","screenshotPath","catch","oldOnDidCreateContext","_onDidCreateContext","_onWillCloseContext","_defaultContextOptions","existingContexts","Array","from","_contexts","testFailed","status","expectedStatus","isHook","title","preserveTrace","captureScreenshots","traceAttachments","addTraceAttachment","outputPath","length","attachments","contentType","screenshotAttachments","addScreenshotAttachment","leftoverContexts","forEach","file","promises","rename","unlink","auto","videoMode","mode","captureVideo","videoOptions","recordVideo","size","newContext","allPages","on","prependToError","formatPendingCalls","_connection","pendingProtocolCalls","error","value","message","stack","preserveVideo","v","videoPath","savedPath","basename","saveAs","e","newPage","calls","call","frame","formatStackFrame","apiName","relative","cwd","line","column"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as fs from 'fs';\nimport * as path from 'path';\nimport type { LaunchOptions, BrowserContextOptions, Page, BrowserContext, BrowserType } from '../../types/types';\nimport type { TestType, PlaywrightTestArgs, PlaywrightTestOptions, PlaywrightWorkerArgs, PlaywrightWorkerOptions } from '../../types/test';\nimport { rootTestType } from './testType';\nimport { createGuid, removeFolders } from '../utils/utils';\nexport { expect } from './expect';\nexport const _baseTest: TestType<{}, {}> = rootTestType.test;\n\ntype TestFixtures = PlaywrightTestArgs & PlaywrightTestOptions & {\n  _combinedContextOptions: BrowserContextOptions,\n  _setupContextOptionsAndArtifacts: void;\n};\ntype WorkerAndFileFixtures = PlaywrightWorkerArgs & PlaywrightWorkerOptions & {\n  _browserType: BrowserType;\n  _artifactsDir: () => string,\n};\n\nexport const test = _baseTest.extend<TestFixtures, WorkerAndFileFixtures>({\n  defaultBrowserType: [ 'chromium', { scope: 'worker' } ],\n  browserName: [ ({ defaultBrowserType }, use) => use(defaultBrowserType), { scope: 'worker' } ],\n  playwright: [ require('../inprocess'), { scope: 'worker' } ],\n  headless: [ undefined, { scope: 'worker' } ],\n  channel: [ undefined, { scope: 'worker' } ],\n  launchOptions: [ {}, { scope: 'worker' } ],\n  screenshot: [ 'off', { scope: 'worker' } ],\n  video: [ 'off', { scope: 'worker' } ],\n  trace: [ 'off', { scope: 'worker' } ],\n\n  _artifactsDir: [async ({}, use, workerInfo) => {\n    let dir: string | undefined;\n    await use(() => {\n      if (!dir) {\n        dir = path.join(workerInfo.project.outputDir, '.playwright-artifacts-' + workerInfo.workerIndex);\n        fs.mkdirSync(dir, { recursive: true });\n      }\n      return dir;\n    });\n    if (dir)\n      await removeFolders([dir]);\n  }, { scope: 'worker' }],\n\n  _browserType: [async ({ playwright, browserName, headless, channel, launchOptions }, use) => {\n    if (!['chromium', 'firefox', 'webkit'].includes(browserName))\n      throw new Error(`Unexpected browserName \"${browserName}\", must be one of \"chromium\", \"firefox\" or \"webkit\"`);\n    const browserType = playwright[browserName];\n\n    const options: LaunchOptions = {\n      handleSIGINT: false,\n      timeout: 0,\n      ...launchOptions,\n    };\n    if (headless !== undefined)\n      options.headless = headless;\n    if (channel !== undefined)\n      options.channel = channel;\n\n    (browserType as any)._defaultLaunchOptions = options;\n    await use(browserType);\n    (browserType as any)._defaultLaunchOptions = undefined;\n  }, { scope: 'worker' }],\n\n  browser: [ async ({ _browserType }, use) => {\n    const browser = await _browserType.launch();\n    await use(browser);\n    await browser.close();\n  }, { scope: 'worker' } ],\n\n  acceptDownloads: undefined,\n  bypassCSP: undefined,\n  colorScheme: undefined,\n  deviceScaleFactor: undefined,\n  extraHTTPHeaders: undefined,\n  geolocation: undefined,\n  hasTouch: undefined,\n  httpCredentials: undefined,\n  ignoreHTTPSErrors: undefined,\n  isMobile: undefined,\n  javaScriptEnabled: undefined,\n  locale: undefined,\n  offline: undefined,\n  permissions: undefined,\n  proxy: undefined,\n  storageState: undefined,\n  timezoneId: undefined,\n  userAgent: undefined,\n  viewport: undefined,\n  actionTimeout: undefined,\n  navigationTimeout: undefined,\n  baseURL: async ({ }, use) => {\n    await use(process.env.PLAYWRIGHT_TEST_BASE_URL);\n  },\n  contextOptions: {},\n\n  _combinedContextOptions: async ({\n    acceptDownloads,\n    bypassCSP,\n    colorScheme,\n    deviceScaleFactor,\n    extraHTTPHeaders,\n    hasTouch,\n    geolocation,\n    httpCredentials,\n    ignoreHTTPSErrors,\n    isMobile,\n    javaScriptEnabled,\n    locale,\n    offline,\n    permissions,\n    proxy,\n    storageState,\n    viewport,\n    timezoneId,\n    userAgent,\n    baseURL,\n    contextOptions,\n  }, use) => {\n    const options: BrowserContextOptions = {};\n    if (acceptDownloads !== undefined)\n      options.acceptDownloads = acceptDownloads;\n    if (bypassCSP !== undefined)\n      options.bypassCSP = bypassCSP;\n    if (colorScheme !== undefined)\n      options.colorScheme = colorScheme;\n    if (deviceScaleFactor !== undefined)\n      options.deviceScaleFactor = deviceScaleFactor;\n    if (extraHTTPHeaders !== undefined)\n      options.extraHTTPHeaders = extraHTTPHeaders;\n    if (geolocation !== undefined)\n      options.geolocation = geolocation;\n    if (hasTouch !== undefined)\n      options.hasTouch = hasTouch;\n    if (httpCredentials !== undefined)\n      options.httpCredentials = httpCredentials;\n    if (ignoreHTTPSErrors !== undefined)\n      options.ignoreHTTPSErrors = ignoreHTTPSErrors;\n    if (isMobile !== undefined)\n      options.isMobile = isMobile;\n    if (javaScriptEnabled !== undefined)\n      options.javaScriptEnabled = javaScriptEnabled;\n    if (locale !== undefined)\n      options.locale = locale;\n    if (offline !== undefined)\n      options.offline = offline;\n    if (permissions !== undefined)\n      options.permissions = permissions;\n    if (proxy !== undefined)\n      options.proxy = proxy;\n    if (storageState !== undefined)\n      options.storageState = storageState;\n    if (timezoneId !== undefined)\n      options.timezoneId = timezoneId;\n    if (userAgent !== undefined)\n      options.userAgent = userAgent;\n    if (viewport !== undefined)\n      options.viewport = viewport;\n    if (baseURL !== undefined)\n      options.baseURL = baseURL;\n    await use({\n      ...contextOptions,\n      ...options,\n    });\n  },\n\n  _setupContextOptionsAndArtifacts: [async ({ _browserType, _combinedContextOptions, _artifactsDir, trace, screenshot, actionTimeout, navigationTimeout }, use, testInfo) => {\n    testInfo.snapshotSuffix = process.platform;\n    if (process.env.PWDEBUG)\n      testInfo.setTimeout(0);\n\n    if (trace === 'retry-with-trace')\n      trace = 'on-first-retry';\n    const captureTrace = (trace === 'on' || trace === 'retain-on-failure' || (trace === 'on-first-retry' && testInfo.retry === 1));\n    const temporaryTraceFiles: string[] = [];\n    const temporaryScreenshots: string[] = [];\n\n    const onDidCreateContext = async (context: BrowserContext) => {\n      context.setDefaultTimeout(actionTimeout || 0);\n      context.setDefaultNavigationTimeout(navigationTimeout || actionTimeout || 0);\n      if (captureTrace)\n        await context.tracing.start({ screenshots: true, snapshots: true });\n      else\n        await context.tracing.stop();\n      (context as any)._csi = {\n        onApiCall: (name: string) => {\n          return (testInfo as any)._addStep('pw:api', name);\n        },\n      };\n    };\n\n    const onWillCloseContext = async (context: BrowserContext) => {\n      if (captureTrace) {\n        // Export trace for now. We'll know whether we have to preserve it\n        // after the test finishes.\n        const tracePath = path.join(_artifactsDir(), createGuid() + '.zip');\n        temporaryTraceFiles.push(tracePath);\n        await (context.tracing as any)._export({ path: tracePath });\n      }\n      if (screenshot === 'on' || screenshot === 'only-on-failure') {\n        // Capture screenshot for now. We'll know whether we have to preserve them\n        // after the test finishes.\n        await Promise.all(context.pages().map(async page => {\n          const screenshotPath = path.join(_artifactsDir(), createGuid() + '.png');\n          temporaryScreenshots.push(screenshotPath);\n          await page.screenshot({ timeout: 5000, path: screenshotPath }).catch(() => {});\n        }));\n      }\n    };\n\n    // 1. Setup instrumentation and process existing contexts.\n    const oldOnDidCreateContext = (_browserType as any)._onDidCreateContext;\n    (_browserType as any)._onDidCreateContext = onDidCreateContext;\n    (_browserType as any)._onWillCloseContext = onWillCloseContext;\n    (_browserType as any)._defaultContextOptions = _combinedContextOptions;\n    const existingContexts = Array.from((_browserType as any)._contexts) as BrowserContext[];\n    await Promise.all(existingContexts.map(onDidCreateContext));\n\n    // 2. Run the test.\n    await use();\n\n    // 3. Determine whether we need the artifacts.\n    const testFailed = testInfo.status !== testInfo.expectedStatus;\n    const isHook = testInfo.title === 'beforeAll' || testInfo.title === 'afterAll';\n    const preserveTrace = captureTrace && !isHook && (trace === 'on' || (testFailed && trace === 'retain-on-failure') || (trace === 'on-first-retry' && testInfo.retry === 1));\n    const captureScreenshots = !isHook && (screenshot === 'on' || (screenshot === 'only-on-failure' && testFailed));\n\n    const traceAttachments: string[] = [];\n    const addTraceAttachment = () => {\n      const tracePath = testInfo.outputPath(`trace${traceAttachments.length ? '-' + traceAttachments.length : ''}.zip`);\n      traceAttachments.push(tracePath);\n      testInfo.attachments.push({ name: 'trace', path: tracePath, contentType: 'application/zip' });\n      return tracePath;\n    };\n\n    const screenshotAttachments: string[] = [];\n    const addScreenshotAttachment = () => {\n      const screenshotPath = testInfo.outputPath(`test-${testFailed ? 'failed' : 'finished'}-${screenshotAttachments.length + 1}.png`);\n      screenshotAttachments.push(screenshotPath);\n      testInfo.attachments.push({ name: 'screenshot', path: screenshotPath, contentType: 'image/png' });\n      return screenshotPath;\n    };\n\n    // 4. Cleanup instrumentation.\n    const leftoverContexts = Array.from((_browserType as any)._contexts) as BrowserContext[];\n    (_browserType as any)._onDidCreateContext = oldOnDidCreateContext;\n    (_browserType as any)._onWillCloseContext = undefined;\n    (_browserType as any)._defaultContextOptions = undefined;\n    leftoverContexts.forEach(context => (context as any)._csi = undefined);\n\n    // 5. Collect artifacts from any non-closed contexts.\n    await Promise.all(leftoverContexts.map(async context => {\n      if (preserveTrace)\n        await (context.tracing as any)._export({ path: addTraceAttachment() });\n      if (captureScreenshots)\n        await Promise.all(context.pages().map(page => page.screenshot({ timeout: 5000, path: addScreenshotAttachment() }).catch(() => {})));\n    }));\n\n    // 6. Either remove or attach temporary traces and screenshots for contexts closed\n    // before the test has finished.\n    await Promise.all(temporaryTraceFiles.map(async file => {\n      if (preserveTrace)\n        await fs.promises.rename(file, addTraceAttachment()).catch(() => {});\n      else\n        await fs.promises.unlink(file).catch(() => {});\n    }));\n    await Promise.all(temporaryScreenshots.map(async file => {\n      if (captureScreenshots)\n        await fs.promises.rename(file, addScreenshotAttachment()).catch(() => {});\n      else\n        await fs.promises.unlink(file).catch(() => {});\n    }));\n  }, { auto: true }],\n\n  context: async ({ browser, video, _artifactsDir }, use, testInfo) => {\n    if (testInfo.title === 'beforeAll' || testInfo.title === 'afterAll')\n      throw new Error(`\"context\" and \"page\" fixtures are not suppoted in ${testInfo.title}. Use browser.newContext() instead.`);\n\n    let videoMode = typeof video === 'string' ? video : video.mode;\n    if (videoMode === 'retry-with-video')\n      videoMode = 'on-first-retry';\n\n    const captureVideo = (videoMode === 'on' || videoMode === 'retain-on-failure' || (videoMode === 'on-first-retry' && testInfo.retry === 1));\n    const videoOptions: BrowserContextOptions = captureVideo ? {\n      recordVideo: {\n        dir: _artifactsDir(),\n        size: typeof video === 'string' ? undefined : video.size,\n      }\n    } : {};\n    const context = await browser.newContext(videoOptions);\n\n    const allPages: Page[] = [];\n    context.on('page', page => allPages.push(page));\n\n    await use(context);\n\n    const prependToError = testInfo.status === 'timedOut' ?\n      formatPendingCalls((context as any)._connection.pendingProtocolCalls()) : '';\n    await context.close();\n    if (prependToError) {\n      if (!testInfo.error) {\n        testInfo.error = { value: prependToError };\n      } else if (testInfo.error.message) {\n        testInfo.error.message = prependToError + testInfo.error.message;\n        if (testInfo.error.stack)\n          testInfo.error.stack = prependToError + testInfo.error.stack;\n      }\n    }\n\n    const testFailed = testInfo.status !== testInfo.expectedStatus;\n    const preserveVideo = captureVideo && (videoMode === 'on' || (testFailed && videoMode === 'retain-on-failure') || (videoMode === 'on-first-retry' && testInfo.retry === 1));\n    if (preserveVideo) {\n      await Promise.all(allPages.map(async page => {\n        const v = page.video();\n        if (!v)\n          return;\n        try {\n          const videoPath = await v.path();\n          const savedPath = testInfo.outputPath(path.basename(videoPath));\n          await v.saveAs(savedPath);\n          testInfo.attachments.push({ name: 'video', path: savedPath, contentType: 'video/webm' });\n        } catch (e) {\n          // Silent catch empty videos.\n        }\n      }));\n    }\n  },\n\n  page: async ({ context }, use) => {\n    await use(await context.newPage());\n  },\n});\nexport default test;\n\nfunction formatPendingCalls(calls: ProtocolCall[]) {\n  if (!calls.length)\n    return '';\n  return 'Pending operations:\\n' + calls.map(call => {\n    const frame = call.stack && call.stack[0] ? formatStackFrame(call.stack[0]) : '<unknown>';\n    return `  - ${call.apiName} at ${frame}\\n`;\n  }).join('') + '\\n';\n}\n\nfunction formatStackFrame(frame: StackFrame) {\n  const file = path.relative(process.cwd(), frame.file) || path.basename(frame.file);\n  return `${file}:${frame.line || 1}:${frame.column || 1}`;\n}\n\ntype StackFrame = {\n  file: string,\n  line?: number,\n  column?: number,\n  function?: string,\n};\n\ntype ProtocolCall = {\n  stack?: StackFrame[],\n  apiName?: string,\n};\n"],"file":"index.js"}