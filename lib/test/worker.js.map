{"version":3,"sources":["../../src/test/worker.ts"],"names":["closed","sendMessageToParent","global","console","Console","stdout","process","stderr","colorMode","env","FORCE_COLOR","write","chunk","outPayload","testId","workerRunner","_currentTest","chunkToParams","PW_RUNNER_DEBUG","on","gracefullyCloseAndExit","workerIndex","reason","promise","unhandledError","error","message","method","initParams","params","WorkerRunner","event","bind","runPayload","run","setTimeout","exit","stop","cleanup","undefined","e","send","Buffer","buffer","toString","text","util","inspect"],"mappings":"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","sourcesContent":["/**\n * Copyright Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Console } from 'console';\nimport * as util from 'util';\nimport { RunPayload, TestOutputPayload, WorkerInitParams } from './ipc';\nimport { startProfiling, stopProfiling } from './profiler';\nimport { serializeError } from './util';\nimport { WorkerRunner } from './workerRunner';\n\nlet closed = false;\n\nsendMessageToParent('ready');\n\nglobal.console = new Console({\n  stdout: process.stdout,\n  stderr: process.stderr,\n  colorMode: process.env.FORCE_COLOR === '1',\n});\n\nprocess.stdout.write = (chunk: string | Buffer) => {\n  const outPayload: TestOutputPayload = {\n    testId: workerRunner?._currentTest?.testId,\n    ...chunkToParams(chunk)\n  };\n  sendMessageToParent('stdOut', outPayload);\n  return true;\n};\n\nif (!process.env.PW_RUNNER_DEBUG) {\n  process.stderr.write = (chunk: string | Buffer) => {\n    const outPayload: TestOutputPayload = {\n      testId: workerRunner?._currentTest?.testId,\n      ...chunkToParams(chunk)\n    };\n    sendMessageToParent('stdErr', outPayload);\n    return true;\n  };\n}\n\nprocess.on('disconnect', gracefullyCloseAndExit);\nprocess.on('SIGINT',() => {});\nprocess.on('SIGTERM',() => {});\n\nlet workerRunner: WorkerRunner;\nlet workerIndex: number | undefined;\n\nprocess.on('unhandledRejection', (reason, promise) => {\n  if (workerRunner)\n    workerRunner.unhandledError(reason);\n});\n\nprocess.on('uncaughtException', error => {\n  if (workerRunner)\n    workerRunner.unhandledError(error);\n});\n\nprocess.on('message', async message => {\n  if (message.method === 'init') {\n    const initParams = message.params as WorkerInitParams;\n    workerIndex = initParams.workerIndex;\n    startProfiling();\n    workerRunner = new WorkerRunner(initParams);\n    for (const event of ['testBegin', 'testEnd', 'stepBegin', 'stepEnd', 'done'])\n      workerRunner.on(event, sendMessageToParent.bind(null, event));\n    return;\n  }\n  if (message.method === 'stop') {\n    await gracefullyCloseAndExit();\n    return;\n  }\n  if (message.method === 'run') {\n    const runPayload = message.params as RunPayload;\n    await workerRunner!.run(runPayload);\n  }\n});\n\nasync function gracefullyCloseAndExit() {\n  if (closed)\n    return;\n  closed = true;\n  // Force exit after 30 seconds.\n  setTimeout(() => process.exit(0), 30000);\n  // Meanwhile, try to gracefully shutdown.\n  try {\n    if (workerRunner) {\n      await workerRunner.stop();\n      await workerRunner.cleanup();\n    }\n    if (workerIndex !== undefined)\n      await stopProfiling(workerIndex);\n  } catch (e) {\n    process.send!({ method: 'teardownError', params: { error: serializeError(e) } });\n  }\n  process.exit(0);\n}\n\nfunction sendMessageToParent(method: string, params = {}) {\n  try {\n    process.send!({ method, params });\n  } catch (e) {\n    // Can throw when closing.\n  }\n}\n\nfunction chunkToParams(chunk: Buffer | string):  { text?: string, buffer?: string } {\n  if (chunk instanceof Buffer)\n    return { buffer: chunk.toString('base64') };\n  if (typeof chunk !== 'string')\n    return { text: util.inspect(chunk) };\n  return { text: chunk };\n}\n"],"file":"worker.js"}