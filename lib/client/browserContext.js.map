{"version":3,"sources":["../../src/client/browserContext.ts"],"names":["BrowserContext","ChannelOwner","from","context","_object","fromNullable","constructor","parent","type","guid","initializer","_pages","Set","_routes","_browser","_browserType","_bindings","Map","_timeoutSettings","TimeoutSettings","_ownerPage","_closedPromise","_options","sdkLanguage","tracing","_backgroundPages","_serviceWorkers","_isChromium","Browser","_name","Tracing","_channel","on","binding","_onBinding","BindingCall","_onClose","page","_onPage","Page","route","request","_onRoute","network","Route","Request","backgroundPage","add","emit","Events","BackgroundPage","worker","serviceWorker","Worker","_context","ServiceWorker","_onRequest","failureText","responseEndTiming","_onRequestFailed","_onRequestFinished","response","_onResponse","Response","Promise","f","once","Close","_setBrowserType","browserType","_contexts","_opener","isClosed","Popup","_failureText","_timing","responseEnd","RequestFailed","RequestFinished","url","handler","baseURL","continue","catch","bindingCall","func","get","_initializer","name","call","setDefaultNavigationTimeout","timeout","setDefaultNavigationTimeoutNoReply","setDefaultTimeout","setDefaultTimeoutNoReply","browser","pages","newPage","_wrapApiCall","channel","Error","cookies","urls","addCookies","clearCookies","grantPermissions","permissions","options","clearPermissions","setGeolocation","geolocation","undefined","setExtraHTTPHeaders","headers","validateHeaders","setOffline","offline","setHTTPCredentials","httpCredentials","addInitScript","script","arg","source","exposeBinding","callback","needsHandle","handle","set","exposeFunction","args","unshift","length","setNetworkInterceptionEnabled","enabled","unroute","filter","waitForEvent","event","optionsOrPredicate","predicate","waiter","Waiter","createForEvent","rejectOnTimeout","rejectOnEvent","result","dispose","storageState","state","path","fs","promises","writeFile","JSON","stringify","backgroundPages","serviceWorkers","newCDPSession","Frame","frame","CDPSession","session","delete","close","_onWillCloseContext","e","_enableRecorder","params","recorderSupplementEnable","prepareBrowserContextParams","videoSize","videosPath","extraHTTPHeaders","contextParams","viewport","noDefaultViewport","parse","readFile","recordVideo","dir","size"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Page, BindingCall } from './page';\nimport { Frame } from './frame';\nimport * as network from './network';\nimport * as channels from '../protocol/channels';\nimport fs from 'fs';\nimport { ChannelOwner } from './channelOwner';\nimport { deprecate, evaluationScript, urlMatches } from './clientHelper';\nimport { Browser } from './browser';\nimport { Worker } from './worker';\nimport { Events } from './events';\nimport { TimeoutSettings } from '../utils/timeoutSettings';\nimport { Waiter } from './waiter';\nimport { URLMatch, Headers, WaitForEventOptions, BrowserContextOptions, StorageState } from './types';\nimport { isUnderTest, headersObjectToArray, mkdirIfNeeded } from '../utils/utils';\nimport { isSafeCloseError } from '../utils/errors';\nimport * as api from '../../types/types';\nimport * as structs from '../../types/structs';\nimport { CDPSession } from './cdpSession';\nimport { Tracing } from './tracing';\nimport type { BrowserType } from './browserType';\n\nexport class BrowserContext extends ChannelOwner<channels.BrowserContextChannel, channels.BrowserContextInitializer> implements api.BrowserContext {\n  _pages = new Set<Page>();\n  private _routes: { url: URLMatch, handler: network.RouteHandler }[] = [];\n  readonly _browser: Browser | null = null;\n  private _browserType: BrowserType | undefined;\n  readonly _bindings = new Map<string, (source: structs.BindingSource, ...args: any[]) => any>();\n  _timeoutSettings = new TimeoutSettings();\n  _ownerPage: Page | undefined;\n  private _closedPromise: Promise<void>;\n  _options: channels.BrowserNewContextParams = {\n    sdkLanguage: 'javascript'\n  };\n\n  readonly tracing: Tracing;\n\n  readonly _backgroundPages = new Set<Page>();\n  readonly _serviceWorkers = new Set<Worker>();\n  readonly _isChromium: boolean;\n\n  static from(context: channels.BrowserContextChannel): BrowserContext {\n    return (context as any)._object;\n  }\n\n  static fromNullable(context: channels.BrowserContextChannel | null): BrowserContext | null {\n    return context ? BrowserContext.from(context) : null;\n  }\n\n  constructor(parent: ChannelOwner, type: string, guid: string, initializer: channels.BrowserContextInitializer) {\n    super(parent, type, guid, initializer);\n    if (parent instanceof Browser)\n      this._browser = parent;\n    this._isChromium = this._browser?._name === 'chromium';\n    this.tracing = new Tracing(this);\n\n    this._channel.on('bindingCall', ({binding}) => this._onBinding(BindingCall.from(binding)));\n    this._channel.on('close', () => this._onClose());\n    this._channel.on('page', ({page}) => this._onPage(Page.from(page)));\n    this._channel.on('route', ({ route, request }) => this._onRoute(network.Route.from(route), network.Request.from(request)));\n    this._channel.on('backgroundPage', ({ page }) => {\n      const backgroundPage = Page.from(page);\n      this._backgroundPages.add(backgroundPage);\n      this.emit(Events.BrowserContext.BackgroundPage, backgroundPage);\n    });\n    this._channel.on('serviceWorker', ({worker}) => {\n      const serviceWorker = Worker.from(worker);\n      serviceWorker._context = this;\n      this._serviceWorkers.add(serviceWorker);\n      this.emit(Events.BrowserContext.ServiceWorker, serviceWorker);\n    });\n    this._channel.on('request', ({ request, page }) => this._onRequest(network.Request.from(request), Page.fromNullable(page)));\n    this._channel.on('requestFailed', ({ request, failureText, responseEndTiming, page }) => this._onRequestFailed(network.Request.from(request), responseEndTiming, failureText, Page.fromNullable(page)));\n    this._channel.on('requestFinished', ({ request, responseEndTiming, page }) => this._onRequestFinished(network.Request.from(request), responseEndTiming, Page.fromNullable(page)));\n    this._channel.on('response', ({ response, page }) => this._onResponse(network.Response.from(response), Page.fromNullable(page)));\n    this._closedPromise = new Promise(f => this.once(Events.BrowserContext.Close, f));\n  }\n\n  _setBrowserType(browserType: BrowserType) {\n    this._browserType = browserType;\n    browserType._contexts.add(this);\n  }\n\n  private _onPage(page: Page): void {\n    this._pages.add(page);\n    this.emit(Events.BrowserContext.Page, page);\n    if (page._opener && !page._opener.isClosed())\n      page._opener.emit(Events.Page.Popup, page);\n  }\n\n  private _onRequest(request: network.Request, page: Page | null) {\n    this.emit(Events.BrowserContext.Request, request);\n    if (page)\n      page.emit(Events.Page.Request, request);\n  }\n\n  private _onResponse(response: network.Response, page: Page | null) {\n    this.emit(Events.BrowserContext.Response, response);\n    if (page)\n      page.emit(Events.Page.Response, response);\n  }\n\n  private _onRequestFailed(request: network.Request, responseEndTiming: number, failureText: string | undefined, page: Page | null) {\n    request._failureText = failureText || null;\n    if (request._timing)\n      request._timing.responseEnd = responseEndTiming;\n    this.emit(Events.BrowserContext.RequestFailed, request);\n    if (page)\n      page.emit(Events.Page.RequestFailed, request);\n  }\n\n  private _onRequestFinished(request: network.Request, responseEndTiming: number, page: Page | null) {\n    if (request._timing)\n      request._timing.responseEnd = responseEndTiming;\n    this.emit(Events.BrowserContext.RequestFinished, request);\n    if (page)\n      page.emit(Events.Page.RequestFinished, request);\n  }\n\n  _onRoute(route: network.Route, request: network.Request) {\n    for (const {url, handler} of this._routes) {\n      if (urlMatches(this._options.baseURL, request.url(), url)) {\n        handler(route, request);\n        return;\n      }\n    }\n    // it can race with BrowserContext.close() which then throws since its closed\n    route.continue().catch(() => {});\n  }\n\n  async _onBinding(bindingCall: BindingCall) {\n    const func = this._bindings.get(bindingCall._initializer.name);\n    if (!func)\n      return;\n    await bindingCall.call(func);\n  }\n\n  setDefaultNavigationTimeout(timeout: number) {\n    this._timeoutSettings.setDefaultNavigationTimeout(timeout);\n    this._channel.setDefaultNavigationTimeoutNoReply({ timeout });\n  }\n\n  setDefaultTimeout(timeout: number) {\n    this._timeoutSettings.setDefaultTimeout(timeout);\n    this._channel.setDefaultTimeoutNoReply({ timeout });\n  }\n\n  browser(): Browser | null {\n    return this._browser;\n  }\n\n  pages(): Page[] {\n    return [...this._pages];\n  }\n\n  async newPage(): Promise<Page> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      if (this._ownerPage)\n        throw new Error('Please use browser.newContext()');\n      return Page.from((await channel.newPage()).page);\n    });\n  }\n\n  async cookies(urls?: string | string[]): Promise<network.NetworkCookie[]> {\n    if (!urls)\n      urls = [];\n    if (urls && typeof urls === 'string')\n      urls = [ urls ];\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      return (await channel.cookies({ urls: urls as string[] })).cookies;\n    });\n  }\n\n  async addCookies(cookies: network.SetNetworkCookieParam[]): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.addCookies({ cookies });\n    });\n  }\n\n  async clearCookies(): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.clearCookies();\n    });\n  }\n\n  async grantPermissions(permissions: string[], options?: { origin?: string }): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.grantPermissions({ permissions, ...options });\n    });\n  }\n\n  async clearPermissions(): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.clearPermissions();\n    });\n  }\n\n  async setGeolocation(geolocation: { longitude: number, latitude: number, accuracy?: number } | null): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.setGeolocation({ geolocation: geolocation || undefined });\n    });\n  }\n\n  async setExtraHTTPHeaders(headers: Headers): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      network.validateHeaders(headers);\n      await channel.setExtraHTTPHeaders({ headers: headersObjectToArray(headers) });\n    });\n  }\n\n  async setOffline(offline: boolean): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.setOffline({ offline });\n    });\n  }\n\n  async setHTTPCredentials(httpCredentials: { username: string, password: string } | null): Promise<void> {\n    if (!isUnderTest())\n      deprecate(`context.setHTTPCredentials`, `warning: method |context.setHTTPCredentials()| is deprecated. Instead of changing credentials, create another browser context with new credentials.`);\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.setHTTPCredentials({ httpCredentials: httpCredentials || undefined });\n    });\n  }\n\n  async addInitScript(script: Function | string | { path?: string, content?: string }, arg?: any): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      const source = await evaluationScript(script, arg);\n      await channel.addInitScript({ source });\n    });\n  }\n\n  async exposeBinding(name: string, callback: (source: structs.BindingSource, ...args: any[]) => any, options: { handle?: boolean } = {}): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.exposeBinding({ name, needsHandle: options.handle });\n      this._bindings.set(name, callback);\n    });\n  }\n\n  async exposeFunction(name: string, callback: Function): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      await channel.exposeBinding({ name });\n      const binding = (source: structs.BindingSource, ...args: any[]) => callback(...args);\n      this._bindings.set(name, binding);\n    });\n  }\n\n  async route(url: URLMatch, handler: network.RouteHandler): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      this._routes.unshift({ url, handler });\n      if (this._routes.length === 1)\n        await channel.setNetworkInterceptionEnabled({ enabled: true });\n    });\n  }\n\n  async unroute(url: URLMatch, handler?: network.RouteHandler): Promise<void> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      this._routes = this._routes.filter(route => route.url !== url || (handler && route.handler !== handler));\n      if (this._routes.length === 0)\n        await channel.setNetworkInterceptionEnabled({ enabled: false });\n    });\n  }\n\n  async waitForEvent(event: string, optionsOrPredicate: WaitForEventOptions = {}): Promise<any> {\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      const timeout = this._timeoutSettings.timeout(typeof optionsOrPredicate === 'function'  ? {} : optionsOrPredicate);\n      const predicate = typeof optionsOrPredicate === 'function'  ? optionsOrPredicate : optionsOrPredicate.predicate;\n      const waiter = Waiter.createForEvent(this, event);\n      waiter.rejectOnTimeout(timeout, `Timeout while waiting for event \"${event}\"`);\n      if (event !== Events.BrowserContext.Close)\n        waiter.rejectOnEvent(this, Events.BrowserContext.Close, new Error('Context closed'));\n      const result = await waiter.waitForEvent(this, event, predicate as any);\n      waiter.dispose();\n      return result;\n    });\n  }\n\n  async storageState(options: { path?: string } = {}): Promise<StorageState> {\n    return await this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      const state = await channel.storageState();\n      if (options.path) {\n        await mkdirIfNeeded(options.path);\n        await fs.promises.writeFile(options.path, JSON.stringify(state, undefined, 2), 'utf8');\n      }\n      return state;\n    });\n  }\n\n  backgroundPages(): Page[] {\n    return [...this._backgroundPages];\n  }\n\n  serviceWorkers(): Worker[] {\n    return [...this._serviceWorkers];\n  }\n\n  async newCDPSession(page: Page | Frame): Promise<api.CDPSession> {\n    // channelOwner.ts's validation messages don't handle the pseudo-union type, so we're explicit here\n    if (!(page instanceof Page) && !(page instanceof Frame))\n      throw new Error('page: expected Page or Frame');\n    return this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n      const result = await channel.newCDPSession(page instanceof Page ? { page: page._channel } : { frame: page._channel });\n      return CDPSession.from(result.session);\n    });\n  }\n\n  _onClose() {\n    if (this._browser)\n      this._browser._contexts.delete(this);\n    this._browserType?._contexts?.delete(this);\n    this.emit(Events.BrowserContext.Close, this);\n  }\n\n  async close(): Promise<void> {\n    try {\n      await this._wrapApiCall(async (channel: channels.BrowserContextChannel) => {\n        await this._browserType?._onWillCloseContext?.(this);\n        await channel.close();\n        await this._closedPromise;\n      });\n    } catch (e) {\n      if (isSafeCloseError(e))\n        return;\n      throw e;\n    }\n  }\n\n  async _enableRecorder(params: channels.BrowserContextRecorderSupplementEnableParams) {\n    await this._channel.recorderSupplementEnable(params);\n  }\n}\n\nexport async function prepareBrowserContextParams(options: BrowserContextOptions): Promise<channels.BrowserNewContextParams> {\n  if (options.videoSize && !options.videosPath)\n    throw new Error(`\"videoSize\" option requires \"videosPath\" to be specified`);\n  if (options.extraHTTPHeaders)\n    network.validateHeaders(options.extraHTTPHeaders);\n  const contextParams: channels.BrowserNewContextParams = {\n    sdkLanguage: 'javascript',\n    ...options,\n    viewport: options.viewport === null ? undefined : options.viewport,\n    noDefaultViewport: options.viewport === null,\n    extraHTTPHeaders: options.extraHTTPHeaders ? headersObjectToArray(options.extraHTTPHeaders) : undefined,\n    storageState: typeof options.storageState === 'string' ? JSON.parse(await fs.promises.readFile(options.storageState, 'utf8')) : options.storageState,\n  };\n  if (!contextParams.recordVideo && options.videosPath) {\n    contextParams.recordVideo = {\n      dir: options.videosPath,\n      size: options.videoSize\n    };\n  }\n  return contextParams;\n}\n"],"file":"browserContext.js"}