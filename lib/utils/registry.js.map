{"version":3,"sources":["../../src/utils/registry.ts"],"names":["PACKAGE_PATH","path","join","__dirname","BIN_PATH","EXECUTABLE_PATHS","undefined","DOWNLOAD_URLS","registryDirectory","result","envDefined","cacheDirectory","process","platform","env","XDG_CACHE_HOME","os","homedir","LOCALAPPDATA","Error","isAbsolute","resolve","cwd","isBrowserDirectory","browserDirectory","baseName","basename","browserName","allDownloadable","startsWith","readDescriptors","packagePath","browsersJSON","require","map","obj","name","revisionOverride","revisionOverrides","hostPlatform","revision","browserDirectoryPrefix","descriptor","installByDefault","dir","replace","Registry","constructor","_executables","descriptors","findExecutablePath","tokens","executablePathOrDie","e","prettyMessage","chromium","find","d","chromiumExecutable","push","type","directory","executablePath","installType","validateHostRequirements","_validateHostRequirements","_install","_downloadExecutable","_dependencyGroup","chromiumWithSymbols","chromiumWithSymbolsExecutable","_createChromiumChannel","_installChromiumChannel","_installMSEdgeChannel","firefox","firefoxExecutable","firefoxBeta","firefoxBetaExecutable","webkit","webkitExecutable","webkitLinuxLddDirectories","ffmpeg","ffmpegExecutable","Promise","lookAt","install","shouldThrow","suffix","prefixes","PROGRAMFILES","filter","Boolean","prefix","location","length","installation","executables","findExecutable","b","_addRequirementsAndDedupe","set","Set","executable","add","Array","from","linuxLddDirectories","dlOpenLibraries","windowsExeAndDllDirectories","stdout","write","ubuntuVersion","arch","installDeps","executablesToInstallDeps","targets","executablesToInstall","fs","promises","mkdir","recursive","lockfilePath","releaseLock","lockfile","lock","retries","factor","onCompromised","err","message","linksDir","writeFile","_validateInstallationCache","downloadURLTemplate","downloadHostEnv","downloadHost","downloadURL","util","format","title","downloadFileName","catch","stack","markerFilePath","channel","scripts","scriptArgs","products","JSON","parse","productName","product","Product","searchConfig","darwin","artifact","win32","release","Releases","Platform","Architecture","Artifacts","ArtifactName","Location","scriptName","shell","endsWith","code","stdio","usedBrowserPaths","fileName","readdir","linkPath","linkTarget","readFile","toString","usedBrowserPath","browserRevision","parseInt","shouldHaveMarkerFile","unlink","downloadedBrowsers","file","directories","delete","installDefaultBrowsersForNpmInstall","registry"],"mappings":"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","sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as os from 'os';\nimport path from 'path';\nimport * as util from 'util';\nimport * as fs from 'fs';\nimport lockfile from 'proper-lockfile';\nimport { getUbuntuVersion } from './ubuntuVersion';\nimport { getFromENV, getAsBooleanFromENV, calculateSha1, removeFolders, existsAsync, hostPlatform, canAccessFile, spawnAsync, fetchData, wrapInASCIIBox } from './utils';\nimport { DependencyGroup, installDependenciesLinux, installDependenciesWindows, validateDependenciesLinux, validateDependenciesWindows } from './dependencies';\nimport { downloadBrowserWithProgressBar, logPolitely } from './browserFetcher';\n\nconst PACKAGE_PATH = path.join(__dirname, '..', '..');\nconst BIN_PATH = path.join(__dirname, '..', '..', 'bin');\n\nconst EXECUTABLE_PATHS = {\n  'chromium': {\n    'ubuntu18.04': ['chrome-linux', 'chrome'],\n    'ubuntu20.04': ['chrome-linux', 'chrome'],\n    'mac10.13': ['chrome-mac', 'Chromium.app', 'Contents', 'MacOS', 'Chromium'],\n    'mac10.14': ['chrome-mac', 'Chromium.app', 'Contents', 'MacOS', 'Chromium'],\n    'mac10.15': ['chrome-mac', 'Chromium.app', 'Contents', 'MacOS', 'Chromium'],\n    'mac11': ['chrome-mac', 'Chromium.app', 'Contents', 'MacOS', 'Chromium'],\n    'mac11-arm64': ['chrome-mac', 'Chromium.app', 'Contents', 'MacOS', 'Chromium'],\n    'win32': ['chrome-win', 'chrome.exe'],\n    'win64': ['chrome-win', 'chrome.exe'],\n  },\n  'firefox': {\n    'ubuntu18.04': ['firefox', 'firefox'],\n    'ubuntu20.04': ['firefox', 'firefox'],\n    'mac10.13': ['firefox', 'Nightly.app', 'Contents', 'MacOS', 'firefox'],\n    'mac10.14': ['firefox', 'Nightly.app', 'Contents', 'MacOS', 'firefox'],\n    'mac10.15': ['firefox', 'Nightly.app', 'Contents', 'MacOS', 'firefox'],\n    'mac11': ['firefox', 'Nightly.app', 'Contents', 'MacOS', 'firefox'],\n    'mac11-arm64': ['firefox', 'Nightly.app', 'Contents', 'MacOS', 'firefox'],\n    'win32': ['firefox', 'firefox.exe'],\n    'win64': ['firefox', 'firefox.exe'],\n  },\n  'webkit': {\n    'ubuntu18.04': ['pw_run.sh'],\n    'ubuntu20.04': ['pw_run.sh'],\n    'mac10.13': undefined,\n    'mac10.14': ['pw_run.sh'],\n    'mac10.15': ['pw_run.sh'],\n    'mac11': ['pw_run.sh'],\n    'mac11-arm64': ['pw_run.sh'],\n    'win32': ['Playwright.exe'],\n    'win64': ['Playwright.exe'],\n  },\n  'ffmpeg': {\n    'ubuntu18.04': ['ffmpeg-linux'],\n    'ubuntu20.04': ['ffmpeg-linux'],\n    'mac10.13': ['ffmpeg-mac'],\n    'mac10.14': ['ffmpeg-mac'],\n    'mac10.15': ['ffmpeg-mac'],\n    'mac11': ['ffmpeg-mac'],\n    'mac11-arm64': ['ffmpeg-mac'],\n    'win32': ['ffmpeg-win32.exe'],\n    'win64': ['ffmpeg-win64.exe'],\n  },\n};\n\nconst DOWNLOAD_URLS = {\n  'chromium': {\n    'ubuntu18.04': '%s/builds/chromium/%s/chromium-linux.zip',\n    'ubuntu20.04': '%s/builds/chromium/%s/chromium-linux.zip',\n    'mac10.13': '%s/builds/chromium/%s/chromium-mac.zip',\n    'mac10.14': '%s/builds/chromium/%s/chromium-mac.zip',\n    'mac10.15': '%s/builds/chromium/%s/chromium-mac.zip',\n    'mac11': '%s/builds/chromium/%s/chromium-mac.zip',\n    'mac11-arm64': '%s/builds/chromium/%s/chromium-mac-arm64.zip',\n    'win32': '%s/builds/chromium/%s/chromium-win32.zip',\n    'win64': '%s/builds/chromium/%s/chromium-win64.zip',\n  },\n  'chromium-with-symbols': {\n    'ubuntu18.04': '%s/builds/chromium/%s/chromium-with-symbols-linux.zip',\n    'ubuntu20.04': '%s/builds/chromium/%s/chromium-with-symbols-linux.zip',\n    'mac10.13': '%s/builds/chromium/%s/chromium-with-symbols-mac.zip',\n    'mac10.14': '%s/builds/chromium/%s/chromium-with-symbols-mac.zip',\n    'mac10.15': '%s/builds/chromium/%s/chromium-with-symbols-mac.zip',\n    'mac11': '%s/builds/chromium/%s/chromium-with-symbols-mac.zip',\n    'mac11-arm64': '%s/builds/chromium/%s/chromium-with-symbols-mac-arm64.zip',\n    'win32': '%s/builds/chromium/%s/chromium-with-symbols-win32.zip',\n    'win64': '%s/builds/chromium/%s/chromium-with-symbols-win64.zip',\n  },\n  'firefox': {\n    'ubuntu18.04': '%s/builds/firefox/%s/firefox-ubuntu-18.04.zip',\n    'ubuntu20.04': '%s/builds/firefox/%s/firefox-ubuntu-20.04.zip',\n    'mac10.13': '%s/builds/firefox/%s/firefox-mac-10.14.zip',\n    'mac10.14': '%s/builds/firefox/%s/firefox-mac-10.14.zip',\n    'mac10.15': '%s/builds/firefox/%s/firefox-mac-10.14.zip',\n    'mac11': '%s/builds/firefox/%s/firefox-mac-10.14.zip',\n    'mac11-arm64': '%s/builds/firefox/%s/firefox-mac-11.0-arm64.zip',\n    'win32': '%s/builds/firefox/%s/firefox-win32.zip',\n    'win64': '%s/builds/firefox/%s/firefox-win64.zip',\n  },\n  'firefox-beta': {\n    'ubuntu18.04': '%s/builds/firefox-beta/%s/firefox-beta-ubuntu-18.04.zip',\n    'ubuntu20.04': '%s/builds/firefox-beta/%s/firefox-beta-ubuntu-20.04.zip',\n    'mac10.13': '%s/builds/firefox-beta/%s/firefox-beta-mac-10.14.zip',\n    'mac10.14': '%s/builds/firefox-beta/%s/firefox-beta-mac-10.14.zip',\n    'mac10.15': '%s/builds/firefox-beta/%s/firefox-beta-mac-10.14.zip',\n    'mac11': '%s/builds/firefox-beta/%s/firefox-beta-mac-10.14.zip',\n    'mac11-arm64': '%s/builds/firefox-beta/%s/firefox-beta-mac-11.0-arm64.zip',\n    'win32': '%s/builds/firefox-beta/%s/firefox-beta-win32.zip',\n    'win64': '%s/builds/firefox-beta/%s/firefox-beta-win64.zip',\n  },\n  'webkit': {\n    'ubuntu18.04': '%s/builds/webkit/%s/webkit-ubuntu-18.04.zip',\n    'ubuntu20.04': '%s/builds/webkit/%s/webkit-ubuntu-20.04.zip',\n    'mac10.13': undefined,\n    'mac10.14': '%s/builds/deprecated-webkit-mac-10.14/%s/deprecated-webkit-mac-10.14.zip',\n    'mac10.15': '%s/builds/webkit/%s/webkit-mac-10.15.zip',\n    'mac11': '%s/builds/webkit/%s/webkit-mac-10.15.zip',\n    'mac11-arm64': '%s/builds/webkit/%s/webkit-mac-11.0-arm64.zip',\n    'win32': '%s/builds/webkit/%s/webkit-win64.zip',\n    'win64': '%s/builds/webkit/%s/webkit-win64.zip',\n  },\n  'ffmpeg': {\n    'ubuntu18.04': '%s/builds/ffmpeg/%s/ffmpeg-linux.zip',\n    'ubuntu20.04': '%s/builds/ffmpeg/%s/ffmpeg-linux.zip',\n    'mac10.13': '%s/builds/ffmpeg/%s/ffmpeg-mac.zip',\n    'mac10.14': '%s/builds/ffmpeg/%s/ffmpeg-mac.zip',\n    'mac10.15': '%s/builds/ffmpeg/%s/ffmpeg-mac.zip',\n    'mac11': '%s/builds/ffmpeg/%s/ffmpeg-mac.zip',\n    'mac11-arm64': '%s/builds/ffmpeg/%s/ffmpeg-mac.zip',\n    'win32': '%s/builds/ffmpeg/%s/ffmpeg-win32.zip',\n    'win64': '%s/builds/ffmpeg/%s/ffmpeg-win64.zip',\n  },\n};\n\nexport const registryDirectory = (() => {\n  let result: string;\n\n  const envDefined = getFromENV('PLAYWRIGHT_BROWSERS_PATH');\n  if (envDefined === '0') {\n    result = path.join(__dirname, '..', '..', '.local-browsers');\n  } else if (envDefined) {\n    result = envDefined;\n  } else {\n    let cacheDirectory: string;\n    if (process.platform === 'linux')\n      cacheDirectory = process.env.XDG_CACHE_HOME || path.join(os.homedir(), '.cache');\n    else if (process.platform === 'darwin')\n      cacheDirectory = path.join(os.homedir(), 'Library', 'Caches');\n    else if (process.platform === 'win32')\n      cacheDirectory = process.env.LOCALAPPDATA || path.join(os.homedir(), 'AppData', 'Local');\n    else\n      throw new Error('Unsupported platform: ' + process.platform);\n    result = path.join(cacheDirectory, 'ms-playwright');\n  }\n\n  if (!path.isAbsolute(result)) {\n    // It is important to resolve to the absolute path:\n    //   - for unzipping to work correctly;\n    //   - so that registry directory matches between installation and execution.\n    // INIT_CWD points to the root of `npm/yarn install` and is probably what\n    // the user meant when typing the relative path.\n    result = path.resolve(getFromENV('INIT_CWD') || process.cwd(), result);\n  }\n  return result;\n})();\n\nfunction isBrowserDirectory(browserDirectory: string): boolean {\n  const baseName = path.basename(browserDirectory);\n  for (const browserName of allDownloadable) {\n    if (baseName.startsWith(browserName + '-'))\n      return true;\n  }\n  return false;\n}\n\ntype BrowsersJSONDescriptor = {\n  name: string,\n  revision: string,\n  installByDefault: boolean,\n  dir: string,\n};\n\nfunction readDescriptors(packagePath: string) {\n  const browsersJSON = require(path.join(packagePath, 'browsers.json'));\n  return (browsersJSON['browsers'] as any[]).map(obj => {\n    const name = obj.name;\n    const revisionOverride = (obj.revisionOverrides || {})[hostPlatform];\n    const revision = revisionOverride || obj.revision;\n    const browserDirectoryPrefix = revisionOverride ? `${name}_${hostPlatform}_special` : `${name}`;\n    const descriptor: BrowsersJSONDescriptor = {\n      name,\n      revision,\n      installByDefault: !!obj.installByDefault,\n      // Method `isBrowserDirectory` determines directory to be browser iff\n      // it starts with some browser name followed by '-'. Some browser names\n      // are prefixes of others, e.g. 'webkit' is a prefix of `webkit-technology-preview`.\n      // To avoid older registries erroneously removing 'webkit-technology-preview', we have to\n      // ensure that browser folders to never include dashes inside.\n      dir: path.join(registryDirectory, browserDirectoryPrefix.replace(/-/g, '_') + '-' + revision),\n    };\n    return descriptor;\n  });\n}\n\nexport type BrowserName = 'chromium' | 'firefox' | 'webkit';\ntype InternalTool = 'ffmpeg' | 'firefox-beta' | 'chromium-with-symbols';\ntype ChromiumChannel = 'chrome' | 'chrome-beta' | 'chrome-dev' | 'chrome-canary' | 'msedge' | 'msedge-beta' | 'msedge-dev' | 'msedge-canary';\nconst allDownloadable = ['chromium', 'firefox', 'webkit', 'ffmpeg', 'firefox-beta', 'chromium-with-symbols'];\n\nexport interface Executable {\n  type: 'browser' | 'tool' | 'channel';\n  name: BrowserName | InternalTool | ChromiumChannel;\n  browserName: BrowserName | undefined;\n  installType: 'download-by-default' | 'download-on-demand' | 'install-script' | 'none';\n  directory: string | undefined;\n  executablePathOrDie(): string;\n  executablePath(): string | undefined;\n  validateHostRequirements(): Promise<void>;\n}\n\ninterface ExecutableImpl extends Executable {\n  _install?: () => Promise<void>;\n  _dependencyGroup?: DependencyGroup;\n}\n\nexport class Registry {\n  private _executables: ExecutableImpl[];\n\n  constructor(packagePath: string) {\n    const descriptors = readDescriptors(packagePath);\n    const findExecutablePath = (dir: string, name: keyof typeof EXECUTABLE_PATHS) => {\n      const tokens = EXECUTABLE_PATHS[name][hostPlatform];\n      return tokens ? path.join(dir, ...tokens) : undefined;\n    };\n    const executablePathOrDie = (name: string, e: string | undefined, installByDefault: boolean) => {\n      if (!e)\n        throw new Error(`${name} is not supported on ${hostPlatform}`);\n      // TODO: language-specific error message\n      if (!canAccessFile(e)) {\n        const prettyMessage = [\n          `Looks like Playwright Test or Playwright was just installed or updated.`,\n          `Please run the following command to download new browser${installByDefault ? 's' : ''}:`,\n          ``,\n          `    npx playwright install${installByDefault ? '' : ' ' + name}`,\n          ``,\n          `<3 Playwright Team`,\n        ].join('\\n');\n        throw new Error(`Executable doesn't exist at ${e}\\n${wrapInASCIIBox(prettyMessage, 1)}`);\n      }\n      return e;\n    };\n    this._executables = [];\n\n    const chromium = descriptors.find(d => d.name === 'chromium')!;\n    const chromiumExecutable = findExecutablePath(chromium.dir, 'chromium');\n    this._executables.push({\n      type: 'browser',\n      name: 'chromium',\n      browserName: 'chromium',\n      directory: chromium.dir,\n      executablePath: () => chromiumExecutable,\n      executablePathOrDie: () => executablePathOrDie('chromium', chromiumExecutable, chromium.installByDefault),\n      installType: chromium.installByDefault ? 'download-by-default' : 'download-on-demand',\n      validateHostRequirements: () => this._validateHostRequirements('chromium', chromium.dir, ['chrome-linux'], [], ['chrome-win']),\n      _install: () => this._downloadExecutable(chromium, chromiumExecutable, DOWNLOAD_URLS['chromium'][hostPlatform], 'PLAYWRIGHT_CHROMIUM_DOWNLOAD_HOST'),\n      _dependencyGroup: 'chromium',\n    });\n\n    const chromiumWithSymbols = descriptors.find(d => d.name === 'chromium-with-symbols')!;\n    const chromiumWithSymbolsExecutable = findExecutablePath(chromiumWithSymbols.dir, 'chromium');\n    this._executables.push({\n      type: 'tool',\n      name: 'chromium-with-symbols',\n      browserName: 'chromium',\n      directory: chromiumWithSymbols.dir,\n      executablePath: () => chromiumWithSymbolsExecutable,\n      executablePathOrDie: () => executablePathOrDie('chromium-with-symbols', chromiumWithSymbolsExecutable, chromiumWithSymbols.installByDefault),\n      installType: chromiumWithSymbols.installByDefault ? 'download-by-default' : 'download-on-demand',\n      validateHostRequirements: () => this._validateHostRequirements('chromium', chromiumWithSymbols.dir, ['chrome-linux'], [], ['chrome-win']),\n      _install: () => this._downloadExecutable(chromiumWithSymbols, chromiumWithSymbolsExecutable, DOWNLOAD_URLS['chromium-with-symbols'][hostPlatform], 'PLAYWRIGHT_CHROMIUM_DOWNLOAD_HOST'),\n      _dependencyGroup: 'chromium',\n    });\n\n    this._executables.push(this._createChromiumChannel('chrome', {\n      'linux': '/opt/google/chrome/chrome',\n      'darwin': '/Applications/Google Chrome.app/Contents/MacOS/Google Chrome',\n      'win32': `\\\\Google\\\\Chrome\\\\Application\\\\chrome.exe`,\n    }, () => this._installChromiumChannel('chrome', {\n      'linux': 'reinstall_chrome_stable_linux.sh',\n      'darwin': 'reinstall_chrome_stable_mac.sh',\n      'win32': 'reinstall_chrome_stable_win.ps1',\n    })));\n\n    this._executables.push(this._createChromiumChannel('chrome-beta', {\n      'linux': '/opt/google/chrome-beta/chrome',\n      'darwin': '/Applications/Google Chrome Beta.app/Contents/MacOS/Google Chrome Beta',\n      'win32': `\\\\Google\\\\Chrome Beta\\\\Application\\\\chrome.exe`,\n    }, () => this._installChromiumChannel('chrome-beta', {\n      'linux': 'reinstall_chrome_beta_linux.sh',\n      'darwin': 'reinstall_chrome_beta_mac.sh',\n      'win32': 'reinstall_chrome_beta_win.ps1',\n    })));\n\n    this._executables.push(this._createChromiumChannel('chrome-dev', {\n      'linux': '/opt/google/chrome-unstable/chrome',\n      'darwin': '/Applications/Google Chrome Dev.app/Contents/MacOS/Google Chrome Dev',\n      'win32': `\\\\Google\\\\Chrome Dev\\\\Application\\\\chrome.exe`,\n    }));\n\n    this._executables.push(this._createChromiumChannel('chrome-canary', {\n      'linux': '',\n      'darwin': '/Applications/Google Chrome Canary.app/Contents/MacOS/Google Chrome Canary',\n      'win32': `\\\\Google\\\\Chrome SxS\\\\Application\\\\chrome.exe`,\n    }));\n\n    this._executables.push(this._createChromiumChannel('msedge', {\n      'linux': '',\n      'darwin': '/Applications/Microsoft Edge.app/Contents/MacOS/Microsoft Edge',\n      'win32': `\\\\Microsoft\\\\Edge\\\\Application\\\\msedge.exe`,\n    }, () => this._installMSEdgeChannel('msedge', {\n      'linux': '',\n      'darwin': 'reinstall_msedge_stable_mac.sh',\n      'win32': 'reinstall_msedge_stable_win.ps1',\n    })));\n\n    this._executables.push(this._createChromiumChannel('msedge-beta', {\n      'linux': '/opt/microsoft/msedge-beta/msedge',\n      'darwin': '/Applications/Microsoft Edge Beta.app/Contents/MacOS/Microsoft Edge Beta',\n      'win32': `\\\\Microsoft\\\\Edge Beta\\\\Application\\\\msedge.exe`,\n    }, () => this._installMSEdgeChannel('msedge-beta', {\n      'darwin': 'reinstall_msedge_beta_mac.sh',\n      'linux': 'reinstall_msedge_beta_linux.sh',\n      'win32': 'reinstall_msedge_beta_win.ps1',\n    })));\n\n    this._executables.push(this._createChromiumChannel('msedge-dev', {\n      'linux': '/opt/microsoft/msedge-dev/msedge',\n      'darwin': '/Applications/Microsoft Edge Dev.app/Contents/MacOS/Microsoft Edge Dev',\n      'win32': `\\\\Microsoft\\\\Edge Dev\\\\Application\\\\msedge.exe`,\n    }, () => this._installMSEdgeChannel('msedge-dev', {\n      'darwin': 'reinstall_msedge_dev_mac.sh',\n      'linux': 'reinstall_msedge_dev_linux.sh',\n      'win32': 'reinstall_msedge_dev_win.ps1',\n    })));\n\n    this._executables.push(this._createChromiumChannel('msedge-canary', {\n      'linux': '',\n      'darwin': '/Applications/Microsoft Edge Canary.app/Contents/MacOS/Microsoft Edge Canary',\n      'win32': `\\\\Microsoft\\\\Edge SxS\\\\Application\\\\msedge.exe`,\n    }));\n\n    const firefox = descriptors.find(d => d.name === 'firefox')!;\n    const firefoxExecutable = findExecutablePath(firefox.dir, 'firefox');\n    this._executables.push({\n      type: 'browser',\n      name: 'firefox',\n      browserName: 'firefox',\n      directory: firefox.dir,\n      executablePath: () => firefoxExecutable,\n      executablePathOrDie: () => executablePathOrDie('firefox', firefoxExecutable, firefox.installByDefault),\n      installType: firefox.installByDefault ? 'download-by-default' : 'download-on-demand',\n      validateHostRequirements: () => this._validateHostRequirements('firefox', firefox.dir, ['firefox'], [], ['firefox']),\n      _install: () => this._downloadExecutable(firefox, firefoxExecutable, DOWNLOAD_URLS['firefox'][hostPlatform], 'PLAYWRIGHT_FIREFOX_DOWNLOAD_HOST'),\n      _dependencyGroup: 'firefox',\n    });\n\n    const firefoxBeta = descriptors.find(d => d.name === 'firefox-beta')!;\n    const firefoxBetaExecutable = findExecutablePath(firefoxBeta.dir, 'firefox');\n    this._executables.push({\n      type: 'tool',\n      name: 'firefox-beta',\n      browserName: 'firefox',\n      directory: firefoxBeta.dir,\n      executablePath: () => firefoxBetaExecutable,\n      executablePathOrDie: () => executablePathOrDie('firefox-beta', firefoxBetaExecutable, firefoxBeta.installByDefault),\n      installType: firefoxBeta.installByDefault ? 'download-by-default' : 'download-on-demand',\n      validateHostRequirements: () => this._validateHostRequirements('firefox', firefoxBeta.dir, ['firefox'], [], ['firefox']),\n      _install: () => this._downloadExecutable(firefoxBeta, firefoxBetaExecutable, DOWNLOAD_URLS['firefox-beta'][hostPlatform], 'PLAYWRIGHT_FIREFOX_DOWNLOAD_HOST'),\n      _dependencyGroup: 'firefox',\n    });\n\n    const webkit = descriptors.find(d => d.name === 'webkit')!;\n    const webkitExecutable = findExecutablePath(webkit.dir, 'webkit');\n    const webkitLinuxLddDirectories = [\n      path.join('minibrowser-gtk'),\n      path.join('minibrowser-gtk', 'bin'),\n      path.join('minibrowser-gtk', 'lib'),\n      path.join('minibrowser-wpe'),\n      path.join('minibrowser-wpe', 'bin'),\n      path.join('minibrowser-wpe', 'lib'),\n    ];\n    this._executables.push({\n      type: 'browser',\n      name: 'webkit',\n      browserName: 'webkit',\n      directory: webkit.dir,\n      executablePath: () => webkitExecutable,\n      executablePathOrDie: () => executablePathOrDie('webkit', webkitExecutable, webkit.installByDefault),\n      installType: webkit.installByDefault ? 'download-by-default' : 'download-on-demand',\n      validateHostRequirements: () => this._validateHostRequirements('webkit', webkit.dir, webkitLinuxLddDirectories, ['libGLESv2.so.2', 'libx264.so'], ['']),\n      _install: () => this._downloadExecutable(webkit, webkitExecutable, DOWNLOAD_URLS['webkit'][hostPlatform], 'PLAYWRIGHT_WEBKIT_DOWNLOAD_HOST'),\n      _dependencyGroup: 'webkit',\n    });\n\n    const ffmpeg = descriptors.find(d => d.name === 'ffmpeg')!;\n    const ffmpegExecutable = findExecutablePath(ffmpeg.dir, 'ffmpeg');\n    this._executables.push({\n      type: 'tool',\n      name: 'ffmpeg',\n      browserName: undefined,\n      directory: ffmpeg.dir,\n      executablePath: () => ffmpegExecutable,\n      executablePathOrDie: () => executablePathOrDie('ffmpeg', ffmpegExecutable, ffmpeg.installByDefault),\n      installType: ffmpeg.installByDefault ? 'download-by-default' : 'download-on-demand',\n      validateHostRequirements: () => Promise.resolve(),\n      _install: () => this._downloadExecutable(ffmpeg, ffmpegExecutable, DOWNLOAD_URLS['ffmpeg'][hostPlatform], 'PLAYWRIGHT_FFMPEG_DOWNLOAD_HOST'),\n      _dependencyGroup: 'tools',\n    });\n  }\n\n  private _createChromiumChannel(name: ChromiumChannel, lookAt: Record<'linux' | 'darwin' | 'win32', string>, install?: () => Promise<void>): ExecutableImpl {\n    const executablePath = (shouldThrow: boolean) => {\n      const suffix = lookAt[process.platform as 'linux' | 'darwin' | 'win32'];\n      if (!suffix) {\n        if (shouldThrow)\n          throw new Error(`Chromium distribution '${name}' is not supported on ${process.platform}`);\n        return undefined;\n      }\n      const prefixes = (process.platform === 'win32' ? [\n        process.env.LOCALAPPDATA, process.env.PROGRAMFILES, process.env['PROGRAMFILES(X86)']\n      ].filter(Boolean) : ['']) as string[];\n\n      for (const prefix of prefixes) {\n        const executablePath = path.join(prefix, suffix);\n        if (canAccessFile(executablePath))\n          return executablePath;\n      }\n      if (!shouldThrow)\n        return undefined;\n\n      const location = prefixes.length ? ` at ${path.join(prefixes[0], suffix)}` : ``;\n      // TODO: language-specific error message\n      const installation = install ? `\\nRun \"npx playwright install ${name}\"` : '';\n      throw new Error(`Chromium distribution '${name}' is not found${location}${installation}`);\n    };\n    return {\n      type: 'channel',\n      name,\n      browserName: 'chromium',\n      directory: undefined,\n      executablePath: () => executablePath(false),\n      executablePathOrDie: () => executablePath(true)!,\n      installType: install ? 'install-script' : 'none',\n      validateHostRequirements: () => Promise.resolve(),\n      _install: install,\n    };\n  }\n\n  executables(): Executable[] {\n    return this._executables;\n  }\n\n  findExecutable(name: BrowserName): Executable;\n  findExecutable(name: string): Executable | undefined;\n  findExecutable(name: string): Executable | undefined {\n    return this._executables.find(b => b.name === name);\n  }\n\n  private _addRequirementsAndDedupe(executables: Executable[] | undefined): ExecutableImpl[] {\n    const set = new Set<ExecutableImpl>();\n    if (!executables)\n      executables = this._executables.filter(executable => executable.installType === 'download-by-default');\n    for (const executable of executables as ExecutableImpl[]) {\n      set.add(executable);\n      if (executable.browserName === 'chromium')\n        set.add(this.findExecutable('ffmpeg')!);\n    }\n    return Array.from(set);\n  }\n\n  private async _validateHostRequirements(browserName: BrowserName, browserDirectory: string, linuxLddDirectories: string[], dlOpenLibraries: string[], windowsExeAndDllDirectories: string[]) {\n    if (getAsBooleanFromENV('PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS')) {\n      process.stdout.write('Skipping host requirements validation logic because `PLAYWRIGHT_SKIP_VALIDATE_HOST_REQUIREMENTS` env variable is set.\\n');\n      return;\n    }\n    const ubuntuVersion = await getUbuntuVersion();\n    if (browserName === 'firefox' && ubuntuVersion === '16.04')\n      throw new Error(`Cannot launch Firefox on Ubuntu 16.04! Minimum required Ubuntu version for Firefox browser is 18.04`);\n\n    if (os.platform() === 'linux')\n      return await validateDependenciesLinux(linuxLddDirectories.map(d => path.join(browserDirectory, d)), dlOpenLibraries);\n    if (os.platform() === 'win32' && os.arch() === 'x64')\n      return await validateDependenciesWindows(windowsExeAndDllDirectories.map(d => path.join(browserDirectory, d)));\n  }\n\n  async installDeps(executablesToInstallDeps?: Executable[]) {\n    const executables = this._addRequirementsAndDedupe(executablesToInstallDeps);\n    const targets = new Set<DependencyGroup>();\n    for (const executable of executables) {\n      if (executable._dependencyGroup)\n        targets.add(executable._dependencyGroup);\n    }\n    targets.add('tools');\n    if (os.platform() === 'win32')\n      return await installDependenciesWindows(targets);\n    if (os.platform() === 'linux')\n      return await installDependenciesLinux(targets);\n  }\n\n  async install(executablesToInstall?: Executable[]) {\n    const executables = this._addRequirementsAndDedupe(executablesToInstall);\n    await fs.promises.mkdir(registryDirectory, { recursive: true });\n    const lockfilePath = path.join(registryDirectory, '__dirlock');\n    const releaseLock = await lockfile.lock(registryDirectory, {\n      retries: {\n        retries: 10,\n        // Retry 20 times during 10 minutes with\n        // exponential back-off.\n        // See documentation at: https://www.npmjs.com/package/retry#retrytimeoutsoptions\n        factor: 1.27579,\n      },\n      onCompromised: (err: Error) => {\n        throw new Error(`${err.message} Path: ${lockfilePath}`);\n      },\n      lockfilePath,\n    });\n    const linksDir = path.join(registryDirectory, '.links');\n\n    try {\n      // Create a link first, so that cache validation does not remove our own browsers.\n      await fs.promises.mkdir(linksDir, { recursive: true });\n      await fs.promises.writeFile(path.join(linksDir, calculateSha1(PACKAGE_PATH)), PACKAGE_PATH);\n\n      // Remove stale browsers.\n      await this._validateInstallationCache(linksDir);\n\n      // Install browsers for this package.\n      for (const executable of executables) {\n        if (executable._install)\n          await executable._install();\n        else\n          throw new Error(`ERROR: Playwright does not support installing ${executable.name}`);\n      }\n    } finally {\n      await releaseLock();\n    }\n  }\n\n  private async _downloadExecutable(descriptor: BrowsersJSONDescriptor, executablePath: string | undefined, downloadURLTemplate: string | undefined, downloadHostEnv: string) {\n    if (!downloadURLTemplate || !executablePath)\n      throw new Error(`ERROR: Playwright does not support ${descriptor.name} on ${hostPlatform}`);\n    const downloadHost =\n        (downloadHostEnv && getFromENV(downloadHostEnv)) ||\n        getFromENV('PLAYWRIGHT_DOWNLOAD_HOST') ||\n        'https://playwright.azureedge.net';\n    const downloadURL = util.format(downloadURLTemplate, downloadHost, descriptor.revision);\n    const title = `${descriptor.name} v${descriptor.revision}`;\n    const downloadFileName = `playwright-download-${descriptor.name}-${hostPlatform}-${descriptor.revision}.zip`;\n    await downloadBrowserWithProgressBar(title, descriptor.dir, executablePath, downloadURL, downloadFileName).catch(e => {\n      throw new Error(`Failed to download ${title}, caused by\\n${e.stack}`);\n    });\n    await fs.promises.writeFile(markerFilePath(descriptor.dir), '');\n  }\n\n  private async _installMSEdgeChannel(channel: 'msedge'|'msedge-beta'|'msedge-dev', scripts: Record<'linux' | 'darwin' | 'win32', string>) {\n    const scriptArgs: string[] = [];\n    if (process.platform !== 'linux') {\n      const products = JSON.parse(await fetchData('https://edgeupdates.microsoft.com/api/products'));\n      const productName = {\n        'msedge': 'Stable',\n        'msedge-beta': 'Beta',\n        'msedge-dev': 'Dev',\n      }[channel];\n      const product = products.find((product: any) => product.Product === productName);\n      const searchConfig = ({\n        darwin: {platform: 'MacOS', arch: 'universal', artifact: 'pkg'},\n        win32: {platform: 'Windows', arch: os.arch() === 'x64' ? 'x64' : 'x86', artifact: 'msi'},\n      } as any)[process.platform];\n      const release = searchConfig ? product.Releases.find((release: any) => release.Platform === searchConfig.platform && release.Architecture === searchConfig.arch) : null;\n      const artifact = release ? release.Artifacts.find((artifact: any) => artifact.ArtifactName === searchConfig.artifact) : null;\n      if (artifact)\n        scriptArgs.push(artifact.Location /* url */);\n      else\n        throw new Error(`Cannot install ${channel} on ${process.platform}`);\n    }\n    await this._installChromiumChannel(channel, scripts, scriptArgs);\n  }\n\n  private async _installChromiumChannel(channel: string, scripts: Record<'linux' | 'darwin' | 'win32', string>, scriptArgs: string[] = []) {\n    const scriptName = scripts[process.platform as 'linux' | 'darwin' | 'win32'];\n    if (!scriptName)\n      throw new Error(`Cannot install ${channel} on ${process.platform}`);\n    const shell = scriptName.endsWith('.ps1') ? 'powershell.exe' : 'bash';\n    const { code } = await spawnAsync(shell, [path.join(BIN_PATH, scriptName), ...scriptArgs], { cwd: BIN_PATH, stdio: 'inherit' });\n    if (code !== 0)\n      throw new Error(`Failed to install ${channel}`);\n  }\n\n  private async _validateInstallationCache(linksDir: string) {\n    // 1. Collect used downloads and package descriptors.\n    const usedBrowserPaths: Set<string> = new Set();\n    for (const fileName of await fs.promises.readdir(linksDir)) {\n      const linkPath = path.join(linksDir, fileName);\n      let linkTarget = '';\n      try {\n        linkTarget = (await fs.promises.readFile(linkPath)).toString();\n        const descriptors = readDescriptors(linkTarget);\n        for (const browserName of allDownloadable) {\n          // We retain browsers if they are found in the descriptor.\n          // Note, however, that there are older versions out in the wild that rely on\n          // the \"download\" field in the browser descriptor and use its value\n          // to retain and download browsers.\n          // As of v1.10, we decided to abandon \"download\" field.\n          const descriptor = descriptors.find(d => d.name === browserName);\n          if (!descriptor)\n            continue;\n          const usedBrowserPath = descriptor.dir;\n          const browserRevision = parseInt(descriptor.revision, 10);\n          // Old browser installations don't have marker file.\n          const shouldHaveMarkerFile = (browserName === 'chromium' && browserRevision >= 786218) ||\n              (browserName === 'firefox' && browserRevision >= 1128) ||\n              (browserName === 'webkit' && browserRevision >= 1307) ||\n              // All new applications have a marker file right away.\n              (browserName !== 'firefox' && browserName !== 'chromium' && browserName !== 'webkit');\n          if (!shouldHaveMarkerFile || (await existsAsync(markerFilePath(usedBrowserPath))))\n            usedBrowserPaths.add(usedBrowserPath);\n        }\n      } catch (e) {\n        await fs.promises.unlink(linkPath).catch(e => {});\n      }\n    }\n\n    // 2. Delete all unused browsers.\n    if (!getAsBooleanFromENV('PLAYWRIGHT_SKIP_BROWSER_GC')) {\n      let downloadedBrowsers = (await fs.promises.readdir(registryDirectory)).map(file => path.join(registryDirectory, file));\n      downloadedBrowsers = downloadedBrowsers.filter(file => isBrowserDirectory(file));\n      const directories = new Set<string>(downloadedBrowsers);\n      for (const browserDirectory of usedBrowserPaths)\n        directories.delete(browserDirectory);\n      for (const directory of directories)\n        logPolitely('Removing unused browser at ' + directory);\n      await removeFolders([...directories]);\n    }\n  }\n}\n\nfunction markerFilePath(browserDirectory: string): string {\n  return path.join(browserDirectory, 'INSTALLATION_COMPLETE');\n}\n\nexport async function installDefaultBrowsersForNpmInstall() {\n  // PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD should have a value of 0 or 1\n  if (getAsBooleanFromENV('PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD')) {\n    logPolitely('Skipping browsers download because `PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD` env variable is set');\n    return false;\n  }\n  await registry.install();\n}\n\nexport const registry = new Registry(PACKAGE_PATH);\n"],"file":"registry.js"}