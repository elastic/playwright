{"version":3,"sources":["../../src/dispatchers/networkDispatchers.ts"],"names":["RequestDispatcher","Dispatcher","from","scope","request","result","fromNullable","undefined","constructor","postData","postDataBuffer","frame","FrameDispatcher","url","resourceType","method","toString","headers","isNavigationRequest","redirectedFrom","response","_object","ResponseDispatcher","status","statusText","requestHeaders","timing","finished","_finishedPromise","body","binary","securityDetails","value","serverAddr","RouteDispatcher","route","responseBody","params","metadata","continue","Buffer","interceptResponse","_scope","fulfill","abort","errorCode","WebSocketDispatcher","webSocket","on","WebSocket","Events","FrameSent","event","_dispatchEvent","FrameReceived","SocketError","error","Close"],"mappings":"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","sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Request, Response, Route, WebSocket } from '../server/network';\nimport * as channels from '../protocol/channels';\nimport { Dispatcher, DispatcherScope, lookupNullableDispatcher, existingDispatcher } from './dispatcher';\nimport { FrameDispatcher } from './frameDispatcher';\n\nexport class RequestDispatcher extends Dispatcher<Request, channels.RequestInitializer> implements channels.RequestChannel {\n\n  static from(scope: DispatcherScope, request: Request): RequestDispatcher {\n    const result = existingDispatcher<RequestDispatcher>(request);\n    return result || new RequestDispatcher(scope, request);\n  }\n\n  static fromNullable(scope: DispatcherScope, request: Request | null): RequestDispatcher | undefined {\n    return request ? RequestDispatcher.from(scope, request) : undefined;\n  }\n\n  private constructor(scope: DispatcherScope, request: Request) {\n    const postData = request.postDataBuffer();\n    super(scope, request, 'Request', {\n      frame: FrameDispatcher.from(scope, request.frame()),\n      url: request.url(),\n      resourceType: request.resourceType(),\n      method: request.method(),\n      postData: postData === null ? undefined : postData.toString('base64'),\n      headers: request.headers(),\n      isNavigationRequest: request.isNavigationRequest(),\n      redirectedFrom: RequestDispatcher.fromNullable(scope, request.redirectedFrom()),\n    });\n  }\n\n  async response(): Promise<channels.RequestResponseResult> {\n    return { response: lookupNullableDispatcher<ResponseDispatcher>(await this._object.response()) };\n  }\n}\n\nexport class ResponseDispatcher extends Dispatcher<Response, channels.ResponseInitializer> implements channels.ResponseChannel {\n\n  static from(scope: DispatcherScope, response: Response): ResponseDispatcher {\n    const result = existingDispatcher<ResponseDispatcher>(response);\n    return result || new ResponseDispatcher(scope, response);\n  }\n\n  static fromNullable(scope: DispatcherScope, response: Response | null): ResponseDispatcher | undefined {\n    return response ? ResponseDispatcher.from(scope, response) : undefined;\n  }\n\n  private constructor(scope: DispatcherScope, response: Response) {\n    super(scope, response, 'Response', {\n      // TODO: responses in popups can point to non-reported requests.\n      request: RequestDispatcher.from(scope, response.request()),\n      url: response.url(),\n      status: response.status(),\n      statusText: response.statusText(),\n      requestHeaders: response.request().headers(),\n      headers: response.headers(),\n      timing: response.timing()\n    });\n  }\n\n  async finished(): Promise<channels.ResponseFinishedResult> {\n    return await this._object._finishedPromise;\n  }\n\n  async body(): Promise<channels.ResponseBodyResult> {\n    return { binary: (await this._object.body()).toString('base64') };\n  }\n\n  async securityDetails(): Promise<channels.ResponseSecurityDetailsResult> {\n    return { value: await this._object.securityDetails() || undefined };\n  }\n\n  async serverAddr(): Promise<channels.ResponseServerAddrResult> {\n    return { value: await this._object.serverAddr() || undefined };\n  }\n}\n\nexport class RouteDispatcher extends Dispatcher<Route, channels.RouteInitializer> implements channels.RouteChannel {\n\n  static from(scope: DispatcherScope, route: Route): RouteDispatcher {\n    const result = existingDispatcher<RouteDispatcher>(route);\n    return result || new RouteDispatcher(scope, route);\n  }\n\n  private constructor(scope: DispatcherScope, route: Route) {\n    super(scope, route, 'Route', {\n      // Context route can point to a non-reported request.\n      request: RequestDispatcher.from(scope, route.request())\n    });\n  }\n\n  async responseBody(params?: channels.RouteResponseBodyParams, metadata?: channels.Metadata): Promise<channels.RouteResponseBodyResult> {\n    return { binary: (await this._object.responseBody()).toString('base64') };\n  }\n\n  async continue(params: channels.RouteContinueParams, metadata?: channels.Metadata): Promise<channels.RouteContinueResult> {\n    const response = await this._object.continue({\n      url: params.url,\n      method: params.method,\n      headers: params.headers,\n      postData: params.postData ? Buffer.from(params.postData, 'base64') : undefined,\n      interceptResponse: params.interceptResponse\n    });\n    const result: channels.RouteContinueResult = {};\n    if (response) {\n      result.response = {\n        request: RequestDispatcher.from(this._scope, response.request()),\n        status: response.status(),\n        statusText: response.statusText(),\n        headers: response.headers(),\n      };\n    }\n    return result;\n  }\n\n  async fulfill(params: channels.RouteFulfillParams): Promise<void> {\n    await this._object.fulfill(params);\n  }\n\n  async abort(params: channels.RouteAbortParams): Promise<void> {\n    await this._object.abort(params.errorCode || 'failed');\n  }\n}\n\nexport class WebSocketDispatcher extends Dispatcher<WebSocket, channels.WebSocketInitializer> implements channels.WebSocketChannel {\n  constructor(scope: DispatcherScope, webSocket: WebSocket) {\n    super(scope, webSocket, 'WebSocket', {\n      url: webSocket.url(),\n    });\n    webSocket.on(WebSocket.Events.FrameSent, (event: { opcode: number, data: string }) => this._dispatchEvent('frameSent', event));\n    webSocket.on(WebSocket.Events.FrameReceived, (event: { opcode: number, data: string }) => this._dispatchEvent('frameReceived', event));\n    webSocket.on(WebSocket.Events.SocketError, (error: string) => this._dispatchEvent('socketError', { error }));\n    webSocket.on(WebSocket.Events.Close, () => this._dispatchEvent('close', {}));\n  }\n}\n"],"file":"networkDispatchers.js"}