{"version":3,"file":"driver.js","names":["_fs","_interopRequireDefault","require","playwright","_interopRequireWildcard","_server","_transport","_playwrightServer","_processLauncher","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","obj","printApiJson","console","log","JSON","stringify","runDriver","dispatcherConnection","DispatcherConnection","RootDispatcher","rootScope","sdkLanguage","createPlaywright","PlaywrightDispatcher","transport","PipeTransport","process","stdout","stdin","onmessage","message","dispatch","parse","isJavaScriptLanguageBinding","env","PW_LANG_NAME","replacer","String","toWellFormed","key","value","undefined","send","onclose","gracefullyProcessExitDoNotHang","on","runServer","options","port","host","path","maxConnections","Infinity","extension","server","PlaywrightServer","mode","wsEndpoint","listen","close","catch","error","launchBrowserServer","browserName","configFile","fs","readFileSync","toString","browserType","launchServer"],"sources":["../../src/cli/driver.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\n/* eslint-disable no-console */\n\nimport fs from 'fs';\nimport * as playwright from '../..';\nimport type { BrowserType } from '../client/browserType';\nimport type { LaunchServerOptions } from '../client/types';\nimport { createPlaywright, DispatcherConnection, RootDispatcher, PlaywrightDispatcher } from '../server';\nimport { PipeTransport } from '../protocol/transport';\nimport { PlaywrightServer } from '../remote/playwrightServer';\nimport { gracefullyProcessExitDoNotHang } from '../utils/processLauncher';\n\nexport function printApiJson() {\n  // Note: this file is generated by build-playwright-driver.sh\n  console.log(JSON.stringify(require('../../api.json')));\n}\n\nexport function runDriver() {\n  const dispatcherConnection = new DispatcherConnection();\n  new RootDispatcher(dispatcherConnection, async (rootScope, { sdkLanguage }) => {\n    const playwright = createPlaywright({ sdkLanguage });\n    return new PlaywrightDispatcher(rootScope, playwright);\n  });\n  const transport = new PipeTransport(process.stdout, process.stdin);\n  transport.onmessage = (message: string) => dispatcherConnection.dispatch(JSON.parse(message));\n  // Certain Language Binding JSON parsers (e.g. .NET) do not like strings with lone surrogates.\n  const isJavaScriptLanguageBinding = !process.env.PW_LANG_NAME || process.env.PW_LANG_NAME === 'javascript';\n  const replacer = !isJavaScriptLanguageBinding && (String.prototype as any).toWellFormed ? (key: string, value: any): any => {\n    if (typeof value === 'string')\n      return value.toWellFormed();\n    return value;\n  } : undefined;\n  dispatcherConnection.onmessage = message => transport.send(JSON.stringify(message, replacer));\n  transport.onclose = () => {\n    // Drop any messages during shutdown on the floor.\n    dispatcherConnection.onmessage = () => {};\n    gracefullyProcessExitDoNotHang(0);\n  };\n  // Ignore the SIGINT signal in the driver process so the parent can gracefully close the connection.\n  // We still will destruct everything (close browsers and exit) when the transport pipe closes.\n  process.on('SIGINT', () => {\n    // Keep the process running.\n  });\n}\n\nexport type RunServerOptions = {\n  port?: number,\n  host?: string,\n  path?: string,\n  extension?: boolean,\n  maxConnections?: number,\n  browserProxyMode?: 'client' | 'tether',\n  ownedByTetherClient?: boolean,\n};\n\nexport async function runServer(options: RunServerOptions) {\n  const {\n    port,\n    host,\n    path = '/',\n    maxConnections = Infinity,\n    extension,\n  } = options;\n  const server = new PlaywrightServer({ mode: extension ? 'extension' : 'default', path, maxConnections });\n  const wsEndpoint = await server.listen(port, host);\n  process.on('exit', () => server.close().catch(console.error));\n  console.log('Listening on ' + wsEndpoint);\n  process.stdin.on('close', () => gracefullyProcessExitDoNotHang(0));\n}\n\nexport async function launchBrowserServer(browserName: string, configFile?: string) {\n  let options: LaunchServerOptions = {};\n  if (configFile)\n    options = JSON.parse(fs.readFileSync(configFile).toString());\n  const browserType = (playwright as any)[browserName] as BrowserType;\n  const server = await browserType.launchServer(options);\n  console.log(server.wsEndpoint());\n}\n"],"mappings":"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"}