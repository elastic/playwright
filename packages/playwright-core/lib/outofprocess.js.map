{"version":3,"file":"outofprocess.js","names":["_connection","require","_transport","childProcess","_interopRequireWildcard","path","_manualPromise","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","start","env","client","PlaywrightClient","playwright","_playwright","driverProcess","_driverProcess","stop","constructor","_closePromise","ManualPromise","fork","join","__dirname","stdio","detached","process","unref","stderr","on","data","write","connection","Connection","undefined","transport","PipeTransport","stdin","stdout","onmessage","message","send","JSON","stringify","dispatch","parse","onclose","resolve","initializePlaywright","destroy"],"sources":["../src/outofprocess.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Connection } from './client/connection';\nimport { PipeTransport } from './protocol/transport';\nimport type { Playwright } from './client/playwright';\nimport * as childProcess from 'child_process';\nimport * as path from 'path';\nimport { ManualPromise } from './utils/manualPromise';\n\nexport async function start(env: any = {}): Promise<{ playwright: Playwright, stop: () => Promise<void> }> {\n  const client = new PlaywrightClient(env);\n  const playwright = await client._playwright;\n  (playwright as any).driverProcess = client._driverProcess;\n  return { playwright, stop: () => client.stop() };\n}\n\nclass PlaywrightClient {\n  _playwright: Promise<Playwright>;\n  _driverProcess: childProcess.ChildProcess;\n  private _closePromise = new ManualPromise<void>();\n\n  constructor(env: any) {\n    this._driverProcess = childProcess.fork(path.join(__dirname, '..', 'cli.js'), ['run-driver'], {\n      stdio: 'pipe',\n      detached: true,\n      env: {\n        ...process.env,\n        ...env\n      },\n    });\n    this._driverProcess.unref();\n    this._driverProcess.stderr!.on('data', data => process.stderr.write(data));\n\n    const connection = new Connection(undefined, undefined);\n    const transport = new PipeTransport(this._driverProcess.stdin!, this._driverProcess.stdout!);\n    connection.onmessage = message => transport.send(JSON.stringify(message));\n    transport.onmessage = message => connection.dispatch(JSON.parse(message));\n    transport.onclose = () => this._closePromise.resolve();\n\n    this._playwright = connection.initializePlaywright();\n  }\n\n  async stop() {\n    this._driverProcess.stdin!.destroy();\n    this._driverProcess.stdout!.destroy();\n    this._driverProcess.stderr!.destroy();\n    await this._closePromise;\n  }\n}\n"],"mappings":"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"}