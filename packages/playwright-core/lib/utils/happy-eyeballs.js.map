{"version":3,"file":"happy-eyeballs.js","names":["dns","_interopRequireWildcard","require","http","https","net","tls","_manualPromise","_debug","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","connectionAttemptDelayMs","HttpHappyEyeballsAgent","Agent","createConnection","options","oncreate","isIP","clientRequestArgsToHostName","createConnectionAsync","catch","err","HttpsHappyEyeballsAgent","connect","httpsHappyEyeballsAgent","exports","keepAlive","httpHappyEyeballsAgent","createSocket","host","port","Promise","resolve","reject","socket","on","error","createTLSSocket","assert","useTLS","lookup","__testHookLookup","lookupAddresses","hostname","addresses","sockets","Set","firstError","errorCount","handleError","_firstError","delete","length","connected","ManualPromise","address","servername","s","destroy","clear","Error","add","race","f","setTimeout","isDone","promises","all","family","verbatim","firstFamily","filter","secondFamily","tmp","result","Math","max","push"],"sources":["../../src/utils/happy-eyeballs.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as dns from 'dns';\nimport * as http from 'http';\nimport * as https from 'https';\nimport * as net from 'net';\nimport * as tls from 'tls';\nimport { ManualPromise } from './manualPromise';\nimport { assert } from './debug';\n\n// Implementation(partial) of Happy Eyeballs 2 algorithm described in\n// https://www.rfc-editor.org/rfc/rfc8305\n\n// Same as in Chromium (https://source.chromium.org/chromium/chromium/src/+/5666ff4f5077a7e2f72902f3a95f5d553ea0d88d:net/socket/transport_connect_job.cc;l=102)\nconst connectionAttemptDelayMs = 300;\n\nclass HttpHappyEyeballsAgent extends http.Agent {\n  createConnection(options: http.ClientRequestArgs, oncreate?: (err: Error | null, socket?: net.Socket) => void): net.Socket | undefined {\n    // There is no ambiguity in case of IP address.\n    if (net.isIP(clientRequestArgsToHostName(options)))\n      return net.createConnection(options as net.NetConnectOpts);\n    createConnectionAsync(options, oncreate, /* useTLS */ false).catch(err => oncreate?.(err));\n  }\n}\n\nclass HttpsHappyEyeballsAgent extends https.Agent {\n  createConnection(options: http.ClientRequestArgs, oncreate?: (err: Error | null, socket?: net.Socket) => void): net.Socket | undefined {\n    // There is no ambiguity in case of IP address.\n    if (net.isIP(clientRequestArgsToHostName(options)))\n      return tls.connect(options as tls.ConnectionOptions);\n    createConnectionAsync(options, oncreate, /* useTLS */ true).catch(err => oncreate?.(err));\n  }\n}\n\n// These options are aligned with the default Node.js globalAgent options.\nexport const httpsHappyEyeballsAgent = new HttpsHappyEyeballsAgent({ keepAlive: true });\nexport const httpHappyEyeballsAgent = new HttpHappyEyeballsAgent({ keepAlive: true });\n\nexport async function createSocket(host: string, port: number): Promise<net.Socket> {\n  return new Promise((resolve, reject) => {\n    if (net.isIP(host)) {\n      const socket = net.createConnection({ host, port });\n      socket.on('connect', () => resolve(socket));\n      socket.on('error', error => reject(error));\n    } else {\n      createConnectionAsync({ host, port }, (err, socket) => {\n        if (err)\n          reject(err);\n        if (socket)\n          resolve(socket);\n      }, /* useTLS */ false).catch(err => reject(err));\n    }\n  });\n}\n\nexport async function createTLSSocket(options: tls.ConnectionOptions): Promise<tls.TLSSocket> {\n  return new Promise((resolve, reject) => {\n    assert(options.host, 'host is required');\n    if (net.isIP(options.host)) {\n      const socket = tls.connect(options)\n      socket.on('secureConnect', () => resolve(socket));\n      socket.on('error', error => reject(error));\n    } else {\n      createConnectionAsync(options, (err, socket) => {\n        if (err)\n          reject(err);\n        if (socket) {\n          socket.on('secureConnect', () => resolve(socket));\n          socket.on('error', error => reject(error));\n        }\n      }, true).catch(err => reject(err));\n    }\n  });\n}\n\nexport async function createConnectionAsync(\n  options: http.ClientRequestArgs, \n  oncreate: ((err: Error | null, socket?: tls.TLSSocket) => void) | undefined, \n  useTLS: true\n): Promise<void>;\n\nexport async function createConnectionAsync(\n  options: http.ClientRequestArgs, \n  oncreate: ((err: Error | null, socket?: net.Socket) => void) | undefined, \n  useTLS: false\n): Promise<void>;\n\nexport async function createConnectionAsync(\n  options: http.ClientRequestArgs, \n  oncreate: ((err: Error | null, socket?: any) => void) | undefined, \n  useTLS: boolean\n): Promise<void> {\n  const lookup = (options as any).__testHookLookup || lookupAddresses;\n  const hostname = clientRequestArgsToHostName(options);\n  const addresses = await lookup(hostname);\n  const sockets = new Set<net.Socket>();\n  let firstError;\n  let errorCount = 0;\n  const handleError = (socket: net.Socket, err: Error) => {\n    if (!sockets.delete(socket))\n      return;\n    ++errorCount;\n    firstError ??= err;\n    if (errorCount === addresses.length)\n      oncreate?.(firstError);\n  };\n\n  const connected = new ManualPromise();\n  for (const { address } of addresses) {\n    const socket = useTLS ?\n      tls.connect({\n        ...(options as tls.ConnectionOptions),\n        port: options.port as number,\n        host: address,\n        servername: hostname }) :\n      net.createConnection({\n        ...options,\n        port: options.port as number,\n        host: address });\n\n    // Each socket may fire only one of 'connect', 'timeout' or 'error' events.\n    // None of these events are fired after socket.destroy() is called.\n    socket.on('connect', () => {\n      connected.resolve();\n      oncreate?.(null, socket);\n      // TODO: Cache the result?\n      // Close other outstanding sockets.\n      sockets.delete(socket);\n      for (const s of sockets)\n        s.destroy();\n      sockets.clear();\n    });\n    socket.on('timeout', () => {\n      // Timeout is not an error, so we have to manually close the socket.\n      socket.destroy();\n      handleError(socket, new Error('Connection timeout'));\n    });\n    socket.on('error', e => handleError(socket, e));\n    sockets.add(socket);\n    await Promise.race([\n      connected,\n      new Promise(f => setTimeout(f, connectionAttemptDelayMs))\n    ]);\n    if (connected.isDone())\n      break;\n  }\n}\n\nasync function lookupAddresses(hostname: string): Promise<dns.LookupAddress[]> {\n  const addresses = await dns.promises.lookup(hostname, { all: true, family: 0, verbatim: true });\n  let firstFamily = addresses.filter(({ family }) => family === 6);\n  let secondFamily = addresses.filter(({ family }) => family === 4);\n  // Make sure first address in the list is the same as in the original order.\n  if (firstFamily.length && firstFamily[0] !== addresses[0]) {\n    const tmp = firstFamily;\n    firstFamily = secondFamily;\n    secondFamily = tmp;\n  }\n  const result = [];\n  // Alternate ipv6 and ipv4 addresses.\n  for (let i = 0; i < Math.max(firstFamily.length, secondFamily.length); i++) {\n    if (firstFamily[i])\n      result.push(firstFamily[i]);\n    if (secondFamily[i])\n      result.push(secondFamily[i]);\n  }\n  return result;\n}\n\nfunction clientRequestArgsToHostName(options: http.ClientRequestArgs): string {\n  if (options.hostname)\n    return options.hostname;\n  if (options.host)\n    return options.host;\n  throw new Error('Either options.hostname or options.host must be provided');\n}\n\n"],"mappings":";;;;;;;;;AAgBA,IAAAA,GAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,IAAA,GAAAF,uBAAA,CAAAC,OAAA;AACA,IAAAE,KAAA,GAAAH,uBAAA,CAAAC,OAAA;AACA,IAAAG,GAAA,GAAAJ,uBAAA,CAAAC,OAAA;AACA,IAAAI,GAAA,GAAAL,uBAAA,CAAAC,OAAA;AACA,IAAAK,cAAA,GAAAL,OAAA;AACA,IAAAM,MAAA,GAAAN,OAAA;AAAiC,SAAAO,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAT,wBAAAS,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,IAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAjB,CAAA,EAAAc,CAAA,SAAAI,CAAA,GAAAR,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAI,CAAA,KAAAA,CAAA,CAAAX,GAAA,IAAAW,CAAA,CAAAC,GAAA,IAAAR,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAI,CAAA,IAAAV,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAgB,GAAA,CAAAnB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAtBjC;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAUA;AACA;;AAEA;AACA,MAAMY,wBAAwB,GAAG,GAAG;AAEpC,MAAMC,sBAAsB,SAAS5B,IAAI,CAAC6B,KAAK,CAAC;EAC9CC,gBAAgBA,CAACC,OAA+B,EAAEC,QAA2D,EAA0B;IACrI;IACA,IAAI9B,GAAG,CAAC+B,IAAI,CAACC,2BAA2B,CAACH,OAAO,CAAC,CAAC,EAChD,OAAO7B,GAAG,CAAC4B,gBAAgB,CAACC,OAA6B,CAAC;IAC5DI,qBAAqB,CAACJ,OAAO,EAAEC,QAAQ,EAAE,YAAa,KAAK,CAAC,CAACI,KAAK,CAACC,GAAG,IAAIL,QAAQ,aAARA,QAAQ,uBAARA,QAAQ,CAAGK,GAAG,CAAC,CAAC;EAC5F;AACF;AAEA,MAAMC,uBAAuB,SAASrC,KAAK,CAAC4B,KAAK,CAAC;EAChDC,gBAAgBA,CAACC,OAA+B,EAAEC,QAA2D,EAA0B;IACrI;IACA,IAAI9B,GAAG,CAAC+B,IAAI,CAACC,2BAA2B,CAACH,OAAO,CAAC,CAAC,EAChD,OAAO5B,GAAG,CAACoC,OAAO,CAACR,OAAgC,CAAC;IACtDI,qBAAqB,CAACJ,OAAO,EAAEC,QAAQ,EAAE,YAAa,IAAI,CAAC,CAACI,KAAK,CAACC,GAAG,IAAIL,QAAQ,aAARA,QAAQ,uBAARA,QAAQ,CAAGK,GAAG,CAAC,CAAC;EAC3F;AACF;;AAEA;AACO,MAAMG,uBAAuB,GAAAC,OAAA,CAAAD,uBAAA,GAAG,IAAIF,uBAAuB,CAAC;EAAEI,SAAS,EAAE;AAAK,CAAC,CAAC;AAChF,MAAMC,sBAAsB,GAAAF,OAAA,CAAAE,sBAAA,GAAG,IAAIf,sBAAsB,CAAC;EAAEc,SAAS,EAAE;AAAK,CAAC,CAAC;AAE9E,eAAeE,YAAYA,CAACC,IAAY,EAAEC,IAAY,EAAuB;EAClF,OAAO,IAAIC,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;IACtC,IAAI/C,GAAG,CAAC+B,IAAI,CAACY,IAAI,CAAC,EAAE;MAClB,MAAMK,MAAM,GAAGhD,GAAG,CAAC4B,gBAAgB,CAAC;QAAEe,IAAI;QAAEC;MAAK,CAAC,CAAC;MACnDI,MAAM,CAACC,EAAE,CAAC,SAAS,EAAE,MAAMH,OAAO,CAACE,MAAM,CAAC,CAAC;MAC3CA,MAAM,CAACC,EAAE,CAAC,OAAO,EAAEC,KAAK,IAAIH,MAAM,CAACG,KAAK,CAAC,CAAC;IAC5C,CAAC,MAAM;MACLjB,qBAAqB,CAAC;QAAEU,IAAI;QAAEC;MAAK,CAAC,EAAE,CAACT,GAAG,EAAEa,MAAM,KAAK;QACrD,IAAIb,GAAG,EACLY,MAAM,CAACZ,GAAG,CAAC;QACb,IAAIa,MAAM,EACRF,OAAO,CAACE,MAAM,CAAC;MACnB,CAAC,EAAE,YAAa,KAAK,CAAC,CAACd,KAAK,CAACC,GAAG,IAAIY,MAAM,CAACZ,GAAG,CAAC,CAAC;IAClD;EACF,CAAC,CAAC;AACJ;AAEO,eAAegB,eAAeA,CAACtB,OAA8B,EAA0B;EAC5F,OAAO,IAAIgB,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK;IACtC,IAAAK,aAAM,EAACvB,OAAO,CAACc,IAAI,EAAE,kBAAkB,CAAC;IACxC,IAAI3C,GAAG,CAAC+B,IAAI,CAACF,OAAO,CAACc,IAAI,CAAC,EAAE;MAC1B,MAAMK,MAAM,GAAG/C,GAAG,CAACoC,OAAO,CAACR,OAAO,CAAC;MACnCmB,MAAM,CAACC,EAAE,CAAC,eAAe,EAAE,MAAMH,OAAO,CAACE,MAAM,CAAC,CAAC;MACjDA,MAAM,CAACC,EAAE,CAAC,OAAO,EAAEC,KAAK,IAAIH,MAAM,CAACG,KAAK,CAAC,CAAC;IAC5C,CAAC,MAAM;MACLjB,qBAAqB,CAACJ,OAAO,EAAE,CAACM,GAAG,EAAEa,MAAM,KAAK;QAC9C,IAAIb,GAAG,EACLY,MAAM,CAACZ,GAAG,CAAC;QACb,IAAIa,MAAM,EAAE;UACVA,MAAM,CAACC,EAAE,CAAC,eAAe,EAAE,MAAMH,OAAO,CAACE,MAAM,CAAC,CAAC;UACjDA,MAAM,CAACC,EAAE,CAAC,OAAO,EAAEC,KAAK,IAAIH,MAAM,CAACG,KAAK,CAAC,CAAC;QAC5C;MACF,CAAC,EAAE,IAAI,CAAC,CAAChB,KAAK,CAACC,GAAG,IAAIY,MAAM,CAACZ,GAAG,CAAC,CAAC;IACpC;EACF,CAAC,CAAC;AACJ;AAcO,eAAeF,qBAAqBA,CACzCJ,OAA+B,EAC/BC,QAAiE,EACjEuB,MAAe,EACA;EACf,MAAMC,MAAM,GAAIzB,OAAO,CAAS0B,gBAAgB,IAAIC,eAAe;EACnE,MAAMC,QAAQ,GAAGzB,2BAA2B,CAACH,OAAO,CAAC;EACrD,MAAM6B,SAAS,GAAG,MAAMJ,MAAM,CAACG,QAAQ,CAAC;EACxC,MAAME,OAAO,GAAG,IAAIC,GAAG,CAAa,CAAC;EACrC,IAAIC,UAAU;EACd,IAAIC,UAAU,GAAG,CAAC;EAClB,MAAMC,WAAW,GAAGA,CAACf,MAAkB,EAAEb,GAAU,KAAK;IAAA,IAAA6B,WAAA;IACtD,IAAI,CAACL,OAAO,CAACM,MAAM,CAACjB,MAAM,CAAC,EACzB;IACF,EAAEc,UAAU;IACZ,CAAAE,WAAA,GAAAH,UAAU,cAAAG,WAAA,cAAAA,WAAA,GAAVH,UAAU,GAAK1B,GAAG;IAClB,IAAI2B,UAAU,KAAKJ,SAAS,CAACQ,MAAM,EACjCpC,QAAQ,aAARA,QAAQ,eAARA,QAAQ,CAAG+B,UAAU,CAAC;EAC1B,CAAC;EAED,MAAMM,SAAS,GAAG,IAAIC,4BAAa,CAAC,CAAC;EACrC,KAAK,MAAM;IAAEC;EAAQ,CAAC,IAAIX,SAAS,EAAE;IACnC,MAAMV,MAAM,GAAGK,MAAM,GACnBpD,GAAG,CAACoC,OAAO,CAAC;MACV,GAAIR,OAAiC;MACrCe,IAAI,EAAEf,OAAO,CAACe,IAAc;MAC5BD,IAAI,EAAE0B,OAAO;MACbC,UAAU,EAAEb;IAAS,CAAC,CAAC,GACzBzD,GAAG,CAAC4B,gBAAgB,CAAC;MACnB,GAAGC,OAAO;MACVe,IAAI,EAAEf,OAAO,CAACe,IAAc;MAC5BD,IAAI,EAAE0B;IAAQ,CAAC,CAAC;;IAEpB;IACA;IACArB,MAAM,CAACC,EAAE,CAAC,SAAS,EAAE,MAAM;MACzBkB,SAAS,CAACrB,OAAO,CAAC,CAAC;MACnBhB,QAAQ,aAARA,QAAQ,eAARA,QAAQ,CAAG,IAAI,EAAEkB,MAAM,CAAC;MACxB;MACA;MACAW,OAAO,CAACM,MAAM,CAACjB,MAAM,CAAC;MACtB,KAAK,MAAMuB,CAAC,IAAIZ,OAAO,EACrBY,CAAC,CAACC,OAAO,CAAC,CAAC;MACbb,OAAO,CAACc,KAAK,CAAC,CAAC;IACjB,CAAC,CAAC;IACFzB,MAAM,CAACC,EAAE,CAAC,SAAS,EAAE,MAAM;MACzB;MACAD,MAAM,CAACwB,OAAO,CAAC,CAAC;MAChBT,WAAW,CAACf,MAAM,EAAE,IAAI0B,KAAK,CAAC,oBAAoB,CAAC,CAAC;IACtD,CAAC,CAAC;IACF1B,MAAM,CAACC,EAAE,CAAC,OAAO,EAAE5C,CAAC,IAAI0D,WAAW,CAACf,MAAM,EAAE3C,CAAC,CAAC,CAAC;IAC/CsD,OAAO,CAACgB,GAAG,CAAC3B,MAAM,CAAC;IACnB,MAAMH,OAAO,CAAC+B,IAAI,CAAC,CACjBT,SAAS,EACT,IAAItB,OAAO,CAACgC,CAAC,IAAIC,UAAU,CAACD,CAAC,EAAEpD,wBAAwB,CAAC,CAAC,CAC1D,CAAC;IACF,IAAI0C,SAAS,CAACY,MAAM,CAAC,CAAC,EACpB;EACJ;AACF;AAEA,eAAevB,eAAeA,CAACC,QAAgB,EAAgC;EAC7E,MAAMC,SAAS,GAAG,MAAM/D,GAAG,CAACqF,QAAQ,CAAC1B,MAAM,CAACG,QAAQ,EAAE;IAAEwB,GAAG,EAAE,IAAI;IAAEC,MAAM,EAAE,CAAC;IAAEC,QAAQ,EAAE;EAAK,CAAC,CAAC;EAC/F,IAAIC,WAAW,GAAG1B,SAAS,CAAC2B,MAAM,CAAC,CAAC;IAAEH;EAAO,CAAC,KAAKA,MAAM,KAAK,CAAC,CAAC;EAChE,IAAII,YAAY,GAAG5B,SAAS,CAAC2B,MAAM,CAAC,CAAC;IAAEH;EAAO,CAAC,KAAKA,MAAM,KAAK,CAAC,CAAC;EACjE;EACA,IAAIE,WAAW,CAAClB,MAAM,IAAIkB,WAAW,CAAC,CAAC,CAAC,KAAK1B,SAAS,CAAC,CAAC,CAAC,EAAE;IACzD,MAAM6B,GAAG,GAAGH,WAAW;IACvBA,WAAW,GAAGE,YAAY;IAC1BA,YAAY,GAAGC,GAAG;EACpB;EACA,MAAMC,MAAM,GAAG,EAAE;EACjB;EACA,KAAK,IAAIjE,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGkE,IAAI,CAACC,GAAG,CAACN,WAAW,CAAClB,MAAM,EAAEoB,YAAY,CAACpB,MAAM,CAAC,EAAE3C,CAAC,EAAE,EAAE;IAC1E,IAAI6D,WAAW,CAAC7D,CAAC,CAAC,EAChBiE,MAAM,CAACG,IAAI,CAACP,WAAW,CAAC7D,CAAC,CAAC,CAAC;IAC7B,IAAI+D,YAAY,CAAC/D,CAAC,CAAC,EACjBiE,MAAM,CAACG,IAAI,CAACL,YAAY,CAAC/D,CAAC,CAAC,CAAC;EAChC;EACA,OAAOiE,MAAM;AACf;AAEA,SAASxD,2BAA2BA,CAACH,OAA+B,EAAU;EAC5E,IAAIA,OAAO,CAAC4B,QAAQ,EAClB,OAAO5B,OAAO,CAAC4B,QAAQ;EACzB,IAAI5B,OAAO,CAACc,IAAI,EACd,OAAOd,OAAO,CAACc,IAAI;EACrB,MAAM,IAAI+B,KAAK,CAAC,0DAA0D,CAAC;AAC7E"}