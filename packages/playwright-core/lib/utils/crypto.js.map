{"version":3,"file":"crypto.js","names":["_crypto","_interopRequireDefault","require","_debug","obj","__esModule","default","createGuid","crypto","randomBytes","toString","calculateSha1","buffer","hash","createHash","update","digest","encodeBase128","value","bytes","byte","length","push","Buffer","from","reverse","DER","encodeSequence","data","_encode","concat","encodeInteger","assert","encodeObjectIdentifier","oid","parts","split","map","v","Number","output","i","encodeNull","encodeSet","encodeExplicitContextDependent","tag","encodePrintableString","encodeBitString","unusedBits","content","encodeDate","date","year","getUTCFullYear","isGeneralizedTime","slice","getUTCMonth","padStart","getUTCDate","getUTCHours","getUTCMinutes","getUTCSeconds","encodedDate","join","lengthBytes","_encodeLength","unshift","generateSelfSignedCertificate","privateKey","publicKey","generateKeyPairSync","modulusLength","publicKeyDer","export","type","format","oneYearInMilliseconds","notBefore","Date","getTime","notAfter","tbsCertificate","signature","sign","certificate","certPem","match","cert","key"],"sources":["../../src/utils/crypto.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport crypto from 'crypto';\nimport { assert } from './debug';\n\nexport function createGuid(): string {\n  return crypto.randomBytes(16).toString('hex');\n}\n\nexport function calculateSha1(buffer: Buffer | string): string {\n  const hash = crypto.createHash('sha1');\n  hash.update(buffer);\n  return hash.digest('hex');\n}\n\n// Variable-length quantity encoding aka. base-128 encoding\nfunction encodeBase128(value: number): Buffer {\n  const bytes = [];\n  do {\n    let byte = value & 0x7f;\n    value >>>= 7;\n    if (bytes.length > 0) byte |= 0x80;\n    bytes.push(byte);\n  } while (value > 0);\n  return Buffer.from(bytes.reverse());\n};\n\n// ASN1/DER Speficiation:   https://www.itu.int/rec/T-REC-X.680-X.693-202102-I/en\nclass DER {\n  static encodeSequence(data: Buffer[]): Buffer {\n    return this._encode(0x30, Buffer.concat(data));\n  }\n  static encodeInteger(data: number): Buffer {\n    assert(data >= -128 && data <= 127);\n    return this._encode(0x02, Buffer.from([data]));\n  }\n  static encodeObjectIdentifier(oid: string): Buffer {\n    const parts = oid.split('.').map((v) => Number(v));\n    // Encode the second part, which could be large, using base-128 encoding if necessary\n    const output = [encodeBase128(40 * parts[0] + parts[1])];\n\n    for (let i = 2; i < parts.length; i++) {\n      output.push(encodeBase128(parts[i]));\n    }\n\n    return this._encode(0x06, Buffer.concat(output));\n  }\n  static encodeNull(): Buffer {\n    return Buffer.from([0x05, 0x00]);\n  }\n  static encodeSet(data: Buffer[]): Buffer {\n    assert(data.length === 1, 'Only one item in the set is supported. We\\'d need to sort the data to support more.');\n    // We expect the data to be already sorted.\n    return this._encode(0x31, Buffer.concat(data));\n  }\n  static encodeExplicitContextDependent(tag: number, data: Buffer): Buffer {\n    return this._encode(0xa0 + tag, data);\n  }\n  static encodePrintableString(data: string): Buffer {\n    return this._encode(0x13, Buffer.from(data));\n  }\n  static encodeBitString(data: Buffer): Buffer {\n    // The first byte of the content is the number of unused bits at the end\n    const unusedBits = 0; // Assuming all bits are used\n    const content = Buffer.concat([Buffer.from([unusedBits]), data]);\n    return this._encode(0x03, content);\n  }\n  static encodeDate(date: Date): Buffer {\n    const year = date.getUTCFullYear();\n    const isGeneralizedTime = year >= 2050;\n    const parts = [\n      isGeneralizedTime ? year.toString() : year.toString().slice(-2),\n      (date.getUTCMonth() + 1).toString().padStart(2, '0'),\n      date.getUTCDate().toString().padStart(2, '0'),\n      date.getUTCHours().toString().padStart(2, '0'),\n      date.getUTCMinutes().toString().padStart(2, '0'),\n      date.getUTCSeconds().toString().padStart(2, '0')\n    ];\n    const encodedDate = parts.join('') + 'Z';\n    const tag = isGeneralizedTime ? 0x18 : 0x17; // 0x18 for GeneralizedTime, 0x17 for UTCTime\n    return this._encode(tag, Buffer.from(encodedDate));\n  }\n  private static _encode(tag: number, data: Buffer): Buffer {\n    const lengthBytes = this._encodeLength(data.length);\n    return Buffer.concat([Buffer.from([tag]), lengthBytes, data]);\n  }\n  private static _encodeLength(length: number): Buffer {\n    if (length < 128) {\n      return Buffer.from([length]);\n    } else {\n      const lengthBytes = [];\n      while (length > 0) {\n        lengthBytes.unshift(length & 0xFF);\n        length >>= 8;\n      }\n      return Buffer.from([0x80 | lengthBytes.length, ...lengthBytes]);\n    }\n  }\n}\n\n// X.509 Specification: https://datatracker.ietf.org/doc/html/rfc2459#section-4.1\nexport function generateSelfSignedCertificate() {\n  const { privateKey, publicKey } = crypto.generateKeyPairSync('rsa', { modulusLength: 2048 });\n  const publicKeyDer = publicKey.export({ type: 'pkcs1', format: 'der' });\n\n  const oneYearInMilliseconds = 365 * 24 * 60 * 60 * 1_000;\n  const notBefore = new Date(new Date().getTime() - oneYearInMilliseconds);\n  const notAfter = new Date(new Date().getTime() + oneYearInMilliseconds);\n\n  // List of fields / structure: https://datatracker.ietf.org/doc/html/rfc2459#section-4.1\n  const tbsCertificate = DER.encodeSequence([\n    DER.encodeExplicitContextDependent(0, DER.encodeInteger(1)), // version\n    DER.encodeInteger(1), // serialNumber\n    DER.encodeSequence([\n      DER.encodeObjectIdentifier('1.2.840.113549.1.1.11'), // sha256WithRSAEncryption PKCS #1\n      DER.encodeNull()\n    ]), // signature\n    DER.encodeSequence([\n      DER.encodeSet([\n        DER.encodeSequence([\n          DER.encodeObjectIdentifier('2.5.4.3'), // commonName X.520 DN component\n          DER.encodePrintableString('localhost')\n        ]),\n      ]),\n      DER.encodeSet([\n        DER.encodeSequence([\n          DER.encodeObjectIdentifier('2.5.4.10'), // organizationName X.520 DN component\n          DER.encodePrintableString('Playwright Client Certificate Support')\n        ])\n      ])\n    ]), // issuer\n    DER.encodeSequence([\n      DER.encodeDate(notBefore), // notBefore\n      DER.encodeDate(notAfter), // notAfter\n    ]), // validity\n    DER.encodeSequence([\n      DER.encodeSet([\n        DER.encodeSequence([\n          DER.encodeObjectIdentifier('2.5.4.3'), // commonName X.520 DN component\n          DER.encodePrintableString('localhost')\n        ]),\n      ]),\n      DER.encodeSet([\n        DER.encodeSequence([\n          DER.encodeObjectIdentifier('2.5.4.10'), // organizationName X.520 DN component\n          DER.encodePrintableString('Playwright Client Certificate Support')\n        ])\n      ])\n    ]), // subject\n    DER.encodeSequence([\n      DER.encodeSequence([\n        DER.encodeObjectIdentifier('1.2.840.113549.1.1.1'), // rsaEncryption PKCS #1\n        DER.encodeNull()\n      ]),\n      DER.encodeBitString(publicKeyDer)\n    ]), // SubjectPublicKeyInfo\n  ]);\n\n  const signature = crypto.sign('sha256', tbsCertificate, privateKey);\n\n  const certificate = DER.encodeSequence([\n    tbsCertificate,\n    DER.encodeSequence([\n      DER.encodeObjectIdentifier('1.2.840.113549.1.1.11'), // sha256WithRSAEncryption PKCS #1\n      DER.encodeNull()\n    ]),\n    DER.encodeBitString(signature)\n  ]);\n\n  const certPem = [\n    '-----BEGIN CERTIFICATE-----',\n    // Split the base64 string into lines of 64 characters\n    certificate.toString('base64').match(/.{1,64}/g)!.join('\\n'),\n    '-----END CERTIFICATE-----'\n  ].join('\\n');\n\n  return {\n    cert: certPem,\n    key: privateKey.export({ type: 'pkcs1', format: 'pem' }),\n  };\n}\n"],"mappings":"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"}