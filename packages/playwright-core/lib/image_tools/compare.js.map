{"version":3,"file":"compare.js","names":["_colorUtils","require","_imageChannel","_stats","SSIM_WINDOW_RADIUS","VARIANCE_WINDOW_RADIUS","drawPixel","width","data","x","y","r","g","b","idx","compare","actual","expected","diff","height","options","maxColorDeltaE94","paddingSize","Math","max","paddingColorEven","paddingColorOdd","r1","g1","b1","ImageChannel","intoRGB","r2","g2","b2","noop","drawRedPixel","drawYellowPixel","drawGrayPixel","gray","rgb2gray","get","value","blendWithWhite","fastR","fastG","fastB","diffCount","delta","colorDeltaE94","FastStats","varX1","varY1","boundXY","varX2","varY2","var1","varianceC1","var2","varianceC2","ssimX1","ssimY1","ssimX2","ssimY2","ssimRGB","ssim","isAntialiased"],"sources":["../../src/image_tools/compare.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { blendWithWhite, colorDeltaE94, rgb2gray } from './colorUtils';\nimport { ImageChannel } from './imageChannel';\nimport { ssim, FastStats } from './stats';\n\nconst SSIM_WINDOW_RADIUS = 15;\nconst VARIANCE_WINDOW_RADIUS = 1;\n\nfunction drawPixel(width: number, data: Buffer, x: number, y: number, r: number, g: number, b: number) {\n  const idx = (y * width + x) * 4;\n  data[idx + 0] = r;\n  data[idx + 1] = g;\n  data[idx + 2] = b;\n  data[idx + 3] = 255;\n}\n\ntype CompareOptions = {\n  maxColorDeltaE94?: number;\n};\n\nexport function compare(actual: Buffer, expected: Buffer, diff: Buffer|null, width: number, height: number, options: CompareOptions = {}) {\n  const {\n    maxColorDeltaE94 = 1.0,\n  } = options;\n\n  const paddingSize = Math.max(VARIANCE_WINDOW_RADIUS, SSIM_WINDOW_RADIUS);\n  const paddingColorEven = [255, 0, 255];\n  const paddingColorOdd = [0, 255, 0];\n  const [r1, g1, b1] = ImageChannel.intoRGB(width, height, expected, {\n    paddingSize,\n    paddingColorEven,\n    paddingColorOdd,\n  });\n  const [r2, g2, b2] = ImageChannel.intoRGB(width, height, actual, {\n    paddingSize,\n    paddingColorEven,\n    paddingColorOdd,\n  });\n\n  const noop = (x: number, y: number) => {};\n  const drawRedPixel = diff ? (x: number, y: number) => drawPixel(width, diff, x - paddingSize, y - paddingSize, 255, 0, 0) : noop;\n  const drawYellowPixel = diff ? (x: number, y: number) => drawPixel(width, diff, x - paddingSize, y - paddingSize, 255, 255, 0) : noop;\n  const drawGrayPixel = diff ? (x: number, y: number) => {\n    const gray = rgb2gray(r1.get(x, y), g1.get(x, y), b1.get(x, y));\n    const value = blendWithWhite(gray, 0.1);\n    drawPixel(width, diff, x - paddingSize, y - paddingSize, value, value, value);\n  } : noop;\n\n  let fastR, fastG, fastB;\n\n  let diffCount = 0;\n  for (let y = paddingSize; y < r1.height - paddingSize; ++y){\n    for (let x = paddingSize; x < r1.width - paddingSize; ++x) {\n      // Fast-path: equal pixels.\n      if (r1.get(x, y) === r2.get(x, y) && g1.get(x, y) === g2.get(x, y) && b1.get(x, y) === b2.get(x, y)) {\n        drawGrayPixel(x, y);\n        continue;\n      }\n\n      // Compare pixel colors using the dE94 color difference formulae.\n      // The dE94 is normalized so that the value of 1.0 is the \"just-noticeable-difference\".\n      // Color difference below 1.0 is not noticeable to a human eye, so we can disregard it.\n      // See https://en.wikipedia.org/wiki/Color_difference\n      const delta = colorDeltaE94(\n          [r1.get(x, y), g1.get(x, y), b1.get(x, y)],\n          [r2.get(x, y), g2.get(x, y), b2.get(x, y)]\n      );\n\n      if (delta <= maxColorDeltaE94) {\n        drawGrayPixel(x, y);\n        continue;\n      }\n\n      if (!fastR || !fastG || !fastB) {\n        fastR = new FastStats(r1, r2);\n        fastG = new FastStats(g1, g2);\n        fastB = new FastStats(b1, b2);\n      }\n      const [varX1, varY1] = r1.boundXY(x - VARIANCE_WINDOW_RADIUS, y - VARIANCE_WINDOW_RADIUS);\n      const [varX2, varY2] = r1.boundXY(x + VARIANCE_WINDOW_RADIUS, y + VARIANCE_WINDOW_RADIUS);\n      const var1 = fastR.varianceC1(varX1, varY1, varX2, varY2) + fastG.varianceC1(varX1, varY1, varX2, varY2) + fastB.varianceC1(varX1, varY1, varX2, varY2);\n      const var2 = fastR.varianceC2(varX1, varY1, varX2, varY2) + fastG.varianceC2(varX1, varY1, varX2, varY2) + fastB.varianceC2(varX1, varY1, varX2, varY2);\n      // if this pixel is a part of a flood fill of a 3x3 square of either of the images, then it cannot be\n      // anti-aliasing pixel so it must be a pixel difference.\n      if (var1 === 0 || var2 === 0) {\n        drawRedPixel(x, y);\n        ++diffCount;\n        continue;\n      }\n\n      const [ssimX1, ssimY1] = r1.boundXY(x - SSIM_WINDOW_RADIUS, y - SSIM_WINDOW_RADIUS);\n      const [ssimX2, ssimY2] = r1.boundXY(x + SSIM_WINDOW_RADIUS, y + SSIM_WINDOW_RADIUS);\n      const ssimRGB = (ssim(fastR, ssimX1, ssimY1, ssimX2, ssimY2) + ssim(fastG, ssimX1, ssimY1, ssimX2, ssimY2) + ssim(fastB, ssimX1, ssimY1, ssimX2, ssimY2)) / 3.0;\n      const isAntialiased = ssimRGB >= 0.99;\n      if (isAntialiased) {\n        drawYellowPixel(x, y);\n      } else {\n        drawRedPixel(x, y);\n        ++diffCount;\n      }\n    }\n  }\n\n  return diffCount;\n}\n"],"mappings":"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"}