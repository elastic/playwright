{"version":3,"file":"inProcessFactory.js","names":["_server","require","_connection","_browserServerImpl","_androidServerImpl","createInProcessPlaywright","playwright","createPlaywright","sdkLanguage","process","env","PW_LANG_NAME","clientConnection","Connection","undefined","useRawBuffers","dispatcherConnection","DispatcherConnection","onmessage","message","dispatch","rootScope","RootDispatcher","PlaywrightDispatcher","playwrightAPI","getObjectWithKnownName","chromium","_serverLauncher","BrowserServerLauncherImpl","firefox","webkit","_android","AndroidServerLauncherImpl","setImmediate","toImpl","x","_dispatchers","get","_guid","_object","_toImpl"],"sources":["../src/inProcessFactory.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { Playwright as PlaywrightAPI } from './client/playwright';\nimport { createPlaywright, DispatcherConnection, RootDispatcher, PlaywrightDispatcher } from './server';\nimport { Connection } from './client/connection';\nimport { BrowserServerLauncherImpl } from './browserServerImpl';\nimport { AndroidServerLauncherImpl } from './androidServerImpl';\nimport type { Language } from './utils';\n\nexport function createInProcessPlaywright(): PlaywrightAPI {\n  const playwright = createPlaywright({ sdkLanguage: (process.env.PW_LANG_NAME as Language | undefined) || 'javascript' });\n\n  const clientConnection = new Connection(undefined, undefined);\n  clientConnection.useRawBuffers();\n  const dispatcherConnection = new DispatcherConnection(true /* local */);\n\n  // Dispatch synchronously at first.\n  dispatcherConnection.onmessage = message => clientConnection.dispatch(message);\n  clientConnection.onmessage = message => dispatcherConnection.dispatch(message);\n\n  const rootScope = new RootDispatcher(dispatcherConnection);\n\n  // Initialize Playwright channel.\n  new PlaywrightDispatcher(rootScope, playwright);\n  const playwrightAPI = clientConnection.getObjectWithKnownName('Playwright') as PlaywrightAPI;\n  playwrightAPI.chromium._serverLauncher = new BrowserServerLauncherImpl('chromium');\n  playwrightAPI.firefox._serverLauncher = new BrowserServerLauncherImpl('firefox');\n  playwrightAPI.webkit._serverLauncher = new BrowserServerLauncherImpl('webkit');\n  playwrightAPI._android._serverLauncher = new AndroidServerLauncherImpl();\n\n  // Switch to async dispatch after we got Playwright object.\n  dispatcherConnection.onmessage = message => setImmediate(() => clientConnection.dispatch(message));\n  clientConnection.onmessage = message => setImmediate(() => dispatcherConnection.dispatch(message));\n\n  clientConnection.toImpl = (x: any) => x ? dispatcherConnection._dispatchers.get(x._guid)!._object : dispatcherConnection._dispatchers.get('');\n  (playwrightAPI as any)._toImpl = clientConnection.toImpl;\n  return playwrightAPI;\n}\n"],"mappings":";;;;;;AAiBA,IAAAA,OAAA,GAAAC,OAAA;AACA,IAAAC,WAAA,GAAAD,OAAA;AACA,IAAAE,kBAAA,GAAAF,OAAA;AACA,IAAAG,kBAAA,GAAAH,OAAA;AApBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AASO,SAASI,yBAAyBA,CAAA,EAAkB;EACzD,MAAMC,UAAU,GAAG,IAAAC,wBAAgB,EAAC;IAAEC,WAAW,EAAGC,OAAO,CAACC,GAAG,CAACC,YAAY,IAA6B;EAAa,CAAC,CAAC;EAExH,MAAMC,gBAAgB,GAAG,IAAIC,sBAAU,CAACC,SAAS,EAAEA,SAAS,CAAC;EAC7DF,gBAAgB,CAACG,aAAa,CAAC,CAAC;EAChC,MAAMC,oBAAoB,GAAG,IAAIC,4BAAoB,CAAC,IAAI,CAAC,WAAW,CAAC;;EAEvE;EACAD,oBAAoB,CAACE,SAAS,GAAGC,OAAO,IAAIP,gBAAgB,CAACQ,QAAQ,CAACD,OAAO,CAAC;EAC9EP,gBAAgB,CAACM,SAAS,GAAGC,OAAO,IAAIH,oBAAoB,CAACI,QAAQ,CAACD,OAAO,CAAC;EAE9E,MAAME,SAAS,GAAG,IAAIC,sBAAc,CAACN,oBAAoB,CAAC;;EAE1D;EACA,IAAIO,4BAAoB,CAACF,SAAS,EAAEf,UAAU,CAAC;EAC/C,MAAMkB,aAAa,GAAGZ,gBAAgB,CAACa,sBAAsB,CAAC,YAAY,CAAkB;EAC5FD,aAAa,CAACE,QAAQ,CAACC,eAAe,GAAG,IAAIC,4CAAyB,CAAC,UAAU,CAAC;EAClFJ,aAAa,CAACK,OAAO,CAACF,eAAe,GAAG,IAAIC,4CAAyB,CAAC,SAAS,CAAC;EAChFJ,aAAa,CAACM,MAAM,CAACH,eAAe,GAAG,IAAIC,4CAAyB,CAAC,QAAQ,CAAC;EAC9EJ,aAAa,CAACO,QAAQ,CAACJ,eAAe,GAAG,IAAIK,4CAAyB,CAAC,CAAC;;EAExE;EACAhB,oBAAoB,CAACE,SAAS,GAAGC,OAAO,IAAIc,YAAY,CAAC,MAAMrB,gBAAgB,CAACQ,QAAQ,CAACD,OAAO,CAAC,CAAC;EAClGP,gBAAgB,CAACM,SAAS,GAAGC,OAAO,IAAIc,YAAY,CAAC,MAAMjB,oBAAoB,CAACI,QAAQ,CAACD,OAAO,CAAC,CAAC;EAElGP,gBAAgB,CAACsB,MAAM,GAAIC,CAAM,IAAKA,CAAC,GAAGnB,oBAAoB,CAACoB,YAAY,CAACC,GAAG,CAACF,CAAC,CAACG,KAAK,CAAC,CAAEC,OAAO,GAAGvB,oBAAoB,CAACoB,YAAY,CAACC,GAAG,CAAC,EAAE,CAAC;EAC5Ib,aAAa,CAASgB,OAAO,GAAG5B,gBAAgB,CAACsB,MAAM;EACxD,OAAOV,aAAa;AACtB"}