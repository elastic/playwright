{"version":3,"file":"browser.js","names":["_fs","_interopRequireDefault","require","_browserContext","_channelOwner","_events","_errors","_cdpSession","_artifact","_utils","_Symbol$asyncDispose","obj","__esModule","default","Symbol","asyncDispose","Browser","ChannelOwner","from","browser","_object","constructor","parent","type","guid","initializer","_contexts","Set","_isConnected","_closedPromise","_shouldCloseConnectionOnClose","_browserType","_options","_name","_path","_connectHeaders","_closeReason","name","_channel","on","_didClose","Promise","f","once","Events","Disconnected","browserType","newContext","options","_innerNewContext","_newContextForReuse","_wrapApiCall","context","_willCloseContext","page","pages","_onClose","_stopPendingOperations","reason","stopPendingOperations","forReuse","_defaultContextOptions","contextOptions","prepareBrowserContextParams","response","newContextForReuse","BrowserContext","_didCreateContext","logger","_logger","contexts","version","_initializer","newPage","_ownedContext","_ownerPage","isConnected","newBrowserCDPSession","CDPSession","session","startTracing","path","undefined","stopTracing","artifact","Artifact","buffer","readIntoBuffer","delete","mkdirIfNeeded","fs","promises","writeFile","close","_connection","e","isTargetClosedError","emit","exports"],"sources":["../../src/client/browser.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport type * as channels from '@protocol/channels';\nimport { BrowserContext, prepareBrowserContextParams } from './browserContext';\nimport type { Page } from './page';\nimport { ChannelOwner } from './channelOwner';\nimport { Events } from './events';\nimport type { LaunchOptions, BrowserContextOptions, HeadersArray } from './types';\nimport { isTargetClosedError } from './errors';\nimport type * as api from '../../types/types';\nimport { CDPSession } from './cdpSession';\nimport type { BrowserType } from './browserType';\nimport { Artifact } from './artifact';\nimport { mkdirIfNeeded } from '../utils';\n\nexport class Browser extends ChannelOwner<channels.BrowserChannel> implements api.Browser {\n  readonly _contexts = new Set<BrowserContext>();\n  private _isConnected = true;\n  private _closedPromise: Promise<void>;\n  _shouldCloseConnectionOnClose = false;\n  _browserType!: BrowserType;\n  _options: LaunchOptions = {};\n  readonly _name: string;\n  private _path: string | undefined;\n\n  // Used from @playwright/test fixtures.\n  _connectHeaders?: HeadersArray;\n  _closeReason: string | undefined;\n\n  static from(browser: channels.BrowserChannel): Browser {\n    return (browser as any)._object;\n  }\n\n  constructor(parent: ChannelOwner, type: string, guid: string, initializer: channels.BrowserInitializer) {\n    super(parent, type, guid, initializer);\n    this._name = initializer.name;\n    this._channel.on('close', () => this._didClose());\n    this._closedPromise = new Promise(f => this.once(Events.Browser.Disconnected, f));\n  }\n\n  browserType(): BrowserType {\n    return this._browserType;\n  }\n\n  async newContext(options: BrowserContextOptions = {}): Promise<BrowserContext> {\n    return await this._innerNewContext(options, false);\n  }\n\n  async _newContextForReuse(options: BrowserContextOptions = {}): Promise<BrowserContext> {\n    return await this._wrapApiCall(async () => {\n      for (const context of this._contexts) {\n        await this._browserType._willCloseContext(context);\n        for (const page of context.pages())\n          page._onClose();\n        context._onClose();\n      }\n      return await this._innerNewContext(options, true);\n    }, true);\n  }\n\n  async _stopPendingOperations(reason: string) {\n    return await this._wrapApiCall(async () => {\n      await this._channel.stopPendingOperations({ reason });\n    }, true);\n  }\n\n  async _innerNewContext(options: BrowserContextOptions = {}, forReuse: boolean): Promise<BrowserContext> {\n    options = { ...this._browserType._defaultContextOptions, ...options };\n    const contextOptions = await prepareBrowserContextParams(options);\n    const response = forReuse ? await this._channel.newContextForReuse(contextOptions) : await this._channel.newContext(contextOptions);\n    const context = BrowserContext.from(response.context);\n    await this._browserType._didCreateContext(context, contextOptions, this._options, options.logger || this._logger);\n    return context;\n  }\n\n  contexts(): BrowserContext[] {\n    return [...this._contexts];\n  }\n\n  version(): string {\n    return this._initializer.version;\n  }\n\n  async newPage(options: BrowserContextOptions = {}): Promise<Page> {\n    return await this._wrapApiCall(async () => {\n      const context = await this.newContext(options);\n      const page = await context.newPage();\n      page._ownedContext = context;\n      context._ownerPage = page;\n      return page;\n    });\n  }\n\n  isConnected(): boolean {\n    return this._isConnected;\n  }\n\n  async newBrowserCDPSession(): Promise<api.CDPSession> {\n    return CDPSession.from((await this._channel.newBrowserCDPSession()).session);\n  }\n\n  async startTracing(page?: Page, options: { path?: string; screenshots?: boolean; categories?: string[]; } = {}) {\n    this._path = options.path;\n    await this._channel.startTracing({ ...options, page: page ? page._channel : undefined });\n  }\n\n  async stopTracing(): Promise<Buffer> {\n    const artifact = Artifact.from((await this._channel.stopTracing()).artifact);\n    const buffer = await artifact.readIntoBuffer();\n    await artifact.delete();\n    if (this._path) {\n      await mkdirIfNeeded(this._path);\n      await fs.promises.writeFile(this._path, buffer);\n      this._path = undefined;\n    }\n    return buffer;\n  }\n\n  async [Symbol.asyncDispose]() {\n    await this.close();\n  }\n\n  async close(options: { reason?: string } = {}): Promise<void> {\n    this._closeReason = options.reason;\n    try {\n      if (this._shouldCloseConnectionOnClose)\n        this._connection.close();\n      else\n        await this._channel.close(options);\n      await this._closedPromise;\n    } catch (e) {\n      if (isTargetClosedError(e))\n        return;\n      throw e;\n    }\n  }\n\n  _didClose() {\n    this._isConnected = false;\n    this.emit(Events.Browser.Disconnected, this);\n  }\n}\n"],"mappings":"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"}