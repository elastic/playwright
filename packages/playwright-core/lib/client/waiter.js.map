{"version":3,"file":"waiter.js","names":["_stackTrace","require","_errors","_utils","Waiter","constructor","channelOwner","event","_dispose","_failures","_immediateError","_logs","_channelOwner","_waitId","_error","createGuid","_channel","waitForEventInfo","info","waitId","phase","catch","_wrapApiCall","error","createForEvent","waitForEvent","emitter","predicate","promise","dispose","waitForPromise","rejectOnEvent","_rejectOn","then","rejectOnTimeout","timeout","message","waitForTimeout","TimeoutError","rejectImmediately","result","Promise","race","e","rewriteErrorMessage","formatLogRecording","log","s","push","exports","listener","resolve","reject","eventArg","removeListener","addListener","timeoutId","setTimeout","clearTimeout","length","header","headerLength","leftLength","rightLength","repeat","join"],"sources":["../../src/client/waiter.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { EventEmitter } from 'events';\nimport { rewriteErrorMessage } from '../utils/stackTrace';\nimport { TimeoutError } from './errors';\nimport { createGuid } from '../utils';\nimport type * as channels from '@protocol/channels';\nimport type { ChannelOwner } from './channelOwner';\n\nexport class Waiter {\n  private _dispose: (() => void)[];\n  private _failures: Promise<any>[] = [];\n  private _immediateError?: Error;\n  private _logs: string[] = [];\n  private _channelOwner: ChannelOwner<channels.EventTargetChannel>;\n  private _waitId: string;\n  private _error: string | undefined;\n\n  constructor(channelOwner: ChannelOwner<channels.EventTargetChannel>, event: string) {\n    this._waitId = createGuid();\n    this._channelOwner = channelOwner;\n    this._channelOwner._channel.waitForEventInfo({ info: { waitId: this._waitId, phase: 'before', event } }).catch(() => {});\n    this._dispose = [\n      () => this._channelOwner._wrapApiCall(async () => {\n        await this._channelOwner._channel.waitForEventInfo({ info: { waitId: this._waitId, phase: 'after', error: this._error } });\n      }, true).catch(() => {}),\n    ];\n  }\n\n  static createForEvent(channelOwner: ChannelOwner<channels.EventTargetChannel>, event: string) {\n    return new Waiter(channelOwner, event);\n  }\n\n  async waitForEvent<T = void>(emitter: EventEmitter, event: string, predicate?: (arg: T) => boolean | Promise<boolean>): Promise<T> {\n    const { promise, dispose } = waitForEvent(emitter, event, predicate);\n    return await this.waitForPromise(promise, dispose);\n  }\n\n  rejectOnEvent<T = void>(emitter: EventEmitter, event: string, error: Error | (() => Error), predicate?: (arg: T) => boolean | Promise<boolean>) {\n    const { promise, dispose } = waitForEvent(emitter, event, predicate);\n    this._rejectOn(promise.then(() => { throw (typeof error === 'function' ? error() : error); }), dispose);\n  }\n\n  rejectOnTimeout(timeout: number, message: string) {\n    if (!timeout)\n      return;\n    const { promise, dispose } = waitForTimeout(timeout);\n    this._rejectOn(promise.then(() => { throw new TimeoutError(message); }), dispose);\n  }\n\n  rejectImmediately(error: Error) {\n    this._immediateError = error;\n  }\n\n  dispose() {\n    for (const dispose of this._dispose)\n      dispose();\n  }\n\n  async waitForPromise<T>(promise: Promise<T>, dispose?: () => void): Promise<T> {\n    try {\n      if (this._immediateError)\n        throw this._immediateError;\n      const result = await Promise.race([promise, ...this._failures]);\n      if (dispose)\n        dispose();\n      return result;\n    } catch (e) {\n      if (dispose)\n        dispose();\n      this._error = e.message;\n      this.dispose();\n      rewriteErrorMessage(e, e.message + formatLogRecording(this._logs));\n      throw e;\n    }\n  }\n\n  log(s: string) {\n    this._logs.push(s);\n    this._channelOwner._wrapApiCall(async () => {\n      await this._channelOwner._channel.waitForEventInfo({ info: { waitId: this._waitId, phase: 'log', message: s } }).catch(() => {});\n    }, true);\n  }\n\n  private _rejectOn(promise: Promise<any>, dispose?: () => void) {\n    this._failures.push(promise);\n    if (dispose)\n      this._dispose.push(dispose);\n  }\n}\n\nfunction waitForEvent<T = void>(emitter: EventEmitter, event: string, predicate?: (arg: T) => boolean | Promise<boolean>): { promise: Promise<T>, dispose: () => void } {\n  let listener: (eventArg: any) => void;\n  const promise = new Promise<T>((resolve, reject) => {\n    listener = async (eventArg: any) => {\n      try {\n        if (predicate && !(await predicate(eventArg)))\n          return;\n        emitter.removeListener(event, listener);\n        resolve(eventArg);\n      } catch (e) {\n        emitter.removeListener(event, listener);\n        reject(e);\n      }\n    };\n    emitter.addListener(event, listener);\n  });\n  const dispose = () => emitter.removeListener(event, listener);\n  return { promise, dispose };\n}\n\nfunction waitForTimeout(timeout: number): { promise: Promise<void>, dispose: () => void } {\n  let timeoutId: any;\n  const promise = new Promise<void>(resolve => timeoutId = setTimeout(resolve, timeout));\n  const dispose = () => clearTimeout(timeoutId);\n  return { promise, dispose };\n}\n\nfunction formatLogRecording(log: string[]): string {\n  if (!log.length)\n    return '';\n  const header = ` logs `;\n  const headerLength = 60;\n  const leftLength = (headerLength - header.length) / 2;\n  const rightLength = headerLength - header.length - leftLength;\n  return `\\n${'='.repeat(leftLength)}${header}${'='.repeat(rightLength)}\\n${log.join('\\n')}\\n${'='.repeat(headerLength)}`;\n}\n"],"mappings":"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"}