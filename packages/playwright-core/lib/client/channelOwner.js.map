{"version":3,"file":"channelOwner.js","names":["_eventEmitter","require","_validator","_debugLogger","_stackTrace","_utils","_zones","ChannelOwner","EventEmitter","constructor","parent","type","guid","initializer","_connection","_parent","_objects","Map","_type","_guid","_channel","_initializer","_logger","_instrumentation","_eventToSubscriptionMapping","_wasCollected","setMaxListeners","undefined","set","_createChannel","_setEventToSubscriptionMapping","mapping","_updateSubscription","event","enabled","protocolEvent","get","String","_wrapApiCall","updateSubscription","catch","on","listener","listenerCount","addListener","prependListener","off","removeListener","_adopt","child","delete","_dispose","reason","object","values","clear","_debugScopeState","objects","Array","from","map","o","base","channel","Proxy","obj","prop","validator","maybeFindValidator","params","apiZone","apiName","frames","csi","callCookie","stepId","reported","currentStepId","out","onApiCallBegin","sendMessageToServer","tChannelImpl","tChannelImplToWire","binary","rawBuffers","_object","func","isInternal","logger","zones","zoneData","stackTrace","captureLibraryStackTrace","expectZone","title","logApiCall","result","run","onApiCallEnd","e","innerError","process","env","PWDEBUGIMPL","isUnderTest","stack","includes","message","stackFrames","stringifyStackFrames","join","trim","_toImpl","_this$_connection$toI","_this$_connection","toImpl","call","toJSON","exports","isNested","isEnabled","log","color","debugLogger","names","arg","path","context","ValidationError","toString"],"sources":["../../src/client/channelOwner.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EventEmitter } from './eventEmitter';\nimport type * as channels from '@protocol/channels';\nimport { maybeFindValidator, ValidationError, type ValidatorContext } from '../protocol/validator';\nimport { debugLogger } from '../utils/debugLogger';\nimport type { ExpectZone } from '../utils/stackTrace';\nimport { captureLibraryStackTrace, stringifyStackFrames } from '../utils/stackTrace';\nimport { isUnderTest } from '../utils';\nimport { zones } from '../utils/zones';\nimport type { ClientInstrumentation } from './clientInstrumentation';\nimport type { Connection } from './connection';\nimport type { Logger } from './types';\n\ntype Listener = (...args: any[]) => void;\n\nexport abstract class ChannelOwner<T extends channels.Channel = channels.Channel> extends EventEmitter {\n  readonly _connection: Connection;\n  private _parent: ChannelOwner | undefined;\n  private _objects = new Map<string, ChannelOwner>();\n\n  readonly _type: string;\n  readonly _guid: string;\n  readonly _channel: T;\n  readonly _initializer: channels.InitializerTraits<T>;\n  _logger: Logger | undefined;\n  readonly _instrumentation: ClientInstrumentation;\n  private _eventToSubscriptionMapping: Map<string, string> = new Map();\n  _wasCollected: boolean = false;\n\n  constructor(parent: ChannelOwner | Connection, type: string, guid: string, initializer: channels.InitializerTraits<T>) {\n    super();\n    this.setMaxListeners(0);\n    this._connection = parent instanceof ChannelOwner ? parent._connection : parent;\n    this._type = type;\n    this._guid = guid;\n    this._parent = parent instanceof ChannelOwner ? parent : undefined;\n    this._instrumentation = this._connection._instrumentation;\n\n    this._connection._objects.set(guid, this);\n    if (this._parent) {\n      this._parent._objects.set(guid, this);\n      this._logger = this._parent._logger;\n    }\n\n    this._channel = this._createChannel(new EventEmitter());\n    this._initializer = initializer;\n  }\n\n  _setEventToSubscriptionMapping(mapping: Map<string, string>) {\n    this._eventToSubscriptionMapping = mapping;\n  }\n\n  private _updateSubscription(event: string | symbol, enabled: boolean) {\n    const protocolEvent = this._eventToSubscriptionMapping.get(String(event));\n    if (protocolEvent) {\n      this._wrapApiCall(async () => {\n        await (this._channel as any).updateSubscription({ event: protocolEvent, enabled });\n      }, true).catch(() => {});\n    }\n  }\n\n  override on(event: string | symbol, listener: Listener): this {\n    if (!this.listenerCount(event))\n      this._updateSubscription(event, true);\n    super.on(event, listener);\n    return this;\n  }\n\n  override addListener(event: string | symbol, listener: Listener): this {\n    if (!this.listenerCount(event))\n      this._updateSubscription(event, true);\n    super.addListener(event, listener);\n    return this;\n  }\n\n  override prependListener(event: string | symbol, listener: Listener): this {\n    if (!this.listenerCount(event))\n      this._updateSubscription(event, true);\n    super.prependListener(event, listener);\n    return this;\n  }\n\n  override off(event: string | symbol, listener: Listener): this {\n    super.off(event, listener);\n    if (!this.listenerCount(event))\n      this._updateSubscription(event, false);\n    return this;\n  }\n\n  override removeListener(event: string | symbol, listener: Listener): this {\n    super.removeListener(event, listener);\n    if (!this.listenerCount(event))\n      this._updateSubscription(event, false);\n    return this;\n  }\n\n  _adopt(child: ChannelOwner<any>) {\n    child._parent!._objects.delete(child._guid);\n    this._objects.set(child._guid, child);\n    child._parent = this;\n  }\n\n  _dispose(reason: 'gc' | undefined) {\n    // Clean up from parent and connection.\n    if (this._parent)\n      this._parent._objects.delete(this._guid);\n    this._connection._objects.delete(this._guid);\n    this._wasCollected = reason === 'gc';\n\n    // Dispose all children.\n    for (const object of [...this._objects.values()])\n      object._dispose(reason);\n    this._objects.clear();\n  }\n\n  _debugScopeState(): any {\n    return {\n      _guid: this._guid,\n      objects: Array.from(this._objects.values()).map(o => o._debugScopeState()),\n    };\n  }\n\n  private _createChannel(base: Object): T {\n    const channel = new Proxy(base, {\n      get: (obj: any, prop: string | symbol) => {\n        if (typeof prop === 'string') {\n          const validator = maybeFindValidator(this._type, prop, 'Params');\n          if (validator) {\n            return async (params: any) => {\n              return await this._wrapApiCall(async apiZone => {\n                const { apiName, frames, csi, callCookie, stepId } = apiZone.reported ? { apiName: undefined, csi: undefined, callCookie: undefined, frames: [], stepId: undefined } : apiZone;\n                apiZone.reported = true;\n                let currentStepId = stepId;\n                if (csi && apiName) {\n                  const out: { stepId?: string } = {};\n                  csi.onApiCallBegin(apiName, params, frames, callCookie, out);\n                  currentStepId = out.stepId;\n                }\n                return await this._connection.sendMessageToServer(this, prop, validator(params, '', { tChannelImpl: tChannelImplToWire, binary: this._connection.rawBuffers() ? 'buffer' : 'toBase64' }), apiName, frames, currentStepId);\n              });\n            };\n          }\n        }\n        return obj[prop];\n      },\n    });\n    (channel as any)._object = this;\n    return channel;\n  }\n\n  async _wrapApiCall<R>(func: (apiZone: ApiZone) => Promise<R>, isInternal = false): Promise<R> {\n    const logger = this._logger;\n    const apiZone = zones.zoneData<ApiZone>('apiZone');\n    if (apiZone)\n      return await func(apiZone);\n\n    const stackTrace = captureLibraryStackTrace();\n    let apiName: string | undefined = stackTrace.apiName;\n    const frames: channels.StackFrame[] = stackTrace.frames;\n\n    isInternal = isInternal || this._type === 'LocalUtils';\n    if (isInternal)\n      apiName = undefined;\n\n    // Enclosing zone could have provided the apiName and wallTime.\n    const expectZone = zones.zoneData<ExpectZone>('expectZone');\n    const stepId = expectZone?.stepId;\n    if (!isInternal && expectZone)\n      apiName = expectZone.title;\n\n    // If we are coming from the expectZone, there is no need to generate a new\n    // step for the API call, since it will be generated by the expect itself.\n    const csi = isInternal || expectZone ? undefined : this._instrumentation;\n    const callCookie: any = {};\n\n    try {\n      logApiCall(logger, `=> ${apiName} started`, isInternal);\n      const apiZone: ApiZone = { apiName, frames, isInternal, reported: false, csi, callCookie, stepId };\n      const result = await zones.run('apiZone', apiZone, async () => await func(apiZone));\n      csi?.onApiCallEnd(callCookie);\n      logApiCall(logger, `<= ${apiName} succeeded`, isInternal);\n      return result;\n    } catch (e) {\n      const innerError = ((process.env.PWDEBUGIMPL || isUnderTest()) && e.stack) ? '\\n<inner error>\\n' + e.stack : '';\n      if (apiName && !apiName.includes('<anonymous>'))\n        e.message = apiName + ': ' + e.message;\n      const stackFrames = '\\n' + stringifyStackFrames(stackTrace.frames).join('\\n') + innerError;\n      if (stackFrames.trim())\n        e.stack = e.message + stackFrames;\n      else\n        e.stack = '';\n      csi?.onApiCallEnd(callCookie, e);\n      logApiCall(logger, `<= ${apiName} failed`, isInternal);\n      throw e;\n    }\n  }\n\n  _toImpl(): any {\n    return this._connection.toImpl?.(this);\n  }\n\n  private toJSON() {\n    // Jest's expect library tries to print objects sometimes.\n    // RPC objects can contain links to lots of other objects,\n    // which can cause jest to crash. Let's help it out\n    // by just returning the important values.\n    return {\n      _type: this._type,\n      _guid: this._guid,\n    };\n  }\n}\n\nfunction logApiCall(logger: Logger | undefined, message: string, isNested: boolean) {\n  if (isNested)\n    return;\n  if (logger && logger.isEnabled('api', 'info'))\n    logger.log('api', 'info', message, [], { color: 'cyan' });\n  debugLogger.log('api', message);\n}\n\nfunction tChannelImplToWire(names: '*' | string[], arg: any, path: string, context: ValidatorContext) {\n  if (arg._object instanceof ChannelOwner && (names === '*' || names.includes(arg._object._type)))\n    return { guid: arg._object._guid };\n  throw new ValidationError(`${path}: expected channel ${names.toString()}`);\n}\n\ntype ApiZone = {\n  apiName: string | undefined;\n  frames: channels.StackFrame[];\n  isInternal: boolean;\n  reported: boolean;\n  csi: ClientInstrumentation | undefined;\n  callCookie: any;\n  stepId?: string;\n};\n"],"mappings":"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"}