{"version":3,"file":"artifact.js","names":["fs","_interopRequireWildcard","require","_stream","_fileUtils","_channelOwner","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","Artifact","ChannelOwner","from","channel","_object","pathAfterFinished","_connection","isRemote","Error","_channel","value","saveAs","path","result","saveAsStream","stream","Stream","mkdirIfNeeded","Promise","resolve","reject","pipe","createWriteStream","on","failure","error","createReadStream","readIntoBuffer","chunks","chunk","push","Buffer","concat","cancel","delete","exports"],"sources":["../../src/client/artifact.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\nimport * as fs from 'fs';\nimport { Stream } from './stream';\nimport { mkdirIfNeeded } from '../utils/fileUtils';\nimport { ChannelOwner } from './channelOwner';\nimport type { Readable } from 'stream';\n\nexport class Artifact extends ChannelOwner<channels.ArtifactChannel> {\n  static from(channel: channels.ArtifactChannel): Artifact {\n    return (channel as any)._object;\n  }\n\n  async pathAfterFinished(): Promise<string> {\n    if (this._connection.isRemote())\n      throw new Error(`Path is not available when connecting remotely. Use saveAs() to save a local copy.`);\n    return (await this._channel.pathAfterFinished()).value;\n  }\n\n  async saveAs(path: string): Promise<void> {\n    if (!this._connection.isRemote()) {\n      await this._channel.saveAs({ path });\n      return;\n    }\n\n    const result = await this._channel.saveAsStream();\n    const stream = Stream.from(result.stream);\n    await mkdirIfNeeded(path);\n    await new Promise((resolve, reject) => {\n      stream.stream().pipe(fs.createWriteStream(path))\n          .on('finish' as any, resolve)\n          .on('error' as any, reject);\n    });\n  }\n\n  async failure(): Promise<string | null> {\n    return (await this._channel.failure()).error || null;\n  }\n\n  async createReadStream(): Promise<Readable> {\n    const result = await this._channel.stream();\n    const stream = Stream.from(result.stream);\n    return stream.stream();\n  }\n\n  async readIntoBuffer(): Promise<Buffer> {\n    const stream = (await this.createReadStream())!;\n    return await new Promise((resolve, reject) => {\n      const chunks: Buffer[] = [];\n      stream.on('data', (chunk: Buffer) => {\n        chunks.push(chunk);\n      });\n      stream.on('end', () => {\n        resolve(Buffer.concat(chunks));\n      });\n      stream.on('error', reject);\n    });\n  }\n\n  async cancel(): Promise<void> {\n    return await this._channel.cancel();\n  }\n\n  async delete(): Promise<void> {\n    return await this._channel.delete();\n  }\n}\n"],"mappings":"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"}