{"version":3,"file":"tracing.js","names":["_artifact","require","_channelOwner","Tracing","ChannelOwner","from","channel","_object","constructor","parent","type","guid","initializer","_includeSources","_tracesDir","_stacksId","_isTracing","start","options","sources","traceName","_wrapApiCall","_channel","tracingStart","name","snapshots","screenshots","live","_live","response","tracingStartChunk","title","_startCollectingStacks","startChunk","_connection","setIsTracing","result","localUtils","tracingStarted","tracesDir","stacksId","stopChunk","_doStopChunk","path","stop","tracingStop","filePath","_resetStackCounter","tracingStopChunk","mode","traceDiscarded","isLocal","isRemote","zip","zipFile","entries","includeSources","artifact","Artifact","saveAs","delete","exports"],"sources":["../../src/client/tracing.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as api from '../../types/types';\nimport type * as channels from '@protocol/channels';\nimport { Artifact } from './artifact';\nimport { ChannelOwner } from './channelOwner';\n\nexport class Tracing extends ChannelOwner<channels.TracingChannel> implements api.Tracing {\n  private _includeSources = false;\n  _tracesDir: string | undefined;\n  private _stacksId: string | undefined;\n  private _isTracing = false;\n\n  static from(channel: channels.TracingChannel): Tracing {\n    return (channel as any)._object;\n  }\n\n  constructor(parent: ChannelOwner, type: string, guid: string, initializer: channels.TracingInitializer) {\n    super(parent, type, guid, initializer);\n  }\n\n  async start(options: { name?: string, title?: string, snapshots?: boolean, screenshots?: boolean, sources?: boolean, _live?: boolean } = {}) {\n    this._includeSources = !!options.sources;\n    const traceName = await this._wrapApiCall(async () => {\n      await this._channel.tracingStart({\n        name: options.name,\n        snapshots: options.snapshots,\n        screenshots: options.screenshots,\n        live: options._live,\n      });\n      const response = await this._channel.tracingStartChunk({ name: options.name, title: options.title });\n      return response.traceName;\n    }, true);\n    await this._startCollectingStacks(traceName);\n  }\n\n  async startChunk(options: { name?: string, title?: string } = {}) {\n    const { traceName } = await this._channel.tracingStartChunk(options);\n    await this._startCollectingStacks(traceName);\n  }\n\n  private async _startCollectingStacks(traceName: string) {\n    if (!this._isTracing) {\n      this._isTracing = true;\n      this._connection.setIsTracing(true);\n    }\n    const result = await this._connection.localUtils()._channel.tracingStarted({ tracesDir: this._tracesDir, traceName });\n    this._stacksId = result.stacksId;\n  }\n\n  async stopChunk(options: { path?: string } = {}) {\n    await this._wrapApiCall(async () => {\n      await this._doStopChunk(options.path);\n    }, true);\n  }\n\n  async stop(options: { path?: string } = {}) {\n    await this._wrapApiCall(async () => {\n      await this._doStopChunk(options.path);\n      await this._channel.tracingStop();\n    }, true);\n  }\n\n  private async _doStopChunk(filePath: string | undefined) {\n    this._resetStackCounter();\n\n    if (!filePath) {\n      // Not interested in artifacts.\n      await this._channel.tracingStopChunk({ mode: 'discard' });\n      if (this._stacksId)\n        await this._connection.localUtils()._channel.traceDiscarded({ stacksId: this._stacksId });\n      return;\n    }\n\n    const isLocal = !this._connection.isRemote();\n\n    if (isLocal) {\n      const result = await this._channel.tracingStopChunk({ mode: 'entries' });\n      await this._connection.localUtils()._channel.zip({ zipFile: filePath, entries: result.entries!, mode: 'write', stacksId: this._stacksId, includeSources: this._includeSources });\n      return;\n    }\n\n    const result = await this._channel.tracingStopChunk({ mode: 'archive' });\n\n    // The artifact may be missing if the browser closed while stopping tracing.\n    if (!result.artifact) {\n      if (this._stacksId)\n        await this._connection.localUtils()._channel.traceDiscarded({ stacksId: this._stacksId });\n      return;\n    }\n\n    // Save trace to the final local file.\n    const artifact = Artifact.from(result.artifact);\n    await artifact.saveAs(filePath);\n    await artifact.delete();\n\n    await this._connection.localUtils()._channel.zip({ zipFile: filePath, entries: [], mode: 'append', stacksId: this._stacksId, includeSources: this._includeSources });\n  }\n\n  _resetStackCounter() {\n    if (this._isTracing) {\n      this._isTracing = false;\n      this._connection.setIsTracing(false);\n    }\n  }\n}\n"],"mappings":"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"}