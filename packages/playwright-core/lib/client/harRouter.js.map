{"version":3,"file":"harRouter.js","names":["_debugLogger","require","_Symbol$asyncDispose","Symbol","asyncDispose","HarRouter","create","localUtils","file","notFoundAction","options","harId","error","_channel","harOpen","Error","constructor","_localUtils","_harId","_notFoundAction","_options","_handle","route","request","response","harLookup","url","method","headers","headersArray","postData","postDataBuffer","undefined","isNavigationRequest","action","debugLogger","log","redirectURL","_redirectNavigationRequest","status","fulfill","Object","fromEntries","map","h","name","value","body","message","abort","fallback","addContextRoute","context","urlMatch","addPageRoute","page","dispose","harClose","catch","exports"],"sources":["../../src/client/harRouter.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { debugLogger } from '../utils/debugLogger';\nimport type { BrowserContext } from './browserContext';\nimport type { LocalUtils } from './localUtils';\nimport type { Route } from './network';\nimport type { URLMatch } from '../utils';\nimport type { Page } from './page';\n\ntype HarNotFoundAction = 'abort' | 'fallback';\n\nexport class HarRouter {\n  private _localUtils: LocalUtils;\n  private _harId: string;\n  private _notFoundAction: HarNotFoundAction;\n  private _options: { urlMatch?: URLMatch; baseURL?: string; };\n\n  static async create(localUtils: LocalUtils, file: string, notFoundAction: HarNotFoundAction, options: { urlMatch?: URLMatch }): Promise<HarRouter> {\n    const { harId, error } = await localUtils._channel.harOpen({ file });\n    if (error)\n      throw new Error(error);\n    return new HarRouter(localUtils, harId!, notFoundAction, options);\n  }\n\n  private constructor(localUtils: LocalUtils, harId: string, notFoundAction: HarNotFoundAction, options: { urlMatch?: URLMatch }) {\n    this._localUtils = localUtils;\n    this._harId = harId;\n    this._options = options;\n    this._notFoundAction = notFoundAction;\n  }\n\n  private async _handle(route: Route) {\n    const request = route.request();\n\n    const response = await this._localUtils._channel.harLookup({\n      harId: this._harId,\n      url: request.url(),\n      method: request.method(),\n      headers: (await request.headersArray()),\n      postData: request.postDataBuffer() || undefined,\n      isNavigationRequest: request.isNavigationRequest()\n    });\n\n    if (response.action === 'redirect') {\n      debugLogger.log('api', `HAR: ${route.request().url()} redirected to ${response.redirectURL}`);\n      await route._redirectNavigationRequest(response.redirectURL!);\n      return;\n    }\n\n    if (response.action === 'fulfill') {\n      // If the response status is -1, the request was canceled or stalled, so we just stall it here.\n      // See https://github.com/microsoft/playwright/issues/29311.\n      // TODO: it'd be better to abort such requests, but then we likely need to respect the timing,\n      // because the request might have been stalled for a long time until the very end of the\n      // test when HAR was recorded but we'd abort it immediately.\n      if (response.status === -1)\n        return;\n      await route.fulfill({\n        status: response.status,\n        headers: Object.fromEntries(response.headers!.map(h => [h.name, h.value])),\n        body: response.body!\n      });\n      return;\n    }\n\n    if (response.action === 'error')\n      debugLogger.log('api', 'HAR: ' + response.message!);\n    // Report the error, but fall through to the default handler.\n\n    if (this._notFoundAction === 'abort') {\n      await route.abort();\n      return;\n    }\n\n    await route.fallback();\n  }\n\n  async addContextRoute(context: BrowserContext) {\n    await context.route(this._options.urlMatch || '**/*', route => this._handle(route));\n  }\n\n  async addPageRoute(page: Page) {\n    await page.route(this._options.urlMatch || '**/*', route => this._handle(route));\n  }\n\n  async [Symbol.asyncDispose]() {\n    await this.dispose();\n  }\n\n  dispose() {\n    this._localUtils._channel.harClose({ harId: this._harId }).catch(() => {});\n  }\n}\n"],"mappings":"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"}