{"version":3,"file":"clientInstrumentation.js","names":["createInstrumentation","listeners","Proxy","get","obj","prop","listener","push","splice","indexOf","length","startsWith","params","_prop","_ref","call","_prop2","_ref2"],"sources":["../../src/client/clientInstrumentation.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { StackFrame } from '@protocol/channels';\nimport type { BrowserContext } from './browserContext';\nimport type { APIRequestContext } from './fetch';\n\nexport interface ClientInstrumentation {\n  addListener(listener: ClientInstrumentationListener): void;\n  removeListener(listener: ClientInstrumentationListener): void;\n  removeAllListeners(): void;\n  onApiCallBegin(apiCall: string, params: Record<string, any>, frames: StackFrame[], userData: any, out: { stepId?: string }): void;\n  onApiCallEnd(userData: any, error?: Error): void;\n  onWillPause(): void;\n\n  runAfterCreateBrowserContext(context: BrowserContext): Promise<void>;\n  runAfterCreateRequestContext(context: APIRequestContext): Promise<void>;\n  runBeforeCloseBrowserContext(context: BrowserContext): Promise<void>;\n  runBeforeCloseRequestContext(context: APIRequestContext): Promise<void>;\n}\n\nexport interface ClientInstrumentationListener {\n  onApiCallBegin?(apiName: string, params: Record<string, any>, frames: StackFrame[], userData: any, out: { stepId?: string }): void;\n  onApiCallEnd?(userData: any, error?: Error): void;\n  onWillPause?(): void;\n\n  runAfterCreateBrowserContext?(context: BrowserContext): Promise<void>;\n  runAfterCreateRequestContext?(context: APIRequestContext): Promise<void>;\n  runBeforeCloseBrowserContext?(context: BrowserContext): Promise<void>;\n  runBeforeCloseRequestContext?(context: APIRequestContext): Promise<void>;\n}\n\nexport function createInstrumentation(): ClientInstrumentation {\n  const listeners: ClientInstrumentationListener[] = [];\n  return new Proxy({}, {\n    get: (obj: any, prop: string | symbol) => {\n      if (typeof prop !== 'string')\n        return obj[prop];\n      if (prop === 'addListener')\n        return (listener: ClientInstrumentationListener) => listeners.push(listener);\n      if (prop === 'removeListener')\n        return (listener: ClientInstrumentationListener) => listeners.splice(listeners.indexOf(listener), 1);\n      if (prop === 'removeAllListeners')\n        return () => listeners.splice(0, listeners.length);\n      if (prop.startsWith('run')) {\n        return async (...params: any[]) => {\n          for (const listener of listeners)\n            await (listener as any)[prop]?.(...params);\n        };\n      }\n      if (prop.startsWith('on')) {\n        return (...params: any[]) => {\n          for (const listener of listeners)\n            (listener as any)[prop]?.(...params);\n        };\n      }\n      return obj[prop];\n    },\n  });\n}\n"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AA+BO,SAASA,qBAAqBA,CAAA,EAA0B;EAC7D,MAAMC,SAA0C,GAAG,EAAE;EACrD,OAAO,IAAIC,KAAK,CAAC,CAAC,CAAC,EAAE;IACnBC,GAAG,EAAEA,CAACC,GAAQ,EAAEC,IAAqB,KAAK;MACxC,IAAI,OAAOA,IAAI,KAAK,QAAQ,EAC1B,OAAOD,GAAG,CAACC,IAAI,CAAC;MAClB,IAAIA,IAAI,KAAK,aAAa,EACxB,OAAQC,QAAuC,IAAKL,SAAS,CAACM,IAAI,CAACD,QAAQ,CAAC;MAC9E,IAAID,IAAI,KAAK,gBAAgB,EAC3B,OAAQC,QAAuC,IAAKL,SAAS,CAACO,MAAM,CAACP,SAAS,CAACQ,OAAO,CAACH,QAAQ,CAAC,EAAE,CAAC,CAAC;MACtG,IAAID,IAAI,KAAK,oBAAoB,EAC/B,OAAO,MAAMJ,SAAS,CAACO,MAAM,CAAC,CAAC,EAAEP,SAAS,CAACS,MAAM,CAAC;MACpD,IAAIL,IAAI,CAACM,UAAU,CAAC,KAAK,CAAC,EAAE;QAC1B,OAAO,OAAO,GAAGC,MAAa,KAAK;UACjC,KAAK,MAAMN,QAAQ,IAAIL,SAAS;YAAA,IAAAY,KAAA,EAAAC,IAAA;YAC9B,QAAAD,KAAA,GAAM,CAAAC,IAAA,GAACR,QAAQ,EAASD,IAAI,CAAC,cAAAQ,KAAA,uBAAvBA,KAAA,CAAAE,IAAA,CAAAD,IAAA,EAA0B,GAAGF,MAAM,CAAC;UAAC;QAC/C,CAAC;MACH;MACA,IAAIP,IAAI,CAACM,UAAU,CAAC,IAAI,CAAC,EAAE;QACzB,OAAO,CAAC,GAAGC,MAAa,KAAK;UAC3B,KAAK,MAAMN,QAAQ,IAAIL,SAAS;YAAA,IAAAe,MAAA,EAAAC,KAAA;YAC9B,CAAAD,MAAA,IAAAC,KAAA,GAACX,QAAQ,EAASD,IAAI,CAAC,cAAAW,MAAA,eAAvBA,MAAA,CAAAD,IAAA,CAAAE,KAAA,EAA0B,GAAGL,MAAM,CAAC;UAAC;QACzC,CAAC;MACH;MACA,OAAOR,GAAG,CAACC,IAAI,CAAC;IAClB;EACF,CAAC,CAAC;AACJ"}