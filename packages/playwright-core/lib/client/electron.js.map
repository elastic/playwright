{"version":3,"file":"electron.js","names":["_timeoutSettings","require","_browserContext","_channelOwner","_clientHelper","_events","_jsHandle","_consoleMessage","_waiter","_errors","_Symbol$asyncDispose","Electron","ChannelOwner","from","electron","_object","constructor","parent","type","guid","initializer","launch","options","params","prepareBrowserContextParams","env","envObjectToArray","process","tracesDir","app","ElectronApplication","_channel","electronApplication","_context","_setOptions","exports","Symbol","asyncDispose","_windows","Set","TimeoutSettings","BrowserContext","context","page","_pages","_onPage","on","Events","Page","emit","Close","event","Console","ConsoleMessage","_setEventToSubscriptionMapping","Map","_toImpl","add","Window","once","delete","windows","firstWindow","size","values","next","value","waitForEvent","close","e","isTargetClosedError","optionsOrPredicate","_wrapApiCall","timeout","predicate","waiter","Waiter","createForEvent","rejectOnTimeout","rejectOnEvent","TargetClosedError","result","dispose","browserWindow","JSHandle","handle","evaluate","pageFunction","arg","evaluateExpression","expression","String","isFunction","serializeArgument","parseResult","evaluateHandle","evaluateExpressionHandle"],"sources":["../../src/client/electron.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { BrowserWindow } from 'electron';\nimport type * as childProcess from 'child_process';\nimport type * as structs from '../../types/structs';\nimport type * as api from '../../types/types';\nimport type * as channels from '@protocol/channels';\nimport { TimeoutSettings } from '../common/timeoutSettings';\nimport { BrowserContext, prepareBrowserContextParams } from './browserContext';\nimport { ChannelOwner } from './channelOwner';\nimport { envObjectToArray } from './clientHelper';\nimport { Events } from './events';\nimport { JSHandle, parseResult, serializeArgument } from './jsHandle';\nimport type { Page } from './page';\nimport { ConsoleMessage } from './consoleMessage';\nimport type { Env, WaitForEventOptions, Headers, BrowserContextOptions } from './types';\nimport { Waiter } from './waiter';\nimport { TargetClosedError, isTargetClosedError } from './errors';\n\ntype ElectronOptions = Omit<channels.ElectronLaunchOptions, 'env'|'extraHTTPHeaders'|'recordHar'|'colorScheme'|'acceptDownloads'> & {\n  env?: Env,\n  extraHTTPHeaders?: Headers,\n  recordHar?: BrowserContextOptions['recordHar'],\n  colorScheme?: 'dark' | 'light' | 'no-preference' | null,\n  acceptDownloads?: boolean,\n};\n\ntype ElectronAppType = typeof import('electron');\n\nexport class Electron extends ChannelOwner<channels.ElectronChannel> implements api.Electron {\n  static from(electron: channels.ElectronChannel): Electron {\n    return (electron as any)._object;\n  }\n\n  constructor(parent: ChannelOwner, type: string, guid: string, initializer: channels.ElectronInitializer) {\n    super(parent, type, guid, initializer);\n  }\n\n  async launch(options: ElectronOptions = {}): Promise<ElectronApplication> {\n    const params: channels.ElectronLaunchParams = {\n      ...await prepareBrowserContextParams(options),\n      env: envObjectToArray(options.env ? options.env : process.env),\n      tracesDir: options.tracesDir,\n    };\n    const app = ElectronApplication.from((await this._channel.launch(params)).electronApplication);\n    app._context._setOptions(params, options);\n    return app;\n  }\n}\n\nexport class ElectronApplication extends ChannelOwner<channels.ElectronApplicationChannel> implements api.ElectronApplication {\n  readonly _context: BrowserContext;\n  private _windows = new Set<Page>();\n  private _timeoutSettings = new TimeoutSettings();\n\n  static from(electronApplication: channels.ElectronApplicationChannel): ElectronApplication {\n    return (electronApplication as any)._object;\n  }\n\n  constructor(parent: ChannelOwner, type: string, guid: string, initializer: channels.ElectronApplicationInitializer) {\n    super(parent, type, guid, initializer);\n    this._context = BrowserContext.from(initializer.context);\n    for (const page of this._context._pages)\n      this._onPage(page);\n    this._context.on(Events.BrowserContext.Page, page => this._onPage(page));\n    this._channel.on('close', () => {\n      this.emit(Events.ElectronApplication.Close);\n    });\n    this._channel.on('console', event => this.emit(Events.ElectronApplication.Console, new ConsoleMessage(event)));\n    this._setEventToSubscriptionMapping(new Map<string, channels.ElectronApplicationUpdateSubscriptionParams['event']>([\n      [Events.ElectronApplication.Console, 'console'],\n    ]));\n  }\n\n  process(): childProcess.ChildProcess {\n    return this._toImpl().process();\n  }\n\n  _onPage(page: Page) {\n    this._windows.add(page);\n    this.emit(Events.ElectronApplication.Window, page);\n    page.once(Events.Page.Close, () => this._windows.delete(page));\n  }\n\n  windows(): Page[] {\n    // TODO: add ElectronPage class inheriting from Page.\n    return [...this._windows];\n  }\n\n  async firstWindow(options?: { timeout?: number }): Promise<Page> {\n    if (this._windows.size)\n      return this._windows.values().next().value;\n    return await this.waitForEvent('window', options);\n  }\n\n  context(): BrowserContext {\n    return this._context;\n  }\n\n  async [Symbol.asyncDispose]() {\n    await this.close();\n  }\n\n  async close() {\n    try {\n      await this._context.close();\n    } catch (e) {\n      if (isTargetClosedError(e))\n        return;\n      throw e;\n    }\n  }\n\n  async waitForEvent(event: string, optionsOrPredicate: WaitForEventOptions = {}): Promise<any> {\n    return await this._wrapApiCall(async () => {\n      const timeout = this._timeoutSettings.timeout(typeof optionsOrPredicate === 'function' ? {} : optionsOrPredicate);\n      const predicate = typeof optionsOrPredicate === 'function' ? optionsOrPredicate : optionsOrPredicate.predicate;\n      const waiter = Waiter.createForEvent(this, event);\n      waiter.rejectOnTimeout(timeout, `Timeout ${timeout}ms exceeded while waiting for event \"${event}\"`);\n      if (event !== Events.ElectronApplication.Close)\n        waiter.rejectOnEvent(this, Events.ElectronApplication.Close, () => new TargetClosedError());\n      const result = await waiter.waitForEvent(this, event, predicate as any);\n      waiter.dispose();\n      return result;\n    });\n  }\n\n  async browserWindow(page: Page): Promise<JSHandle<BrowserWindow>> {\n    const result = await this._channel.browserWindow({ page: page._channel });\n    return JSHandle.from(result.handle);\n  }\n\n  async evaluate<R, Arg>(pageFunction: structs.PageFunctionOn<ElectronAppType, Arg, R>, arg: Arg): Promise<R> {\n    const result = await this._channel.evaluateExpression({ expression: String(pageFunction), isFunction: typeof pageFunction === 'function', arg: serializeArgument(arg) });\n    return parseResult(result.value);\n  }\n\n  async evaluateHandle<R, Arg>(pageFunction: structs.PageFunctionOn<ElectronAppType, Arg, R>, arg: Arg): Promise<structs.SmartHandle<R>> {\n    const result = await this._channel.evaluateExpressionHandle({ expression: String(pageFunction), isFunction: typeof pageFunction === 'function', arg: serializeArgument(arg) });\n    return JSHandle.from(result.handle) as any as structs.SmartHandle<R>;\n  }\n}\n"],"mappings":"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"}