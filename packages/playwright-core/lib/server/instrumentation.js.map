{"version":3,"file":"instrumentation.js","names":["_events","require","_utils","SdkObject","EventEmitter","constructor","parent","guidPrefix","guid","attribution","instrumentation","createGuid","setMaxListeners","exports","createInstrumentation","listeners","Map","Proxy","get","obj","prop","listener","context","set","delete","startsWith","sdkObject","params","_prop","_ref","call","serverSideCallMetadata","id","startTime","endTime","type","method","log","isServerSide"],"sources":["../../src/server/instrumentation.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EventEmitter } from 'events';\nimport { createGuid } from '../utils';\nimport type { APIRequestContext } from './fetch';\nimport type { Browser } from './browser';\nimport type { BrowserContext } from './browserContext';\nimport type { BrowserType } from './browserType';\nimport type { ElementHandle } from './dom';\nimport type { Frame } from './frames';\nimport type { Page } from './page';\nimport type { Playwright } from './playwright';\n\nexport type Attribution = {\n  playwright: Playwright;\n  browserType?: BrowserType;\n  browser?: Browser;\n  context?: BrowserContext | APIRequestContext;\n  page?: Page;\n  frame?: Frame;\n};\n\nimport type { CallMetadata } from '@protocol/callMetadata';\nexport type { CallMetadata } from '@protocol/callMetadata';\n\nexport class SdkObject extends EventEmitter {\n  guid: string;\n  attribution: Attribution;\n  instrumentation: Instrumentation;\n\n  constructor(parent: SdkObject, guidPrefix?: string, guid?: string) {\n    super();\n    this.guid = guid || `${guidPrefix || ''}@${createGuid()}`;\n    this.setMaxListeners(0);\n    this.attribution = { ...parent.attribution };\n    this.instrumentation = parent.instrumentation;\n  }\n}\n\nexport interface Instrumentation {\n  addListener(listener: InstrumentationListener, context: BrowserContext | APIRequestContext | null): void;\n  removeListener(listener: InstrumentationListener): void;\n  onBeforeCall(sdkObject: SdkObject, metadata: CallMetadata): Promise<void>;\n  onBeforeInputAction(sdkObject: SdkObject, metadata: CallMetadata, element: ElementHandle): Promise<void>;\n  onCallLog(sdkObject: SdkObject, metadata: CallMetadata, logName: string, message: string): void;\n  onAfterCall(sdkObject: SdkObject, metadata: CallMetadata): Promise<void>;\n  onPageOpen(page: Page): void;\n  onPageClose(page: Page): void;\n  onBrowserOpen(browser: Browser): void;\n  onBrowserClose(browser: Browser): void;\n}\n\nexport interface InstrumentationListener {\n  onBeforeCall?(sdkObject: SdkObject, metadata: CallMetadata): Promise<void>;\n  onBeforeInputAction?(sdkObject: SdkObject, metadata: CallMetadata, element: ElementHandle): Promise<void>;\n  onCallLog?(sdkObject: SdkObject, metadata: CallMetadata, logName: string, message: string): void;\n  onAfterCall?(sdkObject: SdkObject, metadata: CallMetadata): Promise<void>;\n  onPageOpen?(page: Page): void;\n  onPageClose?(page: Page): void;\n  onBrowserOpen?(browser: Browser): void;\n  onBrowserClose?(browser: Browser): void;\n}\n\nexport function createInstrumentation(): Instrumentation {\n  const listeners = new Map<InstrumentationListener, BrowserContext | APIRequestContext | null>();\n  return new Proxy({}, {\n    get: (obj: any, prop: string | symbol) => {\n      if (typeof prop !== 'string')\n        return obj[prop];\n      if (prop === 'addListener')\n        return (listener: InstrumentationListener, context: BrowserContext | APIRequestContext | null) => listeners.set(listener, context);\n      if (prop === 'removeListener')\n        return (listener: InstrumentationListener) => listeners.delete(listener);\n      if (!prop.startsWith('on'))\n        return obj[prop];\n      return async (sdkObject: SdkObject, ...params: any[]) => {\n        for (const [listener, context] of listeners) {\n          if (!context || sdkObject.attribution.context === context)\n            await (listener as any)[prop]?.(sdkObject, ...params);\n        }\n      };\n    },\n  });\n}\n\nexport function serverSideCallMetadata(): CallMetadata {\n  return {\n    id: '',\n    startTime: 0,\n    endTime: 0,\n    type: 'Internal',\n    method: '',\n    params: {},\n    log: [],\n    isServerSide: true,\n  };\n}\n"],"mappings":";;;;;;;;AAgBA,IAAAA,OAAA,GAAAC,OAAA;AACA,IAAAC,MAAA,GAAAD,OAAA;AAjBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAyBO,MAAME,SAAS,SAASC,oBAAY,CAAC;EAK1CC,WAAWA,CAACC,MAAiB,EAAEC,UAAmB,EAAEC,IAAa,EAAE;IACjE,KAAK,CAAC,CAAC;IAAC,KALVA,IAAI;IAAA,KACJC,WAAW;IAAA,KACXC,eAAe;IAIb,IAAI,CAACF,IAAI,GAAGA,IAAI,IAAK,GAAED,UAAU,IAAI,EAAG,IAAG,IAAAI,iBAAU,EAAC,CAAE,EAAC;IACzD,IAAI,CAACC,eAAe,CAAC,CAAC,CAAC;IACvB,IAAI,CAACH,WAAW,GAAG;MAAE,GAAGH,MAAM,CAACG;IAAY,CAAC;IAC5C,IAAI,CAACC,eAAe,GAAGJ,MAAM,CAACI,eAAe;EAC/C;AACF;AAACG,OAAA,CAAAV,SAAA,GAAAA,SAAA;AA0BM,SAASW,qBAAqBA,CAAA,EAAoB;EACvD,MAAMC,SAAS,GAAG,IAAIC,GAAG,CAAqE,CAAC;EAC/F,OAAO,IAAIC,KAAK,CAAC,CAAC,CAAC,EAAE;IACnBC,GAAG,EAAEA,CAACC,GAAQ,EAAEC,IAAqB,KAAK;MACxC,IAAI,OAAOA,IAAI,KAAK,QAAQ,EAC1B,OAAOD,GAAG,CAACC,IAAI,CAAC;MAClB,IAAIA,IAAI,KAAK,aAAa,EACxB,OAAO,CAACC,QAAiC,EAAEC,OAAkD,KAAKP,SAAS,CAACQ,GAAG,CAACF,QAAQ,EAAEC,OAAO,CAAC;MACpI,IAAIF,IAAI,KAAK,gBAAgB,EAC3B,OAAQC,QAAiC,IAAKN,SAAS,CAACS,MAAM,CAACH,QAAQ,CAAC;MAC1E,IAAI,CAACD,IAAI,CAACK,UAAU,CAAC,IAAI,CAAC,EACxB,OAAON,GAAG,CAACC,IAAI,CAAC;MAClB,OAAO,OAAOM,SAAoB,EAAE,GAAGC,MAAa,KAAK;QACvD,KAAK,MAAM,CAACN,QAAQ,EAAEC,OAAO,CAAC,IAAIP,SAAS,EAAE;UAAA,IAAAa,KAAA,EAAAC,IAAA;UAC3C,IAAI,CAACP,OAAO,IAAII,SAAS,CAACjB,WAAW,CAACa,OAAO,KAAKA,OAAO,EACvD,QAAAM,KAAA,GAAM,CAAAC,IAAA,GAACR,QAAQ,EAASD,IAAI,CAAC,cAAAQ,KAAA,uBAAvBA,KAAA,CAAAE,IAAA,CAAAD,IAAA,EAA0BH,SAAS,EAAE,GAAGC,MAAM,CAAC;QACzD;MACF,CAAC;IACH;EACF,CAAC,CAAC;AACJ;AAEO,SAASI,sBAAsBA,CAAA,EAAiB;EACrD,OAAO;IACLC,EAAE,EAAE,EAAE;IACNC,SAAS,EAAE,CAAC;IACZC,OAAO,EAAE,CAAC;IACVC,IAAI,EAAE,UAAU;IAChBC,MAAM,EAAE,EAAE;IACVT,MAAM,EAAE,CAAC,CAAC;IACVU,GAAG,EAAE,EAAE;IACPC,YAAY,EAAE;EAChB,CAAC;AACH"}