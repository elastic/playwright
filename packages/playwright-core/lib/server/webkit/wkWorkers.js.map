{"version":3,"file":"wkWorkers.js","names":["_eventsHelper","require","_page","_wkConnection","_wkExecutionContext","WKWorkers","constructor","page","_sessionListeners","_workerSessions","Map","setSession","session","eventsHelper","removeEventListeners","clear","addEventListener","event","worker","Worker","url","workerSession","WKSession","connection","workerId","message","send","JSON","stringify","catch","e","dispatchMessage","id","error","set","_createExecutionContext","WKExecutionContext","undefined","_addWorker","on","_onConsoleMessage","Promise","all","_removeWorker","get","parse","dispose","delete","_clearWorkers","initializeSession","type","level","text","parameters","line","lineNumber","column","columnNumber","derivedType","handles","map","p","_existingExecutionContext","createHandle","location","_addConsoleMessage","length","exports"],"sources":["../../../src/server/webkit/wkWorkers.ts"],"sourcesContent":["/**\n * Copyright 2019 Microsoft Corporation All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { RegisteredListener } from '../../utils/eventsHelper';\nimport { eventsHelper } from '../../utils/eventsHelper';\nimport type { Page } from '../page';\nimport { Worker } from '../page';\nimport type { Protocol } from './protocol';\nimport { WKSession } from './wkConnection';\nimport { WKExecutionContext } from './wkExecutionContext';\nimport type * as types from '../types';\n\nexport class WKWorkers {\n  private _sessionListeners: RegisteredListener[] = [];\n  private _page: Page;\n  private _workerSessions = new Map<string, WKSession>();\n\n  constructor(page: Page) {\n    this._page = page;\n  }\n\n  setSession(session: WKSession) {\n    eventsHelper.removeEventListeners(this._sessionListeners);\n    this.clear();\n    this._sessionListeners = [\n      eventsHelper.addEventListener(session, 'Worker.workerCreated', (event: Protocol.Worker.workerCreatedPayload) => {\n        const worker = new Worker(this._page, event.url);\n        const workerSession = new WKSession(session.connection, event.workerId, (message: any) => {\n          session.send('Worker.sendMessageToWorker', {\n            workerId: event.workerId,\n            message: JSON.stringify(message)\n          }).catch(e => {\n            workerSession.dispatchMessage({ id: message.id, error: { message: e.message } });\n          });\n        });\n        this._workerSessions.set(event.workerId, workerSession);\n        worker._createExecutionContext(new WKExecutionContext(workerSession, undefined));\n        this._page._addWorker(event.workerId, worker);\n        workerSession.on('Console.messageAdded', event => this._onConsoleMessage(worker, event));\n        Promise.all([\n          workerSession.send('Runtime.enable'),\n          workerSession.send('Console.enable'),\n          session.send('Worker.initialized', { workerId: event.workerId })\n        ]).catch(e => {\n          // Worker can go as we are initializing it.\n          this._page._removeWorker(event.workerId);\n        });\n      }),\n      eventsHelper.addEventListener(session, 'Worker.dispatchMessageFromWorker', (event: Protocol.Worker.dispatchMessageFromWorkerPayload) => {\n        const workerSession = this._workerSessions.get(event.workerId)!;\n        if (!workerSession)\n          return;\n        workerSession.dispatchMessage(JSON.parse(event.message));\n      }),\n      eventsHelper.addEventListener(session, 'Worker.workerTerminated', (event: Protocol.Worker.workerTerminatedPayload) => {\n        const workerSession = this._workerSessions.get(event.workerId)!;\n        if (!workerSession)\n          return;\n        workerSession.dispose();\n        this._workerSessions.delete(event.workerId);\n        this._page._removeWorker(event.workerId);\n      })\n    ];\n  }\n\n  clear() {\n    this._page._clearWorkers();\n    this._workerSessions.clear();\n  }\n\n  async initializeSession(session: WKSession) {\n    await session.send('Worker.enable');\n  }\n\n  async _onConsoleMessage(worker: Worker, event: Protocol.Console.messageAddedPayload) {\n    const { type, level, text, parameters, url, line: lineNumber, column: columnNumber } = event.message;\n    let derivedType: string = type || '';\n    if (type === 'log')\n      derivedType = level;\n    else if (type === 'timing')\n      derivedType = 'timeEnd';\n\n    const handles = (parameters || []).map(p => {\n      return worker._existingExecutionContext!.createHandle(p);\n    });\n    const location: types.ConsoleMessageLocation = {\n      url: url || '',\n      lineNumber: (lineNumber || 1) - 1,\n      columnNumber: (columnNumber || 1) - 1\n    };\n    this._page._addConsoleMessage(derivedType, handles, location, handles.length ? undefined : text);\n  }\n}\n"],"mappings":"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"}