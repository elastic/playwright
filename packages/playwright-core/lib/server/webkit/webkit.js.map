{"version":3,"file":"webkit.js","names":["_wkBrowser","require","_path","_interopRequireDefault","_wkConnection","_browserType","_utils","obj","__esModule","default","WebKit","BrowserType","constructor","parent","connectToTransport","transport","options","WKBrowser","connect","attribution","playwright","amendEnvironment","env","userDataDir","executable","browserArguments","CURL_COOKIE_JAR_PATH","path","join","doRewriteStartupLog","error","logs","includes","wrapInASCIIBox","kNoXServerRunningError","attemptToGracefullyCloseBrowser","send","method","params","id","kBrowserCloseMessageId","defaultArgs","isPersistent","args","proxy","headless","userDataDirArg","find","arg","startsWith","_createUserDataDirArgMisuseError","Error","webkitArguments","process","platform","push","server","bypass","split","map","t","replace","exports"],"sources":["../../../src/server/webkit/webkit.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { WKBrowser } from '../webkit/wkBrowser';\nimport type { Env } from '../../utils/processLauncher';\nimport path from 'path';\nimport { kBrowserCloseMessageId } from './wkConnection';\nimport { BrowserType, kNoXServerRunningError } from '../browserType';\nimport type { ConnectionTransport } from '../transport';\nimport type { BrowserOptions } from '../browser';\nimport type * as types from '../types';\nimport { wrapInASCIIBox } from '../../utils';\nimport type { SdkObject } from '../instrumentation';\nimport type { ProtocolError } from '../protocolError';\n\nexport class WebKit extends BrowserType {\n  constructor(parent: SdkObject) {\n    super(parent, 'webkit');\n  }\n\n  override connectToTransport(transport: ConnectionTransport, options: BrowserOptions): Promise<WKBrowser> {\n    return WKBrowser.connect(this.attribution.playwright, transport, options);\n  }\n\n  override amendEnvironment(env: Env, userDataDir: string, executable: string, browserArguments: string[]): Env {\n    return { ...env, CURL_COOKIE_JAR_PATH: path.join(userDataDir, 'cookiejar.db') };\n  }\n\n  override doRewriteStartupLog(error: ProtocolError): ProtocolError {\n    if (!error.logs)\n      return error;\n    if (error.logs.includes('cannot open display'))\n      error.logs = '\\n' + wrapInASCIIBox(kNoXServerRunningError, 1);\n    return error;\n  }\n\n  override attemptToGracefullyCloseBrowser(transport: ConnectionTransport): void {\n    transport.send({ method: 'Playwright.close', params: {}, id: kBrowserCloseMessageId });\n  }\n\n  override defaultArgs(options: types.LaunchOptions, isPersistent: boolean, userDataDir: string): string[] {\n    const { args = [], proxy, headless } = options;\n    const userDataDirArg = args.find(arg => arg.startsWith('--user-data-dir'));\n    if (userDataDirArg)\n      throw this._createUserDataDirArgMisuseError('--user-data-dir');\n    if (args.find(arg => !arg.startsWith('-')))\n      throw new Error('Arguments can not specify page to be opened');\n    const webkitArguments = ['--inspector-pipe'];\n    if (process.platform === 'win32')\n      webkitArguments.push('--disable-accelerated-compositing');\n    if (headless)\n      webkitArguments.push('--headless');\n    if (isPersistent)\n      webkitArguments.push(`--user-data-dir=${userDataDir}`);\n    else\n      webkitArguments.push(`--no-startup-window`);\n    if (proxy) {\n      if (process.platform === 'darwin') {\n        webkitArguments.push(`--proxy=${proxy.server}`);\n        if (proxy.bypass)\n          webkitArguments.push(`--proxy-bypass-list=${proxy.bypass}`);\n      } else if (process.platform === 'linux') {\n        webkitArguments.push(`--proxy=${proxy.server}`);\n        if (proxy.bypass)\n          webkitArguments.push(...proxy.bypass.split(',').map(t => `--ignore-host=${t}`));\n      } else if (process.platform === 'win32') {\n        // Enable socks5 hostname resolution on Windows. Workaround can be removed once fixed upstream.\n        // See https://github.com/microsoft/playwright/issues/20451\n        webkitArguments.push(`--curl-proxy=${proxy.server.replace(/^socks5:\\/\\//, 'socks5h://')}`);\n        if (proxy.bypass)\n          webkitArguments.push(`--curl-noproxy=${proxy.bypass}`);\n      }\n    }\n    webkitArguments.push(...args);\n    if (isPersistent)\n      webkitArguments.push('about:blank');\n    return webkitArguments;\n  }\n}\n"],"mappings":"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"}