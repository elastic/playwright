{"version":3,"file":"wkInput.js","names":["input","_interopRequireWildcard","require","_macEditingCommands","_utils","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","toModifiersMask","modifiers","mask","toButtonsMask","buttons","RawKeyboardImpl","constructor","session","_pageProxySession","_session","setSession","keydown","code","keyCode","keyCodeWithoutLocation","key","location","autoRepeat","text","parts","modifier","push","shortcut","join","commands","macEditingCommands","isString","send","type","windowsVirtualKeyCode","unmodifiedText","macCommands","isKeypad","keypadLocation","keyup","sendText","exports","RawMouseImpl","_page","move","x","y","button","forClick","down","clickCount","up","wheel","deltaX","deltaY","_this$_page","_browserContext","_options","isMobile","Error","mainFrame","evaluateExpression","world","setPage","page","RawTouchscreenImpl","tap"],"sources":["../../../src/server/webkit/wkInput.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as input from '../input';\nimport type * as types from '../types';\nimport { macEditingCommands } from '../macEditingCommands';\nimport type { WKSession } from './wkConnection';\nimport { isString } from '../../utils';\nimport type { Page } from '../page';\n\nfunction toModifiersMask(modifiers: Set<types.KeyboardModifier>): number {\n  // From Source/WebKit/Shared/WebEvent.h\n  let mask = 0;\n  if (modifiers.has('Shift'))\n    mask |= 1;\n  if (modifiers.has('Control'))\n    mask |= 2;\n  if (modifiers.has('Alt'))\n    mask |= 4;\n  if (modifiers.has('Meta'))\n    mask |= 8;\n  return mask;\n}\n\nfunction toButtonsMask(buttons: Set<types.MouseButton>): number {\n  let mask = 0;\n  if (buttons.has('left'))\n    mask |= 1;\n  if (buttons.has('right'))\n    mask |= 2;\n  if (buttons.has('middle'))\n    mask |= 4;\n  return mask;\n}\n\nexport class RawKeyboardImpl implements input.RawKeyboard {\n  private readonly _pageProxySession: WKSession;\n  private _session?: WKSession;\n\n  constructor(session: WKSession) {\n    this._pageProxySession = session;\n  }\n\n  setSession(session: WKSession) {\n    this._session = session;\n  }\n\n  async keydown(modifiers: Set<types.KeyboardModifier>, code: string, keyCode: number, keyCodeWithoutLocation: number, key: string, location: number, autoRepeat: boolean, text: string | undefined): Promise<void> {\n    const parts = [];\n    for (const modifier of (['Shift', 'Control', 'Alt', 'Meta']) as types.KeyboardModifier[]) {\n      if (modifiers.has(modifier))\n        parts.push(modifier);\n    }\n    parts.push(code);\n    const shortcut = parts.join('+');\n    let commands = macEditingCommands[shortcut];\n    if (isString(commands))\n      commands = [commands];\n    await this._pageProxySession.send('Input.dispatchKeyEvent', {\n      type: 'keyDown',\n      modifiers: toModifiersMask(modifiers),\n      windowsVirtualKeyCode: keyCode,\n      code,\n      key,\n      text,\n      unmodifiedText: text,\n      autoRepeat,\n      macCommands: commands,\n      isKeypad: location === input.keypadLocation\n    });\n  }\n\n  async keyup(modifiers: Set<types.KeyboardModifier>, code: string, keyCode: number, keyCodeWithoutLocation: number, key: string, location: number): Promise<void> {\n    await this._pageProxySession.send('Input.dispatchKeyEvent', {\n      type: 'keyUp',\n      modifiers: toModifiersMask(modifiers),\n      key,\n      windowsVirtualKeyCode: keyCode,\n      code,\n      isKeypad: location === input.keypadLocation\n    });\n  }\n\n  async sendText(text: string): Promise<void> {\n    await this._session!.send('Page.insertText', { text });\n  }\n}\n\nexport class RawMouseImpl implements input.RawMouse {\n  private readonly _pageProxySession: WKSession;\n  private _session?: WKSession;\n  private _page?: Page;\n\n  constructor(session: WKSession) {\n    this._pageProxySession = session;\n  }\n\n  setSession(session: WKSession) {\n    this._session = session;\n  }\n\n  async move(x: number, y: number, button: types.MouseButton | 'none', buttons: Set<types.MouseButton>, modifiers: Set<types.KeyboardModifier>, forClick: boolean): Promise<void> {\n    await this._pageProxySession.send('Input.dispatchMouseEvent', {\n      type: 'move',\n      button,\n      buttons: toButtonsMask(buttons),\n      x,\n      y,\n      modifiers: toModifiersMask(modifiers)\n    });\n  }\n\n  async down(x: number, y: number, button: types.MouseButton, buttons: Set<types.MouseButton>, modifiers: Set<types.KeyboardModifier>, clickCount: number): Promise<void> {\n    await this._pageProxySession.send('Input.dispatchMouseEvent', {\n      type: 'down',\n      button,\n      buttons: toButtonsMask(buttons),\n      x,\n      y,\n      modifiers: toModifiersMask(modifiers),\n      clickCount\n    });\n  }\n\n  async up(x: number, y: number, button: types.MouseButton, buttons: Set<types.MouseButton>, modifiers: Set<types.KeyboardModifier>, clickCount: number): Promise<void> {\n    await this._pageProxySession.send('Input.dispatchMouseEvent', {\n      type: 'up',\n      button,\n      buttons: toButtonsMask(buttons),\n      x,\n      y,\n      modifiers: toModifiersMask(modifiers),\n      clickCount\n    });\n  }\n\n  async wheel(x: number, y: number, buttons: Set<types.MouseButton>, modifiers: Set<types.KeyboardModifier>, deltaX: number, deltaY: number): Promise<void> {\n    if (this._page?._browserContext._options.isMobile)\n      throw new Error('Mouse wheel is not supported in mobile WebKit');\n    await this._session!.send('Page.updateScrollingState');\n    // Wheel events hit the compositor first, so wait one frame for it to be synced.\n    await this._page!.mainFrame().evaluateExpression(`new Promise(requestAnimationFrame)`, { world: 'utility' });\n    await this._pageProxySession.send('Input.dispatchWheelEvent', {\n      x,\n      y,\n      deltaX,\n      deltaY,\n      modifiers: toModifiersMask(modifiers),\n    });\n  }\n\n  setPage(page: Page) {\n    this._page = page;\n  }\n}\n\nexport class RawTouchscreenImpl implements input.RawTouchscreen {\n  private readonly _pageProxySession: WKSession;\n\n  constructor(session: WKSession) {\n    this._pageProxySession = session;\n  }\n\n  async tap(x: number, y: number, modifiers: Set<types.KeyboardModifier>) {\n    await this._pageProxySession.send('Input.dispatchTapEvent', {\n      x,\n      y,\n      modifiers: toModifiersMask(modifiers),\n    });\n  }\n}\n"],"mappings":"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"}