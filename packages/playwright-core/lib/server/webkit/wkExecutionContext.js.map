{"version":3,"file":"wkExecutionContext.js","names":["js","_interopRequireWildcard","require","_utilityScriptSerializers","_protocolError","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","WKExecutionContext","constructor","session","contextId","_session","_contextId","rawEvaluateJSON","expression","response","send","returnByValue","wasThrown","JavaScriptErrorInEvaluate","result","description","value","error","rewriteError","rawEvaluateHandle","objectId","rawCallFunctionNoReply","func","args","functionDeclaration","toString","find","JSHandle","_objectId","arguments","map","emulateUserGesture","catch","evaluateWithArguments","utilityScript","values","objectIds","awaitPromise","parseEvaluationResultValue","_context","createHandle","getProperties","context","ownProperties","Map","property","properties","enumerable","name","remoteObject","isPromise","className","subtype","type","renderPreview","potentiallyUnserializableValue","releaseHandle","objectCount","Error","exports","isUnserializable","includes","parseUnserializableValue","isJavaScriptErrorInEvaluate","isSessionClosedError","object","String","preview","tokens","push","join","sparseArrayToString"],"sources":["../../../src/server/webkit/wkExecutionContext.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { WKSession } from './wkConnection';\nimport type { Protocol } from './protocol';\nimport * as js from '../javascript';\nimport { parseEvaluationResultValue } from '../isomorphic/utilityScriptSerializers';\nimport { isSessionClosedError } from '../protocolError';\n\nexport class WKExecutionContext implements js.ExecutionContextDelegate {\n  private readonly _session: WKSession;\n  readonly _contextId: number | undefined;\n\n  constructor(session: WKSession, contextId: number | undefined) {\n    this._session = session;\n    this._contextId = contextId;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    try {\n      const response = await this._session.send('Runtime.evaluate', {\n        expression,\n        contextId: this._contextId,\n        returnByValue: true\n      });\n      if (response.wasThrown)\n        throw new js.JavaScriptErrorInEvaluate(response.result.description);\n      return response.result.value;\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  async rawEvaluateHandle(expression: string): Promise<js.ObjectId> {\n    try {\n      const response = await this._session.send('Runtime.evaluate', {\n        expression,\n        contextId: this._contextId,\n        returnByValue: false\n      });\n      if (response.wasThrown)\n        throw new js.JavaScriptErrorInEvaluate(response.result.description);\n      return response.result.objectId!;\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  rawCallFunctionNoReply(func: Function, ...args: any[]) {\n    this._session.send('Runtime.callFunctionOn', {\n      functionDeclaration: func.toString(),\n      objectId: args.find(a => a instanceof js.JSHandle)!._objectId!,\n      arguments: args.map(a => a instanceof js.JSHandle ? { objectId: a._objectId } : { value: a }),\n      returnByValue: true,\n      emulateUserGesture: true\n    }).catch(() => {});\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], objectIds: string[]): Promise<any> {\n    try {\n      const response = await this._session.send('Runtime.callFunctionOn', {\n        functionDeclaration: expression,\n        objectId: utilityScript._objectId!,\n        arguments: [\n          { objectId: utilityScript._objectId },\n          ...values.map(value => ({ value })),\n          ...objectIds.map(objectId => ({ objectId })),\n        ],\n        returnByValue,\n        emulateUserGesture: true,\n        awaitPromise: true\n      });\n      if (response.wasThrown)\n        throw new js.JavaScriptErrorInEvaluate(response.result.description);\n      if (returnByValue)\n        return parseEvaluationResultValue(response.result.value);\n      return utilityScript._context.createHandle(response.result);\n    } catch (error) {\n      throw rewriteError(error);\n    }\n  }\n\n  async getProperties(context: js.ExecutionContext, objectId: js.ObjectId): Promise<Map<string, js.JSHandle>> {\n    const response = await this._session.send('Runtime.getProperties', {\n      objectId,\n      ownProperties: true\n    });\n    const result = new Map();\n    for (const property of response.properties) {\n      if (!property.enumerable || !property.value)\n        continue;\n      result.set(property.name, context.createHandle(property.value));\n    }\n    return result;\n  }\n\n  createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n    const isPromise = remoteObject.className === 'Promise';\n    return new js.JSHandle(context, isPromise ? 'promise' : remoteObject.subtype || remoteObject.type, renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n  }\n\n  async releaseHandle(objectId: js.ObjectId): Promise<void> {\n    await this._session.send('Runtime.releaseObject', { objectId });\n  }\n\n  objectCount(objectId: js.ObjectId): Promise<number> {\n    throw new Error('Method not implemented in WebKit.');\n  }\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const isUnserializable = remoteObject.type === 'number' && ['NaN', '-Infinity', 'Infinity', '-0'].includes(remoteObject.description!);\n  return isUnserializable ? js.parseUnserializableValue(remoteObject.description!) : value;\n}\n\nfunction rewriteError(error: Error): Error {\n  if (!js.isJavaScriptErrorInEvaluate(error) && !isSessionClosedError(error))\n    return new Error('Execution context was destroyed, most likely because of a navigation.');\n  return error;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if ('value' in object)\n    return String(object.value);\n\n  if (object.description === 'Object' && object.preview) {\n    const tokens = [];\n    for (const { name, value } of object.preview.properties!)\n      tokens.push(`${name}: ${value}`);\n    return `{${tokens.join(', ')}}`;\n  }\n  if (object.subtype === 'array' && object.preview)\n    return js.sparseArrayToString(object.preview.properties!);\n  return object.description;\n}\n"],"mappings":"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"}