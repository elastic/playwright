{"version":3,"file":"wkProvisionalPage.js","names":["_eventsHelper","require","_utils","WKProvisionalPage","constructor","session","page","_page$_page$mainFrame","_session","_wkPage","_coopNavigationRequest","_sessionListeners","_mainFrameId","initializationPromise","_page","mainFrame","pendingDocument","request","overrideFrameId","handler","payload","frameId","_frameManager","_id","wkPage","eventsHelper","addEventListener","e","_onRequestWillBeSent","_onRequestIntercepted","_onResponseReceived","_onLoadingFinished","_onLoadingFailed","_initializeSession","frameTree","_handleFrameTree","coopNavigationRequest","dispose","removeEventListeners","commit","assert","_onFrameAttached","event","url","_adoptRequestFromNewProcess","requestId","undefined","frame","parentId","id","exports"],"sources":["../../../src/server/webkit/wkProvisionalPage.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { WKSession } from './wkConnection';\nimport type { WKPage } from './wkPage';\nimport type { RegisteredListener } from '../../utils/eventsHelper';\nimport { eventsHelper } from '../../utils/eventsHelper';\nimport type { Protocol } from './protocol';\nimport { assert } from '../../utils';\nimport type * as network from '../network';\n\nexport class WKProvisionalPage {\n  readonly _session: WKSession;\n  private readonly _wkPage: WKPage;\n  private _coopNavigationRequest: network.Request | undefined;\n  private _sessionListeners: RegisteredListener[] = [];\n  private _mainFrameId: string | null = null;\n  readonly initializationPromise: Promise<void>;\n\n  constructor(session: WKSession, page: WKPage) {\n    this._session = session;\n    this._wkPage = page;\n    // Cross-Origin-Opener-Policy (COOP) request starts in one process and once response headers\n    // have been received, continues in another.\n    //\n    // Network.requestWillBeSent and requestIntercepted (if intercepting) from the original web process\n    // will always come before a provisional page is created based on the response COOP headers.\n    // Thereafter we'll receive targetCreated (provisional) and later on in some order loadingFailed from the\n    // original process and requestWillBeSent from the provisional one. We should ignore loadingFailed\n    // as the original request continues in the provisional process. But if the provisional load is later\n    // canceled we should dispatch loadingFailed to the client.\n    this._coopNavigationRequest = page._page.mainFrame().pendingDocument()?.request;\n\n    const overrideFrameId = (handler: (p: any) => void) => {\n      return (payload: any) => {\n        // Pretend that the events happened in the same process.\n        if (payload.frameId)\n          payload.frameId = this._wkPage._page._frameManager.mainFrame()._id;\n        handler(payload);\n      };\n    };\n    const wkPage = this._wkPage;\n\n    this._sessionListeners = [\n      eventsHelper.addEventListener(session, 'Network.requestWillBeSent', overrideFrameId(e => this._onRequestWillBeSent(e))),\n      eventsHelper.addEventListener(session, 'Network.requestIntercepted', overrideFrameId(e => wkPage._onRequestIntercepted(session, e))),\n      eventsHelper.addEventListener(session, 'Network.responseReceived', overrideFrameId(e => wkPage._onResponseReceived(session, e))),\n      eventsHelper.addEventListener(session, 'Network.loadingFinished', overrideFrameId(e => this._onLoadingFinished(e))),\n      eventsHelper.addEventListener(session, 'Network.loadingFailed', overrideFrameId(e => this._onLoadingFailed(e))),\n    ];\n\n    this.initializationPromise = this._wkPage._initializeSession(session, true, ({ frameTree }) => this._handleFrameTree(frameTree));\n  }\n\n  coopNavigationRequest(): network.Request | undefined {\n    return this._coopNavigationRequest;\n  }\n\n  dispose() {\n    eventsHelper.removeEventListeners(this._sessionListeners);\n  }\n\n  commit() {\n    assert(this._mainFrameId);\n    this._wkPage._onFrameAttached(this._mainFrameId, null);\n  }\n\n  private _onRequestWillBeSent(event: Protocol.Network.requestWillBeSentPayload) {\n    if (this._coopNavigationRequest && this._coopNavigationRequest.url() === event.request.url) {\n      // If it's a continuation of the main frame navigation request after COOP headers were received,\n      // take over original request, and replace its request id with the new one.\n      this._wkPage._adoptRequestFromNewProcess(this._coopNavigationRequest, this._session, event.requestId);\n      // Simply ignore this event as it has already been dispatched from the original process\n      // and there will ne no requestIntercepted event from the provisional process as it resumes\n      // existing network load (that has already received reponse headers).\n      return;\n    }\n    this._wkPage._onRequestWillBeSent(this._session, event);\n  }\n\n  private _onLoadingFinished(event: Protocol.Network.loadingFinishedPayload): void {\n    this._coopNavigationRequest = undefined;\n    this._wkPage._onLoadingFinished(event);\n  }\n\n  private _onLoadingFailed(event: Protocol.Network.loadingFailedPayload) {\n    this._coopNavigationRequest = undefined;\n    this._wkPage._onLoadingFailed(this._session, event);\n  }\n\n  private _handleFrameTree(frameTree: Protocol.Page.FrameResourceTree) {\n    assert(!frameTree.frame.parentId);\n    this._mainFrameId = frameTree.frame.id;\n  }\n}"],"mappings":"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"}