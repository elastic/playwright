{"version":3,"file":"wkAccessibility.js","names":["getAccessibilityTree","session","needle","objectId","_objectId","undefined","axNode","send","tree","WKAXNode","_findNeedle","WKRoleToARIARole","Map","Object","entries","WKUnhelpfulRoleDescriptions","constructor","payload","_payload","_children","children","push","found","child","isControl","role","_isTextControl","_name","value","name","isInteresting","insideControl","focusable","isLeafNode","_hasRedundantTextChild","length","serialize","node","get","description","roledescription","valueString","valueNumber","checked","pressed","userStringProperties","userStringProperty","booleanProperties","booleanProperty","numericalProperties","numericalProperty","tokenProperties","tokenProperty","orientationIsApplicable","Set","orientation","has"],"sources":["../../../src/server/webkit/wkAccessibility.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport type * as accessibility from '../accessibility';\nimport type { WKSession } from './wkConnection';\nimport type { Protocol } from './protocol';\nimport type * as dom from '../dom';\nimport type * as channels from '@protocol/channels';\n\nexport async function getAccessibilityTree(session: WKSession, needle?: dom.ElementHandle) {\n  const objectId = needle ? needle._objectId : undefined;\n  const { axNode } = await session.send('Page.accessibilitySnapshot', { objectId });\n  const tree = new WKAXNode(axNode);\n  return {\n    tree,\n    needle: needle ? tree._findNeedle() : null\n  };\n}\n\nconst WKRoleToARIARole = new Map(Object.entries({\n  'TextField': 'textbox',\n}));\n\n// WebKit localizes role descriptions on mac, but the english versions only add noise.\nconst WKUnhelpfulRoleDescriptions = new Map(Object.entries({\n  'WebArea': 'HTML content',\n  'Summary': 'summary',\n  'DescriptionList': 'description list',\n  'ImageMap': 'image map',\n  'ListMarker': 'list marker',\n  'Video': 'video playback',\n  'Mark': 'highlighted',\n  'contentinfo': 'content information',\n  'Details': 'details',\n  'DescriptionListDetail': 'description',\n  'DescriptionListTerm': 'term',\n  'alertdialog': 'web alert dialog',\n  'dialog': 'web dialog',\n  'status': 'application status',\n  'tabpanel': 'tab panel',\n  'application': 'web application',\n}));\n\nclass WKAXNode implements accessibility.AXNode {\n  private _payload: Protocol.Page.AXNode;\n  private _children: WKAXNode[];\n\n  constructor(payload: Protocol.Page.AXNode) {\n    this._payload = payload;\n\n    this._children = [];\n    for (const payload of this._payload.children || [])\n      this._children.push(new WKAXNode(payload));\n  }\n\n  children() {\n    return this._children;\n  }\n\n  _findNeedle(): WKAXNode | null {\n    if (this._payload.found)\n      return this;\n    for (const child of this._children) {\n      const found = child._findNeedle();\n      if (found)\n        return found;\n    }\n    return null;\n  }\n\n  isControl(): boolean {\n    switch (this._payload.role) {\n      case 'button':\n      case 'checkbox':\n      case 'ColorWell':\n      case 'combobox':\n      case 'DisclosureTriangle':\n      case 'listbox':\n      case 'menu':\n      case 'menubar':\n      case 'menuitem':\n      case 'menuitemcheckbox':\n      case 'menuitemradio':\n      case 'radio':\n      case 'scrollbar':\n      case 'searchbox':\n      case 'slider':\n      case 'spinbutton':\n      case 'switch':\n      case 'tab':\n      case 'textbox':\n      case 'TextField':\n      case 'tree':\n        return true;\n      default:\n        return false;\n    }\n  }\n\n  _isTextControl(): boolean {\n    switch (this._payload.role) {\n      case 'combobox':\n      case 'searchfield':\n      case 'textbox':\n      case 'TextField':\n        return true;\n    }\n    return false;\n  }\n\n  _name(): string {\n    if (this._payload.role === 'text')\n      return this._payload.value || '';\n    return this._payload.name || '';\n  }\n\n  isInteresting(insideControl: boolean): boolean {\n    const { role, focusable } = this._payload;\n    const name = this._name();\n    if (role === 'ScrollArea')\n      return false;\n    if (role === 'WebArea')\n      return true;\n\n    if (focusable || role === 'MenuListOption')\n      return true;\n\n    // If it's not focusable but has a control role, then it's interesting.\n    if (this.isControl())\n      return true;\n\n    // A non focusable child of a control is not interesting\n    if (insideControl)\n      return false;\n\n    return this.isLeafNode() && !!name;\n  }\n\n  _hasRedundantTextChild() {\n    if (this._children.length !== 1)\n      return false;\n    const child = this._children[0];\n    return child._payload.role === 'text' && this._payload.name === child._payload.value;\n  }\n\n  isLeafNode(): boolean {\n    if (!this._children.length)\n      return true;\n      // WebKit on Linux ignores everything inside text controls, normalize this behavior\n    if (this._isTextControl())\n      return true;\n      // WebKit for mac has text nodes inside heading, li, menuitem, a, and p nodes\n    if (this._hasRedundantTextChild())\n      return true;\n    return false;\n  }\n\n  serialize(): channels.AXNode {\n    const node: channels.AXNode = {\n      role: WKRoleToARIARole.get(this._payload.role) || this._payload.role,\n      name: this._name(),\n    };\n\n    if ('description' in this._payload && this._payload.description !== node.name)\n      node.description = this._payload.description;\n\n    if ('roledescription' in this._payload) {\n      const roledescription = this._payload.roledescription;\n      if (roledescription !== this._payload.role && WKUnhelpfulRoleDescriptions.get(this._payload.role) !== roledescription)\n        node.roledescription = roledescription;\n    }\n\n    if ('value' in this._payload && this._payload.role !== 'text') {\n      if (typeof this._payload.value === 'string')\n        node.valueString = this._payload.value;\n      else if (typeof this._payload.value === 'number')\n        node.valueNumber = this._payload.value;\n    }\n\n    if ('checked' in this._payload)\n      node.checked = this._payload.checked === 'true' ? 'checked' : this._payload.checked === 'false' ? 'unchecked' : 'mixed';\n\n    if ('pressed' in this._payload)\n      node.pressed = this._payload.pressed === 'true' ? 'pressed' : this._payload.pressed === 'false' ? 'released' : 'mixed';\n\n    const userStringProperties: Array<keyof channels.AXNode & keyof Protocol.Page.AXNode> = [\n      'keyshortcuts',\n      'valuetext'\n    ];\n    for (const userStringProperty of userStringProperties) {\n      if (!(userStringProperty in this._payload))\n        continue;\n      (node as any)[userStringProperty] = this._payload[userStringProperty];\n    }\n\n    const booleanProperties: Array<keyof channels.AXNode & keyof Protocol.Page.AXNode> = [\n      'disabled',\n      'expanded',\n      'focused',\n      'modal',\n      'multiselectable',\n      'readonly',\n      'required',\n      'selected',\n    ];\n    for (const booleanProperty of booleanProperties) {\n      // WebArea and ScrollArea treat focus differently than other nodes. They report whether their frame  has focus,\n      // not whether focus is specifically on the root node.\n      if (booleanProperty === 'focused' && (this._payload.role === 'WebArea' || this._payload.role === 'ScrollArea'))\n        continue;\n      const value = this._payload[booleanProperty];\n      if (!value)\n        continue;\n      (node as any)[booleanProperty] = value;\n    }\n\n    const numericalProperties: Array<keyof channels.AXNode & keyof Protocol.Page.AXNode> = [\n      'level',\n      'valuemax',\n      'valuemin',\n    ];\n    for (const numericalProperty of numericalProperties) {\n      if (!(numericalProperty in this._payload))\n        continue;\n      (node as any)[numericalProperty] = (this._payload as any)[numericalProperty];\n    }\n    const tokenProperties: Array<keyof channels.AXNode & keyof Protocol.Page.AXNode> = [\n      'autocomplete',\n      'haspopup',\n      'invalid',\n    ];\n    for (const tokenProperty of tokenProperties) {\n      const value = (this._payload as any)[tokenProperty];\n      if (!value || value === 'false')\n        continue;\n      (node as any)[tokenProperty] = value;\n    }\n\n    const orientationIsApplicable = new Set([\n      'ScrollArea',\n      'scrollbar',\n      'listbox',\n      'combobox',\n      'menu',\n      'tree',\n      'separator',\n      'slider',\n      'tablist',\n      'toolbar',\n    ]);\n    if (this._payload.orientation && orientationIsApplicable.has(this._payload.role))\n      node.orientation = this._payload.orientation;\n\n    return node;\n  }\n}\n"],"mappings":"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"}