{"version":3,"file":"playwrightDispatcher.js","names":["_fetch","require","_socksProxy","_androidDispatcher","_browserTypeDispatcher","_dispatcher","_electronDispatcher","_localUtilsDispatcher","_networkDispatchers","_selectorsDispatcher","_browserDispatcher","_utils","_eventsHelper","PlaywrightDispatcher","Dispatcher","constructor","scope","playwright","socksProxy","preLaunchedBrowser","prelaunchedAndroidDevice","browserDispatcher","ConnectedBrowserDispatcher","undefined","android","AndroidDispatcher","prelaunchedAndroidDeviceDispatcher","AndroidDeviceDispatcher","chromium","BrowserTypeDispatcher","bidi","firefox","webkit","electron","ElectronDispatcher","utils","options","isServer","LocalUtilsDispatcher","selectors","SelectorsDispatcher","preConnectedAndroidDevice","socksSupport","SocksSupportDispatcher","_type_Playwright","newRequest","params","request","GlobalAPIRequestContext","_object","APIRequestContextDispatcher","from","parentScope","cleanup","_this$_browserDispatc","cleanupContexts","exports","guid","createGuid","_type_SocksSupport","_socksListeners","eventsHelper","addEventListener","SocksProxy","Events","SocksRequested","payload","_dispatchEvent","SocksData","SocksClosed","socksConnected","_this$_socksProxy","socketConnected","socksFailed","_this$_socksProxy2","socketFailed","socksData","_this$_socksProxy3","sendSocketData","socksError","_this$_socksProxy4","sendSocketError","socksEnd","_this$_socksProxy5","sendSocketEnd","_onDispose","removeEventListeners"],"sources":["../../../src/server/dispatchers/playwrightDispatcher.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\nimport type { Browser } from '../browser';\nimport { GlobalAPIRequestContext } from '../fetch';\nimport type { Playwright } from '../playwright';\nimport type { SocksSocketClosedPayload, SocksSocketDataPayload, SocksSocketRequestedPayload } from '../../common/socksProxy';\nimport { SocksProxy } from '../../common/socksProxy';\nimport { AndroidDispatcher } from './androidDispatcher';\nimport { BrowserTypeDispatcher } from './browserTypeDispatcher';\nimport type { RootDispatcher } from './dispatcher';\nimport { Dispatcher } from './dispatcher';\nimport { ElectronDispatcher } from './electronDispatcher';\nimport { LocalUtilsDispatcher } from './localUtilsDispatcher';\nimport { APIRequestContextDispatcher } from './networkDispatchers';\nimport { SelectorsDispatcher } from './selectorsDispatcher';\nimport { ConnectedBrowserDispatcher } from './browserDispatcher';\nimport { createGuid } from '../../utils';\nimport type { AndroidDevice } from '../android/android';\nimport { AndroidDeviceDispatcher } from './androidDispatcher';\nimport { eventsHelper, type RegisteredListener } from '../../utils/eventsHelper';\n\nexport class PlaywrightDispatcher extends Dispatcher<Playwright, channels.PlaywrightChannel, RootDispatcher> implements channels.PlaywrightChannel {\n  _type_Playwright;\n  private _browserDispatcher: ConnectedBrowserDispatcher | undefined;\n\n  constructor(scope: RootDispatcher, playwright: Playwright, socksProxy?: SocksProxy, preLaunchedBrowser?: Browser, prelaunchedAndroidDevice?: AndroidDevice) {\n    const browserDispatcher = preLaunchedBrowser ? new ConnectedBrowserDispatcher(scope, preLaunchedBrowser) : undefined;\n    const android = new AndroidDispatcher(scope, playwright.android);\n    const prelaunchedAndroidDeviceDispatcher = prelaunchedAndroidDevice ? new AndroidDeviceDispatcher(android, prelaunchedAndroidDevice) : undefined;\n    super(scope, playwright, 'Playwright', {\n      chromium: new BrowserTypeDispatcher(scope, playwright.chromium),\n      bidi: new BrowserTypeDispatcher(scope, playwright.bidi),\n      firefox: new BrowserTypeDispatcher(scope, playwright.firefox),\n      webkit: new BrowserTypeDispatcher(scope, playwright.webkit),\n      android,\n      electron: new ElectronDispatcher(scope, playwright.electron),\n      utils: playwright.options.isServer ? undefined : new LocalUtilsDispatcher(scope, playwright),\n      selectors: new SelectorsDispatcher(scope, browserDispatcher?.selectors || playwright.selectors),\n      preLaunchedBrowser: browserDispatcher,\n      preConnectedAndroidDevice: prelaunchedAndroidDeviceDispatcher,\n      socksSupport: socksProxy ? new SocksSupportDispatcher(scope, socksProxy) : undefined,\n    });\n    this._type_Playwright = true;\n    this._browserDispatcher = browserDispatcher;\n  }\n\n  async newRequest(params: channels.PlaywrightNewRequestParams): Promise<channels.PlaywrightNewRequestResult> {\n    const request = new GlobalAPIRequestContext(this._object, params);\n    return { request: APIRequestContextDispatcher.from(this.parentScope(), request) };\n  }\n\n  async cleanup() {\n    // Cleanup contexts upon disconnect.\n    await this._browserDispatcher?.cleanupContexts();\n  }\n}\n\nclass SocksSupportDispatcher extends Dispatcher<{ guid: string }, channels.SocksSupportChannel, RootDispatcher> implements channels.SocksSupportChannel {\n  _type_SocksSupport: boolean;\n  private _socksProxy: SocksProxy;\n  private _socksListeners: RegisteredListener[];\n\n  constructor(scope: RootDispatcher, socksProxy: SocksProxy) {\n    super(scope, { guid: 'socksSupport@' + createGuid() }, 'SocksSupport', {});\n    this._type_SocksSupport = true;\n    this._socksProxy = socksProxy;\n    this._socksListeners = [\n      eventsHelper.addEventListener(socksProxy, SocksProxy.Events.SocksRequested, (payload: SocksSocketRequestedPayload) => this._dispatchEvent('socksRequested', payload)),\n      eventsHelper.addEventListener(socksProxy, SocksProxy.Events.SocksData, (payload: SocksSocketDataPayload) => this._dispatchEvent('socksData', payload)),\n      eventsHelper.addEventListener(socksProxy, SocksProxy.Events.SocksClosed, (payload: SocksSocketClosedPayload) => this._dispatchEvent('socksClosed', payload)),\n    ];\n  }\n\n  async socksConnected(params: channels.SocksSupportSocksConnectedParams): Promise<void> {\n    this._socksProxy?.socketConnected(params);\n  }\n\n  async socksFailed(params: channels.SocksSupportSocksFailedParams): Promise<void> {\n    this._socksProxy?.socketFailed(params);\n  }\n\n  async socksData(params: channels.SocksSupportSocksDataParams): Promise<void> {\n    this._socksProxy?.sendSocketData(params);\n  }\n\n  async socksError(params: channels.SocksSupportSocksErrorParams): Promise<void> {\n    this._socksProxy?.sendSocketError(params);\n  }\n\n  async socksEnd(params: channels.SocksSupportSocksEndParams): Promise<void> {\n    this._socksProxy?.sendSocketEnd(params);\n  }\n\n  override _onDispose() {\n    eventsHelper.removeEventListeners(this._socksListeners);\n  }\n}\n"],"mappings":"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"}