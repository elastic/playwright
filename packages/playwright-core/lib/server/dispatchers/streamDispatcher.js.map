{"version":3,"file":"streamDispatcher.js","names":["_dispatcher","require","_utils","StreamDispatcher","Dispatcher","constructor","scope","stream","guid","createGuid","_type_Stream","_ended","once","read","params","_object","binary","Buffer","from","readableLength","readyPromise","ManualPromise","done","resolve","on","off","buffer","Math","min","size","close","destroy","exports"],"sources":["../../../src/server/dispatchers/streamDispatcher.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\nimport { Dispatcher } from './dispatcher';\nimport type * as stream from 'stream';\nimport { ManualPromise, createGuid } from '../../utils';\nimport type { ArtifactDispatcher } from './artifactDispatcher';\n\nexport class StreamDispatcher extends Dispatcher<{ guid: string, stream: stream.Readable }, channels.StreamChannel, ArtifactDispatcher> implements channels.StreamChannel {\n  _type_Stream = true;\n  private _ended: boolean = false;\n\n  constructor(scope: ArtifactDispatcher, stream: stream.Readable) {\n    super(scope, { guid: 'stream@' + createGuid(), stream }, 'Stream', {});\n    // In Node v12.9.0+ we can use readableEnded.\n    stream.once('end', () => this._ended =  true);\n    stream.once('error', () => this._ended =  true);\n  }\n\n  async read(params: channels.StreamReadParams): Promise<channels.StreamReadResult> {\n    const stream = this._object.stream;\n    if (this._ended)\n      return { binary: Buffer.from('') };\n    if (!stream.readableLength) {\n      const readyPromise = new ManualPromise<void>();\n      const done = () => readyPromise.resolve();\n      stream.on('readable', done);\n      stream.on('end', done);\n      stream.on('error', done);\n      await readyPromise;\n      stream.off('readable', done);\n      stream.off('end', done);\n      stream.off('error', done);\n    }\n    const buffer = stream.read(Math.min(stream.readableLength, params.size || stream.readableLength));\n    return { binary: buffer || Buffer.from('') };\n  }\n\n  async close() {\n    this._object.stream.destroy();\n  }\n}\n"],"mappings":";;;;;;AAiBA,IAAAA,WAAA,GAAAC,OAAA;AAEA,IAAAC,MAAA,GAAAD,OAAA;AAnBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAQO,MAAME,gBAAgB,SAASC,sBAAU,CAA0H;EAIxKC,WAAWA,CAACC,KAAyB,EAAEC,MAAuB,EAAE;IAC9D,KAAK,CAACD,KAAK,EAAE;MAAEE,IAAI,EAAE,SAAS,GAAG,IAAAC,iBAAU,EAAC,CAAC;MAAEF;IAAO,CAAC,EAAE,QAAQ,EAAE,CAAC,CAAC,CAAC;IACtE;IAAA,KALFG,YAAY,GAAG,IAAI;IAAA,KACXC,MAAM,GAAY,KAAK;IAK7BJ,MAAM,CAACK,IAAI,CAAC,KAAK,EAAE,MAAM,IAAI,CAACD,MAAM,GAAI,IAAI,CAAC;IAC7CJ,MAAM,CAACK,IAAI,CAAC,OAAO,EAAE,MAAM,IAAI,CAACD,MAAM,GAAI,IAAI,CAAC;EACjD;EAEA,MAAME,IAAIA,CAACC,MAAiC,EAAsC;IAChF,MAAMP,MAAM,GAAG,IAAI,CAACQ,OAAO,CAACR,MAAM;IAClC,IAAI,IAAI,CAACI,MAAM,EACb,OAAO;MAAEK,MAAM,EAAEC,MAAM,CAACC,IAAI,CAAC,EAAE;IAAE,CAAC;IACpC,IAAI,CAACX,MAAM,CAACY,cAAc,EAAE;MAC1B,MAAMC,YAAY,GAAG,IAAIC,oBAAa,CAAO,CAAC;MAC9C,MAAMC,IAAI,GAAGA,CAAA,KAAMF,YAAY,CAACG,OAAO,CAAC,CAAC;MACzChB,MAAM,CAACiB,EAAE,CAAC,UAAU,EAAEF,IAAI,CAAC;MAC3Bf,MAAM,CAACiB,EAAE,CAAC,KAAK,EAAEF,IAAI,CAAC;MACtBf,MAAM,CAACiB,EAAE,CAAC,OAAO,EAAEF,IAAI,CAAC;MACxB,MAAMF,YAAY;MAClBb,MAAM,CAACkB,GAAG,CAAC,UAAU,EAAEH,IAAI,CAAC;MAC5Bf,MAAM,CAACkB,GAAG,CAAC,KAAK,EAAEH,IAAI,CAAC;MACvBf,MAAM,CAACkB,GAAG,CAAC,OAAO,EAAEH,IAAI,CAAC;IAC3B;IACA,MAAMI,MAAM,GAAGnB,MAAM,CAACM,IAAI,CAACc,IAAI,CAACC,GAAG,CAACrB,MAAM,CAACY,cAAc,EAAEL,MAAM,CAACe,IAAI,IAAItB,MAAM,CAACY,cAAc,CAAC,CAAC;IACjG,OAAO;MAAEH,MAAM,EAAEU,MAAM,IAAIT,MAAM,CAACC,IAAI,CAAC,EAAE;IAAE,CAAC;EAC9C;EAEA,MAAMY,KAAKA,CAAA,EAAG;IACZ,IAAI,CAACf,OAAO,CAACR,MAAM,CAACwB,OAAO,CAAC,CAAC;EAC/B;AACF;AAACC,OAAA,CAAA7B,gBAAA,GAAAA,gBAAA"}