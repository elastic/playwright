{"version":3,"file":"browserDispatcher.js","names":["_browser","require","_browserContextDispatcher","_cdpSessionDispatcher","_dispatcher","_browserContext","_selectors","_artifactDispatcher","BrowserDispatcher","Dispatcher","constructor","scope","browser","version","name","options","_type_Browser","addObjectListener","Browser","Events","Disconnected","_didClose","_dispatchEvent","_dispose","newContext","params","metadata","context","_object","BrowserContextDispatcher","newContextForReuse","stopPendingOperations","reason","close","potentiallyClosesScope","killForTests","_","defaultUserAgentForTest","userAgent","newBrowserCDPSession","isChromium","Error","crBrowser","session","CDPSessionDispatcher","startTracing","page","undefined","stopTracing","artifact","ArtifactDispatcher","from","exports","ConnectedBrowserDispatcher","_contexts","Set","selectors","Selectors","recordVideo","dir","artifactsDir","add","setSelectors","on","BrowserContext","Close","delete","cleanupContexts","Promise","all","Array","map","needsReset","oldContextDispatcher","existingDispatcher","resetForReuse","contextDispatcher"],"sources":["../../../src/server/dispatchers/browserDispatcher.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { Browser } from '../browser';\nimport type * as channels from '@protocol/channels';\nimport { BrowserContextDispatcher } from './browserContextDispatcher';\nimport { CDPSessionDispatcher } from './cdpSessionDispatcher';\nimport { existingDispatcher } from './dispatcher';\nimport type { RootDispatcher } from './dispatcher';\nimport { Dispatcher } from './dispatcher';\nimport type { CRBrowser } from '../chromium/crBrowser';\nimport type { PageDispatcher } from './pageDispatcher';\nimport type { CallMetadata } from '../instrumentation';\nimport { BrowserContext } from '../browserContext';\nimport { Selectors } from '../selectors';\nimport type { BrowserTypeDispatcher } from './browserTypeDispatcher';\nimport { ArtifactDispatcher } from './artifactDispatcher';\n\nexport class BrowserDispatcher extends Dispatcher<Browser, channels.BrowserChannel, BrowserTypeDispatcher> implements channels.BrowserChannel {\n  _type_Browser = true;\n\n  constructor(scope: BrowserTypeDispatcher, browser: Browser) {\n    super(scope, browser, 'Browser', { version: browser.version(), name: browser.options.name });\n    this.addObjectListener(Browser.Events.Disconnected, () => this._didClose());\n  }\n\n  _didClose() {\n    this._dispatchEvent('close');\n    this._dispose();\n  }\n\n  async newContext(params: channels.BrowserNewContextParams, metadata: CallMetadata): Promise<channels.BrowserNewContextResult> {\n    const context = await this._object.newContext(metadata, params);\n    return { context: new BrowserContextDispatcher(this, context) };\n  }\n\n  async newContextForReuse(params: channels.BrowserNewContextForReuseParams, metadata: CallMetadata): Promise<channels.BrowserNewContextForReuseResult> {\n    return await newContextForReuse(this._object, this, params, null, metadata);\n  }\n\n  async stopPendingOperations(params: channels.BrowserStopPendingOperationsParams, metadata: CallMetadata): Promise<channels.BrowserStopPendingOperationsResult> {\n    await this._object.stopPendingOperations(params.reason);\n  }\n\n  async close(params: channels.BrowserCloseParams, metadata: CallMetadata): Promise<void> {\n    metadata.potentiallyClosesScope = true;\n    await this._object.close(params);\n  }\n\n  async killForTests(_: any, metadata: CallMetadata): Promise<void> {\n    metadata.potentiallyClosesScope = true;\n    await this._object.killForTests();\n  }\n\n  async defaultUserAgentForTest(): Promise<channels.BrowserDefaultUserAgentForTestResult> {\n    return { userAgent: this._object.userAgent() };\n  }\n\n  async newBrowserCDPSession(): Promise<channels.BrowserNewBrowserCDPSessionResult> {\n    if (!this._object.options.isChromium)\n      throw new Error(`CDP session is only available in Chromium`);\n    const crBrowser = this._object as CRBrowser;\n    return { session: new CDPSessionDispatcher(this, await crBrowser.newBrowserCDPSession()) };\n  }\n\n  async startTracing(params: channels.BrowserStartTracingParams): Promise<void> {\n    if (!this._object.options.isChromium)\n      throw new Error(`Tracing is only available in Chromium`);\n    const crBrowser = this._object as CRBrowser;\n    await crBrowser.startTracing(params.page ? (params.page as PageDispatcher)._object : undefined, params);\n  }\n\n  async stopTracing(): Promise<channels.BrowserStopTracingResult> {\n    if (!this._object.options.isChromium)\n      throw new Error(`Tracing is only available in Chromium`);\n    const crBrowser = this._object as CRBrowser;\n    return { artifact: ArtifactDispatcher.from(this, await crBrowser.stopTracing()) };\n  }\n}\n\n// This class implements multiplexing browser dispatchers over a single Browser instance.\nexport class ConnectedBrowserDispatcher extends Dispatcher<Browser, channels.BrowserChannel, RootDispatcher> implements channels.BrowserChannel {\n  _type_Browser = true;\n  private _contexts = new Set<BrowserContext>();\n  readonly selectors: Selectors;\n\n  constructor(scope: RootDispatcher, browser: Browser) {\n    super(scope, browser, 'Browser', { version: browser.version(), name: browser.options.name });\n    // When we have a remotely-connected browser, each client gets a fresh Selector instance,\n    // so that two clients do not interfere between each other.\n    this.selectors = new Selectors();\n  }\n\n  async newContext(params: channels.BrowserNewContextParams, metadata: CallMetadata): Promise<channels.BrowserNewContextResult> {\n    if (params.recordVideo)\n      params.recordVideo.dir = this._object.options.artifactsDir;\n    const context = await this._object.newContext(metadata, params);\n    this._contexts.add(context);\n    context.setSelectors(this.selectors);\n    context.on(BrowserContext.Events.Close, () => this._contexts.delete(context));\n    return { context: new BrowserContextDispatcher(this, context) };\n  }\n\n  async newContextForReuse(params: channels.BrowserNewContextForReuseParams, metadata: CallMetadata): Promise<channels.BrowserNewContextForReuseResult> {\n    return await newContextForReuse(this._object, this as any as BrowserDispatcher, params, this.selectors, metadata);\n  }\n\n  async stopPendingOperations(params: channels.BrowserStopPendingOperationsParams, metadata: CallMetadata): Promise<channels.BrowserStopPendingOperationsResult> {\n    await this._object.stopPendingOperations(params.reason);\n  }\n\n  async close(): Promise<void> {\n    // Client should not send us Browser.close.\n  }\n\n  async killForTests(): Promise<void> {\n    // Client should not send us Browser.killForTests.\n  }\n\n  async defaultUserAgentForTest(): Promise<channels.BrowserDefaultUserAgentForTestResult> {\n    throw new Error('Client should not send us Browser.defaultUserAgentForTest');\n  }\n\n  async newBrowserCDPSession(): Promise<channels.BrowserNewBrowserCDPSessionResult> {\n    if (!this._object.options.isChromium)\n      throw new Error(`CDP session is only available in Chromium`);\n    const crBrowser = this._object as CRBrowser;\n    return { session: new CDPSessionDispatcher(this as any as BrowserDispatcher, await crBrowser.newBrowserCDPSession()) };\n  }\n\n  async startTracing(params: channels.BrowserStartTracingParams): Promise<void> {\n    if (!this._object.options.isChromium)\n      throw new Error(`Tracing is only available in Chromium`);\n    const crBrowser = this._object as CRBrowser;\n    await crBrowser.startTracing(params.page ? (params.page as PageDispatcher)._object : undefined, params);\n  }\n\n  async stopTracing(): Promise<channels.BrowserStopTracingResult> {\n    if (!this._object.options.isChromium)\n      throw new Error(`Tracing is only available in Chromium`);\n    const crBrowser = this._object as CRBrowser;\n    return { artifact: ArtifactDispatcher.from(this, await crBrowser.stopTracing()) };\n  }\n\n  async cleanupContexts() {\n    await Promise.all(Array.from(this._contexts).map(context => context.close({ reason: 'Global context cleanup (connection terminated)' })));\n  }\n}\n\nasync function newContextForReuse(browser: Browser, scope: BrowserDispatcher, params: channels.BrowserNewContextForReuseParams, selectors: Selectors | null, metadata: CallMetadata): Promise<channels.BrowserNewContextForReuseResult> {\n  const { context, needsReset } = await browser.newContextForReuse(params, metadata);\n  if (needsReset) {\n    const oldContextDispatcher = existingDispatcher<BrowserContextDispatcher>(context);\n    if (oldContextDispatcher)\n      oldContextDispatcher._dispose();\n    await context.resetForReuse(metadata, params);\n  }\n  if (selectors)\n    context.setSelectors(selectors);\n  const contextDispatcher = new BrowserContextDispatcher(scope, context);\n  return { context: contextDispatcher };\n}\n"],"mappings":"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"}