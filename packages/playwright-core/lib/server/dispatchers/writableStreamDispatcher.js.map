{"version":3,"file":"writableStreamDispatcher.js","names":["_dispatcher","require","fs","_interopRequireWildcard","_utils","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","WritableStreamDispatcher","Dispatcher","constructor","scope","streamOrDirectory","lastModifiedMs","guid","createGuid","_type_WritableStream","_lastModifiedMs","write","params","_object","Error","stream","Promise","fulfill","reject","binary","error","close","end","promises","utimes","path","Date","exports"],"sources":["../../../src/server/dispatchers/writableStreamDispatcher.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\nimport { Dispatcher } from './dispatcher';\nimport * as fs from 'fs';\nimport { createGuid } from '../../utils';\nimport type { BrowserContextDispatcher } from './browserContextDispatcher';\n\nexport class WritableStreamDispatcher extends Dispatcher<{ guid: string, streamOrDirectory: fs.WriteStream | string }, channels.WritableStreamChannel, BrowserContextDispatcher> implements channels.WritableStreamChannel {\n  _type_WritableStream = true;\n  private _lastModifiedMs: number | undefined;\n\n  constructor(scope: BrowserContextDispatcher, streamOrDirectory: fs.WriteStream | string, lastModifiedMs?: number) {\n    super(scope, { guid: 'writableStream@' + createGuid(), streamOrDirectory }, 'WritableStream', {});\n    this._lastModifiedMs = lastModifiedMs;\n  }\n\n  async write(params: channels.WritableStreamWriteParams): Promise<channels.WritableStreamWriteResult> {\n    if (typeof this._object.streamOrDirectory === 'string')\n      throw new Error('Cannot write to a directory');\n    const stream = this._object.streamOrDirectory;\n    await new Promise<void>((fulfill, reject) => {\n      stream.write(params.binary, error => {\n        if (error)\n          reject(error);\n        else\n          fulfill();\n      });\n    });\n  }\n\n  async close() {\n    if (typeof this._object.streamOrDirectory === 'string')\n      throw new Error('Cannot close a directory');\n    const stream = this._object.streamOrDirectory;\n    await new Promise<void>(fulfill => stream.end(fulfill));\n    if (this._lastModifiedMs)\n      await fs.promises.utimes(this.path(), new Date(this._lastModifiedMs), new Date(this._lastModifiedMs));\n  }\n\n  path(): string {\n    if (typeof this._object.streamOrDirectory === 'string')\n      return this._object.streamOrDirectory;\n    return this._object.streamOrDirectory.path as string;\n  }\n}\n"],"mappings":"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"}