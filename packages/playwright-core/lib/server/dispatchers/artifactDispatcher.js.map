{"version":3,"file":"artifactDispatcher.js","names":["_dispatcher","require","_streamDispatcher","_fs","_interopRequireDefault","_fileUtils","obj","__esModule","default","ArtifactDispatcher","Dispatcher","from","parentScope","artifact","fromNullable","undefined","result","existingDispatcher","constructor","scope","absolutePath","localPath","_type_Artifact","pathAfterFinished","path","_object","localPathAfterFinished","value","saveAs","params","Promise","resolve","reject","error","mkdirIfNeeded","fs","promises","copyFile","e","saveAsStream","readable","createReadStream","highWaterMark","stream","StreamDispatcher","on","fileName","failure","failureError","cancel","delete","_","metadata","potentiallyClosesScope","_dispose","exports"],"sources":["../../../src/server/dispatchers/artifactDispatcher.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\nimport { Dispatcher, existingDispatcher } from './dispatcher';\nimport type { DispatcherScope } from './dispatcher';\nimport { StreamDispatcher } from './streamDispatcher';\nimport fs from 'fs';\nimport { mkdirIfNeeded } from '../../utils/fileUtils';\nimport type { Artifact } from '../artifact';\nimport type { CallMetadata } from '../instrumentation';\n\nexport class ArtifactDispatcher extends Dispatcher<Artifact, channels.ArtifactChannel, DispatcherScope> implements channels.ArtifactChannel {\n  _type_Artifact = true;\n\n  static from(parentScope: DispatcherScope, artifact: Artifact): ArtifactDispatcher {\n    return ArtifactDispatcher.fromNullable(parentScope, artifact)!;\n  }\n\n  static fromNullable(parentScope: DispatcherScope, artifact: Artifact): ArtifactDispatcher | undefined {\n    if (!artifact)\n      return undefined;\n    const result = existingDispatcher<ArtifactDispatcher>(artifact);\n    return result || new ArtifactDispatcher(parentScope, artifact);\n  }\n\n  private constructor(scope: DispatcherScope, artifact: Artifact) {\n    super(scope, artifact, 'Artifact', {\n      absolutePath: artifact.localPath(),\n    });\n  }\n\n  async pathAfterFinished(): Promise<channels.ArtifactPathAfterFinishedResult> {\n    const path = await this._object.localPathAfterFinished();\n    return { value: path };\n  }\n\n  async saveAs(params: channels.ArtifactSaveAsParams): Promise<channels.ArtifactSaveAsResult> {\n    return await new Promise((resolve, reject) => {\n      this._object.saveAs(async (localPath, error) => {\n        if (error) {\n          reject(error);\n          return;\n        }\n        try {\n          await mkdirIfNeeded(params.path);\n          await fs.promises.copyFile(localPath, params.path);\n          resolve();\n        } catch (e) {\n          reject(e);\n        }\n      });\n    });\n  }\n\n  async saveAsStream(): Promise<channels.ArtifactSaveAsStreamResult> {\n    return await new Promise((resolve, reject) => {\n      this._object.saveAs(async (localPath, error) => {\n        if (error) {\n          reject(error);\n          return;\n        }\n        try {\n          const readable = fs.createReadStream(localPath, { highWaterMark: 1024 * 1024 });\n          const stream = new StreamDispatcher(this, readable);\n          // Resolve with a stream, so that client starts saving the data.\n          resolve({ stream });\n          // Block the Artifact until the stream is consumed.\n          await new Promise<void>(resolve => {\n            readable.on('close', resolve);\n            readable.on('end', resolve);\n            readable.on('error', resolve);\n          });\n        } catch (e) {\n          reject(e);\n        }\n      });\n    });\n  }\n\n  async stream(): Promise<channels.ArtifactStreamResult> {\n    const fileName = await this._object.localPathAfterFinished();\n    const readable = fs.createReadStream(fileName, { highWaterMark: 1024 * 1024 });\n    return { stream: new StreamDispatcher(this, readable) };\n  }\n\n  async failure(): Promise<channels.ArtifactFailureResult> {\n    const error = await this._object.failureError();\n    return { error: error || undefined };\n  }\n\n  async cancel(): Promise<void> {\n    await this._object.cancel();\n  }\n\n  async delete(_: any, metadata: CallMetadata): Promise<void> {\n    metadata.potentiallyClosesScope = true;\n    await this._object.delete();\n    this._dispose();\n  }\n}\n"],"mappings":"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"}