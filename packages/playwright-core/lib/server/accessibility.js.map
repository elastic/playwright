{"version":3,"file":"accessibility.js","names":["Accessibility","constructor","getAXTree","_getAXTree","snapshot","options","interestingOnly","root","tree","needle","undefined","serializeTree","interestingNodes","Set","collectInterestingNodes","has","exports","collection","node","insideControl","isInteresting","add","isLeafNode","isControl","child","children","whitelistedNodes","push","serializedNode","serialize","length"],"sources":["../../src/server/accessibility.ts"],"sourcesContent":["/**\n * Copyright 2018 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as dom from './dom';\nimport type * as channels from '@protocol/channels';\n\nexport interface AXNode {\n    isInteresting(insideControl: boolean): boolean;\n    isLeafNode(): boolean;\n    isControl(): boolean;\n    serialize(): channels.AXNode;\n    children(): Iterable<AXNode>;\n}\n\nexport class Accessibility {\n  private _getAXTree:  (needle?: dom.ElementHandle) => Promise<{tree: AXNode, needle: AXNode | null}>;\n  constructor(getAXTree: (needle?: dom.ElementHandle) => Promise<{tree: AXNode, needle: AXNode | null}>) {\n    this._getAXTree = getAXTree;\n  }\n\n  async snapshot(options: {\n      interestingOnly?: boolean;\n      root?: dom.ElementHandle;\n    } = {}): Promise<channels.AXNode | null> {\n    const {\n      interestingOnly = true,\n      root = null,\n    } = options;\n    const { tree, needle } = await this._getAXTree(root || undefined);\n    if (!interestingOnly) {\n      if (root)\n        return needle && serializeTree(needle)[0];\n      return serializeTree(tree)[0];\n    }\n\n    const interestingNodes: Set<AXNode> = new Set();\n    collectInterestingNodes(interestingNodes, tree, false);\n    if (root && (!needle || !interestingNodes.has(needle)))\n      return null;\n    return serializeTree(needle || tree, interestingNodes)[0];\n  }\n}\n\nfunction collectInterestingNodes(collection: Set<AXNode>, node: AXNode, insideControl: boolean) {\n  if (node.isInteresting(insideControl))\n    collection.add(node);\n  if (node.isLeafNode())\n    return;\n  insideControl = insideControl || node.isControl();\n  for (const child of node.children())\n    collectInterestingNodes(collection, child, insideControl);\n}\n\nfunction serializeTree(node: AXNode, whitelistedNodes?: Set<AXNode>): channels.AXNode[] {\n  const children: channels.AXNode[] = [];\n  for (const child of node.children())\n    children.push(...serializeTree(child, whitelistedNodes));\n\n  if (whitelistedNodes && !whitelistedNodes.has(node))\n    return children;\n\n  const serializedNode = node.serialize();\n  if (children.length)\n    serializedNode.children = children;\n  return [serializedNode];\n}\n"],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAaO,MAAMA,aAAa,CAAC;EAEzBC,WAAWA,CAACC,SAAyF,EAAE;IAAA,KAD/FC,UAAU;IAEhB,IAAI,CAACA,UAAU,GAAGD,SAAS;EAC7B;EAEA,MAAME,QAAQA,CAACC,OAGZ,GAAG,CAAC,CAAC,EAAmC;IACzC,MAAM;MACJC,eAAe,GAAG,IAAI;MACtBC,IAAI,GAAG;IACT,CAAC,GAAGF,OAAO;IACX,MAAM;MAAEG,IAAI;MAAEC;IAAO,CAAC,GAAG,MAAM,IAAI,CAACN,UAAU,CAACI,IAAI,IAAIG,SAAS,CAAC;IACjE,IAAI,CAACJ,eAAe,EAAE;MACpB,IAAIC,IAAI,EACN,OAAOE,MAAM,IAAIE,aAAa,CAACF,MAAM,CAAC,CAAC,CAAC,CAAC;MAC3C,OAAOE,aAAa,CAACH,IAAI,CAAC,CAAC,CAAC,CAAC;IAC/B;IAEA,MAAMI,gBAA6B,GAAG,IAAIC,GAAG,CAAC,CAAC;IAC/CC,uBAAuB,CAACF,gBAAgB,EAAEJ,IAAI,EAAE,KAAK,CAAC;IACtD,IAAID,IAAI,KAAK,CAACE,MAAM,IAAI,CAACG,gBAAgB,CAACG,GAAG,CAACN,MAAM,CAAC,CAAC,EACpD,OAAO,IAAI;IACb,OAAOE,aAAa,CAACF,MAAM,IAAID,IAAI,EAAEI,gBAAgB,CAAC,CAAC,CAAC,CAAC;EAC3D;AACF;AAACI,OAAA,CAAAhB,aAAA,GAAAA,aAAA;AAED,SAASc,uBAAuBA,CAACG,UAAuB,EAAEC,IAAY,EAAEC,aAAsB,EAAE;EAC9F,IAAID,IAAI,CAACE,aAAa,CAACD,aAAa,CAAC,EACnCF,UAAU,CAACI,GAAG,CAACH,IAAI,CAAC;EACtB,IAAIA,IAAI,CAACI,UAAU,CAAC,CAAC,EACnB;EACFH,aAAa,GAAGA,aAAa,IAAID,IAAI,CAACK,SAAS,CAAC,CAAC;EACjD,KAAK,MAAMC,KAAK,IAAIN,IAAI,CAACO,QAAQ,CAAC,CAAC,EACjCX,uBAAuB,CAACG,UAAU,EAAEO,KAAK,EAAEL,aAAa,CAAC;AAC7D;AAEA,SAASR,aAAaA,CAACO,IAAY,EAAEQ,gBAA8B,EAAqB;EACtF,MAAMD,QAA2B,GAAG,EAAE;EACtC,KAAK,MAAMD,KAAK,IAAIN,IAAI,CAACO,QAAQ,CAAC,CAAC,EACjCA,QAAQ,CAACE,IAAI,CAAC,GAAGhB,aAAa,CAACa,KAAK,EAAEE,gBAAgB,CAAC,CAAC;EAE1D,IAAIA,gBAAgB,IAAI,CAACA,gBAAgB,CAACX,GAAG,CAACG,IAAI,CAAC,EACjD,OAAOO,QAAQ;EAEjB,MAAMG,cAAc,GAAGV,IAAI,CAACW,SAAS,CAAC,CAAC;EACvC,IAAIJ,QAAQ,CAACK,MAAM,EACjBF,cAAc,CAACH,QAAQ,GAAGA,QAAQ;EACpC,OAAO,CAACG,cAAc,CAAC;AACzB"}