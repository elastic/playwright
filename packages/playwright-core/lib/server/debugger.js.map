{"version":3,"file":"debugger.js","names":["_events","require","_utils","_browserContext","_debug","symbol","Symbol","Debugger","EventEmitter","constructor","context","_pauseOnNextStatement","_pausedCallsMetadata","Map","_enabled","_context","_muted","_slowMo","debugMode","pauseOnNextStatement","instrumentation","addListener","once","BrowserContext","Events","Close","removeListener","_browser","options","slowMo","setMuted","muted","onBeforeCall","sdkObject","metadata","shouldPauseOnCall","shouldPauseBeforeStep","pause","_doSlowMo","Promise","f","setTimeout","onAfterCall","shouldSlowMo","onBeforeInputAction","pauseStartTime","monotonicTime","result","resolve","set","emit","PausedStateChanged","resume","step","isPaused","endTime","pauseEndTime","clear","has","size","pausedDetails","push","exports","_sdkObject$attributio","attribution","playwright","isServer","browser","headful","isUnderTest","method","apiName","type","commandsWithTracingSnapshots","pausesBeforeInputActions","slowMoActions"],"sources":["../../src/server/debugger.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EventEmitter } from 'events';\nimport { debugMode, isUnderTest, monotonicTime } from '../utils';\nimport { BrowserContext } from './browserContext';\nimport type { CallMetadata, InstrumentationListener, SdkObject } from './instrumentation';\nimport { commandsWithTracingSnapshots, pausesBeforeInputActions, slowMoActions } from '../protocol/debug';\n\nconst symbol = Symbol('Debugger');\n\nexport class Debugger extends EventEmitter implements InstrumentationListener {\n  private _pauseOnNextStatement = false;\n  private _pausedCallsMetadata = new Map<CallMetadata, { resolve: () => void, sdkObject: SdkObject }>();\n  private _enabled: boolean;\n  private _context: BrowserContext;\n\n  static Events = {\n    PausedStateChanged: 'pausedstatechanged'\n  };\n  private _muted = false;\n  private _slowMo: number | undefined;\n\n  constructor(context: BrowserContext) {\n    super();\n    this._context = context;\n    (this._context as any)[symbol] = this;\n    this._enabled = debugMode() === 'inspector';\n    if (this._enabled)\n      this.pauseOnNextStatement();\n    context.instrumentation.addListener(this, context);\n    this._context.once(BrowserContext.Events.Close, () => {\n      this._context.instrumentation.removeListener(this);\n    });\n    this._slowMo = this._context._browser.options.slowMo;\n  }\n\n  async setMuted(muted: boolean) {\n    this._muted = muted;\n  }\n\n  async onBeforeCall(sdkObject: SdkObject, metadata: CallMetadata): Promise<void> {\n    if (this._muted)\n      return;\n    if (shouldPauseOnCall(sdkObject, metadata) || (this._pauseOnNextStatement && shouldPauseBeforeStep(metadata)))\n      await this.pause(sdkObject, metadata);\n  }\n\n  async _doSlowMo() {\n    await new Promise(f => setTimeout(f, this._slowMo));\n  }\n\n  async onAfterCall(sdkObject: SdkObject, metadata: CallMetadata): Promise<void> {\n    if (this._slowMo && shouldSlowMo(metadata))\n      await this._doSlowMo();\n  }\n\n  async onBeforeInputAction(sdkObject: SdkObject, metadata: CallMetadata): Promise<void> {\n    if (this._muted)\n      return;\n    if (this._enabled && this._pauseOnNextStatement)\n      await this.pause(sdkObject, metadata);\n  }\n\n  async pause(sdkObject: SdkObject, metadata: CallMetadata) {\n    if (this._muted)\n      return;\n    this._enabled = true;\n    metadata.pauseStartTime = monotonicTime();\n    const result = new Promise<void>(resolve => {\n      this._pausedCallsMetadata.set(metadata, { resolve, sdkObject });\n    });\n    this.emit(Debugger.Events.PausedStateChanged);\n    return result;\n  }\n\n  resume(step: boolean) {\n    if (!this.isPaused())\n      return;\n\n    this._pauseOnNextStatement = step;\n    const endTime = monotonicTime();\n    for (const [metadata, { resolve }] of this._pausedCallsMetadata) {\n      metadata.pauseEndTime = endTime;\n      resolve();\n    }\n    this._pausedCallsMetadata.clear();\n    this.emit(Debugger.Events.PausedStateChanged);\n  }\n\n  pauseOnNextStatement() {\n    this._pauseOnNextStatement = true;\n  }\n\n  isPaused(metadata?: CallMetadata): boolean {\n    if (metadata)\n      return this._pausedCallsMetadata.has(metadata);\n    return !!this._pausedCallsMetadata.size;\n  }\n\n  pausedDetails(): { metadata: CallMetadata, sdkObject: SdkObject }[] {\n    const result: { metadata: CallMetadata, sdkObject: SdkObject }[] = [];\n    for (const [metadata, { sdkObject }] of this._pausedCallsMetadata)\n      result.push({ metadata, sdkObject });\n    return result;\n  }\n}\n\nfunction shouldPauseOnCall(sdkObject: SdkObject, metadata: CallMetadata): boolean {\n  if (sdkObject.attribution.playwright.options.isServer)\n    return false;\n  if (!sdkObject.attribution.browser?.options.headful && !isUnderTest())\n    return false;\n  return metadata.method === 'pause';\n}\n\nfunction shouldPauseBeforeStep(metadata: CallMetadata): boolean {\n  // Don't stop on internal.\n  if (!metadata.apiName)\n    return false;\n  // Always stop on 'close'\n  if (metadata.method === 'close')\n    return true;\n  if (metadata.method === 'waitForSelector' || metadata.method === 'waitForEventInfo')\n    return false;  // Never stop on those, primarily for the test harness.\n  const step = metadata.type + '.' + metadata.method;\n  // Stop before everything that generates snapshot. But don't stop before those marked as pausesBeforeInputActions\n  // since we stop in them on a separate instrumentation signal.\n  return commandsWithTracingSnapshots.has(step) && !pausesBeforeInputActions.has(metadata.type + '.' + metadata.method);\n}\n\nexport function shouldSlowMo(metadata: CallMetadata): boolean {\n  return slowMoActions.has(metadata.type + '.' + metadata.method);\n}\n"],"mappings":"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"}