{"version":3,"file":"browserType.js","names":["_fs","_interopRequireDefault","require","os","_interopRequireWildcard","_path","_browserContext","_registry","_transport","_processLauncher","_pipeTransport","_progress","_timeoutSettings","_utils","_fileUtils","_helper","_debugLogger","_instrumentation","_protocolError","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","obj","kNoXServerRunningError","exports","BrowserType","SdkObject","constructor","parent","browserName","_name","_useBidi","attribution","browserType","executablePath","registry","findExecutable","playwright","options","sdkLanguage","name","launch","metadata","protocolLogger","_validateLaunchOptions","useWebSocket","controller","ProgressController","setLogName","browser","run","progress","seleniumHubUrl","__testHookSeleniumRemoteURL","process","env","SELENIUM_REMOTE_URL","_launchWithSeleniumHub","_innerLaunchWithRetries","undefined","helper","debugProtocolLogger","catch","_rewriteStartupLog","TimeoutSettings","launchTimeout","launchPersistentContext","userDataDir","persistent","clientCertificatesProxy","createClientCertificatesProxyIfNeeded","proxy","cleanupWhenAborted","close","_defaultContext","_clientCertificatesProxy","_innerLaunch","error","errorMessage","message","includes","log","maybeUserDataDir","normalizeProxySettings","browserLogsCollector","RecentLogsCollector","browserProcess","artifactsDir","transport","_launchProcess","__testHookBeforeCreateBrowser","browserOptions","isChromium","channel","slowMo","headful","headless","downloadsPath","tracesDir","customExecutablePath","wsEndpoint","originalLaunchOptions","validateBrowserContextOptions","copyTestHooks","connectToTransport","_userDataDirForTest","ignoreAllDefaultArgs","_loadDefaultContext","isPersistent","_await$readyState$wai","ignoreDefaultArgs","args","handleSIGINT","handleSIGTERM","handleSIGHUP","envArrayToObject","_createArtifactDirs","tempDirectories","fs","promises","mkdtemp","path","join","tmpdir","push","existsAsync","mkdir","recursive","mode","browserArguments","defaultArgs","filter","arg","indexOf","executable","Error","registryExecutable","executablePathOrDie","validateHostRequirementsForExecutablesIfNeeded","readyState","launchedProcess","gracefullyClose","kill","launchProcess","command","amendEnvironment","onBrowserOutput","stdio","attemptToGracefullyClose","__testHookGracefullyClose","attemptToGracefullyCloseBrowser","onExit","exitCode","signal","onBrowserExit","onclose","closeOrKill","timeout","timer","Promise","race","resolve","reject","setTimeout","ignored","clearTimeout","__testHookBrowserCloseTimeout","DEFAULT_TIMEOUT","timeUntilDeadline","waitUntilReady","WebSocketTransport","connect","PipeTransport","connectOverCDP","endpointURL","hubUrl","devtools","debugMode","isAbsolute","cwd","socksProxyPort","server","_createUserDataDirArgMisuseError","userDataDirArg","isProtocolError","doRewriteStartupLog","from","to","key","value","entries","startsWith"],"sources":["../../src/server/browserType.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport * as os from 'os';\nimport path from 'path';\nimport type { BrowserContext } from './browserContext';\nimport { createClientCertificatesProxyIfNeeded, normalizeProxySettings, validateBrowserContextOptions } from './browserContext';\nimport type { BrowserName } from './registry';\nimport { registry } from './registry';\nimport type { ConnectionTransport } from './transport';\nimport { WebSocketTransport } from './transport';\nimport type { BrowserOptions, Browser, BrowserProcess } from './browser';\nimport type { Env } from '../utils/processLauncher';\nimport { launchProcess, envArrayToObject } from '../utils/processLauncher';\nimport { PipeTransport } from './pipeTransport';\nimport type { Progress } from './progress';\nimport { ProgressController } from './progress';\nimport type * as types from './types';\nimport type * as channels from '@protocol/channels';\nimport { DEFAULT_TIMEOUT, TimeoutSettings } from '../common/timeoutSettings';\nimport { debugMode } from '../utils';\nimport { existsAsync } from '../utils/fileUtils';\nimport { helper } from './helper';\nimport { RecentLogsCollector } from '../utils/debugLogger';\nimport type { CallMetadata } from './instrumentation';\nimport { SdkObject } from './instrumentation';\nimport { type ProtocolError, isProtocolError } from './protocolError';\n\nexport const kNoXServerRunningError = 'Looks like you launched a headed browser without having a XServer running.\\n' +\n  'Set either \\'headless: true\\' or use \\'xvfb-run <your-playwright-app>\\' before running Playwright.\\n\\n<3 Playwright Team';\n\n\nexport interface BrowserReadyState {\n  onBrowserOutput(message: string): void;\n  onBrowserExit(): void;\n  waitUntilReady(): Promise<{ wsEndpoint?: string }>;\n}\n\nexport abstract class BrowserType extends SdkObject {\n  private _name: BrowserName;\n  _useBidi: boolean = false;\n\n  constructor(parent: SdkObject, browserName: BrowserName) {\n    super(parent, 'browser-type');\n    this.attribution.browserType = this;\n    this._name = browserName;\n  }\n\n  executablePath(): string {\n    return registry.findExecutable(this._name).executablePath(this.attribution.playwright.options.sdkLanguage) || '';\n  }\n\n  name(): string {\n    return this._name;\n  }\n\n  async launch(metadata: CallMetadata, options: types.LaunchOptions, protocolLogger?: types.ProtocolLogger): Promise<Browser> {\n    options = this._validateLaunchOptions(options);\n    if (this._useBidi)\n      options.useWebSocket = true;\n    const controller = new ProgressController(metadata, this);\n    controller.setLogName('browser');\n    const browser = await controller.run(progress => {\n      const seleniumHubUrl = (options as any).__testHookSeleniumRemoteURL || process.env.SELENIUM_REMOTE_URL;\n      if (seleniumHubUrl)\n        return this._launchWithSeleniumHub(progress, seleniumHubUrl, options);\n      return this._innerLaunchWithRetries(progress, options, undefined, helper.debugProtocolLogger(protocolLogger)).catch(e => { throw this._rewriteStartupLog(e); });\n    }, TimeoutSettings.launchTimeout(options));\n    return browser;\n  }\n\n  async launchPersistentContext(metadata: CallMetadata, userDataDir: string, options: channels.BrowserTypeLaunchPersistentContextOptions & { useWebSocket?: boolean }): Promise<BrowserContext> {\n    options = this._validateLaunchOptions(options);\n    if (this._useBidi)\n      options.useWebSocket = true;\n    const controller = new ProgressController(metadata, this);\n    const persistent: channels.BrowserNewContextParams = { ...options };\n    controller.setLogName('browser');\n    const browser = await controller.run(async progress => {\n      // Note: Any initial TLS requests will fail since we rely on the Page/Frames initialize which sets ignoreHTTPSErrors.\n      const clientCertificatesProxy = await createClientCertificatesProxyIfNeeded(persistent);\n      if (clientCertificatesProxy)\n        options.proxy = persistent.proxy;\n      progress.cleanupWhenAborted(() => clientCertificatesProxy?.close());\n      const browser = await this._innerLaunchWithRetries(progress, options, persistent, helper.debugProtocolLogger(), userDataDir).catch(e => { throw this._rewriteStartupLog(e); });\n      browser._defaultContext!._clientCertificatesProxy = clientCertificatesProxy;\n      return browser;\n    }, TimeoutSettings.launchTimeout(options));\n    return browser._defaultContext!;\n  }\n\n  async _innerLaunchWithRetries(progress: Progress, options: types.LaunchOptions, persistent: channels.BrowserNewContextParams | undefined, protocolLogger: types.ProtocolLogger, userDataDir?: string): Promise<Browser> {\n    try {\n      return await this._innerLaunch(progress, options, persistent, protocolLogger, userDataDir);\n    } catch (error) {\n      // @see https://github.com/microsoft/playwright/issues/5214\n      const errorMessage = typeof error === 'object' && typeof error.message === 'string' ? error.message : '';\n      if (errorMessage.includes('Inconsistency detected by ld.so')) {\n        progress.log(`<restarting browser due to hitting race condition in glibc>`);\n        return this._innerLaunch(progress, options, persistent, protocolLogger, userDataDir);\n      }\n      throw error;\n    }\n  }\n\n  async _innerLaunch(progress: Progress, options: types.LaunchOptions, persistent: channels.BrowserNewContextParams | undefined, protocolLogger: types.ProtocolLogger, maybeUserDataDir?: string): Promise<Browser> {\n    options.proxy = options.proxy ? normalizeProxySettings(options.proxy) : undefined;\n    const browserLogsCollector = new RecentLogsCollector();\n    const { browserProcess, userDataDir, artifactsDir, transport } = await this._launchProcess(progress, options, !!persistent, browserLogsCollector, maybeUserDataDir);\n    if ((options as any).__testHookBeforeCreateBrowser)\n      await (options as any).__testHookBeforeCreateBrowser();\n    const browserOptions: BrowserOptions = {\n      name: this._name,\n      isChromium: this._name === 'chromium',\n      channel: options.channel,\n      slowMo: options.slowMo,\n      persistent,\n      headful: !options.headless,\n      artifactsDir,\n      downloadsPath: (options.downloadsPath || artifactsDir)!,\n      tracesDir: (options.tracesDir || artifactsDir)!,\n      browserProcess,\n      customExecutablePath: options.executablePath,\n      proxy: options.proxy,\n      protocolLogger,\n      browserLogsCollector,\n      wsEndpoint: options.useWebSocket ? (transport as WebSocketTransport).wsEndpoint : undefined,\n      originalLaunchOptions: options,\n    };\n    if (persistent)\n      validateBrowserContextOptions(persistent, browserOptions);\n    copyTestHooks(options, browserOptions);\n    const browser = await this.connectToTransport(transport, browserOptions);\n    (browser as any)._userDataDirForTest = userDataDir;\n    // We assume no control when using custom arguments, and do not prepare the default context in that case.\n    if (persistent && !options.ignoreAllDefaultArgs)\n      await browser._defaultContext!._loadDefaultContext(progress);\n    return browser;\n  }\n\n  private async _launchProcess(progress: Progress, options: types.LaunchOptions, isPersistent: boolean, browserLogsCollector: RecentLogsCollector, userDataDir?: string): Promise<{ browserProcess: BrowserProcess, artifactsDir: string, userDataDir: string, transport: ConnectionTransport }> {\n    const {\n      ignoreDefaultArgs,\n      ignoreAllDefaultArgs,\n      args = [],\n      executablePath = null,\n      handleSIGINT = true,\n      handleSIGTERM = true,\n      handleSIGHUP = true,\n    } = options;\n\n    const env = options.env ? envArrayToObject(options.env) : process.env;\n\n    await this._createArtifactDirs(options);\n\n    const tempDirectories = [];\n    const artifactsDir = await fs.promises.mkdtemp(path.join(os.tmpdir(), 'playwright-artifacts-'));\n    tempDirectories.push(artifactsDir);\n\n    if (userDataDir) {\n      // Firefox bails if the profile directory does not exist, Chrome creates it. We ensure consistent behavior here.\n      if (!await existsAsync(userDataDir))\n        await fs.promises.mkdir(userDataDir, { recursive: true, mode: 0o700 });\n    } else {\n      userDataDir = await fs.promises.mkdtemp(path.join(os.tmpdir(), `playwright_${this._name}dev_profile-`));\n      tempDirectories.push(userDataDir);\n    }\n\n    const browserArguments = [];\n    if (ignoreAllDefaultArgs)\n      browserArguments.push(...args);\n    else if (ignoreDefaultArgs)\n      browserArguments.push(...this.defaultArgs(options, isPersistent, userDataDir).filter(arg => ignoreDefaultArgs.indexOf(arg) === -1));\n    else\n      browserArguments.push(...this.defaultArgs(options, isPersistent, userDataDir));\n\n    let executable: string;\n    if (executablePath) {\n      if (!(await existsAsync(executablePath)))\n        throw new Error(`Failed to launch ${this._name} because executable doesn't exist at ${executablePath}`);\n      executable = executablePath;\n    } else {\n      const registryExecutable = registry.findExecutable(options.channel || this._name);\n      if (!registryExecutable || registryExecutable.browserName !== this._name)\n        throw new Error(`Unsupported ${this._name} channel \"${options.channel}\"`);\n      executable = registryExecutable.executablePathOrDie(this.attribution.playwright.options.sdkLanguage);\n      await registry.validateHostRequirementsForExecutablesIfNeeded([registryExecutable], this.attribution.playwright.options.sdkLanguage);\n    }\n\n    const readyState = this.readyState(options);\n    // Note: it is important to define these variables before launchProcess, so that we don't get\n    // \"Cannot access 'browserServer' before initialization\" if something went wrong.\n    let transport: ConnectionTransport | undefined = undefined;\n    let browserProcess: BrowserProcess | undefined = undefined;\n    const { launchedProcess, gracefullyClose, kill } = await launchProcess({\n      command: executable,\n      args: browserArguments,\n      env: this.amendEnvironment(env, userDataDir, executable, browserArguments),\n      handleSIGINT,\n      handleSIGTERM,\n      handleSIGHUP,\n      log: (message: string) => {\n        readyState?.onBrowserOutput(message);\n        progress.log(message);\n        browserLogsCollector.log(message);\n      },\n      stdio: 'pipe',\n      tempDirectories,\n      attemptToGracefullyClose: async () => {\n        if ((options as any).__testHookGracefullyClose)\n          await (options as any).__testHookGracefullyClose();\n        // We try to gracefully close to prevent crash reporting and core dumps.\n        // Note that it's fine to reuse the pipe transport, since\n        // our connection ignores kBrowserCloseMessageId.\n        this.attemptToGracefullyCloseBrowser(transport!);\n      },\n      onExit: (exitCode, signal) => {\n        // Unblock launch when browser prematurely exits.\n        readyState?.onBrowserExit();\n        if (browserProcess && browserProcess.onclose)\n          browserProcess.onclose(exitCode, signal);\n      },\n    });\n    async function closeOrKill(timeout: number): Promise<void> {\n      let timer: NodeJS.Timeout;\n      try {\n        await Promise.race([\n          gracefullyClose(),\n          new Promise((resolve, reject) => timer = setTimeout(reject, timeout)),\n        ]);\n      } catch (ignored) {\n        await kill().catch(ignored => {}); // Make sure to await actual process exit.\n      } finally {\n        clearTimeout(timer!);\n      }\n    }\n    browserProcess = {\n      onclose: undefined,\n      process: launchedProcess,\n      close: () => closeOrKill((options as any).__testHookBrowserCloseTimeout || DEFAULT_TIMEOUT),\n      kill\n    };\n    progress.cleanupWhenAborted(() => closeOrKill(progress.timeUntilDeadline()));\n    const wsEndpoint = (await readyState?.waitUntilReady())?.wsEndpoint;\n    if (options.useWebSocket) {\n      transport = await WebSocketTransport.connect(progress, wsEndpoint!);\n    } else {\n      const stdio = launchedProcess.stdio as unknown as [NodeJS.ReadableStream, NodeJS.WritableStream, NodeJS.WritableStream, NodeJS.WritableStream, NodeJS.ReadableStream];\n      transport = new PipeTransport(stdio[3], stdio[4]);\n    }\n    return { browserProcess, artifactsDir, userDataDir, transport };\n  }\n\n  async _createArtifactDirs(options: types.LaunchOptions): Promise<void> {\n    if (options.downloadsPath)\n      await fs.promises.mkdir(options.downloadsPath, { recursive: true });\n    if (options.tracesDir)\n      await fs.promises.mkdir(options.tracesDir, { recursive: true });\n  }\n\n  async connectOverCDP(metadata: CallMetadata, endpointURL: string, options: { slowMo?: number }, timeout?: number): Promise<Browser> {\n    throw new Error('CDP connections are only supported by Chromium');\n  }\n\n  async _launchWithSeleniumHub(progress: Progress, hubUrl: string, options: types.LaunchOptions): Promise<Browser> {\n    throw new Error('Connecting to SELENIUM_REMOTE_URL is only supported by Chromium');\n  }\n\n  private _validateLaunchOptions<Options extends types.LaunchOptions>(options: Options): Options {\n    const { devtools = false } = options;\n    let { headless = !devtools, downloadsPath, proxy } = options;\n    if (debugMode())\n      headless = false;\n    if (downloadsPath && !path.isAbsolute(downloadsPath))\n      downloadsPath = path.join(process.cwd(), downloadsPath);\n    if (this.attribution.playwright.options.socksProxyPort)\n      proxy = { server: `socks5://127.0.0.1:${this.attribution.playwright.options.socksProxyPort}` };\n    return { ...options, devtools, headless, downloadsPath, proxy };\n  }\n\n  protected _createUserDataDirArgMisuseError(userDataDirArg: string): Error {\n    switch (this.attribution.playwright.options.sdkLanguage) {\n      case 'java':\n        return new Error(`Pass userDataDir parameter to 'BrowserType.launchPersistentContext(userDataDir, options)' instead of specifying '${userDataDirArg}' argument`);\n      case 'python':\n        return new Error(`Pass user_data_dir parameter to 'browser_type.launch_persistent_context(user_data_dir, **kwargs)' instead of specifying '${userDataDirArg}' argument`);\n      case 'csharp':\n        return new Error(`Pass userDataDir parameter to 'BrowserType.LaunchPersistentContextAsync(userDataDir, options)' instead of specifying '${userDataDirArg}' argument`);\n      default:\n        return new Error(`Pass userDataDir parameter to 'browserType.launchPersistentContext(userDataDir, options)' instead of specifying '${userDataDirArg}' argument`);\n    }\n  }\n\n  _rewriteStartupLog(error: Error): Error {\n    if (!isProtocolError(error))\n      return error;\n    return this.doRewriteStartupLog(error);\n  }\n\n  readyState(options: types.LaunchOptions): BrowserReadyState|undefined {\n    return undefined;\n  }\n\n  abstract defaultArgs(options: types.LaunchOptions, isPersistent: boolean, userDataDir: string): string[];\n  abstract connectToTransport(transport: ConnectionTransport, options: BrowserOptions): Promise<Browser>;\n  abstract amendEnvironment(env: Env, userDataDir: string, executable: string, browserArguments: string[]): Env;\n  abstract doRewriteStartupLog(error: ProtocolError): ProtocolError;\n  abstract attemptToGracefullyCloseBrowser(transport: ConnectionTransport): void;\n}\n\nfunction copyTestHooks(from: object, to: object) {\n  for (const [key, value] of Object.entries(from)) {\n    if (key.startsWith('__testHook'))\n      (to as any)[key] = value;\n  }\n}\n"],"mappings":"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"}