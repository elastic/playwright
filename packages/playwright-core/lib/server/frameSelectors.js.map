{"version":3,"file":"frameSelectors.js","names":["_selectorParser","require","_utils","FrameSelectors","constructor","frame","_parseSelector","selector","options","strict","_page","context","_options","strictSelectors","selectors","parseSelector","query","scope","resolved","resolveInjectedForSelector","handle","injected","evaluateHandle","info","querySelector","parsed","document","elementHandle","asElement","dispose","adoptIfNeeded","_mainContext","queryArrayInMainWorld","mainWorld","Error","querySelectorAll","queryCount","evaluate","length","queryAll","arrayHandle","properties","getProperties","targetContext","result","property","values","push","Promise","all","resolveFrameForSelector","frameChunks","splitSelectorByFrame","chunk","visitAllSelectorParts","part","nested","name","body","locator","asLocator","attribution","playwright","sdkLanguage","InvalidSelectorError","i","_context","world","injectedScript","selectorString","element","nodeName","createStacklessError","previewNode","undefined","stringifySelector","maybeFrame","_delegate","getContentFrame","exports","adopted","adoptElementHandle"],"sources":["../../src/server/frameSelectors.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { Frame } from './frames';\nimport type * as types from './types';\nimport { stringifySelector, type ParsedSelector, splitSelectorByFrame, InvalidSelectorError, visitAllSelectorParts } from '../utils/isomorphic/selectorParser';\nimport type { FrameExecutionContext, ElementHandle } from './dom';\nimport type { JSHandle } from './javascript';\nimport type { InjectedScript } from './injected/injectedScript';\nimport { asLocator } from '../utils';\n\nexport type SelectorInfo = {\n  parsed: ParsedSelector,\n  world: types.World,\n  strict: boolean,\n};\n\nexport type SelectorInFrame = {\n  frame: Frame;\n  info: SelectorInfo;\n  scope?: ElementHandle;\n};\n\nexport class FrameSelectors {\n  readonly frame: Frame;\n\n  constructor(frame: Frame) {\n    this.frame = frame;\n  }\n\n  private _parseSelector(selector: string | ParsedSelector, options?: types.StrictOptions): SelectorInfo {\n    const strict = typeof options?.strict === 'boolean' ? options.strict : !!this.frame._page.context()._options.strictSelectors;\n    return this.frame._page.context().selectors().parseSelector(selector, strict);\n  }\n\n  async query(selector: string, options?: types.StrictOptions, scope?: ElementHandle): Promise<ElementHandle<Element> | null> {\n    const resolved = await this.resolveInjectedForSelector(selector, options, scope);\n    // Be careful, |this.frame| can be different from |resolved.frame|.\n    if (!resolved)\n      return null;\n    const handle = await resolved.injected.evaluateHandle((injected, { info, scope }) => {\n      return injected.querySelector(info.parsed, scope || document, info.strict);\n    }, { info: resolved.info, scope: resolved.scope });\n    const elementHandle = handle.asElement() as ElementHandle<Element> | null;\n    if (!elementHandle) {\n      handle.dispose();\n      return null;\n    }\n    return adoptIfNeeded(elementHandle, await resolved.frame._mainContext());\n  }\n\n  async queryArrayInMainWorld(selector: string, scope?: ElementHandle): Promise<JSHandle<Element[]>> {\n    const resolved = await this.resolveInjectedForSelector(selector, { mainWorld: true }, scope);\n    // Be careful, |this.frame| can be different from |resolved.frame|.\n    if (!resolved)\n      throw new Error(`Failed to find frame for selector \"${selector}\"`);\n    return await resolved.injected.evaluateHandle((injected, { info, scope }) => {\n      return injected.querySelectorAll(info.parsed, scope || document);\n    }, { info: resolved.info, scope: resolved.scope });\n  }\n\n  async queryCount(selector: string): Promise<number> {\n    const resolved = await this.resolveInjectedForSelector(selector);\n    // Be careful, |this.frame| can be different from |resolved.frame|.\n    if (!resolved)\n      throw new Error(`Failed to find frame for selector \"${selector}\"`);\n    return await resolved.injected.evaluate((injected, { info }) => {\n      return injected.querySelectorAll(info.parsed, document).length;\n    }, { info: resolved.info });\n  }\n\n  async queryAll(selector: string, scope?: ElementHandle): Promise<ElementHandle<Element>[]> {\n    const resolved = await this.resolveInjectedForSelector(selector, {}, scope);\n    // Be careful, |this.frame| can be different from |resolved.frame|.\n    if (!resolved)\n      return [];\n    const arrayHandle = await resolved.injected.evaluateHandle((injected, { info, scope }) => {\n      return injected.querySelectorAll(info.parsed, scope || document);\n    }, { info: resolved.info, scope: resolved.scope });\n\n    const properties = await arrayHandle.getProperties();\n    arrayHandle.dispose();\n\n    // Note: adopting elements one by one may be slow. If we encounter the issue here,\n    // we might introduce 'useMainContext' option or similar to speed things up.\n    const targetContext = await resolved.frame._mainContext();\n    const result: Promise<ElementHandle<Element>>[] = [];\n    for (const property of properties.values()) {\n      const elementHandle = property.asElement() as ElementHandle<Element>;\n      if (elementHandle)\n        result.push(adoptIfNeeded(elementHandle, targetContext));\n      else\n        property.dispose();\n    }\n    return Promise.all(result);\n  }\n\n  async resolveFrameForSelector(selector: string, options: types.StrictOptions = {}, scope?: ElementHandle): Promise<SelectorInFrame | null> {\n    let frame: Frame = this.frame;\n    const frameChunks = splitSelectorByFrame(selector);\n\n    for (const chunk of frameChunks) {\n      visitAllSelectorParts(chunk, (part, nested) => {\n        if (nested && part.name === 'internal:control' && part.body === 'enter-frame') {\n          const locator = asLocator(this.frame._page.attribution.playwright.options.sdkLanguage, selector);\n          throw new InvalidSelectorError(`Frame locators are not allowed inside composite locators, while querying \"${locator}\"`);\n        }\n      });\n    }\n\n    for (let i = 0; i < frameChunks.length - 1; ++i) {\n      const info = this._parseSelector(frameChunks[i], options);\n      const context = await frame._context(info.world);\n      const injectedScript = await context.injectedScript();\n      const handle = await injectedScript.evaluateHandle((injected, { info, scope, selectorString }) => {\n        const element = injected.querySelector(info.parsed, scope || document, info.strict);\n        if (element && element.nodeName !== 'IFRAME' && element.nodeName !== 'FRAME')\n          throw injected.createStacklessError(`Selector \"${selectorString}\" resolved to ${injected.previewNode(element)}, <iframe> was expected`);\n        return element;\n      }, { info, scope: i === 0 ? scope : undefined, selectorString: stringifySelector(info.parsed) });\n      const element = handle.asElement() as ElementHandle<Element> | null;\n      if (!element)\n        return null;\n      const maybeFrame = await frame._page._delegate.getContentFrame(element);\n      element.dispose();\n      if (!maybeFrame)\n        return null;\n      frame = maybeFrame;\n    }\n    // If we end up in the different frame, we should start from the frame root, so throw away the scope.\n    if (frame !== this.frame)\n      scope = undefined;\n    return { frame, info: frame.selectors._parseSelector(frameChunks[frameChunks.length - 1], options), scope };\n  }\n\n  async resolveInjectedForSelector(selector: string, options?: { strict?: boolean, mainWorld?: boolean }, scope?: ElementHandle): Promise<{ injected: JSHandle<InjectedScript>, info: SelectorInfo, frame: Frame, scope?: ElementHandle } | undefined> {\n    const resolved = await this.resolveFrameForSelector(selector, options, scope);\n    // Be careful, |this.frame| can be different from |resolved.frame|.\n    if (!resolved)\n      return;\n    const context = await resolved.frame._context(options?.mainWorld ? 'main' : resolved.info.world);\n    const injected = await context.injectedScript();\n    return { injected, info: resolved.info, frame: resolved.frame, scope: resolved.scope };\n  }\n}\n\nasync function adoptIfNeeded<T extends Node>(handle: ElementHandle<T>, context: FrameExecutionContext): Promise<ElementHandle<T>> {\n  if (handle._context === context)\n    return handle;\n  const adopted = handle._page._delegate.adoptElementHandle(handle, context);\n  handle.dispose();\n  return adopted;\n}\n"],"mappings":"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"}