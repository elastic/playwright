{"version":3,"file":"socksInterceptor.js","names":["socks","_interopRequireWildcard","require","_events","_interopRequireDefault","_validator","obj","__esModule","default","_getRequireWildcardCache","e","WeakMap","r","t","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","SocksInterceptor","constructor","transport","pattern","redirectPortForTest","_handler","_channel","_socksSupportObjectGuid","_ids","Set","SocksProxyHandler","lastId","Proxy","EventEmitter","prop","undefined","params","id","add","validator","findValidator","tChannelImpl","tChannelForSocks","binary","send","guid","method","metadata","stack","apiName","internal","on","Events","SocksConnected","payload","socksConnected","SocksData","socksData","SocksError","socksError","SocksFailed","socksFailed","SocksEnd","socksEnd","socketRequested","socketClosed","sendSocketData","cleanup","interceptMessage","message","delete","type","emit","exports","names","arg","path","context","ValidationError"],"sources":["../../src/server/socksInterceptor.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as socks from '../common/socksProxy';\nimport EventEmitter from 'events';\nimport type * as channels from '@protocol/channels';\nimport type { WebSocketTransport } from './transport';\nimport { findValidator, ValidationError } from '../protocol/validator';\nimport type { ValidatorContext } from '../protocol/validator';\n\nexport class SocksInterceptor {\n  private _handler: socks.SocksProxyHandler;\n  private _channel: channels.SocksSupportChannel & EventEmitter;\n  private _socksSupportObjectGuid?: string;\n  private _ids = new Set<number>();\n\n  constructor(transport: WebSocketTransport, pattern: string | undefined, redirectPortForTest: number | undefined) {\n    this._handler = new socks.SocksProxyHandler(pattern,  redirectPortForTest);\n\n    let lastId = -1;\n    this._channel = new Proxy(new EventEmitter(), {\n      get: (obj: any, prop: string | symbol) => {\n        if ((prop in obj) || obj[prop] !== undefined || typeof prop !== 'string')\n          return obj[prop];\n        return (params: any) => {\n          try {\n            const id = --lastId;\n            this._ids.add(id);\n            const validator = findValidator('SocksSupport', prop, 'Params');\n            params = validator(params, '', { tChannelImpl: tChannelForSocks, binary: 'toBase64' });\n            transport.send({ id, guid: this._socksSupportObjectGuid, method: prop, params, metadata: { stack: [], apiName: '', internal: true } } as any);\n          } catch (e) {\n          }\n        };\n      },\n    }) as channels.SocksSupportChannel & EventEmitter;\n    this._handler.on(socks.SocksProxyHandler.Events.SocksConnected, (payload: socks.SocksSocketConnectedPayload) => this._channel.socksConnected(payload));\n    this._handler.on(socks.SocksProxyHandler.Events.SocksData, (payload: socks.SocksSocketDataPayload) => this._channel.socksData(payload));\n    this._handler.on(socks.SocksProxyHandler.Events.SocksError, (payload: socks.SocksSocketErrorPayload) => this._channel.socksError(payload));\n    this._handler.on(socks.SocksProxyHandler.Events.SocksFailed, (payload: socks.SocksSocketFailedPayload) => this._channel.socksFailed(payload));\n    this._handler.on(socks.SocksProxyHandler.Events.SocksEnd, (payload: socks.SocksSocketEndPayload) => this._channel.socksEnd(payload));\n    this._channel.on('socksRequested', payload => this._handler.socketRequested(payload));\n    this._channel.on('socksClosed', payload => this._handler.socketClosed(payload));\n    this._channel.on('socksData', payload => this._handler.sendSocketData(payload));\n  }\n\n  cleanup() {\n    this._handler.cleanup();\n  }\n\n  interceptMessage(message: any): boolean {\n    if (this._ids.has(message.id)) {\n      this._ids.delete(message.id);\n      return true;\n    }\n    if (message.method === '__create__' && message.params.type === 'SocksSupport') {\n      this._socksSupportObjectGuid = message.params.guid;\n      return false;\n    }\n    if (this._socksSupportObjectGuid && message.guid === this._socksSupportObjectGuid) {\n      const validator = findValidator('SocksSupport', message.method, 'Event');\n      const params = validator(message.params, '', { tChannelImpl: tChannelForSocks, binary: 'fromBase64' });\n      this._channel.emit(message.method, params);\n      return true;\n    }\n    return false;\n  }\n}\n\nfunction tChannelForSocks(names: '*' | string[], arg: any, path: string, context: ValidatorContext) {\n  throw new ValidationError(`${path}: channels are not expected in SocksSupport`);\n}\n\n"],"mappings":";;;;;;AAgBA,IAAAA,KAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,OAAA,GAAAC,sBAAA,CAAAF,OAAA;AAGA,IAAAG,UAAA,GAAAH,OAAA;AAAuE,SAAAE,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAAA,SAAAG,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAT,wBAAAS,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAH,UAAA,SAAAG,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAF,OAAA,EAAAE,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAC,GAAA,CAAAJ,CAAA,UAAAG,CAAA,CAAAE,GAAA,CAAAL,CAAA,OAAAM,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAZ,CAAA,oBAAAY,CAAA,IAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAf,CAAA,EAAAY,CAAA,SAAAI,CAAA,GAAAR,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAX,CAAA,EAAAY,CAAA,UAAAI,CAAA,KAAAA,CAAA,CAAAX,GAAA,IAAAW,CAAA,CAAAC,GAAA,IAAAR,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAI,CAAA,IAAAV,CAAA,CAAAM,CAAA,IAAAZ,CAAA,CAAAY,CAAA,YAAAN,CAAA,CAAAR,OAAA,GAAAE,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAc,GAAA,CAAAjB,CAAA,EAAAM,CAAA,GAAAA,CAAA;AApBvE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AASO,MAAMY,gBAAgB,CAAC;EAM5BC,WAAWA,CAACC,SAA6B,EAAEC,OAA2B,EAAEC,mBAAuC,EAAE;IAAA,KALzGC,QAAQ;IAAA,KACRC,QAAQ;IAAA,KACRC,uBAAuB;IAAA,KACvBC,IAAI,GAAG,IAAIC,GAAG,CAAS,CAAC;IAG9B,IAAI,CAACJ,QAAQ,GAAG,IAAIjC,KAAK,CAACsC,iBAAiB,CAACP,OAAO,EAAGC,mBAAmB,CAAC;IAE1E,IAAIO,MAAM,GAAG,CAAC,CAAC;IACf,IAAI,CAACL,QAAQ,GAAG,IAAIM,KAAK,CAAC,IAAIC,eAAY,CAAC,CAAC,EAAE;MAC5C1B,GAAG,EAAEA,CAACT,GAAQ,EAAEoC,IAAqB,KAAK;QACxC,IAAKA,IAAI,IAAIpC,GAAG,IAAKA,GAAG,CAACoC,IAAI,CAAC,KAAKC,SAAS,IAAI,OAAOD,IAAI,KAAK,QAAQ,EACtE,OAAOpC,GAAG,CAACoC,IAAI,CAAC;QAClB,OAAQE,MAAW,IAAK;UACtB,IAAI;YACF,MAAMC,EAAE,GAAG,EAAEN,MAAM;YACnB,IAAI,CAACH,IAAI,CAACU,GAAG,CAACD,EAAE,CAAC;YACjB,MAAME,SAAS,GAAG,IAAAC,wBAAa,EAAC,cAAc,EAAEN,IAAI,EAAE,QAAQ,CAAC;YAC/DE,MAAM,GAAGG,SAAS,CAACH,MAAM,EAAE,EAAE,EAAE;cAAEK,YAAY,EAAEC,gBAAgB;cAAEC,MAAM,EAAE;YAAW,CAAC,CAAC;YACtFrB,SAAS,CAACsB,IAAI,CAAC;cAAEP,EAAE;cAAEQ,IAAI,EAAE,IAAI,CAAClB,uBAAuB;cAAEmB,MAAM,EAAEZ,IAAI;cAAEE,MAAM;cAAEW,QAAQ,EAAE;gBAAEC,KAAK,EAAE,EAAE;gBAAEC,OAAO,EAAE,EAAE;gBAAEC,QAAQ,EAAE;cAAK;YAAE,CAAQ,CAAC;UAC/I,CAAC,CAAC,OAAOhD,CAAC,EAAE,CACZ;QACF,CAAC;MACH;IACF,CAAC,CAAgD;IACjD,IAAI,CAACuB,QAAQ,CAAC0B,EAAE,CAAC3D,KAAK,CAACsC,iBAAiB,CAACsB,MAAM,CAACC,cAAc,EAAGC,OAA0C,IAAK,IAAI,CAAC5B,QAAQ,CAAC6B,cAAc,CAACD,OAAO,CAAC,CAAC;IACtJ,IAAI,CAAC7B,QAAQ,CAAC0B,EAAE,CAAC3D,KAAK,CAACsC,iBAAiB,CAACsB,MAAM,CAACI,SAAS,EAAGF,OAAqC,IAAK,IAAI,CAAC5B,QAAQ,CAAC+B,SAAS,CAACH,OAAO,CAAC,CAAC;IACvI,IAAI,CAAC7B,QAAQ,CAAC0B,EAAE,CAAC3D,KAAK,CAACsC,iBAAiB,CAACsB,MAAM,CAACM,UAAU,EAAGJ,OAAsC,IAAK,IAAI,CAAC5B,QAAQ,CAACiC,UAAU,CAACL,OAAO,CAAC,CAAC;IAC1I,IAAI,CAAC7B,QAAQ,CAAC0B,EAAE,CAAC3D,KAAK,CAACsC,iBAAiB,CAACsB,MAAM,CAACQ,WAAW,EAAGN,OAAuC,IAAK,IAAI,CAAC5B,QAAQ,CAACmC,WAAW,CAACP,OAAO,CAAC,CAAC;IAC7I,IAAI,CAAC7B,QAAQ,CAAC0B,EAAE,CAAC3D,KAAK,CAACsC,iBAAiB,CAACsB,MAAM,CAACU,QAAQ,EAAGR,OAAoC,IAAK,IAAI,CAAC5B,QAAQ,CAACqC,QAAQ,CAACT,OAAO,CAAC,CAAC;IACpI,IAAI,CAAC5B,QAAQ,CAACyB,EAAE,CAAC,gBAAgB,EAAEG,OAAO,IAAI,IAAI,CAAC7B,QAAQ,CAACuC,eAAe,CAACV,OAAO,CAAC,CAAC;IACrF,IAAI,CAAC5B,QAAQ,CAACyB,EAAE,CAAC,aAAa,EAAEG,OAAO,IAAI,IAAI,CAAC7B,QAAQ,CAACwC,YAAY,CAACX,OAAO,CAAC,CAAC;IAC/E,IAAI,CAAC5B,QAAQ,CAACyB,EAAE,CAAC,WAAW,EAAEG,OAAO,IAAI,IAAI,CAAC7B,QAAQ,CAACyC,cAAc,CAACZ,OAAO,CAAC,CAAC;EACjF;EAEAa,OAAOA,CAAA,EAAG;IACR,IAAI,CAAC1C,QAAQ,CAAC0C,OAAO,CAAC,CAAC;EACzB;EAEAC,gBAAgBA,CAACC,OAAY,EAAW;IACtC,IAAI,IAAI,CAACzC,IAAI,CAACtB,GAAG,CAAC+D,OAAO,CAAChC,EAAE,CAAC,EAAE;MAC7B,IAAI,CAACT,IAAI,CAAC0C,MAAM,CAACD,OAAO,CAAChC,EAAE,CAAC;MAC5B,OAAO,IAAI;IACb;IACA,IAAIgC,OAAO,CAACvB,MAAM,KAAK,YAAY,IAAIuB,OAAO,CAACjC,MAAM,CAACmC,IAAI,KAAK,cAAc,EAAE;MAC7E,IAAI,CAAC5C,uBAAuB,GAAG0C,OAAO,CAACjC,MAAM,CAACS,IAAI;MAClD,OAAO,KAAK;IACd;IACA,IAAI,IAAI,CAAClB,uBAAuB,IAAI0C,OAAO,CAACxB,IAAI,KAAK,IAAI,CAAClB,uBAAuB,EAAE;MACjF,MAAMY,SAAS,GAAG,IAAAC,wBAAa,EAAC,cAAc,EAAE6B,OAAO,CAACvB,MAAM,EAAE,OAAO,CAAC;MACxE,MAAMV,MAAM,GAAGG,SAAS,CAAC8B,OAAO,CAACjC,MAAM,EAAE,EAAE,EAAE;QAAEK,YAAY,EAAEC,gBAAgB;QAAEC,MAAM,EAAE;MAAa,CAAC,CAAC;MACtG,IAAI,CAACjB,QAAQ,CAAC8C,IAAI,CAACH,OAAO,CAACvB,MAAM,EAAEV,MAAM,CAAC;MAC1C,OAAO,IAAI;IACb;IACA,OAAO,KAAK;EACd;AACF;AAACqC,OAAA,CAAArD,gBAAA,GAAAA,gBAAA;AAED,SAASsB,gBAAgBA,CAACgC,KAAqB,EAAEC,GAAQ,EAAEC,IAAY,EAAEC,OAAyB,EAAE;EAClG,MAAM,IAAIC,0BAAe,CAAE,GAAEF,IAAK,6CAA4C,CAAC;AACjF"}