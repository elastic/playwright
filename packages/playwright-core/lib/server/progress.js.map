{"version":3,"file":"progress.js","names":["_errors","require","_utils","_manualPromise","ProgressController","constructor","metadata","sdkObject","_forceAbortPromise","ManualPromise","_cleanups","_logName","_state","_deadline","_timeout","instrumentation","catch","e","setLogName","logName","abort","error","reject","run","task","timeout","_this$sdkObject$attri","monotonicTime","assert","attribution","context","_activeProgressControllers","add","progress","log","message","push","onCallLog","timeUntilDeadline","isRunning","cleanupWhenAborted","cleanup","runCleanup","throwIfAborted","AbortedError","beforeInputAction","element","onBeforeInputAction","timeoutError","TimeoutError","timer","setTimeout","promise","result","Promise","race","all","splice","map","_this$sdkObject$attri2","delete","clearTimeout","exports","Error"],"sources":["../../src/server/progress.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { TimeoutError } from './errors';\nimport { assert, monotonicTime } from '../utils';\nimport type { LogName } from '../utils/debugLogger';\nimport type { CallMetadata, Instrumentation, SdkObject } from './instrumentation';\nimport type { ElementHandle } from './dom';\nimport { ManualPromise } from '../utils/manualPromise';\n\nexport interface Progress {\n  log(message: string): void;\n  timeUntilDeadline(): number;\n  isRunning(): boolean;\n  cleanupWhenAborted(cleanup: () => any): void;\n  throwIfAborted(): void;\n  beforeInputAction(element: ElementHandle): Promise<void>;\n  metadata: CallMetadata;\n}\n\nexport class ProgressController {\n  private _forceAbortPromise = new ManualPromise<any>();\n\n  // Cleanups to be run only in the case of abort.\n  private _cleanups: (() => any)[] = [];\n\n  private _logName = 'api';\n  private _state: 'before' | 'running' | 'aborted' | 'finished' = 'before';\n  private _deadline: number = 0;\n  private _timeout: number = 0;\n  readonly metadata: CallMetadata;\n  readonly instrumentation: Instrumentation;\n  readonly sdkObject: SdkObject;\n\n  constructor(metadata: CallMetadata, sdkObject: SdkObject) {\n    this.metadata = metadata;\n    this.sdkObject = sdkObject;\n    this.instrumentation = sdkObject.instrumentation;\n    this._forceAbortPromise.catch(e => null);  // Prevent unhandled promise rejection.\n  }\n\n  setLogName(logName: LogName) {\n    this._logName = logName;\n  }\n\n  abort(error: Error) {\n    this._forceAbortPromise.reject(error);\n  }\n\n  async run<T>(task: (progress: Progress) => Promise<T>, timeout?: number): Promise<T> {\n    if (timeout) {\n      this._timeout = timeout;\n      this._deadline = timeout ? monotonicTime() + timeout : 0;\n    }\n\n    assert(this._state === 'before');\n    this._state = 'running';\n    this.sdkObject.attribution.context?._activeProgressControllers.add(this);\n\n    const progress: Progress = {\n      log: message => {\n        if (this._state === 'running')\n          this.metadata.log.push(message);\n        // Note: we might be sending logs after progress has finished, for example browser logs.\n        this.instrumentation.onCallLog(this.sdkObject, this.metadata, this._logName, message);\n      },\n      timeUntilDeadline: () => this._deadline ? this._deadline - monotonicTime() : 2147483647, // 2^31-1 safe setTimeout in Node.\n      isRunning: () => this._state === 'running',\n      cleanupWhenAborted: (cleanup: () => any) => {\n        if (this._state === 'running')\n          this._cleanups.push(cleanup);\n        else\n          runCleanup(cleanup);\n      },\n      throwIfAborted: () => {\n        if (this._state === 'aborted')\n          throw new AbortedError();\n      },\n      beforeInputAction: async (element: ElementHandle) => {\n        await this.instrumentation.onBeforeInputAction(this.sdkObject, this.metadata, element);\n      },\n      metadata: this.metadata\n    };\n\n    const timeoutError = new TimeoutError(`Timeout ${this._timeout}ms exceeded.`);\n    const timer = setTimeout(() => this._forceAbortPromise.reject(timeoutError), progress.timeUntilDeadline());\n    try {\n      const promise = task(progress);\n      const result = await Promise.race([promise, this._forceAbortPromise]);\n      this._state = 'finished';\n      return result;\n    } catch (e) {\n      this._state = 'aborted';\n      await Promise.all(this._cleanups.splice(0).map(runCleanup));\n      throw e;\n    } finally {\n      this.sdkObject.attribution.context?._activeProgressControllers.delete(this);\n      clearTimeout(timer);\n    }\n  }\n}\n\nasync function runCleanup(cleanup: () => any) {\n  try {\n    await cleanup();\n  } catch (e) {\n  }\n}\n\nclass AbortedError extends Error {}\n"],"mappings":"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"}