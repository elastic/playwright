{"version":3,"file":"artifact.js","names":["_fs","_interopRequireDefault","require","_utils","_manualPromise","_instrumentation","_errors","obj","__esModule","default","Artifact","SdkObject","constructor","parent","localPath","unaccessibleErrorMessage","cancelCallback","_localPath","_unaccessibleErrorMessage","_cancelCallback","_finishedPromise","ManualPromise","_saveCallbacks","_finished","_deleted","_failureError","finishedPromise","localPathAfterFinished","Error","saveAs","saveCallback","catch","push","failureError","_this$_failureError","message","cancel","assert","undefined","delete","fileName","fs","promises","unlink","e","deleteOnContextClose","reportFinished","TargetClosedError","error","callback","resolve","exports"],"sources":["../../src/server/artifact.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport { assert } from '../utils';\nimport { ManualPromise } from '../utils/manualPromise';\nimport { SdkObject } from './instrumentation';\nimport { TargetClosedError } from './errors';\n\ntype SaveCallback = (localPath: string, error?: Error) => Promise<void>;\ntype CancelCallback = () => Promise<void>;\n\nexport class Artifact extends SdkObject {\n  private _localPath: string;\n  private _unaccessibleErrorMessage: string | undefined;\n  private _cancelCallback: CancelCallback | undefined;\n  private _finishedPromise = new ManualPromise<void>();\n  private _saveCallbacks: SaveCallback[] = [];\n  private _finished: boolean = false;\n  private _deleted = false;\n  private _failureError: Error | undefined;\n\n  constructor(parent: SdkObject, localPath: string, unaccessibleErrorMessage?: string, cancelCallback?: CancelCallback) {\n    super(parent, 'artifact');\n    this._localPath = localPath;\n    this._unaccessibleErrorMessage = unaccessibleErrorMessage;\n    this._cancelCallback = cancelCallback;\n  }\n\n  finishedPromise() {\n    return this._finishedPromise;\n  }\n\n  localPath() {\n    return this._localPath;\n  }\n\n  async localPathAfterFinished(): Promise<string> {\n    if (this._unaccessibleErrorMessage)\n      throw new Error(this._unaccessibleErrorMessage);\n    await this._finishedPromise;\n    if (this._failureError)\n      throw this._failureError;\n    return this._localPath;\n  }\n\n  saveAs(saveCallback: SaveCallback) {\n    if (this._unaccessibleErrorMessage)\n      throw new Error(this._unaccessibleErrorMessage);\n    if (this._deleted)\n      throw new Error(`File already deleted. Save before deleting.`);\n    if (this._failureError)\n      throw this._failureError;\n\n    if (this._finished) {\n      saveCallback(this._localPath).catch(() => {});\n      return;\n    }\n    this._saveCallbacks.push(saveCallback);\n  }\n\n  async failureError(): Promise<string | null> {\n    if (this._unaccessibleErrorMessage)\n      return this._unaccessibleErrorMessage;\n    await this._finishedPromise;\n    return this._failureError?.message || null;\n  }\n\n  async cancel(): Promise<void> {\n    assert(this._cancelCallback !== undefined);\n    return this._cancelCallback();\n  }\n\n  async delete(): Promise<void> {\n    if (this._unaccessibleErrorMessage)\n      return;\n    const fileName = await this.localPathAfterFinished();\n    if (this._deleted)\n      return;\n    this._deleted = true;\n    if (fileName)\n      await fs.promises.unlink(fileName).catch(e => {});\n  }\n\n  async deleteOnContextClose(): Promise<void> {\n    // Compared to \"delete\", this method does not wait for the artifact to finish.\n    // We use it when closing the context to avoid stalling.\n    if (this._deleted)\n      return;\n    this._deleted = true;\n    if (!this._unaccessibleErrorMessage)\n      await fs.promises.unlink(this._localPath).catch(e => {});\n    await this.reportFinished(new TargetClosedError());\n  }\n\n  async reportFinished(error?: Error) {\n    if (this._finished)\n      return;\n    this._finished = true;\n    this._failureError = error;\n\n    if (error) {\n      for (const callback of this._saveCallbacks)\n        await callback('', error);\n    } else {\n      for (const callback of this._saveCallbacks)\n        await callback(this._localPath);\n    }\n    this._saveCallbacks = [];\n\n    this._finishedPromise.resolve();\n  }\n}\n"],"mappings":"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"}