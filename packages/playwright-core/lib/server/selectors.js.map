{"version":3,"file":"selectors.js","names":["_selectorParser","require","_utils","Selectors","constructor","_builtinEngines","_builtinEnginesInMainWorld","_engines","guid","createGuid","_testIdAttributeName","Set","Map","register","name","source","contentScript","match","Error","has","set","testIdAttributeName","setTestIdAttributeName","unregisterAll","clear","parseSelector","selector","strict","parsed","needsMainWorld","visitAllSelectorParts","part","custom","get","InvalidSelectorError","stringifySelector","world","exports"],"sources":["../../src/server/selectors.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { visitAllSelectorParts, InvalidSelectorError, type ParsedSelector, parseSelector, stringifySelector } from '../utils/isomorphic/selectorParser';\nimport { createGuid } from '../utils';\n\nexport class Selectors {\n  private readonly _builtinEngines: Set<string>;\n  private readonly _builtinEnginesInMainWorld: Set<string>;\n  readonly _engines: Map<string, { source: string, contentScript: boolean }>;\n  readonly guid = `selectors@${createGuid()}`;\n  private _testIdAttributeName: string = 'data-testid';\n\n  constructor() {\n    // Note: keep in sync with InjectedScript class.\n    this._builtinEngines = new Set([\n      'css', 'css:light',\n      'xpath', 'xpath:light',\n      '_react', '_vue',\n      'text', 'text:light',\n      'id', 'id:light',\n      'data-testid', 'data-testid:light',\n      'data-test-id', 'data-test-id:light',\n      'data-test', 'data-test:light',\n      'nth', 'visible', 'internal:control',\n      'internal:has', 'internal:has-not',\n      'internal:has-text', 'internal:has-not-text',\n      'internal:and', 'internal:or', 'internal:chain',\n      'role', 'internal:attr', 'internal:label', 'internal:text', 'internal:role', 'internal:testid',\n    ]);\n    this._builtinEnginesInMainWorld = new Set([\n      '_react', '_vue',\n    ]);\n    this._engines = new Map();\n  }\n\n  async register(name: string, source: string, contentScript: boolean = false): Promise<void> {\n    if (!name.match(/^[a-zA-Z_0-9-]+$/))\n      throw new Error('Selector engine name may only contain [a-zA-Z0-9_] characters');\n    // Note: we keep 'zs' for future use.\n    if (this._builtinEngines.has(name) || name === 'zs' || name === 'zs:light')\n      throw new Error(`\"${name}\" is a predefined selector engine`);\n    if (this._engines.has(name))\n      throw new Error(`\"${name}\" selector engine has been already registered`);\n    this._engines.set(name, { source, contentScript });\n  }\n\n  testIdAttributeName(): string {\n    return this._testIdAttributeName;\n  }\n\n  setTestIdAttributeName(testIdAttributeName: string) {\n    this._testIdAttributeName = testIdAttributeName;\n  }\n\n  unregisterAll() {\n    this._engines.clear();\n  }\n\n  parseSelector(selector: string | ParsedSelector, strict: boolean) {\n    const parsed = typeof selector === 'string' ? parseSelector(selector) : selector;\n    let needsMainWorld = false;\n    visitAllSelectorParts(parsed, part => {\n      const name = part.name;\n      const custom = this._engines.get(name);\n      if (!custom && !this._builtinEngines.has(name))\n        throw new InvalidSelectorError(`Unknown engine \"${name}\" while parsing selector ${stringifySelector(parsed)}`);\n      if (custom && !custom.contentScript)\n        needsMainWorld = true;\n      if (this._builtinEnginesInMainWorld.has(name))\n        needsMainWorld = true;\n    });\n    return {\n      parsed,\n      world: needsMainWorld ? 'main' as const : 'utility' as const,\n      strict,\n    };\n  }\n}\n"],"mappings":"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"}