{"version":3,"file":"bidiSerializer.js","names":["UnserializableError","Error","BidiSerializer","serialize","arg","_serializeObject","type","_serializeNumber","value","toString","Object","is","Infinity","NaN","Array","isArray","parsedArray","map","subArg","isPlainObject","JSON","stringify","error","TypeError","message","startsWith","parsedObject","key","push","isRegExp","pattern","source","flags","isDate","toISOString","exports","obj","constructor","RegExp","Date"],"sources":["../../../../src/server/bidi/third_party/bidiSerializer.ts"],"sourcesContent":["/**\n * @license\n * Copyright 2024 Google Inc.\n * Modifications copyright (c) Microsoft Corporation.\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport type * as Bidi from './bidiProtocol';\n\n/* eslint-disable curly, indent */\n\n/**\n * @internal\n */\nclass UnserializableError extends Error {}\n\n/**\n * @internal\n */\nexport class BidiSerializer {\n  static serialize(arg: unknown): Bidi.Script.LocalValue {\n    switch (typeof arg) {\n      case 'symbol':\n      case 'function':\n        throw new UnserializableError(`Unable to serializable ${typeof arg}`);\n      case 'object':\n        return BidiSerializer._serializeObject(arg);\n\n      case 'undefined':\n        return {\n          type: 'undefined',\n        };\n      case 'number':\n        return BidiSerializer._serializeNumber(arg);\n      case 'bigint':\n        return {\n          type: 'bigint',\n          value: arg.toString(),\n        };\n      case 'string':\n        return {\n          type: 'string',\n          value: arg,\n        };\n      case 'boolean':\n        return {\n          type: 'boolean',\n          value: arg,\n        };\n    }\n  }\n\n  static _serializeNumber(arg: number): Bidi.Script.LocalValue {\n    let value: Bidi.Script.SpecialNumber | number;\n    if (Object.is(arg, -0)) {\n      value = '-0';\n    } else if (Object.is(arg, Infinity)) {\n      value = 'Infinity';\n    } else if (Object.is(arg, -Infinity)) {\n      value = '-Infinity';\n    } else if (Object.is(arg, NaN)) {\n      value = 'NaN';\n    } else {\n      value = arg;\n    }\n    return {\n      type: 'number',\n      value,\n    };\n  }\n\n  static _serializeObject(arg: object | null): Bidi.Script.LocalValue {\n    if (arg === null) {\n      return {\n        type: 'null',\n      };\n    } else if (Array.isArray(arg)) {\n      const parsedArray = arg.map(subArg => {\n        return BidiSerializer.serialize(subArg);\n      });\n\n      return {\n        type: 'array',\n        value: parsedArray,\n      };\n    } else if (isPlainObject(arg)) {\n      try {\n        JSON.stringify(arg);\n      } catch (error) {\n        if (\n          error instanceof TypeError &&\n          error.message.startsWith('Converting circular structure to JSON')\n        ) {\n          error.message += ' Recursive objects are not allowed.';\n        }\n        throw error;\n      }\n\n      const parsedObject: Bidi.Script.MappingLocalValue = [];\n      for (const key in arg) {\n        parsedObject.push([BidiSerializer.serialize(key), BidiSerializer.serialize(arg[key])]);\n      }\n\n      return {\n        type: 'object',\n        value: parsedObject,\n      };\n    } else if (isRegExp(arg)) {\n      return {\n        type: 'regexp',\n        value: {\n          pattern: arg.source,\n          flags: arg.flags,\n        },\n      };\n    } else if (isDate(arg)) {\n      return {\n        type: 'date',\n        value: arg.toISOString(),\n      };\n    }\n\n    throw new UnserializableError(\n      'Custom object serialization not possible. Use plain objects instead.'\n    );\n  }\n}\n\n/**\n * @internal\n */\nexport const isPlainObject = (obj: unknown): obj is Record<any, unknown> => {\n  return typeof obj === 'object' && obj?.constructor === Object;\n};\n\n/**\n * @internal\n */\nexport const isRegExp = (obj: unknown): obj is RegExp => {\n  return typeof obj === 'object' && obj?.constructor === RegExp;\n};\n\n/**\n * @internal\n */\nexport const isDate = (obj: unknown): obj is Date => {\n  return typeof obj === 'object' && obj?.constructor === Date;\n};\n"],"mappings":"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"}