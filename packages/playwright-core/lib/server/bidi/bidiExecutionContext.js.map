{"version":3,"file":"bidiExecutionContext.js","names":["_utilityScriptSerializers","require","js","_interopRequireWildcard","_bidiDeserializer","bidi","_bidiSerializer","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","BidiExecutionContext","constructor","session","realmInfo","_session","_target","type","context","sandbox","realm","rawEvaluateJSON","expression","response","send","target","serializationOptions","maxObjectDepth","maxDomDepth","awaitPromise","userActivation","BidiDeserializer","deserialize","result","JavaScriptErrorInEvaluate","exceptionDetails","text","JSON","stringify","rawEvaluateHandle","resultOwnership","Script","ResultOwnership","Root","handle","rawCallFunctionNoReply","func","args","Error","evaluateWithArguments","functionDeclaration","returnByValue","utilityScript","values","objectIds","arguments","_objectId","map","BidiSerializer","serialize","undefined","parseEvaluationResultValue","objectId","_context","createHandle","getProperties","jsRemoteObject","remoteObject","JSHandle","renderPreview","remoteObjectValue","releaseHandle","handles","objectCount","rawCallFunction","arg","exports","String","value","parseUnserializableValue"],"sources":["../../../src/server/bidi/bidiExecutionContext.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { parseEvaluationResultValue } from '../isomorphic/utilityScriptSerializers';\nimport * as js from '../javascript';\nimport type { BidiSession } from './bidiConnection';\nimport { BidiDeserializer } from './third_party/bidiDeserializer';\nimport * as bidi from './third_party/bidiProtocol';\nimport { BidiSerializer } from './third_party/bidiSerializer';\n\nexport class BidiExecutionContext implements js.ExecutionContextDelegate {\n  private readonly _session: BidiSession;\n  private readonly _target: bidi.Script.Target;\n\n  constructor(session: BidiSession, realmInfo: bidi.Script.RealmInfo) {\n    this._session = session;\n    if (realmInfo.type === 'window') {\n      // Simple realm does not seem to work for Window contexts.\n      this._target = {\n        context: realmInfo.context,\n        sandbox: realmInfo.sandbox,\n      };\n    } else {\n      this._target = {\n        realm: realmInfo.realm\n      };\n    }\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const response = await this._session.send('script.evaluate', {\n      expression,\n      target: this._target,\n      serializationOptions: {\n        maxObjectDepth: 10,\n        maxDomDepth: 10,\n      },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'success')\n      return BidiDeserializer.deserialize(response.result);\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n\n  async rawEvaluateHandle(expression: string): Promise<js.ObjectId> {\n    const response = await this._session.send('script.evaluate', {\n      expression,\n      target: this._target,\n      resultOwnership: bidi.Script.ResultOwnership.Root, // Necessary for the handle to be returned.\n      serializationOptions: { maxObjectDepth: 0, maxDomDepth: 0 },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'success') {\n      if ('handle' in response.result)\n        return response.result.handle!;\n      throw new js.JavaScriptErrorInEvaluate('Cannot get handle: ' + JSON.stringify(response.result));\n    }\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n\n  rawCallFunctionNoReply(func: Function, ...args: any[]) {\n    throw new Error('Method not implemented.');\n  }\n\n  async evaluateWithArguments(functionDeclaration: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], objectIds: string[]): Promise<any> {\n    const response = await this._session.send('script.callFunction', {\n      functionDeclaration,\n      target: this._target,\n      arguments: [\n        { handle: utilityScript._objectId! },\n        ...values.map(BidiSerializer.serialize),\n        ...objectIds.map(handle => ({ handle })),\n      ],\n      resultOwnership: returnByValue ? undefined : bidi.Script.ResultOwnership.Root, // Necessary for the handle to be returned.\n      serializationOptions: returnByValue ? {} : { maxObjectDepth: 0, maxDomDepth: 0 },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    if (response.type === 'success') {\n      if (returnByValue)\n        return parseEvaluationResultValue(BidiDeserializer.deserialize(response.result));\n      const objectId = 'handle' in response.result ? response.result.handle : undefined ;\n      return utilityScript._context.createHandle({ objectId, ...response.result });\n    }\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n\n  async getProperties(context: js.ExecutionContext, objectId: js.ObjectId): Promise<Map<string, js.JSHandle>> {\n    throw new Error('Method not implemented.');\n  }\n\n  createHandle(context: js.ExecutionContext, jsRemoteObject: js.RemoteObject): js.JSHandle {\n    const remoteObject: bidi.Script.RemoteValue = jsRemoteObject as bidi.Script.RemoteValue;\n    return new js.JSHandle(context, remoteObject.type, renderPreview(remoteObject), jsRemoteObject.objectId, remoteObjectValue(remoteObject));\n  }\n\n  async releaseHandle(objectId: js.ObjectId): Promise<void> {\n    await this._session.send('script.disown', {\n      target: this._target,\n      handles: [objectId],\n    });\n  }\n\n  objectCount(objectId: js.ObjectId): Promise<number> {\n    throw new Error('Method not implemented.');\n  }\n\n  async rawCallFunction(functionDeclaration: string, arg: bidi.Script.LocalValue): Promise<bidi.Script.RemoteValue> {\n    const response = await this._session.send('script.callFunction', {\n      functionDeclaration,\n      target: this._target,\n      arguments: [arg],\n      resultOwnership: bidi.Script.ResultOwnership.Root, // Necessary for the handle to be returned.\n      serializationOptions: { maxObjectDepth: 0, maxDomDepth: 0 },\n      awaitPromise: true,\n      userActivation: true,\n    });\n    if (response.type === 'exception')\n      throw new js.JavaScriptErrorInEvaluate(response.exceptionDetails.text + '\\nFull val: ' + JSON.stringify(response.exceptionDetails));\n    if (response.type === 'success')\n      return response.result;\n    throw new js.JavaScriptErrorInEvaluate('Unexpected response type: ' + JSON.stringify(response));\n  }\n}\n\nfunction renderPreview(remoteObject: bidi.Script.RemoteValue): string | undefined {\n  if (remoteObject.type === 'undefined')\n    return 'undefined';\n  if (remoteObject.type === 'null')\n    return 'null';\n  if ('value' in remoteObject)\n    return String(remoteObject.value);\n  return `<${remoteObject.type}>`;\n}\n\nfunction remoteObjectValue(remoteObject: bidi.Script.RemoteValue): any {\n  if (remoteObject.type === 'undefined')\n    return undefined;\n  if (remoteObject.type === 'null')\n    return null;\n  if (remoteObject.type === 'number' && typeof remoteObject.value === 'string')\n    return js.parseUnserializableValue(remoteObject.value);\n  if ('value' in remoteObject)\n    return remoteObject.value;\n  return undefined;\n}\n"],"mappings":"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"}