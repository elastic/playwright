{"version":3,"file":"bidiBrowser.js","names":["_eventsHelper","require","_browser","_browserContext","network","_interopRequireWildcard","_bidiConnection","_bidiNetworkManager","_bidiPage","bidi","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","BidiBrowser","Browser","connect","parent","transport","options","browser","__testHookOnConnectToBrowser","sessionStatus","_browserSession","send","ready","Error","message","proxy","proxyType","url","URL","server","protocol","httpProxy","host","httpsProxy","socksProxy","socksVersion","bypass","noProxy","split","_bidiSessionInfo","capabilities","alwaysMatch","acceptInsecureCerts","unhandledPromptBehavior","Session","UserPromptHandlerType","Ignore","webSocketUrl","events","constructor","_connection","_contexts","Map","_bidiPages","_eventListeners","BidiConnection","_onDisconnect","bind","protocolLogger","browserLogsCollector","browserSession","eventsHelper","addEventListener","_onBrowsingContextCreated","_onScriptRealmDestroyed","_didClose","doCreateNewContext","userContext","context","BidiBrowserContext","_initialize","contexts","Array","from","values","version","browserVersion","userAgent","isConnected","isClosed","event","parentFrameId","page","parentFrame","_page","_frameManager","frame","_session","addFrameBrowsingContext","frameAttached","_defaultContext","session","createMainFrameBrowsingContextSession","opener","originalOpener","BidiPage","_onBrowsingContextDestroyed","removeFrameBrowsingContext","frameDetached","bidiPage","didClose","delete","_onRealmDestroyed","exports","BrowserContext","browserContextId","_authenticateProxyViaHeader","pages","newPageDelegate","assertBrowserContextIsNotOwned","type","BrowsingContext","CreateType","Window","_browserContextId","doGetCookies","urls","cookies","partition","filterCookies","map","c","_c$expiry","copy","name","value","bidiBytesValueToString","domain","path","httpOnly","secure","expires","expiry","sameSite","fromBidiSameSite","addCookies","rewriteCookies","promises","cookie","toBidiSameSite","undefined","Math","round","Promise","all","doClearCookies","doGrantPermissions","origin","permissions","doClearPermissions","setGeolocation","geolocation","setExtraHTTPHeaders","headers","setUserAgent","setOffline","offline","doSetHTTPCredentials","httpCredentials","doAddInitScript","initScript","doRemoveNonInternalInitScripts","doUpdateRequestInterception","onClosePersistent","clearCache","doClose","reason","cancelDownload","uuid","Network","SameSite","Strict","Lax","None","_Network"],"sources":["../../../src/server/bidi/bidiBrowser.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\nimport type { RegisteredListener } from '../../utils/eventsHelper';\nimport { eventsHelper } from '../../utils/eventsHelper';\nimport type { BrowserOptions } from '../browser';\nimport { Browser } from '../browser';\nimport { assertBrowserContextIsNotOwned, BrowserContext } from '../browserContext';\nimport type { SdkObject } from '../instrumentation';\nimport * as network from '../network';\nimport type { InitScript, Page, PageDelegate } from '../page';\nimport type { ConnectionTransport } from '../transport';\nimport type * as types from '../types';\nimport type { BidiSession } from './bidiConnection';\nimport { BidiConnection } from './bidiConnection';\nimport { bidiBytesValueToString } from './bidiNetworkManager';\nimport { BidiPage } from './bidiPage';\nimport * as bidi from './third_party/bidiProtocol';\n\nexport class BidiBrowser extends Browser {\n  private readonly _connection: BidiConnection;\n  readonly _browserSession: BidiSession;\n  private _bidiSessionInfo!: bidi.Session.NewResult;\n  readonly _contexts = new Map<string, BidiBrowserContext>();\n  readonly _bidiPages = new Map<bidi.BrowsingContext.BrowsingContext, BidiPage>();\n  private readonly _eventListeners: RegisteredListener[];\n\n  static async connect(parent: SdkObject, transport: ConnectionTransport, options: BrowserOptions): Promise<BidiBrowser> {\n    const browser = new BidiBrowser(parent, transport, options);\n    if ((options as any).__testHookOnConnectToBrowser)\n      await (options as any).__testHookOnConnectToBrowser();\n    const sessionStatus = await browser._browserSession.send('session.status', {});\n    if (!sessionStatus.ready)\n      throw new Error('Bidi session is not ready. ' + sessionStatus.message);\n\n    let proxy: bidi.Session.ManualProxyConfiguration | undefined;\n    if (options.proxy) {\n      proxy = {\n        proxyType: 'manual',\n      };\n      const url = new URL(options.proxy.server);  // Validate proxy server.\n      switch (url.protocol) {\n        case 'http:':\n          proxy.httpProxy = url.host;\n          break;\n        case 'https:':\n          proxy.httpsProxy = url.host;\n          break;\n        case 'socks4:':\n          proxy.socksProxy = url.host;\n          proxy.socksVersion = 4;\n          break;\n        case 'socks5:':\n          proxy.socksProxy = url.host;\n          proxy.socksVersion = 5;\n          break;\n        default:\n          throw new Error('Invalid proxy server protocol: ' + options.proxy.server);\n      }\n      if (options.proxy.bypass)\n        proxy.noProxy = options.proxy.bypass.split(',');\n      // TODO: support authentication.\n    }\n\n    browser._bidiSessionInfo = await browser._browserSession.send('session.new', {\n      capabilities: {\n        alwaysMatch: {\n          acceptInsecureCerts: false,\n          proxy,\n          unhandledPromptBehavior: {\n            default: bidi.Session.UserPromptHandlerType.Ignore,\n          },\n          webSocketUrl: true\n        },\n      }\n    });\n\n    await browser._browserSession.send('session.subscribe', {\n      events: [\n        'browsingContext',\n        'network',\n        'log',\n        'script',\n      ],\n    });\n    return browser;\n  }\n\n  constructor(parent: SdkObject, transport: ConnectionTransport, options: BrowserOptions) {\n    super(parent, options);\n    this._connection = new BidiConnection(transport, this._onDisconnect.bind(this), options.protocolLogger, options.browserLogsCollector);\n    this._browserSession = this._connection.browserSession;\n    this._eventListeners = [\n      eventsHelper.addEventListener(this._browserSession, 'browsingContext.contextCreated', this._onBrowsingContextCreated.bind(this)),\n      eventsHelper.addEventListener(this._browserSession, 'script.realmDestroyed', this._onScriptRealmDestroyed.bind(this)),\n    ];\n  }\n\n  _onDisconnect() {\n    this._didClose();\n  }\n\n  async doCreateNewContext(options: channels.BrowserNewContextParams): Promise<BrowserContext> {\n    const { userContext } = await this._browserSession.send('browser.createUserContext', {});\n    const context = new BidiBrowserContext(this, userContext, options);\n    await context._initialize();\n    this._contexts.set(userContext, context);\n    return context;\n  }\n\n  contexts(): BrowserContext[] {\n    return Array.from(this._contexts.values());\n  }\n\n  version(): string {\n    return this._bidiSessionInfo.capabilities.browserVersion;\n  }\n\n  userAgent(): string {\n    return this._bidiSessionInfo.capabilities.userAgent;\n  }\n\n  isConnected(): boolean {\n    return !this._connection.isClosed();\n  }\n\n  private _onBrowsingContextCreated(event: bidi.BrowsingContext.Info) {\n    if (event.parent) {\n      const parentFrameId = event.parent;\n      for (const page of this._bidiPages.values()) {\n        const parentFrame = page._page._frameManager.frame(parentFrameId);\n        if (!parentFrame)\n          continue;\n        page._session.addFrameBrowsingContext(event.context);\n        page._page._frameManager.frameAttached(event.context, parentFrameId);\n        return;\n      }\n      return;\n    }\n    let context = this._contexts.get(event.userContext);\n    if (!context)\n      context = this._defaultContext as BidiBrowserContext;\n    if (!context)\n      return;\n    const session = this._connection.createMainFrameBrowsingContextSession(event.context);\n    const opener = event.originalOpener && this._bidiPages.get(event.originalOpener);\n    const page = new BidiPage(context, session, opener || null);\n    this._bidiPages.set(event.context, page);\n  }\n\n  _onBrowsingContextDestroyed(event: bidi.BrowsingContext.Info) {\n    if (event.parent) {\n      this._browserSession.removeFrameBrowsingContext(event.context);\n      const parentFrameId = event.parent;\n      for (const page of this._bidiPages.values()) {\n        const parentFrame = page._page._frameManager.frame(parentFrameId);\n        if (!parentFrame)\n          continue;\n        page._page._frameManager.frameDetached(event.context);\n        return;\n      }\n      return;\n    }\n    const bidiPage = this._bidiPages.get(event.context);\n    if (!bidiPage)\n      return;\n    bidiPage.didClose();\n    this._bidiPages.delete(event.context);\n  }\n\n  private _onScriptRealmDestroyed(event: bidi.Script.RealmDestroyedParameters) {\n    for (const page of this._bidiPages.values()) {\n      if (page._onRealmDestroyed(event))\n        return;\n    }\n  }\n}\n\nexport class BidiBrowserContext extends BrowserContext {\n  declare readonly _browser: BidiBrowser;\n\n  constructor(browser: BidiBrowser, browserContextId: string | undefined, options: channels.BrowserNewContextParams) {\n    super(browser, options, browserContextId);\n    this._authenticateProxyViaHeader();\n  }\n\n  pages(): Page[] {\n    return [];\n  }\n\n  async newPageDelegate(): Promise<PageDelegate> {\n    assertBrowserContextIsNotOwned(this);\n    const { context } = await this._browser._browserSession.send('browsingContext.create', {\n      type: bidi.BrowsingContext.CreateType.Window,\n      userContext: this._browserContextId,\n    });\n    return this._browser._bidiPages.get(context)!;\n  }\n\n  async doGetCookies(urls: string[]): Promise<channels.NetworkCookie[]> {\n    const { cookies } = await this._browser._browserSession.send('storage.getCookies',\n        { partition: { type: 'storageKey', userContext: this._browserContextId } });\n    return network.filterCookies(cookies.map((c: bidi.Network.Cookie) => {\n      const copy: channels.NetworkCookie = {\n        name: c.name,\n        value: bidiBytesValueToString(c.value),\n        domain: c.domain,\n        path: c.path,\n        httpOnly: c.httpOnly,\n        secure: c.secure,\n        expires: c.expiry ?? -1,\n        sameSite: c.sameSite ? fromBidiSameSite(c.sameSite) : 'None',\n      };\n      return copy;\n    }), urls);\n  }\n\n  async addCookies(cookies: channels.SetNetworkCookie[]) {\n    cookies = network.rewriteCookies(cookies);\n    const promises = cookies.map((c: channels.SetNetworkCookie) => {\n      const cookie: bidi.Storage.PartialCookie = {\n        name: c.name,\n        value: { type: 'string', value: c.value },\n        domain: c.domain!,\n        path: c.path,\n        httpOnly: c.httpOnly,\n        secure: c.secure,\n        sameSite: c.sameSite && toBidiSameSite(c.sameSite),\n        expiry: (c.expires === -1 || c.expires === undefined) ? undefined : Math.round(c.expires),\n      };\n      return this._browser._browserSession.send('storage.setCookie',\n          { cookie, partition: { type: 'storageKey', userContext: this._browserContextId } });\n    });\n    await Promise.all(promises);\n  }\n\n  async doClearCookies() {\n    await this._browser._browserSession.send('storage.deleteCookies',\n        { partition: { type: 'storageKey', userContext: this._browserContextId } });\n  }\n\n  async doGrantPermissions(origin: string, permissions: string[]) {\n  }\n\n  async doClearPermissions() {\n  }\n\n  async setGeolocation(geolocation?: types.Geolocation): Promise<void> {\n  }\n\n  async setExtraHTTPHeaders(headers: types.HeadersArray): Promise<void> {\n  }\n\n  async setUserAgent(userAgent: string | undefined): Promise<void> {\n  }\n\n  async setOffline(offline: boolean): Promise<void> {\n  }\n\n  async doSetHTTPCredentials(httpCredentials?: types.Credentials): Promise<void> {\n  }\n\n  async doAddInitScript(initScript: InitScript) {\n    // for (const page of this.pages())\n    //   await (page._delegate as WKPage)._updateBootstrapScript();\n  }\n\n  async doRemoveNonInternalInitScripts() {\n  }\n\n  async doUpdateRequestInterception(): Promise<void> {\n  }\n\n  onClosePersistent() {}\n\n  override async clearCache(): Promise<void> {\n  }\n\n  async doClose(reason: string | undefined) {\n    // TODO: implement for persistent context\n    if (!this._browserContextId)\n      return;\n\n    await this._browser._browserSession.send('browser.removeUserContext', {\n      userContext: this._browserContextId\n    });\n    this._browser._contexts.delete(this._browserContextId);\n  }\n\n  async cancelDownload(uuid: string) {\n  }\n}\n\nfunction fromBidiSameSite(sameSite: bidi.Network.SameSite): channels.NetworkCookie['sameSite'] {\n  switch (sameSite) {\n    case 'strict': return 'Strict';\n    case 'lax': return 'Lax';\n    case 'none': return 'None';\n  }\n  return 'None';\n}\n\nfunction toBidiSameSite(sameSite: channels.SetNetworkCookie['sameSite']): bidi.Network.SameSite {\n  switch (sameSite) {\n    case 'Strict': return bidi.Network.SameSite.Strict;\n    case 'Lax': return bidi.Network.SameSite.Lax;\n    case 'None': return bidi.Network.SameSite.None;\n  }\n  return bidi.Network.SameSite.None;\n}\n\nexport namespace Network {\n  export const enum SameSite {\n    Strict = 'strict',\n    Lax = 'lax',\n    None = 'none',\n  }\n}\n"],"mappings":"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"}