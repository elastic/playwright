{"version":3,"file":"bidiFirefox.js","names":["_os","_interopRequireDefault","require","_path","_utils","_browserType","_bidiBrowser","_bidiConnection","obj","__esModule","default","BidiFirefox","BrowserType","constructor","parent","_useBidi","connectToTransport","transport","options","BidiBrowser","connect","attribution","playwright","doRewriteStartupLog","error","logs","includes","wrapInASCIIBox","process","env","GITHUB_ACTION","kNoXServerRunningError","amendEnvironment","userDataDir","executable","browserArguments","path","isAbsolute","os","homedir","Error","platform","SNAP_NAME","undefined","SNAP_INSTANCE_NAME","attemptToGracefullyCloseBrowser","send","method","params","id","kBrowserCloseMessageId","defaultArgs","isPersistent","args","headless","userDataDirArg","find","arg","startsWith","_createUserDataDirArgMisuseError","firefoxArguments","push","readyState","assert","useWebSocket","BidiReadyState","exports","_wsEndpoint","ManualPromise","onBrowserOutput","message","match","resolve","onBrowserExit","waitUntilReady","wsEndpoint"],"sources":["../../../src/server/bidi/bidiFirefox.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport os from 'os';\nimport path from 'path';\nimport { assert, ManualPromise, wrapInASCIIBox } from '../../utils';\nimport type { Env } from '../../utils/processLauncher';\nimport type { BrowserOptions } from '../browser';\nimport type { BrowserReadyState } from '../browserType';\nimport { BrowserType, kNoXServerRunningError } from '../browserType';\nimport type { SdkObject } from '../instrumentation';\nimport type { ProtocolError } from '../protocolError';\nimport type { ConnectionTransport } from '../transport';\nimport type * as types from '../types';\nimport { BidiBrowser } from './bidiBrowser';\nimport { kBrowserCloseMessageId } from './bidiConnection';\n\nexport class BidiFirefox extends BrowserType {\n  constructor(parent: SdkObject) {\n    super(parent, 'bidi');\n    this._useBidi = true;\n  }\n\n  override async connectToTransport(transport: ConnectionTransport, options: BrowserOptions): Promise<BidiBrowser> {\n    return BidiBrowser.connect(this.attribution.playwright, transport, options);\n  }\n\n  override doRewriteStartupLog(error: ProtocolError): ProtocolError {\n    if (!error.logs)\n      return error;\n    // https://github.com/microsoft/playwright/issues/6500\n    if (error.logs.includes(`as root in a regular user's session is not supported.`))\n      error.logs = '\\n' + wrapInASCIIBox(`Firefox is unable to launch if the $HOME folder isn't owned by the current user.\\nWorkaround: Set the HOME=/root environment variable${process.env.GITHUB_ACTION ? ' in your GitHub Actions workflow file' : ''} when running Playwright.`, 1);\n    if (error.logs.includes('no DISPLAY environment variable specified'))\n      error.logs = '\\n' + wrapInASCIIBox(kNoXServerRunningError, 1);\n    return error;\n  }\n\n  override amendEnvironment(env: Env, userDataDir: string, executable: string, browserArguments: string[]): Env {\n    if (!path.isAbsolute(os.homedir()))\n      throw new Error(`Cannot launch Firefox with relative home directory. Did you set ${os.platform() === 'win32' ? 'USERPROFILE' : 'HOME'} to a relative path?`);\n    if (os.platform() === 'linux') {\n      // Always remove SNAP_NAME and SNAP_INSTANCE_NAME env variables since they\n      // confuse Firefox: in our case, builds never come from SNAP.\n      // See https://github.com/microsoft/playwright/issues/20555\n      return { ...env, SNAP_NAME: undefined, SNAP_INSTANCE_NAME: undefined };\n    }\n    return env;\n  }\n\n  override attemptToGracefullyCloseBrowser(transport: ConnectionTransport): void {\n    transport.send({ method: 'browser.close', params: {}, id: kBrowserCloseMessageId });\n  }\n\n  override defaultArgs(options: types.LaunchOptions, isPersistent: boolean, userDataDir: string): string[] {\n    const { args = [], headless } = options;\n    const userDataDirArg = args.find(arg => arg.startsWith('-profile') || arg.startsWith('--profile'));\n    if (userDataDirArg)\n      throw this._createUserDataDirArgMisuseError('--profile');\n    const firefoxArguments = ['--remote-debugging-port=0'];\n    if (headless)\n      firefoxArguments.push('--headless');\n    else\n      firefoxArguments.push('--foreground');\n    firefoxArguments.push(`--profile`, userDataDir);\n    firefoxArguments.push(...args);\n    // TODO: make ephemeral context work without this argument.\n    firefoxArguments.push('about:blank');\n    // if (isPersistent)\n    //   firefoxArguments.push('about:blank');\n    // else\n    //   firefoxArguments.push('-silent');\n    return firefoxArguments;\n  }\n\n  override readyState(options: types.LaunchOptions): BrowserReadyState | undefined {\n    assert(options.useWebSocket);\n    return new BidiReadyState();\n  }\n}\n\nclass BidiReadyState implements BrowserReadyState {\n  private readonly _wsEndpoint = new ManualPromise<string|undefined>();\n\n  onBrowserOutput(message: string): void {\n    // Bidi WebSocket in Firefox.\n    const match = message.match(/WebDriver BiDi listening on (ws:\\/\\/.*)$/);\n    if (match)\n      this._wsEndpoint.resolve(match[1] + '/session');\n  }\n  onBrowserExit(): void {\n    // Unblock launch when browser prematurely exits.\n    this._wsEndpoint.resolve(undefined);\n  }\n  async waitUntilReady(): Promise<{ wsEndpoint?: string }> {\n    const wsEndpoint = await this._wsEndpoint;\n    return { wsEndpoint };\n  }\n}\n"],"mappings":"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"}