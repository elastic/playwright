{"version":3,"file":"inMemorySnapshotter.js","names":["_snapshotStorage","require","_snapshotter","_harTracer","_utils","InMemorySnapshotter","constructor","context","_blobs","Map","_snapshotReadyPromises","_storage","_snapshotCount","Snapshotter","HarTracer","content","includeTraceInfo","recordRequestOverrides","waitForContentOnStop","SnapshotStorage","initialize","start","omitScripts","reset","flush","stop","dispose","captureSnapshot","page","callId","snapshotName","element","has","Error","catch","promise","ManualPromise","set","onEntryStarted","entry","onEntryFinished","addResource","onContentBlob","sha1","buffer","onSnapshotterBlob","blob","onFrameSnapshot","snapshot","_this$_snapshotReadyP","renderer","addFrameSnapshot","get","resolve","resourceContentForTest","snapshotCount","exports"],"sources":["../../../../src/server/trace/test/inMemorySnapshotter.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { BrowserContext } from '../../browserContext';\nimport type { Page } from '../../page';\nimport type { FrameSnapshot } from '@trace/snapshot';\nimport type { SnapshotRenderer } from '../../../../../trace-viewer/src/snapshotRenderer';\nimport { SnapshotStorage } from '../../../../../trace-viewer/src/snapshotStorage';\nimport type { SnapshotterBlob, SnapshotterDelegate } from '../recorder/snapshotter';\nimport { Snapshotter } from '../recorder/snapshotter';\nimport type { ElementHandle } from '../../dom';\nimport type { HarTracerDelegate } from '../../har/harTracer';\nimport { HarTracer } from '../../har/harTracer';\nimport type * as har from '@trace/har';\nimport { ManualPromise } from '../../../utils';\n\nexport class InMemorySnapshotter implements SnapshotterDelegate, HarTracerDelegate {\n  private _blobs = new Map<string, Buffer>();\n  private _snapshotter: Snapshotter;\n  private _harTracer: HarTracer;\n  private _snapshotReadyPromises = new Map<string, ManualPromise<SnapshotRenderer>>();\n  private _storage: SnapshotStorage;\n  private _snapshotCount = 0;\n\n  constructor(context: BrowserContext) {\n    this._snapshotter = new Snapshotter(context, this);\n    this._harTracer = new HarTracer(context, null, this, { content: 'attach', includeTraceInfo: true, recordRequestOverrides: false, waitForContentOnStop: false });\n    this._storage = new SnapshotStorage();\n  }\n\n  async initialize(): Promise<void> {\n    await this._snapshotter.start();\n    this._harTracer.start({ omitScripts: true });\n  }\n\n  async reset() {\n    await this._snapshotter.reset();\n    await this._harTracer.flush();\n    this._harTracer.stop();\n    this._harTracer.start({ omitScripts: true });\n  }\n\n  async dispose() {\n    this._snapshotter.dispose();\n    await this._harTracer.flush();\n    this._harTracer.stop();\n  }\n\n  async captureSnapshot(page: Page, callId: string, snapshotName: string, element?: ElementHandle): Promise<SnapshotRenderer> {\n    if (this._snapshotReadyPromises.has(snapshotName))\n      throw new Error('Duplicate snapshot name: ' + snapshotName);\n\n    this._snapshotter.captureSnapshot(page, callId, snapshotName, element).catch(() => {});\n    const promise = new ManualPromise<SnapshotRenderer>();\n    this._snapshotReadyPromises.set(snapshotName, promise);\n    return promise;\n  }\n\n  onEntryStarted(entry: har.Entry) {\n  }\n\n  onEntryFinished(entry: har.Entry) {\n    this._storage.addResource(entry);\n  }\n\n  onContentBlob(sha1: string, buffer: Buffer) {\n    this._blobs.set(sha1, buffer);\n  }\n\n  onSnapshotterBlob(blob: SnapshotterBlob): void {\n    this._blobs.set(blob.sha1, blob.buffer);\n  }\n\n  onFrameSnapshot(snapshot: FrameSnapshot): void {\n    ++this._snapshotCount;\n    const renderer = this._storage.addFrameSnapshot(snapshot);\n    this._snapshotReadyPromises.get(snapshot.snapshotName || '')?.resolve(renderer);\n  }\n\n  async resourceContentForTest(sha1: string): Promise<Buffer | undefined> {\n    return this._blobs.get(sha1);\n  }\n\n  snapshotCount() {\n    return this._snapshotCount;\n  }\n}\n"],"mappings":"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"}