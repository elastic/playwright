{"version":3,"file":"snapshotter.js","names":["_browserContext","require","_page","_eventsHelper","_debugLogger","_snapshotterInjected","_utils","_utilsBundle","Snapshotter","constructor","context","delegate","_context","_delegate","_eventListeners","_snapshotStreamer","_initialized","_started","guid","createGuid","started","start","_initialize","reset","_runInAllFrames","stop","resetForReuse","page","pages","_onPage","eventsHelper","addEventListener","BrowserContext","Events","Page","bind","javaScriptEnabled","_options","initScript","frameSnapshotStreamer","undefined","addInitScript","expression","frames","push","Promise","all","map","frame","nonStallingRawEvaluateInExistingMainContext","catch","e","debugLogger","log","dispose","removeEventListeners","captureSnapshot","callId","snapshotName","element","JSON","stringify","callFunctionNoReply","customEvent","CustomEvent","bubbles","cancelable","detail","composed","dispatchEvent","snapshots","data","snapshot","pageId","frameId","frameUrl","url","doctype","html","viewport","timestamp","monotonicTime","collectionTime","resourceOverrides","isMainFrame","mainFrame","content","contentType","buffer","Buffer","from","sha1","calculateSha1","mime","getExtension","onSnapshotterBlob","ref","onFrameSnapshot","_annotateFrameHierarchy","FrameAttached","frameElement","parent","parentFrame","_mainContext","evaluate","snapshotStreamer","window","markIframe","exports"],"sources":["../../../../src/server/trace/recorder/snapshotter.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { BrowserContext } from '../../browserContext';\nimport { Page } from '../../page';\nimport type { RegisteredListener } from '../../../utils/eventsHelper';\nimport { eventsHelper } from '../../../utils/eventsHelper';\nimport { debugLogger } from '../../../utils/debugLogger';\nimport type { Frame } from '../../frames';\nimport type { SnapshotData } from './snapshotterInjected';\nimport { frameSnapshotStreamer } from './snapshotterInjected';\nimport { calculateSha1, createGuid, monotonicTime } from '../../../utils';\nimport type { FrameSnapshot } from '@trace/snapshot';\nimport type { ElementHandle } from '../../dom';\nimport { mime } from '../../../utilsBundle';\n\nexport type SnapshotterBlob = {\n  buffer: Buffer,\n  sha1: string,\n};\n\nexport interface SnapshotterDelegate {\n  onSnapshotterBlob(blob: SnapshotterBlob): void;\n  onFrameSnapshot(snapshot: FrameSnapshot): void;\n}\n\nexport class Snapshotter {\n  private _context: BrowserContext;\n  private _delegate: SnapshotterDelegate;\n  private _eventListeners: RegisteredListener[] = [];\n  private _snapshotStreamer: string;\n  private _initialized = false;\n  private _started = false;\n\n  constructor(context: BrowserContext, delegate: SnapshotterDelegate) {\n    this._context = context;\n    this._delegate = delegate;\n    const guid = createGuid();\n    this._snapshotStreamer = '__playwright_snapshot_streamer_' + guid;\n  }\n\n  started(): boolean {\n    return this._started;\n  }\n\n  async start() {\n    this._started = true;\n    if (!this._initialized) {\n      this._initialized = true;\n      await this._initialize();\n    }\n    await this.reset();\n  }\n\n  async reset() {\n    if (this._started)\n      await this._runInAllFrames(`window[\"${this._snapshotStreamer}\"].reset()`);\n  }\n\n  async stop() {\n    this._started = false;\n  }\n\n  resetForReuse() {\n    // Next time we start recording, we will call addInitScript again.\n    this._initialized = false;\n  }\n\n  async _initialize() {\n    for (const page of this._context.pages())\n      this._onPage(page);\n    this._eventListeners = [\n      eventsHelper.addEventListener(this._context, BrowserContext.Events.Page, this._onPage.bind(this)),\n    ];\n\n    const { javaScriptEnabled } = this._context._options;\n    const initScript = `(${frameSnapshotStreamer})(\"${this._snapshotStreamer}\", ${javaScriptEnabled || javaScriptEnabled === undefined})`;\n    await this._context.addInitScript(initScript);\n    await this._runInAllFrames(initScript);\n  }\n\n  private async _runInAllFrames(expression: string) {\n    const frames = [];\n    for (const page of this._context.pages())\n      frames.push(...page.frames());\n    await Promise.all(frames.map(frame => {\n      return frame.nonStallingRawEvaluateInExistingMainContext(expression).catch(e => debugLogger.log('error', e));\n    }));\n  }\n\n  dispose() {\n    eventsHelper.removeEventListeners(this._eventListeners);\n  }\n\n  async captureSnapshot(page: Page, callId: string, snapshotName: string, element?: ElementHandle): Promise<void> {\n    // Prepare expression synchronously.\n    const expression = `window[\"${this._snapshotStreamer}\"].captureSnapshot(${JSON.stringify(snapshotName)})`;\n\n    // In a best-effort manner, without waiting for it, mark target element.\n    element?.callFunctionNoReply((element: Element, callId: string) => {\n      const customEvent = new CustomEvent('__playwright_target__', {\n        bubbles: true,\n        cancelable: true,\n        detail: callId,\n        composed: true,\n      });\n      element.dispatchEvent(customEvent);\n    }, callId);\n\n    // In each frame, in a non-stalling manner, capture the snapshots.\n    const snapshots = page.frames().map(async frame => {\n      const data = await frame.nonStallingRawEvaluateInExistingMainContext(expression).catch(e => debugLogger.log('error', e)) as SnapshotData;\n      // Something went wrong -> bail out, our snapshots are best-efforty.\n      if (!data || !this._started)\n        return;\n\n      const snapshot: FrameSnapshot = {\n        callId,\n        snapshotName,\n        pageId: page.guid,\n        frameId: frame.guid,\n        frameUrl: data.url,\n        doctype: data.doctype,\n        html: data.html,\n        viewport: data.viewport,\n        timestamp: monotonicTime(),\n        collectionTime: data.collectionTime,\n        resourceOverrides: [],\n        isMainFrame: page.mainFrame() === frame\n      };\n      for (const { url, content, contentType } of data.resourceOverrides) {\n        if (typeof content === 'string') {\n          const buffer = Buffer.from(content);\n          const sha1 = calculateSha1(buffer) + '.' + (mime.getExtension(contentType) || 'dat');\n          this._delegate.onSnapshotterBlob({ sha1, buffer });\n          snapshot.resourceOverrides.push({ url, sha1 });\n        } else {\n          snapshot.resourceOverrides.push({ url, ref: content });\n        }\n      }\n      this._delegate.onFrameSnapshot(snapshot);\n    });\n    await Promise.all(snapshots);\n  }\n\n  private _onPage(page: Page) {\n    // Annotate frame hierarchy so that snapshots could include frame ids.\n    for (const frame of page.frames())\n      this._annotateFrameHierarchy(frame);\n    this._eventListeners.push(eventsHelper.addEventListener(page, Page.Events.FrameAttached, frame => this._annotateFrameHierarchy(frame)));\n  }\n\n  private async _annotateFrameHierarchy(frame: Frame) {\n    try {\n      const frameElement = await frame.frameElement();\n      const parent = frame.parentFrame();\n      if (!parent)\n        return;\n      const context = await parent._mainContext();\n      await context?.evaluate(({ snapshotStreamer, frameElement, frameId }) => {\n        (window as any)[snapshotStreamer].markIframe(frameElement, frameId);\n      }, { snapshotStreamer: this._snapshotStreamer, frameElement, frameId: frame.guid });\n      frameElement.dispose();\n    } catch (e) {\n    }\n  }\n}\n"],"mappings":"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"}