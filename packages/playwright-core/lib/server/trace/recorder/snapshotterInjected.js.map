{"version":3,"file":"snapshotterInjected.js","names":["frameSnapshotStreamer","snapshotStreamer","removeNoScript","window","kShadowAttribute","kValueAttribute","kCheckedAttribute","kSelectedAttribute","kScrollTopAttribute","kScrollLeftAttribute","kStyleSheetAttribute","kTargetAttribute","kCustomElementsAttribute","kCurrentSrcAttribute","kSnapshotFrameId","Symbol","kCachedData","kEndOfList","resetCachedData","obj","ensureCachedData","removeHash","url","u","URL","hash","toString","e","Streamer","constructor","_lastSnapshotNumber","_staleStyleSheets","Set","_readingStyleSheet","_fakeBase","_observer","invalidateCSSGroupingRule","rule","parentStyleSheet","_invalidateStyleSheet","_interceptNativeMethod","CSSStyleSheet","prototype","sheet","_interceptNativeGetter","CSSGroupingRule","_interceptNativeAsyncMethod","document","createElement","MutationObserver","list","_handleMutations","observerConfig","attributes","subtree","observe","_refreshListenersWhenNeeded","_refreshListeners","customEventName","seenEvent","handleCustomEvent","addEventListener","observer","entries","newDocumentElement","some","entry","Array","from","addedNodes","includes","documentElement","dispatchEvent","CustomEvent","childList","event","detail","callId","composedPath","__playwright_target__","method","cb","native","args","result","call","prop","descriptor","Object","getOwnPropertyDescriptor","defineProperty","get","mutation","target","attributesCached","undefined","add","_updateStyleElementStyleSheetTextIfNeeded","forceText","data","has","cssText","delete","_getSheetText","_updateLinkStyleSheetTextIfNeeded","snapshotNumber","cssRef","markIframe","iframeElement","frameId","reset","clear","visitNode","node","nodeType","Node","ELEMENT_NODE","element","shadowRoot","child","firstChild","nextSibling","__sanitizeMetaAttribute","name","value","httpEquiv","toLowerCase","type","params","split","length","charsetParamIdx","findIndex","param","trim","startsWith","join","_sanitizeUrl","_sanitizeSrcSet","srcset","map","src","spaceIndex","lastIndexOf","substring","_resolveUrl","base","href","_getSheetBase","rootSheet","ownerNode","baseURI","rules","cssRules","push","captureSnapshot","timestamp","performance","now","nodeCounter","shadowDomNesting","headNesting","takeRecords","definedCustomElements","nodeName","DOCUMENT_FRAGMENT_NODE","TEXT_NODE","_getAttribute","rel","getAttribute","values","equals","cached","extraNodes","expectValue","checkAndReturn","n","ref","nodeValue","textContent","attrs","visitChild","snapshot","visitChildStyleSheet","visitStyleSheet","_window$customElement","localName","customElements","checked","selected","scrollTop","scrollLeft","setAttribute","documentOrShadowRoot","ownerDocument","adoptedStyleSheets","size","currentSrc","i","keys","pop","oldCSSText","html","doctype","resourceOverrides","viewport","width","innerWidth","height","innerHeight","location","collectionTime","content","contentType"],"sources":["../../../../src/server/trace/recorder/snapshotterInjected.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { NodeSnapshot } from '@trace/snapshot';\n\nexport type SnapshotData = {\n  doctype?: string,\n  html: NodeSnapshot,\n  resourceOverrides: {\n    url: string,\n    // String is the content. Number is \"x snapshots ago\", same url.\n    content: string | number,\n    contentType: 'text/css'\n  }[],\n  viewport: { width: number, height: number },\n  url: string,\n  timestamp: number,\n  collectionTime: number,\n};\n\nexport function frameSnapshotStreamer(snapshotStreamer: string, removeNoScript: boolean) {\n  // Communication with Playwright.\n  if ((window as any)[snapshotStreamer])\n    return;\n\n  // Attributes present in the snapshot.\n  const kShadowAttribute = '__playwright_shadow_root_';\n  const kValueAttribute = '__playwright_value_';\n  const kCheckedAttribute = '__playwright_checked_';\n  const kSelectedAttribute = '__playwright_selected_';\n  const kScrollTopAttribute = '__playwright_scroll_top_';\n  const kScrollLeftAttribute = '__playwright_scroll_left_';\n  const kStyleSheetAttribute = '__playwright_style_sheet_';\n  const kTargetAttribute = '__playwright_target__';\n  const kCustomElementsAttribute = '__playwright_custom_elements__';\n  const kCurrentSrcAttribute = '__playwright_current_src__';\n\n  // Symbols for our own info on Nodes/StyleSheets.\n  const kSnapshotFrameId = Symbol('__playwright_snapshot_frameid_');\n  const kCachedData = Symbol('__playwright_snapshot_cache_');\n  const kEndOfList = Symbol('__playwright_end_of_list_');\n  type CachedData = {\n    cached?: any[], // Cached values to determine whether the snapshot will be the same.\n    ref?: [number, number], // Previous snapshotNumber and nodeIndex.\n    attributesCached?: boolean, // Whether node attributes have not changed.\n    cssText?: string, // Text for stylesheets.\n    cssRef?: number, // Previous snapshotNumber for overridden stylesheets.\n  };\n\n  function resetCachedData(obj: any) {\n    delete obj[kCachedData];\n  }\n\n  function ensureCachedData(obj: any): CachedData {\n    if (!obj[kCachedData])\n      obj[kCachedData] = {};\n    return obj[kCachedData];\n  }\n\n  function removeHash(url: string) {\n    try {\n      const u = new URL(url);\n      u.hash = '';\n      return u.toString();\n    } catch (e) {\n      return url;\n    }\n  }\n\n  class Streamer {\n    private _lastSnapshotNumber = 0;\n    private _staleStyleSheets = new Set<CSSStyleSheet>();\n    private _readingStyleSheet = false;  // To avoid invalidating due to our own reads.\n    private _fakeBase: HTMLBaseElement;\n    private _observer: MutationObserver;\n\n    constructor() {\n      const invalidateCSSGroupingRule = (rule: CSSGroupingRule) => {\n        if (rule.parentStyleSheet)\n          this._invalidateStyleSheet(rule.parentStyleSheet);\n      };\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'insertRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'deleteRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'addRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'removeRule', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeGetter(window.CSSStyleSheet.prototype, 'rules', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeGetter(window.CSSStyleSheet.prototype, 'cssRules', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSStyleSheet.prototype, 'replaceSync', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n      this._interceptNativeMethod(window.CSSGroupingRule.prototype, 'insertRule', invalidateCSSGroupingRule);\n      this._interceptNativeMethod(window.CSSGroupingRule.prototype, 'deleteRule', invalidateCSSGroupingRule);\n      this._interceptNativeGetter(window.CSSGroupingRule.prototype, 'cssRules', invalidateCSSGroupingRule);\n      this._interceptNativeAsyncMethod(window.CSSStyleSheet.prototype, 'replace', (sheet: CSSStyleSheet) => this._invalidateStyleSheet(sheet));\n\n      this._fakeBase = document.createElement('base');\n\n      this._observer = new MutationObserver(list => this._handleMutations(list));\n      const observerConfig = { attributes: true, subtree: true };\n      this._observer.observe(document, observerConfig);\n      this._refreshListenersWhenNeeded();\n    }\n\n    private _refreshListenersWhenNeeded() {\n      this._refreshListeners();\n\n      const customEventName = '__playwright_snapshotter_global_listeners_check__';\n\n      let seenEvent = false;\n      const handleCustomEvent = () => seenEvent = true;\n      window.addEventListener(customEventName, handleCustomEvent);\n\n      const observer = new MutationObserver(entries => {\n        // Check for new documentElement in case we need to reinstall document listeners.\n        const newDocumentElement = entries.some(entry => Array.from(entry.addedNodes).includes(document.documentElement));\n        if (newDocumentElement) {\n          // New documentElement - let's check whether listeners are still here.\n          seenEvent = false;\n          window.dispatchEvent(new CustomEvent(customEventName));\n          if (!seenEvent) {\n            // Listener did not fire. Reattach the listener and notify.\n            window.addEventListener(customEventName, handleCustomEvent);\n            this._refreshListeners();\n          }\n        }\n      });\n      observer.observe(document, { childList: true });\n    }\n\n    private _refreshListeners() {\n      (document as any).addEventListener('__playwright_target__', (event: CustomEvent) => {\n        if (!event.detail)\n          return;\n        const callId = event.detail as string;\n        (event.composedPath()[0] as any).__playwright_target__ = callId;\n      });\n    }\n\n    private _interceptNativeMethod(obj: any, method: string, cb: (thisObj: any, result: any) => void) {\n      const native = obj[method] as Function;\n      if (!native)\n        return;\n      obj[method] = function(...args: any[]) {\n        const result = native.call(this, ...args);\n        cb(this, result);\n        return result;\n      };\n    }\n\n    private _interceptNativeAsyncMethod(obj: any, method: string, cb: (thisObj: any, result: any) => void) {\n      const native = obj[method] as Function;\n      if (!native)\n        return;\n      obj[method] = async function(...args: any[]) {\n        const result = await native.call(this, ...args);\n        cb(this, result);\n        return result;\n      };\n    }\n\n    private _interceptNativeGetter(obj: any, prop: string, cb: (thisObj: any, result: any) => void) {\n      const descriptor = Object.getOwnPropertyDescriptor(obj, prop)!;\n      Object.defineProperty(obj, prop, {\n        ...descriptor,\n        get: function() {\n          const result = descriptor.get!.call(this);\n          cb(this, result);\n          return result;\n        },\n      });\n    }\n\n    private _handleMutations(list: MutationRecord[]) {\n      for (const mutation of list)\n        ensureCachedData(mutation.target).attributesCached = undefined;\n    }\n\n    private _invalidateStyleSheet(sheet: CSSStyleSheet) {\n      if (this._readingStyleSheet)\n        return;\n      this._staleStyleSheets.add(sheet);\n    }\n\n    private _updateStyleElementStyleSheetTextIfNeeded(sheet: CSSStyleSheet, forceText?: boolean): string | undefined {\n      const data = ensureCachedData(sheet);\n      if (this._staleStyleSheets.has(sheet) || (forceText && data.cssText === undefined)) {\n        this._staleStyleSheets.delete(sheet);\n        try {\n          data.cssText = this._getSheetText(sheet);\n        } catch (e) {\n          // Sometimes we cannot access cross-origin stylesheets.\n          data.cssText = '';\n        }\n      }\n      return data.cssText;\n    }\n\n    // Returns either content, ref, or no override.\n    private _updateLinkStyleSheetTextIfNeeded(sheet: CSSStyleSheet, snapshotNumber: number): string | number | undefined {\n      const data = ensureCachedData(sheet);\n      if (this._staleStyleSheets.has(sheet)) {\n        this._staleStyleSheets.delete(sheet);\n        try {\n          data.cssText = this._getSheetText(sheet);\n          data.cssRef = snapshotNumber;\n          return data.cssText;\n        } catch (e) {\n          // Sometimes we cannot access cross-origin stylesheets.\n        }\n      }\n      return data.cssRef === undefined ? undefined : snapshotNumber - data.cssRef;\n    }\n\n    markIframe(iframeElement: HTMLIFrameElement | HTMLFrameElement, frameId: string) {\n      (iframeElement as any)[kSnapshotFrameId] = frameId;\n    }\n\n    reset() {\n      this._staleStyleSheets.clear();\n\n      const visitNode = (node: Node | ShadowRoot) => {\n        resetCachedData(node);\n        if (node.nodeType === Node.ELEMENT_NODE) {\n          const element = node as Element;\n          if (element.shadowRoot)\n            visitNode(element.shadowRoot);\n        }\n        for (let child = node.firstChild; child; child = child.nextSibling)\n          visitNode(child);\n      };\n      visitNode(document.documentElement);\n      visitNode(this._fakeBase);\n    }\n\n    private __sanitizeMetaAttribute(name: string, value: string, httpEquiv: string) {\n      if (name === 'charset')\n        return 'utf-8';\n\n      if (httpEquiv.toLowerCase() !== 'content-type' || name !== 'content')\n        return value;\n\n      const [type, ...params] = value.split(';');\n      if (type !== 'text/html' || params.length <= 0)\n        return value;\n\n      const charsetParamIdx = params.findIndex(param => param.trim().startsWith('charset='));\n      if (charsetParamIdx > -1)\n        params[charsetParamIdx] = 'charset=utf-8';\n\n      return `${type}; ${params.join('; ')}`;\n    }\n\n    private _sanitizeUrl(url: string): string {\n      if (url.startsWith('javascript:') || url.startsWith('vbscript:'))\n        return '';\n      return url;\n    }\n\n    private _sanitizeSrcSet(srcset: string): string {\n      return srcset.split(',').map(src => {\n        src = src.trim();\n        const spaceIndex = src.lastIndexOf(' ');\n        if (spaceIndex === -1)\n          return this._sanitizeUrl(src);\n        return this._sanitizeUrl(src.substring(0, spaceIndex).trim()) + src.substring(spaceIndex);\n      }).join(', ');\n    }\n\n    private _resolveUrl(base: string, url: string): string {\n      if (url === '')\n        return '';\n      try {\n        return new URL(url, base).href;\n      } catch (e) {\n        return url;\n      }\n    }\n\n    private _getSheetBase(sheet: CSSStyleSheet): string {\n      let rootSheet = sheet;\n      while (rootSheet.parentStyleSheet)\n        rootSheet = rootSheet.parentStyleSheet;\n      if (rootSheet.ownerNode)\n        return rootSheet.ownerNode.baseURI;\n      return document.baseURI;\n    }\n\n    private _getSheetText(sheet: CSSStyleSheet): string {\n      this._readingStyleSheet = true;\n      try {\n        const rules: string[] = [];\n        for (const rule of sheet.cssRules)\n          rules.push(rule.cssText);\n        return rules.join('\\n');\n      } finally {\n        this._readingStyleSheet = false;\n      }\n    }\n\n    captureSnapshot(): SnapshotData | undefined {\n      const timestamp = performance.now();\n      const snapshotNumber = ++this._lastSnapshotNumber;\n      let nodeCounter = 0;\n      let shadowDomNesting = 0;\n      let headNesting = 0;\n\n      // Ensure we are up to date.\n      this._handleMutations(this._observer.takeRecords());\n\n      const definedCustomElements = new Set<string>();\n\n      const visitNode = (node: Node | ShadowRoot): { equals: boolean, n: NodeSnapshot } | undefined => {\n        const nodeType = node.nodeType;\n        const nodeName = nodeType === Node.DOCUMENT_FRAGMENT_NODE ? 'template' : node.nodeName;\n\n        if (nodeType !== Node.ELEMENT_NODE &&\n            nodeType !== Node.DOCUMENT_FRAGMENT_NODE &&\n            nodeType !== Node.TEXT_NODE)\n          return;\n        if (nodeName === 'SCRIPT')\n          return;\n        // Don't preload resources.\n        if (nodeName === 'LINK' && nodeType === Node.ELEMENT_NODE) {\n          const rel = (node as Element).getAttribute('rel')?.toLowerCase();\n          if (rel === 'preload' || rel === 'prefetch')\n            return;\n        }\n        if (removeNoScript && nodeName === 'NOSCRIPT')\n          return;\n        if (nodeName === 'META' && (node as HTMLMetaElement).httpEquiv.toLowerCase() === 'content-security-policy')\n          return;\n        // Skip iframes which are inside document's head as they are not visible.\n        // See https://github.com/microsoft/playwright/issues/12005.\n        if ((nodeName === 'IFRAME' || nodeName === 'FRAME') && headNesting)\n          return;\n\n        const data = ensureCachedData(node);\n        const values: any[] = [];\n        let equals = !!data.cached;\n        let extraNodes = 0;\n\n        const expectValue = (value: any) => {\n          equals = equals && data.cached![values.length] === value;\n          values.push(value);\n        };\n\n        const checkAndReturn = (n: NodeSnapshot): { equals: boolean, n: NodeSnapshot } => {\n          data.attributesCached = true;\n          if (equals)\n            return { equals: true, n: [[snapshotNumber - data.ref![0], data.ref![1]]] };\n          nodeCounter += extraNodes;\n          data.ref = [snapshotNumber, nodeCounter++];\n          data.cached = values;\n          return { equals: false, n };\n        };\n\n        if (nodeType === Node.TEXT_NODE) {\n          const value = node.nodeValue || '';\n          expectValue(value);\n          return checkAndReturn(value);\n        }\n\n        if (nodeName === 'STYLE') {\n          const sheet = (node as HTMLStyleElement).sheet;\n          let cssText: string | undefined;\n          if (sheet)\n            cssText = this._updateStyleElementStyleSheetTextIfNeeded(sheet);\n          cssText = cssText || node.textContent || '';\n          expectValue(cssText);\n          // Compensate for the extra 'cssText' text node.\n          extraNodes++;\n          return checkAndReturn([nodeName, {}, cssText]);\n        }\n\n        const attrs: { [attr: string]: string } = {};\n        const result: NodeSnapshot = [nodeName, attrs];\n\n        const visitChild = (child: Node) => {\n          const snapshot = visitNode(child);\n          if (snapshot) {\n            result.push(snapshot.n);\n            expectValue(child);\n            equals = equals && snapshot.equals;\n          }\n        };\n\n        const visitChildStyleSheet = (child: CSSStyleSheet) => {\n          const snapshot = visitStyleSheet(child);\n          if (snapshot) {\n            result.push(snapshot.n);\n            expectValue(child);\n            equals = equals && snapshot.equals;\n          }\n        };\n\n        if (nodeType === Node.DOCUMENT_FRAGMENT_NODE)\n          attrs[kShadowAttribute] = 'open';\n\n        if (nodeType === Node.ELEMENT_NODE) {\n          const element = node as Element;\n          if (element.localName.includes('-') && window.customElements?.get(element.localName))\n            definedCustomElements.add(element.localName);\n          if (nodeName === 'INPUT' || nodeName === 'TEXTAREA') {\n            const value = (element as HTMLInputElement).value;\n            expectValue(kValueAttribute);\n            expectValue(value);\n            attrs[kValueAttribute] = value;\n          }\n          if (nodeName === 'INPUT' && ['checkbox', 'radio'].includes((element as HTMLInputElement).type)) {\n            const value = (element as HTMLInputElement).checked ? 'true' : 'false';\n            expectValue(kCheckedAttribute);\n            expectValue(value);\n            attrs[kCheckedAttribute] = value;\n          }\n          if (nodeName === 'OPTION') {\n            const value = (element as HTMLOptionElement).selected ? 'true' : 'false';\n            expectValue(kSelectedAttribute);\n            expectValue(value);\n            attrs[kSelectedAttribute] = value;\n          }\n          if (element.scrollTop) {\n            expectValue(kScrollTopAttribute);\n            expectValue(element.scrollTop);\n            attrs[kScrollTopAttribute] = '' + element.scrollTop;\n          }\n          if (element.scrollLeft) {\n            expectValue(kScrollLeftAttribute);\n            expectValue(element.scrollLeft);\n            attrs[kScrollLeftAttribute] = '' + element.scrollLeft;\n          }\n          if (element.shadowRoot) {\n            ++shadowDomNesting;\n            visitChild(element.shadowRoot);\n            --shadowDomNesting;\n          }\n          if ('__playwright_target__' in element) {\n            expectValue(kTargetAttribute);\n            expectValue(element['__playwright_target__']);\n            attrs[kTargetAttribute] = element['__playwright_target__'] as string;\n          }\n        }\n\n        if (nodeName === 'HEAD') {\n          ++headNesting;\n          // Insert fake <base> first, to ensure all <link> elements use the proper base uri.\n          this._fakeBase.setAttribute('href', document.baseURI);\n          visitChild(this._fakeBase);\n        }\n        for (let child = node.firstChild; child; child = child.nextSibling)\n          visitChild(child);\n        if (nodeName === 'HEAD')\n          --headNesting;\n        expectValue(kEndOfList);\n        let documentOrShadowRoot = null;\n        if (node.ownerDocument!.documentElement === node)\n          documentOrShadowRoot = node.ownerDocument;\n        else if (node.nodeType === Node.DOCUMENT_FRAGMENT_NODE)\n          documentOrShadowRoot = node;\n        if (documentOrShadowRoot) {\n          for (const sheet of (documentOrShadowRoot as any).adoptedStyleSheets || [])\n            visitChildStyleSheet(sheet);\n          expectValue(kEndOfList);\n        }\n\n        // Process iframe src attribute before bailing out since it depends on a symbol, not the DOM.\n        if (nodeName === 'IFRAME' || nodeName === 'FRAME') {\n          const element = node as Element;\n          const frameId = (element as any)[kSnapshotFrameId];\n          const name = 'src';\n          const value = frameId ? `/snapshot/${frameId}` : '';\n          expectValue(name);\n          expectValue(value);\n          attrs[name] = value;\n        }\n\n        // Process custom elements before bailing out since they depend on JS, not the DOM.\n        if (nodeName === 'BODY' && definedCustomElements.size) {\n          const value = [...definedCustomElements].join(',');\n          expectValue(kCustomElementsAttribute);\n          expectValue(value);\n          attrs[kCustomElementsAttribute] = value;\n        }\n\n        // Process currentSrc before bailing out since it depends on JS, not the DOM.\n        if (nodeName === 'IMG' || nodeName === 'PICTURE') {\n          const value = nodeName === 'PICTURE' ? '' : this._sanitizeUrl((node as HTMLImageElement).currentSrc);\n          expectValue(kCurrentSrcAttribute);\n          expectValue(value);\n          attrs[kCurrentSrcAttribute] = value;\n        }\n\n        // We can skip attributes comparison because nothing else has changed,\n        // and mutation observer didn't tell us about the attributes.\n        if (equals && data.attributesCached && !shadowDomNesting)\n          return checkAndReturn(result);\n\n        if (nodeType === Node.ELEMENT_NODE) {\n          const element = node as Element;\n          for (let i = 0; i < element.attributes.length; i++) {\n            const name = element.attributes[i].name;\n            if (nodeName === 'LINK' && name === 'integrity')\n              continue;\n            if (nodeName === 'IFRAME' && (name === 'src' || name === 'srcdoc' || name === 'sandbox'))\n              continue;\n            if (nodeName === 'FRAME' && name === 'src')\n              continue;\n            let value = element.attributes[i].value;\n            if (nodeName === 'META')\n              value = this.__sanitizeMetaAttribute(name, value, (node as HTMLMetaElement).httpEquiv);\n            else if (name === 'src' && (nodeName === 'IMG'))\n              value = this._sanitizeUrl(value);\n            else if (name === 'srcset' && (nodeName === 'IMG'))\n              value = this._sanitizeSrcSet(value);\n            else if (name === 'srcset' && (nodeName === 'SOURCE'))\n              value = this._sanitizeSrcSet(value);\n            else if (name === 'href' && (nodeName === 'LINK'))\n              value = this._sanitizeUrl(value);\n            else if (name.startsWith('on'))\n              value = '';\n            expectValue(name);\n            expectValue(value);\n            attrs[name] = value;\n          }\n          expectValue(kEndOfList);\n        }\n\n        if (result.length === 2 && !Object.keys(attrs).length)\n          result.pop();  // Remove empty attrs when there are no children.\n        return checkAndReturn(result);\n      };\n\n      const visitStyleSheet = (sheet: CSSStyleSheet): { equals: boolean, n: NodeSnapshot } => {\n        const data = ensureCachedData(sheet);\n        const oldCSSText = data.cssText;\n        const cssText = this._updateStyleElementStyleSheetTextIfNeeded(sheet, true /* forceText */)!;\n        if (cssText === oldCSSText)\n          return { equals: true, n: [[snapshotNumber - data.ref![0], data.ref![1]]] };\n        data.ref = [snapshotNumber, nodeCounter++];\n        return {\n          equals: false,\n          n: ['template', {\n            [kStyleSheetAttribute]: cssText,\n          }]\n        };\n      };\n\n      let html: NodeSnapshot;\n      if (document.documentElement) {\n        const { n } = visitNode(document.documentElement)!;\n        html = n;\n      } else {\n        html = ['html'];\n      }\n\n      const result: SnapshotData = {\n        html,\n        doctype: document.doctype ? document.doctype.name : undefined,\n        resourceOverrides: [],\n        viewport: {\n          width: window.innerWidth,\n          height: window.innerHeight,\n        },\n        url: location.href,\n        timestamp,\n        collectionTime: 0,\n      };\n\n      for (const sheet of this._staleStyleSheets) {\n        if (sheet.href === null)\n          continue;\n        const content = this._updateLinkStyleSheetTextIfNeeded(sheet, snapshotNumber);\n        if (content === undefined) {\n          // Unable to capture stylesheet contents.\n          continue;\n        }\n        const base = this._getSheetBase(sheet);\n        const url = removeHash(this._resolveUrl(base, sheet.href!));\n        result.resourceOverrides.push({ url, content, contentType: 'text/css' },);\n      }\n\n      result.collectionTime = performance.now() - result.timestamp;\n      return result;\n    }\n  }\n\n  (window as any)[snapshotStreamer] = new Streamer();\n}\n"],"mappings":"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"}