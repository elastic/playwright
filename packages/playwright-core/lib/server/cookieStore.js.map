{"version":3,"file":"cookieStore.js","names":["Cookie","constructor","data","_raw","name","matches","url","secure","protocol","hostname","domainMatches","domain","pathMatches","pathname","path","equals","other","networkCookie","updateExpiresFrom","expires","expired","Date","now","CookieStore","_nameToCookies","Map","addCookies","cookies","cookie","_addCookie","result","_cookiesIterator","push","allCookies","set","get","Set","delete","add","pruneExpired","size","exports","value","startsWith","endsWith"],"sources":["../../src/server/cookieStore.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\n\nclass Cookie {\n  private _raw: channels.NetworkCookie;\n  constructor(data: channels.NetworkCookie) {\n    this._raw = data;\n  }\n\n  name(): string {\n    return this._raw.name;\n  }\n\n  // https://datatracker.ietf.org/doc/html/rfc6265#section-5.4\n  matches(url: URL): boolean {\n    if (this._raw.secure && (url.protocol !== 'https:' && url.hostname !== 'localhost'))\n      return false;\n    if (!domainMatches(url.hostname, this._raw.domain))\n      return false;\n    if (!pathMatches(url.pathname, this._raw.path))\n      return false;\n    return true;\n  }\n\n  equals(other: Cookie) {\n    return this._raw.name === other._raw.name &&\n      this._raw.domain === other._raw.domain &&\n      this._raw.path === other._raw.path;\n  }\n\n  networkCookie(): channels.NetworkCookie {\n    return this._raw;\n  }\n\n  updateExpiresFrom(other: Cookie) {\n    this._raw.expires = other._raw.expires;\n  }\n\n  expired() {\n    if (this._raw.expires === -1)\n      return false;\n    return this._raw.expires * 1000 < Date.now();\n  }\n}\n\nexport class CookieStore {\n  private readonly _nameToCookies: Map<string, Set<Cookie>> = new Map();\n\n  addCookies(cookies: channels.NetworkCookie[]) {\n    for (const cookie of cookies)\n      this._addCookie(new Cookie(cookie));\n  }\n\n  cookies(url: URL): channels.NetworkCookie[] {\n    const result = [];\n    for (const cookie of this._cookiesIterator()) {\n      if (cookie.matches(url))\n        result.push(cookie.networkCookie());\n    }\n    return result;\n  }\n\n  allCookies(): channels.NetworkCookie[] {\n    const result = [];\n    for (const cookie of this._cookiesIterator())\n      result.push(cookie.networkCookie());\n    return result;\n  }\n\n  private _addCookie(cookie: Cookie) {\n    let set = this._nameToCookies.get(cookie.name());\n    if (!set) {\n      set = new Set();\n      this._nameToCookies.set(cookie.name(), set);\n    }\n    // https://datatracker.ietf.org/doc/html/rfc6265#section-5.3\n    for (const other of set) {\n      if (other.equals(cookie))\n        set.delete(other);\n    }\n    set.add(cookie);\n    CookieStore.pruneExpired(set);\n  }\n\n  private *_cookiesIterator(): IterableIterator<Cookie> {\n    for (const [name, cookies] of this._nameToCookies) {\n      CookieStore.pruneExpired(cookies);\n      for (const cookie of cookies)\n        yield cookie;\n      if (cookies.size === 0)\n        this._nameToCookies.delete(name);\n    }\n  }\n\n  private static pruneExpired(cookies: Set<Cookie>) {\n    for (const cookie of cookies) {\n      if (cookie.expired())\n        cookies.delete(cookie);\n    }\n  }\n}\n\nexport function domainMatches(value: string, domain: string): boolean {\n  if (value === domain)\n    return true;\n  // Only strict match is allowed if domain doesn't start with '.' (host-only-flag is true in the spec)\n  if (!domain.startsWith('.'))\n    return false;\n  value = '.' + value;\n  return value.endsWith(domain);\n}\n\nfunction pathMatches(value: string, path: string): boolean {\n  if (value === path)\n    return true;\n  if (!value.endsWith('/'))\n    value = value + '/';\n  if (!path.endsWith('/'))\n    path = path + '/';\n  return value.startsWith(path);\n}\n"],"mappings":"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"}