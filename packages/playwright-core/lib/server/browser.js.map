{"version":3,"file":"browser.js","names":["_browserContext","require","_page","_download","_instrumentation","_artifact","Browser","SdkObject","constructor","parent","options","_downloads","Map","_defaultContext","_startedClosing","_idToVideo","_contextForReuse","_closeReason","_isCollocatedWithServer","attribution","browser","instrumentation","onBrowserOpen","newContext","metadata","validateBrowserContextOptions","clientCertificatesProxy","createClientCertificatesProxyIfNeeded","context","doCreateNewContext","error","close","_clientCertificatesProxy","storageState","setStorageState","newContextForReuse","params","hash","BrowserContext","reusableContextHash","canResetForReuse","reason","needsReset","stopPendingOperations","_this$_contextForReus","_downloadCreated","page","uuid","url","suggestedFilename","download","Download","downloadsPath","set","_downloadFilenameSuggested","get","_filenameSuggested","_downloadFinished","artifact","reportFinished","Error","undefined","delete","_videoStarted","videoId","path","pageOrError","Artifact","then","Page","_video","emitOnContext","Events","VideoStarted","emit","Video","_takeVideo","video","_didClose","contexts","_browserClosed","Disconnected","onBrowserClose","browserProcess","isConnected","Promise","x","once","killForTests","kill","exports"],"sources":["../../src/server/browser.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as types from './types';\nimport type * as channels from '@protocol/channels';\nimport { BrowserContext, createClientCertificatesProxyIfNeeded, validateBrowserContextOptions } from './browserContext';\nimport { Page } from './page';\nimport { Download } from './download';\nimport type { ProxySettings } from './types';\nimport type { ChildProcess } from 'child_process';\nimport type { RecentLogsCollector } from '../utils/debugLogger';\nimport type { CallMetadata } from './instrumentation';\nimport { SdkObject } from './instrumentation';\nimport { Artifact } from './artifact';\n\nexport interface BrowserProcess {\n  onclose?: ((exitCode: number | null, signal: string | null) => void);\n  process?: ChildProcess;\n  kill(): Promise<void>;\n  close(): Promise<void>;\n}\n\nexport type BrowserOptions = {\n  name: string,\n  isChromium: boolean,\n  channel?: string,\n  artifactsDir: string;\n  downloadsPath: string,\n  tracesDir: string,\n  headful?: boolean,\n  persistent?: channels.BrowserNewContextParams,  // Undefined means no persistent context.\n  browserProcess: BrowserProcess,\n  customExecutablePath?: string;\n  proxy?: ProxySettings,\n  protocolLogger: types.ProtocolLogger,\n  browserLogsCollector: RecentLogsCollector,\n  slowMo?: number;\n  wsEndpoint?: string;  // Only there when connected over web socket.\n  originalLaunchOptions: types.LaunchOptions;\n};\n\nexport abstract class Browser extends SdkObject {\n\n  static Events = {\n    Disconnected: 'disconnected',\n  };\n\n  readonly options: BrowserOptions;\n  private _downloads = new Map<string, Download>();\n  _defaultContext: BrowserContext | null = null;\n  private _startedClosing = false;\n  readonly _idToVideo = new Map<string, { context: BrowserContext, artifact: Artifact }>();\n  private _contextForReuse: { context: BrowserContext, hash: string } | undefined;\n  _closeReason: string | undefined;\n  _isCollocatedWithServer: boolean = true;\n\n  constructor(parent: SdkObject, options: BrowserOptions) {\n    super(parent, 'browser');\n    this.attribution.browser = this;\n    this.options = options;\n    this.instrumentation.onBrowserOpen(this);\n  }\n\n  abstract doCreateNewContext(options: channels.BrowserNewContextParams): Promise<BrowserContext>;\n  abstract contexts(): BrowserContext[];\n  abstract isConnected(): boolean;\n  abstract version(): string;\n  abstract userAgent(): string;\n\n  async newContext(metadata: CallMetadata, options: channels.BrowserNewContextParams): Promise<BrowserContext> {\n    validateBrowserContextOptions(options, this.options);\n    const clientCertificatesProxy = await createClientCertificatesProxyIfNeeded(options, this.options);\n    let context;\n    try {\n      context = await this.doCreateNewContext(options);\n    } catch (error) {\n      await clientCertificatesProxy?.close();\n      throw error;\n    }\n    context._clientCertificatesProxy = clientCertificatesProxy;\n    if (options.storageState)\n      await context.setStorageState(metadata, options.storageState);\n    return context;\n  }\n\n  async newContextForReuse(params: channels.BrowserNewContextForReuseParams, metadata: CallMetadata): Promise<{ context: BrowserContext, needsReset: boolean }> {\n    const hash = BrowserContext.reusableContextHash(params);\n    if (!this._contextForReuse || hash !== this._contextForReuse.hash || !this._contextForReuse.context.canResetForReuse()) {\n      if (this._contextForReuse)\n        await this._contextForReuse.context.close({ reason: 'Context reused' });\n      this._contextForReuse = { context: await this.newContext(metadata, params), hash };\n      return { context: this._contextForReuse.context, needsReset: false };\n    }\n    await this._contextForReuse.context.stopPendingOperations('Context recreated');\n    return { context: this._contextForReuse.context, needsReset: true };\n  }\n\n  async stopPendingOperations(reason: string) {\n    await this._contextForReuse?.context?.stopPendingOperations(reason);\n  }\n\n  _downloadCreated(page: Page, uuid: string, url: string, suggestedFilename?: string) {\n    const download = new Download(page, this.options.downloadsPath || '', uuid, url, suggestedFilename);\n    this._downloads.set(uuid, download);\n  }\n\n  _downloadFilenameSuggested(uuid: string, suggestedFilename: string) {\n    const download = this._downloads.get(uuid);\n    if (!download)\n      return;\n    download._filenameSuggested(suggestedFilename);\n  }\n\n  _downloadFinished(uuid: string, error?: string) {\n    const download = this._downloads.get(uuid);\n    if (!download)\n      return;\n    download.artifact.reportFinished(error ? new Error(error) : undefined);\n    this._downloads.delete(uuid);\n  }\n\n  _videoStarted(context: BrowserContext, videoId: string, path: string, pageOrError: Promise<Page | Error>) {\n    const artifact = new Artifact(context, path);\n    this._idToVideo.set(videoId, { context, artifact });\n    pageOrError.then(page => {\n      if (page instanceof Page) {\n        page._video = artifact;\n        page.emitOnContext(BrowserContext.Events.VideoStarted, artifact);\n        page.emit(Page.Events.Video, artifact);\n      }\n    });\n  }\n\n  _takeVideo(videoId: string): Artifact | undefined {\n    const video = this._idToVideo.get(videoId);\n    this._idToVideo.delete(videoId);\n    return video?.artifact;\n  }\n\n  _didClose() {\n    for (const context of this.contexts())\n      context._browserClosed();\n    if (this._defaultContext)\n      this._defaultContext._browserClosed();\n    this.emit(Browser.Events.Disconnected);\n    this.instrumentation.onBrowserClose(this);\n  }\n\n  async close(options: { reason?: string }) {\n    if (!this._startedClosing) {\n      if (options.reason)\n        this._closeReason = options.reason;\n      this._startedClosing = true;\n      await this.options.browserProcess.close();\n    }\n    if (this.isConnected())\n      await new Promise(x => this.once(Browser.Events.Disconnected, x));\n  }\n\n  async killForTests() {\n    await this.options.browserProcess.kill();\n  }\n}\n"],"mappings":"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"}