{"version":3,"file":"recorderRunner.js","names":["_utils","require","_language","_recorderUtils","innerPerformAction","mainFrame","action","params","cb","callMetadata","id","createGuid","apiName","objectId","guid","pageId","_page","frameId","startTime","monotonicTime","endTime","type","method","log","instrumentation","onBeforeCall","e","onAfterCall","performAction","pageAliases","actionInContext","_find","pageAlias","frame","page","entries","find","alias","Error","kActionTimeout","name","url","goto","timeout","close","selector","buildFullSelector","framePath","options","toClickOptions","click","strict","modifiers","toKeyboardModifiers","shortcut","key","join","press","text","fill","files","setInputFiles","payloads","check","uncheck","values","map","value","selectOption","expect","expression","isNot","checked","expectedText","serializeExpectedTextValues","matchSubstring","normalizeWhiteSpace","expectedValue"],"sources":["../../../src/server/recorder/recorderRunner.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createGuid, monotonicTime, serializeExpectedTextValues } from '../../utils';\nimport { toClickOptions, toKeyboardModifiers } from '../codegen/language';\nimport type { ActionInContext } from '../codegen/types';\nimport type { Frame } from '../frames';\nimport type { CallMetadata } from '../instrumentation';\nimport type { Page } from '../page';\nimport { buildFullSelector } from './recorderUtils';\n\nasync function innerPerformAction(mainFrame: Frame, action: string, params: any, cb: (callMetadata: CallMetadata) => Promise<any>): Promise<boolean> {\n  const callMetadata: CallMetadata = {\n    id: `call@${createGuid()}`,\n    apiName: 'frame.' + action,\n    objectId: mainFrame.guid,\n    pageId: mainFrame._page.guid,\n    frameId: mainFrame.guid,\n    startTime: monotonicTime(),\n    endTime: 0,\n    type: 'Frame',\n    method: action,\n    params,\n    log: [],\n  };\n\n  try {\n    await mainFrame.instrumentation.onBeforeCall(mainFrame, callMetadata);\n    await cb(callMetadata);\n  } catch (e) {\n    callMetadata.endTime = monotonicTime();\n    await mainFrame.instrumentation.onAfterCall(mainFrame, callMetadata);\n    return false;\n  }\n\n  callMetadata.endTime = monotonicTime();\n  await mainFrame.instrumentation.onAfterCall(mainFrame, callMetadata);\n  return true;\n}\n\nexport async function performAction(pageAliases: Map<Page, string>, actionInContext: ActionInContext): Promise<boolean> {\n  const pageAlias = actionInContext.frame.pageAlias;\n  const page = [...pageAliases.entries()].find(([, alias]) => pageAlias === alias)?.[0];\n  if (!page)\n    throw new Error('Internal error: page not found');\n  const mainFrame = page.mainFrame();\n  const { action } = actionInContext;\n  const kActionTimeout = 5000;\n\n  if (action.name === 'navigate')\n    return await innerPerformAction(mainFrame, 'goto', { url: action.url }, callMetadata => mainFrame.goto(callMetadata, action.url, { timeout: kActionTimeout }));\n  if (action.name === 'openPage')\n    throw Error('Not reached');\n  if (action.name === 'closePage')\n    return await innerPerformAction(mainFrame, 'close', {}, callMetadata => mainFrame._page.close(callMetadata));\n\n  const selector = buildFullSelector(actionInContext.frame.framePath, action.selector);\n\n  if (action.name === 'click') {\n    const options = toClickOptions(action);\n    return await innerPerformAction(mainFrame, 'click', { selector }, callMetadata => mainFrame.click(callMetadata, selector, { ...options, timeout: kActionTimeout, strict: true }));\n  }\n  if (action.name === 'press') {\n    const modifiers = toKeyboardModifiers(action.modifiers);\n    const shortcut = [...modifiers, action.key].join('+');\n    return await innerPerformAction(mainFrame, 'press', { selector, key: shortcut }, callMetadata => mainFrame.press(callMetadata, selector, shortcut, { timeout: kActionTimeout, strict: true }));\n  }\n  if (action.name === 'fill')\n    return await innerPerformAction(mainFrame, 'fill', { selector, text: action.text }, callMetadata => mainFrame.fill(callMetadata, selector, action.text, { timeout: kActionTimeout, strict: true }));\n  if (action.name === 'setInputFiles')\n    return await innerPerformAction(mainFrame, 'setInputFiles', { selector, files: action.files }, callMetadata => mainFrame.setInputFiles(callMetadata, selector, { selector, payloads: [], timeout: kActionTimeout, strict: true }));\n  if (action.name === 'check')\n    return await innerPerformAction(mainFrame, 'check', { selector }, callMetadata => mainFrame.check(callMetadata, selector, { timeout: kActionTimeout, strict: true }));\n  if (action.name === 'uncheck')\n    return await innerPerformAction(mainFrame, 'uncheck', { selector }, callMetadata => mainFrame.uncheck(callMetadata, selector, { timeout: kActionTimeout, strict: true }));\n  if (action.name === 'select') {\n    const values = action.options.map(value => ({ value }));\n    return await innerPerformAction(mainFrame, 'selectOption', { selector, values }, callMetadata => mainFrame.selectOption(callMetadata, selector, [], values, { timeout: kActionTimeout, strict: true }));\n  }\n  if (action.name === 'assertChecked') {\n    return await innerPerformAction(mainFrame, 'expect', { selector }, callMetadata => mainFrame.expect(callMetadata, selector, {\n      selector,\n      expression: 'to.be.checked',\n      isNot: !action.checked,\n      timeout: kActionTimeout,\n    }));\n  }\n  if (action.name === 'assertText') {\n    return await innerPerformAction(mainFrame, 'expect', { selector }, callMetadata => mainFrame.expect(callMetadata, selector, {\n      selector,\n      expression: 'to.have.text',\n      expectedText: serializeExpectedTextValues([action.text], { matchSubstring: true, normalizeWhiteSpace: true }),\n      isNot: false,\n      timeout: kActionTimeout,\n    }));\n  }\n  if (action.name === 'assertValue') {\n    return await innerPerformAction(mainFrame, 'expect', { selector }, callMetadata => mainFrame.expect(callMetadata, selector, {\n      selector,\n      expression: 'to.have.value',\n      expectedValue: action.value,\n      isNot: false,\n      timeout: kActionTimeout,\n    }));\n  }\n  if (action.name === 'assertVisible') {\n    return await innerPerformAction(mainFrame, 'expect', { selector }, callMetadata => mainFrame.expect(callMetadata, selector, {\n      selector,\n      expression: 'to.be.visible',\n      isNot: false,\n      timeout: kActionTimeout,\n    }));\n  }\n  throw new Error('Internal error: unexpected action ' + (action as any).name);\n}\n"],"mappings":"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"}