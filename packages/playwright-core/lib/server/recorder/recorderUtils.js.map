{"version":3,"file":"recorderUtils.js","names":["metadataToCallLog","metadata","status","_metadata$params","_metadata$params2","_metadata$error","title","apiName","method","params","info","event","replace","error","url","selector","duration","endTime","startTime","undefined","pauseStartTime","pauseEndTime","Math","max","callLog","id","messages","log","message","buildFullSelector","framePath","join","mainFrameForAction","pageAliases","actionInContext","_find","pageAlias","frame","page","entries","find","alias","Error","mainFrame","frameForAction","action","_find2","fullSelector","result","selectors","resolveFrameForSelector"],"sources":["../../../src/server/recorder/recorderUtils.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { CallMetadata } from '../instrumentation';\nimport type { CallLog, CallLogStatus } from '@recorder/recorderTypes';\nimport type { Page } from '../page';\nimport type { ActionInContext } from '../codegen/types';\nimport type { Frame } from '../frames';\nimport type * as actions from './recorderActions';\n\nexport function metadataToCallLog(metadata: CallMetadata, status: CallLogStatus): CallLog {\n  let title = metadata.apiName || metadata.method;\n  if (metadata.method === 'waitForEventInfo')\n    title += `(${metadata.params.info.event})`;\n  title = title.replace('object.expect', 'expect');\n  if (metadata.error)\n    status = 'error';\n  const params = {\n    url: metadata.params?.url,\n    selector: metadata.params?.selector,\n  };\n  let duration = metadata.endTime ? metadata.endTime - metadata.startTime : undefined;\n  if (typeof duration === 'number' && metadata.pauseStartTime && metadata.pauseEndTime) {\n    duration -= (metadata.pauseEndTime - metadata.pauseStartTime);\n    duration = Math.max(duration, 0);\n  }\n  const callLog: CallLog = {\n    id: metadata.id,\n    messages: metadata.log,\n    title,\n    status,\n    error: metadata.error?.error?.message,\n    params,\n    duration,\n  };\n  return callLog;\n}\n\nexport function buildFullSelector(framePath: string[], selector: string) {\n  return [...framePath, selector].join(' >> internal:control=enter-frame >> ');\n}\n\nexport function mainFrameForAction(pageAliases: Map<Page, string>, actionInContext: ActionInContext): Frame {\n  const pageAlias = actionInContext.frame.pageAlias;\n  const page = [...pageAliases.entries()].find(([, alias]) => pageAlias === alias)?.[0];\n  if (!page)\n    throw new Error('Internal error: page not found');\n  return page.mainFrame();\n}\n\nexport async function frameForAction(pageAliases: Map<Page, string>, actionInContext: ActionInContext, action: actions.ActionWithSelector): Promise<Frame> {\n  const pageAlias = actionInContext.frame.pageAlias;\n  const page = [...pageAliases.entries()].find(([, alias]) => pageAlias === alias)?.[0];\n  if (!page)\n    throw new Error('Internal error: page not found');\n  const fullSelector = buildFullSelector(actionInContext.frame.framePath, action.selector);\n  const result = await page.mainFrame().selectors.resolveFrameForSelector(fullSelector);\n  if (!result)\n    throw new Error('Internal error: frame not found');\n  return result.frame;\n}\n"],"mappings":"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"}