{"version":3,"file":"recorderCollection.js","names":["_events","require","RecorderCollection","EventEmitter","constructor","enabled","actionListener","_currentAction","_lastAction","_actions","_enabled","_actionListener","restart","emit","actions","setEnabled","addAction","action","willPerformAction","didPerformAction","performedActionFailed","actionInContext","_this$_actionListener","eraseLastAction","frame","pageAlias","lastAction","name","selector","clickCount","url","pop","push","commitLastAction","committed","signal","signals","_this$_actionListener2","length","_page","mainFrame","framePath","exports"],"sources":["../../../src/server/recorder/recorderCollection.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { EventEmitter } from 'events';\nimport type { Frame } from '../frames';\nimport type { Signal } from './recorderActions';\nimport type { ActionInContext } from '../codegen/types';\n\nexport class RecorderCollection extends EventEmitter {\n  private _currentAction: ActionInContext | null = null;\n  private _lastAction: ActionInContext | null = null;\n  private _actions: ActionInContext[] = [];\n  private _enabled: boolean;\n  private _actionListener: EventEmitter | undefined;\n\n  constructor(enabled: boolean, actionListener: EventEmitter | undefined) {\n    super();\n    this._enabled = enabled;\n    this._actionListener = actionListener;\n    this.restart();\n  }\n\n  restart() {\n    this._currentAction = null;\n    this._lastAction = null;\n    this._actions = [];\n    this.emit('change');\n  }\n\n  actions() {\n    return this._actions;\n  }\n\n  setEnabled(enabled: boolean) {\n    this._enabled = enabled;\n  }\n\n  addAction(action: ActionInContext) {\n    if (!this._enabled)\n      return;\n    this.willPerformAction(action);\n    this.didPerformAction(action);\n  }\n\n  willPerformAction(action: ActionInContext) {\n    if (!this._enabled)\n      return;\n    this._currentAction = action;\n  }\n\n  performedActionFailed(action: ActionInContext) {\n    if (!this._enabled)\n      return;\n    if (this._currentAction === action)\n      this._currentAction = null;\n  }\n\n  didPerformAction(actionInContext: ActionInContext) {\n    if (!this._enabled)\n      return;\n    const action = actionInContext.action;\n    let eraseLastAction = false;\n    if (this._lastAction && this._lastAction.frame.pageAlias === actionInContext.frame.pageAlias) {\n      const lastAction = this._lastAction.action;\n      // We augment last action based on the type.\n      if (this._lastAction && action.name === 'fill' && lastAction.name === 'fill') {\n        if (action.selector === lastAction.selector)\n          eraseLastAction = true;\n      }\n      if (lastAction && action.name === 'click' && lastAction.name === 'click') {\n        if (action.selector === lastAction.selector && action.clickCount > lastAction.clickCount)\n          eraseLastAction = true;\n      }\n      if (lastAction && action.name === 'navigate' && lastAction.name === 'navigate') {\n        if (action.url === lastAction.url) {\n          // Already at a target URL.\n          this._currentAction = null;\n          return;\n        }\n      }\n      // Check and uncheck erase click.\n      if (lastAction && (action.name === 'check' || action.name === 'uncheck') && lastAction.name === 'click') {\n        if (action.selector === lastAction.selector)\n          eraseLastAction = true;\n      }\n    }\n\n    this._lastAction = actionInContext;\n    this._currentAction = null;\n    if (eraseLastAction)\n      this._actions.pop();\n    this._actions.push(actionInContext);\n    this.emit('change');\n    this._actionListener?.emit('actions', this._actions);\n  }\n\n  commitLastAction() {\n    if (!this._enabled)\n      return;\n    const action = this._lastAction;\n    if (action)\n      action.committed = true;\n  }\n\n  signal(pageAlias: string, frame: Frame, signal: Signal) {\n    if (!this._enabled)\n      return;\n\n    // Signal either arrives while action is being performed or shortly after.\n    if (this._currentAction) {\n      this._currentAction.action.signals.push(signal);\n      return;\n    }\n\n    if (this._lastAction && (!this._lastAction.committed || signal.name !== 'navigation')) {\n      const signals = this._lastAction.action.signals;\n      if (signal.name === 'navigation' && signals.length && signals[signals.length - 1].name === 'download')\n        return;\n      if (signal.name === 'download' && signals.length && signals[signals.length - 1].name === 'navigation')\n        signals.length = signals.length - 1;\n      this._lastAction.action.signals.push(signal);\n      this.emit('change');\n      this._actionListener?.emit('actions', this._actions);\n      return;\n    }\n\n    if (signal.name === 'navigation' && frame._page.mainFrame() === frame) {\n      this.addAction({\n        frame: {\n          pageAlias,\n          framePath: [],\n        },\n        committed: true,\n        action: {\n          name: 'navigate',\n          url: frame.url(),\n          signals: [],\n        },\n      });\n    }\n  }\n}\n"],"mappings":";;;;;;AAgBA,IAAAA,OAAA,GAAAC,OAAA;AAhBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAOO,MAAMC,kBAAkB,SAASC,oBAAY,CAAC;EAOnDC,WAAWA,CAACC,OAAgB,EAAEC,cAAwC,EAAE;IACtE,KAAK,CAAC,CAAC;IAAC,KAPFC,cAAc,GAA2B,IAAI;IAAA,KAC7CC,WAAW,GAA2B,IAAI;IAAA,KAC1CC,QAAQ,GAAsB,EAAE;IAAA,KAChCC,QAAQ;IAAA,KACRC,eAAe;IAIrB,IAAI,CAACD,QAAQ,GAAGL,OAAO;IACvB,IAAI,CAACM,eAAe,GAAGL,cAAc;IACrC,IAAI,CAACM,OAAO,CAAC,CAAC;EAChB;EAEAA,OAAOA,CAAA,EAAG;IACR,IAAI,CAACL,cAAc,GAAG,IAAI;IAC1B,IAAI,CAACC,WAAW,GAAG,IAAI;IACvB,IAAI,CAACC,QAAQ,GAAG,EAAE;IAClB,IAAI,CAACI,IAAI,CAAC,QAAQ,CAAC;EACrB;EAEAC,OAAOA,CAAA,EAAG;IACR,OAAO,IAAI,CAACL,QAAQ;EACtB;EAEAM,UAAUA,CAACV,OAAgB,EAAE;IAC3B,IAAI,CAACK,QAAQ,GAAGL,OAAO;EACzB;EAEAW,SAASA,CAACC,MAAuB,EAAE;IACjC,IAAI,CAAC,IAAI,CAACP,QAAQ,EAChB;IACF,IAAI,CAACQ,iBAAiB,CAACD,MAAM,CAAC;IAC9B,IAAI,CAACE,gBAAgB,CAACF,MAAM,CAAC;EAC/B;EAEAC,iBAAiBA,CAACD,MAAuB,EAAE;IACzC,IAAI,CAAC,IAAI,CAACP,QAAQ,EAChB;IACF,IAAI,CAACH,cAAc,GAAGU,MAAM;EAC9B;EAEAG,qBAAqBA,CAACH,MAAuB,EAAE;IAC7C,IAAI,CAAC,IAAI,CAACP,QAAQ,EAChB;IACF,IAAI,IAAI,CAACH,cAAc,KAAKU,MAAM,EAChC,IAAI,CAACV,cAAc,GAAG,IAAI;EAC9B;EAEAY,gBAAgBA,CAACE,eAAgC,EAAE;IAAA,IAAAC,qBAAA;IACjD,IAAI,CAAC,IAAI,CAACZ,QAAQ,EAChB;IACF,MAAMO,MAAM,GAAGI,eAAe,CAACJ,MAAM;IACrC,IAAIM,eAAe,GAAG,KAAK;IAC3B,IAAI,IAAI,CAACf,WAAW,IAAI,IAAI,CAACA,WAAW,CAACgB,KAAK,CAACC,SAAS,KAAKJ,eAAe,CAACG,KAAK,CAACC,SAAS,EAAE;MAC5F,MAAMC,UAAU,GAAG,IAAI,CAAClB,WAAW,CAACS,MAAM;MAC1C;MACA,IAAI,IAAI,CAACT,WAAW,IAAIS,MAAM,CAACU,IAAI,KAAK,MAAM,IAAID,UAAU,CAACC,IAAI,KAAK,MAAM,EAAE;QAC5E,IAAIV,MAAM,CAACW,QAAQ,KAAKF,UAAU,CAACE,QAAQ,EACzCL,eAAe,GAAG,IAAI;MAC1B;MACA,IAAIG,UAAU,IAAIT,MAAM,CAACU,IAAI,KAAK,OAAO,IAAID,UAAU,CAACC,IAAI,KAAK,OAAO,EAAE;QACxE,IAAIV,MAAM,CAACW,QAAQ,KAAKF,UAAU,CAACE,QAAQ,IAAIX,MAAM,CAACY,UAAU,GAAGH,UAAU,CAACG,UAAU,EACtFN,eAAe,GAAG,IAAI;MAC1B;MACA,IAAIG,UAAU,IAAIT,MAAM,CAACU,IAAI,KAAK,UAAU,IAAID,UAAU,CAACC,IAAI,KAAK,UAAU,EAAE;QAC9E,IAAIV,MAAM,CAACa,GAAG,KAAKJ,UAAU,CAACI,GAAG,EAAE;UACjC;UACA,IAAI,CAACvB,cAAc,GAAG,IAAI;UAC1B;QACF;MACF;MACA;MACA,IAAImB,UAAU,KAAKT,MAAM,CAACU,IAAI,KAAK,OAAO,IAAIV,MAAM,CAACU,IAAI,KAAK,SAAS,CAAC,IAAID,UAAU,CAACC,IAAI,KAAK,OAAO,EAAE;QACvG,IAAIV,MAAM,CAACW,QAAQ,KAAKF,UAAU,CAACE,QAAQ,EACzCL,eAAe,GAAG,IAAI;MAC1B;IACF;IAEA,IAAI,CAACf,WAAW,GAAGa,eAAe;IAClC,IAAI,CAACd,cAAc,GAAG,IAAI;IAC1B,IAAIgB,eAAe,EACjB,IAAI,CAACd,QAAQ,CAACsB,GAAG,CAAC,CAAC;IACrB,IAAI,CAACtB,QAAQ,CAACuB,IAAI,CAACX,eAAe,CAAC;IACnC,IAAI,CAACR,IAAI,CAAC,QAAQ,CAAC;IACnB,CAAAS,qBAAA,OAAI,CAACX,eAAe,cAAAW,qBAAA,eAApBA,qBAAA,CAAsBT,IAAI,CAAC,SAAS,EAAE,IAAI,CAACJ,QAAQ,CAAC;EACtD;EAEAwB,gBAAgBA,CAAA,EAAG;IACjB,IAAI,CAAC,IAAI,CAACvB,QAAQ,EAChB;IACF,MAAMO,MAAM,GAAG,IAAI,CAACT,WAAW;IAC/B,IAAIS,MAAM,EACRA,MAAM,CAACiB,SAAS,GAAG,IAAI;EAC3B;EAEAC,MAAMA,CAACV,SAAiB,EAAED,KAAY,EAAEW,MAAc,EAAE;IACtD,IAAI,CAAC,IAAI,CAACzB,QAAQ,EAChB;;IAEF;IACA,IAAI,IAAI,CAACH,cAAc,EAAE;MACvB,IAAI,CAACA,cAAc,CAACU,MAAM,CAACmB,OAAO,CAACJ,IAAI,CAACG,MAAM,CAAC;MAC/C;IACF;IAEA,IAAI,IAAI,CAAC3B,WAAW,KAAK,CAAC,IAAI,CAACA,WAAW,CAAC0B,SAAS,IAAIC,MAAM,CAACR,IAAI,KAAK,YAAY,CAAC,EAAE;MAAA,IAAAU,sBAAA;MACrF,MAAMD,OAAO,GAAG,IAAI,CAAC5B,WAAW,CAACS,MAAM,CAACmB,OAAO;MAC/C,IAAID,MAAM,CAACR,IAAI,KAAK,YAAY,IAAIS,OAAO,CAACE,MAAM,IAAIF,OAAO,CAACA,OAAO,CAACE,MAAM,GAAG,CAAC,CAAC,CAACX,IAAI,KAAK,UAAU,EACnG;MACF,IAAIQ,MAAM,CAACR,IAAI,KAAK,UAAU,IAAIS,OAAO,CAACE,MAAM,IAAIF,OAAO,CAACA,OAAO,CAACE,MAAM,GAAG,CAAC,CAAC,CAACX,IAAI,KAAK,YAAY,EACnGS,OAAO,CAACE,MAAM,GAAGF,OAAO,CAACE,MAAM,GAAG,CAAC;MACrC,IAAI,CAAC9B,WAAW,CAACS,MAAM,CAACmB,OAAO,CAACJ,IAAI,CAACG,MAAM,CAAC;MAC5C,IAAI,CAACtB,IAAI,CAAC,QAAQ,CAAC;MACnB,CAAAwB,sBAAA,OAAI,CAAC1B,eAAe,cAAA0B,sBAAA,eAApBA,sBAAA,CAAsBxB,IAAI,CAAC,SAAS,EAAE,IAAI,CAACJ,QAAQ,CAAC;MACpD;IACF;IAEA,IAAI0B,MAAM,CAACR,IAAI,KAAK,YAAY,IAAIH,KAAK,CAACe,KAAK,CAACC,SAAS,CAAC,CAAC,KAAKhB,KAAK,EAAE;MACrE,IAAI,CAACR,SAAS,CAAC;QACbQ,KAAK,EAAE;UACLC,SAAS;UACTgB,SAAS,EAAE;QACb,CAAC;QACDP,SAAS,EAAE,IAAI;QACfjB,MAAM,EAAE;UACNU,IAAI,EAAE,UAAU;UAChBG,GAAG,EAAEN,KAAK,CAACM,GAAG,CAAC,CAAC;UAChBM,OAAO,EAAE;QACX;MACF,CAAC,CAAC;IACJ;EACF;AACF;AAACM,OAAA,CAAAxC,kBAAA,GAAAA,kBAAA"}