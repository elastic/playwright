{"version":3,"file":"contextRecorder.js","names":["_events","require","recorderSource","_interopRequireWildcard","_utils","_timeoutRunner","_browserContext","_languages","_frames","_page","_recorderRunner","_throttledFile","_recorderCollection","_language","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","ContextRecorder","EventEmitter","constructor","context","params","delegate","_collection","_pageAliases","Map","_lastPopupOrdinal","_lastDialogOrdinal","_lastDownloadOrdinal","_timers","Set","_context","_params","_delegate","_recorderSources","_throttledOutputFile","_orderedLanguages","_listeners","language","attribution","playwright","options","sdkLanguage","setOutput","outputFile","languageGeneratorOptions","browserName","_browser","name","launchOptions","headless","contextOptions","deviceName","device","saveStorage","collection","RecorderCollection","mode","actionListener","on","languageGenerator","_this$_throttledOutpu","header","footer","actionTexts","text","generateCode","actions","source","isRecorded","label","group","groupName","id","highlighter","highlight","revealLine","split","length","push","setContent","emit","Events","Change","sources","primaryFileName","BrowserContext","BeforeClose","_this$_throttledOutpu2","flush","eventsHelper","addEventListener","process","_this$_throttledOutpu3","codegenId","_this$_collection","languages","languageSet","primaryLanguage","find","l","Error","delete","ThrottledFile","restart","languageName","lang","install","Page","page","_onPage","pages","Dialog","dialog","_onDialog","exposeBinding","action","_performAction","frame","_recordAction","extendInjectedScript","setEnabled","enabled","dispose","timer","clearTimeout","clear","removeEventListeners","emitSelector","selector","_this$_params$actionL","mainFrame","addAction","_describeMainFrame","committed","signals","Frame","InternalNavigation","event","isPublic","_onFrameNavigated","Download","_onDownload","suffix","size","String","pageAlias","opener","_onPopup","url","clearScript","framePath","_describeFrame","generateFrameSelector","testIdAttributeName","selectors","_this$_delegate$rewri","_this$_delegate","commitLastAction","frameDescription","actionInContext","description","undefined","rewriteActionInContext","willPerformAction","success","performAction","didPerformAction","_setCommittedAfterTimeout","performedActionFailed","_this$_delegate$rewri2","_this$_delegate2","setTimeout","isUnderTest","add","signal","popup","popupAlias","downloadAlias","dialogAlias","exports","selectorPromises","parent","parentFrame","generateFrameSelectorInParent","result","Promise","all","reverse","raceAgainstDeadline","frameElement","utility","_utilityContext","injected","injectedScript","evaluate","element","generateSelectorSimple","toString","monotonicTime","timedOut","quoteCSSAttributeValue"],"sources":["../../../src/server/recorder/contextRecorder.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as channels from '@protocol/channels';\nimport type { Source } from '@recorder/recorderTypes';\nimport { EventEmitter } from 'events';\nimport * as recorderSource from '../../generated/recorderSource';\nimport { eventsHelper, isUnderTest, monotonicTime, quoteCSSAttributeValue, type RegisteredListener } from '../../utils';\nimport { raceAgainstDeadline } from '../../utils/timeoutRunner';\nimport { BrowserContext } from '../browserContext';\nimport type { ActionInContext, FrameDescription, LanguageGeneratorOptions, Language, LanguageGenerator } from '../codegen/types';\nimport { languageSet } from '../codegen/languages';\nimport type { Dialog } from '../dialog';\nimport { Frame } from '../frames';\nimport { Page } from '../page';\nimport type * as actions from './recorderActions';\nimport { performAction } from './recorderRunner';\nimport { ThrottledFile } from './throttledFile';\nimport { RecorderCollection } from './recorderCollection';\nimport { generateCode } from '../codegen/language';\n\ntype BindingSource = { frame: Frame, page: Page };\n\nexport interface ContextRecorderDelegate {\n  rewriteActionInContext?(pageAliases: Map<Page, string>, actionInContext: ActionInContext): Promise<void>;\n}\n\nexport class ContextRecorder extends EventEmitter {\n  static Events = {\n    Change: 'change'\n  };\n\n  private _collection: RecorderCollection;\n  private _pageAliases = new Map<Page, string>();\n  private _lastPopupOrdinal = 0;\n  private _lastDialogOrdinal = -1;\n  private _lastDownloadOrdinal = -1;\n  private _timers = new Set<NodeJS.Timeout>();\n  private _context: BrowserContext;\n  private _params: channels.BrowserContextRecorderSupplementEnableParams;\n  private _delegate: ContextRecorderDelegate;\n  private _recorderSources: Source[];\n  private _throttledOutputFile: ThrottledFile | null = null;\n  private _orderedLanguages: LanguageGenerator[] = [];\n  private _listeners: RegisteredListener[] = [];\n\n  constructor(context: BrowserContext, params: channels.BrowserContextRecorderSupplementEnableParams, delegate: ContextRecorderDelegate) {\n    super();\n    this._context = context;\n    this._params = params;\n    this._delegate = delegate;\n    this._recorderSources = [];\n    const language = params.language || context.attribution.playwright.options.sdkLanguage;\n    this.setOutput(language, params.outputFile);\n\n    // Make a copy of options to modify them later.\n    const languageGeneratorOptions: LanguageGeneratorOptions = {\n      browserName: context._browser.options.name,\n      launchOptions: { headless: false, ...params.launchOptions },\n      contextOptions: { ...params.contextOptions },\n      deviceName: params.device,\n      saveStorage: params.saveStorage,\n    };\n\n    const collection = new RecorderCollection(params.mode === 'recording', params.actionListener);\n    collection.on('change', () => {\n      this._recorderSources = [];\n      for (const languageGenerator of this._orderedLanguages) {\n        const { header, footer, actionTexts, text } = generateCode(collection.actions(), languageGenerator, languageGeneratorOptions);\n        const source: Source = {\n          isRecorded: true,\n          label: languageGenerator.name,\n          group: languageGenerator.groupName,\n          id: languageGenerator.id,\n          text,\n          header,\n          footer,\n          actions: actionTexts,\n          language: languageGenerator.highlighter,\n          highlight: []\n        };\n        source.revealLine = text.split('\\n').length - 1;\n        this._recorderSources.push(source);\n        if (languageGenerator === this._orderedLanguages[0])\n          this._throttledOutputFile?.setContent(source.text);\n      }\n      this.emit(ContextRecorder.Events.Change, {\n        sources: this._recorderSources,\n        primaryFileName: this._orderedLanguages[0].id\n      });\n    });\n    context.on(BrowserContext.Events.BeforeClose, () => {\n      this._throttledOutputFile?.flush();\n    });\n    this._listeners.push(eventsHelper.addEventListener(process, 'exit', () => {\n      this._throttledOutputFile?.flush();\n    }));\n    this._collection = collection;\n  }\n\n  setOutput(codegenId: string, outputFile?: string) {\n    const languages = languageSet();\n    const primaryLanguage = [...languages].find(l => l.id === codegenId);\n    if (!primaryLanguage)\n      throw new Error(`\\n===============================\\nUnsupported language: '${codegenId}'\\n===============================\\n`);\n    languages.delete(primaryLanguage);\n    this._orderedLanguages = [primaryLanguage, ...languages];\n    this._throttledOutputFile = outputFile ? new ThrottledFile(outputFile) : null;\n    this._collection?.restart();\n  }\n\n  languageName(id?: string): Language {\n    for (const lang of this._orderedLanguages) {\n      if (!id || lang.id === id)\n        return lang.highlighter;\n    }\n    return 'javascript';\n  }\n\n  async install() {\n    this._context.on(BrowserContext.Events.Page, (page: Page) => this._onPage(page));\n    for (const page of this._context.pages())\n      this._onPage(page);\n    this._context.on(BrowserContext.Events.Dialog, (dialog: Dialog) => this._onDialog(dialog.page()));\n\n    // Input actions that potentially lead to navigation are intercepted on the page and are\n    // performed by the Playwright.\n    await this._context.exposeBinding('__pw_recorderPerformAction', false,\n        (source: BindingSource, action: actions.PerformOnRecordAction) => this._performAction(source.frame, action));\n\n    // Other non-essential actions are simply being recorded.\n    await this._context.exposeBinding('__pw_recorderRecordAction', false,\n        (source: BindingSource, action: actions.Action) => this._recordAction(source.frame, action));\n\n    await this._context.extendInjectedScript(recorderSource.source);\n  }\n\n  setEnabled(enabled: boolean) {\n    this._collection.setEnabled(enabled);\n  }\n\n  dispose() {\n    for (const timer of this._timers)\n      clearTimeout(timer);\n    this._timers.clear();\n    eventsHelper.removeEventListeners(this._listeners);\n  }\n\n  emitSelector(selector: string) {\n    this._params.actionListener?.emit('selector', selector);\n  }\n\n  private async _onPage(page: Page) {\n    // First page is called page, others are called popup1, popup2, etc.\n    const frame = page.mainFrame();\n    page.on('close', () => {\n      this._collection.addAction({\n        frame: this._describeMainFrame(page),\n        committed: true,\n        action: {\n          name: 'closePage',\n          signals: [],\n        }\n      });\n      this._pageAliases.delete(page);\n    });\n    frame.on(Frame.Events.InternalNavigation, event => {\n      if (event.isPublic)\n        this._onFrameNavigated(frame, page);\n    });\n    page.on(Page.Events.Download, () => this._onDownload(page));\n    const suffix = this._pageAliases.size ? String(++this._lastPopupOrdinal) : '';\n    const pageAlias = 'page' + suffix;\n    this._pageAliases.set(page, pageAlias);\n\n    if (page.opener()) {\n      this._onPopup(page.opener()!, page);\n    } else {\n      this._collection.addAction({\n        frame: this._describeMainFrame(page),\n        committed: true,\n        action: {\n          name: 'openPage',\n          url: page.mainFrame().url(),\n          signals: [],\n        }\n      });\n    }\n  }\n\n  clearScript(): void {\n    this._collection.restart();\n    if (this._params.mode === 'recording') {\n      for (const page of this._context.pages())\n        this._onFrameNavigated(page.mainFrame(), page);\n    }\n  }\n\n  private _describeMainFrame(page: Page): FrameDescription {\n    return {\n      pageAlias: this._pageAliases.get(page)!,\n      framePath: [],\n    };\n  }\n\n  private async _describeFrame(frame: Frame): Promise<FrameDescription> {\n    return {\n      pageAlias: this._pageAliases.get(frame._page)!,\n      framePath: await generateFrameSelector(frame),\n    };\n  }\n\n  testIdAttributeName(): string {\n    return this._params.testIdAttributeName || this._context.selectors().testIdAttributeName() || 'data-testid';\n  }\n\n  private async _performAction(frame: Frame, action: actions.PerformOnRecordAction) {\n    // Commit last action so that no further signals are added to it.\n    this._collection.commitLastAction();\n\n    const frameDescription = await this._describeFrame(frame);\n    const actionInContext: ActionInContext = {\n      frame: frameDescription,\n      action,\n      description: undefined,\n    };\n\n    await this._delegate.rewriteActionInContext?.(this._pageAliases, actionInContext);\n\n    this._collection.willPerformAction(actionInContext);\n    const success = await performAction(this._pageAliases, actionInContext);\n    if (success) {\n      this._collection.didPerformAction(actionInContext);\n      this._setCommittedAfterTimeout(actionInContext);\n    } else {\n      this._collection.performedActionFailed(actionInContext);\n    }\n  }\n\n  private async _recordAction(frame: Frame, action: actions.Action) {\n    // Commit last action so that no further signals are added to it.\n    this._collection.commitLastAction();\n\n    const frameDescription = await this._describeFrame(frame);\n    const actionInContext: ActionInContext = {\n      frame: frameDescription,\n      action,\n      description: undefined,\n    };\n\n    await this._delegate.rewriteActionInContext?.(this._pageAliases, actionInContext);\n\n    this._setCommittedAfterTimeout(actionInContext);\n    this._collection.addAction(actionInContext);\n  }\n\n  private _setCommittedAfterTimeout(actionInContext: ActionInContext) {\n    const timer = setTimeout(() => {\n      // Commit the action after 5 seconds so that no further signals are added to it.\n      actionInContext.committed = true;\n      this._timers.delete(timer);\n    }, isUnderTest() ? 500 : 5000);\n    this._timers.add(timer);\n  }\n\n  private _onFrameNavigated(frame: Frame, page: Page) {\n    const pageAlias = this._pageAliases.get(page);\n    this._collection.signal(pageAlias!, frame, { name: 'navigation', url: frame.url() });\n  }\n\n  private _onPopup(page: Page, popup: Page) {\n    const pageAlias = this._pageAliases.get(page)!;\n    const popupAlias = this._pageAliases.get(popup)!;\n    this._collection.signal(pageAlias, page.mainFrame(), { name: 'popup', popupAlias });\n  }\n\n  private _onDownload(page: Page) {\n    const pageAlias = this._pageAliases.get(page)!;\n    ++this._lastDownloadOrdinal;\n    this._collection.signal(pageAlias, page.mainFrame(), { name: 'download', downloadAlias: this._lastDownloadOrdinal ? String(this._lastDownloadOrdinal) : '' });\n  }\n\n  private _onDialog(page: Page) {\n    const pageAlias = this._pageAliases.get(page)!;\n    ++this._lastDialogOrdinal;\n    this._collection.signal(pageAlias, page.mainFrame(), { name: 'dialog', dialogAlias: this._lastDialogOrdinal ? String(this._lastDialogOrdinal) : '' });\n  }\n}\n\nexport async function generateFrameSelector(frame: Frame): Promise<string[]> {\n  const selectorPromises: Promise<string>[] = [];\n  while (frame) {\n    const parent = frame.parentFrame();\n    if (!parent)\n      break;\n    selectorPromises.push(generateFrameSelectorInParent(parent, frame));\n    frame = parent;\n  }\n  const result = await Promise.all(selectorPromises);\n  return result.reverse();\n}\n\nasync function generateFrameSelectorInParent(parent: Frame, frame: Frame): Promise<string> {\n  const result = await raceAgainstDeadline(async () => {\n    try {\n      const frameElement = await frame.frameElement();\n      if (!frameElement || !parent)\n        return;\n      const utility = await parent._utilityContext();\n      const injected = await utility.injectedScript();\n      const selector = await injected.evaluate((injected, element) => {\n        return injected.generateSelectorSimple(element as Element);\n      }, frameElement);\n      return selector;\n    } catch (e) {\n      return e.toString();\n    }\n  }, monotonicTime() + 2000);\n  if (!result.timedOut && result.result)\n    return result.result;\n\n  if (frame.name())\n    return `iframe[name=${quoteCSSAttributeValue(frame.name())}]`;\n  return `iframe[src=${quoteCSSAttributeValue(frame.url())}]`;\n}\n"],"mappings":"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"}