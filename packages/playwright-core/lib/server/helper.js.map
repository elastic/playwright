{"version":3,"file":"helper.js","names":["_debugLogger","require","_eventsHelper","MAX_LOG_LENGTH","process","env","Infinity","Helper","completeUserURL","urlString","startsWith","enclosingIntRect","rect","x","Math","floor","y","x2","ceil","width","y2","height","enclosingIntSize","size","getViewportSizeFromWindowFeatures","features","widthString","find","f","heightString","parseInt","substring","NaN","Number","isNaN","waitForEvent","progress","emitter","event","predicate","listeners","promise","Promise","resolve","reject","push","eventsHelper","addEventListener","eventArg","removeEventListeners","e","dispose","cleanupWhenAborted","secondsToRoundishMillis","value","millisToRoundishMillis","debugProtocolLogger","protocolLogger","direction","message","debugLogger","isEnabled","text","JSON","stringify","length","log","formatBrowserLogs","logs","disconnectReason","join","helper","exports"],"sources":["../../src/server/helper.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { EventEmitter } from 'events';\nimport type * as types from './types';\nimport type { Progress } from './progress';\nimport { debugLogger } from '../utils/debugLogger';\nimport type { RegisteredListener } from '../utils/eventsHelper';\nimport { eventsHelper } from '../utils/eventsHelper';\n\nconst MAX_LOG_LENGTH = process.env.MAX_LOG_LENGTH ? +process.env.MAX_LOG_LENGTH : Infinity;\n\nclass Helper {\n  static completeUserURL(urlString: string): string {\n    if (urlString.startsWith('localhost') || urlString.startsWith('127.0.0.1'))\n      urlString = 'http://' + urlString;\n    return urlString;\n  }\n\n  static enclosingIntRect(rect: types.Rect): types.Rect {\n    const x = Math.floor(rect.x + 1e-3);\n    const y = Math.floor(rect.y + 1e-3);\n    const x2 = Math.ceil(rect.x + rect.width - 1e-3);\n    const y2 = Math.ceil(rect.y + rect.height - 1e-3);\n    return { x, y, width: x2 - x, height: y2 - y };\n  }\n\n  static enclosingIntSize(size: types.Size): types.Size {\n    return { width: Math.floor(size.width + 1e-3), height: Math.floor(size.height + 1e-3) };\n  }\n\n  static getViewportSizeFromWindowFeatures(features: string[]): types.Size | null {\n    const widthString = features.find(f => f.startsWith('width='));\n    const heightString = features.find(f => f.startsWith('height='));\n    const width = widthString ? parseInt(widthString.substring(6), 10) : NaN;\n    const height = heightString ? parseInt(heightString.substring(7), 10) : NaN;\n    if (!Number.isNaN(width) && !Number.isNaN(height))\n      return { width, height };\n    return null;\n  }\n\n  static waitForEvent(progress: Progress | null, emitter: EventEmitter, event: string | symbol, predicate?: Function): { promise: Promise<any>, dispose: () => void } {\n    const listeners: RegisteredListener[] = [];\n    const promise = new Promise((resolve, reject) => {\n      listeners.push(eventsHelper.addEventListener(emitter, event, eventArg => {\n        try {\n          if (predicate && !predicate(eventArg))\n            return;\n          eventsHelper.removeEventListeners(listeners);\n          resolve(eventArg);\n        } catch (e) {\n          eventsHelper.removeEventListeners(listeners);\n          reject(e);\n        }\n      }));\n    });\n    const dispose = () => eventsHelper.removeEventListeners(listeners);\n    if (progress)\n      progress.cleanupWhenAborted(dispose);\n    return { promise, dispose };\n  }\n\n  static secondsToRoundishMillis(value: number): number {\n    return ((value * 1000000) | 0) / 1000;\n  }\n\n  static millisToRoundishMillis(value: number): number {\n    return ((value * 1000) | 0) / 1000;\n  }\n\n  static debugProtocolLogger(protocolLogger?: types.ProtocolLogger): types.ProtocolLogger {\n    return (direction: 'send' | 'receive', message: object) => {\n      if (protocolLogger)\n        protocolLogger(direction, message);\n      if (debugLogger.isEnabled('protocol')) {\n        let text = JSON.stringify(message);\n        if (text.length > MAX_LOG_LENGTH)\n          text = text.substring(0, MAX_LOG_LENGTH / 2) + ' <<<<<( LOG TRUNCATED )>>>>> ' + text.substring(text.length - MAX_LOG_LENGTH / 2);\n        debugLogger.log('protocol', (direction === 'send' ? 'SEND ► ' : '◀ RECV ') + text);\n      }\n    };\n  }\n\n  static formatBrowserLogs(logs: string[], disconnectReason?: string) {\n    if (!disconnectReason && !logs.length)\n      return '';\n    return '\\n' + (disconnectReason ? disconnectReason + '\\n' : '') + logs.join('\\n');\n  }\n}\n\nexport const helper = Helper;\n"],"mappings":"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"}