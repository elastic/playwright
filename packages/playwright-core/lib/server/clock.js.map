{"version":3,"file":"clock.js","names":["clockSource","_interopRequireWildcard","require","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","Clock","constructor","browserContext","_browserContext","_scriptInstalled","markAsUninstalled","fastForward","ticks","_installIfNeeded","ticksMillis","parseTicks","addInitScript","Date","now","_evaluateInFrames","install","time","timeMillis","undefined","parseTime","pauseAt","resume","setFixedTime","setSystemTime","runFor","script","source","safeNonStallingEvaluateInAllFrames","throwOnJSErrors","exports","value","str","strings","split","l","length","ms","parsed","test","Error","parseInt","Math","pow","epoch","isFinite","getTime"],"sources":["../../src/server/clock.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { BrowserContext } from './browserContext';\nimport * as clockSource from '../generated/clockSource';\n\nexport class Clock {\n  private _browserContext: BrowserContext;\n  private _scriptInstalled = false;\n\n  constructor(browserContext: BrowserContext) {\n    this._browserContext = browserContext;\n  }\n\n  markAsUninstalled() {\n    this._scriptInstalled = false;\n  }\n\n  async fastForward(ticks: number | string) {\n    await this._installIfNeeded();\n    const ticksMillis = parseTicks(ticks);\n    await this._browserContext.addInitScript(`globalThis.__pwClock.controller.log('fastForward', ${Date.now()}, ${ticksMillis})`);\n    await this._evaluateInFrames(`globalThis.__pwClock.controller.fastForward(${ticksMillis})`);\n  }\n\n  async install(time: number | string | undefined) {\n    await this._installIfNeeded();\n    const timeMillis = time !== undefined ? parseTime(time) : Date.now();\n    await this._browserContext.addInitScript(`globalThis.__pwClock.controller.log('install', ${Date.now()}, ${timeMillis})`);\n    await this._evaluateInFrames(`globalThis.__pwClock.controller.install(${timeMillis})`);\n  }\n\n  async pauseAt(ticks: number | string) {\n    await this._installIfNeeded();\n    const timeMillis = parseTime(ticks);\n    await this._browserContext.addInitScript(`globalThis.__pwClock.controller.log('pauseAt', ${Date.now()}, ${timeMillis})`);\n    await this._evaluateInFrames(`globalThis.__pwClock.controller.pauseAt(${timeMillis})`);\n  }\n\n  async resume() {\n    await this._installIfNeeded();\n    await this._browserContext.addInitScript(`globalThis.__pwClock.controller.log('resume', ${Date.now()})`);\n    await this._evaluateInFrames(`globalThis.__pwClock.controller.resume()`);\n  }\n\n  async setFixedTime(time: string | number) {\n    await this._installIfNeeded();\n    const timeMillis = parseTime(time);\n    await this._browserContext.addInitScript(`globalThis.__pwClock.controller.log('setFixedTime', ${Date.now()}, ${timeMillis})`);\n    await this._evaluateInFrames(`globalThis.__pwClock.controller.setFixedTime(${timeMillis})`);\n  }\n\n  async setSystemTime(time: string | number) {\n    await this._installIfNeeded();\n    const timeMillis = parseTime(time);\n    await this._browserContext.addInitScript(`globalThis.__pwClock.controller.log('setSystemTime', ${Date.now()}, ${timeMillis})`);\n    await this._evaluateInFrames(`globalThis.__pwClock.controller.setSystemTime(${timeMillis})`);\n  }\n\n  async runFor(ticks: number | string) {\n    await this._installIfNeeded();\n    const ticksMillis = parseTicks(ticks);\n    await this._browserContext.addInitScript(`globalThis.__pwClock.controller.log('runFor', ${Date.now()}, ${ticksMillis})`);\n    await this._evaluateInFrames(`globalThis.__pwClock.controller.runFor(${ticksMillis})`);\n  }\n\n  private async _installIfNeeded() {\n    if (this._scriptInstalled)\n      return;\n    this._scriptInstalled = true;\n    const script = `(() => {\n      const module = {};\n      ${clockSource.source}\n      globalThis.__pwClock = (module.exports.inject())(globalThis);\n    })();`;\n    await this._browserContext.addInitScript(script);\n    await this._evaluateInFrames(script);\n  }\n\n  private async _evaluateInFrames(script: string) {\n    await this._browserContext.safeNonStallingEvaluateInAllFrames(script, 'main', { throwOnJSErrors: true });\n  }\n}\n\n/**\n * Parse strings like '01:10:00' (meaning 1 hour, 10 minutes, 0 seconds) into\n * number of milliseconds. This is used to support human-readable strings passed\n * to clock.tick()\n */\nfunction parseTicks(value: number | string): number {\n  if (typeof value === 'number')\n    return value;\n  if (!value)\n    return 0;\n  const str = value;\n\n  const strings = str.split(':');\n  const l = strings.length;\n  let i = l;\n  let ms = 0;\n  let parsed;\n\n  if (l > 3 || !/^(\\d\\d:){0,2}\\d\\d?$/.test(str)) {\n    throw new Error(\n        `Clock only understands numbers, 'mm:ss' and 'hh:mm:ss'`,\n    );\n  }\n\n  while (i--) {\n    parsed = parseInt(strings[i], 10);\n    if (parsed >= 60)\n      throw new Error(`Invalid time ${str}`);\n    ms += parsed * Math.pow(60, l - i - 1);\n  }\n\n  return ms * 1000;\n}\n\nfunction parseTime(epoch: string | number | undefined): number {\n  if (!epoch)\n    return 0;\n  if (typeof epoch === 'number')\n    return epoch;\n  const parsed = new Date(epoch);\n  if (!isFinite(parsed.getTime()))\n    throw new Error(`Invalid date: ${epoch}`);\n  return parsed.getTime();\n}\n"],"mappings":"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"}