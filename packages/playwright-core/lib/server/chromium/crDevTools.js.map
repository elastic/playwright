{"version":3,"file":"crDevTools.js","names":["_fs","_interopRequireDefault","require","obj","__esModule","default","kBindingName","CRDevTools","constructor","preferencesPath","_preferencesPath","_prefs","_savePromise","__testHookOnBinding","Promise","resolve","install","session","on","event","name","parsed","JSON","parse","payload","result","undefined","method","json","fs","promises","readFile","e","params","_save","send","expression","id","stringify","contextId","executionContextId","catch","all","source","then","writeFile","exports"],"sources":["../../../src/server/chromium/crDevTools.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport type { CRSession } from './crConnection';\n\nconst kBindingName = '__pw_devtools__';\n\n// This class intercepts preferences-related DevTools embedder methods\n// and stores preferences as a json file in the browser installation directory.\nexport class CRDevTools {\n  private _preferencesPath: string;\n  private _prefs: any;\n  private _savePromise: Promise<any>;\n  __testHookOnBinding?: (parsed: any) => any;\n\n  constructor(preferencesPath: string) {\n    this._preferencesPath = preferencesPath;\n    this._savePromise = Promise.resolve();\n  }\n\n  install(session: CRSession) {\n    session.on('Runtime.bindingCalled', async event => {\n      if (event.name !== kBindingName)\n        return;\n      const parsed = JSON.parse(event.payload);\n      let result = undefined;\n      if (this.__testHookOnBinding)\n        this.__testHookOnBinding(parsed);\n      if (parsed.method === 'getPreferences') {\n        if (this._prefs === undefined) {\n          try {\n            const json = await fs.promises.readFile(this._preferencesPath, 'utf8');\n            this._prefs = JSON.parse(json);\n          } catch (e) {\n            this._prefs = {};\n          }\n        }\n        result = this._prefs;\n      } else if (parsed.method === 'setPreference') {\n        this._prefs[parsed.params[0]] = parsed.params[1];\n        this._save();\n      } else if (parsed.method === 'removePreference') {\n        delete this._prefs[parsed.params[0]];\n        this._save();\n      } else if (parsed.method === 'clearPreferences') {\n        this._prefs = {};\n        this._save();\n      }\n      session.send('Runtime.evaluate', {\n        expression: `window.DevToolsAPI.embedderMessageAck(${parsed.id}, ${JSON.stringify(result)})`,\n        contextId: event.executionContextId\n      }).catch(e => null);\n    });\n    Promise.all([\n      session.send('Runtime.enable'),\n      session.send('Runtime.addBinding', { name: kBindingName }),\n      session.send('Page.enable'),\n      session.send('Page.addScriptToEvaluateOnNewDocument', { source: `\n        (() => {\n          const init = () => {\n            // Lazy init happens when InspectorFrontendHost is initialized.\n            // At this point DevToolsHost is ready to be used.\n            const host = window.DevToolsHost;\n            const old = host.sendMessageToEmbedder.bind(host);\n            host.sendMessageToEmbedder = message => {\n              if (['getPreferences', 'setPreference', 'removePreference', 'clearPreferences'].includes(JSON.parse(message).method))\n                window.${kBindingName}(message);\n              else\n                old(message);\n            };\n          };\n          let value;\n          Object.defineProperty(window, 'InspectorFrontendHost', {\n            configurable: true,\n            enumerable: true,\n            get() { return value; },\n            set(v) { value = v; init(); },\n          });\n        })()\n      ` }),\n      session.send('Runtime.runIfWaitingForDebugger'),\n    ]).catch(e => null);\n  }\n\n  _save() {\n    // Serialize saves to avoid corruption.\n    this._savePromise = this._savePromise.then(async () => {\n      await fs.promises.writeFile(this._preferencesPath, JSON.stringify(this._prefs)).catch(e => null);\n    });\n  }\n}\n"],"mappings":"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"}