{"version":3,"file":"crPdf.js","names":["_utils","require","_crProtocolHelper","PagePaperFormats","letter","width","height","legal","tabloid","ledger","a0","a1","a2","a3","a4","a5","a6","unitToPixels","convertPrintParameterToInches","text","undefined","unit","substring","length","toLowerCase","valueText","hasOwnProperty","value","Number","assert","isNaN","pixels","CRPDF","constructor","client","_client","generate","options","scale","displayHeaderFooter","headerTemplate","footerTemplate","printBackground","landscape","pageRanges","preferCSSPageSize","margin","tagged","outline","paperWidth","paperHeight","format","marginTop","top","marginLeft","left","marginBottom","bottom","marginRight","right","generateDocumentOutline","generateTaggedPDF","result","send","transferMode","readProtocolStream","stream","exports"],"sources":["../../../src/server/chromium/crPdf.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { assert } from '../../utils';\nimport type * as channels from '@protocol/channels';\nimport type { CRSession } from './crConnection';\nimport { readProtocolStream } from './crProtocolHelper';\n\nconst PagePaperFormats: { [key: string]: { width: number, height: number }} = {\n  letter: { width: 8.5, height: 11 },\n  legal: { width: 8.5, height: 14 },\n  tabloid: { width: 11, height: 17 },\n  ledger: { width: 17, height: 11 },\n  a0: { width: 33.1, height: 46.8 },\n  a1: { width: 23.4, height: 33.1 },\n  a2: { width: 16.54, height: 23.4 },\n  a3: { width: 11.7, height: 16.54 },\n  a4: { width: 8.27, height: 11.7 },\n  a5: { width: 5.83, height: 8.27 },\n  a6: { width: 4.13, height: 5.83 },\n};\n\nconst unitToPixels: { [key: string]: number } = {\n  'px': 1,\n  'in': 96,\n  'cm': 37.8,\n  'mm': 3.78\n};\n\nfunction convertPrintParameterToInches(text: string | undefined): number | undefined {\n  if (text === undefined)\n    return undefined;\n  let unit = text.substring(text.length - 2).toLowerCase();\n  let valueText = '';\n  if (unitToPixels.hasOwnProperty(unit)) {\n    valueText = text.substring(0, text.length - 2);\n  } else {\n    // In case of unknown unit try to parse the whole parameter as number of pixels.\n    // This is consistent with phantom's paperSize behavior.\n    unit = 'px';\n    valueText = text;\n  }\n  const value = Number(valueText);\n  assert(!isNaN(value), 'Failed to parse parameter value: ' + text);\n  const pixels = value * unitToPixels[unit];\n  return pixels / 96;\n}\n\nexport class CRPDF {\n  private _client: CRSession;\n\n  constructor(client: CRSession) {\n    this._client = client;\n  }\n\n  async generate(options: channels.PagePdfParams): Promise<Buffer> {\n    const {\n      scale = 1,\n      displayHeaderFooter = false,\n      headerTemplate = '',\n      footerTemplate = '',\n      printBackground = false,\n      landscape = false,\n      pageRanges = '',\n      preferCSSPageSize = false,\n      margin = {},\n      tagged = false,\n      outline = false\n    } = options;\n\n    let paperWidth = 8.5;\n    let paperHeight = 11;\n    if (options.format) {\n      const format = PagePaperFormats[options.format.toLowerCase()];\n      assert(format, 'Unknown paper format: ' + options.format);\n      paperWidth = format.width;\n      paperHeight = format.height;\n    } else {\n      paperWidth = convertPrintParameterToInches(options.width) || paperWidth;\n      paperHeight = convertPrintParameterToInches(options.height) || paperHeight;\n    }\n\n    const marginTop = convertPrintParameterToInches(margin.top) || 0;\n    const marginLeft = convertPrintParameterToInches(margin.left) || 0;\n    const marginBottom = convertPrintParameterToInches(margin.bottom) || 0;\n    const marginRight = convertPrintParameterToInches(margin.right) || 0;\n    const generateDocumentOutline = outline;\n    const generateTaggedPDF = tagged;\n    const result = await this._client.send('Page.printToPDF', {\n      transferMode: 'ReturnAsStream',\n      landscape,\n      displayHeaderFooter,\n      headerTemplate,\n      footerTemplate,\n      printBackground,\n      scale,\n      paperWidth,\n      paperHeight,\n      marginTop,\n      marginBottom,\n      marginLeft,\n      marginRight,\n      pageRanges,\n      preferCSSPageSize,\n      generateTaggedPDF,\n      generateDocumentOutline\n    });\n    return await readProtocolStream(this._client, result.stream!);\n  }\n}\n"],"mappings":";;;;;;AAiBA,IAAAA,MAAA,GAAAC,OAAA;AAGA,IAAAC,iBAAA,GAAAD,OAAA;AApBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAOA,MAAME,gBAAqE,GAAG;EAC5EC,MAAM,EAAE;IAAEC,KAAK,EAAE,GAAG;IAAEC,MAAM,EAAE;EAAG,CAAC;EAClCC,KAAK,EAAE;IAAEF,KAAK,EAAE,GAAG;IAAEC,MAAM,EAAE;EAAG,CAAC;EACjCE,OAAO,EAAE;IAAEH,KAAK,EAAE,EAAE;IAAEC,MAAM,EAAE;EAAG,CAAC;EAClCG,MAAM,EAAE;IAAEJ,KAAK,EAAE,EAAE;IAAEC,MAAM,EAAE;EAAG,CAAC;EACjCI,EAAE,EAAE;IAAEL,KAAK,EAAE,IAAI;IAAEC,MAAM,EAAE;EAAK,CAAC;EACjCK,EAAE,EAAE;IAAEN,KAAK,EAAE,IAAI;IAAEC,MAAM,EAAE;EAAK,CAAC;EACjCM,EAAE,EAAE;IAAEP,KAAK,EAAE,KAAK;IAAEC,MAAM,EAAE;EAAK,CAAC;EAClCO,EAAE,EAAE;IAAER,KAAK,EAAE,IAAI;IAAEC,MAAM,EAAE;EAAM,CAAC;EAClCQ,EAAE,EAAE;IAAET,KAAK,EAAE,IAAI;IAAEC,MAAM,EAAE;EAAK,CAAC;EACjCS,EAAE,EAAE;IAAEV,KAAK,EAAE,IAAI;IAAEC,MAAM,EAAE;EAAK,CAAC;EACjCU,EAAE,EAAE;IAAEX,KAAK,EAAE,IAAI;IAAEC,MAAM,EAAE;EAAK;AAClC,CAAC;AAED,MAAMW,YAAuC,GAAG;EAC9C,IAAI,EAAE,CAAC;EACP,IAAI,EAAE,EAAE;EACR,IAAI,EAAE,IAAI;EACV,IAAI,EAAE;AACR,CAAC;AAED,SAASC,6BAA6BA,CAACC,IAAwB,EAAsB;EACnF,IAAIA,IAAI,KAAKC,SAAS,EACpB,OAAOA,SAAS;EAClB,IAAIC,IAAI,GAAGF,IAAI,CAACG,SAAS,CAACH,IAAI,CAACI,MAAM,GAAG,CAAC,CAAC,CAACC,WAAW,CAAC,CAAC;EACxD,IAAIC,SAAS,GAAG,EAAE;EAClB,IAAIR,YAAY,CAACS,cAAc,CAACL,IAAI,CAAC,EAAE;IACrCI,SAAS,GAAGN,IAAI,CAACG,SAAS,CAAC,CAAC,EAAEH,IAAI,CAACI,MAAM,GAAG,CAAC,CAAC;EAChD,CAAC,MAAM;IACL;IACA;IACAF,IAAI,GAAG,IAAI;IACXI,SAAS,GAAGN,IAAI;EAClB;EACA,MAAMQ,KAAK,GAAGC,MAAM,CAACH,SAAS,CAAC;EAC/B,IAAAI,aAAM,EAAC,CAACC,KAAK,CAACH,KAAK,CAAC,EAAE,mCAAmC,GAAGR,IAAI,CAAC;EACjE,MAAMY,MAAM,GAAGJ,KAAK,GAAGV,YAAY,CAACI,IAAI,CAAC;EACzC,OAAOU,MAAM,GAAG,EAAE;AACpB;AAEO,MAAMC,KAAK,CAAC;EAGjBC,WAAWA,CAACC,MAAiB,EAAE;IAAA,KAFvBC,OAAO;IAGb,IAAI,CAACA,OAAO,GAAGD,MAAM;EACvB;EAEA,MAAME,QAAQA,CAACC,OAA+B,EAAmB;IAC/D,MAAM;MACJC,KAAK,GAAG,CAAC;MACTC,mBAAmB,GAAG,KAAK;MAC3BC,cAAc,GAAG,EAAE;MACnBC,cAAc,GAAG,EAAE;MACnBC,eAAe,GAAG,KAAK;MACvBC,SAAS,GAAG,KAAK;MACjBC,UAAU,GAAG,EAAE;MACfC,iBAAiB,GAAG,KAAK;MACzBC,MAAM,GAAG,CAAC,CAAC;MACXC,MAAM,GAAG,KAAK;MACdC,OAAO,GAAG;IACZ,CAAC,GAAGX,OAAO;IAEX,IAAIY,UAAU,GAAG,GAAG;IACpB,IAAIC,WAAW,GAAG,EAAE;IACpB,IAAIb,OAAO,CAACc,MAAM,EAAE;MAClB,MAAMA,MAAM,GAAGhD,gBAAgB,CAACkC,OAAO,CAACc,MAAM,CAAC3B,WAAW,CAAC,CAAC,CAAC;MAC7D,IAAAK,aAAM,EAACsB,MAAM,EAAE,wBAAwB,GAAGd,OAAO,CAACc,MAAM,CAAC;MACzDF,UAAU,GAAGE,MAAM,CAAC9C,KAAK;MACzB6C,WAAW,GAAGC,MAAM,CAAC7C,MAAM;IAC7B,CAAC,MAAM;MACL2C,UAAU,GAAG/B,6BAA6B,CAACmB,OAAO,CAAChC,KAAK,CAAC,IAAI4C,UAAU;MACvEC,WAAW,GAAGhC,6BAA6B,CAACmB,OAAO,CAAC/B,MAAM,CAAC,IAAI4C,WAAW;IAC5E;IAEA,MAAME,SAAS,GAAGlC,6BAA6B,CAAC4B,MAAM,CAACO,GAAG,CAAC,IAAI,CAAC;IAChE,MAAMC,UAAU,GAAGpC,6BAA6B,CAAC4B,MAAM,CAACS,IAAI,CAAC,IAAI,CAAC;IAClE,MAAMC,YAAY,GAAGtC,6BAA6B,CAAC4B,MAAM,CAACW,MAAM,CAAC,IAAI,CAAC;IACtE,MAAMC,WAAW,GAAGxC,6BAA6B,CAAC4B,MAAM,CAACa,KAAK,CAAC,IAAI,CAAC;IACpE,MAAMC,uBAAuB,GAAGZ,OAAO;IACvC,MAAMa,iBAAiB,GAAGd,MAAM;IAChC,MAAMe,MAAM,GAAG,MAAM,IAAI,CAAC3B,OAAO,CAAC4B,IAAI,CAAC,iBAAiB,EAAE;MACxDC,YAAY,EAAE,gBAAgB;MAC9BrB,SAAS;MACTJ,mBAAmB;MACnBC,cAAc;MACdC,cAAc;MACdC,eAAe;MACfJ,KAAK;MACLW,UAAU;MACVC,WAAW;MACXE,SAAS;MACTI,YAAY;MACZF,UAAU;MACVI,WAAW;MACXd,UAAU;MACVC,iBAAiB;MACjBgB,iBAAiB;MACjBD;IACF,CAAC,CAAC;IACF,OAAO,MAAM,IAAAK,oCAAkB,EAAC,IAAI,CAAC9B,OAAO,EAAE2B,MAAM,CAACI,MAAO,CAAC;EAC/D;AACF;AAACC,OAAA,CAAAnC,KAAA,GAAAA,KAAA"}