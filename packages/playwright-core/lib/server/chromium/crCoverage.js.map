{"version":3,"file":"crCoverage.js","names":["_eventsHelper","require","_utils","CRCoverage","constructor","client","_jsCoverage","_cssCoverage","JSCoverage","CSSCoverage","startJSCoverage","options","start","stopJSCoverage","stop","startCSSCoverage","stopCSSCoverage","exports","_client","_enabled","_scriptIds","_scriptSources","_eventListeners","_resetOnNavigation","_reportAnonymousScripts","Set","Map","assert","resetOnNavigation","reportAnonymousScripts","clear","eventsHelper","addEventListener","_onScriptParsed","bind","_onExecutionContextsCleared","_onDebuggerPaused","Promise","all","send","callCount","detailed","skip","event","add","scriptId","url","response","_sendMayFail","set","scriptSource","profileResponse","removeEventListeners","coverage","entries","entry","result","has","source","get","push","_stylesheetURLs","_stylesheetSources","_onStyleSheet","header","sourceURL","styleSheetId","text","ruleTrackingResponse","styleSheetIdToCoverage","ruleUsage","ranges","startOffset","endOffset","count","used","keys","convertToDisjointRanges","nestedRanges","points","range","offset","type","sort","a","b","aLength","bLength","hitCountStack","results","lastOffset","point","length","lastResult","end","pop","filter"],"sources":["../../../src/server/chromium/crCoverage.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { CRSession } from './crConnection';\nimport type { RegisteredListener } from '../../utils/eventsHelper';\nimport { eventsHelper } from '../../utils/eventsHelper';\nimport type { Protocol } from './protocol';\nimport type * as channels from '@protocol/channels';\nimport { assert } from '../../utils';\n\nexport class CRCoverage {\n  private _jsCoverage: JSCoverage;\n  private _cssCoverage: CSSCoverage;\n\n  constructor(client: CRSession) {\n    this._jsCoverage = new JSCoverage(client);\n    this._cssCoverage = new CSSCoverage(client);\n  }\n\n  async startJSCoverage(options: channels.PageStartJSCoverageParams) {\n    return await this._jsCoverage.start(options);\n  }\n\n  async stopJSCoverage(): Promise<channels.PageStopJSCoverageResult> {\n    return await this._jsCoverage.stop();\n  }\n\n  async startCSSCoverage(options: channels.PageStartCSSCoverageParams) {\n    return await this._cssCoverage.start(options);\n  }\n\n  async stopCSSCoverage(): Promise<channels.PageStopCSSCoverageResult> {\n    return await this._cssCoverage.stop();\n  }\n}\n\nclass JSCoverage {\n  _client: CRSession;\n  _enabled: boolean;\n  _scriptIds: Set<string>;\n  _scriptSources: Map<string, string>;\n  _eventListeners: RegisteredListener[];\n  _resetOnNavigation: boolean;\n  _reportAnonymousScripts = false;\n\n  constructor(client: CRSession) {\n    this._client = client;\n    this._enabled = false;\n    this._scriptIds = new Set();\n    this._scriptSources = new Map();\n    this._eventListeners = [];\n    this._resetOnNavigation = false;\n  }\n\n  async start(options: channels.PageStartJSCoverageParams) {\n    assert(!this._enabled, 'JSCoverage is already enabled');\n    const {\n      resetOnNavigation = true,\n      reportAnonymousScripts = false\n    } = options;\n    this._resetOnNavigation = resetOnNavigation;\n    this._reportAnonymousScripts = reportAnonymousScripts;\n    this._enabled = true;\n    this._scriptIds.clear();\n    this._scriptSources.clear();\n    this._eventListeners = [\n      eventsHelper.addEventListener(this._client, 'Debugger.scriptParsed', this._onScriptParsed.bind(this)),\n      eventsHelper.addEventListener(this._client, 'Runtime.executionContextsCleared', this._onExecutionContextsCleared.bind(this)),\n      eventsHelper.addEventListener(this._client, 'Debugger.paused', this._onDebuggerPaused.bind(this)),\n    ];\n    await Promise.all([\n      this._client.send('Profiler.enable'),\n      this._client.send('Profiler.startPreciseCoverage', { callCount: true, detailed: true }),\n      this._client.send('Debugger.enable'),\n      this._client.send('Debugger.setSkipAllPauses', { skip: true })\n    ]);\n  }\n\n  _onDebuggerPaused() {\n    this._client.send('Debugger.resume');\n  }\n\n  _onExecutionContextsCleared() {\n    if (!this._resetOnNavigation)\n      return;\n    this._scriptIds.clear();\n    this._scriptSources.clear();\n  }\n\n  async _onScriptParsed(event: Protocol.Debugger.scriptParsedPayload) {\n    this._scriptIds.add(event.scriptId);\n    // Ignore other anonymous scripts unless the reportAnonymousScripts option is true.\n    if (!event.url && !this._reportAnonymousScripts)\n      return;\n    // This might fail if the page has already navigated away.\n    const response = await this._client._sendMayFail('Debugger.getScriptSource', { scriptId: event.scriptId });\n    if (response)\n      this._scriptSources.set(event.scriptId, response.scriptSource);\n  }\n\n  async stop(): Promise<channels.PageStopJSCoverageResult> {\n    assert(this._enabled, 'JSCoverage is not enabled');\n    this._enabled = false;\n    const [profileResponse] = await Promise.all([\n      this._client.send('Profiler.takePreciseCoverage'),\n      this._client.send('Profiler.stopPreciseCoverage'),\n      this._client.send('Profiler.disable'),\n      this._client.send('Debugger.disable'),\n    ] as const);\n    eventsHelper.removeEventListeners(this._eventListeners);\n\n    const coverage: channels.PageStopJSCoverageResult = { entries: [] };\n    for (const entry of profileResponse.result) {\n      if (!this._scriptIds.has(entry.scriptId))\n        continue;\n      if (!entry.url && !this._reportAnonymousScripts)\n        continue;\n      const source = this._scriptSources.get(entry.scriptId);\n      if (source)\n        coverage.entries.push({ ...entry, source });\n      else\n        coverage.entries.push(entry);\n    }\n    return coverage;\n  }\n}\n\nclass CSSCoverage {\n  _client: CRSession;\n  _enabled: boolean;\n  _stylesheetURLs: Map<string, string>;\n  _stylesheetSources: Map<string, string>;\n  _eventListeners: RegisteredListener[];\n  _resetOnNavigation: boolean;\n\n  constructor(client: CRSession) {\n    this._client = client;\n    this._enabled = false;\n    this._stylesheetURLs = new Map();\n    this._stylesheetSources = new Map();\n    this._eventListeners = [];\n    this._resetOnNavigation = false;\n  }\n\n  async start(options: channels.PageStartCSSCoverageParams) {\n    assert(!this._enabled, 'CSSCoverage is already enabled');\n    const { resetOnNavigation = true } = options;\n    this._resetOnNavigation = resetOnNavigation;\n    this._enabled = true;\n    this._stylesheetURLs.clear();\n    this._stylesheetSources.clear();\n    this._eventListeners = [\n      eventsHelper.addEventListener(this._client, 'CSS.styleSheetAdded', this._onStyleSheet.bind(this)),\n      eventsHelper.addEventListener(this._client, 'Runtime.executionContextsCleared', this._onExecutionContextsCleared.bind(this)),\n    ];\n    await Promise.all([\n      this._client.send('DOM.enable'),\n      this._client.send('CSS.enable'),\n      this._client.send('CSS.startRuleUsageTracking'),\n    ]);\n  }\n\n  _onExecutionContextsCleared() {\n    if (!this._resetOnNavigation)\n      return;\n    this._stylesheetURLs.clear();\n    this._stylesheetSources.clear();\n  }\n\n  async _onStyleSheet(event: Protocol.CSS.styleSheetAddedPayload) {\n    const header = event.header;\n    // Ignore anonymous scripts\n    if (!header.sourceURL)\n      return;\n    // This might fail if the page has already navigated away.\n    const response = await this._client._sendMayFail('CSS.getStyleSheetText', { styleSheetId: header.styleSheetId });\n    if (response) {\n      this._stylesheetURLs.set(header.styleSheetId, header.sourceURL);\n      this._stylesheetSources.set(header.styleSheetId, response.text);\n    }\n  }\n\n  async stop(): Promise<channels.PageStopCSSCoverageResult> {\n    assert(this._enabled, 'CSSCoverage is not enabled');\n    this._enabled = false;\n    const ruleTrackingResponse = await this._client.send('CSS.stopRuleUsageTracking');\n    await Promise.all([\n      this._client.send('CSS.disable'),\n      this._client.send('DOM.disable'),\n    ]);\n    eventsHelper.removeEventListeners(this._eventListeners);\n\n    // aggregate by styleSheetId\n    const styleSheetIdToCoverage = new Map();\n    for (const entry of ruleTrackingResponse.ruleUsage) {\n      let ranges = styleSheetIdToCoverage.get(entry.styleSheetId);\n      if (!ranges) {\n        ranges = [];\n        styleSheetIdToCoverage.set(entry.styleSheetId, ranges);\n      }\n      ranges.push({\n        startOffset: entry.startOffset,\n        endOffset: entry.endOffset,\n        count: entry.used ? 1 : 0,\n      });\n    }\n\n    const coverage: channels.PageStopCSSCoverageResult = { entries: [] };\n    for (const styleSheetId of this._stylesheetURLs.keys()) {\n      const url = this._stylesheetURLs.get(styleSheetId)!;\n      const text = this._stylesheetSources.get(styleSheetId)!;\n      const ranges = convertToDisjointRanges(styleSheetIdToCoverage.get(styleSheetId) || []);\n      coverage.entries.push({ url, ranges, text });\n    }\n\n    return coverage;\n  }\n}\n\nfunction convertToDisjointRanges(nestedRanges: {\n    startOffset: number;\n    endOffset: number;\n    count: number; }[]): { start: number; end: number; }[] {\n  const points = [];\n  for (const range of nestedRanges) {\n    points.push({ offset: range.startOffset, type: 0, range });\n    points.push({ offset: range.endOffset, type: 1, range });\n  }\n  // Sort points to form a valid parenthesis sequence.\n  points.sort((a, b) => {\n    // Sort with increasing offsets.\n    if (a.offset !== b.offset)\n      return a.offset - b.offset;\n    // All \"end\" points should go before \"start\" points.\n    if (a.type !== b.type)\n      return b.type - a.type;\n    const aLength = a.range.endOffset - a.range.startOffset;\n    const bLength = b.range.endOffset - b.range.startOffset;\n    // For two \"start\" points, the one with longer range goes first.\n    if (a.type === 0)\n      return bLength - aLength;\n    // For two \"end\" points, the one with shorter range goes first.\n    return aLength - bLength;\n  });\n\n  const hitCountStack = [];\n  const results: { start: number; end: number; }[] = [];\n  let lastOffset = 0;\n  // Run scanning line to intersect all ranges.\n  for (const point of points) {\n    if (hitCountStack.length && lastOffset < point.offset && hitCountStack[hitCountStack.length - 1] > 0) {\n      const lastResult = results.length ? results[results.length - 1] : null;\n      if (lastResult && lastResult.end === lastOffset)\n        lastResult.end = point.offset;\n      else\n        results.push({ start: lastOffset, end: point.offset });\n    }\n    lastOffset = point.offset;\n    if (point.type === 0)\n      hitCountStack.push(point.range.count);\n    else\n      hitCountStack.pop();\n  }\n  // Filter out empty ranges.\n  return results.filter(range => range.end - range.start > 1);\n}\n"],"mappings":"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"}