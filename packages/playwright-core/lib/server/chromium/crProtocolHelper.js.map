{"version":3,"file":"crProtocolHelper.js","names":["_fs","_interopRequireDefault","require","_fileUtils","_stackTrace","obj","__esModule","default","getExceptionMessage","exceptionDetails","exception","description","String","value","message","text","stackTrace","callframe","callFrames","location","url","lineNumber","columnNumber","functionName","releaseObject","client","objectId","send","catch","error","saveProtocolStream","handle","path","eof","mkdirIfNeeded","fd","fs","promises","open","response","buf","Buffer","from","data","base64Encoded","undefined","write","close","readProtocolStream","chunks","push","concat","toConsoleMessageLocation","length","exceptionToError","_exceptionDetails$exc","_nameOverride$value","messageWithStack","lines","split","firstStackTraceLine","findIndex","line","startsWith","messageWithName","stack","slice","join","name","splitErrorMessage","err","Error","nameOverride","preview","properties","find","o","toModifiersMask","modifiers","mask","has","toButtonsMask","buttons"],"sources":["../../../src/server/chromium/crProtocolHelper.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { CRSession } from './crConnection';\nimport type { Protocol } from './protocol';\nimport fs from 'fs';\nimport type * as types from '../types';\nimport { mkdirIfNeeded } from '../../utils/fileUtils';\nimport { splitErrorMessage } from '../../utils/stackTrace';\n\nexport function getExceptionMessage(exceptionDetails: Protocol.Runtime.ExceptionDetails): string {\n  if (exceptionDetails.exception)\n    return exceptionDetails.exception.description || String(exceptionDetails.exception.value);\n  let message = exceptionDetails.text;\n  if (exceptionDetails.stackTrace) {\n    for (const callframe of exceptionDetails.stackTrace.callFrames) {\n      const location = callframe.url + ':' + callframe.lineNumber + ':' + callframe.columnNumber;\n      const functionName = callframe.functionName || '<anonymous>';\n      message += `\\n    at ${functionName} (${location})`;\n    }\n  }\n  return message;\n}\n\nexport async function releaseObject(client: CRSession, objectId: string) {\n  await client.send('Runtime.releaseObject', { objectId }).catch(error => { });\n}\n\nexport async function saveProtocolStream(client: CRSession, handle: string, path: string) {\n  let eof = false;\n  await mkdirIfNeeded(path);\n  const fd = await fs.promises.open(path, 'w');\n  while (!eof) {\n    const response = await client.send('IO.read', { handle });\n    eof = response.eof;\n    const buf = Buffer.from(response.data, response.base64Encoded ? 'base64' : undefined);\n    await fd.write(buf);\n  }\n  await fd.close();\n  await client.send('IO.close', { handle });\n}\n\nexport async function readProtocolStream(client: CRSession, handle: string): Promise<Buffer> {\n  let eof = false;\n  const chunks = [];\n  while (!eof) {\n    const response = await client.send('IO.read', { handle });\n    eof = response.eof;\n    const buf = Buffer.from(response.data, response.base64Encoded ? 'base64' : undefined);\n    chunks.push(buf);\n  }\n  await client.send('IO.close', { handle });\n  return Buffer.concat(chunks);\n}\n\nexport function toConsoleMessageLocation(stackTrace: Protocol.Runtime.StackTrace | undefined): types.ConsoleMessageLocation {\n  return stackTrace && stackTrace.callFrames.length ? {\n    url: stackTrace.callFrames[0].url,\n    lineNumber: stackTrace.callFrames[0].lineNumber,\n    columnNumber: stackTrace.callFrames[0].columnNumber,\n  } : { url: '', lineNumber: 0, columnNumber: 0 };\n}\n\nexport function exceptionToError(exceptionDetails: Protocol.Runtime.ExceptionDetails): Error {\n  const messageWithStack = getExceptionMessage(exceptionDetails);\n  const lines = messageWithStack.split('\\n');\n  const firstStackTraceLine = lines.findIndex(line => line.startsWith('    at'));\n  let messageWithName = '';\n  let stack = '';\n  if (firstStackTraceLine === -1) {\n    messageWithName = messageWithStack;\n  } else {\n    messageWithName = lines.slice(0, firstStackTraceLine).join('\\n');\n    stack = messageWithStack;\n  }\n  const { name, message } = splitErrorMessage(messageWithName);\n\n  const err = new Error(message);\n  err.stack = stack;\n  const nameOverride = exceptionDetails.exception?.preview?.properties.find(o => o.name === 'name');\n  err.name = nameOverride ? nameOverride.value ?? 'Error' : name;\n  return err;\n}\n\nexport function toModifiersMask(modifiers: Set<types.KeyboardModifier>): number {\n  let mask = 0;\n  if (modifiers.has('Alt'))\n    mask |= 1;\n  if (modifiers.has('Control'))\n    mask |= 2;\n  if (modifiers.has('Meta'))\n    mask |= 4;\n  if (modifiers.has('Shift'))\n    mask |= 8;\n  return mask;\n}\n\nexport function toButtonsMask(buttons: Set<types.MouseButton>): number {\n  let mask = 0;\n  if (buttons.has('left'))\n    mask |= 1;\n  if (buttons.has('right'))\n    mask |= 2;\n  if (buttons.has('middle'))\n    mask |= 4;\n  return mask;\n}\n"],"mappings":"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"}