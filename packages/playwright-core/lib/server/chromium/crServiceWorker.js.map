{"version":3,"file":"crServiceWorker.js","names":["_page","require","_crExecutionContext","_crNetworkManager","network","_interopRequireWildcard","_browserContext","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","CRServiceWorker","Worker","constructor","browserContext","session","url","_networkManager","_session","process","env","PW_EXPERIMENTAL_SERVICE_WORKER_NETWORK_EVENTS","CRNetworkManager","once","event","_createExecutionContext","CRExecutionContext","context","_isNetworkInspectionEnabled","updateRequestInterception","updateExtraHTTPHeaders","updateHttpCredentials","updateOffline","addSession","undefined","catch","send","on","_sendMayFail","didClose","_this$_networkManager","removeSession","dispose","_this$_networkManager2","setOffline","_options","offline","_this$_networkManager3","authenticate","httpCredentials","_this$_networkManager4","setExtraHTTPHeaders","extraHTTPHeaders","_this$_networkManager5","setRequestInterception","needsRequestInterception","_requestInterceptor","reportRequestFinished","request","response","emit","BrowserContext","Events","RequestFinished","requestFailed","_canceled","RequestFailed","requestReceivedResponse","Response","requestStarted","route","Request","_this$_browserContext","_this$_browserContext2","Route","continue","isFallback","serviceWorkers","exports"],"sources":["../../../src/server/chromium/crServiceWorker.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\nimport { Worker } from '../page';\nimport type { CRBrowserContext } from './crBrowser';\nimport type { CRSession } from './crConnection';\nimport { CRExecutionContext } from './crExecutionContext';\nimport { CRNetworkManager } from './crNetworkManager';\nimport * as network from '../network';\nimport { BrowserContext } from '../browserContext';\n\nexport class CRServiceWorker extends Worker {\n  readonly _browserContext: CRBrowserContext;\n  readonly _networkManager?: CRNetworkManager;\n  private _session: CRSession;\n\n  constructor(browserContext: CRBrowserContext, session: CRSession, url: string) {\n    super(browserContext, url);\n    this._session = session;\n    this._browserContext = browserContext;\n    if (!!process.env.PW_EXPERIMENTAL_SERVICE_WORKER_NETWORK_EVENTS)\n      this._networkManager = new CRNetworkManager(null, this);\n    session.once('Runtime.executionContextCreated', event => {\n      this._createExecutionContext(new CRExecutionContext(session, event.context));\n    });\n\n    if (this._networkManager && this._isNetworkInspectionEnabled()) {\n      this.updateRequestInterception();\n      this.updateExtraHTTPHeaders();\n      this.updateHttpCredentials();\n      this.updateOffline();\n      this._networkManager.addSession(session, undefined, true /* isMain */).catch(() => {});\n    }\n\n    session.send('Runtime.enable', {}).catch(e => { });\n    session.send('Runtime.runIfWaitingForDebugger').catch(e => { });\n    session.on('Inspector.targetReloadedAfterCrash', () => {\n      // Resume service worker after restart.\n      session._sendMayFail('Runtime.runIfWaitingForDebugger', {});\n    });\n  }\n\n  override didClose() {\n    this._networkManager?.removeSession(this._session);\n    this._session.dispose();\n    super.didClose();\n  }\n\n  async updateOffline(): Promise<void> {\n    if (!this._isNetworkInspectionEnabled())\n      return;\n    await this._networkManager?.setOffline(!!this._browserContext._options.offline).catch(() => {});\n  }\n\n  async updateHttpCredentials(): Promise<void> {\n    if (!this._isNetworkInspectionEnabled())\n      return;\n    await this._networkManager?.authenticate(this._browserContext._options.httpCredentials || null).catch(() => {});\n  }\n\n  async updateExtraHTTPHeaders(): Promise<void> {\n    if (!this._isNetworkInspectionEnabled())\n      return;\n    await this._networkManager?.setExtraHTTPHeaders(this._browserContext._options.extraHTTPHeaders || []).catch(() => {});\n  }\n\n  async updateRequestInterception(): Promise<void> {\n    if (!this._isNetworkInspectionEnabled())\n      return;\n    await this._networkManager?.setRequestInterception(this.needsRequestInterception()).catch(() => {});\n  }\n\n  needsRequestInterception(): boolean {\n    return this._isNetworkInspectionEnabled() && !!this._browserContext._requestInterceptor;\n  }\n\n  reportRequestFinished(request: network.Request, response: network.Response | null) {\n    this._browserContext.emit(BrowserContext.Events.RequestFinished, { request, response });\n  }\n\n  requestFailed(request: network.Request, _canceled: boolean) {\n    this._browserContext.emit(BrowserContext.Events.RequestFailed, request);\n  }\n\n  requestReceivedResponse(response: network.Response) {\n    this._browserContext.emit(BrowserContext.Events.Response, response);\n  }\n\n  requestStarted(request: network.Request, route?: network.RouteDelegate) {\n    this._browserContext.emit(BrowserContext.Events.Request, request);\n    if (route) {\n      const r = new network.Route(request, route);\n      if (this._browserContext._requestInterceptor?.(r, request))\n        return;\n      r.continue({ isFallback: true }).catch(() => {});\n    }\n  }\n\n  private _isNetworkInspectionEnabled(): boolean {\n    return this._browserContext._options.serviceWorkers !== 'block';\n  }\n}\n"],"mappings":"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"}