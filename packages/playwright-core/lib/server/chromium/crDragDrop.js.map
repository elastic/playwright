{"version":3,"file":"crDragDrop.js","names":["_utils","require","_crProtocolHelper","DragManager","constructor","page","_crPage","_dragState","_lastPosition","x","y","cancelDrag","_mainFrameSession","_client","send","type","data","items","dragOperationsMask","interceptDragCausedByMove","button","buttons","modifiers","moveCallback","toModifiersMask","client","onDragIntercepted","dragInterceptedPromise","Promise","setupDragListeners","didStartDrag","resolve","dragEvent","dragListener","event","mouseListener","callback","window","addEventListener","once","capture","setTimeout","defaultPrevented","__cleanupDrag","val","removeEventListener","_page","safeNonStallingEvaluateInAllFrames","toString","on","enabled","off","expectingDrag","all","frames","map","frame","nonStallingEvaluateInExistingContext","catch","some","isDragging","drop","assert","exports"],"sources":["../../../src/server/chromium/crDragDrop.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n*/\nimport type { CRPage } from './crPage';\nimport type * as types from '../types';\nimport { assert } from '../../utils';\nimport type { Protocol } from './protocol';\nimport { toModifiersMask } from './crProtocolHelper';\n\ndeclare global {\n  interface Window {\n    __cleanupDrag?: () => Promise<boolean>;\n  }\n}\n\nexport class DragManager {\n  private _crPage: CRPage;\n  private _dragState: Protocol.Input.DragData | null = null;\n  private _lastPosition = { x: 0, y: 0 };\n  constructor(page: CRPage) {\n    this._crPage = page;\n  }\n\n  async cancelDrag() {\n    if (!this._dragState)\n      return false;\n    await this._crPage._mainFrameSession._client.send('Input.dispatchDragEvent', {\n      type: 'dragCancel',\n      x: this._lastPosition.x,\n      y: this._lastPosition.y,\n      data: {\n        items: [],\n        dragOperationsMask: 0xFFFF,\n      }\n    });\n    this._dragState = null;\n    return true;\n  }\n\n  async interceptDragCausedByMove(x: number, y: number, button: types.MouseButton | 'none', buttons: Set<types.MouseButton>, modifiers: Set<types.KeyboardModifier>, moveCallback: () => Promise<void>): Promise<void> {\n    this._lastPosition = { x, y };\n    if (this._dragState) {\n      await this._crPage._mainFrameSession._client.send('Input.dispatchDragEvent', {\n        type: 'dragOver',\n        x,\n        y,\n        data: this._dragState,\n        modifiers: toModifiersMask(modifiers),\n      });\n      return;\n    }\n    if (button !== 'left')\n      return moveCallback();\n\n    const client = this._crPage._mainFrameSession._client;\n    let onDragIntercepted: (payload: Protocol.Input.dragInterceptedPayload) => void;\n    const dragInterceptedPromise = new Promise<Protocol.Input.dragInterceptedPayload>(x => onDragIntercepted = x);\n\n    function setupDragListeners() {\n      let didStartDrag = Promise.resolve(false);\n      let dragEvent: Event|null = null;\n      const dragListener = (event: Event) => dragEvent = event;\n      const mouseListener = () => {\n        didStartDrag = new Promise<boolean>(callback => {\n          window.addEventListener('dragstart', dragListener, { once: true, capture: true });\n          setTimeout(() => callback(dragEvent ? !dragEvent.defaultPrevented : false), 0);\n        });\n      };\n      window.addEventListener('mousemove', mouseListener, { once: true, capture: true });\n      window.__cleanupDrag = async () => {\n        const val = await didStartDrag;\n        window.removeEventListener('mousemove', mouseListener, { capture: true });\n        window.removeEventListener('dragstart', dragListener, { capture: true });\n        delete window.__cleanupDrag;\n        return val;\n      };\n    }\n\n    await this._crPage._page.safeNonStallingEvaluateInAllFrames(`(${setupDragListeners.toString()})()`, 'utility');\n\n    client.on('Input.dragIntercepted', onDragIntercepted!);\n    try {\n      await client.send('Input.setInterceptDrags', { enabled: true });\n    } catch {\n      // If Input.setInterceptDrags is not supported, just do a regular move.\n      // This can be removed once we stop supporting old Electron.\n      client.off('Input.dragIntercepted', onDragIntercepted!);\n      return moveCallback();\n    }\n    await moveCallback();\n\n    const expectingDrag = (await Promise.all(this._crPage._page.frames().map(async frame => {\n      return frame.nonStallingEvaluateInExistingContext('window.__cleanupDrag && window.__cleanupDrag()', 'utility').catch(() => false);\n    }))).some(x => x);\n    this._dragState = expectingDrag ? (await dragInterceptedPromise).data : null;\n    client.off('Input.dragIntercepted', onDragIntercepted!);\n    await client.send('Input.setInterceptDrags', { enabled: false });\n\n\n    if (this._dragState) {\n      await this._crPage._mainFrameSession._client.send('Input.dispatchDragEvent', {\n        type: 'dragEnter',\n        x,\n        y,\n        data: this._dragState,\n        modifiers: toModifiersMask(modifiers),\n      });\n    }\n  }\n\n  isDragging() {\n    return !!this._dragState;\n  }\n\n  async drop(x: number, y: number, modifiers: Set<types.KeyboardModifier>) {\n    assert(this._dragState, 'missing drag state');\n    await this._crPage._mainFrameSession._client.send('Input.dispatchDragEvent', {\n      type: 'drop',\n      x,\n      y,\n      data: this._dragState,\n      modifiers: toModifiersMask(modifiers),\n    });\n    this._dragState = null;\n  }\n}\n"],"mappings":"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"}