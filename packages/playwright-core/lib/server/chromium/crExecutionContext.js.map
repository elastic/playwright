{"version":3,"file":"crExecutionContext.js","names":["_crProtocolHelper","require","js","_interopRequireWildcard","_stackTrace","_utilityScriptSerializers","_protocolError","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","CRExecutionContext","constructor","client","contextPayload","_client","_contextId","id","rawEvaluateJSON","expression","exceptionDetails","result","remoteObject","send","contextId","returnByValue","catch","rewriteError","JavaScriptErrorInEvaluate","getExceptionMessage","value","rawEvaluateHandle","objectId","rawCallFunctionNoReply","func","args","functionDeclaration","toString","arguments","map","JSHandle","_objectId","executionContextId","userGesture","evaluateWithArguments","utilityScript","values","objectIds","awaitPromise","parseEvaluationResultValue","_context","createHandle","getProperties","context","response","ownProperties","Map","property","enumerable","name","subtype","type","renderPreview","potentiallyUnserializableValue","releaseHandle","releaseObject","objectCount","prototypeObjectId","match","objects","description","exports","error","message","includes","TypeError","startsWith","rewriteErrorMessage","isJavaScriptErrorInEvaluate","isSessionClosedError","Error","unserializableValue","parseUnserializableValue","object","String","preview","tokens","properties","push","join","sparseArrayToString"],"sources":["../../../src/server/chromium/crExecutionContext.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { CRSession } from './crConnection';\nimport { getExceptionMessage, releaseObject } from './crProtocolHelper';\nimport type { Protocol } from './protocol';\nimport * as js from '../javascript';\nimport { rewriteErrorMessage } from '../../utils/stackTrace';\nimport { parseEvaluationResultValue } from '../isomorphic/utilityScriptSerializers';\nimport { isSessionClosedError } from '../protocolError';\n\nexport class CRExecutionContext implements js.ExecutionContextDelegate {\n  _client: CRSession;\n  _contextId: number;\n\n  constructor(client: CRSession, contextPayload: Protocol.Runtime.ExecutionContextDescription) {\n    this._client = client;\n    this._contextId = contextPayload.id;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.evaluate', {\n      expression,\n      contextId: this._contextId,\n      returnByValue: true,\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new js.JavaScriptErrorInEvaluate(getExceptionMessage(exceptionDetails));\n    return remoteObject.value;\n  }\n\n  async rawEvaluateHandle(expression: string): Promise<js.ObjectId> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.evaluate', {\n      expression,\n      contextId: this._contextId,\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new js.JavaScriptErrorInEvaluate(getExceptionMessage(exceptionDetails));\n    return remoteObject.objectId!;\n  }\n\n  rawCallFunctionNoReply(func: Function, ...args: any[]) {\n    this._client.send('Runtime.callFunctionOn', {\n      functionDeclaration: func.toString(),\n      arguments: args.map(a => a instanceof js.JSHandle ? { objectId: a._objectId } : { value: a }),\n      returnByValue: true,\n      executionContextId: this._contextId,\n      userGesture: true\n    }).catch(() => {});\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], objectIds: string[]): Promise<any> {\n    const { exceptionDetails, result: remoteObject } = await this._client.send('Runtime.callFunctionOn', {\n      functionDeclaration: expression,\n      objectId: utilityScript._objectId,\n      arguments: [\n        { objectId: utilityScript._objectId },\n        ...values.map(value => ({ value })),\n        ...objectIds.map(objectId => ({ objectId })),\n      ],\n      returnByValue,\n      awaitPromise: true,\n      userGesture: true\n    }).catch(rewriteError);\n    if (exceptionDetails)\n      throw new js.JavaScriptErrorInEvaluate(getExceptionMessage(exceptionDetails));\n    return returnByValue ? parseEvaluationResultValue(remoteObject.value) : utilityScript._context.createHandle(remoteObject);\n  }\n\n  async getProperties(context: js.ExecutionContext, objectId: js.ObjectId): Promise<Map<string, js.JSHandle>> {\n    const response = await this._client.send('Runtime.getProperties', {\n      objectId,\n      ownProperties: true\n    });\n    const result = new Map();\n    for (const property of response.result) {\n      if (!property.enumerable || !property.value)\n        continue;\n      result.set(property.name, context.createHandle(property.value));\n    }\n    return result;\n  }\n\n  createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n    return new js.JSHandle(context, remoteObject.subtype || remoteObject.type, renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n  }\n\n  async releaseHandle(objectId: js.ObjectId): Promise<void> {\n    await releaseObject(this._client, objectId);\n  }\n\n  async objectCount(objectId: js.ObjectId): Promise<number> {\n    const result = await this._client.send('Runtime.queryObjects', {\n      prototypeObjectId: objectId\n    });\n    const match = result.objects.description!.match(/Array\\((\\d+)\\)/)!;\n    return +match[1];\n  }\n}\n\nfunction rewriteError(error: Error): Protocol.Runtime.evaluateReturnValue {\n  if (error.message.includes('Object reference chain is too long'))\n    return { result: { type: 'undefined' } };\n  if (error.message.includes('Object couldn\\'t be returned by value'))\n    return { result: { type: 'undefined' } };\n\n  if (error instanceof TypeError && error.message.startsWith('Converting circular structure to JSON'))\n    rewriteErrorMessage(error, error.message + ' Are you passing a nested JSHandle?');\n  if (!js.isJavaScriptErrorInEvaluate(error) && !isSessionClosedError(error))\n    throw new Error('Execution context was destroyed, most likely because of a navigation.');\n  throw error;\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const unserializableValue = remoteObject.unserializableValue;\n  return unserializableValue ? js.parseUnserializableValue(unserializableValue) : value;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if ('value' in object)\n    return String(object.value);\n  if (object.unserializableValue)\n    return String(object.unserializableValue);\n\n  if (object.description === 'Object' && object.preview) {\n    const tokens = [];\n    for (const { name, value } of object.preview.properties)\n      tokens.push(`${name}: ${value}`);\n    return `{${tokens.join(', ')}}`;\n  }\n  if (object.subtype === 'array' && object.preview)\n    return js.sparseArrayToString(object.preview.properties);\n  return object.description;\n}\n"],"mappings":"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"}