{"version":3,"file":"formData.js","names":["_utilsBundle","require","MultipartFormData","constructor","_boundary","_chunks","generateUniqueBoundaryString","contentTypeHeader","addField","name","value","_beginMultiPartHeader","_finishMultiPartHeader","push","Buffer","from","_finishMultiPartField","addFileField","mimeType","mime","getType","buffer","finish","_addBoundary","concat","isLastBoundary","exports","alphaNumericEncodingMap","charCodes","i","Math","floor","random","length","String","fromCharCode"],"sources":["../../src/server/formData.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { mime } from '../utilsBundle';\nimport type * as channels from '@protocol/channels';\n\nexport class MultipartFormData {\n  private readonly _boundary: string;\n  private readonly _chunks: Buffer[] = [];\n\n  constructor() {\n    this._boundary = generateUniqueBoundaryString();\n  }\n\n  contentTypeHeader() {\n    return `multipart/form-data; boundary=${this._boundary}`;\n  }\n\n  addField(name: string, value: string) {\n    this._beginMultiPartHeader(name);\n    this._finishMultiPartHeader();\n    this._chunks.push(Buffer.from(value));\n    this._finishMultiPartField();\n  }\n\n  addFileField(name: string, value: NonNullable<channels.FormField['file']>) {\n    this._beginMultiPartHeader(name);\n    this._chunks.push(Buffer.from(`; filename=\"${value.name}\"`));\n    this._chunks.push(Buffer.from(`\\r\\ncontent-type: ${value.mimeType || mime.getType(value.name) || 'application/octet-stream'}`));\n    this._finishMultiPartHeader();\n    this._chunks.push(value.buffer);\n    this._finishMultiPartField();\n  }\n\n  finish(): Buffer {\n    this._addBoundary(true);\n    return Buffer.concat(this._chunks);\n  }\n\n  private _beginMultiPartHeader(name: string) {\n    this._addBoundary();\n    this._chunks.push(Buffer.from(`content-disposition: form-data; name=\"${name}\"`));\n  }\n\n  private _finishMultiPartHeader() {\n    this._chunks.push(Buffer.from(`\\r\\n\\r\\n`));\n  }\n\n  private _finishMultiPartField() {\n    this._chunks.push(Buffer.from(`\\r\\n`));\n  }\n\n  private _addBoundary(isLastBoundary?: boolean) {\n    this._chunks.push(Buffer.from('--' + this._boundary));\n    if (isLastBoundary)\n      this._chunks.push(Buffer.from('--'));\n    this._chunks.push(Buffer.from('\\r\\n'));\n  }\n}\n\nconst alphaNumericEncodingMap = [\n  0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0x48,\n  0x49, 0x4A, 0x4B, 0x4C, 0x4D, 0x4E, 0x4F, 0x50,\n  0x51, 0x52, 0x53, 0x54, 0x55, 0x56, 0x57, 0x58,\n  0x59, 0x5A, 0x61, 0x62, 0x63, 0x64, 0x65, 0x66,\n  0x67, 0x68, 0x69, 0x6A, 0x6B, 0x6C, 0x6D, 0x6E,\n  0x6F, 0x70, 0x71, 0x72, 0x73, 0x74, 0x75, 0x76,\n  0x77, 0x78, 0x79, 0x7A, 0x30, 0x31, 0x32, 0x33,\n  0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x41, 0x42\n];\n\n// See generateUniqueBoundaryString() in WebKit\nfunction generateUniqueBoundaryString(): string {\n  const charCodes = [];\n  for (let i = 0; i < 16; i++)\n    charCodes.push(alphaNumericEncodingMap[Math.floor(Math.random() * alphaNumericEncodingMap.length)]);\n  return '----WebKitFormBoundary' + String.fromCharCode(...charCodes);\n}\n"],"mappings":"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"}