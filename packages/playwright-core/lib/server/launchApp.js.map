{"version":3,"file":"launchApp.js","names":["_fs","_interopRequireDefault","require","_path","_registry","_utils","_instrumentation","obj","__esModule","default","launchApp","browserType","options","_options$persistentCo","_options$persistentCo2","_options$persistentCo3","args","persistentContextOptions","name","push","windowSize","width","height","windowPosition","x","y","context","launchPersistentContext","serverSideCallMetadata","channel","executablePath","findChromiumChannel","sdkLanguage","undefined","noDefaultViewport","ignoreDefaultArgs","colorScheme","acceptDownloads","isUnderTest","page","pages","process","platform","on","newPage","mainFrame","url","bringToFront","close","installAppIcon","icon","fs","promises","readFile","resolve","crPage","_delegate","_mainFrameSession","_client","send","image","toString","syncLocalStorageWithSettings","appName","settingsFile","path","join","registryDirectory","exposeBinding","_","settings","mkdirSync","dirname","recursive","writeFileSync","catch","addInitScript","String","location","protocol","window","top","Object","entries","map","k","v","localStorage","saveSettings","_saveSerializedSettings","JSON","stringify"],"sources":["../../src/server/launchApp.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport path from 'path';\nimport type { Page } from './page';\nimport { findChromiumChannel } from './registry';\nimport { isUnderTest } from '../utils';\nimport { serverSideCallMetadata } from './instrumentation';\nimport type * as types from './types';\nimport type { BrowserType } from './browserType';\nimport type { CRPage } from './chromium/crPage';\nimport { registryDirectory } from './registry';\n\nexport async function launchApp(browserType: BrowserType, options: {\n  sdkLanguage: string,\n  windowSize: types.Size,\n  windowPosition?: types.Point,\n  persistentContextOptions?: Parameters<BrowserType['launchPersistentContext']>[2];\n}) {\n  const args = [...options.persistentContextOptions?.args ?? []];\n\n  if (browserType.name() === 'chromium') {\n    args.push(\n        '--app=data:text/html,',\n        `--window-size=${options.windowSize.width},${options.windowSize.height}`,\n        ...(options.windowPosition ? [`--window-position=${options.windowPosition.x},${options.windowPosition.y}`] : []),\n        '--test-type=',\n    );\n  }\n\n  const context = await browserType.launchPersistentContext(serverSideCallMetadata(), '', {\n    channel: !options.persistentContextOptions?.executablePath ? findChromiumChannel(options.sdkLanguage) : undefined,\n    noDefaultViewport: true,\n    ignoreDefaultArgs: ['--enable-automation'],\n    colorScheme: 'no-override',\n    acceptDownloads: isUnderTest() ? 'accept' : 'internal-browser-default',\n    ...options?.persistentContextOptions,\n    args,\n  });\n  const [page] = context.pages();\n  // Chromium on macOS opens a new tab when clicking on the dock icon.\n  // See https://github.com/microsoft/playwright/issues/9434\n  if (browserType.name() === 'chromium' && process.platform === 'darwin') {\n    context.on('page', async (newPage: Page) => {\n      if (newPage.mainFrame().url() === 'chrome://new-tab-page/') {\n        await page.bringToFront();\n        await newPage.close(serverSideCallMetadata());\n      }\n    });\n  }\n  if (browserType.name() === 'chromium')\n    await installAppIcon(page);\n  return { context, page };\n}\n\nasync function installAppIcon(page: Page) {\n  const icon = await fs.promises.readFile(require.resolve('./chromium/appIcon.png'));\n  const crPage = page._delegate as CRPage;\n  await crPage._mainFrameSession._client.send('Browser.setDockTile', {\n    image: icon.toString('base64')\n  });\n}\n\nexport async function syncLocalStorageWithSettings(page: Page, appName: string) {\n  if (isUnderTest())\n    return;\n  const settingsFile = path.join(registryDirectory, '.settings', `${appName}.json`);\n  await page.exposeBinding('_saveSerializedSettings', false, (_, settings) => {\n    fs.mkdirSync(path.dirname(settingsFile), { recursive: true });\n    fs.writeFileSync(settingsFile, settings);\n  });\n\n  const settings = await fs.promises.readFile(settingsFile, 'utf-8').catch(() => ('{}'));\n  await page.addInitScript(\n      `(${String((settings: any) => {\n        // iframes w/ snapshots, etc.\n        if (location && location.protocol === 'data:')\n          return;\n        if (window.top !== window)\n          return;\n        Object.entries(settings).map(([k, v]) => localStorage[k] = v);\n        (window as any).saveSettings = () => {\n          (window as any)._saveSerializedSettings(JSON.stringify({ ...localStorage }));\n        };\n      })})(${settings});\n  `);\n}\n"],"mappings":"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"}