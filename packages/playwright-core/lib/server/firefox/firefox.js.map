{"version":3,"file":"firefox.js","names":["os","_interopRequireWildcard","require","_path","_interopRequireDefault","_ffBrowser","_ffConnection","_browserType","_utils","obj","__esModule","default","_getRequireWildcardCache","e","WeakMap","r","t","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","Firefox","BrowserType","constructor","parent","connectToTransport","transport","options","FFBrowser","connect","attribution","playwright","doRewriteStartupLog","error","logs","includes","wrapInASCIIBox","process","env","GITHUB_ACTION","kNoXServerRunningError","amendEnvironment","userDataDir","executable","browserArguments","path","isAbsolute","homedir","Error","platform","SNAP_NAME","undefined","SNAP_INSTANCE_NAME","attemptToGracefullyCloseBrowser","message","method","params","id","kBrowserCloseMessageId","send","defaultArgs","isPersistent","args","headless","userDataDirArg","find","arg","startsWith","_createUserDataDirArgMisuseError","firefoxArguments","push","readyState","JugglerReadyState","exports","_jugglerPromise","ManualPromise","onBrowserOutput","resolve","onBrowserExit","waitUntilReady"],"sources":["../../../src/server/firefox/firefox.ts"],"sourcesContent":["/**\n * Copyright 2017 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as os from 'os';\nimport path from 'path';\nimport { FFBrowser } from './ffBrowser';\nimport { kBrowserCloseMessageId } from './ffConnection';\nimport { BrowserType, kNoXServerRunningError } from '../browserType';\nimport type { BrowserReadyState } from '../browserType';\nimport type { Env } from '../../utils/processLauncher';\nimport type { ConnectionTransport } from '../transport';\nimport type { BrowserOptions } from '../browser';\nimport type * as types from '../types';\nimport { ManualPromise, wrapInASCIIBox } from '../../utils';\nimport type { SdkObject } from '../instrumentation';\nimport type { ProtocolError } from '../protocolError';\n\nexport class Firefox extends BrowserType {\n  constructor(parent: SdkObject) {\n    super(parent, 'firefox');\n  }\n\n  override connectToTransport(transport: ConnectionTransport, options: BrowserOptions): Promise<FFBrowser> {\n    return FFBrowser.connect(this.attribution.playwright, transport, options);\n  }\n\n  override doRewriteStartupLog(error: ProtocolError): ProtocolError {\n    if (!error.logs)\n      return error;\n    // https://github.com/microsoft/playwright/issues/6500\n    if (error.logs.includes(`as root in a regular user's session is not supported.`))\n      error.logs = '\\n' + wrapInASCIIBox(`Firefox is unable to launch if the $HOME folder isn't owned by the current user.\\nWorkaround: Set the HOME=/root environment variable${process.env.GITHUB_ACTION ? ' in your GitHub Actions workflow file' : ''} when running Playwright.`, 1);\n    if (error.logs.includes('no DISPLAY environment variable specified'))\n      error.logs = '\\n' + wrapInASCIIBox(kNoXServerRunningError, 1);\n    return error;\n  }\n\n  override amendEnvironment(env: Env, userDataDir: string, executable: string, browserArguments: string[]): Env {\n    if (!path.isAbsolute(os.homedir()))\n      throw new Error(`Cannot launch Firefox with relative home directory. Did you set ${os.platform() === 'win32' ? 'USERPROFILE' : 'HOME'} to a relative path?`);\n    if (os.platform() === 'linux') {\n      // Always remove SNAP_NAME and SNAP_INSTANCE_NAME env variables since they\n      // confuse Firefox: in our case, builds never come from SNAP.\n      // See https://github.com/microsoft/playwright/issues/20555\n      return { ...env, SNAP_NAME: undefined, SNAP_INSTANCE_NAME: undefined };\n    }\n    return env;\n  }\n\n  override attemptToGracefullyCloseBrowser(transport: ConnectionTransport): void {\n    const message = { method: 'Browser.close', params: {}, id: kBrowserCloseMessageId };\n    transport.send(message);\n  }\n\n  override defaultArgs(options: types.LaunchOptions, isPersistent: boolean, userDataDir: string): string[] {\n    const { args = [], headless } = options;\n    const userDataDirArg = args.find(arg => arg.startsWith('-profile') || arg.startsWith('--profile'));\n    if (userDataDirArg)\n      throw this._createUserDataDirArgMisuseError('--profile');\n    if (args.find(arg => arg.startsWith('-juggler')))\n      throw new Error('Use the port parameter instead of -juggler argument');\n    const firefoxArguments = ['-no-remote'];\n    if (headless) {\n      firefoxArguments.push('-headless');\n    } else {\n      firefoxArguments.push('-wait-for-browser');\n      firefoxArguments.push('-foreground');\n    }\n    firefoxArguments.push(`-profile`, userDataDir);\n    firefoxArguments.push('-juggler-pipe');\n    firefoxArguments.push(...args);\n    if (isPersistent)\n      firefoxArguments.push('about:blank');\n    else\n      firefoxArguments.push('-silent');\n    return firefoxArguments;\n  }\n\n  override readyState(options: types.LaunchOptions): BrowserReadyState | undefined {\n    return new JugglerReadyState();\n  }\n}\n\nclass JugglerReadyState implements BrowserReadyState {\n  private readonly _jugglerPromise = new ManualPromise<void>();\n\n  onBrowserOutput(message: string): void {\n    if (message.includes('Juggler listening to the pipe'))\n      this._jugglerPromise.resolve();\n  }\n  onBrowserExit(): void {\n    // Unblock launch when browser prematurely exits.\n    this._jugglerPromise.resolve();\n  }\n  async waitUntilReady(): Promise<{ wsEndpoint?: string }> {\n    await this._jugglerPromise;\n    return { };\n  }\n}\n\n"],"mappings":";;;;;;AAiBA,IAAAA,EAAA,GAAAC,uBAAA,CAAAC,OAAA;AACA,IAAAC,KAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,UAAA,GAAAH,OAAA;AACA,IAAAI,aAAA,GAAAJ,OAAA;AACA,IAAAK,YAAA,GAAAL,OAAA;AAMA,IAAAM,MAAA,GAAAN,OAAA;AAA4D,SAAAE,uBAAAK,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAAA,SAAAG,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAZ,wBAAAY,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAH,UAAA,SAAAG,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAF,OAAA,EAAAE,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAC,GAAA,CAAAJ,CAAA,UAAAG,CAAA,CAAAE,GAAA,CAAAL,CAAA,OAAAM,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAZ,CAAA,oBAAAY,CAAA,IAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAf,CAAA,EAAAY,CAAA,SAAAI,CAAA,GAAAR,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAX,CAAA,EAAAY,CAAA,UAAAI,CAAA,KAAAA,CAAA,CAAAX,GAAA,IAAAW,CAAA,CAAAC,GAAA,IAAAR,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAI,CAAA,IAAAV,CAAA,CAAAM,CAAA,IAAAZ,CAAA,CAAAY,CAAA,YAAAN,CAAA,CAAAR,OAAA,GAAAE,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAc,GAAA,CAAAjB,CAAA,EAAAM,CAAA,GAAAA,CAAA;AA3B5D;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAgBO,MAAMY,OAAO,SAASC,wBAAW,CAAC;EACvCC,WAAWA,CAACC,MAAiB,EAAE;IAC7B,KAAK,CAACA,MAAM,EAAE,SAAS,CAAC;EAC1B;EAESC,kBAAkBA,CAACC,SAA8B,EAAEC,OAAuB,EAAsB;IACvG,OAAOC,oBAAS,CAACC,OAAO,CAAC,IAAI,CAACC,WAAW,CAACC,UAAU,EAAEL,SAAS,EAAEC,OAAO,CAAC;EAC3E;EAESK,mBAAmBA,CAACC,KAAoB,EAAiB;IAChE,IAAI,CAACA,KAAK,CAACC,IAAI,EACb,OAAOD,KAAK;IACd;IACA,IAAIA,KAAK,CAACC,IAAI,CAACC,QAAQ,CAAE,uDAAsD,CAAC,EAC9EF,KAAK,CAACC,IAAI,GAAG,IAAI,GAAG,IAAAE,qBAAc,EAAE,wIAAuIC,OAAO,CAACC,GAAG,CAACC,aAAa,GAAG,uCAAuC,GAAG,EAAG,2BAA0B,EAAE,CAAC,CAAC;IACpR,IAAIN,KAAK,CAACC,IAAI,CAACC,QAAQ,CAAC,2CAA2C,CAAC,EAClEF,KAAK,CAACC,IAAI,GAAG,IAAI,GAAG,IAAAE,qBAAc,EAACI,mCAAsB,EAAE,CAAC,CAAC;IAC/D,OAAOP,KAAK;EACd;EAESQ,gBAAgBA,CAACH,GAAQ,EAAEI,WAAmB,EAAEC,UAAkB,EAAEC,gBAA0B,EAAO;IAC5G,IAAI,CAACC,aAAI,CAACC,UAAU,CAACxD,EAAE,CAACyD,OAAO,CAAC,CAAC,CAAC,EAChC,MAAM,IAAIC,KAAK,CAAE,mEAAkE1D,EAAE,CAAC2D,QAAQ,CAAC,CAAC,KAAK,OAAO,GAAG,aAAa,GAAG,MAAO,sBAAqB,CAAC;IAC9J,IAAI3D,EAAE,CAAC2D,QAAQ,CAAC,CAAC,KAAK,OAAO,EAAE;MAC7B;MACA;MACA;MACA,OAAO;QAAE,GAAGX,GAAG;QAAEY,SAAS,EAAEC,SAAS;QAAEC,kBAAkB,EAAED;MAAU,CAAC;IACxE;IACA,OAAOb,GAAG;EACZ;EAESe,+BAA+BA,CAAC3B,SAA8B,EAAQ;IAC7E,MAAM4B,OAAO,GAAG;MAAEC,MAAM,EAAE,eAAe;MAAEC,MAAM,EAAE,CAAC,CAAC;MAAEC,EAAE,EAAEC;IAAuB,CAAC;IACnFhC,SAAS,CAACiC,IAAI,CAACL,OAAO,CAAC;EACzB;EAESM,WAAWA,CAACjC,OAA4B,EAAEkC,YAAqB,EAAEnB,WAAmB,EAAY;IACvG,MAAM;MAAEoB,IAAI,GAAG,EAAE;MAAEC;IAAS,CAAC,GAAGpC,OAAO;IACvC,MAAMqC,cAAc,GAAGF,IAAI,CAACG,IAAI,CAACC,GAAG,IAAIA,GAAG,CAACC,UAAU,CAAC,UAAU,CAAC,IAAID,GAAG,CAACC,UAAU,CAAC,WAAW,CAAC,CAAC;IAClG,IAAIH,cAAc,EAChB,MAAM,IAAI,CAACI,gCAAgC,CAAC,WAAW,CAAC;IAC1D,IAAIN,IAAI,CAACG,IAAI,CAACC,GAAG,IAAIA,GAAG,CAACC,UAAU,CAAC,UAAU,CAAC,CAAC,EAC9C,MAAM,IAAInB,KAAK,CAAC,qDAAqD,CAAC;IACxE,MAAMqB,gBAAgB,GAAG,CAAC,YAAY,CAAC;IACvC,IAAIN,QAAQ,EAAE;MACZM,gBAAgB,CAACC,IAAI,CAAC,WAAW,CAAC;IACpC,CAAC,MAAM;MACLD,gBAAgB,CAACC,IAAI,CAAC,mBAAmB,CAAC;MAC1CD,gBAAgB,CAACC,IAAI,CAAC,aAAa,CAAC;IACtC;IACAD,gBAAgB,CAACC,IAAI,CAAE,UAAS,EAAE5B,WAAW,CAAC;IAC9C2B,gBAAgB,CAACC,IAAI,CAAC,eAAe,CAAC;IACtCD,gBAAgB,CAACC,IAAI,CAAC,GAAGR,IAAI,CAAC;IAC9B,IAAID,YAAY,EACdQ,gBAAgB,CAACC,IAAI,CAAC,aAAa,CAAC,CAAC,KAErCD,gBAAgB,CAACC,IAAI,CAAC,SAAS,CAAC;IAClC,OAAOD,gBAAgB;EACzB;EAESE,UAAUA,CAAC5C,OAA4B,EAAiC;IAC/E,OAAO,IAAI6C,iBAAiB,CAAC,CAAC;EAChC;AACF;AAACC,OAAA,CAAApD,OAAA,GAAAA,OAAA;AAED,MAAMmD,iBAAiB,CAA8B;EAAAjD,YAAA;IAAA,KAClCmD,eAAe,GAAG,IAAIC,oBAAa,CAAO,CAAC;EAAA;EAE5DC,eAAeA,CAACtB,OAAe,EAAQ;IACrC,IAAIA,OAAO,CAACnB,QAAQ,CAAC,+BAA+B,CAAC,EACnD,IAAI,CAACuC,eAAe,CAACG,OAAO,CAAC,CAAC;EAClC;EACAC,aAAaA,CAAA,EAAS;IACpB;IACA,IAAI,CAACJ,eAAe,CAACG,OAAO,CAAC,CAAC;EAChC;EACA,MAAME,cAAcA,CAAA,EAAqC;IACvD,MAAM,IAAI,CAACL,eAAe;IAC1B,OAAO,CAAE,CAAC;EACZ;AACF"}