{"version":3,"file":"ffAccessibility.js","names":["getAccessibilityTree","session","needle","objectId","_objectId","undefined","tree","send","axNode","FFAXNode","_findNeedle","FFRoleToARIARole","Map","Object","entries","constructor","payload","_children","_payload","_editable","_richlyEditable","_focusable","_expanded","_name","_role","_cachedHasFocusableChild","children","map","x","editable","tag","focusable","expanded","name","role","_isPlainTextField","_isTextOnlyObject","_hasFocusableChild","child","foundObject","found","isLeafNode","length","isControl","isInteresting","insideControl","trim","serialize","node","get","userStringProperties","userStringProperty","booleanProperties","booleanProperty","value","numericalProperties","numericalProperty","tokenProperties","tokenProperty","valueString","checked","pressed","invalid"],"sources":["../../../src/server/firefox/ffAccessibility.ts"],"sourcesContent":["/**\n * Copyright 2018 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License');\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an 'AS IS' BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type * as accessibility from '../accessibility';\nimport type { FFSession } from './ffConnection';\nimport type { Protocol } from './protocol';\nimport type * as dom from '../dom';\nimport type * as channels from '@protocol/channels';\n\nexport async function getAccessibilityTree(session: FFSession, needle?: dom.ElementHandle): Promise<{tree: accessibility.AXNode, needle: accessibility.AXNode | null}> {\n  const objectId = needle ? needle._objectId : undefined;\n  const { tree } = await session.send('Accessibility.getFullAXTree', { objectId });\n  const axNode = new FFAXNode(tree);\n  return {\n    tree: axNode,\n    needle: needle ? axNode._findNeedle() : null\n  };\n}\n\nconst FFRoleToARIARole = new Map(Object.entries({\n  'pushbutton': 'button',\n  'checkbutton': 'checkbox',\n  'editcombobox': 'combobox',\n  'content deletion': 'deletion',\n  'footnote': 'doc-footnote',\n  'non-native document': 'document',\n  'grouping': 'group',\n  'graphic': 'img',\n  'content insertion': 'insertion',\n  'animation': 'marquee',\n  'flat equation': 'math',\n  'menupopup': 'menu',\n  'check menu item': 'menuitemcheckbox',\n  'radio menu item': 'menuitemradio',\n  'listbox option': 'option',\n  'radiobutton': 'radio',\n  'statusbar': 'status',\n  'pagetab': 'tab',\n  'pagetablist': 'tablist',\n  'propertypage': 'tabpanel',\n  'entry': 'textbox',\n  'outline': 'tree',\n  'tree table': 'treegrid',\n  'outlineitem': 'treeitem',\n}));\n\nclass FFAXNode implements accessibility.AXNode {\n  _children: FFAXNode[];\n  private _payload: Protocol.Accessibility.AXTree;\n  private _editable: boolean;\n  private _richlyEditable: boolean;\n  private _focusable: boolean;\n  private _expanded: boolean;\n  private _name: string;\n  private _role: string;\n  private _cachedHasFocusableChild: boolean|undefined;\n\n  constructor(payload: Protocol.Accessibility.AXTree) {\n    this._payload = payload;\n    this._children = (payload.children || []).map(x => new FFAXNode(x));\n    this._editable = !!payload.editable;\n    this._richlyEditable = this._editable && (payload.tag !== 'textarea' && payload.tag !== 'input');\n    this._focusable = !!payload.focusable;\n    this._expanded = !!payload.expanded;\n    this._name = this._payload.name;\n    this._role = this._payload.role;\n  }\n\n  _isPlainTextField(): boolean {\n    if (this._richlyEditable)\n      return false;\n    if (this._editable)\n      return true;\n    return this._role === 'entry';\n  }\n\n  _isTextOnlyObject(): boolean {\n    const role = this._role;\n    return (role === 'text leaf' || role === 'text' || role === 'statictext');\n  }\n\n  _hasFocusableChild(): boolean {\n    if (this._cachedHasFocusableChild === undefined) {\n      this._cachedHasFocusableChild = false;\n      for (const child of this._children) {\n        if (child._focusable || child._hasFocusableChild()) {\n          this._cachedHasFocusableChild = true;\n          break;\n        }\n      }\n    }\n    return this._cachedHasFocusableChild;\n  }\n\n  children() {\n    return this._children;\n  }\n\n  _findNeedle(): FFAXNode | null {\n    if (this._payload.foundObject)\n      return this;\n    for (const child of this._children) {\n      const found = child._findNeedle();\n      if (found)\n        return found;\n    }\n    return null;\n  }\n\n  isLeafNode(): boolean {\n    if (!this._children.length)\n      return true;\n      // These types of objects may have children that we use as internal\n      // implementation details, but we want to expose them as leaves to platform\n      // accessibility APIs because screen readers might be confused if they find\n      // any children.\n    if (this._isPlainTextField() || this._isTextOnlyObject())\n      return true;\n      // Roles whose children are only presentational according to the ARIA and\n      // HTML5 Specs should be hidden from screen readers.\n      // (Note that whilst ARIA buttons can have only presentational children, HTML5\n      // buttons are allowed to have content.)\n    switch (this._role) {\n      case 'graphic':\n      case 'scrollbar':\n      case 'slider':\n      case 'separator':\n      case 'progressbar':\n        return true;\n      default:\n        break;\n    }\n    // Here and below: Android heuristics\n    if (this._hasFocusableChild())\n      return false;\n    if (this._focusable && this._role !== 'document' && this._name)\n      return true;\n    if (this._role === 'heading' && this._name)\n      return true;\n    return false;\n  }\n\n  isControl(): boolean {\n    switch (this._role) {\n      case 'checkbutton':\n      case 'check menu item':\n      case 'check rich option':\n      case 'combobox':\n      case 'combobox option':\n      case 'color chooser':\n      case 'listbox':\n      case 'listbox option':\n      case 'listbox rich option':\n      case 'popup menu':\n      case 'menupopup':\n      case 'menuitem':\n      case 'menubar':\n      case 'button':\n      case 'pushbutton':\n      case 'radiobutton':\n      case 'radio menuitem':\n      case 'scrollbar':\n      case 'slider':\n      case 'spinbutton':\n      case 'switch':\n      case 'pagetab':\n      case 'entry':\n      case 'tree table':\n        return true;\n      default:\n        return false;\n    }\n  }\n\n  isInteresting(insideControl: boolean): boolean {\n    if (this._focusable || this._richlyEditable)\n      return true;\n      // If it's not focusable but has a control role, then it's interesting.\n    if (this.isControl())\n      return true;\n      // A non focusable child of a control is not interesting\n    if (insideControl)\n      return false;\n    return this.isLeafNode() && !!this._name.trim();\n  }\n\n  serialize(): channels.AXNode {\n    const node: {[x in keyof channels.AXNode]: any} = {\n      role: FFRoleToARIARole.get(this._role) || this._role,\n      name: this._name || '',\n    };\n    const userStringProperties: Array<keyof channels.AXNode & keyof Protocol.Accessibility.AXTree> = [\n      'name',\n      'description',\n      'roledescription',\n      'valuetext',\n      'keyshortcuts',\n    ];\n    for (const userStringProperty of userStringProperties) {\n      if (!(userStringProperty in this._payload))\n        continue;\n      node[userStringProperty] = this._payload[userStringProperty];\n    }\n    const booleanProperties: Array<keyof channels.AXNode & keyof Protocol.Accessibility.AXTree> = [\n      'disabled',\n      'expanded',\n      'focused',\n      'modal',\n      'multiline',\n      'multiselectable',\n      'readonly',\n      'required',\n      'selected',\n    ];\n    for (const booleanProperty of booleanProperties) {\n      if (this._role === 'document' && booleanProperty === 'focused')\n        continue; // document focusing is strange\n      const value = this._payload[booleanProperty];\n      if (!value)\n        continue;\n      node[booleanProperty] = value;\n    }\n    const numericalProperties: Array<keyof channels.AXNode & keyof Protocol.Accessibility.AXTree> = [\n      'level'\n    ];\n    for (const numericalProperty of numericalProperties) {\n      if (!(numericalProperty in this._payload))\n        continue;\n      node[numericalProperty] = this._payload[numericalProperty];\n    }\n    const tokenProperties: Array<keyof channels.AXNode & keyof Protocol.Accessibility.AXTree> = [\n      'autocomplete',\n      'haspopup',\n      'orientation',\n    ];\n    for (const tokenProperty of tokenProperties) {\n      const value = this._payload[tokenProperty];\n      if (!value || value === 'false')\n        continue;\n      node[tokenProperty] = value;\n    }\n\n    const axNode = node as channels.AXNode;\n    axNode.valueString = this._payload.value;\n    if ('checked' in this._payload)\n      axNode.checked = this._payload.checked === true ? 'checked' : this._payload.checked === 'mixed' ? 'mixed' : 'unchecked';\n    if ('pressed' in this._payload)\n      axNode.pressed = this._payload.pressed === true ? 'pressed' : 'released';\n    if ('invalid' in this._payload)\n      axNode.invalid = this._payload.invalid === true ? 'true' : 'false';\n    return axNode;\n  }\n}\n"],"mappings":"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"}