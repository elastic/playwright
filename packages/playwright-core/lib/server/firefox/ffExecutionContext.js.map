{"version":3,"file":"ffExecutionContext.js","names":["js","_interopRequireWildcard","require","_stackTrace","_utilityScriptSerializers","_protocolError","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","FFExecutionContext","constructor","session","executionContextId","_session","_executionContextId","rawEvaluateJSON","expression","payload","send","returnByValue","catch","rewriteError","checkException","exceptionDetails","result","value","rawEvaluateHandle","objectId","rawCallFunctionNoReply","func","args","functionDeclaration","toString","map","JSHandle","_objectId","evaluateWithArguments","utilityScript","values","objectIds","undefined","parseEvaluationResultValue","_context","createHandle","getProperties","context","response","Map","property","properties","name","remoteObject","subtype","type","renderPreview","potentiallyUnserializableValue","releaseHandle","objectCount","Error","exports","JavaScriptErrorInEvaluate","JSON","stringify","text","stack","error","message","includes","TypeError","startsWith","rewriteErrorMessage","isJavaScriptErrorInEvaluate","isSessionClosedError","unserializableValue","parseUnserializableValue","object","String","toUpperCase","slice"],"sources":["../../../src/server/firefox/ffExecutionContext.ts"],"sourcesContent":["/**\n * Copyright 2019 Google Inc. All rights reserved.\n * Modifications copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport * as js from '../javascript';\nimport type { FFSession } from './ffConnection';\nimport type { Protocol } from './protocol';\nimport { rewriteErrorMessage } from '../../utils/stackTrace';\nimport { parseEvaluationResultValue } from '../isomorphic/utilityScriptSerializers';\nimport { isSessionClosedError } from '../protocolError';\n\nexport class FFExecutionContext implements js.ExecutionContextDelegate {\n  _session: FFSession;\n  _executionContextId: string;\n\n  constructor(session: FFSession, executionContextId: string) {\n    this._session = session;\n    this._executionContextId = executionContextId;\n  }\n\n  async rawEvaluateJSON(expression: string): Promise<any> {\n    const payload = await this._session.send('Runtime.evaluate', {\n      expression,\n      returnByValue: true,\n      executionContextId: this._executionContextId,\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    return payload.result!.value;\n  }\n\n  async rawEvaluateHandle(expression: string): Promise<js.ObjectId> {\n    const payload = await this._session.send('Runtime.evaluate', {\n      expression,\n      returnByValue: false,\n      executionContextId: this._executionContextId,\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    return payload.result!.objectId!;\n  }\n\n  rawCallFunctionNoReply(func: Function, ...args: any[]) {\n    this._session.send('Runtime.callFunction', {\n      functionDeclaration: func.toString(),\n      args: args.map(a => a instanceof js.JSHandle ? { objectId: a._objectId } : { value: a }) as any,\n      returnByValue: true,\n      executionContextId: this._executionContextId\n    }).catch(() => {});\n  }\n\n  async evaluateWithArguments(expression: string, returnByValue: boolean, utilityScript: js.JSHandle<any>, values: any[], objectIds: string[]): Promise<any> {\n    const payload = await this._session.send('Runtime.callFunction', {\n      functionDeclaration: expression,\n      args: [\n        { objectId: utilityScript._objectId, value: undefined },\n        ...values.map(value => ({ value })),\n        ...objectIds.map(objectId => ({ objectId, value: undefined })),\n      ],\n      returnByValue,\n      executionContextId: this._executionContextId\n    }).catch(rewriteError);\n    checkException(payload.exceptionDetails);\n    if (returnByValue)\n      return parseEvaluationResultValue(payload.result!.value);\n    return utilityScript._context.createHandle(payload.result!);\n  }\n\n  async getProperties(context: js.ExecutionContext, objectId: js.ObjectId): Promise<Map<string, js.JSHandle>> {\n    const response = await this._session.send('Runtime.getObjectProperties', {\n      executionContextId: this._executionContextId,\n      objectId,\n    });\n    const result = new Map();\n    for (const property of response.properties)\n      result.set(property.name, context.createHandle(property.value));\n    return result;\n  }\n\n  createHandle(context: js.ExecutionContext, remoteObject: Protocol.Runtime.RemoteObject): js.JSHandle {\n    return new js.JSHandle(context, remoteObject.subtype || remoteObject.type || '', renderPreview(remoteObject), remoteObject.objectId, potentiallyUnserializableValue(remoteObject));\n  }\n\n  async releaseHandle(objectId: js.ObjectId): Promise<void> {\n    await this._session.send('Runtime.disposeObject', {\n      executionContextId: this._executionContextId,\n      objectId\n    });\n  }\n\n  objectCount(objectId: js.ObjectId): Promise<number> {\n    throw new Error('Method not implemented in Firefox.');\n  }\n}\n\nfunction checkException(exceptionDetails?: Protocol.Runtime.ExceptionDetails) {\n  if (!exceptionDetails)\n    return;\n  if (exceptionDetails.value)\n    throw new js.JavaScriptErrorInEvaluate(JSON.stringify(exceptionDetails.value));\n  else\n    throw new js.JavaScriptErrorInEvaluate(exceptionDetails.text + (exceptionDetails.stack ? '\\n' + exceptionDetails.stack : ''));\n}\n\nfunction rewriteError(error: Error): (Protocol.Runtime.evaluateReturnValue | Protocol.Runtime.callFunctionReturnValue) {\n  if (error.message.includes('cyclic object value') || error.message.includes('Object is not serializable'))\n    return { result: { type: 'undefined', value: undefined } };\n  if (error instanceof TypeError && error.message.startsWith('Converting circular structure to JSON'))\n    rewriteErrorMessage(error, error.message + ' Are you passing a nested JSHandle?');\n  if (!js.isJavaScriptErrorInEvaluate(error) && !isSessionClosedError(error))\n    throw new Error('Execution context was destroyed, most likely because of a navigation.');\n  throw error;\n}\n\nfunction potentiallyUnserializableValue(remoteObject: Protocol.Runtime.RemoteObject): any {\n  const value = remoteObject.value;\n  const unserializableValue = remoteObject.unserializableValue;\n  return unserializableValue ? js.parseUnserializableValue(unserializableValue) : value;\n}\n\nfunction renderPreview(object: Protocol.Runtime.RemoteObject): string | undefined {\n  if (object.type === 'undefined')\n    return 'undefined';\n  if (object.unserializableValue)\n    return String(object.unserializableValue);\n  if (object.type === 'symbol')\n    return 'Symbol()';\n  if (object.subtype === 'regexp')\n    return 'RegExp';\n  if (object.subtype === 'weakmap')\n    return 'WeakMap';\n  if (object.subtype === 'weakset')\n    return 'WeakSet';\n  if (object.subtype)\n    return object.subtype[0].toUpperCase() + object.subtype.slice(1);\n  if ('value' in object)\n    return String(object.value);\n}\n"],"mappings":";;;;;;AAiBA,IAAAA,EAAA,GAAAC,uBAAA,CAAAC,OAAA;AAGA,IAAAC,WAAA,GAAAD,OAAA;AACA,IAAAE,yBAAA,GAAAF,OAAA;AACA,IAAAG,cAAA,GAAAH,OAAA;AAAwD,SAAAI,yBAAAC,CAAA,6BAAAC,OAAA,mBAAAC,CAAA,OAAAD,OAAA,IAAAE,CAAA,OAAAF,OAAA,YAAAF,wBAAA,YAAAA,CAAAC,CAAA,WAAAA,CAAA,GAAAG,CAAA,GAAAD,CAAA,KAAAF,CAAA;AAAA,SAAAN,wBAAAM,CAAA,EAAAE,CAAA,SAAAA,CAAA,IAAAF,CAAA,IAAAA,CAAA,CAAAI,UAAA,SAAAJ,CAAA,eAAAA,CAAA,uBAAAA,CAAA,yBAAAA,CAAA,WAAAK,OAAA,EAAAL,CAAA,QAAAG,CAAA,GAAAJ,wBAAA,CAAAG,CAAA,OAAAC,CAAA,IAAAA,CAAA,CAAAG,GAAA,CAAAN,CAAA,UAAAG,CAAA,CAAAI,GAAA,CAAAP,CAAA,OAAAQ,CAAA,KAAAC,SAAA,UAAAC,CAAA,GAAAC,MAAA,CAAAC,cAAA,IAAAD,MAAA,CAAAE,wBAAA,WAAAC,CAAA,IAAAd,CAAA,oBAAAc,CAAA,IAAAH,MAAA,CAAAI,SAAA,CAAAC,cAAA,CAAAC,IAAA,CAAAjB,CAAA,EAAAc,CAAA,SAAAI,CAAA,GAAAR,CAAA,GAAAC,MAAA,CAAAE,wBAAA,CAAAb,CAAA,EAAAc,CAAA,UAAAI,CAAA,KAAAA,CAAA,CAAAX,GAAA,IAAAW,CAAA,CAAAC,GAAA,IAAAR,MAAA,CAAAC,cAAA,CAAAJ,CAAA,EAAAM,CAAA,EAAAI,CAAA,IAAAV,CAAA,CAAAM,CAAA,IAAAd,CAAA,CAAAc,CAAA,YAAAN,CAAA,CAAAH,OAAA,GAAAL,CAAA,EAAAG,CAAA,IAAAA,CAAA,CAAAgB,GAAA,CAAAnB,CAAA,EAAAQ,CAAA,GAAAA,CAAA;AAtBxD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AASO,MAAMY,kBAAkB,CAAwC;EAIrEC,WAAWA,CAACC,OAAkB,EAAEC,kBAA0B,EAAE;IAAA,KAH5DC,QAAQ;IAAA,KACRC,mBAAmB;IAGjB,IAAI,CAACD,QAAQ,GAAGF,OAAO;IACvB,IAAI,CAACG,mBAAmB,GAAGF,kBAAkB;EAC/C;EAEA,MAAMG,eAAeA,CAACC,UAAkB,EAAgB;IACtD,MAAMC,OAAO,GAAG,MAAM,IAAI,CAACJ,QAAQ,CAACK,IAAI,CAAC,kBAAkB,EAAE;MAC3DF,UAAU;MACVG,aAAa,EAAE,IAAI;MACnBP,kBAAkB,EAAE,IAAI,CAACE;IAC3B,CAAC,CAAC,CAACM,KAAK,CAACC,YAAY,CAAC;IACtBC,cAAc,CAACL,OAAO,CAACM,gBAAgB,CAAC;IACxC,OAAON,OAAO,CAACO,MAAM,CAAEC,KAAK;EAC9B;EAEA,MAAMC,iBAAiBA,CAACV,UAAkB,EAAwB;IAChE,MAAMC,OAAO,GAAG,MAAM,IAAI,CAACJ,QAAQ,CAACK,IAAI,CAAC,kBAAkB,EAAE;MAC3DF,UAAU;MACVG,aAAa,EAAE,KAAK;MACpBP,kBAAkB,EAAE,IAAI,CAACE;IAC3B,CAAC,CAAC,CAACM,KAAK,CAACC,YAAY,CAAC;IACtBC,cAAc,CAACL,OAAO,CAACM,gBAAgB,CAAC;IACxC,OAAON,OAAO,CAACO,MAAM,CAAEG,QAAQ;EACjC;EAEAC,sBAAsBA,CAACC,IAAc,EAAE,GAAGC,IAAW,EAAE;IACrD,IAAI,CAACjB,QAAQ,CAACK,IAAI,CAAC,sBAAsB,EAAE;MACzCa,mBAAmB,EAAEF,IAAI,CAACG,QAAQ,CAAC,CAAC;MACpCF,IAAI,EAAEA,IAAI,CAACG,GAAG,CAAClC,CAAC,IAAIA,CAAC,YAAYjB,EAAE,CAACoD,QAAQ,GAAG;QAAEP,QAAQ,EAAE5B,CAAC,CAACoC;MAAU,CAAC,GAAG;QAAEV,KAAK,EAAE1B;MAAE,CAAC,CAAQ;MAC/FoB,aAAa,EAAE,IAAI;MACnBP,kBAAkB,EAAE,IAAI,CAACE;IAC3B,CAAC,CAAC,CAACM,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;EACpB;EAEA,MAAMgB,qBAAqBA,CAACpB,UAAkB,EAAEG,aAAsB,EAAEkB,aAA+B,EAAEC,MAAa,EAAEC,SAAmB,EAAgB;IACzJ,MAAMtB,OAAO,GAAG,MAAM,IAAI,CAACJ,QAAQ,CAACK,IAAI,CAAC,sBAAsB,EAAE;MAC/Da,mBAAmB,EAAEf,UAAU;MAC/Bc,IAAI,EAAE,CACJ;QAAEH,QAAQ,EAAEU,aAAa,CAACF,SAAS;QAAEV,KAAK,EAAEe;MAAU,CAAC,EACvD,GAAGF,MAAM,CAACL,GAAG,CAACR,KAAK,KAAK;QAAEA;MAAM,CAAC,CAAC,CAAC,EACnC,GAAGc,SAAS,CAACN,GAAG,CAACN,QAAQ,KAAK;QAAEA,QAAQ;QAAEF,KAAK,EAAEe;MAAU,CAAC,CAAC,CAAC,CAC/D;MACDrB,aAAa;MACbP,kBAAkB,EAAE,IAAI,CAACE;IAC3B,CAAC,CAAC,CAACM,KAAK,CAACC,YAAY,CAAC;IACtBC,cAAc,CAACL,OAAO,CAACM,gBAAgB,CAAC;IACxC,IAAIJ,aAAa,EACf,OAAO,IAAAsB,oDAA0B,EAACxB,OAAO,CAACO,MAAM,CAAEC,KAAK,CAAC;IAC1D,OAAOY,aAAa,CAACK,QAAQ,CAACC,YAAY,CAAC1B,OAAO,CAACO,MAAO,CAAC;EAC7D;EAEA,MAAMoB,aAAaA,CAACC,OAA4B,EAAElB,QAAqB,EAAqC;IAC1G,MAAMmB,QAAQ,GAAG,MAAM,IAAI,CAACjC,QAAQ,CAACK,IAAI,CAAC,6BAA6B,EAAE;MACvEN,kBAAkB,EAAE,IAAI,CAACE,mBAAmB;MAC5Ca;IACF,CAAC,CAAC;IACF,MAAMH,MAAM,GAAG,IAAIuB,GAAG,CAAC,CAAC;IACxB,KAAK,MAAMC,QAAQ,IAAIF,QAAQ,CAACG,UAAU,EACxCzB,MAAM,CAAChB,GAAG,CAACwC,QAAQ,CAACE,IAAI,EAAEL,OAAO,CAACF,YAAY,CAACK,QAAQ,CAACvB,KAAK,CAAC,CAAC;IACjE,OAAOD,MAAM;EACf;EAEAmB,YAAYA,CAACE,OAA4B,EAAEM,YAA2C,EAAe;IACnG,OAAO,IAAIrE,EAAE,CAACoD,QAAQ,CAACW,OAAO,EAAEM,YAAY,CAACC,OAAO,IAAID,YAAY,CAACE,IAAI,IAAI,EAAE,EAAEC,aAAa,CAACH,YAAY,CAAC,EAAEA,YAAY,CAACxB,QAAQ,EAAE4B,8BAA8B,CAACJ,YAAY,CAAC,CAAC;EACpL;EAEA,MAAMK,aAAaA,CAAC7B,QAAqB,EAAiB;IACxD,MAAM,IAAI,CAACd,QAAQ,CAACK,IAAI,CAAC,uBAAuB,EAAE;MAChDN,kBAAkB,EAAE,IAAI,CAACE,mBAAmB;MAC5Ca;IACF,CAAC,CAAC;EACJ;EAEA8B,WAAWA,CAAC9B,QAAqB,EAAmB;IAClD,MAAM,IAAI+B,KAAK,CAAC,oCAAoC,CAAC;EACvD;AACF;AAACC,OAAA,CAAAlD,kBAAA,GAAAA,kBAAA;AAED,SAASa,cAAcA,CAACC,gBAAoD,EAAE;EAC5E,IAAI,CAACA,gBAAgB,EACnB;EACF,IAAIA,gBAAgB,CAACE,KAAK,EACxB,MAAM,IAAI3C,EAAE,CAAC8E,yBAAyB,CAACC,IAAI,CAACC,SAAS,CAACvC,gBAAgB,CAACE,KAAK,CAAC,CAAC,CAAC,KAE/E,MAAM,IAAI3C,EAAE,CAAC8E,yBAAyB,CAACrC,gBAAgB,CAACwC,IAAI,IAAIxC,gBAAgB,CAACyC,KAAK,GAAG,IAAI,GAAGzC,gBAAgB,CAACyC,KAAK,GAAG,EAAE,CAAC,CAAC;AACjI;AAEA,SAAS3C,YAAYA,CAAC4C,KAAY,EAAqF;EACrH,IAAIA,KAAK,CAACC,OAAO,CAACC,QAAQ,CAAC,qBAAqB,CAAC,IAAIF,KAAK,CAACC,OAAO,CAACC,QAAQ,CAAC,4BAA4B,CAAC,EACvG,OAAO;IAAE3C,MAAM,EAAE;MAAE6B,IAAI,EAAE,WAAW;MAAE5B,KAAK,EAAEe;IAAU;EAAE,CAAC;EAC5D,IAAIyB,KAAK,YAAYG,SAAS,IAAIH,KAAK,CAACC,OAAO,CAACG,UAAU,CAAC,uCAAuC,CAAC,EACjG,IAAAC,+BAAmB,EAACL,KAAK,EAAEA,KAAK,CAACC,OAAO,GAAG,qCAAqC,CAAC;EACnF,IAAI,CAACpF,EAAE,CAACyF,2BAA2B,CAACN,KAAK,CAAC,IAAI,CAAC,IAAAO,mCAAoB,EAACP,KAAK,CAAC,EACxE,MAAM,IAAIP,KAAK,CAAC,uEAAuE,CAAC;EAC1F,MAAMO,KAAK;AACb;AAEA,SAASV,8BAA8BA,CAACJ,YAA2C,EAAO;EACxF,MAAM1B,KAAK,GAAG0B,YAAY,CAAC1B,KAAK;EAChC,MAAMgD,mBAAmB,GAAGtB,YAAY,CAACsB,mBAAmB;EAC5D,OAAOA,mBAAmB,GAAG3F,EAAE,CAAC4F,wBAAwB,CAACD,mBAAmB,CAAC,GAAGhD,KAAK;AACvF;AAEA,SAAS6B,aAAaA,CAACqB,MAAqC,EAAsB;EAChF,IAAIA,MAAM,CAACtB,IAAI,KAAK,WAAW,EAC7B,OAAO,WAAW;EACpB,IAAIsB,MAAM,CAACF,mBAAmB,EAC5B,OAAOG,MAAM,CAACD,MAAM,CAACF,mBAAmB,CAAC;EAC3C,IAAIE,MAAM,CAACtB,IAAI,KAAK,QAAQ,EAC1B,OAAO,UAAU;EACnB,IAAIsB,MAAM,CAACvB,OAAO,KAAK,QAAQ,EAC7B,OAAO,QAAQ;EACjB,IAAIuB,MAAM,CAACvB,OAAO,KAAK,SAAS,EAC9B,OAAO,SAAS;EAClB,IAAIuB,MAAM,CAACvB,OAAO,KAAK,SAAS,EAC9B,OAAO,SAAS;EAClB,IAAIuB,MAAM,CAACvB,OAAO,EAChB,OAAOuB,MAAM,CAACvB,OAAO,CAAC,CAAC,CAAC,CAACyB,WAAW,CAAC,CAAC,GAAGF,MAAM,CAACvB,OAAO,CAAC0B,KAAK,CAAC,CAAC,CAAC;EAClE,IAAI,OAAO,IAAIH,MAAM,EACnB,OAAOC,MAAM,CAACD,MAAM,CAAClD,KAAK,CAAC;AAC/B"}