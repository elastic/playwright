{"version":3,"file":"oopDownloadBrowserMain.js","names":["_fs","_interopRequireDefault","require","_path","_network","_manualPromise","_zipBundle","obj","__esModule","default","log","message","_process$send","_process","process","send","call","method","params","progress","done","total","_process$send2","_process2","browserDirectoryToMarkerFilePath","browserDirectory","path","join","downloadFile","options","downloadedBytes","totalBytes","promise","ManualPromise","httpRequest","url","headers","userAgent","timeout","connectionTimeout","response","statusCode","content","handleError","error","Error","resume","reject","on","chunk","parseInt","file","fs","createWriteStream","zipPath","resolve","pipe","onData","close","code","_error$message","length","main","title","extract","dir","executablePath","promises","chmod","writeFile","exit","e","console"],"sources":["../../../src/server/registry/oopDownloadBrowserMain.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport path from 'path';\nimport { httpRequest } from '../../utils/network';\nimport { ManualPromise } from '../../utils/manualPromise';\nimport { extract } from '../../zipBundle';\n\nexport type DownloadParams = {\n  title: string;\n  browserDirectory: string;\n  url: string;\n  zipPath: string;\n  executablePath: string | undefined;\n  connectionTimeout: number;\n  userAgent: string;\n};\n\nfunction log(message: string) {\n  process.send?.({ method: 'log', params: { message } });\n}\n\nfunction progress(done: number, total: number) {\n  process.send?.({ method: 'progress', params: { done, total } });\n}\n\nfunction browserDirectoryToMarkerFilePath(browserDirectory: string): string {\n  return path.join(browserDirectory, 'INSTALLATION_COMPLETE');\n}\n\nfunction downloadFile(options: DownloadParams): Promise<void> {\n  let downloadedBytes = 0;\n  let totalBytes = 0;\n\n  const promise = new ManualPromise<void>();\n\n  httpRequest({\n    url: options.url,\n    headers: {\n      'User-Agent': options.userAgent,\n    },\n    timeout: options.connectionTimeout,\n  }, response => {\n    log(`-- response status code: ${response.statusCode}`);\n    if (response.statusCode !== 200) {\n      let content = '';\n      const handleError = () => {\n        const error = new Error(`Download failed: server returned code ${response.statusCode} body '${content}'. URL: ${options.url}`);\n        // consume response data to free up memory\n        response.resume();\n        promise.reject(error);\n      };\n      response\n          .on('data', chunk => content += chunk)\n          .on('end', handleError)\n          .on('error', handleError);\n      return;\n    }\n    totalBytes = parseInt(response.headers['content-length'] || '0', 10);\n    log(`-- total bytes: ${totalBytes}`);\n    const file = fs.createWriteStream(options.zipPath);\n    file.on('finish', () => {\n      if (downloadedBytes !== totalBytes) {\n        log(`-- download failed, size mismatch: ${downloadedBytes} != ${totalBytes}`);\n        promise.reject(new Error(`Download failed: size mismatch, file size: ${downloadedBytes}, expected size: ${totalBytes} URL: ${options.url}`));\n      } else {\n        log(`-- download complete, size: ${downloadedBytes}`);\n        promise.resolve();\n      }\n    });\n    file.on('error', error => promise.reject(error));\n    response.pipe(file);\n    response.on('data', onData);\n    response.on('error', (error: any) => {\n      file.close();\n      if (error?.code === 'ECONNRESET') {\n        log(`-- download failed, server closed connection`);\n        promise.reject(new Error(`Download failed: server closed connection. URL: ${options.url}`));\n      } else {\n        log(`-- download failed, unexpected error`);\n        promise.reject(new Error(`Download failed: ${error?.message ?? error}. URL: ${options.url}`));\n      }\n    });\n  }, (error: any) => promise.reject(error));\n  return promise;\n\n  function onData(chunk: string) {\n    downloadedBytes += chunk.length;\n    progress(downloadedBytes, totalBytes);\n  }\n}\n\nasync function main(options: DownloadParams) {\n  await downloadFile(options);\n  log(`SUCCESS downloading ${options.title}`);\n  log(`extracting archive`);\n  await extract(options.zipPath, { dir: options.browserDirectory });\n  if (options.executablePath) {\n    log(`fixing permissions at ${options.executablePath}`);\n    await fs.promises.chmod(options.executablePath, 0o755);\n  }\n  await fs.promises.writeFile(browserDirectoryToMarkerFilePath(options.browserDirectory), '');\n}\n\nprocess.on('message', async message => {\n  const { method, params } = message as any;\n  if (method === 'download') {\n    try {\n      await main(params);\n      // eslint-disable-next-line no-restricted-properties\n      process.exit(0);\n    } catch (e) {\n      // eslint-disable-next-line no-console\n      console.error(e);\n      // eslint-disable-next-line no-restricted-properties\n      process.exit(1);\n    }\n  }\n});\n\n// eslint-disable-next-line no-restricted-properties\nprocess.on('disconnect', () => { process.exit(0); });\n"],"mappings":"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"}