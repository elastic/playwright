{"version":3,"file":"harRecorder.js","names":["_fs","_interopRequireDefault","require","_path","_artifact","_harTracer","_zipBundle","_manualPromise","_utils","obj","__esModule","default","HarRecorder","constructor","context","page","options","_isFlushed","_tracer","_entries","_zipFile","_writtenZipEntries","Set","Artifact","path","join","_browser","artifactsDir","createGuid","urlFilterRe","urlRegexSource","undefined","urlRegexFlags","RegExp","expectsZip","endsWith","content","HarTracer","slimMode","mode","includeTraceInfo","recordRequestOverrides","waitForContentOnStop","urlFilter","urlGlob","yazl","ZipFile","start","omitScripts","onEntryStarted","entry","push","onEntryFinished","onContentBlob","sha1","buffer","has","add","addBuffer","flush","log","stop","entries","harFileContent","jsonStringify","result","ManualPromise","on","error","reject","Buffer","from","end","outputStream","pipe","fs","createWriteStream","localPath","resolve","promises","writeFile","export","reportFinished","exports","object","tokens","innerJsonStringify","indent","flat","parentKey","JSON","stringify","isArray","Array","name","Object","filter","e","length","childIndent","brackets","open","close","i","key","flatten"],"sources":["../../../src/server/har/harRecorder.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport path from 'path';\nimport { Artifact } from '../artifact';\nimport type { BrowserContext } from '../browserContext';\nimport type * as har from '@trace/har';\nimport { HarTracer } from './harTracer';\nimport type { HarTracerDelegate } from './harTracer';\nimport type * as channels from '@protocol/channels';\nimport { yazl } from '../../zipBundle';\nimport type { ZipFile } from '../../zipBundle';\nimport { ManualPromise } from '../../utils/manualPromise';\nimport type EventEmitter from 'events';\nimport { createGuid } from '../../utils';\nimport type { Page } from '../page';\n\nexport class HarRecorder implements HarTracerDelegate {\n  private _artifact: Artifact;\n  private _isFlushed: boolean = false;\n  private _tracer: HarTracer;\n  private _entries: har.Entry[] = [];\n  private _zipFile: ZipFile | null = null;\n  private _writtenZipEntries = new Set<string>();\n\n  constructor(context: BrowserContext, page: Page | null, options: channels.RecordHarOptions) {\n    this._artifact = new Artifact(context, path.join(context._browser.options.artifactsDir, `${createGuid()}.har`));\n    const urlFilterRe = options.urlRegexSource !== undefined && options.urlRegexFlags !== undefined ? new RegExp(options.urlRegexSource, options.urlRegexFlags) : undefined;\n    const expectsZip = options.path.endsWith('.zip');\n    const content = options.content || (expectsZip ? 'attach' : 'embed');\n    this._tracer = new HarTracer(context, page, this, {\n      content,\n      slimMode: options.mode === 'minimal',\n      includeTraceInfo: false,\n      recordRequestOverrides: true,\n      waitForContentOnStop: true,\n      urlFilter: urlFilterRe ?? options.urlGlob,\n    });\n    this._zipFile = content === 'attach' || expectsZip ? new yazl.ZipFile() : null;\n    this._tracer.start({ omitScripts: false });\n  }\n\n  onEntryStarted(entry: har.Entry) {\n    this._entries.push(entry);\n  }\n\n  onEntryFinished(entry: har.Entry) {\n  }\n\n  onContentBlob(sha1: string, buffer: Buffer) {\n    if (!this._zipFile || this._writtenZipEntries.has(sha1))\n      return;\n    this._writtenZipEntries.add(sha1);\n    this._zipFile!.addBuffer(buffer, sha1);\n  }\n\n  async flush() {\n    if (this._isFlushed)\n      return;\n    this._isFlushed = true;\n    await this._tracer.flush();\n\n    const log = this._tracer.stop();\n    log.entries = this._entries;\n\n    const harFileContent = jsonStringify({ log });\n\n    if (this._zipFile) {\n      const result = new ManualPromise<void>();\n      (this._zipFile as unknown as EventEmitter).on('error', error => result.reject(error));\n      this._zipFile.addBuffer(Buffer.from(harFileContent, 'utf-8'), 'har.har');\n      this._zipFile.end();\n      this._zipFile.outputStream.pipe(fs.createWriteStream(this._artifact.localPath())).on('close', () => {\n        result.resolve();\n      });\n      await result;\n    } else {\n      await fs.promises.writeFile(this._artifact.localPath(), harFileContent);\n    }\n  }\n\n  async export(): Promise<Artifact> {\n    await this.flush();\n    this._artifact.reportFinished();\n    return this._artifact;\n  }\n}\n\nfunction jsonStringify(object: any): string {\n  const tokens: string[] = [];\n  innerJsonStringify(object, tokens, '', false, undefined);\n  return tokens.join('');\n}\n\nfunction innerJsonStringify(object: any, tokens: string[], indent: string, flat: boolean, parentKey: string | undefined) {\n  if (typeof object !== 'object' || object === null) {\n    tokens.push(JSON.stringify(object));\n    return;\n  }\n\n  const isArray = Array.isArray(object);\n  if (!isArray && object.constructor.name !== 'Object') {\n    tokens.push(JSON.stringify(object));\n    return;\n  }\n\n  const entries = isArray ? object : Object.entries(object).filter(e => e[1] !== undefined);\n  if (!entries.length) {\n    tokens.push(isArray ? `[]` : `{}`);\n    return;\n  }\n\n  const childIndent = `${indent}  `;\n  let brackets: { open: string, close: string };\n  if (isArray)\n    brackets = flat ? { open: '[', close: ']' } : { open: `[\\n${childIndent}`, close: `\\n${indent}]` };\n  else\n    brackets = flat ? { open: '{ ', close: ' }' } : { open: `{\\n${childIndent}`, close: `\\n${indent}}` };\n\n  tokens.push(brackets.open);\n\n  for (let i = 0; i < entries.length; ++i) {\n    const entry = entries[i];\n    if (i)\n      tokens.push(flat ? `, ` : `,\\n${childIndent}`);\n    if (!isArray)\n      tokens.push(`${JSON.stringify(entry[0])}: `);\n    const key = isArray ? undefined : entry[0];\n    const flatten = flat || key === 'timings' || parentKey === 'headers';\n    innerJsonStringify(isArray ? entry : entry[1], tokens, childIndent, flatten, key);\n  }\n\n  tokens.push(brackets.close);\n}\n"],"mappings":"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"}