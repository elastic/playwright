{"version":3,"file":"serializers.js","names":["parseSerializedValue","value","handles","innerParseSerializedValue","Map","refs","ref","undefined","get","n","s","b","v","NaN","Infinity","d","Date","u","URL","bi","BigInt","e","error","Error","m","name","stack","r","RegExp","p","f","a","result","set","id","push","o","k","h","serializeValue","handleSerializer","innerSerializeValue","lastId","visited","visitorInfo","handle","fallThrough","Object","is","toString","isError","message","isDate","toJSON","isURL","isRegExp","source","flags","Array","isArray","i","length","keys","obj","prototype","call","proto","getPrototypeOf"],"sources":["../../src/protocol/serializers.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { SerializedValue } from '@protocol/channels';\n\nexport function parseSerializedValue(value: SerializedValue, handles: any[] | undefined): any {\n  return innerParseSerializedValue(value, handles, new Map());\n}\n\nfunction innerParseSerializedValue(value: SerializedValue, handles: any[] | undefined, refs: Map<number, object>): any {\n  if (value.ref !== undefined)\n    return refs.get(value.ref);\n  if (value.n !== undefined)\n    return value.n;\n  if (value.s !== undefined)\n    return value.s;\n  if (value.b !== undefined)\n    return value.b;\n  if (value.v !== undefined) {\n    if (value.v === 'undefined')\n      return undefined;\n    if (value.v === 'null')\n      return null;\n    if (value.v === 'NaN')\n      return NaN;\n    if (value.v === 'Infinity')\n      return Infinity;\n    if (value.v === '-Infinity')\n      return -Infinity;\n    if (value.v === '-0')\n      return -0;\n  }\n  if (value.d !== undefined)\n    return new Date(value.d);\n  if (value.u !== undefined)\n    return new URL(value.u);\n  if (value.bi !== undefined)\n    return BigInt(value.bi);\n  if (value.e !== undefined) {\n    const error = new Error(value.e.m);\n    error.name = value.e.n;\n    error.stack = value.e.s;\n    return error;\n  }\n  if (value.r !== undefined)\n    return new RegExp(value.r.p, value.r.f);\n\n  if (value.a !== undefined) {\n    const result: any[] = [];\n    refs.set(value.id!, result);\n    for (const v of value.a)\n      result.push(innerParseSerializedValue(v, handles, refs));\n    return result;\n  }\n  if (value.o !== undefined) {\n    const result: any = {};\n    refs.set(value.id!, result);\n    for (const { k, v } of value.o)\n      result[k] = innerParseSerializedValue(v, handles, refs);\n    return result;\n  }\n  if (value.h !== undefined) {\n    if (handles === undefined)\n      throw new Error('Unexpected handle');\n    return handles[value.h];\n  }\n  throw new Error('Unexpected value');\n}\n\nexport type HandleOrValue = { h: number } | { fallThrough: any };\ntype VisitorInfo = {\n  visited: Map<object, number>;\n  lastId: number;\n};\n\nexport function serializeValue(value: any, handleSerializer: (value: any) => HandleOrValue): SerializedValue {\n  return innerSerializeValue(value, handleSerializer, { lastId: 0, visited: new Map() });\n}\n\nfunction innerSerializeValue(value: any, handleSerializer: (value: any) => HandleOrValue, visitorInfo: VisitorInfo): SerializedValue {\n  const handle = handleSerializer(value);\n  if ('fallThrough' in handle)\n    value = handle.fallThrough;\n  else\n    return handle;\n\n  if (typeof value === 'symbol')\n    return { v: 'undefined' };\n  if (Object.is(value, undefined))\n    return { v: 'undefined' };\n  if (Object.is(value, null))\n    return { v: 'null' };\n  if (Object.is(value, NaN))\n    return { v: 'NaN' };\n  if (Object.is(value, Infinity))\n    return { v: 'Infinity' };\n  if (Object.is(value, -Infinity))\n    return { v: '-Infinity' };\n  if (Object.is(value, -0))\n    return { v: '-0' };\n  if (typeof value === 'boolean')\n    return { b: value };\n  if (typeof value === 'number')\n    return { n: value };\n  if (typeof value === 'string')\n    return { s: value };\n  if (typeof value === 'bigint')\n    return { bi: value.toString() };\n  if (isError(value))\n    return { e: { n: value.name, m: value.message, s: value.stack || '' } };\n  if (isDate(value))\n    return { d: value.toJSON() };\n  if (isURL(value))\n    return { u: value.toJSON() };\n  if (isRegExp(value))\n    return { r: { p: value.source, f: value.flags } };\n\n  const id = visitorInfo.visited.get(value);\n  if (id)\n    return { ref: id };\n\n  if (Array.isArray(value)) {\n    const a = [];\n    const id = ++visitorInfo.lastId;\n    visitorInfo.visited.set(value, id);\n    for (let i = 0; i < value.length; ++i)\n      a.push(innerSerializeValue(value[i], handleSerializer, visitorInfo));\n    return { a, id };\n  }\n  if (typeof value === 'object') {\n    const o: { k: string, v: SerializedValue }[] = [];\n    const id = ++visitorInfo.lastId;\n    visitorInfo.visited.set(value, id);\n    for (const name of Object.keys(value))\n      o.push({ k: name, v: innerSerializeValue(value[name], handleSerializer, visitorInfo) });\n    return { o, id };\n  }\n  throw new Error('Unexpected value');\n}\n\nfunction isRegExp(obj: any): obj is RegExp {\n  return obj instanceof RegExp || Object.prototype.toString.call(obj) === '[object RegExp]';\n}\n\nfunction isDate(obj: any): obj is Date {\n  return obj instanceof Date || Object.prototype.toString.call(obj) === '[object Date]';\n}\n\nfunction isURL(obj: any): obj is URL {\n  return obj instanceof URL || Object.prototype.toString.call(obj) === '[object URL]';\n}\n\nfunction isError(obj: any): obj is Error {\n  const proto = obj ? Object.getPrototypeOf(obj) : null;\n  return obj instanceof Error || proto?.name === 'Error' || (proto && isError(proto));\n}\n"],"mappings":"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"}