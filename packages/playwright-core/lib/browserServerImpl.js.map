{"version":3,"file":"browserServerImpl.js","names":["_utilsBundle","require","_clientHelper","_utils","_instrumentation","_playwright","_playwrightServer","_helper","_stackTrace","_socksProxy","BrowserServerLauncherImpl","constructor","browserName","_browserName","launchServer","options","playwright","createPlaywright","sdkLanguage","isServer","socksProxy","SocksProxy","undefined","socksProxyPort","listen","metadata","serverSideCallMetadata","browser","launch","ignoreDefaultArgs","Array","isArray","ignoreAllDefaultArgs","env","envObjectToArray","toProtocolLogger","logger","catch","e","log","helper","formatBrowserLogs","rewriteErrorMessage","message","path","wsPath","startsWith","createGuid","server","PlaywrightServer","mode","maxConnections","Infinity","preLaunchedBrowser","preLaunchedSocksProxy","wsEndpoint","port","host","browserServer","ws","EventEmitter","process","browserProcess","close","Symbol","asyncDispose","kill","_disconnectForTest","_userDataDirForTest","onclose","exitCode","signal","emit","exports","direction","isEnabled","JSON","stringify"],"sources":["../src/browserServerImpl.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the 'License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { LaunchServerOptions, Logger } from './client/types';\nimport { ws } from './utilsBundle';\nimport type { WebSocketEventEmitter } from './utilsBundle';\nimport type { BrowserServerLauncher, BrowserServer } from './client/browserType';\nimport { envObjectToArray } from './client/clientHelper';\nimport { createGuid } from './utils';\nimport type { ProtocolLogger } from './server/types';\nimport { serverSideCallMetadata } from './server/instrumentation';\nimport { createPlaywright } from './server/playwright';\nimport { PlaywrightServer } from './remote/playwrightServer';\nimport { helper } from './server/helper';\nimport { rewriteErrorMessage } from './utils/stackTrace';\nimport { SocksProxy } from './common/socksProxy';\n\nexport class BrowserServerLauncherImpl implements BrowserServerLauncher {\n  private _browserName: 'chromium' | 'firefox' | 'webkit';\n\n  constructor(browserName: 'chromium' | 'firefox' | 'webkit') {\n    this._browserName = browserName;\n  }\n\n  async launchServer(options: LaunchServerOptions = {}): Promise<BrowserServer> {\n    const playwright = createPlaywright({ sdkLanguage: 'javascript', isServer: true });\n    // TODO: enable socks proxy once ipv6 is supported.\n    const socksProxy = false ? new SocksProxy() : undefined;\n    playwright.options.socksProxyPort = await socksProxy?.listen(0);\n\n    // 1. Pre-launch the browser\n    const metadata = serverSideCallMetadata();\n    const browser = await playwright[this._browserName].launch(metadata, {\n      ...options,\n      ignoreDefaultArgs: Array.isArray(options.ignoreDefaultArgs) ? options.ignoreDefaultArgs : undefined,\n      ignoreAllDefaultArgs: !!options.ignoreDefaultArgs && !Array.isArray(options.ignoreDefaultArgs),\n      env: options.env ? envObjectToArray(options.env) : undefined,\n    }, toProtocolLogger(options.logger)).catch(e => {\n      const log = helper.formatBrowserLogs(metadata.log);\n      rewriteErrorMessage(e, `${e.message} Failed to launch browser.${log}`);\n      throw e;\n    });\n\n    const path = options.wsPath ? (options.wsPath.startsWith('/') ? options.wsPath : `/${options.wsPath}`) : `/${createGuid()}`;\n\n    // 2. Start the server\n    const server = new PlaywrightServer({ mode: 'launchServer', path, maxConnections: Infinity, preLaunchedBrowser: browser, preLaunchedSocksProxy: socksProxy });\n    const wsEndpoint = await server.listen(options.port, options.host);\n\n    // 3. Return the BrowserServer interface\n    const browserServer = new ws.EventEmitter() as (BrowserServer & WebSocketEventEmitter);\n    browserServer.process = () => browser.options.browserProcess.process!;\n    browserServer.wsEndpoint = () => wsEndpoint;\n    browserServer.close = () => browser.options.browserProcess.close();\n    browserServer[Symbol.asyncDispose] = browserServer.close;\n    browserServer.kill = () => browser.options.browserProcess.kill();\n    (browserServer as any)._disconnectForTest = () => server.close();\n    (browserServer as any)._userDataDirForTest = (browser as any)._userDataDirForTest;\n    browser.options.browserProcess.onclose = (exitCode, signal) => {\n      socksProxy?.close().catch(() => {});\n      server.close();\n      browserServer.emit('close', exitCode, signal);\n    };\n    return browserServer;\n  }\n}\n\nfunction toProtocolLogger(logger: Logger | undefined): ProtocolLogger | undefined {\n  return logger ? (direction: 'send' | 'receive', message: object) => {\n    if (logger.isEnabled('protocol', 'verbose'))\n      logger.log('protocol', 'verbose', (direction === 'send' ? 'SEND ► ' : '◀ RECV ') + JSON.stringify(message), [], {});\n  } : undefined;\n}\n"],"mappings":"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"}