{"version":3,"file":"fsWatcher.js","names":["_utilsBundle","require","Watcher","constructor","onChange","_onChange","_watchedPaths","_ignoredFolders","_collector","_fsWatcher","_throttleTimer","update","watchedPaths","ignoredFolders","reportPending","_this$_fsWatcher","JSON","stringify","_reportEventsIfAny","close","undefined","length","clearTimeout","ignored","chokidar","watch","ignoreInitial","on","event","file","push","setTimeout","Promise","resolve","reject","once","_this$_fsWatcher2","slice","exports"],"sources":["../src/fsWatcher.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { chokidar } from './utilsBundle';\nimport type { FSWatcher } from 'chokidar';\n\nexport type FSEvent = { event: 'add' | 'addDir' | 'change' | 'unlink' | 'unlinkDir', file: string };\n\nexport class Watcher {\n  private _onChange: (events: FSEvent[]) => void;\n  private _watchedPaths: string[] = [];\n  private _ignoredFolders: string[] = [];\n  private _collector: FSEvent[] = [];\n  private _fsWatcher: FSWatcher | undefined;\n  private _throttleTimer: NodeJS.Timeout | undefined;\n\n  constructor(onChange: (events: FSEvent[]) => void) {\n    this._onChange = onChange;\n  }\n\n  async update(watchedPaths: string[], ignoredFolders: string[], reportPending: boolean) {\n    if (JSON.stringify([this._watchedPaths, this._ignoredFolders]) === JSON.stringify(watchedPaths, ignoredFolders))\n      return;\n\n    if (reportPending)\n      this._reportEventsIfAny();\n\n    this._watchedPaths = watchedPaths;\n    this._ignoredFolders = ignoredFolders;\n    void this._fsWatcher?.close();\n    this._fsWatcher = undefined;\n    this._collector.length = 0;\n    clearTimeout(this._throttleTimer);\n    this._throttleTimer = undefined;\n\n    if (!this._watchedPaths.length)\n      return;\n\n    const ignored = [...this._ignoredFolders, '**/node_modules/**'];\n    this._fsWatcher = chokidar.watch(watchedPaths, { ignoreInitial: true, ignored }).on('all', async (event, file) => {\n      if (this._throttleTimer)\n        clearTimeout(this._throttleTimer);\n      this._collector.push({ event, file });\n      this._throttleTimer = setTimeout(() => this._reportEventsIfAny(), 250);\n    });\n\n    await new Promise((resolve, reject) => this._fsWatcher!.once('ready', resolve).once('error', reject));\n  }\n\n  async close() {\n    await this._fsWatcher?.close();\n  }\n\n  private _reportEventsIfAny() {\n    if (this._collector.length)\n      this._onChange(this._collector.slice());\n    this._collector.length = 0;\n  }\n}\n"],"mappings":";;;;;;AAgBA,IAAAA,YAAA,GAAAC,OAAA;AAhBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAOO,MAAMC,OAAO,CAAC;EAQnBC,WAAWA,CAACC,QAAqC,EAAE;IAAA,KAP3CC,SAAS;IAAA,KACTC,aAAa,GAAa,EAAE;IAAA,KAC5BC,eAAe,GAAa,EAAE;IAAA,KAC9BC,UAAU,GAAc,EAAE;IAAA,KAC1BC,UAAU;IAAA,KACVC,cAAc;IAGpB,IAAI,CAACL,SAAS,GAAGD,QAAQ;EAC3B;EAEA,MAAMO,MAAMA,CAACC,YAAsB,EAAEC,cAAwB,EAAEC,aAAsB,EAAE;IAAA,IAAAC,gBAAA;IACrF,IAAIC,IAAI,CAACC,SAAS,CAAC,CAAC,IAAI,CAACX,aAAa,EAAE,IAAI,CAACC,eAAe,CAAC,CAAC,KAAKS,IAAI,CAACC,SAAS,CAACL,YAAY,EAAEC,cAAc,CAAC,EAC7G;IAEF,IAAIC,aAAa,EACf,IAAI,CAACI,kBAAkB,CAAC,CAAC;IAE3B,IAAI,CAACZ,aAAa,GAAGM,YAAY;IACjC,IAAI,CAACL,eAAe,GAAGM,cAAc;IACrC,OAAAE,gBAAA,GAAK,IAAI,CAACN,UAAU,cAAAM,gBAAA,uBAAfA,gBAAA,CAAiBI,KAAK,CAAC,CAAC;IAC7B,IAAI,CAACV,UAAU,GAAGW,SAAS;IAC3B,IAAI,CAACZ,UAAU,CAACa,MAAM,GAAG,CAAC;IAC1BC,YAAY,CAAC,IAAI,CAACZ,cAAc,CAAC;IACjC,IAAI,CAACA,cAAc,GAAGU,SAAS;IAE/B,IAAI,CAAC,IAAI,CAACd,aAAa,CAACe,MAAM,EAC5B;IAEF,MAAME,OAAO,GAAG,CAAC,GAAG,IAAI,CAAChB,eAAe,EAAE,oBAAoB,CAAC;IAC/D,IAAI,CAACE,UAAU,GAAGe,qBAAQ,CAACC,KAAK,CAACb,YAAY,EAAE;MAAEc,aAAa,EAAE,IAAI;MAAEH;IAAQ,CAAC,CAAC,CAACI,EAAE,CAAC,KAAK,EAAE,OAAOC,KAAK,EAAEC,IAAI,KAAK;MAChH,IAAI,IAAI,CAACnB,cAAc,EACrBY,YAAY,CAAC,IAAI,CAACZ,cAAc,CAAC;MACnC,IAAI,CAACF,UAAU,CAACsB,IAAI,CAAC;QAAEF,KAAK;QAAEC;MAAK,CAAC,CAAC;MACrC,IAAI,CAACnB,cAAc,GAAGqB,UAAU,CAAC,MAAM,IAAI,CAACb,kBAAkB,CAAC,CAAC,EAAE,GAAG,CAAC;IACxE,CAAC,CAAC;IAEF,MAAM,IAAIc,OAAO,CAAC,CAACC,OAAO,EAAEC,MAAM,KAAK,IAAI,CAACzB,UAAU,CAAE0B,IAAI,CAAC,OAAO,EAAEF,OAAO,CAAC,CAACE,IAAI,CAAC,OAAO,EAAED,MAAM,CAAC,CAAC;EACvG;EAEA,MAAMf,KAAKA,CAAA,EAAG;IAAA,IAAAiB,iBAAA;IACZ,QAAAA,iBAAA,GAAM,IAAI,CAAC3B,UAAU,cAAA2B,iBAAA,uBAAfA,iBAAA,CAAiBjB,KAAK,CAAC,CAAC;EAChC;EAEQD,kBAAkBA,CAAA,EAAG;IAC3B,IAAI,IAAI,CAACV,UAAU,CAACa,MAAM,EACxB,IAAI,CAAChB,SAAS,CAAC,IAAI,CAACG,UAAU,CAAC6B,KAAK,CAAC,CAAC,CAAC;IACzC,IAAI,CAAC7B,UAAU,CAACa,MAAM,GAAG,CAAC;EAC5B;AACF;AAACiB,OAAA,CAAApC,OAAA,GAAAA,OAAA"}