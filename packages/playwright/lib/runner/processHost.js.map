{"version":3,"file":"processHost.js","names":["_child_process","_interopRequireDefault","require","_events","_utilsBundle","_esmUtils","_utils","_esmLoaderHost","obj","__esModule","default","ProcessHost","EventEmitter","constructor","runnerScript","processName","env","process","_didSendStop","_processDidExit","_didExitAndRanOnExit","_runnerScript","_lastMessageId","_callbacks","Map","_processName","_producedEnv","_extraEnv","startRunner","runnerParams","options","_this$process$stdout","_this$process$stderr","assert","child_process","fork","resolve","detached","esmLoaderRegistered","PW_TS_ESM_LOADER_ON","stdio","onStdOut","onStdErr","PW_RUNNER_DEBUG","PW_TS_ESM_LEGACY_LOADER_ON","execArgv","execArgvWithExperimentalLoaderOptions","on","code","signal","onExit","emit","unexpectedly","e","message","debug","enabled","JSON","stringify","method","producedEnv","params","Object","fromEntries","map","_e$","undefined","id","error","result","has","reject","get","delete","errorObject","Error","stack","stdout","stderr","Promise","once","processParams","send","sendMessage","set","sendMessageNoReply","catch","stop","f","didSendStop","_this$process","exports"],"sources":["../../src/runner/processHost.ts"],"sourcesContent":["/**\n * Copyright Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport child_process from 'child_process';\nimport { EventEmitter } from 'events';\nimport { debug } from 'playwright-core/lib/utilsBundle';\nimport type { EnvProducedPayload, ProcessInitParams } from '../common/ipc';\nimport type { ProtocolResponse } from '../common/process';\nimport { execArgvWithExperimentalLoaderOptions } from '../transform/esmUtils';\nimport { assert } from 'playwright-core/lib/utils';\nimport { esmLoaderRegistered } from '../common/esmLoaderHost';\n\nexport type ProcessExitData = {\n  unexpectedly: boolean;\n  code: number | null;\n  signal: NodeJS.Signals | null;\n};\n\nexport class ProcessHost extends EventEmitter {\n  private process: child_process.ChildProcess | undefined;\n  private _didSendStop = false;\n  private _processDidExit = false;\n  private _didExitAndRanOnExit = false;\n  private _runnerScript: string;\n  private _lastMessageId = 0;\n  private _callbacks = new Map<number, { resolve: (result: any) => void, reject: (error: Error) => void }>();\n  private _processName: string;\n  private _producedEnv: Record<string, string | undefined> = {};\n  private _extraEnv: Record<string, string | undefined>;\n\n  constructor(runnerScript: string, processName: string, env: Record<string, string | undefined>) {\n    super();\n    this._runnerScript = runnerScript;\n    this._processName = processName;\n    this._extraEnv = env;\n  }\n\n  async startRunner(runnerParams: any, options: { onStdOut?: (chunk: Buffer | string) => void, onStdErr?: (chunk: Buffer | string) => void } = {}): Promise<ProcessExitData | undefined> {\n    assert(!this.process, 'Internal error: starting the same process twice');\n    this.process = child_process.fork(require.resolve('../common/process'), {\n      detached: false,\n      env: {\n        ...process.env,\n        ...this._extraEnv,\n        ...(esmLoaderRegistered ? { PW_TS_ESM_LOADER_ON: '1' } : {}),\n      },\n      stdio: [\n        'ignore',\n        options.onStdOut ? 'pipe' : 'inherit',\n        (options.onStdErr && !process.env.PW_RUNNER_DEBUG) ? 'pipe' : 'inherit',\n        'ipc',\n      ],\n      ...(process.env.PW_TS_ESM_LEGACY_LOADER_ON ? { execArgv: execArgvWithExperimentalLoaderOptions() } : {}),\n    });\n    this.process.on('exit', async (code, signal) => {\n      this._processDidExit = true;\n      await this.onExit();\n      this._didExitAndRanOnExit = true;\n      this.emit('exit', { unexpectedly: !this._didSendStop, code, signal } as ProcessExitData);\n    });\n    this.process.on('error', e => {});  // do not yell at a send to dead process.\n    this.process.on('message', (message: any) => {\n      if (debug.enabled('pw:test:protocol'))\n        debug('pw:test:protocol')('◀ RECV ' + JSON.stringify(message));\n      if (message.method === '__env_produced__') {\n        const producedEnv: EnvProducedPayload = message.params;\n        this._producedEnv = Object.fromEntries(producedEnv.map(e => [e[0], e[1] ?? undefined]));\n      } else if (message.method === '__dispatch__') {\n        const { id, error, method, params, result } = message.params as ProtocolResponse;\n        if (id && this._callbacks.has(id)) {\n          const { resolve, reject } = this._callbacks.get(id)!;\n          this._callbacks.delete(id);\n          if (error) {\n            const errorObject = new Error(error.message);\n            errorObject.stack = error.stack;\n            reject(errorObject);\n          } else {\n            resolve(result);\n          }\n        } else {\n          this.emit(method!, params);\n        }\n      } else {\n        this.emit(message.method!, message.params);\n      }\n    });\n\n    if (options.onStdOut)\n      this.process.stdout?.on('data', options.onStdOut);\n    if (options.onStdErr)\n      this.process.stderr?.on('data', options.onStdErr);\n\n    const error = await new Promise<ProcessExitData | undefined>(resolve => {\n      this.process!.once('exit', (code, signal) => resolve({ unexpectedly: true, code, signal }));\n      this.once('ready', () => resolve(undefined));\n    });\n\n    if (error)\n      return error;\n\n    const processParams: ProcessInitParams = {\n      processName: this._processName\n    };\n\n    this.send({\n      method: '__init__', params: {\n        processParams,\n        runnerScript: this._runnerScript,\n        runnerParams\n      }\n    });\n  }\n\n  sendMessage(message: { method: string, params?: any }) {\n    const id = ++this._lastMessageId;\n    this.send({\n      method: '__dispatch__',\n      params: { id, ...message }\n    });\n    return new Promise((resolve, reject) => {\n      this._callbacks.set(id, { resolve, reject });\n    });\n  }\n\n  protected sendMessageNoReply(message: { method: string, params?: any }) {\n    this.sendMessage(message).catch(() => {});\n  }\n\n  protected async onExit() {\n  }\n\n  async stop() {\n    if (!this._processDidExit && !this._didSendStop) {\n      this.send({ method: '__stop__' });\n      this._didSendStop = true;\n    }\n    if (!this._didExitAndRanOnExit)\n      await new Promise(f => this.once('exit', f));\n  }\n\n  didSendStop() {\n    return this._didSendStop;\n  }\n\n  producedEnv() {\n    return this._producedEnv;\n  }\n\n  private send(message: { method: string, params?: any }) {\n    if (debug.enabled('pw:test:protocol'))\n      debug('pw:test:protocol')('SEND ► ' + JSON.stringify(message));\n    this.process?.send(message);\n  }\n}\n"],"mappings":"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"}