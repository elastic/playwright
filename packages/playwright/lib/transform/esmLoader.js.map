{"version":3,"file":"esmLoader.js","names":["_fs","_interopRequireDefault","require","_url","_compilationCache","_transform","_portTransport","_util","obj","__esModule","default","resolve","specifier","context","defaultResolve","_currentFileDepsColle","parentURL","startsWith","filename","url","fileURLToPath","resolved","resolveHook","undefined","pathToFileURL","toString","result","currentFileDepsCollector","add","load","moduleUrl","defaultLoad","_transport","format","shouldTransform","code","fs","readFileSync","transformed","transformHook","serializedCache","transport","send","cache","fileIsModule","source","shortCircuit","globalPreload","createTransport","port","initialize","data","PortTransport","method","params","setSingleTSConfig","tsconfig","setTransformConfig","config","addToCompilationCache","serializeCompilationCache","startCollectingFileDeps","stopCollectingFileDeps","file","module","exports"],"sources":["../../src/transform/esmLoader.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport url from 'url';\nimport { addToCompilationCache, currentFileDepsCollector, serializeCompilationCache, startCollectingFileDeps, stopCollectingFileDeps } from './compilationCache';\nimport { transformHook, resolveHook, setTransformConfig, shouldTransform, setSingleTSConfig } from './transform';\nimport { PortTransport } from './portTransport';\nimport { fileIsModule } from '../util';\n\n// Node < 18.6: defaultResolve takes 3 arguments.\n// Node >= 18.6: nextResolve from the chain takes 2 arguments.\nasync function resolve(specifier: string, context: { parentURL?: string }, defaultResolve: Function) {\n  if (context.parentURL && context.parentURL.startsWith('file://')) {\n    const filename = url.fileURLToPath(context.parentURL);\n    const resolved = resolveHook(filename, specifier, true);\n    if (resolved !== undefined)\n      specifier = url.pathToFileURL(resolved).toString();\n  }\n  const result = await defaultResolve(specifier, context, defaultResolve);\n  // Note: we collect dependencies here that will be sent to the main thread\n  // (and optionally runner process) after the loading finishes.\n  if (result?.url && result.url.startsWith('file://'))\n    currentFileDepsCollector()?.add(url.fileURLToPath(result.url));\n\n  return result;\n}\n\n// Node < 18.6: defaultLoad takes 3 arguments.\n// Node >= 18.6: nextLoad from the chain takes 2 arguments.\nasync function load(moduleUrl: string, context: { format?: string }, defaultLoad: Function) {\n  // Bail out for wasm, json, etc.\n  // non-js files have context.format === undefined\n  if (context.format !== 'commonjs' && context.format !== 'module' && context.format !== undefined)\n    return defaultLoad(moduleUrl, context, defaultLoad);\n\n  // Bail for built-in modules.\n  if (!moduleUrl.startsWith('file://'))\n    return defaultLoad(moduleUrl, context, defaultLoad);\n\n  const filename = url.fileURLToPath(moduleUrl);\n  // Bail for node_modules.\n  if (!shouldTransform(filename))\n    return defaultLoad(moduleUrl, context, defaultLoad);\n\n  const code = fs.readFileSync(filename, 'utf-8');\n  const transformed = transformHook(code, filename, moduleUrl);\n\n  // Flush the source maps to the main thread, so that errors during import() are source-mapped.\n  if (transformed.serializedCache)\n    await transport?.send('pushToCompilationCache', { cache: transformed.serializedCache });\n\n  // Output format is required, so we determine it manually when unknown.\n  // shortCircuit is required by Node >= 18.6 to designate no more loaders should be called.\n  return {\n    format: context.format || (fileIsModule(filename) ? 'module' : 'commonjs'),\n    source: transformed.code,\n    shortCircuit: true,\n  };\n}\n\nlet transport: PortTransport | undefined;\n\n// Node.js < 20\nfunction globalPreload(context: { port: MessagePort }) {\n  transport = createTransport(context.port);\n  return `\n    globalThis.__esmLoaderPortPreV20 = port;\n  `;\n}\n\n// Node.js >= 20\nfunction initialize(data: { port: MessagePort }) {\n  transport = createTransport(data?.port);\n}\n\nfunction createTransport(port: MessagePort) {\n  return new PortTransport(port, async (method, params) => {\n    if (method === 'setSingleTSConfig') {\n      setSingleTSConfig(params.tsconfig);\n      return;\n    }\n\n    if (method === 'setTransformConfig') {\n      setTransformConfig(params.config);\n      return;\n    }\n\n    if (method === 'addToCompilationCache') {\n      addToCompilationCache(params.cache);\n      return;\n    }\n\n    if (method === 'getCompilationCache')\n      return { cache: serializeCompilationCache() };\n\n    if (method === 'startCollectingFileDeps') {\n      startCollectingFileDeps();\n      return;\n    }\n\n    if (method === 'stopCollectingFileDeps') {\n      stopCollectingFileDeps(params.file);\n      return;\n    }\n  });\n}\n\n\nmodule.exports = { resolve, load, globalPreload, initialize };\n"],"mappings":"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"}