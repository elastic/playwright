{"version":3,"file":"fixtures.js","names":["_util","require","crypto","_interopRequireWildcard","_getRequireWildcardCache","e","WeakMap","r","t","__esModule","default","has","get","n","__proto__","a","Object","defineProperty","getOwnPropertyDescriptor","u","prototype","hasOwnProperty","call","i","set","kScopeOrder","isFixtureTuple","value","Array","isArray","isFixtureOption","option","FixturePool","constructor","fixturesList","onLoadError","parentPool","disallowWorkerFixtures","optionOverrides","_optionOverrides$over","digest","_registrations","_onLoadError","Map","allOverrides","overrides","overrideKeys","Set","keys","list","_appendFixtureList","selectedOverrides","key","entries","fixtures","length","location","validate","isOptionsOverride","entry","name","options","_value$1$auto","auto","scope","timeout","customTitle","title","box","fn","previous","_addLoadError","formatLocation","undefined","includes","original","optionOverride","super","deps","fixtureParameterNames","registration","id","registrationId","markers","stack","hasDependencyErrors","addDependencyError","message","visit","boxedOnly","push","dep","resolve","indexOf","formatPotentiallyInternalLocation","index","allRegs","slice","filteredRegs","filter","regs","names","map","join","pop","from","sort","hash","createHash","update","validateFunction","prefix","forFixture","autoFixtures","values","exports","signatureSymbol","Symbol","isUserFixture","filterStackFile","file","onError","innerFixtureParameterNames","inheritFixtureNames","to","text","filterOutComments","toString","match","trimmedParams","trim","firstParam","splitByComma","props","substring","prop","colon","restProperty","find","startsWith","s","result","commentState","start","token","lastToken","registrationIdMap","lastId","String"],"sources":["../../src/common/fixtures.ts"],"sourcesContent":["/**\n * Copyright Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { filterStackFile, formatLocation } from '../util';\nimport * as crypto from 'crypto';\nimport type { Fixtures } from '../../types/test';\nimport type { Location } from '../../types/testReporter';\nimport type { FixturesWithLocation } from './config';\n\nexport type FixtureScope = 'test' | 'worker';\ntype FixtureAuto = boolean | 'all-hooks-included';\nconst kScopeOrder: FixtureScope[] = ['test', 'worker'];\ntype FixtureOptions = { auto?: FixtureAuto, scope?: FixtureScope, option?: boolean, timeout?: number | undefined, title?: string, box?: boolean };\ntype FixtureTuple = [ value: any, options: FixtureOptions ];\nexport type FixtureRegistration = {\n  // Fixture registration location.\n  location: Location;\n  // Fixture name comes from test.extend() call.\n  name: string;\n  scope: FixtureScope;\n  // Either a fixture function, or a fixture value.\n  fn: Function | any;\n  // Auto fixtures always run without user explicitly mentioning them.\n  auto: FixtureAuto;\n  // An \"option\" fixture can have a value set in the config.\n  option: boolean;\n  // Custom title to be used instead of the name, internal-only.\n  customTitle?: string;\n  // Fixture with a separate timeout does not count towards the test time.\n  timeout?: number;\n  // Names of the dependencies, comes from the declaration \"({ foo, bar }) => {...}\"\n  deps: string[];\n  // Unique id, to differentiate between fixtures with the same name.\n  id: string;\n  // A fixture override can use the previous version of the fixture.\n  super?: FixtureRegistration;\n  // Whether this fixture is an option override value set from the config.\n  optionOverride?: boolean;\n  // Do not generate the step for this fixture, consider it internal.\n  box?: boolean;\n};\nexport type LoadError = {\n  message: string;\n  location: Location;\n};\ntype LoadErrorSink = (error: LoadError) => void;\ntype OptionOverrides = {\n  overrides: Fixtures,\n  location: Location,\n};\n\nfunction isFixtureTuple(value: any): value is FixtureTuple {\n  return Array.isArray(value) && typeof value[1] === 'object';\n}\n\nfunction isFixtureOption(value: any): value is FixtureTuple {\n  return isFixtureTuple(value) && !!value[1].option;\n}\n\nexport class FixturePool {\n  readonly digest: string;\n  private readonly _registrations: Map<string, FixtureRegistration>;\n  private _onLoadError: LoadErrorSink;\n\n  constructor(fixturesList: FixturesWithLocation[], onLoadError: LoadErrorSink, parentPool?: FixturePool, disallowWorkerFixtures?: boolean, optionOverrides?: OptionOverrides) {\n    this._registrations = new Map(parentPool ? parentPool._registrations : []);\n    this._onLoadError = onLoadError;\n\n    const allOverrides = optionOverrides?.overrides ?? {};\n    const overrideKeys = new Set(Object.keys(allOverrides));\n    for (const list of fixturesList) {\n      this._appendFixtureList(list, !!disallowWorkerFixtures, false);\n\n      // Process option overrides immediately after original option definitions,\n      // so that any test.use() override it.\n      const selectedOverrides: Fixtures = {};\n      for (const [key, value] of Object.entries(list.fixtures)) {\n        if (isFixtureOption(value) && overrideKeys.has(key))\n          (selectedOverrides as any)[key] = [(allOverrides as any)[key], value[1]];\n      }\n      if (Object.entries(selectedOverrides).length)\n        this._appendFixtureList({ fixtures: selectedOverrides, location: optionOverrides!.location }, !!disallowWorkerFixtures, true);\n    }\n\n    this.digest = this.validate();\n  }\n\n  private _appendFixtureList(list: FixturesWithLocation, disallowWorkerFixtures: boolean, isOptionsOverride: boolean) {\n    const { fixtures, location } = list;\n    for (const entry of Object.entries(fixtures)) {\n      const name = entry[0];\n      let value = entry[1];\n      let options: { auto: FixtureAuto, scope: FixtureScope, option: boolean, timeout: number | undefined, customTitle?: string, box?: boolean } | undefined;\n      if (isFixtureTuple(value)) {\n        options = {\n          auto: value[1].auto ?? false,\n          scope: value[1].scope || 'test',\n          option: !!value[1].option,\n          timeout: value[1].timeout,\n          customTitle: value[1].title,\n          box: value[1].box,\n        };\n        value = value[0];\n      }\n      let fn = value as (Function | any);\n\n      const previous = this._registrations.get(name);\n      if (previous && options) {\n        if (previous.scope !== options.scope) {\n          this._addLoadError(`Fixture \"${name}\" has already been registered as a { scope: '${previous.scope}' } fixture defined in ${formatLocation(previous.location)}.`, location);\n          continue;\n        }\n        if (previous.auto !== options.auto) {\n          this._addLoadError(`Fixture \"${name}\" has already been registered as a { auto: '${previous.scope}' } fixture defined in ${formatLocation(previous.location)}.`, location);\n          continue;\n        }\n      } else if (previous) {\n        options = { auto: previous.auto, scope: previous.scope, option: previous.option, timeout: previous.timeout, customTitle: previous.customTitle, box: previous.box };\n      } else if (!options) {\n        options = { auto: false, scope: 'test', option: false, timeout: undefined };\n      }\n\n      if (!kScopeOrder.includes(options.scope)) {\n        this._addLoadError(`Fixture \"${name}\" has unknown { scope: '${options.scope}' }.`, location);\n        continue;\n      }\n      if (options.scope === 'worker' && disallowWorkerFixtures) {\n        this._addLoadError(`Cannot use({ ${name} }) in a describe group, because it forces a new worker.\\nMake it top-level in the test file or put in the configuration file.`, location);\n        continue;\n      }\n\n      // Overriding option with \"undefined\" value means setting it to the default value\n      // from the config or from the original declaration of the option.\n      if (fn === undefined && options.option && previous) {\n        let original = previous;\n        while (!original.optionOverride && original.super)\n          original = original.super;\n        fn = original.fn;\n      }\n\n      const deps = fixtureParameterNames(fn, location, e => this._onLoadError(e));\n      const registration: FixtureRegistration = { id: '', name, location, scope: options.scope, fn, auto: options.auto, option: options.option, timeout: options.timeout, customTitle: options.customTitle, box: options.box, deps, super: previous, optionOverride: isOptionsOverride };\n      registrationId(registration);\n      this._registrations.set(name, registration);\n    }\n  }\n\n  private validate() {\n    const markers = new Map<FixtureRegistration, 'visiting' | 'visited'>();\n    const stack: FixtureRegistration[] = [];\n    let hasDependencyErrors = false;\n    const addDependencyError = (message: string, location: Location) => {\n      hasDependencyErrors = true;\n      this._addLoadError(message, location);\n    };\n    const visit = (registration: FixtureRegistration, boxedOnly: boolean) => {\n      markers.set(registration, 'visiting');\n      stack.push(registration);\n      for (const name of registration.deps) {\n        const dep = this.resolve(name, registration);\n        if (!dep) {\n          if (name === registration.name)\n            addDependencyError(`Fixture \"${registration.name}\" references itself, but does not have a base implementation.`, registration.location);\n          else\n            addDependencyError(`Fixture \"${registration.name}\" has unknown parameter \"${name}\".`, registration.location);\n          continue;\n        }\n        if (kScopeOrder.indexOf(registration.scope) > kScopeOrder.indexOf(dep.scope)) {\n          addDependencyError(`${registration.scope} fixture \"${registration.name}\" cannot depend on a ${dep.scope} fixture \"${name}\" defined in ${formatPotentiallyInternalLocation(dep.location)}.`, registration.location);\n          continue;\n        }\n        if (!markers.has(dep)) {\n          visit(dep, boxedOnly);\n        } else if (markers.get(dep) === 'visiting') {\n          const index = stack.indexOf(dep);\n          const allRegs = stack.slice(index, stack.length);\n          const filteredRegs = allRegs.filter(r => !r.box);\n          const regs = boxedOnly ? filteredRegs : allRegs;\n          const names = regs.map(r => `\"${r.name}\"`);\n          addDependencyError(`Fixtures ${names.join(' -> ')} -> \"${dep.name}\" form a dependency cycle: ${regs.map(r => formatPotentiallyInternalLocation(r.location)).join(' -> ')} -> ${formatPotentiallyInternalLocation(dep.location)}`, dep.location);\n          continue;\n        }\n      }\n      markers.set(registration, 'visited');\n      stack.pop();\n    };\n\n    const names = Array.from(this._registrations.keys()).sort();\n\n    // First iterate over non-boxed fixtures to provide clear error messages.\n    for (const name of names) {\n      const registration = this._registrations.get(name)!;\n      if (!registration.box)\n        visit(registration, true);\n    }\n\n    // If no errors found, iterate over boxed fixtures\n    if (!hasDependencyErrors) {\n      for (const name of names) {\n        const registration = this._registrations.get(name)!;\n        if (registration.box)\n          visit(registration, false);\n      }\n    }\n\n    const hash = crypto.createHash('sha1');\n    for (const name of names) {\n      const registration = this._registrations.get(name)!;\n      if (registration.scope === 'worker')\n        hash.update(registration.id + ';');\n    }\n    return hash.digest('hex');\n  }\n\n  validateFunction(fn: Function, prefix: string, location: Location) {\n    for (const name of fixtureParameterNames(fn, location, e => this._onLoadError(e))) {\n      const registration = this._registrations.get(name);\n      if (!registration)\n        this._addLoadError(`${prefix} has unknown parameter \"${name}\".`, location);\n    }\n  }\n\n  resolve(name: string, forFixture?: FixtureRegistration): FixtureRegistration | undefined {\n    if (name === forFixture?.name)\n      return forFixture.super;\n    return this._registrations.get(name);\n  }\n\n  autoFixtures() {\n    return [...this._registrations.values()].filter(r => r.auto !== false);\n  }\n\n  private _addLoadError(message: string, location: Location) {\n    this._onLoadError({ message, location });\n  }\n}\n\nconst signatureSymbol = Symbol('signature');\n\nexport function formatPotentiallyInternalLocation(location: Location): string {\n  const isUserFixture = location && filterStackFile(location.file);\n  return isUserFixture ? formatLocation(location) : '<builtin>';\n}\n\nexport function fixtureParameterNames(fn: Function | any, location: Location, onError: LoadErrorSink): string[] {\n  if (typeof fn !== 'function')\n    return [];\n  if (!fn[signatureSymbol])\n    fn[signatureSymbol] = innerFixtureParameterNames(fn, location, onError);\n  return fn[signatureSymbol];\n}\n\nexport function inheritFixtureNames(from: Function, to: Function) {\n  (to as any)[signatureSymbol] = (from as any)[signatureSymbol];\n}\n\nfunction innerFixtureParameterNames(fn: Function, location: Location, onError: LoadErrorSink): string[] {\n  const text = filterOutComments(fn.toString());\n  const match = text.match(/(?:async)?(?:\\s+function)?[^(]*\\(([^)]*)/);\n  if (!match)\n    return [];\n  const trimmedParams = match[1].trim();\n  if (!trimmedParams)\n    return [];\n  const [firstParam] = splitByComma(trimmedParams);\n  if (firstParam[0] !== '{' || firstParam[firstParam.length - 1] !== '}') {\n    onError({ message: 'First argument must use the object destructuring pattern: '  + firstParam, location });\n    return [];\n  }\n  const props = splitByComma(firstParam.substring(1, firstParam.length - 1)).map(prop => {\n    const colon = prop.indexOf(':');\n    return colon === -1 ? prop.trim() : prop.substring(0, colon).trim();\n  });\n  const restProperty = props.find(prop => prop.startsWith('...'));\n  if (restProperty) {\n    onError({ message: `Rest property \"${restProperty}\" is not supported. List all used fixtures explicitly, separated by comma.`, location });\n    return [];\n  }\n  return props;\n}\n\nfunction filterOutComments(s: string): string {\n  const result: string[] = [];\n  let commentState: 'none'|'singleline'|'multiline' = 'none';\n  for (let i = 0; i < s.length; ++i) {\n    if (commentState === 'singleline') {\n      if (s[i] === '\\n')\n        commentState = 'none';\n    } else if (commentState === 'multiline') {\n      if (s[i - 1] === '*' && s[i] === '/')\n        commentState = 'none';\n    } else if (commentState === 'none') {\n      if (s[i] === '/' && s[i + 1] === '/') {\n        commentState = 'singleline';\n      } else if (s[i] === '/' && s[i + 1] === '*') {\n        commentState = 'multiline';\n        i += 2;\n      } else {\n        result.push(s[i]);\n      }\n    }\n  }\n  return result.join('');\n}\n\nfunction splitByComma(s: string) {\n  const result: string[] = [];\n  const stack: string[] = [];\n  let start = 0;\n  for (let i = 0; i < s.length; i++) {\n    if (s[i] === '{' || s[i] === '[') {\n      stack.push(s[i] === '{' ? '}' : ']');\n    } else if (s[i] === stack[stack.length - 1]) {\n      stack.pop();\n    } else if (!stack.length && s[i] === ',') {\n      const token = s.substring(start, i).trim();\n      if (token)\n        result.push(token);\n      start = i + 1;\n    }\n  }\n  const lastToken = s.substring(start).trim();\n  if (lastToken)\n    result.push(lastToken);\n  return result;\n}\n\n// name + superId, fn -> id\nconst registrationIdMap = new Map<string, Map<Function | any, string>>();\nlet lastId = 0;\n\nfunction registrationId(registration: FixtureRegistration): string {\n  if (registration.id)\n    return registration.id;\n  const key = registration.name + '@@@' + (registration.super ?  registrationId(registration.super) : '');\n  let map = registrationIdMap.get(key);\n  if (!map) {\n    map = new Map();\n    registrationIdMap.set(key, map);\n  }\n  if (!map.has(registration.fn))\n    map.set(registration.fn, String(lastId++));\n  registration.id = map.get(registration.fn)!;\n  return registration.id;\n}\n"],"mappings":"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"}