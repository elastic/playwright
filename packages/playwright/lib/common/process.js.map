{"version":3,"file":"process.js","names":["_utils","require","_util","_esmLoaderHost","_esmUtils","ProcessRunner","gracefullyClose","dispatchEvent","method","params","response","sendMessageToParent","exports","gracefullyCloseCalled","forceExitInitiated","process","on","gracefullyCloseAndExit","execArgv","execArgvWithoutExperimentalLoaderOptions","env","PW_TS_ESM_LOADER_ON","registerESMLoader","processRunner","processName","startingEnv","message","processParams","runnerParams","runnerScript","startProfiling","create","keys","Set","Object","producedEnv","filter","key","map","_process$env$key","id","result","e","error","serializeError","kForceExitTimeout","PWTEST_FORCE_EXIT_TIMEOUT","forceExit","setTimeout","exit","_processRunner","catch","stopProfiling","send"],"sources":["../../src/common/process.ts"],"sourcesContent":["/**\n * Copyright Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport type { EnvProducedPayload, ProcessInitParams } from './ipc';\nimport { startProfiling, stopProfiling } from 'playwright-core/lib/utils';\nimport type { TestInfoError } from '../../types/test';\nimport { serializeError } from '../util';\nimport { registerESMLoader } from './esmLoaderHost';\nimport { execArgvWithoutExperimentalLoaderOptions } from '../transform/esmUtils';\n\nexport type ProtocolRequest = {\n  id: number;\n  method: string;\n  params?: any;\n};\n\nexport type ProtocolResponse = {\n  id?: number;\n  error?: TestInfoError;\n  method?: string;\n  params?: any;\n  result?: any;\n};\n\nexport class ProcessRunner {\n  async gracefullyClose(): Promise<void> { }\n\n  protected dispatchEvent(method: string, params: any) {\n    const response: ProtocolResponse = { method, params };\n    sendMessageToParent({ method: '__dispatch__', params: response });\n  }\n}\n\nlet gracefullyCloseCalled = false;\nlet forceExitInitiated = false;\n\nsendMessageToParent({ method: 'ready' });\n\nprocess.on('disconnect', () => gracefullyCloseAndExit(true));\nprocess.on('SIGINT', () => {});\nprocess.on('SIGTERM', () => {});\n\n// Clear execArgv immediately, so that the user-code does not inherit our loader.\nprocess.execArgv = execArgvWithoutExperimentalLoaderOptions();\n\n// Node.js >= 20\nif (process.env.PW_TS_ESM_LOADER_ON)\n  registerESMLoader();\n\nlet processRunner: ProcessRunner | undefined;\nlet processName: string | undefined;\nconst startingEnv = { ...process.env };\n\nprocess.on('message', async (message: any) => {\n  if (message.method === '__init__') {\n    const { processParams, runnerParams, runnerScript } = message.params as { processParams: ProcessInitParams, runnerParams: any, runnerScript: string };\n    void startProfiling();\n    const { create } = require(runnerScript);\n    processRunner = create(runnerParams) as ProcessRunner;\n    processName = processParams.processName;\n    return;\n  }\n  if (message.method === '__stop__') {\n    const keys = new Set([...Object.keys(process.env), ...Object.keys(startingEnv)]);\n    const producedEnv: EnvProducedPayload = [...keys].filter(key => startingEnv[key] !== process.env[key]).map(key => [key, process.env[key] ?? null]);\n    sendMessageToParent({ method: '__env_produced__', params: producedEnv });\n    await gracefullyCloseAndExit(false);\n    return;\n  }\n  if (message.method === '__dispatch__') {\n    const { id, method, params } = message.params as ProtocolRequest;\n    try {\n      const result = await (processRunner as any)[method](params);\n      const response: ProtocolResponse = { id, result };\n      sendMessageToParent({ method: '__dispatch__', params: response });\n    } catch (e) {\n      const response: ProtocolResponse = { id, error: serializeError(e) };\n      sendMessageToParent({ method: '__dispatch__', params: response });\n    }\n  }\n});\n\nconst kForceExitTimeout = +(process.env.PWTEST_FORCE_EXIT_TIMEOUT || 30000);\n\nasync function gracefullyCloseAndExit(forceExit: boolean) {\n  if (forceExit && !forceExitInitiated) {\n    forceExitInitiated = true;\n    // Force exit after 30 seconds.\n    // eslint-disable-next-line no-restricted-properties\n    setTimeout(() => process.exit(0), kForceExitTimeout);\n  }\n  if (!gracefullyCloseCalled) {\n    gracefullyCloseCalled = true;\n    // Meanwhile, try to gracefully shutdown.\n    await processRunner?.gracefullyClose().catch(() => {});\n    if (processName)\n      await stopProfiling(processName).catch(() => {});\n    // eslint-disable-next-line no-restricted-properties\n    process.exit(0);\n  }\n}\n\nfunction sendMessageToParent(message: { method: string, params?: any }) {\n  try {\n    process.send!(message);\n  } catch (e) {\n    // Can throw when closing.\n  }\n}\n"],"mappings":"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"}