{"version":3,"file":"poolBuilder.js","names":["_fixtures","require","_util","PoolBuilder","createForLoader","createForWorker","project","constructor","type","_project","_testTypePools","Map","_type","buildPools","suite","testErrors","forEachTest","test","pool","_buildPoolForTest","_poolDigest","digest","_pool","_buildTestTypePool","_testType","parents","parent","push","reverse","_use","length","FixturePool","e","_handleLoadError","hook","_hooks","validateFunction","fn","location","modifier","_modifiers","testType","has","_this$_project$projec","_this$_project","_this$_project2","optionOverrides","overrides","use","file","id","line","column","fixtures","undefined","set","get","Error","formatLocation","message","exports"],"sources":["../../src/common/poolBuilder.ts"],"sourcesContent":["/**\n * Copyright Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { FixturePool } from './fixtures';\nimport type { LoadError } from './fixtures';\nimport type { Suite, TestCase } from './test';\nimport type { TestTypeImpl } from './testType';\nimport type { FullProjectInternal } from './config';\nimport { formatLocation } from '../util';\nimport type { TestError } from '../../types/testReporter';\n\nexport class PoolBuilder {\n  private _project: FullProjectInternal | undefined;\n  private _testTypePools = new Map<TestTypeImpl, FixturePool>();\n  private _type: 'loader' | 'worker';\n\n  static createForLoader() {\n    return new PoolBuilder('loader');\n  }\n\n  static createForWorker(project: FullProjectInternal) {\n    return new PoolBuilder('worker', project);\n  }\n\n  private constructor(type: 'loader' | 'worker', project?: FullProjectInternal) {\n    this._type = type;\n    this._project = project;\n  }\n\n  buildPools(suite: Suite, testErrors?: TestError[]) {\n    suite.forEachTest(test => {\n      const pool = this._buildPoolForTest(test, testErrors);\n      if (this._type === 'loader')\n        test._poolDigest = pool.digest;\n      if (this._type === 'worker')\n        test._pool = pool;\n    });\n  }\n\n  private _buildPoolForTest(test: TestCase, testErrors?: TestError[]): FixturePool {\n    let pool = this._buildTestTypePool(test._testType, testErrors);\n\n    const parents: Suite[] = [];\n    for (let parent: Suite | undefined = test.parent; parent; parent = parent.parent)\n      parents.push(parent);\n    parents.reverse();\n\n    for (const parent of parents) {\n      if (parent._use.length)\n        pool = new FixturePool(parent._use, e => this._handleLoadError(e, testErrors), pool, parent._type === 'describe');\n      for (const hook of parent._hooks)\n        pool.validateFunction(hook.fn, hook.type + ' hook', hook.location);\n      for (const modifier of parent._modifiers)\n        pool.validateFunction(modifier.fn, modifier.type + ' modifier', modifier.location);\n    }\n\n    pool.validateFunction(test.fn, 'Test', test.location);\n    return pool;\n  }\n\n  private _buildTestTypePool(testType: TestTypeImpl, testErrors?: TestError[]): FixturePool {\n    if (!this._testTypePools.has(testType)) {\n      const optionOverrides = {\n        overrides: this._project?.project?.use ?? {},\n        location: { file: `project#${this._project?.id}`, line: 1, column: 1 }\n      };\n      const pool = new FixturePool(testType.fixtures, e => this._handleLoadError(e, testErrors), undefined, undefined, optionOverrides);\n      this._testTypePools.set(testType, pool);\n    }\n    return this._testTypePools.get(testType)!;\n  }\n\n  private _handleLoadError(e: LoadError, testErrors?: TestError[]): void {\n    if (testErrors)\n      testErrors.push(e);\n    else\n      throw new Error(`${formatLocation(e.location)}: ${e.message}`);\n  }\n}\n"],"mappings":"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"}