{"version":3,"file":"timeoutManager.js","names":["_utilsBundle","require","_utils","kMaxDeadline","exports","TimeoutManager","constructor","timeout","_defaultSlot","_running","_ignoreTimeouts","elapsed","setIgnoreTimeouts","interrupt","timeoutPromise","reject","_createTimeoutError","isTimeExhaustedFor","runnable","_runnable$fixture","slot","fixture","withRunnable","cb","_runnable$fixture2","Error","running","start","monotonicTime","deadline","timer","undefined","ManualPromise","_updateTimeout","Promise","race","clearTimeout","setTimeout","defaultSlot","slow","currentSlotDeadline","currentSlotType","type","_runnable$fixture3","message","phase","title","fixtureWithSlot","colors","red","location","error","TimeoutManagerError","name","stack","file","line","column"],"sources":["../../src/worker/timeoutManager.ts"],"sourcesContent":["/**\n * Copyright Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { colors } from 'playwright-core/lib/utilsBundle';\nimport { ManualPromise, monotonicTime } from 'playwright-core/lib/utils';\nimport type { Location } from '../../types/testReporter';\n\nexport type TimeSlot = {\n  timeout: number;\n  elapsed: number;\n};\n\ntype RunnableType = 'test' | 'beforeAll' | 'afterAll' | 'beforeEach' | 'afterEach' | 'slow' | 'skip' | 'fail' | 'fixme' | 'teardown';\n\nexport type RunnableDescription = {\n  type: RunnableType;\n  location?: Location;\n  slot?: TimeSlot;  // Falls back to test slot.\n  fixture?: FixtureDescription;\n};\n\nexport type FixtureDescription = {\n  title: string;\n  phase: 'setup' | 'teardown';\n  location?: Location;\n  slot?: TimeSlot;  // Falls back to the runnable slot.\n};\n\ntype Running = {\n  runnable: RunnableDescription;\n  slot: TimeSlot;\n  start: number;\n  deadline: number;\n  timer: NodeJS.Timeout | undefined;\n  timeoutPromise: ManualPromise<any>;\n};\nexport const kMaxDeadline = 2147483647; // 2^31-1\n\nexport class TimeoutManager {\n  private _defaultSlot: TimeSlot;\n  private _running?: Running;\n  private _ignoreTimeouts = false;\n\n  constructor(timeout: number) {\n    this._defaultSlot = { timeout, elapsed: 0 };\n  }\n\n  setIgnoreTimeouts() {\n    this._ignoreTimeouts = true;\n  }\n\n  interrupt() {\n    if (this._running)\n      this._running.timeoutPromise.reject(this._createTimeoutError(this._running));\n  }\n\n  isTimeExhaustedFor(runnable: RunnableDescription) {\n    const slot = runnable.fixture?.slot || runnable.slot || this._defaultSlot;\n    // Note: the \"-1\" here matches the +1 in _updateTimeout.\n    return slot.timeout > 0 && (slot.elapsed >= slot.timeout - 1);\n  }\n\n  async withRunnable<T>(runnable: RunnableDescription | undefined, cb: () => Promise<T>): Promise<T> {\n    if (!runnable)\n      return await cb();\n    if (this._running)\n      throw new Error(`Internal error: duplicate runnable`);\n    const running = this._running = {\n      runnable,\n      slot: runnable.fixture?.slot || runnable.slot || this._defaultSlot,\n      start: monotonicTime(),\n      deadline: kMaxDeadline,\n      timer: undefined,\n      timeoutPromise: new ManualPromise(),\n    };\n    try {\n      this._updateTimeout(running);\n      return await Promise.race([\n        cb(),\n        running.timeoutPromise,\n      ]);\n    } finally {\n      if (running.timer)\n        clearTimeout(running.timer);\n      running.timer = undefined;\n      running.slot.elapsed += monotonicTime() - running.start;\n      this._running = undefined;\n    }\n  }\n\n  private _updateTimeout(running: Running) {\n    if (running.timer)\n      clearTimeout(running.timer);\n    running.timer = undefined;\n    if (this._ignoreTimeouts || !running.slot.timeout) {\n      running.deadline = kMaxDeadline;\n      return;\n    }\n    running.deadline = running.start + (running.slot.timeout - running.slot.elapsed);\n    // Compensate for Node.js troubles with timeouts that can fire too early.\n    // We add an extra millisecond which seems to be enough.\n    // See https://github.com/nodejs/node/issues/26578.\n    const timeout = running.deadline - monotonicTime() + 1;\n    if (timeout <= 0)\n      running.timeoutPromise.reject(this._createTimeoutError(running));\n    else\n      running.timer = setTimeout(() => running.timeoutPromise.reject(this._createTimeoutError(running)), timeout);\n  }\n\n  defaultSlot() {\n    return this._defaultSlot;\n  }\n\n  slow() {\n    const slot = this._running ? this._running.slot : this._defaultSlot;\n    slot.timeout = slot.timeout * 3;\n    if (this._running)\n      this._updateTimeout(this._running);\n  }\n\n  setTimeout(timeout: number) {\n    const slot = this._running ? this._running.slot : this._defaultSlot;\n    slot.timeout = timeout;\n    if (this._running)\n      this._updateTimeout(this._running);\n  }\n\n  currentSlotDeadline() {\n    return this._running ? this._running.deadline : kMaxDeadline;\n  }\n\n  currentSlotType() {\n    return this._running ? this._running.runnable.type : 'test';\n  }\n\n  private _createTimeoutError(running: Running): Error {\n    let message = '';\n    const timeout = running.slot.timeout;\n    const runnable = running.runnable;\n    switch (runnable.type) {\n      case 'test': {\n        if (runnable.fixture) {\n          if (runnable.fixture.phase === 'setup')\n            message = `Test timeout of ${timeout}ms exceeded while setting up \"${runnable.fixture.title}\".`;\n          else\n            message = `Tearing down \"${runnable.fixture.title}\" exceeded the test timeout of ${timeout}ms.`;\n        } else {\n          message = `Test timeout of ${timeout}ms exceeded.`;\n        }\n        break;\n      }\n      case 'afterEach':\n      case 'beforeEach':\n        message = `Test timeout of ${timeout}ms exceeded while running \"${runnable.type}\" hook.`;\n        break;\n      case 'beforeAll':\n      case 'afterAll':\n        message = `\"${runnable.type}\" hook timeout of ${timeout}ms exceeded.`;\n        break;\n      case 'teardown': {\n        if (runnable.fixture)\n          message = `Worker teardown timeout of ${timeout}ms exceeded while ${runnable.fixture.phase === 'setup' ? 'setting up' : 'tearing down'} \"${runnable.fixture.title}\".`;\n        else\n          message = `Worker teardown timeout of ${timeout}ms exceeded.`;\n        break;\n      }\n      case 'skip':\n      case 'slow':\n      case 'fixme':\n      case 'fail':\n        message = `\"${runnable.type}\" modifier timeout of ${timeout}ms exceeded.`;\n        break;\n    }\n    const fixtureWithSlot = runnable.fixture?.slot ? runnable.fixture : undefined;\n    if (fixtureWithSlot)\n      message = `Fixture \"${fixtureWithSlot.title}\" timeout of ${timeout}ms exceeded during ${fixtureWithSlot.phase}.`;\n    message = colors.red(message);\n    const location = (fixtureWithSlot || runnable).location;\n    const error = new TimeoutManagerError(message);\n    error.name = '';\n    // Include location for hooks, modifiers and fixtures to distinguish between them.\n    error.stack = message + (location ? `\\n    at ${location.file}:${location.line}:${location.column}` : '');\n    return error;\n  }\n}\n\nexport class TimeoutManagerError extends Error {}\n"],"mappings":"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"}