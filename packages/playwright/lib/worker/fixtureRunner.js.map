{"version":3,"file":"fixtureRunner.js","names":["_util","require","_utils","_fixtures","Fixture","constructor","runner","registration","value","failed","_useFuncFinished","_selfTeardownComplete","_setupDescription","_teardownDescription","_stepInfo","_deps","Set","_usages","shouldGenerateStep","box","option","isUserFixture","location","filterStackFile","file","title","customTitle","name","undefined","category","phase","slot","timeout","elapsed","setup","testInfo","runnable","instanceForId","set","id","fn","_runAsStage","fixture","stepInfo","_setupInternal","params","deps","pool","resolve","dep","get","add","called","useFuncStarted","ManualPromise","useFunc","Error","workerInfo","config","parallelIndex","workerIndex","project","info","scope","error","isDone","reject","teardown","fixtureRunnable","_timeoutManager","isTimeExhaustedFor","_teardownInternal","delete","size","console","clear","_collectFixturesInTeardownOrder","collector","FixtureRunner","testScopeClean","Map","setPool","digest","join","_collectFixturesInSetupOrder","has","teardownScope","fixtures","Array","from","values","reverse","firstError","_firstError","resolveParametersForFunction","autoFixtures","auto","shouldRun","push","sort","r1","r2","names","getRequiredFixtureNames","_setupFixtureForRegistration","resolveParametersAndRunFunction","dependsOnWorkerFixturesOnly","exports","fixtureParameterNames","line","column","e","formatLocation","message"],"sources":["../../src/worker/fixtureRunner.ts"],"sourcesContent":["/**\n * Copyright Microsoft Corporation. All rights reserved.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n *     http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { formatLocation, filterStackFile } from '../util';\nimport { ManualPromise } from 'playwright-core/lib/utils';\nimport type { TestInfoImpl } from './testInfo';\nimport { type FixtureDescription, type RunnableDescription } from './timeoutManager';\nimport { fixtureParameterNames, type FixturePool, type FixtureRegistration, type FixtureScope } from '../common/fixtures';\nimport type { WorkerInfo } from '../../types/test';\nimport type { Location } from '../../types/testReporter';\n\nclass Fixture {\n  runner: FixtureRunner;\n  registration: FixtureRegistration;\n  value: any;\n  failed = false;\n\n  private _useFuncFinished: ManualPromise<void> | undefined;\n  private _selfTeardownComplete: Promise<void> | undefined;\n  private _setupDescription: FixtureDescription;\n  private _teardownDescription: FixtureDescription;\n  private _stepInfo: { category: 'fixture', location?: Location } | undefined;\n  _deps = new Set<Fixture>();\n  _usages = new Set<Fixture>();\n\n  constructor(runner: FixtureRunner, registration: FixtureRegistration) {\n    this.runner = runner;\n    this.registration = registration;\n    this.value = null;\n    const shouldGenerateStep = !this.registration.box && !this.registration.option;\n    const isUserFixture = this.registration.location && filterStackFile(this.registration.location.file);\n    const title = this.registration.customTitle || this.registration.name;\n    const location = isUserFixture ? this.registration.location : undefined;\n    this._stepInfo = shouldGenerateStep ? { category: 'fixture', location } : undefined;\n    this._setupDescription = {\n      title,\n      phase: 'setup',\n      location,\n      slot: this.registration.timeout === undefined ? undefined : {\n        timeout: this.registration.timeout,\n        elapsed: 0,\n      }\n    };\n    this._teardownDescription = { ...this._setupDescription, phase: 'teardown' };\n  }\n\n  async setup(testInfo: TestInfoImpl, runnable: RunnableDescription) {\n    this.runner.instanceForId.set(this.registration.id, this);\n\n    if (typeof this.registration.fn !== 'function') {\n      this.value = this.registration.fn;\n      return;\n    }\n\n    await testInfo._runAsStage({\n      title: `fixture: ${this.registration.name}`,\n      runnable: { ...runnable, fixture: this._setupDescription },\n      stepInfo: this._stepInfo,\n    }, async () => {\n      await this._setupInternal(testInfo);\n    });\n  }\n\n  private async _setupInternal(testInfo: TestInfoImpl) {\n    const params: { [key: string]: any } = {};\n    for (const name of this.registration.deps) {\n      const registration = this.runner.pool!.resolve(name, this.registration)!;\n      const dep = this.runner.instanceForId.get(registration.id);\n      if (!dep) {\n        this.failed = true;\n        return;\n      }\n      // Fixture teardown is root => leaves, when we need to teardown a fixture,\n      // it recursively tears down its usages first.\n      dep._usages.add(this);\n      // Don't forget to decrement all usages when fixture goes.\n      // Otherwise worker-scope fixtures will retain test-scope fixtures forever.\n      this._deps.add(dep);\n      params[name] = dep.value;\n      if (dep.failed) {\n        this.failed = true;\n        return;\n      }\n    }\n\n    let called = false;\n    const useFuncStarted = new ManualPromise<void>();\n    const useFunc = async (value: any) => {\n      if (called)\n        throw new Error(`Cannot provide fixture value for the second time`);\n      called = true;\n      this.value = value;\n      this._useFuncFinished = new ManualPromise<void>();\n      useFuncStarted.resolve();\n      await this._useFuncFinished;\n    };\n\n    const workerInfo: WorkerInfo = { config: testInfo.config, parallelIndex: testInfo.parallelIndex, workerIndex: testInfo.workerIndex, project: testInfo.project };\n    const info = this.registration.scope === 'worker' ? workerInfo : testInfo;\n    this._selfTeardownComplete = (async () => {\n      try {\n        await this.registration.fn(params, useFunc, info);\n      } catch (error) {\n        this.failed = true;\n        if (!useFuncStarted.isDone())\n          useFuncStarted.reject(error);\n        else\n          throw error;\n      }\n    })();\n    await useFuncStarted;\n  }\n\n  async teardown(testInfo: TestInfoImpl, runnable: RunnableDescription) {\n    try {\n      const fixtureRunnable = { ...runnable, fixture: this._teardownDescription };\n      // Do not even start the teardown for a fixture that does not have any\n      // time remaining in the time slot. This avoids cascading timeouts.\n      if (!testInfo._timeoutManager.isTimeExhaustedFor(fixtureRunnable)) {\n        await testInfo._runAsStage({\n          title: `fixture: ${this.registration.name}`,\n          runnable: fixtureRunnable,\n          stepInfo: this._stepInfo,\n        }, async () => {\n          await this._teardownInternal();\n        });\n      }\n    } finally {\n      // To preserve fixtures integrity, forcefully cleanup fixtures\n      // that cannnot teardown due to a timeout or an error.\n      for (const dep of this._deps)\n        dep._usages.delete(this);\n      this.runner.instanceForId.delete(this.registration.id);\n    }\n  }\n\n  private async _teardownInternal() {\n    if (typeof this.registration.fn !== 'function')\n      return;\n    if (this._usages.size !== 0) {\n      // TODO: replace with assert.\n      console.error('Internal error: fixture integrity at', this._teardownDescription.title);  // eslint-disable-line no-console\n      this._usages.clear();\n    }\n    if (this._useFuncFinished) {\n      this._useFuncFinished.resolve();\n      this._useFuncFinished = undefined;\n      await this._selfTeardownComplete;\n    }\n  }\n\n  _collectFixturesInTeardownOrder(scope: FixtureScope, collector: Set<Fixture>) {\n    if (this.registration.scope !== scope)\n      return;\n    for (const fixture of this._usages)\n      fixture._collectFixturesInTeardownOrder(scope, collector);\n    collector.add(this);\n  }\n}\n\nexport class FixtureRunner {\n  private testScopeClean = true;\n  pool: FixturePool | undefined;\n  instanceForId = new Map<string, Fixture>();\n\n  setPool(pool: FixturePool) {\n    if (!this.testScopeClean)\n      throw new Error('Did not teardown test scope');\n    if (this.pool && pool.digest !== this.pool.digest) {\n      throw new Error([\n        `Playwright detected inconsistent test.use() options.`,\n        `Most common mistakes that lead to this issue:`,\n        `  - Calling test.use() outside of the test file, for example in a common helper.`,\n        `  - One test file imports from another test file.`,\n      ].join('\\n'));\n    }\n    this.pool = pool;\n  }\n\n  private _collectFixturesInSetupOrder(registration: FixtureRegistration, collector: Set<FixtureRegistration>) {\n    if (collector.has(registration))\n      return;\n    for (const name of registration.deps) {\n      const dep = this.pool!.resolve(name, registration)!;\n      this._collectFixturesInSetupOrder(dep, collector);\n    }\n    collector.add(registration);\n  }\n\n  async teardownScope(scope: FixtureScope, testInfo: TestInfoImpl, runnable: RunnableDescription) {\n    // Teardown fixtures in the reverse order.\n    const fixtures = Array.from(this.instanceForId.values()).reverse();\n    const collector = new Set<Fixture>();\n    for (const fixture of fixtures)\n      fixture._collectFixturesInTeardownOrder(scope, collector);\n    let firstError: Error | undefined;\n    for (const fixture of collector) {\n      try {\n        await fixture.teardown(testInfo, runnable);\n      } catch (error) {\n        firstError = firstError ?? error;\n      }\n    }\n    if (scope === 'test')\n      this.testScopeClean = true;\n    if (firstError)\n      throw firstError;\n  }\n\n  async resolveParametersForFunction(fn: Function, testInfo: TestInfoImpl, autoFixtures: 'worker' | 'test' | 'all-hooks-only', runnable: RunnableDescription): Promise<object | null> {\n    const collector = new Set<FixtureRegistration>();\n\n    // Collect automatic fixtures.\n    const auto: FixtureRegistration[] = [];\n    for (const registration of this.pool!.autoFixtures()) {\n      let shouldRun = true;\n      if (autoFixtures === 'all-hooks-only')\n        shouldRun = registration.scope === 'worker' || registration.auto === 'all-hooks-included';\n      else if (autoFixtures === 'worker')\n        shouldRun = registration.scope === 'worker';\n      if (shouldRun)\n        auto.push(registration);\n    }\n    auto.sort((r1, r2) => (r1.scope === 'worker' ? 0 : 1) - (r2.scope === 'worker' ? 0 : 1));\n    for (const registration of auto)\n      this._collectFixturesInSetupOrder(registration, collector);\n\n    // Collect used fixtures.\n    const names = getRequiredFixtureNames(fn);\n    for (const name of names)\n      this._collectFixturesInSetupOrder(this.pool!.resolve(name)!, collector);\n\n    // Setup fixtures.\n    for (const registration of collector)\n      await this._setupFixtureForRegistration(registration, testInfo, runnable);\n\n    // Create params object.\n    const params: { [key: string]: any } = {};\n    for (const name of names) {\n      const registration = this.pool!.resolve(name)!;\n      const fixture = this.instanceForId.get(registration.id);\n      if (!fixture || fixture.failed)\n        return null;\n      params[name] = fixture.value;\n    }\n    return params;\n  }\n\n  async resolveParametersAndRunFunction(fn: Function, testInfo: TestInfoImpl, autoFixtures: 'worker' | 'test' | 'all-hooks-only', runnable: RunnableDescription) {\n    const params = await this.resolveParametersForFunction(fn, testInfo, autoFixtures, runnable);\n    if (params === null) {\n      // Do not run the function when fixture setup has already failed.\n      return null;\n    }\n    await testInfo._runAsStage({ title: 'run function', runnable }, async () => {\n      await fn(params, testInfo);\n    });\n  }\n\n  private async _setupFixtureForRegistration(registration: FixtureRegistration, testInfo: TestInfoImpl, runnable: RunnableDescription): Promise<Fixture> {\n    if (registration.scope === 'test')\n      this.testScopeClean = false;\n\n    let fixture = this.instanceForId.get(registration.id);\n    if (fixture)\n      return fixture;\n\n    fixture = new Fixture(this, registration);\n    await fixture.setup(testInfo, runnable);\n    return fixture;\n  }\n\n  dependsOnWorkerFixturesOnly(fn: Function, location: Location): boolean {\n    const names = getRequiredFixtureNames(fn, location);\n    for (const name of names) {\n      const registration = this.pool!.resolve(name)!;\n      if (registration.scope !== 'worker')\n        return false;\n    }\n    return true;\n  }\n}\n\nfunction getRequiredFixtureNames(fn: Function, location?: Location) {\n  return fixtureParameterNames(fn, location ?? { file: '<unknown>', line: 1, column: 1 }, e => {\n    throw new Error(`${formatLocation(e.location!)}: ${e.message}`);\n  });\n}\n"],"mappings":"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"}