{"version":3,"file":"github.js","names":["_utilsBundle","require","_path","_interopRequireDefault","_base","obj","__esModule","default","GitHubLogger","_log","message","type","options","replace","configs","Object","entries","map","key","option","join","console","log","stripAnsiEscapes","debug","error","notice","warning","GitHubReporter","BaseReporter","constructor","args","githubLogger","printsToStdio","onEnd","result","_printAnnotations","onError","errorMessage","formatError","summary","generateSummary","summaryMessage","generateSummaryMessage","failuresToPrint","length","_printFailureAnnotations","_printSlowTestAnnotations","_printSummaryAnnotation","getSlowTests","forEach","file","duration","filePath","workspaceRelativePath","path","process","cwd","milliseconds","title","failures","test","index","annotations","formatFailure","config","includeStdio","includeAttachments","location","line","col","column","exports","_process$env$GITHUB_W","relative","env","_default"],"sources":["../../src/reporters/github.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { ms as milliseconds } from 'playwright-core/lib/utilsBundle';\nimport path from 'path';\nimport { BaseReporter, formatError, formatFailure, stripAnsiEscapes } from './base';\nimport type { TestCase, FullResult, TestError } from '../../types/testReporter';\n\ntype GitHubLogType = 'debug' | 'notice' | 'warning' | 'error';\n\ntype GitHubLogOptions = Partial<{\n  title: string;\n  file: string;\n  col: number;\n  endColumn: number;\n  line: number;\n  endLine: number;\n}>;\n\nclass GitHubLogger {\n  private _log(message: string, type: GitHubLogType = 'notice', options: GitHubLogOptions = {}) {\n    message = message.replace(/\\n/g, '%0A');\n    const configs = Object.entries(options)\n        .map(([key, option]) => `${key}=${option}`)\n        .join(',');\n    console.log(stripAnsiEscapes(`::${type} ${configs}::${message}`));\n  }\n\n  debug(message: string, options?: GitHubLogOptions) {\n    this._log(message, 'debug', options);\n  }\n\n  error(message: string, options?: GitHubLogOptions) {\n    this._log(message, 'error', options);\n  }\n\n  notice(message: string, options?: GitHubLogOptions) {\n    this._log(message, 'notice', options);\n  }\n\n  warning(message: string, options?: GitHubLogOptions) {\n    this._log(message, 'warning', options);\n  }\n}\n\nexport class GitHubReporter extends BaseReporter {\n  githubLogger = new GitHubLogger();\n\n  override printsToStdio() {\n    return false;\n  }\n\n  override async onEnd(result: FullResult) {\n    await super.onEnd(result);\n    this._printAnnotations();\n  }\n\n  override onError(error: TestError) {\n    const errorMessage = formatError(error, false).message;\n    this.githubLogger.error(errorMessage);\n  }\n\n  private _printAnnotations() {\n    const summary = this.generateSummary();\n    const summaryMessage = this.generateSummaryMessage(summary);\n    if (summary.failuresToPrint.length)\n      this._printFailureAnnotations(summary.failuresToPrint);\n    this._printSlowTestAnnotations();\n    this._printSummaryAnnotation(summaryMessage);\n  }\n\n  private _printSlowTestAnnotations() {\n    this.getSlowTests().forEach(([file, duration]) => {\n      const filePath = workspaceRelativePath(path.join(process.cwd(), file));\n      this.githubLogger.warning(`${filePath} took ${milliseconds(duration)}`, {\n        title: 'Slow Test',\n        file: filePath,\n      });\n    });\n  }\n\n  private _printSummaryAnnotation(summary: string){\n    this.githubLogger.notice(summary, {\n      title: 'ðŸŽ­ Playwright Run Summary'\n    });\n  }\n\n  private _printFailureAnnotations(failures: TestCase[]) {\n    failures.forEach((test, index) => {\n      const { annotations } = formatFailure(this.config, test, {\n        index: index + 1,\n        includeStdio: true,\n        includeAttachments: false,\n      });\n      annotations.forEach(({ location, title, message }) => {\n        const options: GitHubLogOptions = {\n          file: workspaceRelativePath(location?.file || test.location.file),\n          title,\n        };\n        if (location) {\n          options.line = location.line;\n          options.col = location.column;\n        }\n        this.githubLogger.error(message, options);\n      });\n    });\n  }\n}\n\nfunction workspaceRelativePath(filePath: string): string {\n  return path.relative(process.env['GITHUB_WORKSPACE'] ?? '', filePath);\n}\n\nexport default GitHubReporter;\n"],"mappings":";;;;;;AAgBA,IAAAA,YAAA,GAAAC,OAAA;AACA,IAAAC,KAAA,GAAAC,sBAAA,CAAAF,OAAA;AACA,IAAAG,KAAA,GAAAH,OAAA;AAAoF,SAAAE,uBAAAE,GAAA,WAAAA,GAAA,IAAAA,GAAA,CAAAC,UAAA,GAAAD,GAAA,KAAAE,OAAA,EAAAF,GAAA;AAlBpF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAkBA,MAAMG,YAAY,CAAC;EACTC,IAAIA,CAACC,OAAe,EAAEC,IAAmB,GAAG,QAAQ,EAAEC,OAAyB,GAAG,CAAC,CAAC,EAAE;IAC5FF,OAAO,GAAGA,OAAO,CAACG,OAAO,CAAC,KAAK,EAAE,KAAK,CAAC;IACvC,MAAMC,OAAO,GAAGC,MAAM,CAACC,OAAO,CAACJ,OAAO,CAAC,CAClCK,GAAG,CAAC,CAAC,CAACC,GAAG,EAAEC,MAAM,CAAC,KAAM,GAAED,GAAI,IAAGC,MAAO,EAAC,CAAC,CAC1CC,IAAI,CAAC,GAAG,CAAC;IACdC,OAAO,CAACC,GAAG,CAAC,IAAAC,sBAAgB,EAAE,KAAIZ,IAAK,IAAGG,OAAQ,KAAIJ,OAAQ,EAAC,CAAC,CAAC;EACnE;EAEAc,KAAKA,CAACd,OAAe,EAAEE,OAA0B,EAAE;IACjD,IAAI,CAACH,IAAI,CAACC,OAAO,EAAE,OAAO,EAAEE,OAAO,CAAC;EACtC;EAEAa,KAAKA,CAACf,OAAe,EAAEE,OAA0B,EAAE;IACjD,IAAI,CAACH,IAAI,CAACC,OAAO,EAAE,OAAO,EAAEE,OAAO,CAAC;EACtC;EAEAc,MAAMA,CAAChB,OAAe,EAAEE,OAA0B,EAAE;IAClD,IAAI,CAACH,IAAI,CAACC,OAAO,EAAE,QAAQ,EAAEE,OAAO,CAAC;EACvC;EAEAe,OAAOA,CAACjB,OAAe,EAAEE,OAA0B,EAAE;IACnD,IAAI,CAACH,IAAI,CAACC,OAAO,EAAE,SAAS,EAAEE,OAAO,CAAC;EACxC;AACF;AAEO,MAAMgB,cAAc,SAASC,kBAAY,CAAC;EAAAC,YAAA,GAAAC,IAAA;IAAA,SAAAA,IAAA;IAAA,KAC/CC,YAAY,GAAG,IAAIxB,YAAY,CAAC,CAAC;EAAA;EAExByB,aAAaA,CAAA,EAAG;IACvB,OAAO,KAAK;EACd;EAEA,MAAeC,KAAKA,CAACC,MAAkB,EAAE;IACvC,MAAM,KAAK,CAACD,KAAK,CAACC,MAAM,CAAC;IACzB,IAAI,CAACC,iBAAiB,CAAC,CAAC;EAC1B;EAESC,OAAOA,CAACZ,KAAgB,EAAE;IACjC,MAAMa,YAAY,GAAG,IAAAC,iBAAW,EAACd,KAAK,EAAE,KAAK,CAAC,CAACf,OAAO;IACtD,IAAI,CAACsB,YAAY,CAACP,KAAK,CAACa,YAAY,CAAC;EACvC;EAEQF,iBAAiBA,CAAA,EAAG;IAC1B,MAAMI,OAAO,GAAG,IAAI,CAACC,eAAe,CAAC,CAAC;IACtC,MAAMC,cAAc,GAAG,IAAI,CAACC,sBAAsB,CAACH,OAAO,CAAC;IAC3D,IAAIA,OAAO,CAACI,eAAe,CAACC,MAAM,EAChC,IAAI,CAACC,wBAAwB,CAACN,OAAO,CAACI,eAAe,CAAC;IACxD,IAAI,CAACG,yBAAyB,CAAC,CAAC;IAChC,IAAI,CAACC,uBAAuB,CAACN,cAAc,CAAC;EAC9C;EAEQK,yBAAyBA,CAAA,EAAG;IAClC,IAAI,CAACE,YAAY,CAAC,CAAC,CAACC,OAAO,CAAC,CAAC,CAACC,IAAI,EAAEC,QAAQ,CAAC,KAAK;MAChD,MAAMC,QAAQ,GAAGC,qBAAqB,CAACC,aAAI,CAACnC,IAAI,CAACoC,OAAO,CAACC,GAAG,CAAC,CAAC,EAAEN,IAAI,CAAC,CAAC;MACtE,IAAI,CAACnB,YAAY,CAACL,OAAO,CAAE,GAAE0B,QAAS,SAAQ,IAAAK,eAAY,EAACN,QAAQ,CAAE,EAAC,EAAE;QACtEO,KAAK,EAAE,WAAW;QAClBR,IAAI,EAAEE;MACR,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ;EAEQL,uBAAuBA,CAACR,OAAe,EAAC;IAC9C,IAAI,CAACR,YAAY,CAACN,MAAM,CAACc,OAAO,EAAE;MAChCmB,KAAK,EAAE;IACT,CAAC,CAAC;EACJ;EAEQb,wBAAwBA,CAACc,QAAoB,EAAE;IACrDA,QAAQ,CAACV,OAAO,CAAC,CAACW,IAAI,EAAEC,KAAK,KAAK;MAChC,MAAM;QAAEC;MAAY,CAAC,GAAG,IAAAC,mBAAa,EAAC,IAAI,CAACC,MAAM,EAAEJ,IAAI,EAAE;QACvDC,KAAK,EAAEA,KAAK,GAAG,CAAC;QAChBI,YAAY,EAAE,IAAI;QAClBC,kBAAkB,EAAE;MACtB,CAAC,CAAC;MACFJ,WAAW,CAACb,OAAO,CAAC,CAAC;QAAEkB,QAAQ;QAAET,KAAK;QAAEjD;MAAQ,CAAC,KAAK;QACpD,MAAME,OAAyB,GAAG;UAChCuC,IAAI,EAAEG,qBAAqB,CAAC,CAAAc,QAAQ,aAARA,QAAQ,uBAARA,QAAQ,CAAEjB,IAAI,KAAIU,IAAI,CAACO,QAAQ,CAACjB,IAAI,CAAC;UACjEQ;QACF,CAAC;QACD,IAAIS,QAAQ,EAAE;UACZxD,OAAO,CAACyD,IAAI,GAAGD,QAAQ,CAACC,IAAI;UAC5BzD,OAAO,CAAC0D,GAAG,GAAGF,QAAQ,CAACG,MAAM;QAC/B;QACA,IAAI,CAACvC,YAAY,CAACP,KAAK,CAACf,OAAO,EAAEE,OAAO,CAAC;MAC3C,CAAC,CAAC;IACJ,CAAC,CAAC;EACJ;AACF;AAAC4D,OAAA,CAAA5C,cAAA,GAAAA,cAAA;AAED,SAAS0B,qBAAqBA,CAACD,QAAgB,EAAU;EAAA,IAAAoB,qBAAA;EACvD,OAAOlB,aAAI,CAACmB,QAAQ,EAAAD,qBAAA,GAACjB,OAAO,CAACmB,GAAG,CAAC,kBAAkB,CAAC,cAAAF,qBAAA,cAAAA,qBAAA,GAAI,EAAE,EAAEpB,QAAQ,CAAC;AACvE;AAAC,IAAAuB,QAAA,GAAAJ,OAAA,CAAAjE,OAAA,GAEcqB,cAAc"}