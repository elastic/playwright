{"version":3,"file":"internalReporter.js","names":["_fs","_interopRequireDefault","require","_babelBundle","_test","_base","_utils","_multiplexer","obj","__esModule","default","InternalReporter","constructor","reporters","_reporter","_didBegin","_config","_startTime","_monotonicStartTime","Multiplexer","version","onConfigure","config","Date","monotonicTime","onBegin","suite","onTestBegin","test","result","onStdOut","chunk","onStdErr","onTestEnd","_addSnippetToTestErrors","onEnd","Suite","startTime","duration","onExit","onError","error","addLocationAndSnippetToError","onStepBegin","step","onStepEnd","_addSnippetToStepError","printsToStdio","errors","location","file","exports","stack","prepareErrorStack","tokens","source","fs","readFileSync","codeFrame","codeFrameColumns","start","highlightCode","realpathSync","push","colors","gray","relativeFilePath","line","snippet","join","e"],"sources":["../../src/reporters/internalReporter.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport fs from 'fs';\nimport { codeFrameColumns } from '../transform/babelBundle';\nimport type { FullConfig, TestCase, TestError, TestResult, FullResult, TestStep } from '../../types/testReporter';\nimport { Suite } from '../common/test';\nimport { colors, prepareErrorStack, relativeFilePath } from './base';\nimport type { ReporterV2 } from './reporterV2';\nimport { monotonicTime } from 'playwright-core/lib/utils';\nimport { Multiplexer } from './multiplexer';\n\nexport class InternalReporter {\n  private _reporter: ReporterV2;\n  private _didBegin = false;\n  private _config!: FullConfig;\n  private _startTime: Date | undefined;\n  private _monotonicStartTime: number | undefined;\n\n  constructor(reporters: ReporterV2[]) {\n    this._reporter = new Multiplexer(reporters);\n  }\n\n  version(): 'v2' {\n    return 'v2';\n  }\n\n  onConfigure(config: FullConfig) {\n    this._config = config;\n    this._startTime = new Date();\n    this._monotonicStartTime = monotonicTime();\n    this._reporter.onConfigure(config);\n  }\n\n  onBegin(suite: Suite) {\n    this._didBegin = true;\n    this._reporter.onBegin(suite);\n  }\n\n  onTestBegin(test: TestCase, result: TestResult) {\n    this._reporter.onTestBegin(test, result);\n  }\n\n  onStdOut(chunk: string | Buffer, test?: TestCase, result?: TestResult) {\n    this._reporter.onStdOut(chunk, test, result);\n  }\n\n  onStdErr(chunk: string | Buffer, test?: TestCase, result?: TestResult) {\n    this._reporter.onStdErr(chunk, test, result);\n  }\n\n  onTestEnd(test: TestCase, result: TestResult) {\n    this._addSnippetToTestErrors(test, result);\n    this._reporter.onTestEnd(test, result);\n  }\n\n  async onEnd(result: { status: FullResult['status'] }) {\n    if (!this._didBegin) {\n      // onBegin was not reported, emit it.\n      this.onBegin(new Suite('', 'root'));\n    }\n    return await this._reporter.onEnd({\n      ...result,\n      startTime: this._startTime!,\n      duration: monotonicTime() - this._monotonicStartTime!,\n    });\n  }\n\n  async onExit() {\n    await this._reporter.onExit();\n  }\n\n  onError(error: TestError) {\n    addLocationAndSnippetToError(this._config, error);\n    this._reporter.onError(error);\n  }\n\n  onStepBegin(test: TestCase, result: TestResult, step: TestStep) {\n    this._reporter.onStepBegin(test, result, step);\n  }\n\n  onStepEnd(test: TestCase, result: TestResult, step: TestStep) {\n    this._addSnippetToStepError(test, step);\n    this._reporter.onStepEnd(test, result, step);\n  }\n\n  printsToStdio() {\n    return this._reporter.printsToStdio();\n  }\n\n  private _addSnippetToTestErrors(test: TestCase, result: TestResult) {\n    for (const error of result.errors)\n      addLocationAndSnippetToError(this._config, error, test.location.file);\n  }\n\n  private _addSnippetToStepError(test: TestCase, step: TestStep) {\n    if (step.error)\n      addLocationAndSnippetToError(this._config, step.error, test.location.file);\n  }\n}\n\nfunction addLocationAndSnippetToError(config: FullConfig, error: TestError, file?: string) {\n  if (error.stack && !error.location)\n    error.location = prepareErrorStack(error.stack).location;\n  const location = error.location;\n  if (!location)\n    return;\n\n  try {\n    const tokens = [];\n    const source = fs.readFileSync(location.file, 'utf8');\n    const codeFrame = codeFrameColumns(source, { start: location }, { highlightCode: true });\n    // Convert /var/folders to /private/var/folders on Mac.\n    if (!file || fs.realpathSync(file) !== location.file) {\n      tokens.push(colors.gray(`   at `) + `${relativeFilePath(config, location.file)}:${location.line}`);\n      tokens.push('');\n    }\n    tokens.push(codeFrame);\n    error.snippet = tokens.join('\\n');\n  } catch (e) {\n    // Failed to read the source file - that's ok.\n  }\n}\n"],"mappings":"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"}