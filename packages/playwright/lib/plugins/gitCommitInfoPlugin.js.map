{"version":3,"file":"gitCommitInfoPlugin.js","names":["_utils","require","GIT_OPERATIONS_TIMEOUT_MS","gitCommitInfo","options","name","setup","config","configDir","info","linksFromEnv","gitStatusFromCLI","directory","timestamp","Date","now","getTime","metadata","Object","assign","exports","out","process","env","BUILD_URL","CI_PROJECT_URL","CI_COMMIT_SHA","CI_JOB_URL","GITHUB_SERVER_URL","GITHUB_REPOSITORY","GITHUB_SHA","GITHUB_RUN_ID","gitDir","separator","createGuid","slice","code","stdout","spawnAsync","stdio","cwd","timeout","showOutput","trim","id","subject","author","email","rawTimestamp","split","Number","parseInt","isInteger"],"sources":["../../src/plugins/gitCommitInfoPlugin.ts"],"sourcesContent":["/**\n * Copyright (c) Microsoft Corporation.\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport { createGuid, spawnAsync } from 'playwright-core/lib/utils';\nimport type { TestRunnerPlugin } from './';\nimport type { FullConfig } from '../../types/testReporter';\n\nconst GIT_OPERATIONS_TIMEOUT_MS = 1500;\n\nexport const gitCommitInfo = (options?: GitCommitInfoPluginOptions): TestRunnerPlugin => {\n  return {\n    name: 'playwright:git-commit-info',\n\n    setup: async (config: FullConfig, configDir: string) => {\n      const info = {\n        ...linksFromEnv(),\n        ...options?.info ? options.info : await gitStatusFromCLI(options?.directory || configDir),\n        timestamp: Date.now(),\n      };\n      // Normalize dates\n      const timestamp = info['revision.timestamp'];\n      if (timestamp instanceof Date)\n        info['revision.timestamp'] = timestamp.getTime();\n\n      config.metadata = config.metadata || {};\n      Object.assign(config.metadata, info);\n    },\n  };\n};\n\nexport interface GitCommitInfoPluginOptions {\n    directory?: string;\n    info?: Info;\n}\n\nexport interface Info {\n  'revision.id'?: string;\n  'revision.author'?: string;\n  'revision.email'?: string;\n  'revision.subject'?: string;\n  'revision.timestamp'?: number | Date;\n  'revision.link'?: string;\n  'ci.link'?: string;\n}\n\nconst linksFromEnv = (): Pick<Info, 'revision.link' | 'ci.link'> => {\n  const out: { 'revision.link'?: string; 'ci.link'?: string; } = {};\n  // Jenkins: https://www.jenkins.io/doc/book/pipeline/jenkinsfile/#using-environment-variables\n  if (process.env.BUILD_URL)\n    out['ci.link'] = process.env.BUILD_URL;\n  // GitLab: https://docs.gitlab.com/ee/ci/variables/predefined_variables.html\n  if (process.env.CI_PROJECT_URL && process.env.CI_COMMIT_SHA)\n    out['revision.link'] = `${process.env.CI_PROJECT_URL}/-/commit/${process.env.CI_COMMIT_SHA}`;\n  if (process.env.CI_JOB_URL)\n    out['ci.link'] = process.env.CI_JOB_URL;\n    // GitHub: https://docs.github.com/en/actions/learn-github-actions/environment-variables#default-environment-variables\n  if (process.env.GITHUB_SERVER_URL && process.env.GITHUB_REPOSITORY && process.env.GITHUB_SHA)\n    out['revision.link'] = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/commit/${process.env.GITHUB_SHA}`;\n  if (process.env.GITHUB_SERVER_URL && process.env.GITHUB_REPOSITORY && process.env.GITHUB_RUN_ID)\n    out['ci.link'] = `${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;\n  return out;\n};\n\nexport const gitStatusFromCLI = async (gitDir: string): Promise<Info | undefined> => {\n  const separator = `:${createGuid().slice(0, 4)}:`;\n  const { code, stdout } = await spawnAsync(\n      'git',\n      ['show', '-s', `--format=%H${separator}%s${separator}%an${separator}%ae${separator}%ct`, 'HEAD'],\n      { stdio: 'pipe', cwd: gitDir, timeout: GIT_OPERATIONS_TIMEOUT_MS }\n  );\n  if (code)\n    return;\n  const showOutput = stdout.trim();\n  const [id, subject, author, email, rawTimestamp] = showOutput.split(separator);\n  let timestamp: number = Number.parseInt(rawTimestamp, 10);\n  timestamp = Number.isInteger(timestamp) ? timestamp * 1000 : 0;\n\n  return {\n    'revision.id': id,\n    'revision.author': author,\n    'revision.email': email,\n    'revision.subject': subject,\n    'revision.timestamp': timestamp,\n  };\n};\n"],"mappings":";;;;;;AAgBA,IAAAA,MAAA,GAAAC,OAAA;AAhBA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAMA,MAAMC,yBAAyB,GAAG,IAAI;AAE/B,MAAMC,aAAa,GAAIC,OAAoC,IAAuB;EACvF,OAAO;IACLC,IAAI,EAAE,4BAA4B;IAElCC,KAAK,EAAE,MAAAA,CAAOC,MAAkB,EAAEC,SAAiB,KAAK;MACtD,MAAMC,IAAI,GAAG;QACX,GAAGC,YAAY,CAAC,CAAC;QACjB,IAAGN,OAAO,aAAPA,OAAO,eAAPA,OAAO,CAAEK,IAAI,GAAGL,OAAO,CAACK,IAAI,GAAG,MAAME,gBAAgB,CAAC,CAAAP,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAEQ,SAAS,KAAIJ,SAAS,CAAC;QACzFK,SAAS,EAAEC,IAAI,CAACC,GAAG,CAAC;MACtB,CAAC;MACD;MACA,MAAMF,SAAS,GAAGJ,IAAI,CAAC,oBAAoB,CAAC;MAC5C,IAAII,SAAS,YAAYC,IAAI,EAC3BL,IAAI,CAAC,oBAAoB,CAAC,GAAGI,SAAS,CAACG,OAAO,CAAC,CAAC;MAElDT,MAAM,CAACU,QAAQ,GAAGV,MAAM,CAACU,QAAQ,IAAI,CAAC,CAAC;MACvCC,MAAM,CAACC,MAAM,CAACZ,MAAM,CAACU,QAAQ,EAAER,IAAI,CAAC;IACtC;EACF,CAAC;AACH,CAAC;AAACW,OAAA,CAAAjB,aAAA,GAAAA,aAAA;AAiBF,MAAMO,YAAY,GAAGA,CAAA,KAA+C;EAClE,MAAMW,GAAsD,GAAG,CAAC,CAAC;EACjE;EACA,IAAIC,OAAO,CAACC,GAAG,CAACC,SAAS,EACvBH,GAAG,CAAC,SAAS,CAAC,GAAGC,OAAO,CAACC,GAAG,CAACC,SAAS;EACxC;EACA,IAAIF,OAAO,CAACC,GAAG,CAACE,cAAc,IAAIH,OAAO,CAACC,GAAG,CAACG,aAAa,EACzDL,GAAG,CAAC,eAAe,CAAC,GAAI,GAAEC,OAAO,CAACC,GAAG,CAACE,cAAe,aAAYH,OAAO,CAACC,GAAG,CAACG,aAAc,EAAC;EAC9F,IAAIJ,OAAO,CAACC,GAAG,CAACI,UAAU,EACxBN,GAAG,CAAC,SAAS,CAAC,GAAGC,OAAO,CAACC,GAAG,CAACI,UAAU;EACvC;EACF,IAAIL,OAAO,CAACC,GAAG,CAACK,iBAAiB,IAAIN,OAAO,CAACC,GAAG,CAACM,iBAAiB,IAAIP,OAAO,CAACC,GAAG,CAACO,UAAU,EAC1FT,GAAG,CAAC,eAAe,CAAC,GAAI,GAAEC,OAAO,CAACC,GAAG,CAACK,iBAAkB,IAAGN,OAAO,CAACC,GAAG,CAACM,iBAAkB,WAAUP,OAAO,CAACC,GAAG,CAACO,UAAW,EAAC;EAC7H,IAAIR,OAAO,CAACC,GAAG,CAACK,iBAAiB,IAAIN,OAAO,CAACC,GAAG,CAACM,iBAAiB,IAAIP,OAAO,CAACC,GAAG,CAACQ,aAAa,EAC7FV,GAAG,CAAC,SAAS,CAAC,GAAI,GAAEC,OAAO,CAACC,GAAG,CAACK,iBAAkB,IAAGN,OAAO,CAACC,GAAG,CAACM,iBAAkB,iBAAgBP,OAAO,CAACC,GAAG,CAACQ,aAAc,EAAC;EAChI,OAAOV,GAAG;AACZ,CAAC;AAEM,MAAMV,gBAAgB,GAAG,MAAOqB,MAAc,IAAgC;EACnF,MAAMC,SAAS,GAAI,IAAG,IAAAC,iBAAU,EAAC,CAAC,CAACC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAE,GAAE;EACjD,MAAM;IAAEC,IAAI;IAAEC;EAAO,CAAC,GAAG,MAAM,IAAAC,iBAAU,EACrC,KAAK,EACL,CAAC,MAAM,EAAE,IAAI,EAAG,cAAaL,SAAU,KAAIA,SAAU,MAAKA,SAAU,MAAKA,SAAU,KAAI,EAAE,MAAM,CAAC,EAChG;IAAEM,KAAK,EAAE,MAAM;IAAEC,GAAG,EAAER,MAAM;IAAES,OAAO,EAAEvC;EAA0B,CACrE,CAAC;EACD,IAAIkC,IAAI,EACN;EACF,MAAMM,UAAU,GAAGL,MAAM,CAACM,IAAI,CAAC,CAAC;EAChC,MAAM,CAACC,EAAE,EAAEC,OAAO,EAAEC,MAAM,EAAEC,KAAK,EAAEC,YAAY,CAAC,GAAGN,UAAU,CAACO,KAAK,CAAChB,SAAS,CAAC;EAC9E,IAAIpB,SAAiB,GAAGqC,MAAM,CAACC,QAAQ,CAACH,YAAY,EAAE,EAAE,CAAC;EACzDnC,SAAS,GAAGqC,MAAM,CAACE,SAAS,CAACvC,SAAS,CAAC,GAAGA,SAAS,GAAG,IAAI,GAAG,CAAC;EAE9D,OAAO;IACL,aAAa,EAAE+B,EAAE;IACjB,iBAAiB,EAAEE,MAAM;IACzB,gBAAgB,EAAEC,KAAK;IACvB,kBAAkB,EAAEF,OAAO;IAC3B,oBAAoB,EAAEhC;EACxB,CAAC;AACH,CAAC;AAACO,OAAA,CAAAT,gBAAA,GAAAA,gBAAA"}